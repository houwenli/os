!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).HRTC=t()}(this,(function(){function e(e,t){return t.forEach((function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach((function(r){if("default"!==r&&!(r in e)){var i=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,i.get?i:{enumerable:!0,get:function(){return t[r]}})}}))})),Object.freeze(e)}function t(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function r(e,t,r,i,n){var o={};return Object.keys(i).forEach((function(e){o[e]=i[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=r.slice().reverse().reduce((function(r,i){return i(e,t,r)||r}),o),n&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(n):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}var i="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function n(e){var t=e.default;if("function"==typeof t){var r=function(){return t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var i=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,i.get?i:{enumerable:!0,get:function(){return e[t]}})})),r}var o=function(e){return e&&e.Math==Math&&e},s=o("object"==typeof globalThis&&globalThis)||o("object"==typeof window&&window)||o("object"==typeof self&&self)||o("object"==typeof i&&i)||function(){return this}()||Function("return this")(),a={},c=function(e){try{return!!e()}catch(t){return!0}},u=!c((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),d=!c((function(){var e=function(){}.bind();return"function"!=typeof e||e.hasOwnProperty("prototype")})),l=d,h=Function.prototype.call,f=l?h.bind(h):function(){return h.apply(h,arguments)},p={},m={}.propertyIsEnumerable,g=Object.getOwnPropertyDescriptor,_=g&&!m.call({1:2},1);p.f=_?function(e){var t=g(this,e);return!!t&&t.enumerable}:m;var S,v,y=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},I=d,T=Function.prototype,R=T.bind,E=T.call,b=I&&R.bind(E,E),C=I?function(e){return e&&b(e)}:function(e){return e&&function(){return E.apply(e,arguments)}},A=C,w=A({}.toString),k=A("".slice),O=function(e){return k(w(e),8,-1)},P=c,M=O,D=Object,N=C("".split),U=P((function(){return!D("z").propertyIsEnumerable(0)}))?function(e){return"String"==M(e)?N(e,""):D(e)}:D,x=TypeError,L=function(e){if(null==e)throw x("Can't call method on "+e);return e},B=U,V=L,Y=function(e){return B(V(e))},j=function(e){return"function"==typeof e},F=j,H=function(e){return"object"==typeof e?null!==e:F(e)},K=s,z=j,W=function(e){return z(e)?e:void 0},G=function(e,t){return arguments.length<2?W(K[e]):K[e]&&K[e][t]},q=C({}.isPrototypeOf),J=G("navigator","userAgent")||"",X=s,Q=J,$=X.process,Z=X.Deno,ee=$&&$.versions||Z&&Z.version,te=ee&&ee.v8;te&&(v=(S=te.split("."))[0]>0&&S[0]<4?1:+(S[0]+S[1])),!v&&Q&&(!(S=Q.match(/Edge\/(\d+)/))||S[1]>=74)&&(S=Q.match(/Chrome\/(\d+)/))&&(v=+S[1]);var re=v,ie=re,ne=c,oe=!!Object.getOwnPropertySymbols&&!ne((function(){var e=Symbol();return!String(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&ie&&ie<41})),se=oe&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,ae=G,ce=j,ue=q,de=Object,le=se?function(e){return"symbol"==typeof e}:function(e){var t=ae("Symbol");return ce(t)&&ue(t.prototype,de(e))},he=String,fe=function(e){try{return he(e)}catch(t){return"Object"}},pe=j,me=fe,ge=TypeError,_e=function(e){if(pe(e))return e;throw ge(me(e)+" is not a function")},Se=_e,ve=function(e,t){var r=e[t];return null==r?void 0:Se(r)},ye=f,Ie=j,Te=H,Re=TypeError,Ee={exports:{}},be=s,Ce=Object.defineProperty,Ae=function(e,t){try{Ce(be,e,{value:t,configurable:!0,writable:!0})}catch(r){be[e]=t}return t},we=Ae,ke="__core-js_shared__",Oe=s[ke]||we(ke,{}),Pe=Oe;(Ee.exports=function(e,t){return Pe[e]||(Pe[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.23.3",mode:"global",copyright:"Â© 2014-2022 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.23.3/LICENSE",source:"https://github.com/zloirock/core-js"});var Me=L,De=Object,Ne=function(e){return De(Me(e))},Ue=Ne,xe=C({}.hasOwnProperty),Le=Object.hasOwn||function(e,t){return xe(Ue(e),t)},Be=C,Ve=0,Ye=Math.random(),je=Be(1..toString),Fe=function(e){return"Symbol("+(void 0===e?"":e)+")_"+je(++Ve+Ye,36)},He=s,Ke=Ee.exports,ze=Le,We=Fe,Ge=oe,qe=se,Je=Ke("wks"),Xe=He.Symbol,Qe=Xe&&Xe.for,$e=qe?Xe:Xe&&Xe.withoutSetter||We,Ze=function(e){if(!ze(Je,e)||!Ge&&"string"!=typeof Je[e]){var t="Symbol."+e;Ge&&ze(Xe,e)?Je[e]=Xe[e]:Je[e]=qe&&Qe?Qe(t):$e(t)}return Je[e]},et=f,tt=H,rt=le,it=ve,nt=function(e,t){var r,i;if("string"===t&&Ie(r=e.toString)&&!Te(i=ye(r,e)))return i;if(Ie(r=e.valueOf)&&!Te(i=ye(r,e)))return i;if("string"!==t&&Ie(r=e.toString)&&!Te(i=ye(r,e)))return i;throw Re("Can't convert object to primitive value")},ot=TypeError,st=Ze("toPrimitive"),at=function(e,t){if(!tt(e)||rt(e))return e;var r,i=it(e,st);if(i){if(void 0===t&&(t="default"),r=et(i,e,t),!tt(r)||rt(r))return r;throw ot("Can't convert object to primitive value")}return void 0===t&&(t="number"),nt(e,t)},ct=at,ut=le,dt=function(e){var t=ct(e,"string");return ut(t)?t:t+""},lt=H,ht=s.document,ft=lt(ht)&&lt(ht.createElement),pt=function(e){return ft?ht.createElement(e):{}},mt=pt,gt=!u&&!c((function(){return 7!=Object.defineProperty(mt("div"),"a",{get:function(){return 7}}).a})),_t=u,St=f,vt=p,yt=y,It=Y,Tt=dt,Rt=Le,Et=gt,bt=Object.getOwnPropertyDescriptor;a.f=_t?bt:function(e,t){if(e=It(e),t=Tt(t),Et)try{return bt(e,t)}catch(r){}if(Rt(e,t))return yt(!St(vt.f,e,t),e[t])};var Ct={},At=u&&c((function(){return 42!=Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype})),wt=H,kt=String,Ot=TypeError,Pt=function(e){if(wt(e))return e;throw Ot(kt(e)+" is not an object")},Mt=u,Dt=gt,Nt=At,Ut=Pt,xt=dt,Lt=TypeError,Bt=Object.defineProperty,Vt=Object.getOwnPropertyDescriptor,Yt="enumerable",jt="configurable",Ft="writable";Ct.f=Mt?Nt?function(e,t,r){if(Ut(e),t=xt(t),Ut(r),"function"==typeof e&&"prototype"===t&&"value"in r&&Ft in r&&!r.writable){var i=Vt(e,t);i&&i.writable&&(e[t]=r.value,r={configurable:jt in r?r.configurable:i.configurable,enumerable:Yt in r?r.enumerable:i.enumerable,writable:!1})}return Bt(e,t,r)}:Bt:function(e,t,r){if(Ut(e),t=xt(t),Ut(r),Dt)try{return Bt(e,t,r)}catch(i){}if("get"in r||"set"in r)throw Lt("Accessors not supported");return"value"in r&&(e[t]=r.value),e};var Ht=Ct,Kt=y,zt=u?function(e,t,r){return Ht.f(e,t,Kt(1,r))}:function(e,t,r){return e[t]=r,e},Wt={exports:{}},Gt=u,qt=Le,Jt=Function.prototype,Xt=Gt&&Object.getOwnPropertyDescriptor,Qt=qt(Jt,"name"),$t={EXISTS:Qt,PROPER:Qt&&"something"===function(){}.name,CONFIGURABLE:Qt&&(!Gt||Gt&&Xt(Jt,"name").configurable)},Zt=j,er=Oe,tr=C(Function.toString);Zt(er.inspectSource)||(er.inspectSource=function(e){return tr(e)});var rr,ir,nr,or=er.inspectSource,sr=j,ar=or,cr=s.WeakMap,ur=sr(cr)&&/native code/.test(ar(cr)),dr=Ee.exports,lr=Fe,hr=dr("keys"),fr=function(e){return hr[e]||(hr[e]=lr(e))},pr={},mr=ur,gr=s,_r=C,Sr=H,vr=zt,yr=Le,Ir=Oe,Tr=fr,Rr=pr,Er="Object already initialized",br=gr.TypeError,Cr=gr.WeakMap;if(mr||Ir.state){var Ar=Ir.state||(Ir.state=new Cr),wr=_r(Ar.get),kr=_r(Ar.has),Or=_r(Ar.set);rr=function(e,t){if(kr(Ar,e))throw new br(Er);return t.facade=e,Or(Ar,e,t),t},ir=function(e){return wr(Ar,e)||{}},nr=function(e){return kr(Ar,e)}}else{var Pr=Tr("state");Rr[Pr]=!0,rr=function(e,t){if(yr(e,Pr))throw new br(Er);return t.facade=e,vr(e,Pr,t),t},ir=function(e){return yr(e,Pr)?e[Pr]:{}},nr=function(e){return yr(e,Pr)}}var Mr={set:rr,get:ir,has:nr,enforce:function(e){return nr(e)?ir(e):rr(e,{})},getterFor:function(e){return function(t){var r;if(!Sr(t)||(r=ir(t)).type!==e)throw br("Incompatible receiver, "+e+" required");return r}}},Dr=c,Nr=j,Ur=Le,xr=u,Lr=$t.CONFIGURABLE,Br=or,Vr=Mr.enforce,Yr=Mr.get,jr=Object.defineProperty,Fr=xr&&!Dr((function(){return 8!==jr((function(){}),"length",{value:8}).length})),Hr=String(String).split("String"),Kr=Wt.exports=function(e,t,r){"Symbol("===String(t).slice(0,7)&&(t="["+String(t).replace(/^Symbol\(([^)]*)\)/,"$1")+"]"),r&&r.getter&&(t="get "+t),r&&r.setter&&(t="set "+t),(!Ur(e,"name")||Lr&&e.name!==t)&&(xr?jr(e,"name",{value:t,configurable:!0}):e.name=t),Fr&&r&&Ur(r,"arity")&&e.length!==r.arity&&jr(e,"length",{value:r.arity});try{r&&Ur(r,"constructor")&&r.constructor?xr&&jr(e,"prototype",{writable:!1}):e.prototype&&(e.prototype=void 0)}catch(n){}var i=Vr(e);return Ur(i,"source")||(i.source=Hr.join("string"==typeof t?t:"")),e};Function.prototype.toString=Kr((function(){return Nr(this)&&Yr(this).source||Br(this)}),"toString");var zr=j,Wr=Ct,Gr=Wt.exports,qr=Ae,Jr=function(e,t,r,i){i||(i={});var n=i.enumerable,o=void 0!==i.name?i.name:t;if(zr(r)&&Gr(r,o,i),i.global)n?e[t]=r:qr(t,r);else{try{i.unsafe?e[t]&&(n=!0):delete e[t]}catch(s){}n?e[t]=r:Wr.f(e,t,{value:r,enumerable:!1,configurable:!i.nonConfigurable,writable:!i.nonWritable})}return e},Xr={},Qr=Math.ceil,$r=Math.floor,Zr=Math.trunc||function(e){var t=+e;return(t>0?$r:Qr)(t)},ei=Zr,ti=function(e){var t=+e;return t!=t||0===t?0:ei(t)},ri=ti,ii=Math.max,ni=Math.min,oi=function(e,t){var r=ri(e);return r<0?ii(r+t,0):ni(r,t)},si=ti,ai=Math.min,ci=function(e){return e>0?ai(si(e),9007199254740991):0},ui=ci,di=function(e){return ui(e.length)},li=Y,hi=oi,fi=di,pi=function(e){return function(t,r,i){var n,o=li(t),s=fi(o),a=hi(i,s);if(e&&r!=r){for(;s>a;)if((n=o[a++])!=n)return!0}else for(;s>a;a++)if((e||a in o)&&o[a]===r)return e||a||0;return!e&&-1}},mi={includes:pi(!0),indexOf:pi(!1)},gi=Le,_i=Y,Si=mi.indexOf,vi=pr,yi=C([].push),Ii=function(e,t){var r,i=_i(e),n=0,o=[];for(r in i)!gi(vi,r)&&gi(i,r)&&yi(o,r);for(;t.length>n;)gi(i,r=t[n++])&&(~Si(o,r)||yi(o,r));return o},Ti=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Ri=Ii,Ei=Ti.concat("length","prototype");Xr.f=Object.getOwnPropertyNames||function(e){return Ri(e,Ei)};var bi={};bi.f=Object.getOwnPropertySymbols;var Ci=G,Ai=Xr,wi=bi,ki=Pt,Oi=C([].concat),Pi=Ci("Reflect","ownKeys")||function(e){var t=Ai.f(ki(e)),r=wi.f;return r?Oi(t,r(e)):t},Mi=Le,Di=Pi,Ni=a,Ui=Ct,xi=function(e,t,r){for(var i=Di(t),n=Ui.f,o=Ni.f,s=0;s<i.length;s++){var a=i[s];Mi(e,a)||r&&Mi(r,a)||n(e,a,o(t,a))}},Li=c,Bi=j,Vi=/#|\.prototype\./,Yi=function(e,t){var r=Fi[ji(e)];return r==Ki||r!=Hi&&(Bi(t)?Li(t):!!t)},ji=Yi.normalize=function(e){return String(e).replace(Vi,".").toLowerCase()},Fi=Yi.data={},Hi=Yi.NATIVE="N",Ki=Yi.POLYFILL="P",zi=Yi,Wi=s,Gi=a.f,qi=zt,Ji=Jr,Xi=Ae,Qi=xi,$i=zi,Zi=function(e,t){var r,i,n,o,s,a=e.target,c=e.global,u=e.stat;if(r=c?Wi:u?Wi[a]||Xi(a,{}):(Wi[a]||{}).prototype)for(i in t){if(o=t[i],n=e.dontCallGetSet?(s=Gi(r,i))&&s.value:r[i],!$i(c?i:a+(u?".":"#")+i,e.forced)&&void 0!==n){if(typeof o==typeof n)continue;Qi(o,n)}(e.sham||n&&n.sham)&&qi(o,"sham",!0),Ji(r,i,o,e)}},en="process"==O(s.process),tn=j,rn=String,nn=TypeError,on=C,sn=Pt,an=function(e){if("object"==typeof e||tn(e))return e;throw nn("Can't set "+rn(e)+" as a prototype")},cn=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,r={};try{(e=on(Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set))(r,[]),t=r instanceof Array}catch(i){}return function(r,i){return sn(r),an(i),t?e(r,i):r.__proto__=i,r}}():void 0),un=Ct.f,dn=Le,ln=Ze("toStringTag"),hn=function(e,t,r){e&&!r&&(e=e.prototype),e&&!dn(e,ln)&&un(e,ln,{configurable:!0,value:t})},fn=G,pn=Ct,mn=u,gn=Ze("species"),_n=function(e){var t=fn(e),r=pn.f;mn&&t&&!t[gn]&&r(t,gn,{configurable:!0,get:function(){return this}})},Sn=q,vn=TypeError,yn=function(e,t){if(Sn(t,e))return e;throw vn("Incorrect invocation")},In={};In[Ze("toStringTag")]="z";var Tn="[object z]"===String(In),Rn=j,En=O,bn=Ze("toStringTag"),Cn=Object,An="Arguments"==En(function(){return arguments}()),wn=Tn?En:function(e){var t,r,i;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(r=function(e,t){try{return e[t]}catch(r){}}(t=Cn(e),bn))?r:An?En(t):"Object"==(i=En(t))&&Rn(t.callee)?"Arguments":i},kn=C,On=c,Pn=j,Mn=wn,Dn=or,Nn=function(){},Un=[],xn=G("Reflect","construct"),Ln=/^\s*(?:class|function)\b/,Bn=kn(Ln.exec),Vn=!Ln.exec(Nn),Yn=function(e){if(!Pn(e))return!1;try{return xn(Nn,Un,e),!0}catch(t){return!1}},jn=function(e){if(!Pn(e))return!1;switch(Mn(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return Vn||!!Bn(Ln,Dn(e))}catch(t){return!0}};jn.sham=!0;var Fn,Hn,Kn,zn,Wn=!xn||On((function(){var e;return Yn(Yn.call)||!Yn(Object)||!Yn((function(){e=!0}))||e}))?jn:Yn,Gn=Wn,qn=fe,Jn=TypeError,Xn=function(e){if(Gn(e))return e;throw Jn(qn(e)+" is not a constructor")},Qn=Pt,$n=Xn,Zn=Ze("species"),eo=function(e,t){var r,i=Qn(e).constructor;return void 0===i||null==(r=Qn(i)[Zn])?t:$n(r)},to=d,ro=Function.prototype,io=ro.apply,no=ro.call,oo="object"==typeof Reflect&&Reflect.apply||(to?no.bind(io):function(){return no.apply(io,arguments)}),so=_e,ao=d,co=C(C.bind),uo=function(e,t){return so(e),void 0===t?e:ao?co(e,t):function(){return e.apply(t,arguments)}},lo=G("document","documentElement"),ho=C([].slice),fo=TypeError,po=/(?:ipad|iphone|ipod).*applewebkit/i.test(J),mo=s,go=oo,_o=uo,So=j,vo=Le,yo=c,Io=lo,To=ho,Ro=pt,Eo=function(e,t){if(e<t)throw fo("Not enough arguments");return e},bo=po,Co=en,Ao=mo.setImmediate,wo=mo.clearImmediate,ko=mo.process,Oo=mo.Dispatch,Po=mo.Function,Mo=mo.MessageChannel,Do=mo.String,No=0,Uo={},xo="onreadystatechange";try{Fn=mo.location}catch(kD){}var Lo=function(e){if(vo(Uo,e)){var t=Uo[e];delete Uo[e],t()}},Bo=function(e){return function(){Lo(e)}},Vo=function(e){Lo(e.data)},Yo=function(e){mo.postMessage(Do(e),Fn.protocol+"//"+Fn.host)};Ao&&wo||(Ao=function(e){Eo(arguments.length,1);var t=So(e)?e:Po(e),r=To(arguments,1);return Uo[++No]=function(){go(t,void 0,r)},Hn(No),No},wo=function(e){delete Uo[e]},Co?Hn=function(e){ko.nextTick(Bo(e))}:Oo&&Oo.now?Hn=function(e){Oo.now(Bo(e))}:Mo&&!bo?(zn=(Kn=new Mo).port2,Kn.port1.onmessage=Vo,Hn=_o(zn.postMessage,zn)):mo.addEventListener&&So(mo.postMessage)&&!mo.importScripts&&Fn&&"file:"!==Fn.protocol&&!yo(Yo)?(Hn=Yo,mo.addEventListener("message",Vo,!1)):Hn=xo in Ro("script")?function(e){Io.appendChild(Ro("script")).onreadystatechange=function(){Io.removeChild(this),Lo(e)}}:function(e){setTimeout(Bo(e),0)});var jo,Fo,Ho,Ko,zo,Wo,Go,qo,Jo={set:Ao,clear:wo},Xo=s,Qo=/ipad|iphone|ipod/i.test(J)&&void 0!==Xo.Pebble,$o=/web0s(?!.*chrome)/i.test(J),Zo=s,es=uo,ts=a.f,rs=Jo.set,is=po,ns=Qo,os=$o,ss=en,as=Zo.MutationObserver||Zo.WebKitMutationObserver,cs=Zo.document,us=Zo.process,ds=Zo.Promise,ls=ts(Zo,"queueMicrotask"),hs=ls&&ls.value;hs||(jo=function(){var e,t;for(ss&&(e=us.domain)&&e.exit();Fo;){t=Fo.fn,Fo=Fo.next;try{t()}catch(kD){throw Fo?Ko():Ho=void 0,kD}}Ho=void 0,e&&e.enter()},is||ss||os||!as||!cs?!ns&&ds&&ds.resolve?((Go=ds.resolve(void 0)).constructor=ds,qo=es(Go.then,Go),Ko=function(){qo(jo)}):ss?Ko=function(){us.nextTick(jo)}:(rs=es(rs,Zo),Ko=function(){rs(jo)}):(zo=!0,Wo=cs.createTextNode(""),new as(jo).observe(Wo,{characterData:!0}),Ko=function(){Wo.data=zo=!zo}));var fs=hs||function(e){var t={fn:e,next:void 0};Ho&&(Ho.next=t),Fo||(Fo=t,Ko()),Ho=t},ps=s,ms=function(e){try{return{error:!1,value:e()}}catch(kD){return{error:!0,value:kD}}},gs=function(){this.head=null,this.tail=null};gs.prototype={add:function(e){var t={item:e,next:null};this.head?this.tail.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return this.head=e.next,this.tail===e&&(this.tail=null),e.item}};var _s=gs,Ss=s.Promise,vs="object"==typeof window&&"object"!=typeof Deno,ys=s,Is=Ss,Ts=j,Rs=zi,Es=or,bs=Ze,Cs=vs,As=re;Is&&Is.prototype;var ws=bs("species"),ks=!1,Os=Ts(ys.PromiseRejectionEvent),Ps=Rs("Promise",(function(){var e=Es(Is),t=e!==String(Is);if(!t&&66===As)return!0;if(As>=51&&/native code/.test(e))return!1;var r=new Is((function(e){e(1)})),i=function(e){e((function(){}),(function(){}))};return(r.constructor={})[ws]=i,!(ks=r.then((function(){}))instanceof i)||!t&&Cs&&!Os})),Ms={CONSTRUCTOR:Ps,REJECTION_EVENT:Os,SUBCLASSING:ks},Ds={},Ns=_e,Us=function(e){var t,r;this.promise=new e((function(e,i){if(void 0!==t||void 0!==r)throw TypeError("Bad Promise constructor");t=e,r=i})),this.resolve=Ns(t),this.reject=Ns(r)};Ds.f=function(e){return new Us(e)};var xs,Ls,Bs,Vs=Zi,Ys=en,js=s,Fs=f,Hs=Jr,Ks=cn,zs=hn,Ws=_n,Gs=_e,qs=j,Js=H,Xs=yn,Qs=eo,$s=Jo.set,Zs=fs,ea=function(e,t){var r=ps.console;r&&r.error&&(1==arguments.length?r.error(e):r.error(e,t))},ta=ms,ra=_s,ia=Mr,na=Ss,oa=Ds,sa="Promise",aa=Ms.CONSTRUCTOR,ca=Ms.REJECTION_EVENT,ua=Ms.SUBCLASSING,da=ia.getterFor(sa),la=ia.set,ha=na&&na.prototype,fa=na,pa=ha,ma=js.TypeError,ga=js.document,_a=js.process,Sa=oa.f,va=Sa,ya=!!(ga&&ga.createEvent&&js.dispatchEvent),Ia="unhandledrejection",Ta=function(e){var t;return!(!Js(e)||!qs(t=e.then))&&t},Ra=function(e,t){var r,i,n,o=t.value,s=1==t.state,a=s?e.ok:e.fail,c=e.resolve,u=e.reject,d=e.domain;try{a?(s||(2===t.rejection&&wa(t),t.rejection=1),!0===a?r=o:(d&&d.enter(),r=a(o),d&&(d.exit(),n=!0)),r===e.promise?u(ma("Promise-chain cycle")):(i=Ta(r))?Fs(i,r,c,u):c(r)):u(o)}catch(kD){d&&!n&&d.exit(),u(kD)}},Ea=function(e,t){e.notified||(e.notified=!0,Zs((function(){for(var r,i=e.reactions;r=i.get();)Ra(r,e);e.notified=!1,t&&!e.rejection&&Ca(e)})))},ba=function(e,t,r){var i,n;ya?((i=ga.createEvent("Event")).promise=t,i.reason=r,i.initEvent(e,!1,!0),js.dispatchEvent(i)):i={promise:t,reason:r},!ca&&(n=js["on"+e])?n(i):e===Ia&&ea("Unhandled promise rejection",r)},Ca=function(e){Fs($s,js,(function(){var t,r=e.facade,i=e.value;if(Aa(e)&&(t=ta((function(){Ys?_a.emit("unhandledRejection",i,r):ba(Ia,r,i)})),e.rejection=Ys||Aa(e)?2:1,t.error))throw t.value}))},Aa=function(e){return 1!==e.rejection&&!e.parent},wa=function(e){Fs($s,js,(function(){var t=e.facade;Ys?_a.emit("rejectionHandled",t):ba("rejectionhandled",t,e.value)}))},ka=function(e,t,r){return function(i){e(t,i,r)}},Oa=function(e,t,r){e.done||(e.done=!0,r&&(e=r),e.value=t,e.state=2,Ea(e,!0))},Pa=function(e,t,r){if(!e.done){e.done=!0,r&&(e=r);try{if(e.facade===t)throw ma("Promise can't be resolved itself");var i=Ta(t);i?Zs((function(){var r={done:!1};try{Fs(i,t,ka(Pa,r,e),ka(Oa,r,e))}catch(kD){Oa(r,kD,e)}})):(e.value=t,e.state=1,Ea(e,!1))}catch(kD){Oa({done:!1},kD,e)}}};if(aa&&(pa=(fa=function(e){Xs(this,pa),Gs(e),Fs(xs,this);var t=da(this);try{e(ka(Pa,t),ka(Oa,t))}catch(kD){Oa(t,kD)}}).prototype,(xs=function(e){la(this,{type:sa,done:!1,notified:!1,parent:!1,reactions:new ra,rejection:!1,state:0,value:void 0})}).prototype=Hs(pa,"then",(function(e,t){var r=da(this),i=Sa(Qs(this,fa));return r.parent=!0,i.ok=!qs(e)||e,i.fail=qs(t)&&t,i.domain=Ys?_a.domain:void 0,0==r.state?r.reactions.add(i):Zs((function(){Ra(i,r)})),i.promise})),Ls=function(){var e=new xs,t=da(e);this.promise=e,this.resolve=ka(Pa,t),this.reject=ka(Oa,t)},oa.f=Sa=function(e){return e===fa||undefined===e?new Ls(e):va(e)},qs(na)&&ha!==Object.prototype)){Bs=ha.then,ua||Hs(ha,"then",(function(e,t){var r=this;return new fa((function(e,t){Fs(Bs,r,e,t)})).then(e,t)}),{unsafe:!0});try{delete ha.constructor}catch(kD){}Ks&&Ks(ha,pa)}Vs({global:!0,constructor:!0,wrap:!0,forced:aa},{Promise:fa}),zs(fa,sa,!1),Ws(sa);var Ma={},Da=Ma,Na=Ze("iterator"),Ua=Array.prototype,xa=function(e){return void 0!==e&&(Da.Array===e||Ua[Na]===e)},La=wn,Ba=ve,Va=Ma,Ya=Ze("iterator"),ja=function(e){if(null!=e)return Ba(e,Ya)||Ba(e,"@@iterator")||Va[La(e)]},Fa=f,Ha=_e,Ka=Pt,za=fe,Wa=ja,Ga=TypeError,qa=function(e,t){var r=arguments.length<2?Wa(e):t;if(Ha(r))return Ka(Fa(r,e));throw Ga(za(e)+" is not iterable")},Ja=f,Xa=Pt,Qa=ve,$a=uo,Za=f,ec=Pt,tc=fe,rc=xa,ic=di,nc=q,oc=qa,sc=ja,ac=function(e,t,r){var i,n;Xa(e);try{if(!(i=Qa(e,"return"))){if("throw"===t)throw r;return r}i=Ja(i,e)}catch(kD){n=!0,i=kD}if("throw"===t)throw r;if(n)throw i;return Xa(i),r},cc=TypeError,uc=function(e,t){this.stopped=e,this.result=t},dc=uc.prototype,lc=function(e,t,r){var i,n,o,s,a,c,u,d=r&&r.that,l=!(!r||!r.AS_ENTRIES),h=!(!r||!r.IS_ITERATOR),f=!(!r||!r.INTERRUPTED),p=$a(t,d),m=function(e){return i&&ac(i,"normal",e),new uc(!0,e)},g=function(e){return l?(ec(e),f?p(e[0],e[1],m):p(e[0],e[1])):f?p(e,m):p(e)};if(h)i=e;else{if(!(n=sc(e)))throw cc(tc(e)+" is not iterable");if(rc(n)){for(o=0,s=ic(e);s>o;o++)if((a=g(e[o]))&&nc(dc,a))return a;return new uc(!1)}i=oc(e,n)}for(c=i.next;!(u=Za(c,i)).done;){try{a=g(u.value)}catch(kD){ac(i,"throw",kD)}if("object"==typeof a&&a&&nc(dc,a))return a}return new uc(!1)},hc=Ze("iterator"),fc=!1;try{var pc=0,mc={next:function(){return{done:!!pc++}},return:function(){fc=!0}};mc[hc]=function(){return this},Array.from(mc,(function(){throw 2}))}catch(kD){}var gc=function(e,t){if(!t&&!fc)return!1;var r=!1;try{var i={};i[hc]=function(){return{next:function(){return{done:r=!0}}}},e(i)}catch(kD){}return r},_c=Ss,Sc=Ms.CONSTRUCTOR||!gc((function(e){_c.all(e).then(void 0,(function(){}))})),vc=f,yc=_e,Ic=Ds,Tc=ms,Rc=lc;Zi({target:"Promise",stat:!0,forced:Sc},{all:function(e){var t=this,r=Ic.f(t),i=r.resolve,n=r.reject,o=Tc((function(){var r=yc(t.resolve),o=[],s=0,a=1;Rc(e,(function(e){var c=s++,u=!1;a++,vc(r,t,e).then((function(e){u||(u=!0,o[c]=e,--a||i(o))}),n)})),--a||i(o)}));return o.error&&n(o.value),r.promise}});var Ec=Zi,bc=Ms.CONSTRUCTOR,Cc=Ss,Ac=G,wc=j,kc=Jr,Oc=Cc&&Cc.prototype;if(Ec({target:"Promise",proto:!0,forced:bc,real:!0},{catch:function(e){return this.then(void 0,e)}}),wc(Cc)){var Pc=Ac("Promise").prototype.catch;Oc.catch!==Pc&&kc(Oc,"catch",Pc,{unsafe:!0})}var Mc=f,Dc=_e,Nc=Ds,Uc=ms,xc=lc;Zi({target:"Promise",stat:!0,forced:Sc},{race:function(e){var t=this,r=Nc.f(t),i=r.reject,n=Uc((function(){var n=Dc(t.resolve);xc(e,(function(e){Mc(n,t,e).then(r.resolve,i)}))}));return n.error&&i(n.value),r.promise}});var Lc=f,Bc=Ds;Zi({target:"Promise",stat:!0,forced:Ms.CONSTRUCTOR},{reject:function(e){var t=Bc.f(this);return Lc(t.reject,void 0,e),t.promise}});var Vc=Pt,Yc=H,jc=Ds,Fc=function(e,t){if(Vc(e),Yc(t)&&t.constructor===e)return t;var r=jc.f(e);return(0,r.resolve)(t),r.promise},Hc=Zi,Kc=Ms.CONSTRUCTOR,zc=Fc;let Wc;G("Promise"),Hc({target:"Promise",stat:!0,forced:Kc},{resolve:function(e){return zc(this,e)}}),function(e){e[e.RTC_ERR_CODE_SUCCESS=0]="RTC_ERR_CODE_SUCCESS",e[e.RTC_ERR_CODE_RTC_SDK_ERROR=90000001]="RTC_ERR_CODE_RTC_SDK_ERROR",e[e.RTC_ERR_CODE_WAIT_RSP_TIMEOUT=90000004]="RTC_ERR_CODE_WAIT_RSP_TIMEOUT",e[e.RTC_ERR_CODE_INVALID_PARAMETER=90000005]="RTC_ERR_CODE_INVALID_PARAMETER",e[e.RTC_ERR_CODE_INVALID_OPERATION=90100001]="RTC_ERR_CODE_INVALID_OPERATION",e[e.RTC_ERR_CODE_NOT_SUPPORT_MEDIA_DEVICES=90100002]="RTC_ERR_CODE_NOT_SUPPORT_MEDIA_DEVICES",e[e.RTC_ERR_CODE_NO_AVAILABLE_DEVICES=90100003]="RTC_ERR_CODE_NO_AVAILABLE_DEVICES",e[e.RTC_ERR_CODE_NO_AVAILABLE_VIDEO_INPUT_DEVICES=90100004]="RTC_ERR_CODE_NO_AVAILABLE_VIDEO_INPUT_DEVICES",e[e.RTC_ERR_CODE_NO_AVAILABLE_AUDIO_INPUT_DEVICES=90100005]="RTC_ERR_CODE_NO_AVAILABLE_AUDIO_INPUT_DEVICES",e[e.RTC_ERR_CODE_NO_AVAILABLE_AUDIO_OUTPUT_DEVICES=90100006]="RTC_ERR_CODE_NO_AVAILABLE_AUDIO_OUTPUT_DEVICES",e[e.RTC_ERR_CODE_STATUS_ERROR=90100007]="RTC_ERR_CODE_STATUS_ERROR",e[e.RTC_ERR_CODE_WEBSOCKET_NOT_CONNECTED=90100008]="RTC_ERR_CODE_WEBSOCKET_NOT_CONNECTED",e[e.RTC_ERR_CODE_WAIT_CONFIG_FAIL=90100009]="RTC_ERR_CODE_WAIT_CONFIG_FAIL",e[e.RTC_ERR_CODE_PUBLISH_RESPONSE_FAIL=90100010]="RTC_ERR_CODE_PUBLISH_RESPONSE_FAIL",e[e.RTC_ERR_CODE_REGION_NOT_COVERED=90100011]="RTC_ERR_CODE_REGION_NOT_COVERED",e[e.RTC_ERR_CODE_WEBSOCKET_CONNECT_TIMEOUT=90100012]="RTC_ERR_CODE_WEBSOCKET_CONNECT_TIMEOUT",e[e.RTC_ERR_CODE_WEBSOCKET_RECONNECT_TIMEOUT=90100013]="RTC_ERR_CODE_WEBSOCKET_RECONNECT_TIMEOUT",e[e.RTC_ERR_CODE_WEBSOCKET_NOT_OPEN=90100014]="RTC_ERR_CODE_WEBSOCKET_NOT_OPEN",e[e.RTC_ERR_CODE_WEBSOCKET_INTERRUPTED=90100015]="RTC_ERR_CODE_WEBSOCKET_INTERRUPTED",e[e.RTC_ERR_CODE_WEBSOCKET_CONNECT_ERROR=90100016]="RTC_ERR_CODE_WEBSOCKET_CONNECT_ERROR",e[e.RTC_ERR_CODE_CAPTURE_PERMISSION_DENIED=90100017]="RTC_ERR_CODE_CAPTURE_PERMISSION_DENIED",e[e.RTC_ERR_CODE_CAPTURE_OVER_CONSTRAINED=90100018]="RTC_ERR_CODE_CAPTURE_OVER_CONSTRAINED",e[e.RTC_ERR_CODE_CAPTURE_DEVICE_NOT_FOUND=90100019]="RTC_ERR_CODE_CAPTURE_DEVICE_NOT_FOUND",e[e.RTC_ERR_CODE_CAPTURE_DEVICE_NOT_READABLE=90100020]="RTC_ERR_CODE_CAPTURE_DEVICE_NOT_READABLE",e[e.RTC_ERR_CODE_PLAY_NOT_ALLOW=90100021]="RTC_ERR_CODE_PLAY_NOT_ALLOW",e[e.RTC_ERR_CODE_ROLE_NO_PERMISSION=90100022]="RTC_ERR_CODE_ROLE_NO_PERMISSION",e[e.RTC_ERR_CODE_ANSWER_SDP_INVALID=90100023]="RTC_ERR_CODE_ANSWER_SDP_INVALID",e[e.RTC_ERR_CODE_MEDIA_UPSTREAM_UNSUPPORTED=90100024]="RTC_ERR_CODE_MEDIA_UPSTREAM_UNSUPPORTED",e[e.RTC_ERR_CODE_WEBRTC_UNSUPPORTED=90100025]="RTC_ERR_CODE_WEBRTC_UNSUPPORTED",e[e.RTC_ERR_CODE_MEDIA_NETWORK_ERROR=90100026]="RTC_ERR_CODE_MEDIA_NETWORK_ERROR",e[e.RTC_ERR_CODE_CLIENT_RELAY_ROOM_OVER_MAXNUM=90100027]="RTC_ERR_CODE_CLIENT_RELAY_ROOM_OVER_MAXNUM",e[e.RTC_ERR_CODE_CLIENT_RELAY_JOINER_OVER_MAXNUM=90100028]="RTC_ERR_CODE_CLIENT_RELAY_JOINER_OVER_MAXNUM",e[e.RTC_ERR_CODE_ROOM_STREAM_STATUS_PAUSED=90100029]="RTC_ERR_CODE_ROOM_STREAM_STATUS_PAUSED",e[e.RTC_ERR_CODE_SIGNATURE_EXPIRED=90100030]="RTC_ERR_CODE_SIGNATURE_EXPIRED",e[e.RTC_ERR_CODE_SIGNATURE_INVALID=90100031]="RTC_ERR_CODE_SIGNATURE_INVALID",e[e.RTC_ERR_CODE_RTC_ACS=90100100]="RTC_ERR_CODE_RTC_ACS",e[e.RTC_ERR_CODE_RTC_CONTROL_ERROR=90100200]="RTC_ERR_CODE_RTC_CONTROL_ERROR",e[e.RTC_ERR_CODE_SFU_ERROR=90100600]="RTC_ERR_CODE_SFU_ERROR"}(Wc||(Wc={}));const Gc={[Wc.RTC_ERR_CODE_SUCCESS]:"success",[Wc.RTC_ERR_CODE_RTC_SDK_ERROR]:"sdk internal error",[Wc.RTC_ERR_CODE_NOT_SUPPORT_MEDIA_DEVICES]:"not support enumerate devices",[Wc.RTC_ERR_CODE_NO_AVAILABLE_DEVICES]:"no available devices",[Wc.RTC_ERR_CODE_NO_AVAILABLE_VIDEO_INPUT_DEVICES]:"no available video input devices",[Wc.RTC_ERR_CODE_NO_AVAILABLE_AUDIO_INPUT_DEVICES]:"no available audio input devices",[Wc.RTC_ERR_CODE_NO_AVAILABLE_AUDIO_OUTPUT_DEVICES]:"no available audio output devices",[Wc.RTC_ERR_CODE_STATUS_ERROR]:"room status error",[Wc.RTC_ERR_CODE_INVALID_PARAMETER]:"invalid parameter",[Wc.RTC_ERR_CODE_WEBSOCKET_NOT_CONNECTED]:'websocket connection state is not "CONNECTED"',[Wc.RTC_ERR_CODE_WEBSOCKET_NOT_OPEN]:"websocket is not open",[Wc.RTC_ERR_CODE_WAIT_CONFIG_FAIL]:"wait server config fail",[Wc.RTC_ERR_CODE_WAIT_RSP_TIMEOUT]:"message response timeout",[Wc.RTC_ERR_CODE_PUBLISH_RESPONSE_FAIL]:"publish response fail",[Wc.RTC_ERR_CODE_REGION_NOT_COVERED]:"current region is not covered, service unavailable",[Wc.RTC_ERR_CODE_WEBSOCKET_CONNECT_TIMEOUT]:"websocket connect timeout",[Wc.RTC_ERR_CODE_WEBSOCKET_RECONNECT_TIMEOUT]:"websocket reconnect timeout",[Wc.RTC_ERR_CODE_WEBSOCKET_INTERRUPTED]:"websocket connection state is idle, interrupt operation",[Wc.RTC_ERR_CODE_CAPTURE_PERMISSION_DENIED]:"capture failed, permission denied",[Wc.RTC_ERR_CODE_CAPTURE_OVER_CONSTRAINED]:"capture failed, Constraint parameter invalid",[Wc.RTC_ERR_CODE_CAPTURE_DEVICE_NOT_FOUND]:"capture failed, requested device not found",[Wc.RTC_ERR_CODE_CAPTURE_DEVICE_NOT_READABLE]:"capture failed, maybe device is occupied by other application",[Wc.RTC_ERR_CODE_PLAY_NOT_ALLOW]:"the user didn't interact with the document first, please trigger by gesture",[Wc.RTC_ERR_CODE_ROLE_NO_PERMISSION]:"the user role have no permission to operate",[Wc.RTC_ERR_CODE_ANSWER_SDP_INVALID]:"the answer sdp is  invalid",[Wc.RTC_ERR_CODE_MEDIA_UPSTREAM_UNSUPPORTED]:"the upstream media is not supported",[Wc.RTC_ERR_CODE_WEBRTC_UNSUPPORTED]:"the browser does not support",[Wc.RTC_ERR_CODE_MEDIA_NETWORK_ERROR]:"media connection establish failed, please switch network or try again later",[Wc.RTC_ERR_CODE_CLIENT_RELAY_ROOM_OVER_MAXNUM]:"relay room number over maxium number.",[Wc.RTC_ERR_CODE_ROOM_STREAM_STATUS_PAUSED]:"room stream status paused",[Wc.RTC_ERR_CODE_CLIENT_RELAY_JOINER_OVER_MAXNUM]:"joiner already exist in relay rooms.",[Wc.RTC_ERR_CODE_SIGNATURE_INVALID]:"signature invalid",[Wc.RTC_ERR_CODE_SIGNATURE_EXPIRED]:"signature expired"};class qc extends Error{constructor(e,t){const r=e;let i,n="";r>9e7&&r<90100100||r<100?(i=r,n=t||r in Wc&&Gc[r]):r>=6e5&&r<7e5?(i=Wc.RTC_ERR_CODE_SFU_ERROR,n="code: ".concat(r,", msg: ").concat(t)):r>=2e5&&r<3e5?(i=Wc.RTC_ERR_CODE_RTC_CONTROL_ERROR,n="code: ".concat(r,", msg: ").concat(t)):r>=1e5&&r<2e5?(i=Wc.RTC_ERR_CODE_RTC_ACS,n="code: ".concat(r,", msg: ").concat(t)):(n="unknow error",i=r),super(n),this.code=i,this.message=n}getCode(){return this.code}getMsg(){return this.message}toString(){return'["code": '.concat(this.code,', "message": "').concat(this.message,'"]')}}var Jc=wn,Xc=String,Qc=function(e){if("Symbol"===Jc(e))throw TypeError("Cannot convert a Symbol value to a string");return Xc(e)},$c=Zi,Zc=u,eu=s,tu=C,ru=Le,iu=j,nu=q,ou=Qc,su=Ct.f,au=xi,cu=eu.Symbol,uu=cu&&cu.prototype;if(Zc&&iu(cu)&&(!("description"in uu)||void 0!==cu().description)){var du={},lu=function(){var e=arguments.length<1||void 0===arguments[0]?void 0:ou(arguments[0]),t=nu(uu,this)?new cu(e):void 0===e?cu():cu(e);return""===e&&(du[t]=!0),t};au(lu,cu),lu.prototype=uu,uu.constructor=lu;var hu="Symbol(test)"==String(cu("test")),fu=tu(uu.toString),pu=tu(uu.valueOf),mu=/^Symbol\((.*)\)[^)]+$/,gu=tu("".replace),_u=tu("".slice);su(uu,"description",{configurable:!0,get:function(){var e=pu(this),t=fu(e);if(ru(du,e))return"";var r=hu?_u(t,7,-1):gu(t,mu,"$1");return""===r?void 0:r}}),$c({global:!0,constructor:!0,forced:!0},{Symbol:lu})}var Su={},vu=Ii,yu=Ti,Iu=Object.keys||function(e){return vu(e,yu)},Tu=u,Ru=At,Eu=Ct,bu=Pt,Cu=Y,Au=Iu;Su.f=Tu&&!Ru?Object.defineProperties:function(e,t){bu(e);for(var r,i=Cu(t),n=Au(t),o=n.length,s=0;o>s;)Eu.f(e,r=n[s++],i[r]);return e};var wu,ku=Pt,Ou=Su,Pu=Ti,Mu=pr,Du=lo,Nu=pt,Uu=fr("IE_PROTO"),xu=function(){},Lu=function(e){return"<script>"+e+"</"+"script>"},Bu=function(e){e.write(Lu("")),e.close();var t=e.parentWindow.Object;return e=null,t},Vu=function(){try{wu=new ActiveXObject("htmlfile")}catch(kD){}var e,t;Vu="undefined"!=typeof document?document.domain&&wu?Bu(wu):((t=Nu("iframe")).style.display="none",Du.appendChild(t),t.src=String("javascript:"),(e=t.contentWindow.document).open(),e.write(Lu("document.F=Object")),e.close(),e.F):Bu(wu);for(var r=Pu.length;r--;)delete Vu.prototype[Pu[r]];return Vu()};Mu[Uu]=!0;var Yu=Object.create||function(e,t){var r;return null!==e?(xu.prototype=ku(e),r=new xu,xu.prototype=null,r[Uu]=e):r=Vu(),void 0===t?r:Ou.f(r,t)},ju=Ze,Fu=Yu,Hu=Ct.f,Ku=ju("unscopables"),zu=Array.prototype;null==zu[Ku]&&Hu(zu,Ku,{configurable:!0,value:Fu(null)});var Wu,Gu,qu,Ju=function(e){zu[Ku][e]=!0},Xu=!c((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),Qu=Le,$u=j,Zu=Ne,ed=Xu,td=fr("IE_PROTO"),rd=Object,id=rd.prototype,nd=ed?rd.getPrototypeOf:function(e){var t=Zu(e);if(Qu(t,td))return t[td];var r=t.constructor;return $u(r)&&t instanceof r?r.prototype:t instanceof rd?id:null},od=c,sd=j,ad=nd,cd=Jr,ud=Ze("iterator"),dd=!1;[].keys&&("next"in(qu=[].keys())?(Gu=ad(ad(qu)))!==Object.prototype&&(Wu=Gu):dd=!0);var ld=null==Wu||od((function(){var e={};return Wu[ud].call(e)!==e}));ld&&(Wu={}),sd(Wu[ud])||cd(Wu,ud,(function(){return this}));var hd={IteratorPrototype:Wu,BUGGY_SAFARI_ITERATORS:dd},fd=hd.IteratorPrototype,pd=Yu,md=y,gd=hn,_d=Ma,Sd=function(){return this},vd=Zi,yd=f,Id=j,Td=function(e,t,r,i){var n=t+" Iterator";return e.prototype=pd(fd,{next:md(+!i,r)}),gd(e,n,!1),_d[n]=Sd,e},Rd=nd,Ed=cn,bd=hn,Cd=zt,Ad=Jr,wd=Ma,kd=$t.PROPER,Od=$t.CONFIGURABLE,Pd=hd.IteratorPrototype,Md=hd.BUGGY_SAFARI_ITERATORS,Dd=Ze("iterator"),Nd="keys",Ud="values",xd="entries",Ld=function(){return this},Bd=Y,Vd=Ju,Yd=Ma,jd=Mr,Fd=Ct.f,Hd=function(e,t,r,i,n,o,s){Td(r,t,i);var a,c,u,d=function(e){if(e===n&&m)return m;if(!Md&&e in f)return f[e];switch(e){case Nd:case Ud:case xd:return function(){return new r(this,e)}}return function(){return new r(this)}},l=t+" Iterator",h=!1,f=e.prototype,p=f[Dd]||f["@@iterator"]||n&&f[n],m=!Md&&p||d(n),g="Array"==t&&f.entries||p;if(g&&(a=Rd(g.call(new e)))!==Object.prototype&&a.next&&(Rd(a)!==Pd&&(Ed?Ed(a,Pd):Id(a[Dd])||Ad(a,Dd,Ld)),bd(a,l,!0)),kd&&n==Ud&&p&&p.name!==Ud&&(Od?Cd(f,"name",Ud):(h=!0,m=function(){return yd(p,this)})),n)if(c={values:d(Ud),keys:o?m:d(Nd),entries:d(xd)},s)for(u in c)(Md||h||!(u in f))&&Ad(f,u,c[u]);else vd({target:t,proto:!0,forced:Md||h},c);return f[Dd]!==m&&Ad(f,Dd,m,{name:n}),wd[t]=m,c},Kd=u,zd="Array Iterator",Wd=jd.set,Gd=jd.getterFor(zd),qd=Hd(Array,"Array",(function(e,t){Wd(this,{type:zd,target:Bd(e),index:0,kind:t})}),(function(){var e=Gd(this),t=e.target,r=e.kind,i=e.index++;return!t||i>=t.length?(e.target=void 0,{value:void 0,done:!0}):"keys"==r?{value:i,done:!1}:"values"==r?{value:t[i],done:!1}:{value:[i,t[i]],done:!1}}),"values"),Jd=Yd.Arguments=Yd.Array;if(Vd("keys"),Vd("values"),Vd("entries"),Kd&&"values"!==Jd.name)try{Fd(Jd,"name",{value:"values"})}catch(kD){}var Xd=f,Qd=_e,$d=Pt,Zd=function(){for(var e,t=$d(this),r=Qd(t.delete),i=!0,n=0,o=arguments.length;n<o;n++)e=Xd(r,t,arguments[n]),i=i&&e;return!!i};Zi({target:"Map",proto:!0,real:!0,forced:!0},{deleteAll:Zd});var el=f,tl=function(e){return el(Map.prototype.entries,e)},rl=Pt,il=uo,nl=tl,ol=lc;Zi({target:"Map",proto:!0,real:!0,forced:!0},{every:function(e){var t=rl(this),r=nl(t),i=il(e,arguments.length>1?arguments[1]:void 0);return!ol(r,(function(e,r,n){if(!i(r,e,t))return n()}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var sl=G,al=uo,cl=f,ul=_e,dl=Pt,ll=eo,hl=tl,fl=lc;Zi({target:"Map",proto:!0,real:!0,forced:!0},{filter:function(e){var t=dl(this),r=hl(t),i=al(e,arguments.length>1?arguments[1]:void 0),n=new(ll(t,sl("Map"))),o=ul(n.set);return fl(r,(function(e,r){i(r,e,t)&&cl(o,n,e,r)}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),n}});var pl=Pt,ml=uo,gl=tl,_l=lc;Zi({target:"Map",proto:!0,real:!0,forced:!0},{find:function(e){var t=pl(this),r=gl(t),i=ml(e,arguments.length>1?arguments[1]:void 0);return _l(r,(function(e,r,n){if(i(r,e,t))return n(r)}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).result}});var Sl=Pt,vl=uo,yl=tl,Il=lc;Zi({target:"Map",proto:!0,real:!0,forced:!0},{findKey:function(e){var t=Sl(this),r=yl(t),i=vl(e,arguments.length>1?arguments[1]:void 0);return Il(r,(function(e,r,n){if(i(r,e,t))return n(e)}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).result}});var Tl=Pt,Rl=tl,El=function(e,t){return e===t||e!=e&&t!=t},bl=lc;Zi({target:"Map",proto:!0,real:!0,forced:!0},{includes:function(e){return bl(Rl(Tl(this)),(function(t,r,i){if(El(r,e))return i()}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var Cl=Pt,Al=tl,wl=lc;Zi({target:"Map",proto:!0,real:!0,forced:!0},{keyOf:function(e){return wl(Al(Cl(this)),(function(t,r,i){if(r===e)return i(t)}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).result}});var kl=G,Ol=uo,Pl=f,Ml=_e,Dl=Pt,Nl=eo,Ul=tl,xl=lc;Zi({target:"Map",proto:!0,real:!0,forced:!0},{mapKeys:function(e){var t=Dl(this),r=Ul(t),i=Ol(e,arguments.length>1?arguments[1]:void 0),n=new(Nl(t,kl("Map"))),o=Ml(n.set);return xl(r,(function(e,r){Pl(o,n,i(r,e,t),r)}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),n}});var Ll=G,Bl=uo,Vl=f,Yl=_e,jl=Pt,Fl=eo,Hl=tl,Kl=lc;Zi({target:"Map",proto:!0,real:!0,forced:!0},{mapValues:function(e){var t=jl(this),r=Hl(t),i=Bl(e,arguments.length>1?arguments[1]:void 0),n=new(Fl(t,Ll("Map"))),o=Yl(n.set);return Kl(r,(function(e,r){Vl(o,n,e,i(r,e,t))}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),n}});var zl=_e,Wl=Pt,Gl=lc;Zi({target:"Map",proto:!0,real:!0,arity:1,forced:!0},{merge:function(e){for(var t=Wl(this),r=zl(t.set),i=arguments.length,n=0;n<i;)Gl(arguments[n++],r,{that:t,AS_ENTRIES:!0});return t}});var ql=Pt,Jl=_e,Xl=tl,Ql=lc,$l=TypeError;Zi({target:"Map",proto:!0,real:!0,forced:!0},{reduce:function(e){var t=ql(this),r=Xl(t),i=arguments.length<2,n=i?void 0:arguments[1];if(Jl(e),Ql(r,(function(r,o){i?(i=!1,n=o):n=e(n,o,r,t)}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),i)throw $l("Reduce of empty map with no initial value");return n}});var Zl=Pt,eh=uo,th=tl,rh=lc;Zi({target:"Map",proto:!0,real:!0,forced:!0},{some:function(e){var t=Zl(this),r=th(t),i=eh(e,arguments.length>1?arguments[1]:void 0);return rh(r,(function(e,r,n){if(i(r,e,t))return n()}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var ih=f,nh=Pt,oh=_e,sh=TypeError;Zi({target:"Map",proto:!0,real:!0,forced:!0},{update:function(e,t){var r=nh(this),i=oh(r.get),n=oh(r.has),o=oh(r.set),s=arguments.length;oh(t);var a=ih(n,r,e);if(!a&&s<3)throw sh("Updating absent value");var c=a?ih(i,r,e):oh(s>2?arguments[2]:void 0)(e,r);return ih(o,r,e,t(c,e,r)),r}});var ah={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},ch=pt("span").classList,uh=ch&&ch.constructor&&ch.constructor.prototype,dh=uh===Object.prototype?void 0:uh,lh=s,hh=ah,fh=dh,ph=qd,mh=zt,gh=Ze,_h=gh("iterator"),Sh=gh("toStringTag"),vh=ph.values,yh=function(e,t){if(e){if(e[_h]!==vh)try{mh(e,_h,vh)}catch(kD){e[_h]=vh}if(e[Sh]||mh(e,Sh,t),hh[t])for(var r in ph)if(e[r]!==ph[r])try{mh(e,r,ph[r])}catch(kD){e[r]=ph[r]}}};for(var Ih in hh)yh(lh[Ih]&&lh[Ih].prototype,Ih);yh(fh,"DOMTokenList");var Th=O,Rh=Array.isArray||function(e){return"Array"==Th(e)},Eh=Wn,bh=H,Ch=Ze("species"),Ah=Array,wh=function(e){var t;return Rh(e)&&(t=e.constructor,(Eh(t)&&(t===Ah||Rh(t.prototype))||bh(t)&&null===(t=t[Ch]))&&(t=void 0)),void 0===t?Ah:t},kh=uo,Oh=U,Ph=Ne,Mh=di,Dh=function(e,t){return new(wh(e))(0===t?0:t)},Nh=C([].push),Uh=function(e){var t=1==e,r=2==e,i=3==e,n=4==e,o=6==e,s=7==e,a=5==e||o;return function(c,u,d,l){for(var h,f,p=Ph(c),m=Oh(p),g=kh(u,d),_=Mh(m),S=0,v=l||Dh,y=t?v(c,_):r||s?v(c,0):void 0;_>S;S++)if((a||S in m)&&(f=g(h=m[S],S,p),e))if(t)y[S]=f;else if(f)switch(e){case 3:return!0;case 5:return h;case 6:return S;case 2:Nh(y,h)}else switch(e){case 4:return!1;case 7:Nh(y,h)}return o?-1:i||n?n:y}},xh={forEach:Uh(0),map:Uh(1),filter:Uh(2),some:Uh(3),every:Uh(4),find:Uh(5),findIndex:Uh(6),filterReject:Uh(7)},Lh=c,Bh=function(e,t){var r=[][e];return!!r&&Lh((function(){r.call(null,t||function(){return 1},1)}))},Vh=xh.forEach,Yh=Bh("forEach")?[].forEach:function(e){return Vh(this,e,arguments.length>1?arguments[1]:void 0)},jh=s,Fh=ah,Hh=dh,Kh=Yh,zh=zt,Wh=function(e){if(e&&e.forEach!==Kh)try{zh(e,"forEach",Kh)}catch(kD){e.forEach=Kh}};for(var Gh in Fh)Fh[Gh]&&Wh(jh[Gh]&&jh[Gh].prototype);Wh(Hh);var qh=mi.includes,Jh=Ju;Zi({target:"Array",proto:!0,forced:c((function(){return!Array(1).includes()}))},{includes:function(e){return qh(this,e,arguments.length>1?arguments[1]:void 0)}}),Jh("includes");var Xh=Pt,Qh=function(){var e=Xh(this),t="";return e.hasIndices&&(t+="d"),e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.unicodeSets&&(t+="v"),e.sticky&&(t+="y"),t},$h=c,Zh=s.RegExp,ef=$h((function(){var e=Zh("a","y");return e.lastIndex=2,null!=e.exec("abcd")})),tf=ef||$h((function(){return!Zh("a","y").sticky})),rf={BROKEN_CARET:ef||$h((function(){var e=Zh("^r","gy");return e.lastIndex=2,null!=e.exec("str")})),MISSED_STICKY:tf,UNSUPPORTED_Y:ef},nf=c,of=s.RegExp,sf=nf((function(){var e=of(".","s");return!(e.dotAll&&e.exec("\n")&&"s"===e.flags)})),af=c,cf=s.RegExp,uf=af((function(){var e=cf("(?<a>b)","g");return"b"!==e.exec("b").groups.a||"bc"!=="b".replace(e,"$<a>c")})),df=f,lf=C,hf=Qc,ff=Qh,pf=rf,mf=Ee.exports,gf=Yu,_f=Mr.get,Sf=sf,vf=uf,yf=mf("native-string-replace",String.prototype.replace),If=RegExp.prototype.exec,Tf=If,Rf=lf("".charAt),Ef=lf("".indexOf),bf=lf("".replace),Cf=lf("".slice),Af=function(){var e=/a/,t=/b*/g;return df(If,e,"a"),df(If,t,"a"),0!==e.lastIndex||0!==t.lastIndex}(),wf=pf.BROKEN_CARET,kf=void 0!==/()??/.exec("")[1];(Af||kf||wf||Sf||vf)&&(Tf=function(e){var t,r,i,n,o,s,a,c=this,u=_f(c),d=hf(e),l=u.raw;if(l)return l.lastIndex=c.lastIndex,t=df(Tf,l,d),c.lastIndex=l.lastIndex,t;var h=u.groups,f=wf&&c.sticky,p=df(ff,c),m=c.source,g=0,_=d;if(f&&(p=bf(p,"y",""),-1===Ef(p,"g")&&(p+="g"),_=Cf(d,c.lastIndex),c.lastIndex>0&&(!c.multiline||c.multiline&&"\n"!==Rf(d,c.lastIndex-1))&&(m="(?: "+m+")",_=" "+_,g++),r=new RegExp("^(?:"+m+")",p)),kf&&(r=new RegExp("^"+m+"$(?!\\s)",p)),Af&&(i=c.lastIndex),n=df(If,f?r:c,_),f?n?(n.input=Cf(n.input,g),n[0]=Cf(n[0],g),n.index=c.lastIndex,c.lastIndex+=n[0].length):c.lastIndex=0:Af&&n&&(c.lastIndex=c.global?n.index+n[0].length:i),kf&&n&&n.length>1&&df(yf,n[0],r,(function(){for(o=1;o<arguments.length-2;o++)void 0===arguments[o]&&(n[o]=void 0)})),n&&h)for(n.groups=s=gf(null),o=0;o<h.length;o++)s[(a=h[o])[0]]=n[a[1]];return n});var Of=Tf;Zi({target:"RegExp",proto:!0,forced:/./.exec!==Of},{exec:Of});var Pf=C,Mf=Jr,Df=Of,Nf=c,Uf=Ze,xf=zt,Lf=Uf("species"),Bf=RegExp.prototype,Vf=C,Yf=ti,jf=Qc,Ff=L,Hf=Vf("".charAt),Kf=Vf("".charCodeAt),zf=Vf("".slice),Wf=function(e){return function(t,r){var i,n,o=jf(Ff(t)),s=Yf(r),a=o.length;return s<0||s>=a?e?"":void 0:(i=Kf(o,s))<55296||i>56319||s+1===a||(n=Kf(o,s+1))<56320||n>57343?e?Hf(o,s):i:e?zf(o,s,s+2):n-56320+(i-55296<<10)+65536}},Gf={codeAt:Wf(!1),charAt:Wf(!0)}.charAt,qf=C,Jf=Ne,Xf=Math.floor,Qf=qf("".charAt),$f=qf("".replace),Zf=qf("".slice),ep=/\$([$&'`]|\d{1,2}|<[^>]*>)/g,tp=/\$([$&'`]|\d{1,2})/g,rp=f,ip=Pt,np=j,op=O,sp=Of,ap=TypeError,cp=oo,up=f,dp=C,lp=function(e,t,r,i){var n=Uf(e),o=!Nf((function(){var t={};return t[n]=function(){return 7},7!=""[e](t)})),s=o&&!Nf((function(){var t=!1,r=/a/;return"split"===e&&((r={}).constructor={},r.constructor[Lf]=function(){return r},r.flags="",r[n]=/./[n]),r.exec=function(){return t=!0,null},r[n](""),!t}));if(!o||!s||r){var a=Pf(/./[n]),c=t(n,""[e],(function(e,t,r,i,n){var s=Pf(e),c=t.exec;return c===Df||c===Bf.exec?o&&!n?{done:!0,value:a(t,r,i)}:{done:!0,value:s(r,t,i)}:{done:!1}}));Mf(String.prototype,e,c[0]),Mf(Bf,n,c[1])}i&&xf(Bf[n],"sham",!0)},hp=c,fp=Pt,pp=j,mp=ti,gp=ci,_p=Qc,Sp=L,vp=function(e,t,r){return t+(r?Gf(e,t).length:1)},yp=ve,Ip=function(e,t,r,i,n,o){var s=r+e.length,a=i.length,c=tp;return void 0!==n&&(n=Jf(n),c=ep),$f(o,c,(function(o,c){var u;switch(Qf(c,0)){case"$":return"$";case"&":return e;case"`":return Zf(t,0,r);case"'":return Zf(t,s);case"<":u=n[Zf(c,1,-1)];break;default:var d=+c;if(0===d)return o;if(d>a){var l=Xf(d/10);return 0===l?o:l<=a?void 0===i[l-1]?Qf(c,1):i[l-1]+Qf(c,1):o}u=i[d-1]}return void 0===u?"":u}))},Tp=function(e,t){var r=e.exec;if(np(r)){var i=rp(r,e,t);return null!==i&&ip(i),i}if("RegExp"===op(e))return rp(sp,e,t);throw ap("RegExp#exec called on incompatible receiver")},Rp=Ze("replace"),Ep=Math.max,bp=Math.min,Cp=dp([].concat),Ap=dp([].push),wp=dp("".indexOf),kp=dp("".slice),Op="$0"==="a".replace(/./,"$0"),Pp=!!/./[Rp]&&""===/./[Rp]("a","$0");lp("replace",(function(e,t,r){var i=Pp?"$":"$0";return[function(e,r){var i=Sp(this),n=null==e?void 0:yp(e,Rp);return n?up(n,e,i,r):up(t,_p(i),e,r)},function(e,n){var o=fp(this),s=_p(e);if("string"==typeof n&&-1===wp(n,i)&&-1===wp(n,"$<")){var a=r(t,o,s,n);if(a.done)return a.value}var c=pp(n);c||(n=_p(n));var u=o.global;if(u){var d=o.unicode;o.lastIndex=0}for(var l=[];;){var h=Tp(o,s);if(null===h)break;if(Ap(l,h),!u)break;""===_p(h[0])&&(o.lastIndex=vp(s,gp(o.lastIndex),d))}for(var f,p="",m=0,g=0;g<l.length;g++){for(var _=_p((h=l[g])[0]),S=Ep(bp(mp(h.index),s.length),0),v=[],y=1;y<h.length;y++)Ap(v,void 0===(f=h[y])?f:String(f));var I=h.groups;if(c){var T=Cp([_],v,S,s);void 0!==I&&Ap(T,I);var R=_p(cp(n,void 0,T))}else R=Ip(_,s,S,v,I,n);S>=m&&(p+=kp(s,m,S)+R,m=S+_.length)}return p+kp(s,m)}]}),!!hp((function(){var e=/./;return e.exec=function(){var e=[];return e.groups={a:"7"},e},"7"!=="".replace(e,"$<a>")}))||!Op||Pp);var Mp=j,Dp=H,Np=cn,Up=function(e,t,r){var i,n;return Np&&Mp(i=t.constructor)&&i!==r&&Dp(n=i.prototype)&&n!==r.prototype&&Np(e,n),e},xp=H,Lp=O,Bp=Ze("match"),Vp=f,Yp=Le,jp=q,Fp=Qh,Hp=RegExp.prototype,Kp=Ct.f,zp=u,Wp=s,Gp=C,qp=zi,Jp=Up,Xp=zt,Qp=Xr.f,$p=q,Zp=function(e){var t;return xp(e)&&(void 0!==(t=e[Bp])?!!t:"RegExp"==Lp(e))},em=Qc,tm=function(e){var t=e.flags;return void 0!==t||"flags"in Hp||Yp(e,"flags")||!jp(Hp,e)?t:Vp(Fp,e)},rm=rf,im=function(e,t,r){r in e||Kp(e,r,{configurable:!0,get:function(){return t[r]},set:function(e){t[r]=e}})},nm=Jr,om=c,sm=Le,am=Mr.enforce,cm=_n,um=sf,dm=uf,lm=Ze("match"),hm=Wp.RegExp,fm=hm.prototype,pm=Wp.SyntaxError,mm=Gp(fm.exec),gm=Gp("".charAt),_m=Gp("".replace),Sm=Gp("".indexOf),vm=Gp("".slice),ym=/^\?<[^\s\d!#%&*+<=>@^][^\s!#%&*+<=>@^]*>/,Im=/a/g,Tm=/a/g,Rm=new hm(Im)!==Im,Em=rm.MISSED_STICKY,bm=rm.UNSUPPORTED_Y,Cm=zp&&(!Rm||Em||um||dm||om((function(){return Tm[lm]=!1,hm(Im)!=Im||hm(Tm)==Tm||"/a/i"!=hm(Im,"i")})));if(qp("RegExp",Cm)){for(var Am=function(e,t){var r,i,n,o,s,a,c=$p(fm,this),u=Zp(e),d=void 0===t,l=[],h=e;if(!c&&u&&d&&e.constructor===Am)return e;if((u||$p(fm,e))&&(e=e.source,d&&(t=tm(h))),e=void 0===e?"":em(e),t=void 0===t?"":em(t),h=e,um&&"dotAll"in Im&&(i=!!t&&Sm(t,"s")>-1)&&(t=_m(t,/s/g,"")),r=t,Em&&"sticky"in Im&&(n=!!t&&Sm(t,"y")>-1)&&bm&&(t=_m(t,/y/g,"")),dm&&(o=function(e){for(var t,r=e.length,i=0,n="",o=[],s={},a=!1,c=!1,u=0,d="";i<=r;i++){if("\\"===(t=gm(e,i)))t+=gm(e,++i);else if("]"===t)a=!1;else if(!a)switch(!0){case"["===t:a=!0;break;case"("===t:mm(ym,vm(e,i+1))&&(i+=2,c=!0),n+=t,u++;continue;case">"===t&&c:if(""===d||sm(s,d))throw new pm("Invalid capture group name");s[d]=!0,o[o.length]=[d,u],c=!1,d="";continue}c?d+=t:n+=t}return[n,o]}(e),e=o[0],l=o[1]),s=Jp(hm(e,t),c?this:fm,Am),(i||n||l.length)&&(a=am(s),i&&(a.dotAll=!0,a.raw=Am(function(e){for(var t,r=e.length,i=0,n="",o=!1;i<=r;i++)"\\"!==(t=gm(e,i))?o||"."!==t?("["===t?o=!0:"]"===t&&(o=!1),n+=t):n+="[\\s\\S]":n+=t+gm(e,++i);return n}(e),r)),n&&(a.sticky=!0),l.length&&(a.groups=l)),e!==h)try{Xp(s,"source",""===h?"(?:)":h)}catch(kD){}return s},wm=Qp(hm),km=0;wm.length>km;)im(Am,hm,wm[km++]);fm.constructor=Am,Am.prototype=fm,nm(Wp,"RegExp",Am,{constructor:!0})}cm("RegExp");const Om=["none","error","warn","info","debug"];var Pm="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},Mm=[],Dm=[],Nm="undefined"!=typeof Uint8Array?Uint8Array:Array,Um=!1;function xm(){Um=!0;for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=0,r=e.length;t<r;++t)Mm[t]=e[t],Dm[e.charCodeAt(t)]=t;Dm["-".charCodeAt(0)]=62,Dm["_".charCodeAt(0)]=63}function Lm(e,t,r){for(var i,n,o=[],s=t;s<r;s+=3)i=(e[s]<<16)+(e[s+1]<<8)+e[s+2],o.push(Mm[(n=i)>>18&63]+Mm[n>>12&63]+Mm[n>>6&63]+Mm[63&n]);return o.join("")}function Bm(e){var t;Um||xm();for(var r=e.length,i=r%3,n="",o=[],s=16383,a=0,c=r-i;a<c;a+=s)o.push(Lm(e,a,a+s>c?c:a+s));return 1===i?(t=e[r-1],n+=Mm[t>>2],n+=Mm[t<<4&63],n+="=="):2===i&&(t=(e[r-2]<<8)+e[r-1],n+=Mm[t>>10],n+=Mm[t>>4&63],n+=Mm[t<<2&63],n+="="),o.push(n),o.join("")}function Vm(e,t,r,i,n){var o,s,a=8*n-i-1,c=(1<<a)-1,u=c>>1,d=-7,l=r?n-1:0,h=r?-1:1,f=e[t+l];for(l+=h,o=f&(1<<-d)-1,f>>=-d,d+=a;d>0;o=256*o+e[t+l],l+=h,d-=8);for(s=o&(1<<-d)-1,o>>=-d,d+=i;d>0;s=256*s+e[t+l],l+=h,d-=8);if(0===o)o=1-u;else{if(o===c)return s?NaN:1/0*(f?-1:1);s+=Math.pow(2,i),o-=u}return(f?-1:1)*s*Math.pow(2,o-i)}function Ym(e,t,r,i,n,o){var s,a,c,u=8*o-n-1,d=(1<<u)-1,l=d>>1,h=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,f=i?0:o-1,p=i?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=d):(s=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-s))<1&&(s--,c*=2),(t+=s+l>=1?h/c:h*Math.pow(2,1-l))*c>=2&&(s++,c/=2),s+l>=d?(a=0,s=d):s+l>=1?(a=(t*c-1)*Math.pow(2,n),s+=l):(a=t*Math.pow(2,l-1)*Math.pow(2,n),s=0));n>=8;e[r+f]=255&a,f+=p,a/=256,n-=8);for(s=s<<n|a,u+=n;u>0;e[r+f]=255&s,f+=p,s/=256,u-=8);e[r+f-p]|=128*m}var jm={}.toString,Fm=Array.isArray||function(e){return"[object Array]"==jm.call(e)};function Hm(){return zm.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function Km(e,t){if(Hm()<t)throw new RangeError("Invalid typed array length");return zm.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=zm.prototype:(null===e&&(e=new zm(t)),e.length=t),e}function zm(e,t,r){if(!(zm.TYPED_ARRAY_SUPPORT||this instanceof zm))return new zm(e,t,r);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return qm(this,e)}return Wm(this,e,t,r)}function Wm(e,t,r,i){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,r,i){if(t.byteLength,r<0||t.byteLength<r)throw new RangeError("'offset' is out of bounds");if(t.byteLength<r+(i||0))throw new RangeError("'length' is out of bounds");t=void 0===r&&void 0===i?new Uint8Array(t):void 0===i?new Uint8Array(t,r):new Uint8Array(t,r,i);zm.TYPED_ARRAY_SUPPORT?(e=t).__proto__=zm.prototype:e=Jm(e,t);return e}(e,t,r,i):"string"==typeof t?function(e,t,r){"string"==typeof r&&""!==r||(r="utf8");if(!zm.isEncoding(r))throw new TypeError('"encoding" must be a valid string encoding');var i=0|$m(t,r),n=(e=Km(e,i)).write(t,r);n!==i&&(e=e.slice(0,n));return e}(e,t,r):function(e,t){if(Qm(t)){var r=0|Xm(t.length);return 0===(e=Km(e,r)).length||t.copy(e,0,0,r),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(i=t.length)!=i?Km(e,0):Jm(e,t);if("Buffer"===t.type&&Fm(t.data))return Jm(e,t.data)}var i;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function Gm(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function qm(e,t){if(Gm(t),e=Km(e,t<0?0:0|Xm(t)),!zm.TYPED_ARRAY_SUPPORT)for(var r=0;r<t;++r)e[r]=0;return e}function Jm(e,t){var r=t.length<0?0:0|Xm(t.length);e=Km(e,r);for(var i=0;i<r;i+=1)e[i]=255&t[i];return e}function Xm(e){if(e>=Hm())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+Hm().toString(16)+" bytes");return 0|e}function Qm(e){return!(null==e||!e._isBuffer)}function $m(e,t){if(Qm(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var r=e.length;if(0===r)return 0;for(var i=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":case void 0:return bg(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return Cg(e).length;default:if(i)return bg(e).length;t=(""+t).toLowerCase(),i=!0}}function Zm(e,t,r){var i=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return pg(this,t,r);case"utf8":case"utf-8":return dg(this,t,r);case"ascii":return hg(this,t,r);case"latin1":case"binary":return fg(this,t,r);case"base64":return ug(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return mg(this,t,r);default:if(i)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),i=!0}}function eg(e,t,r){var i=e[t];e[t]=e[r],e[r]=i}function tg(e,t,r,i,n){if(0===e.length)return-1;if("string"==typeof r?(i=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,isNaN(r)&&(r=n?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(n)return-1;r=e.length-1}else if(r<0){if(!n)return-1;r=0}if("string"==typeof t&&(t=zm.from(t,i)),Qm(t))return 0===t.length?-1:rg(e,t,r,i,n);if("number"==typeof t)return t&=255,zm.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?n?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):rg(e,[t],r,i,n);throw new TypeError("val must be string, number or Buffer")}function rg(e,t,r,i,n){var o,s=1,a=e.length,c=t.length;if(void 0!==i&&("ucs2"===(i=String(i).toLowerCase())||"ucs-2"===i||"utf16le"===i||"utf-16le"===i)){if(e.length<2||t.length<2)return-1;s=2,a/=2,c/=2,r/=2}function u(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(n){var d=-1;for(o=r;o<a;o++)if(u(e,o)===u(t,-1===d?0:o-d)){if(-1===d&&(d=o),o-d+1===c)return d*s}else-1!==d&&(o-=o-d),d=-1}else for(r+c>a&&(r=a-c),o=r;o>=0;o--){for(var l=!0,h=0;h<c;h++)if(u(e,o+h)!==u(t,h)){l=!1;break}if(l)return o}return-1}function ig(e,t,r,i){r=Number(r)||0;var n=e.length-r;i?(i=Number(i))>n&&(i=n):i=n;var o=t.length;if(o%2!=0)throw new TypeError("Invalid hex string");i>o/2&&(i=o/2);for(var s=0;s<i;++s){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[r+s]=a}return s}function ng(e,t,r,i){return Ag(bg(t,e.length-r),e,r,i)}function og(e,t,r,i){return Ag(function(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,i)}function sg(e,t,r,i){return og(e,t,r,i)}function ag(e,t,r,i){return Ag(Cg(t),e,r,i)}function cg(e,t,r,i){return Ag(function(e,t){for(var r,i,n,o=[],s=0;s<e.length&&!((t-=2)<0);++s)i=(r=e.charCodeAt(s))>>8,n=r%256,o.push(n),o.push(i);return o}(t,e.length-r),e,r,i)}function ug(e,t,r){return 0===t&&r===e.length?Bm(e):Bm(e.slice(t,r))}function dg(e,t,r){r=Math.min(e.length,r);for(var i=[],n=t;n<r;){var o,s,a,c,u=e[n],d=null,l=u>239?4:u>223?3:u>191?2:1;if(n+l<=r)switch(l){case 1:u<128&&(d=u);break;case 2:128==(192&(o=e[n+1]))&&(c=(31&u)<<6|63&o)>127&&(d=c);break;case 3:o=e[n+1],s=e[n+2],128==(192&o)&&128==(192&s)&&(c=(15&u)<<12|(63&o)<<6|63&s)>2047&&(c<55296||c>57343)&&(d=c);break;case 4:o=e[n+1],s=e[n+2],a=e[n+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&(c=(15&u)<<18|(63&o)<<12|(63&s)<<6|63&a)>65535&&c<1114112&&(d=c)}null===d?(d=65533,l=1):d>65535&&(d-=65536,i.push(d>>>10&1023|55296),d=56320|1023&d),i.push(d),n+=l}return function(e){var t=e.length;if(t<=lg)return String.fromCharCode.apply(String,e);var r="",i=0;for(;i<t;)r+=String.fromCharCode.apply(String,e.slice(i,i+=lg));return r}(i)}zm.TYPED_ARRAY_SUPPORT=void 0===Pm.TYPED_ARRAY_SUPPORT||Pm.TYPED_ARRAY_SUPPORT,Hm(),zm.poolSize=8192,zm._augment=function(e){return e.__proto__=zm.prototype,e},zm.from=function(e,t,r){return Wm(null,e,t,r)},zm.TYPED_ARRAY_SUPPORT&&(zm.prototype.__proto__=Uint8Array.prototype,zm.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&zm[Symbol.species]),zm.alloc=function(e,t,r){return function(e,t,r,i){return Gm(t),t<=0?Km(e,t):void 0!==r?"string"==typeof i?Km(e,t).fill(r,i):Km(e,t).fill(r):Km(e,t)}(null,e,t,r)},zm.allocUnsafe=function(e){return qm(null,e)},zm.allocUnsafeSlow=function(e){return qm(null,e)},zm.isBuffer=wg,zm.compare=function(e,t){if(!Qm(e)||!Qm(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var r=e.length,i=t.length,n=0,o=Math.min(r,i);n<o;++n)if(e[n]!==t[n]){r=e[n],i=t[n];break}return r<i?-1:i<r?1:0},zm.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},zm.concat=function(e,t){if(!Fm(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return zm.alloc(0);var r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;var i=zm.allocUnsafe(t),n=0;for(r=0;r<e.length;++r){var o=e[r];if(!Qm(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(i,n),n+=o.length}return i},zm.byteLength=$m,zm.prototype._isBuffer=!0,zm.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)eg(this,t,t+1);return this},zm.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)eg(this,t,t+3),eg(this,t+1,t+2);return this},zm.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)eg(this,t,t+7),eg(this,t+1,t+6),eg(this,t+2,t+5),eg(this,t+3,t+4);return this},zm.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?dg(this,0,e):Zm.apply(this,arguments)},zm.prototype.equals=function(e){if(!Qm(e))throw new TypeError("Argument must be a Buffer");return this===e||0===zm.compare(this,e)},zm.prototype.inspect=function(){var e="";return this.length>0&&(e=this.toString("hex",0,50).match(/.{2}/g).join(" "),this.length>50&&(e+=" ... ")),"<Buffer "+e+">"},zm.prototype.compare=function(e,t,r,i,n){if(!Qm(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===i&&(i=0),void 0===n&&(n=this.length),t<0||r>e.length||i<0||n>this.length)throw new RangeError("out of range index");if(i>=n&&t>=r)return 0;if(i>=n)return-1;if(t>=r)return 1;if(this===e)return 0;for(var o=(n>>>=0)-(i>>>=0),s=(r>>>=0)-(t>>>=0),a=Math.min(o,s),c=this.slice(i,n),u=e.slice(t,r),d=0;d<a;++d)if(c[d]!==u[d]){o=c[d],s=u[d];break}return o<s?-1:s<o?1:0},zm.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},zm.prototype.indexOf=function(e,t,r){return tg(this,e,t,r,!0)},zm.prototype.lastIndexOf=function(e,t,r){return tg(this,e,t,r,!1)},zm.prototype.write=function(e,t,r,i){if(void 0===t)i="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)i=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(r)?(r|=0,void 0===i&&(i="utf8")):(i=r,r=void 0)}var n=this.length-t;if((void 0===r||r>n)&&(r=n),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");i||(i="utf8");for(var o=!1;;)switch(i){case"hex":return ig(this,e,t,r);case"utf8":case"utf-8":return ng(this,e,t,r);case"ascii":return og(this,e,t,r);case"latin1":case"binary":return sg(this,e,t,r);case"base64":return ag(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return cg(this,e,t,r);default:if(o)throw new TypeError("Unknown encoding: "+i);i=(""+i).toLowerCase(),o=!0}},zm.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var lg=4096;function hg(e,t,r){var i="";r=Math.min(e.length,r);for(var n=t;n<r;++n)i+=String.fromCharCode(127&e[n]);return i}function fg(e,t,r){var i="";r=Math.min(e.length,r);for(var n=t;n<r;++n)i+=String.fromCharCode(e[n]);return i}function pg(e,t,r){var i=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>i)&&(r=i);for(var n="",o=t;o<r;++o)n+=Eg(e[o]);return n}function mg(e,t,r){for(var i=e.slice(t,r),n="",o=0;o<i.length;o+=2)n+=String.fromCharCode(i[o]+256*i[o+1]);return n}function gg(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function _g(e,t,r,i,n,o){if(!Qm(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>n||t<o)throw new RangeError('"value" argument is out of bounds');if(r+i>e.length)throw new RangeError("Index out of range")}function Sg(e,t,r,i){t<0&&(t=65535+t+1);for(var n=0,o=Math.min(e.length-r,2);n<o;++n)e[r+n]=(t&255<<8*(i?n:1-n))>>>8*(i?n:1-n)}function vg(e,t,r,i){t<0&&(t=4294967295+t+1);for(var n=0,o=Math.min(e.length-r,4);n<o;++n)e[r+n]=t>>>8*(i?n:3-n)&255}function yg(e,t,r,i,n,o){if(r+i>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function Ig(e,t,r,i,n){return n||yg(e,0,r,4),Ym(e,t,r,i,23,4),r+4}function Tg(e,t,r,i,n){return n||yg(e,0,r,8),Ym(e,t,r,i,52,8),r+8}zm.prototype.slice=function(e,t){var r,i=this.length;if((e=~~e)<0?(e+=i)<0&&(e=0):e>i&&(e=i),(t=void 0===t?i:~~t)<0?(t+=i)<0&&(t=0):t>i&&(t=i),t<e&&(t=e),zm.TYPED_ARRAY_SUPPORT)(r=this.subarray(e,t)).__proto__=zm.prototype;else{var n=t-e;r=new zm(n,void 0);for(var o=0;o<n;++o)r[o]=this[o+e]}return r},zm.prototype.readUIntLE=function(e,t,r){e|=0,t|=0,r||gg(e,t,this.length);for(var i=this[e],n=1,o=0;++o<t&&(n*=256);)i+=this[e+o]*n;return i},zm.prototype.readUIntBE=function(e,t,r){e|=0,t|=0,r||gg(e,t,this.length);for(var i=this[e+--t],n=1;t>0&&(n*=256);)i+=this[e+--t]*n;return i},zm.prototype.readUInt8=function(e,t){return t||gg(e,1,this.length),this[e]},zm.prototype.readUInt16LE=function(e,t){return t||gg(e,2,this.length),this[e]|this[e+1]<<8},zm.prototype.readUInt16BE=function(e,t){return t||gg(e,2,this.length),this[e]<<8|this[e+1]},zm.prototype.readUInt32LE=function(e,t){return t||gg(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},zm.prototype.readUInt32BE=function(e,t){return t||gg(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},zm.prototype.readIntLE=function(e,t,r){e|=0,t|=0,r||gg(e,t,this.length);for(var i=this[e],n=1,o=0;++o<t&&(n*=256);)i+=this[e+o]*n;return i>=(n*=128)&&(i-=Math.pow(2,8*t)),i},zm.prototype.readIntBE=function(e,t,r){e|=0,t|=0,r||gg(e,t,this.length);for(var i=t,n=1,o=this[e+--i];i>0&&(n*=256);)o+=this[e+--i]*n;return o>=(n*=128)&&(o-=Math.pow(2,8*t)),o},zm.prototype.readInt8=function(e,t){return t||gg(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},zm.prototype.readInt16LE=function(e,t){t||gg(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},zm.prototype.readInt16BE=function(e,t){t||gg(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},zm.prototype.readInt32LE=function(e,t){return t||gg(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},zm.prototype.readInt32BE=function(e,t){return t||gg(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},zm.prototype.readFloatLE=function(e,t){return t||gg(e,4,this.length),Vm(this,e,!0,23,4)},zm.prototype.readFloatBE=function(e,t){return t||gg(e,4,this.length),Vm(this,e,!1,23,4)},zm.prototype.readDoubleLE=function(e,t){return t||gg(e,8,this.length),Vm(this,e,!0,52,8)},zm.prototype.readDoubleBE=function(e,t){return t||gg(e,8,this.length),Vm(this,e,!1,52,8)},zm.prototype.writeUIntLE=function(e,t,r,i){(e=+e,t|=0,r|=0,i)||_g(this,e,t,r,Math.pow(2,8*r)-1,0);var n=1,o=0;for(this[t]=255&e;++o<r&&(n*=256);)this[t+o]=e/n&255;return t+r},zm.prototype.writeUIntBE=function(e,t,r,i){(e=+e,t|=0,r|=0,i)||_g(this,e,t,r,Math.pow(2,8*r)-1,0);var n=r-1,o=1;for(this[t+n]=255&e;--n>=0&&(o*=256);)this[t+n]=e/o&255;return t+r},zm.prototype.writeUInt8=function(e,t,r){return e=+e,t|=0,r||_g(this,e,t,1,255,0),zm.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},zm.prototype.writeUInt16LE=function(e,t,r){return e=+e,t|=0,r||_g(this,e,t,2,65535,0),zm.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):Sg(this,e,t,!0),t+2},zm.prototype.writeUInt16BE=function(e,t,r){return e=+e,t|=0,r||_g(this,e,t,2,65535,0),zm.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):Sg(this,e,t,!1),t+2},zm.prototype.writeUInt32LE=function(e,t,r){return e=+e,t|=0,r||_g(this,e,t,4,4294967295,0),zm.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):vg(this,e,t,!0),t+4},zm.prototype.writeUInt32BE=function(e,t,r){return e=+e,t|=0,r||_g(this,e,t,4,4294967295,0),zm.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):vg(this,e,t,!1),t+4},zm.prototype.writeIntLE=function(e,t,r,i){if(e=+e,t|=0,!i){var n=Math.pow(2,8*r-1);_g(this,e,t,r,n-1,-n)}var o=0,s=1,a=0;for(this[t]=255&e;++o<r&&(s*=256);)e<0&&0===a&&0!==this[t+o-1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+r},zm.prototype.writeIntBE=function(e,t,r,i){if(e=+e,t|=0,!i){var n=Math.pow(2,8*r-1);_g(this,e,t,r,n-1,-n)}var o=r-1,s=1,a=0;for(this[t+o]=255&e;--o>=0&&(s*=256);)e<0&&0===a&&0!==this[t+o+1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+r},zm.prototype.writeInt8=function(e,t,r){return e=+e,t|=0,r||_g(this,e,t,1,127,-128),zm.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},zm.prototype.writeInt16LE=function(e,t,r){return e=+e,t|=0,r||_g(this,e,t,2,32767,-32768),zm.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):Sg(this,e,t,!0),t+2},zm.prototype.writeInt16BE=function(e,t,r){return e=+e,t|=0,r||_g(this,e,t,2,32767,-32768),zm.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):Sg(this,e,t,!1),t+2},zm.prototype.writeInt32LE=function(e,t,r){return e=+e,t|=0,r||_g(this,e,t,4,2147483647,-2147483648),zm.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):vg(this,e,t,!0),t+4},zm.prototype.writeInt32BE=function(e,t,r){return e=+e,t|=0,r||_g(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),zm.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):vg(this,e,t,!1),t+4},zm.prototype.writeFloatLE=function(e,t,r){return Ig(this,e,t,!0,r)},zm.prototype.writeFloatBE=function(e,t,r){return Ig(this,e,t,!1,r)},zm.prototype.writeDoubleLE=function(e,t,r){return Tg(this,e,t,!0,r)},zm.prototype.writeDoubleBE=function(e,t,r){return Tg(this,e,t,!1,r)},zm.prototype.copy=function(e,t,r,i){if(r||(r=0),i||0===i||(i=this.length),t>=e.length&&(t=e.length),t||(t=0),i>0&&i<r&&(i=r),i===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("sourceStart out of bounds");if(i<0)throw new RangeError("sourceEnd out of bounds");i>this.length&&(i=this.length),e.length-t<i-r&&(i=e.length-t+r);var n,o=i-r;if(this===e&&r<t&&t<i)for(n=o-1;n>=0;--n)e[n+t]=this[n+r];else if(o<1e3||!zm.TYPED_ARRAY_SUPPORT)for(n=0;n<o;++n)e[n+t]=this[n+r];else Uint8Array.prototype.set.call(e,this.subarray(r,r+o),t);return o},zm.prototype.fill=function(e,t,r,i){if("string"==typeof e){if("string"==typeof t?(i=t,t=0,r=this.length):"string"==typeof r&&(i=r,r=this.length),1===e.length){var n=e.charCodeAt(0);n<256&&(e=n)}if(void 0!==i&&"string"!=typeof i)throw new TypeError("encoding must be a string");if("string"==typeof i&&!zm.isEncoding(i))throw new TypeError("Unknown encoding: "+i)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;var o;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(o=t;o<r;++o)this[o]=e;else{var s=Qm(e)?e:bg(new zm(e,i).toString()),a=s.length;for(o=0;o<r-t;++o)this[o+t]=s[o%a]}return this};var Rg=/[^+\/0-9A-Za-z-_]/g;function Eg(e){return e<16?"0"+e.toString(16):e.toString(16)}function bg(e,t){var r;t=t||1/0;for(var i=e.length,n=null,o=[],s=0;s<i;++s){if((r=e.charCodeAt(s))>55295&&r<57344){if(!n){if(r>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(s+1===i){(t-=3)>-1&&o.push(239,191,189);continue}n=r;continue}if(r<56320){(t-=3)>-1&&o.push(239,191,189),n=r;continue}r=65536+(n-55296<<10|r-56320)}else n&&(t-=3)>-1&&o.push(239,191,189);if(n=null,r<128){if((t-=1)<0)break;o.push(r)}else if(r<2048){if((t-=2)<0)break;o.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;o.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return o}function Cg(e){return function(e){var t,r,i,n,o,s;Um||xm();var a=e.length;if(a%4>0)throw new Error("Invalid string. Length must be a multiple of 4");o="="===e[a-2]?2:"="===e[a-1]?1:0,s=new Nm(3*a/4-o),i=o>0?a-4:a;var c=0;for(t=0,r=0;t<i;t+=4,r+=3)n=Dm[e.charCodeAt(t)]<<18|Dm[e.charCodeAt(t+1)]<<12|Dm[e.charCodeAt(t+2)]<<6|Dm[e.charCodeAt(t+3)],s[c++]=n>>16&255,s[c++]=n>>8&255,s[c++]=255&n;return 2===o?(n=Dm[e.charCodeAt(t)]<<2|Dm[e.charCodeAt(t+1)]>>4,s[c++]=255&n):1===o&&(n=Dm[e.charCodeAt(t)]<<10|Dm[e.charCodeAt(t+1)]<<4|Dm[e.charCodeAt(t+2)]>>2,s[c++]=n>>8&255,s[c++]=255&n),s}(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(Rg,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function Ag(e,t,r,i){for(var n=0;n<i&&!(n+r>=t.length||n>=e.length);++n)t[n+r]=e[n];return n}function wg(e){return null!=e&&(!!e._isBuffer||kg(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&kg(e.slice(0,0))}(e))}function kg(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}function Og(){throw new Error("setTimeout has not been defined")}function Pg(){throw new Error("clearTimeout has not been defined")}var Mg=Og,Dg=Pg;function Ng(e){if(Mg===setTimeout)return setTimeout(e,0);if((Mg===Og||!Mg)&&setTimeout)return Mg=setTimeout,setTimeout(e,0);try{return Mg(e,0)}catch(lw){try{return Mg.call(null,e,0)}catch(lw){return Mg.call(this,e,0)}}}"function"==typeof Pm.setTimeout&&(Mg=setTimeout),"function"==typeof Pm.clearTimeout&&(Dg=clearTimeout);var Ug,xg=[],Lg=!1,Bg=-1;function Vg(){Lg&&Ug&&(Lg=!1,Ug.length?xg=Ug.concat(xg):Bg=-1,xg.length&&Yg())}function Yg(){if(!Lg){var e=Ng(Vg);Lg=!0;for(var t=xg.length;t;){for(Ug=xg,xg=[];++Bg<t;)Ug&&Ug[Bg].run();Bg=-1,t=xg.length}Ug=null,Lg=!1,function(e){if(Dg===clearTimeout)return clearTimeout(e);if((Dg===Pg||!Dg)&&clearTimeout)return Dg=clearTimeout,clearTimeout(e);try{Dg(e)}catch(lw){try{return Dg.call(null,e)}catch(lw){return Dg.call(this,e)}}}(e)}}function jg(e,t){this.fun=e,this.array=t}jg.prototype.run=function(){this.fun.apply(null,this.array)};var Fg=Pm.performance||{};function Hg(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}Fg.now||Fg.mozNow||Fg.msNow||Fg.oNow||Fg.webkitNow;var Kg={exports:{}};!function(e,t){e.exports=function e(t,r,i){function n(s,a){if(!r[s]){if(!t[s]){if(!a&&Hg)return Hg(s);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var u=r[s]={exports:{}};t[s][0].call(u.exports,(function(e){return n(t[s][1][e]||e)}),u,u.exports,e,t,r,i)}return r[s].exports}for(var o=Hg,s=0;s<i.length;s++)n(i[s]);return n}({1:[function(e,t,r){var i=e("./utils"),n=e("./support"),o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";r.encode=function(e){for(var t,r,n,s,a,c,u,d=[],l=0,h=e.length,f=h,p="string"!==i.getTypeOf(e);l<e.length;)f=h-l,n=p?(t=e[l++],r=l<h?e[l++]:0,l<h?e[l++]:0):(t=e.charCodeAt(l++),r=l<h?e.charCodeAt(l++):0,l<h?e.charCodeAt(l++):0),s=t>>2,a=(3&t)<<4|r>>4,c=1<f?(15&r)<<2|n>>6:64,u=2<f?63&n:64,d.push(o.charAt(s)+o.charAt(a)+o.charAt(c)+o.charAt(u));return d.join("")},r.decode=function(e){var t,r,i,s,a,c,u=0,d=0,l="data:";if(e.substr(0,l.length)===l)throw new Error("Invalid base64 input, it looks like a data url.");var h,f=3*(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"")).length/4;if(e.charAt(e.length-1)===o.charAt(64)&&f--,e.charAt(e.length-2)===o.charAt(64)&&f--,f%1!=0)throw new Error("Invalid base64 input, bad content length.");for(h=n.uint8array?new Uint8Array(0|f):new Array(0|f);u<e.length;)t=o.indexOf(e.charAt(u++))<<2|(s=o.indexOf(e.charAt(u++)))>>4,r=(15&s)<<4|(a=o.indexOf(e.charAt(u++)))>>2,i=(3&a)<<6|(c=o.indexOf(e.charAt(u++))),h[d++]=t,64!==a&&(h[d++]=r),64!==c&&(h[d++]=i);return h}},{"./support":30,"./utils":32}],2:[function(e,t,r){var i=e("./external"),n=e("./stream/DataWorker"),o=e("./stream/Crc32Probe"),s=e("./stream/DataLengthProbe");function a(e,t,r,i,n){this.compressedSize=e,this.uncompressedSize=t,this.crc32=r,this.compression=i,this.compressedContent=n}a.prototype={getContentWorker:function(){var e=new n(i.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new s("data_length")),t=this;return e.on("end",(function(){if(this.streamInfo.data_length!==t.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")})),e},getCompressedWorker:function(){return new n(i.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},a.createWorkerFrom=function(e,t,r){return e.pipe(new o).pipe(new s("uncompressedSize")).pipe(t.compressWorker(r)).pipe(new s("compressedSize")).withStreamInfo("compression",t)},t.exports=a},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,t,r){var i=e("./stream/GenericWorker");r.STORE={magic:"\0\0",compressWorker:function(e){return new i("STORE compression")},uncompressWorker:function(){return new i("STORE decompression")}},r.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,t,r){var i=e("./utils"),n=function(){for(var e,t=[],r=0;r<256;r++){e=r;for(var i=0;i<8;i++)e=1&e?3988292384^e>>>1:e>>>1;t[r]=e}return t}();t.exports=function(e,t){return void 0!==e&&e.length?"string"!==i.getTypeOf(e)?function(e,t,r,i){var o=n,s=i+r;e^=-1;for(var a=i;a<s;a++)e=e>>>8^o[255&(e^t[a])];return-1^e}(0|t,e,e.length,0):function(e,t,r,i){var o=n,s=i+r;e^=-1;for(var a=i;a<s;a++)e=e>>>8^o[255&(e^t.charCodeAt(a))];return-1^e}(0|t,e,e.length,0):0}},{"./utils":32}],5:[function(e,t,r){r.base64=!1,r.binary=!1,r.dir=!1,r.createFolders=!0,r.date=null,r.compression=null,r.compressionOptions=null,r.comment=null,r.unixPermissions=null,r.dosPermissions=null},{}],6:[function(e,t,r){var i=null;i="undefined"!=typeof Promise?Promise:e("lie"),t.exports={Promise:i}},{lie:37}],7:[function(e,t,r){var i="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array,n=e("pako"),o=e("./utils"),s=e("./stream/GenericWorker"),a=i?"uint8array":"array";function c(e,t){s.call(this,"FlateWorker/"+e),this._pako=null,this._pakoAction=e,this._pakoOptions=t,this.meta={}}r.magic="\b\0",o.inherits(c,s),c.prototype.processChunk=function(e){this.meta=e.meta,null===this._pako&&this._createPako(),this._pako.push(o.transformTo(a,e.data),!1)},c.prototype.flush=function(){s.prototype.flush.call(this),null===this._pako&&this._createPako(),this._pako.push([],!0)},c.prototype.cleanUp=function(){s.prototype.cleanUp.call(this),this._pako=null},c.prototype._createPako=function(){this._pako=new n[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var e=this;this._pako.onData=function(t){e.push({data:t,meta:e.meta})}},r.compressWorker=function(e){return new c("Deflate",e)},r.uncompressWorker=function(){return new c("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,t,r){function i(e,t){var r,i="";for(r=0;r<t;r++)i+=String.fromCharCode(255&e),e>>>=8;return i}function n(e,t,r,n,s,d){var l,h,f=e.file,p=e.compression,m=d!==a.utf8encode,g=o.transformTo("string",d(f.name)),_=o.transformTo("string",a.utf8encode(f.name)),S=f.comment,v=o.transformTo("string",d(S)),y=o.transformTo("string",a.utf8encode(S)),I=_.length!==f.name.length,T=y.length!==S.length,R="",E="",b="",C=f.dir,A=f.date,w={crc32:0,compressedSize:0,uncompressedSize:0};t&&!r||(w.crc32=e.crc32,w.compressedSize=e.compressedSize,w.uncompressedSize=e.uncompressedSize);var k=0;t&&(k|=8),m||!I&&!T||(k|=2048);var O=0,P=0;C&&(O|=16),"UNIX"===s?(P=798,O|=function(e,t){var r=e;return e||(r=t?16893:33204),(65535&r)<<16}(f.unixPermissions,C)):(P=20,O|=function(e){return 63&(e||0)}(f.dosPermissions)),l=A.getUTCHours(),l<<=6,l|=A.getUTCMinutes(),l<<=5,l|=A.getUTCSeconds()/2,h=A.getUTCFullYear()-1980,h<<=4,h|=A.getUTCMonth()+1,h<<=5,h|=A.getUTCDate(),I&&(E=i(1,1)+i(c(g),4)+_,R+="up"+i(E.length,2)+E),T&&(b=i(1,1)+i(c(v),4)+y,R+="uc"+i(b.length,2)+b);var M="";return M+="\n\0",M+=i(k,2),M+=p.magic,M+=i(l,2),M+=i(h,2),M+=i(w.crc32,4),M+=i(w.compressedSize,4),M+=i(w.uncompressedSize,4),M+=i(g.length,2),M+=i(R.length,2),{fileRecord:u.LOCAL_FILE_HEADER+M+g+R,dirRecord:u.CENTRAL_FILE_HEADER+i(P,2)+M+i(v.length,2)+"\0\0\0\0"+i(O,4)+i(n,4)+g+R+v}}var o=e("../utils"),s=e("../stream/GenericWorker"),a=e("../utf8"),c=e("../crc32"),u=e("../signature");function d(e,t,r,i){s.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=t,this.zipPlatform=r,this.encodeFileName=i,this.streamFiles=e,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}o.inherits(d,s),d.prototype.push=function(e){var t=e.meta.percent||0,r=this.entriesCount,i=this._sources.length;this.accumulate?this.contentBuffer.push(e):(this.bytesWritten+=e.data.length,s.prototype.push.call(this,{data:e.data,meta:{currentFile:this.currentFile,percent:r?(t+100*(r-i-1))/r:100}}))},d.prototype.openedSource=function(e){this.currentSourceOffset=this.bytesWritten,this.currentFile=e.file.name;var t=this.streamFiles&&!e.file.dir;if(t){var r=n(e,t,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:r.fileRecord,meta:{percent:0}})}else this.accumulate=!0},d.prototype.closedSource=function(e){this.accumulate=!1;var t=this.streamFiles&&!e.file.dir,r=n(e,t,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(r.dirRecord),t)this.push({data:function(e){return u.DATA_DESCRIPTOR+i(e.crc32,4)+i(e.compressedSize,4)+i(e.uncompressedSize,4)}(e),meta:{percent:100}});else for(this.push({data:r.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},d.prototype.flush=function(){for(var e=this.bytesWritten,t=0;t<this.dirRecords.length;t++)this.push({data:this.dirRecords[t],meta:{percent:100}});var r=this.bytesWritten-e,n=function(e,t,r,n,s){var a=o.transformTo("string",s(n));return u.CENTRAL_DIRECTORY_END+"\0\0\0\0"+i(e,2)+i(e,2)+i(t,4)+i(r,4)+i(a.length,2)+a}(this.dirRecords.length,r,e,this.zipComment,this.encodeFileName);this.push({data:n,meta:{percent:100}})},d.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},d.prototype.registerPrevious=function(e){this._sources.push(e);var t=this;return e.on("data",(function(e){t.processChunk(e)})),e.on("end",(function(){t.closedSource(t.previous.streamInfo),t._sources.length?t.prepareNextSource():t.end()})),e.on("error",(function(e){t.error(e)})),this},d.prototype.resume=function(){return!!s.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},d.prototype.error=function(e){var t=this._sources;if(!s.prototype.error.call(this,e))return!1;for(var r=0;r<t.length;r++)try{t[r].error(e)}catch(e){}return!0},d.prototype.lock=function(){s.prototype.lock.call(this);for(var e=this._sources,t=0;t<e.length;t++)e[t].lock()},t.exports=d},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,t,r){var i=e("../compressions"),n=e("./ZipFileWorker");r.generateWorker=function(e,t,r){var o=new n(t.streamFiles,r,t.platform,t.encodeFileName),s=0;try{e.forEach((function(e,r){s++;var n=function(e,t){var r=e||t,n=i[r];if(!n)throw new Error(r+" is not a valid compression method !");return n}(r.options.compression,t.compression),a=r.options.compressionOptions||t.compressionOptions||{},c=r.dir,u=r.date;r._compressWorker(n,a).withStreamInfo("file",{name:e,dir:c,date:u,comment:r.comment||"",unixPermissions:r.unixPermissions,dosPermissions:r.dosPermissions}).pipe(o)})),o.entriesCount=s}catch(e){o.error(e)}return o}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,t,r){function i(){if(!(this instanceof i))return new i;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var e=new i;for(var t in this)"function"!=typeof this[t]&&(e[t]=this[t]);return e}}(i.prototype=e("./object")).loadAsync=e("./load"),i.support=e("./support"),i.defaults=e("./defaults"),i.version="3.10.0",i.loadAsync=function(e,t){return(new i).loadAsync(e,t)},i.external=e("./external"),t.exports=i},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,t,r){var i=e("./utils"),n=e("./external"),o=e("./utf8"),s=e("./zipEntries"),a=e("./stream/Crc32Probe"),c=e("./nodejsUtils");function u(e){return new n.Promise((function(t,r){var i=e.decompressed.getContentWorker().pipe(new a);i.on("error",(function(e){r(e)})).on("end",(function(){i.streamInfo.crc32!==e.decompressed.crc32?r(new Error("Corrupted zip : CRC32 mismatch")):t()})).resume()}))}t.exports=function(e,t){var r=this;return t=i.extend(t||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:o.utf8decode}),c.isNode&&c.isStream(e)?n.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):i.prepareContent("the loaded zip file",e,!0,t.optimizedBinaryString,t.base64).then((function(e){var r=new s(t);return r.load(e),r})).then((function(e){var r=[n.Promise.resolve(e)],i=e.files;if(t.checkCRC32)for(var o=0;o<i.length;o++)r.push(u(i[o]));return n.Promise.all(r)})).then((function(e){for(var n=e.shift(),o=n.files,s=0;s<o.length;s++){var a=o[s],c=a.fileNameStr,u=i.resolve(a.fileNameStr);r.file(u,a.decompressed,{binary:!0,optimizedBinaryString:!0,date:a.date,dir:a.dir,comment:a.fileCommentStr.length?a.fileCommentStr:null,unixPermissions:a.unixPermissions,dosPermissions:a.dosPermissions,createFolders:t.createFolders}),a.dir||(r.file(u).unsafeOriginalName=c)}return n.zipComment.length&&(r.comment=n.zipComment),r}))}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,t,r){var i=e("../utils"),n=e("../stream/GenericWorker");function o(e,t){n.call(this,"Nodejs stream input adapter for "+e),this._upstreamEnded=!1,this._bindStream(t)}i.inherits(o,n),o.prototype._bindStream=function(e){var t=this;(this._stream=e).pause(),e.on("data",(function(e){t.push({data:e,meta:{percent:0}})})).on("error",(function(e){t.isPaused?this.generatedError=e:t.error(e)})).on("end",(function(){t.isPaused?t._upstreamEnded=!0:t.end()}))},o.prototype.pause=function(){return!!n.prototype.pause.call(this)&&(this._stream.pause(),!0)},o.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},t.exports=o},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,t,r){var i=e("readable-stream").Readable;function n(e,t,r){i.call(this,t),this._helper=e;var n=this;e.on("data",(function(e,t){n.push(e)||n._helper.pause(),r&&r(t)})).on("error",(function(e){n.emit("error",e)})).on("end",(function(){n.push(null)}))}e("../utils").inherits(n,i),n.prototype._read=function(){this._helper.resume()},t.exports=n},{"../utils":32,"readable-stream":16}],14:[function(e,t,r){t.exports={isNode:!0,newBufferFrom:function(e,t){if(zm.from&&zm.from!==Uint8Array.from)return zm.from(e,t);if("number"==typeof e)throw new Error('The "data" argument must not be a number');return new zm(e,t)},allocBuffer:function(e){if(zm.alloc)return zm.alloc(e);var t=new zm(e);return t.fill(0),t},isBuffer:function(e){return wg(e)},isStream:function(e){return e&&"function"==typeof e.on&&"function"==typeof e.pause&&"function"==typeof e.resume}}},{}],15:[function(e,t,r){function i(e,t,r){var i,n=o.getTypeOf(t),a=o.extend(r||{},c);a.date=a.date||new Date,null!==a.compression&&(a.compression=a.compression.toUpperCase()),"string"==typeof a.unixPermissions&&(a.unixPermissions=parseInt(a.unixPermissions,8)),a.unixPermissions&&16384&a.unixPermissions&&(a.dir=!0),a.dosPermissions&&16&a.dosPermissions&&(a.dir=!0),a.dir&&(e=m(e)),a.createFolders&&(i=p(e))&&g.call(this,i,!0);var l="string"===n&&!1===a.binary&&!1===a.base64;r&&void 0!==r.binary||(a.binary=!l),(t instanceof u&&0===t.uncompressedSize||a.dir||!t||0===t.length)&&(a.base64=!1,a.binary=!0,t="",a.compression="STORE",n="string");var _=null;_=t instanceof u||t instanceof s?t:h.isNode&&h.isStream(t)?new f(e,t):o.prepareContent(e,t,a.binary,a.optimizedBinaryString,a.base64);var S=new d(e,_,a);this.files[e]=S}var n=e("./utf8"),o=e("./utils"),s=e("./stream/GenericWorker"),a=e("./stream/StreamHelper"),c=e("./defaults"),u=e("./compressedObject"),d=e("./zipObject"),l=e("./generate"),h=e("./nodejsUtils"),f=e("./nodejs/NodejsStreamInputAdapter"),p=function(e){"/"===e.slice(-1)&&(e=e.substring(0,e.length-1));var t=e.lastIndexOf("/");return 0<t?e.substring(0,t):""},m=function(e){return"/"!==e.slice(-1)&&(e+="/"),e},g=function(e,t){return t=void 0!==t?t:c.createFolders,e=m(e),this.files[e]||i.call(this,e,null,{dir:!0,createFolders:t}),this.files[e]};function _(e){return"[object RegExp]"===Object.prototype.toString.call(e)}var S={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(e){var t,r,i;for(t in this.files)i=this.files[t],(r=t.slice(this.root.length,t.length))&&t.slice(0,this.root.length)===this.root&&e(r,i)},filter:function(e){var t=[];return this.forEach((function(r,i){e(r,i)&&t.push(i)})),t},file:function(e,t,r){if(1!==arguments.length)return e=this.root+e,i.call(this,e,t,r),this;if(_(e)){var n=e;return this.filter((function(e,t){return!t.dir&&n.test(e)}))}var o=this.files[this.root+e];return o&&!o.dir?o:null},folder:function(e){if(!e)return this;if(_(e))return this.filter((function(t,r){return r.dir&&e.test(t)}));var t=this.root+e,r=g.call(this,t),i=this.clone();return i.root=r.name,i},remove:function(e){e=this.root+e;var t=this.files[e];if(t||("/"!==e.slice(-1)&&(e+="/"),t=this.files[e]),t&&!t.dir)delete this.files[e];else for(var r=this.filter((function(t,r){return r.name.slice(0,e.length)===e})),i=0;i<r.length;i++)delete this.files[r[i].name];return this},generate:function(e){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(e){var t,r={};try{if((r=o.extend(e||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:n.utf8encode})).type=r.type.toLowerCase(),r.compression=r.compression.toUpperCase(),"binarystring"===r.type&&(r.type="string"),!r.type)throw new Error("No output type specified.");o.checkSupport(r.type),"darwin"!==r.platform&&"freebsd"!==r.platform&&"linux"!==r.platform&&"sunos"!==r.platform||(r.platform="UNIX"),"win32"===r.platform&&(r.platform="DOS");var i=r.comment||this.comment||"";t=l.generateWorker(this,r,i)}catch(e){(t=new s("error")).error(e)}return new a(t,r.type||"string",r.mimeType)},generateAsync:function(e,t){return this.generateInternalStream(e).accumulate(t)},generateNodeStream:function(e,t){return(e=e||{}).type||(e.type="nodebuffer"),this.generateInternalStream(e).toNodejsStream(t)}};t.exports=S},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,t,r){t.exports=e("stream")},{stream:void 0}],17:[function(e,t,r){var i=e("./DataReader");function n(e){i.call(this,e);for(var t=0;t<this.data.length;t++)e[t]=255&e[t]}e("../utils").inherits(n,i),n.prototype.byteAt=function(e){return this.data[this.zero+e]},n.prototype.lastIndexOfSignature=function(e){for(var t=e.charCodeAt(0),r=e.charCodeAt(1),i=e.charCodeAt(2),n=e.charCodeAt(3),o=this.length-4;0<=o;--o)if(this.data[o]===t&&this.data[o+1]===r&&this.data[o+2]===i&&this.data[o+3]===n)return o-this.zero;return-1},n.prototype.readAndCheckSignature=function(e){var t=e.charCodeAt(0),r=e.charCodeAt(1),i=e.charCodeAt(2),n=e.charCodeAt(3),o=this.readData(4);return t===o[0]&&r===o[1]&&i===o[2]&&n===o[3]},n.prototype.readData=function(e){if(this.checkOffset(e),0===e)return[];var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=n},{"../utils":32,"./DataReader":18}],18:[function(e,t,r){var i=e("../utils");function n(e){this.data=e,this.length=e.length,this.index=0,this.zero=0}n.prototype={checkOffset:function(e){this.checkIndex(this.index+e)},checkIndex:function(e){if(this.length<this.zero+e||e<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+e+"). Corrupted zip ?")},setIndex:function(e){this.checkIndex(e),this.index=e},skip:function(e){this.setIndex(this.index+e)},byteAt:function(e){},readInt:function(e){var t,r=0;for(this.checkOffset(e),t=this.index+e-1;t>=this.index;t--)r=(r<<8)+this.byteAt(t);return this.index+=e,r},readString:function(e){return i.transformTo("string",this.readData(e))},readData:function(e){},lastIndexOfSignature:function(e){},readAndCheckSignature:function(e){},readDate:function(){var e=this.readInt(4);return new Date(Date.UTC(1980+(e>>25&127),(e>>21&15)-1,e>>16&31,e>>11&31,e>>5&63,(31&e)<<1))}},t.exports=n},{"../utils":32}],19:[function(e,t,r){var i=e("./Uint8ArrayReader");function n(e){i.call(this,e)}e("../utils").inherits(n,i),n.prototype.readData=function(e){this.checkOffset(e);var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=n},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,t,r){var i=e("./DataReader");function n(e){i.call(this,e)}e("../utils").inherits(n,i),n.prototype.byteAt=function(e){return this.data.charCodeAt(this.zero+e)},n.prototype.lastIndexOfSignature=function(e){return this.data.lastIndexOf(e)-this.zero},n.prototype.readAndCheckSignature=function(e){return e===this.readData(4)},n.prototype.readData=function(e){this.checkOffset(e);var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=n},{"../utils":32,"./DataReader":18}],21:[function(e,t,r){var i=e("./ArrayReader");function n(e){i.call(this,e)}e("../utils").inherits(n,i),n.prototype.readData=function(e){if(this.checkOffset(e),0===e)return new Uint8Array(0);var t=this.data.subarray(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=n},{"../utils":32,"./ArrayReader":17}],22:[function(e,t,r){var i=e("../utils"),n=e("../support"),o=e("./ArrayReader"),s=e("./StringReader"),a=e("./NodeBufferReader"),c=e("./Uint8ArrayReader");t.exports=function(e){var t=i.getTypeOf(e);return i.checkSupport(t),"string"!==t||n.uint8array?"nodebuffer"===t?new a(e):n.uint8array?new c(i.transformTo("uint8array",e)):new o(i.transformTo("array",e)):new s(e)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,t,r){r.LOCAL_FILE_HEADER="PK",r.CENTRAL_FILE_HEADER="PK",r.CENTRAL_DIRECTORY_END="PK",r.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK",r.ZIP64_CENTRAL_DIRECTORY_END="PK",r.DATA_DESCRIPTOR="PK\b"},{}],24:[function(e,t,r){var i=e("./GenericWorker"),n=e("../utils");function o(e){i.call(this,"ConvertWorker to "+e),this.destType=e}n.inherits(o,i),o.prototype.processChunk=function(e){this.push({data:n.transformTo(this.destType,e.data),meta:e.meta})},t.exports=o},{"../utils":32,"./GenericWorker":28}],25:[function(e,t,r){var i=e("./GenericWorker"),n=e("../crc32");function o(){i.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(o,i),o.prototype.processChunk=function(e){this.streamInfo.crc32=n(e.data,this.streamInfo.crc32||0),this.push(e)},t.exports=o},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,t,r){var i=e("../utils"),n=e("./GenericWorker");function o(e){n.call(this,"DataLengthProbe for "+e),this.propName=e,this.withStreamInfo(e,0)}i.inherits(o,n),o.prototype.processChunk=function(e){if(e){var t=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=t+e.data.length}n.prototype.processChunk.call(this,e)},t.exports=o},{"../utils":32,"./GenericWorker":28}],27:[function(e,t,r){var i=e("../utils"),n=e("./GenericWorker");function o(e){n.call(this,"DataWorker");var t=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,e.then((function(e){t.dataIsReady=!0,t.data=e,t.max=e&&e.length||0,t.type=i.getTypeOf(e),t.isPaused||t._tickAndRepeat()}),(function(e){t.error(e)}))}i.inherits(o,n),o.prototype.cleanUp=function(){n.prototype.cleanUp.call(this),this.data=null},o.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,i.delay(this._tickAndRepeat,[],this)),!0)},o.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(i.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},o.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var e=null,t=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":e=this.data.substring(this.index,t);break;case"uint8array":e=this.data.subarray(this.index,t);break;case"array":case"nodebuffer":e=this.data.slice(this.index,t)}return this.index=t,this.push({data:e,meta:{percent:this.max?this.index/this.max*100:0}})},t.exports=o},{"../utils":32,"./GenericWorker":28}],28:[function(e,t,r){function i(e){this.name=e||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}i.prototype={push:function(e){this.emit("data",e)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(e){this.emit("error",e)}return!0},error:function(e){return!this.isFinished&&(this.isPaused?this.generatedError=e:(this.isFinished=!0,this.emit("error",e),this.previous&&this.previous.error(e),this.cleanUp()),!0)},on:function(e,t){return this._listeners[e].push(t),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(e,t){if(this._listeners[e])for(var r=0;r<this._listeners[e].length;r++)this._listeners[e][r].call(this,t)},pipe:function(e){return e.registerPrevious(this)},registerPrevious:function(e){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=e.streamInfo,this.mergeStreamInfo(),this.previous=e;var t=this;return e.on("data",(function(e){t.processChunk(e)})),e.on("end",(function(){t.end()})),e.on("error",(function(e){t.error(e)})),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var e=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),e=!0),this.previous&&this.previous.resume(),!e},flush:function(){},processChunk:function(e){this.push(e)},withStreamInfo:function(e,t){return this.extraStreamInfo[e]=t,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var e in this.extraStreamInfo)this.extraStreamInfo.hasOwnProperty(e)&&(this.streamInfo[e]=this.extraStreamInfo[e])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var e="Worker "+this.name;return this.previous?this.previous+" -> "+e:e}},t.exports=i},{}],29:[function(e,t,r){var i=e("../utils"),n=e("./ConvertWorker"),o=e("./GenericWorker"),s=e("../base64"),a=e("../support"),c=e("../external"),u=null;if(a.nodestream)try{u=e("../nodejs/NodejsStreamOutputAdapter")}catch(e){}function d(e,t){return new c.Promise((function(r,n){var o=[],a=e._internalType,c=e._outputType,u=e._mimeType;e.on("data",(function(e,r){o.push(e),t&&t(r)})).on("error",(function(e){o=[],n(e)})).on("end",(function(){try{var e=function(e,t,r){switch(e){case"blob":return i.newBlob(i.transformTo("arraybuffer",t),r);case"base64":return s.encode(t);default:return i.transformTo(e,t)}}(c,function(e,t){var r,i=0,n=null,o=0;for(r=0;r<t.length;r++)o+=t[r].length;switch(e){case"string":return t.join("");case"array":return Array.prototype.concat.apply([],t);case"uint8array":for(n=new Uint8Array(o),r=0;r<t.length;r++)n.set(t[r],i),i+=t[r].length;return n;case"nodebuffer":return zm.concat(t);default:throw new Error("concat : unsupported type '"+e+"'")}}(a,o),u);r(e)}catch(e){n(e)}o=[]})).resume()}))}function l(e,t,r){var s=t;switch(t){case"blob":case"arraybuffer":s="uint8array";break;case"base64":s="string"}try{this._internalType=s,this._outputType=t,this._mimeType=r,i.checkSupport(s),this._worker=e.pipe(new n(s)),e.lock()}catch(e){this._worker=new o("error"),this._worker.error(e)}}l.prototype={accumulate:function(e){return d(this,e)},on:function(e,t){var r=this;return"data"===e?this._worker.on(e,(function(e){t.call(r,e.data,e.meta)})):this._worker.on(e,(function(){i.delay(t,arguments,r)})),this},resume:function(){return i.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(e){if(i.checkSupport("nodestream"),"nodebuffer"!==this._outputType)throw new Error(this._outputType+" is not supported by this method");return new u(this,{objectMode:"nodebuffer"!==this._outputType},e)}},t.exports=l},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,t,r){if(r.base64=!0,r.array=!0,r.string=!0,r.arraybuffer="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array,r.nodebuffer=!0,r.uint8array="undefined"!=typeof Uint8Array,"undefined"==typeof ArrayBuffer)r.blob=!1;else{var i=new ArrayBuffer(0);try{r.blob=0===new Blob([i],{type:"application/zip"}).size}catch(e){try{var n=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);n.append(i),r.blob=0===n.getBlob("application/zip").size}catch(e){r.blob=!1}}}try{r.nodestream=!!e("readable-stream").Readable}catch(e){r.nodestream=!1}},{"readable-stream":16}],31:[function(e,t,r){for(var i=e("./utils"),n=e("./support"),o=e("./nodejsUtils"),s=e("./stream/GenericWorker"),a=new Array(256),c=0;c<256;c++)a[c]=252<=c?6:248<=c?5:240<=c?4:224<=c?3:192<=c?2:1;function u(){s.call(this,"utf-8 decode"),this.leftOver=null}function d(){s.call(this,"utf-8 encode")}a[254]=a[254]=1,r.utf8encode=function(e){return n.nodebuffer?o.newBufferFrom(e,"utf-8"):function(e){var t,r,i,o,s,a=e.length,c=0;for(o=0;o<a;o++)55296==(64512&(r=e.charCodeAt(o)))&&o+1<a&&56320==(64512&(i=e.charCodeAt(o+1)))&&(r=65536+(r-55296<<10)+(i-56320),o++),c+=r<128?1:r<2048?2:r<65536?3:4;for(t=n.uint8array?new Uint8Array(c):new Array(c),o=s=0;s<c;o++)55296==(64512&(r=e.charCodeAt(o)))&&o+1<a&&56320==(64512&(i=e.charCodeAt(o+1)))&&(r=65536+(r-55296<<10)+(i-56320),o++),r<128?t[s++]=r:(r<2048?t[s++]=192|r>>>6:(r<65536?t[s++]=224|r>>>12:(t[s++]=240|r>>>18,t[s++]=128|r>>>12&63),t[s++]=128|r>>>6&63),t[s++]=128|63&r);return t}(e)},r.utf8decode=function(e){return n.nodebuffer?i.transformTo("nodebuffer",e).toString("utf-8"):function(e){var t,r,n,o,s=e.length,c=new Array(2*s);for(t=r=0;t<s;)if((n=e[t++])<128)c[r++]=n;else if(4<(o=a[n]))c[r++]=65533,t+=o-1;else{for(n&=2===o?31:3===o?15:7;1<o&&t<s;)n=n<<6|63&e[t++],o--;1<o?c[r++]=65533:n<65536?c[r++]=n:(n-=65536,c[r++]=55296|n>>10&1023,c[r++]=56320|1023&n)}return c.length!==r&&(c.subarray?c=c.subarray(0,r):c.length=r),i.applyFromCharCode(c)}(e=i.transformTo(n.uint8array?"uint8array":"array",e))},i.inherits(u,s),u.prototype.processChunk=function(e){var t=i.transformTo(n.uint8array?"uint8array":"array",e.data);if(this.leftOver&&this.leftOver.length){if(n.uint8array){var o=t;(t=new Uint8Array(o.length+this.leftOver.length)).set(this.leftOver,0),t.set(o,this.leftOver.length)}else t=this.leftOver.concat(t);this.leftOver=null}var s=function(e,t){var r;for((t=t||e.length)>e.length&&(t=e.length),r=t-1;0<=r&&128==(192&e[r]);)r--;return r<0||0===r?t:r+a[e[r]]>t?r:t}(t),c=t;s!==t.length&&(n.uint8array?(c=t.subarray(0,s),this.leftOver=t.subarray(s,t.length)):(c=t.slice(0,s),this.leftOver=t.slice(s,t.length))),this.push({data:r.utf8decode(c),meta:e.meta})},u.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:r.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},r.Utf8DecodeWorker=u,i.inherits(d,s),d.prototype.processChunk=function(e){this.push({data:r.utf8encode(e.data),meta:e.meta})},r.Utf8EncodeWorker=d},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,t,r){var i=e("./support"),n=e("./base64"),o=e("./nodejsUtils"),s=e("./external");function a(e){return e}function c(e,t){for(var r=0;r<e.length;++r)t[r]=255&e.charCodeAt(r);return t}e("setimmediate"),r.newBlob=function(t,i){r.checkSupport("blob");try{return new Blob([t],{type:i})}catch(e){try{var n=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return n.append(t),n.getBlob(i)}catch(e){throw new Error("Bug : can't construct the Blob.")}}};var u={stringifyByChunk:function(e,t,r){var i=[],n=0,o=e.length;if(o<=r)return String.fromCharCode.apply(null,e);for(;n<o;)"array"===t||"nodebuffer"===t?i.push(String.fromCharCode.apply(null,e.slice(n,Math.min(n+r,o)))):i.push(String.fromCharCode.apply(null,e.subarray(n,Math.min(n+r,o)))),n+=r;return i.join("")},stringifyByChar:function(e){for(var t="",r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t},applyCanBeUsed:{uint8array:function(){try{return i.uint8array&&1===String.fromCharCode.apply(null,new Uint8Array(1)).length}catch(e){return!1}}(),nodebuffer:function(){try{return i.nodebuffer&&1===String.fromCharCode.apply(null,o.allocBuffer(1)).length}catch(e){return!1}}()}};function d(e){var t=65536,i=r.getTypeOf(e),n=!0;if("uint8array"===i?n=u.applyCanBeUsed.uint8array:"nodebuffer"===i&&(n=u.applyCanBeUsed.nodebuffer),n)for(;1<t;)try{return u.stringifyByChunk(e,i,t)}catch(e){t=Math.floor(t/2)}return u.stringifyByChar(e)}function l(e,t){for(var r=0;r<e.length;r++)t[r]=e[r];return t}r.applyFromCharCode=d;var h={};h.string={string:a,array:function(e){return c(e,new Array(e.length))},arraybuffer:function(e){return h.string.uint8array(e).buffer},uint8array:function(e){return c(e,new Uint8Array(e.length))},nodebuffer:function(e){return c(e,o.allocBuffer(e.length))}},h.array={string:d,array:a,arraybuffer:function(e){return new Uint8Array(e).buffer},uint8array:function(e){return new Uint8Array(e)},nodebuffer:function(e){return o.newBufferFrom(e)}},h.arraybuffer={string:function(e){return d(new Uint8Array(e))},array:function(e){return l(new Uint8Array(e),new Array(e.byteLength))},arraybuffer:a,uint8array:function(e){return new Uint8Array(e)},nodebuffer:function(e){return o.newBufferFrom(new Uint8Array(e))}},h.uint8array={string:d,array:function(e){return l(e,new Array(e.length))},arraybuffer:function(e){return e.buffer},uint8array:a,nodebuffer:function(e){return o.newBufferFrom(e)}},h.nodebuffer={string:d,array:function(e){return l(e,new Array(e.length))},arraybuffer:function(e){return h.nodebuffer.uint8array(e).buffer},uint8array:function(e){return l(e,new Uint8Array(e.length))},nodebuffer:a},r.transformTo=function(e,t){if(t=t||"",!e)return t;r.checkSupport(e);var i=r.getTypeOf(t);return h[i][e](t)},r.resolve=function(e){for(var t=e.split("/"),r=[],i=0;i<t.length;i++){var n=t[i];"."===n||""===n&&0!==i&&i!==t.length-1||(".."===n?r.pop():r.push(n))}return r.join("/")},r.getTypeOf=function(e){return"string"==typeof e?"string":"[object Array]"===Object.prototype.toString.call(e)?"array":i.nodebuffer&&o.isBuffer(e)?"nodebuffer":i.uint8array&&e instanceof Uint8Array?"uint8array":i.arraybuffer&&e instanceof ArrayBuffer?"arraybuffer":void 0},r.checkSupport=function(e){if(!i[e.toLowerCase()])throw new Error(e+" is not supported by this platform")},r.MAX_VALUE_16BITS=65535,r.MAX_VALUE_32BITS=-1,r.pretty=function(e){var t,r,i="";for(r=0;r<(e||"").length;r++)i+="\\x"+((t=e.charCodeAt(r))<16?"0":"")+t.toString(16).toUpperCase();return i},r.delay=function(e,t,r){setImmediate((function(){e.apply(r||null,t||[])}))},r.inherits=function(e,t){function r(){}r.prototype=t.prototype,e.prototype=new r},r.extend=function(){var e,t,r={};for(e=0;e<arguments.length;e++)for(t in arguments[e])arguments[e].hasOwnProperty(t)&&void 0===r[t]&&(r[t]=arguments[e][t]);return r},r.prepareContent=function(e,t,o,a,u){return s.Promise.resolve(t).then((function(e){return i.blob&&(e instanceof Blob||-1!==["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(e)))&&"undefined"!=typeof FileReader?new s.Promise((function(t,r){var i=new FileReader;i.onload=function(e){t(e.target.result)},i.onerror=function(e){r(e.target.error)},i.readAsArrayBuffer(e)})):e})).then((function(t){var d=r.getTypeOf(t);return d?("arraybuffer"===d?t=r.transformTo("uint8array",t):"string"===d&&(u?t=n.decode(t):o&&!0!==a&&(t=function(e){return c(e,i.uint8array?new Uint8Array(e.length):new Array(e.length))}(t))),t):s.Promise.reject(new Error("Can't read the data of '"+e+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))}))}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,t,r){var i=e("./reader/readerFor"),n=e("./utils"),o=e("./signature"),s=e("./zipEntry"),a=(e("./utf8"),e("./support"));function c(e){this.files=[],this.loadOptions=e}c.prototype={checkSignature:function(e){if(!this.reader.readAndCheckSignature(e)){this.reader.index-=4;var t=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+n.pretty(t)+", expected "+n.pretty(e)+")")}},isSignature:function(e,t){var r=this.reader.index;this.reader.setIndex(e);var i=this.reader.readString(4)===t;return this.reader.setIndex(r),i},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var e=this.reader.readData(this.zipCommentLength),t=a.uint8array?"uint8array":"array",r=n.transformTo(t,e);this.zipComment=this.loadOptions.decodeFileName(r)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var e,t,r,i=this.zip64EndOfCentralSize-44;0<i;)e=this.reader.readInt(2),t=this.reader.readInt(4),r=this.reader.readData(t),this.zip64ExtensibleData[e]={id:e,length:t,value:r}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var e,t;for(e=0;e<this.files.length;e++)t=this.files[e],this.reader.setIndex(t.localHeaderOffset),this.checkSignature(o.LOCAL_FILE_HEADER),t.readLocalPart(this.reader),t.handleUTF8(),t.processAttributes()},readCentralDir:function(){var e;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(o.CENTRAL_FILE_HEADER);)(e=new s({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(e);if(this.centralDirRecords!==this.files.length&&0!==this.centralDirRecords&&0===this.files.length)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var e=this.reader.lastIndexOfSignature(o.CENTRAL_DIRECTORY_END);if(e<0)throw this.isSignature(0,o.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(e);var t=e;if(this.checkSignature(o.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===n.MAX_VALUE_16BITS||this.diskWithCentralDirStart===n.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===n.MAX_VALUE_16BITS||this.centralDirRecords===n.MAX_VALUE_16BITS||this.centralDirSize===n.MAX_VALUE_32BITS||this.centralDirOffset===n.MAX_VALUE_32BITS){if(this.zip64=!0,(e=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(e),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,o.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var r=this.centralDirOffset+this.centralDirSize;this.zip64&&(r+=20,r+=12+this.zip64EndOfCentralSize);var i=t-r;if(0<i)this.isSignature(t,o.CENTRAL_FILE_HEADER)||(this.reader.zero=i);else if(i<0)throw new Error("Corrupted zip: missing "+Math.abs(i)+" bytes.")},prepareReader:function(e){this.reader=i(e)},load:function(e){this.prepareReader(e),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},t.exports=c},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utf8":31,"./utils":32,"./zipEntry":34}],34:[function(e,t,r){var i=e("./reader/readerFor"),n=e("./utils"),o=e("./compressedObject"),s=e("./crc32"),a=e("./utf8"),c=e("./compressions"),u=e("./support");function d(e,t){this.options=e,this.loadOptions=t}d.prototype={isEncrypted:function(){return 1==(1&this.bitFlag)},useUTF8:function(){return 2048==(2048&this.bitFlag)},readLocalPart:function(e){var t,r;if(e.skip(22),this.fileNameLength=e.readInt(2),r=e.readInt(2),this.fileName=e.readData(this.fileNameLength),e.skip(r),-1===this.compressedSize||-1===this.uncompressedSize)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if(null===(t=function(e){for(var t in c)if(c.hasOwnProperty(t)&&c[t].magic===e)return c[t];return null}(this.compressionMethod)))throw new Error("Corrupted zip : compression "+n.pretty(this.compressionMethod)+" unknown (inner file : "+n.transformTo("string",this.fileName)+")");this.decompressed=new o(this.compressedSize,this.uncompressedSize,this.crc32,t,e.readData(this.compressedSize))},readCentralPart:function(e){this.versionMadeBy=e.readInt(2),e.skip(2),this.bitFlag=e.readInt(2),this.compressionMethod=e.readString(2),this.date=e.readDate(),this.crc32=e.readInt(4),this.compressedSize=e.readInt(4),this.uncompressedSize=e.readInt(4);var t=e.readInt(2);if(this.extraFieldsLength=e.readInt(2),this.fileCommentLength=e.readInt(2),this.diskNumberStart=e.readInt(2),this.internalFileAttributes=e.readInt(2),this.externalFileAttributes=e.readInt(4),this.localHeaderOffset=e.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");e.skip(t),this.readExtraFields(e),this.parseZIP64ExtraField(e),this.fileComment=e.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var e=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),0==e&&(this.dosPermissions=63&this.externalFileAttributes),3==e&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||"/"!==this.fileNameStr.slice(-1)||(this.dir=!0)},parseZIP64ExtraField:function(e){if(this.extraFields[1]){var t=i(this.extraFields[1].value);this.uncompressedSize===n.MAX_VALUE_32BITS&&(this.uncompressedSize=t.readInt(8)),this.compressedSize===n.MAX_VALUE_32BITS&&(this.compressedSize=t.readInt(8)),this.localHeaderOffset===n.MAX_VALUE_32BITS&&(this.localHeaderOffset=t.readInt(8)),this.diskNumberStart===n.MAX_VALUE_32BITS&&(this.diskNumberStart=t.readInt(4))}},readExtraFields:function(e){var t,r,i,n=e.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});e.index+4<n;)t=e.readInt(2),r=e.readInt(2),i=e.readData(r),this.extraFields[t]={id:t,length:r,value:i};e.setIndex(n)},handleUTF8:function(){var e=u.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=a.utf8decode(this.fileName),this.fileCommentStr=a.utf8decode(this.fileComment);else{var t=this.findExtraFieldUnicodePath();if(null!==t)this.fileNameStr=t;else{var r=n.transformTo(e,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(r)}var i=this.findExtraFieldUnicodeComment();if(null!==i)this.fileCommentStr=i;else{var o=n.transformTo(e,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(o)}}},findExtraFieldUnicodePath:function(){var e=this.extraFields[28789];if(e){var t=i(e.value);return 1!==t.readInt(1)||s(this.fileName)!==t.readInt(4)?null:a.utf8decode(t.readData(e.length-5))}return null},findExtraFieldUnicodeComment:function(){var e=this.extraFields[25461];if(e){var t=i(e.value);return 1!==t.readInt(1)||s(this.fileComment)!==t.readInt(4)?null:a.utf8decode(t.readData(e.length-5))}return null}},t.exports=d},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,t,r){function i(e,t,r){this.name=e,this.dir=r.dir,this.date=r.date,this.comment=r.comment,this.unixPermissions=r.unixPermissions,this.dosPermissions=r.dosPermissions,this._data=t,this._dataBinary=r.binary,this.options={compression:r.compression,compressionOptions:r.compressionOptions}}var n=e("./stream/StreamHelper"),o=e("./stream/DataWorker"),s=e("./utf8"),a=e("./compressedObject"),c=e("./stream/GenericWorker");i.prototype={internalStream:function(e){var t=null,r="string";try{if(!e)throw new Error("No output type specified.");var i="string"===(r=e.toLowerCase())||"text"===r;"binarystring"!==r&&"text"!==r||(r="string"),t=this._decompressWorker();var o=!this._dataBinary;o&&!i&&(t=t.pipe(new s.Utf8EncodeWorker)),!o&&i&&(t=t.pipe(new s.Utf8DecodeWorker))}catch(e){(t=new c("error")).error(e)}return new n(t,r,"")},async:function(e,t){return this.internalStream(e).accumulate(t)},nodeStream:function(e,t){return this.internalStream(e||"nodebuffer").toNodejsStream(t)},_compressWorker:function(e,t){if(this._data instanceof a&&this._data.compression.magic===e.magic)return this._data.getCompressedWorker();var r=this._decompressWorker();return this._dataBinary||(r=r.pipe(new s.Utf8EncodeWorker)),a.createWorkerFrom(r,e,t)},_decompressWorker:function(){return this._data instanceof a?this._data.getContentWorker():this._data instanceof c?this._data:new o(this._data)}};for(var u=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],d=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},l=0;l<u.length;l++)i.prototype[u[l]]=d;t.exports=i},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,t,r){(function(e){var r,i,n=e.MutationObserver||e.WebKitMutationObserver;if(n){var o=0,s=new n(d),a=e.document.createTextNode("");s.observe(a,{characterData:!0}),r=function(){a.data=o=++o%2}}else if(e.setImmediate||void 0===e.MessageChannel)r="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){d(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(d,0)};else{var c=new e.MessageChannel;c.port1.onmessage=d,r=function(){c.port2.postMessage(0)}}var u=[];function d(){var e,t;i=!0;for(var r=u.length;r;){for(t=u,u=[],e=-1;++e<r;)t[e]();r=u.length}i=!1}t.exports=function(e){1!==u.push(e)||i||r()}}).call(this,void 0!==i?i:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],37:[function(e,t,r){var i=e("immediate");function n(){}var o={},s=["REJECTED"],a=["FULFILLED"],c=["PENDING"];function u(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=c,this.queue=[],this.outcome=void 0,e!==n&&f(this,e)}function d(e,t,r){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof r&&(this.onRejected=r,this.callRejected=this.otherCallRejected)}function l(e,t,r){i((function(){var i;try{i=t(r)}catch(i){return o.reject(e,i)}i===e?o.reject(e,new TypeError("Cannot resolve promise with itself")):o.resolve(e,i)}))}function h(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function f(e,t){var r=!1;function i(t){r||(r=!0,o.reject(e,t))}function n(t){r||(r=!0,o.resolve(e,t))}var s=p((function(){t(n,i)}));"error"===s.status&&i(s.value)}function p(e,t){var r={};try{r.value=e(t),r.status="success"}catch(e){r.status="error",r.value=e}return r}(t.exports=u).prototype.finally=function(e){if("function"!=typeof e)return this;var t=this.constructor;return this.then((function(r){return t.resolve(e()).then((function(){return r}))}),(function(r){return t.resolve(e()).then((function(){throw r}))}))},u.prototype.catch=function(e){return this.then(null,e)},u.prototype.then=function(e,t){if("function"!=typeof e&&this.state===a||"function"!=typeof t&&this.state===s)return this;var r=new this.constructor(n);return this.state!==c?l(r,this.state===a?e:t,this.outcome):this.queue.push(new d(r,e,t)),r},d.prototype.callFulfilled=function(e){o.resolve(this.promise,e)},d.prototype.otherCallFulfilled=function(e){l(this.promise,this.onFulfilled,e)},d.prototype.callRejected=function(e){o.reject(this.promise,e)},d.prototype.otherCallRejected=function(e){l(this.promise,this.onRejected,e)},o.resolve=function(e,t){var r=p(h,t);if("error"===r.status)return o.reject(e,r.value);var i=r.value;if(i)f(e,i);else{e.state=a,e.outcome=t;for(var n=-1,s=e.queue.length;++n<s;)e.queue[n].callFulfilled(t)}return e},o.reject=function(e,t){e.state=s,e.outcome=t;for(var r=-1,i=e.queue.length;++r<i;)e.queue[r].callRejected(t);return e},u.resolve=function(e){return e instanceof this?e:o.resolve(new this(n),e)},u.reject=function(e){var t=new this(n);return o.reject(t,e)},u.all=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var r=e.length,i=!1;if(!r)return this.resolve([]);for(var s=new Array(r),a=0,c=-1,u=new this(n);++c<r;)d(e[c],c);return u;function d(e,n){t.resolve(e).then((function(e){s[n]=e,++a!==r||i||(i=!0,o.resolve(u,s))}),(function(e){i||(i=!0,o.reject(u,e))}))}},u.race=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var r=e.length,i=!1;if(!r)return this.resolve([]);for(var s,a=-1,c=new this(n);++a<r;)s=e[a],t.resolve(s).then((function(e){i||(i=!0,o.resolve(c,e))}),(function(e){i||(i=!0,o.reject(c,e))}));return c}},{immediate:36}],38:[function(e,t,r){var i={};(0,e("./lib/utils/common").assign)(i,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),t.exports=i},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,t,r){var i=e("./zlib/deflate"),n=e("./utils/common"),o=e("./utils/strings"),s=e("./zlib/messages"),a=e("./zlib/zstream"),c=Object.prototype.toString,u=0,d=-1,l=0,h=8;function f(e){if(!(this instanceof f))return new f(e);this.options=n.assign({level:d,method:h,chunkSize:16384,windowBits:15,memLevel:8,strategy:l,to:""},e||{});var t=this.options;t.raw&&0<t.windowBits?t.windowBits=-t.windowBits:t.gzip&&0<t.windowBits&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new a,this.strm.avail_out=0;var r=i.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(r!==u)throw new Error(s[r]);if(t.header&&i.deflateSetHeader(this.strm,t.header),t.dictionary){var p;if(p="string"==typeof t.dictionary?o.string2buf(t.dictionary):"[object ArrayBuffer]"===c.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,(r=i.deflateSetDictionary(this.strm,p))!==u)throw new Error(s[r]);this._dict_set=!0}}function p(e,t){var r=new f(t);if(r.push(e,!0),r.err)throw r.msg||s[r.err];return r.result}f.prototype.push=function(e,t){var r,s,a=this.strm,d=this.options.chunkSize;if(this.ended)return!1;s=t===~~t?t:!0===t?4:0,"string"==typeof e?a.input=o.string2buf(e):"[object ArrayBuffer]"===c.call(e)?a.input=new Uint8Array(e):a.input=e,a.next_in=0,a.avail_in=a.input.length;do{if(0===a.avail_out&&(a.output=new n.Buf8(d),a.next_out=0,a.avail_out=d),1!==(r=i.deflate(a,s))&&r!==u)return this.onEnd(r),!(this.ended=!0);0!==a.avail_out&&(0!==a.avail_in||4!==s&&2!==s)||("string"===this.options.to?this.onData(o.buf2binstring(n.shrinkBuf(a.output,a.next_out))):this.onData(n.shrinkBuf(a.output,a.next_out)))}while((0<a.avail_in||0===a.avail_out)&&1!==r);return 4===s?(r=i.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===u):2!==s||(this.onEnd(u),!(a.avail_out=0))},f.prototype.onData=function(e){this.chunks.push(e)},f.prototype.onEnd=function(e){e===u&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},r.Deflate=f,r.deflate=p,r.deflateRaw=function(e,t){return(t=t||{}).raw=!0,p(e,t)},r.gzip=function(e,t){return(t=t||{}).gzip=!0,p(e,t)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,t,r){var i=e("./zlib/inflate"),n=e("./utils/common"),o=e("./utils/strings"),s=e("./zlib/constants"),a=e("./zlib/messages"),c=e("./zlib/zstream"),u=e("./zlib/gzheader"),d=Object.prototype.toString;function l(e){if(!(this instanceof l))return new l(e);this.options=n.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&0<=t.windowBits&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(0<=t.windowBits&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),15<t.windowBits&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new c,this.strm.avail_out=0;var r=i.inflateInit2(this.strm,t.windowBits);if(r!==s.Z_OK)throw new Error(a[r]);this.header=new u,i.inflateGetHeader(this.strm,this.header)}function h(e,t){var r=new l(t);if(r.push(e,!0),r.err)throw r.msg||a[r.err];return r.result}l.prototype.push=function(e,t){var r,a,c,u,l,h,f=this.strm,p=this.options.chunkSize,m=this.options.dictionary,g=!1;if(this.ended)return!1;a=t===~~t?t:!0===t?s.Z_FINISH:s.Z_NO_FLUSH,"string"==typeof e?f.input=o.binstring2buf(e):"[object ArrayBuffer]"===d.call(e)?f.input=new Uint8Array(e):f.input=e,f.next_in=0,f.avail_in=f.input.length;do{if(0===f.avail_out&&(f.output=new n.Buf8(p),f.next_out=0,f.avail_out=p),(r=i.inflate(f,s.Z_NO_FLUSH))===s.Z_NEED_DICT&&m&&(h="string"==typeof m?o.string2buf(m):"[object ArrayBuffer]"===d.call(m)?new Uint8Array(m):m,r=i.inflateSetDictionary(this.strm,h)),r===s.Z_BUF_ERROR&&!0===g&&(r=s.Z_OK,g=!1),r!==s.Z_STREAM_END&&r!==s.Z_OK)return this.onEnd(r),!(this.ended=!0);f.next_out&&(0!==f.avail_out&&r!==s.Z_STREAM_END&&(0!==f.avail_in||a!==s.Z_FINISH&&a!==s.Z_SYNC_FLUSH)||("string"===this.options.to?(c=o.utf8border(f.output,f.next_out),u=f.next_out-c,l=o.buf2string(f.output,c),f.next_out=u,f.avail_out=p-u,u&&n.arraySet(f.output,f.output,c,u,0),this.onData(l)):this.onData(n.shrinkBuf(f.output,f.next_out)))),0===f.avail_in&&0===f.avail_out&&(g=!0)}while((0<f.avail_in||0===f.avail_out)&&r!==s.Z_STREAM_END);return r===s.Z_STREAM_END&&(a=s.Z_FINISH),a===s.Z_FINISH?(r=i.inflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===s.Z_OK):a!==s.Z_SYNC_FLUSH||(this.onEnd(s.Z_OK),!(f.avail_out=0))},l.prototype.onData=function(e){this.chunks.push(e)},l.prototype.onEnd=function(e){e===s.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=n.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},r.Inflate=l,r.inflate=h,r.inflateRaw=function(e,t){return(t=t||{}).raw=!0,h(e,t)},r.ungzip=h},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,t,r){var i="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;r.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var r=t.shift();if(r){if("object"!=typeof r)throw new TypeError(r+"must be non-object");for(var i in r)r.hasOwnProperty(i)&&(e[i]=r[i])}}return e},r.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var n={arraySet:function(e,t,r,i,n){if(t.subarray&&e.subarray)e.set(t.subarray(r,r+i),n);else for(var o=0;o<i;o++)e[n+o]=t[r+o]},flattenChunks:function(e){var t,r,i,n,o,s;for(t=i=0,r=e.length;t<r;t++)i+=e[t].length;for(s=new Uint8Array(i),t=n=0,r=e.length;t<r;t++)o=e[t],s.set(o,n),n+=o.length;return s}},o={arraySet:function(e,t,r,i,n){for(var o=0;o<i;o++)e[n+o]=t[r+o]},flattenChunks:function(e){return[].concat.apply([],e)}};r.setTyped=function(e){e?(r.Buf8=Uint8Array,r.Buf16=Uint16Array,r.Buf32=Int32Array,r.assign(r,n)):(r.Buf8=Array,r.Buf16=Array,r.Buf32=Array,r.assign(r,o))},r.setTyped(i)},{}],42:[function(e,t,r){var i=e("./common"),n=!0,o=!0;try{String.fromCharCode.apply(null,[0])}catch(e){n=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){o=!1}for(var s=new i.Buf8(256),a=0;a<256;a++)s[a]=252<=a?6:248<=a?5:240<=a?4:224<=a?3:192<=a?2:1;function c(e,t){if(t<65537&&(e.subarray&&o||!e.subarray&&n))return String.fromCharCode.apply(null,i.shrinkBuf(e,t));for(var r="",s=0;s<t;s++)r+=String.fromCharCode(e[s]);return r}s[254]=s[254]=1,r.string2buf=function(e){var t,r,n,o,s,a=e.length,c=0;for(o=0;o<a;o++)55296==(64512&(r=e.charCodeAt(o)))&&o+1<a&&56320==(64512&(n=e.charCodeAt(o+1)))&&(r=65536+(r-55296<<10)+(n-56320),o++),c+=r<128?1:r<2048?2:r<65536?3:4;for(t=new i.Buf8(c),o=s=0;s<c;o++)55296==(64512&(r=e.charCodeAt(o)))&&o+1<a&&56320==(64512&(n=e.charCodeAt(o+1)))&&(r=65536+(r-55296<<10)+(n-56320),o++),r<128?t[s++]=r:(r<2048?t[s++]=192|r>>>6:(r<65536?t[s++]=224|r>>>12:(t[s++]=240|r>>>18,t[s++]=128|r>>>12&63),t[s++]=128|r>>>6&63),t[s++]=128|63&r);return t},r.buf2binstring=function(e){return c(e,e.length)},r.binstring2buf=function(e){for(var t=new i.Buf8(e.length),r=0,n=t.length;r<n;r++)t[r]=e.charCodeAt(r);return t},r.buf2string=function(e,t){var r,i,n,o,a=t||e.length,u=new Array(2*a);for(r=i=0;r<a;)if((n=e[r++])<128)u[i++]=n;else if(4<(o=s[n]))u[i++]=65533,r+=o-1;else{for(n&=2===o?31:3===o?15:7;1<o&&r<a;)n=n<<6|63&e[r++],o--;1<o?u[i++]=65533:n<65536?u[i++]=n:(n-=65536,u[i++]=55296|n>>10&1023,u[i++]=56320|1023&n)}return c(u,i)},r.utf8border=function(e,t){var r;for((t=t||e.length)>e.length&&(t=e.length),r=t-1;0<=r&&128==(192&e[r]);)r--;return r<0||0===r?t:r+s[e[r]]>t?r:t}},{"./common":41}],43:[function(e,t,r){t.exports=function(e,t,r,i){for(var n=65535&e|0,o=e>>>16&65535|0,s=0;0!==r;){for(r-=s=2e3<r?2e3:r;o=o+(n=n+t[i++]|0)|0,--s;);n%=65521,o%=65521}return n|o<<16|0}},{}],44:[function(e,t,r){t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,t,r){var i=function(){for(var e,t=[],r=0;r<256;r++){e=r;for(var i=0;i<8;i++)e=1&e?3988292384^e>>>1:e>>>1;t[r]=e}return t}();t.exports=function(e,t,r,n){var o=i,s=n+r;e^=-1;for(var a=n;a<s;a++)e=e>>>8^o[255&(e^t[a])];return-1^e}},{}],46:[function(e,t,r){var i,n=e("../utils/common"),o=e("./trees"),s=e("./adler32"),a=e("./crc32"),c=e("./messages"),u=0,d=4,l=0,h=-2,f=-1,p=4,m=2,g=8,_=9,S=286,v=30,y=19,I=2*S+1,T=15,R=3,E=258,b=E+R+1,C=42,A=113,w=1,k=2,O=3,P=4;function M(e,t){return e.msg=c[t],t}function D(e){return(e<<1)-(4<e?9:0)}function N(e){for(var t=e.length;0<=--t;)e[t]=0}function U(e){var t=e.state,r=t.pending;r>e.avail_out&&(r=e.avail_out),0!==r&&(n.arraySet(e.output,t.pending_buf,t.pending_out,r,e.next_out),e.next_out+=r,t.pending_out+=r,e.total_out+=r,e.avail_out-=r,t.pending-=r,0===t.pending&&(t.pending_out=0))}function x(e,t){o._tr_flush_block(e,0<=e.block_start?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,U(e.strm)}function L(e,t){e.pending_buf[e.pending++]=t}function B(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function V(e,t){var r,i,n=e.max_chain_length,o=e.strstart,s=e.prev_length,a=e.nice_match,c=e.strstart>e.w_size-b?e.strstart-(e.w_size-b):0,u=e.window,d=e.w_mask,l=e.prev,h=e.strstart+E,f=u[o+s-1],p=u[o+s];e.prev_length>=e.good_match&&(n>>=2),a>e.lookahead&&(a=e.lookahead);do{if(u[(r=t)+s]===p&&u[r+s-1]===f&&u[r]===u[o]&&u[++r]===u[o+1]){o+=2,r++;do{}while(u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&o<h);if(i=E-(h-o),o=h-E,s<i){if(e.match_start=t,a<=(s=i))break;f=u[o+s-1],p=u[o+s]}}}while((t=l[t&d])>c&&0!=--n);return s<=e.lookahead?s:e.lookahead}function Y(e){var t,r,i,o,c,u,d,l,h,f,p=e.w_size;do{if(o=e.window_size-e.lookahead-e.strstart,e.strstart>=p+(p-b)){for(n.arraySet(e.window,e.window,p,p,0),e.match_start-=p,e.strstart-=p,e.block_start-=p,t=r=e.hash_size;i=e.head[--t],e.head[t]=p<=i?i-p:0,--r;);for(t=r=p;i=e.prev[--t],e.prev[t]=p<=i?i-p:0,--r;);o+=p}if(0===e.strm.avail_in)break;if(u=e.strm,d=e.window,l=e.strstart+e.lookahead,f=void 0,(h=o)<(f=u.avail_in)&&(f=h),r=0===f?0:(u.avail_in-=f,n.arraySet(d,u.input,u.next_in,f,l),1===u.state.wrap?u.adler=s(u.adler,d,f,l):2===u.state.wrap&&(u.adler=a(u.adler,d,f,l)),u.next_in+=f,u.total_in+=f,f),e.lookahead+=r,e.lookahead+e.insert>=R)for(c=e.strstart-e.insert,e.ins_h=e.window[c],e.ins_h=(e.ins_h<<e.hash_shift^e.window[c+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[c+R-1])&e.hash_mask,e.prev[c&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=c,c++,e.insert--,!(e.lookahead+e.insert<R)););}while(e.lookahead<b&&0!==e.strm.avail_in)}function j(e,t){for(var r,i;;){if(e.lookahead<b){if(Y(e),e.lookahead<b&&t===u)return w;if(0===e.lookahead)break}if(r=0,e.lookahead>=R&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+R-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==r&&e.strstart-r<=e.w_size-b&&(e.match_length=V(e,r)),e.match_length>=R)if(i=o._tr_tally(e,e.strstart-e.match_start,e.match_length-R),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=R){for(e.match_length--;e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+R-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart,0!=--e.match_length;);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else i=o._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(i&&(x(e,!1),0===e.strm.avail_out))return w}return e.insert=e.strstart<R-1?e.strstart:R-1,t===d?(x(e,!0),0===e.strm.avail_out?O:P):e.last_lit&&(x(e,!1),0===e.strm.avail_out)?w:k}function F(e,t){for(var r,i,n;;){if(e.lookahead<b){if(Y(e),e.lookahead<b&&t===u)return w;if(0===e.lookahead)break}if(r=0,e.lookahead>=R&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+R-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=R-1,0!==r&&e.prev_length<e.max_lazy_match&&e.strstart-r<=e.w_size-b&&(e.match_length=V(e,r),e.match_length<=5&&(1===e.strategy||e.match_length===R&&4096<e.strstart-e.match_start)&&(e.match_length=R-1)),e.prev_length>=R&&e.match_length<=e.prev_length){for(n=e.strstart+e.lookahead-R,i=o._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-R),e.lookahead-=e.prev_length-1,e.prev_length-=2;++e.strstart<=n&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+R-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!=--e.prev_length;);if(e.match_available=0,e.match_length=R-1,e.strstart++,i&&(x(e,!1),0===e.strm.avail_out))return w}else if(e.match_available){if((i=o._tr_tally(e,0,e.window[e.strstart-1]))&&x(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return w}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(i=o._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<R-1?e.strstart:R-1,t===d?(x(e,!0),0===e.strm.avail_out?O:P):e.last_lit&&(x(e,!1),0===e.strm.avail_out)?w:k}function H(e,t,r,i,n){this.good_length=e,this.max_lazy=t,this.nice_length=r,this.max_chain=i,this.func=n}function K(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=g,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new n.Buf16(2*I),this.dyn_dtree=new n.Buf16(2*(2*v+1)),this.bl_tree=new n.Buf16(2*(2*y+1)),N(this.dyn_ltree),N(this.dyn_dtree),N(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new n.Buf16(T+1),this.heap=new n.Buf16(2*S+1),N(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new n.Buf16(2*S+1),N(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function z(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=m,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?C:A,e.adler=2===t.wrap?0:1,t.last_flush=u,o._tr_init(t),l):M(e,h)}function W(e){var t=z(e);return t===l&&function(e){e.window_size=2*e.w_size,N(e.head),e.max_lazy_match=i[e.level].max_lazy,e.good_match=i[e.level].good_length,e.nice_match=i[e.level].nice_length,e.max_chain_length=i[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=R-1,e.match_available=0,e.ins_h=0}(e.state),t}function G(e,t,r,i,o,s){if(!e)return h;var a=1;if(t===f&&(t=6),i<0?(a=0,i=-i):15<i&&(a=2,i-=16),o<1||_<o||r!==g||i<8||15<i||t<0||9<t||s<0||p<s)return M(e,h);8===i&&(i=9);var c=new K;return(e.state=c).strm=e,c.wrap=a,c.gzhead=null,c.w_bits=i,c.w_size=1<<c.w_bits,c.w_mask=c.w_size-1,c.hash_bits=o+7,c.hash_size=1<<c.hash_bits,c.hash_mask=c.hash_size-1,c.hash_shift=~~((c.hash_bits+R-1)/R),c.window=new n.Buf8(2*c.w_size),c.head=new n.Buf16(c.hash_size),c.prev=new n.Buf16(c.w_size),c.lit_bufsize=1<<o+6,c.pending_buf_size=4*c.lit_bufsize,c.pending_buf=new n.Buf8(c.pending_buf_size),c.d_buf=1*c.lit_bufsize,c.l_buf=3*c.lit_bufsize,c.level=t,c.strategy=s,c.method=r,W(e)}i=[new H(0,0,0,0,(function(e,t){var r=65535;for(r>e.pending_buf_size-5&&(r=e.pending_buf_size-5);;){if(e.lookahead<=1){if(Y(e),0===e.lookahead&&t===u)return w;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var i=e.block_start+r;if((0===e.strstart||e.strstart>=i)&&(e.lookahead=e.strstart-i,e.strstart=i,x(e,!1),0===e.strm.avail_out))return w;if(e.strstart-e.block_start>=e.w_size-b&&(x(e,!1),0===e.strm.avail_out))return w}return e.insert=0,t===d?(x(e,!0),0===e.strm.avail_out?O:P):(e.strstart>e.block_start&&(x(e,!1),e.strm.avail_out),w)})),new H(4,4,8,4,j),new H(4,5,16,8,j),new H(4,6,32,32,j),new H(4,4,16,16,F),new H(8,16,32,32,F),new H(8,16,128,128,F),new H(8,32,128,256,F),new H(32,128,258,1024,F),new H(32,258,258,4096,F)],r.deflateInit=function(e,t){return G(e,t,g,15,8,0)},r.deflateInit2=G,r.deflateReset=W,r.deflateResetKeep=z,r.deflateSetHeader=function(e,t){return e&&e.state?2!==e.state.wrap?h:(e.state.gzhead=t,l):h},r.deflate=function(e,t){var r,n,s,c;if(!e||!e.state||5<t||t<0)return e?M(e,h):h;if(n=e.state,!e.output||!e.input&&0!==e.avail_in||666===n.status&&t!==d)return M(e,0===e.avail_out?-5:h);if(n.strm=e,r=n.last_flush,n.last_flush=t,n.status===C)if(2===n.wrap)e.adler=0,L(n,31),L(n,139),L(n,8),n.gzhead?(L(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),L(n,255&n.gzhead.time),L(n,n.gzhead.time>>8&255),L(n,n.gzhead.time>>16&255),L(n,n.gzhead.time>>24&255),L(n,9===n.level?2:2<=n.strategy||n.level<2?4:0),L(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(L(n,255&n.gzhead.extra.length),L(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(e.adler=a(e.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69):(L(n,0),L(n,0),L(n,0),L(n,0),L(n,0),L(n,9===n.level?2:2<=n.strategy||n.level<2?4:0),L(n,3),n.status=A);else{var f=g+(n.w_bits-8<<4)<<8;f|=(2<=n.strategy||n.level<2?0:n.level<6?1:6===n.level?2:3)<<6,0!==n.strstart&&(f|=32),f+=31-f%31,n.status=A,B(n,f),0!==n.strstart&&(B(n,e.adler>>>16),B(n,65535&e.adler)),e.adler=1}if(69===n.status)if(n.gzhead.extra){for(s=n.pending;n.gzindex<(65535&n.gzhead.extra.length)&&(n.pending!==n.pending_buf_size||(n.gzhead.hcrc&&n.pending>s&&(e.adler=a(e.adler,n.pending_buf,n.pending-s,s)),U(e),s=n.pending,n.pending!==n.pending_buf_size));)L(n,255&n.gzhead.extra[n.gzindex]),n.gzindex++;n.gzhead.hcrc&&n.pending>s&&(e.adler=a(e.adler,n.pending_buf,n.pending-s,s)),n.gzindex===n.gzhead.extra.length&&(n.gzindex=0,n.status=73)}else n.status=73;if(73===n.status)if(n.gzhead.name){s=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>s&&(e.adler=a(e.adler,n.pending_buf,n.pending-s,s)),U(e),s=n.pending,n.pending===n.pending_buf_size)){c=1;break}c=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,L(n,c)}while(0!==c);n.gzhead.hcrc&&n.pending>s&&(e.adler=a(e.adler,n.pending_buf,n.pending-s,s)),0===c&&(n.gzindex=0,n.status=91)}else n.status=91;if(91===n.status)if(n.gzhead.comment){s=n.pending;do{if(n.pending===n.pending_buf_size&&(n.gzhead.hcrc&&n.pending>s&&(e.adler=a(e.adler,n.pending_buf,n.pending-s,s)),U(e),s=n.pending,n.pending===n.pending_buf_size)){c=1;break}c=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,L(n,c)}while(0!==c);n.gzhead.hcrc&&n.pending>s&&(e.adler=a(e.adler,n.pending_buf,n.pending-s,s)),0===c&&(n.status=103)}else n.status=103;if(103===n.status&&(n.gzhead.hcrc?(n.pending+2>n.pending_buf_size&&U(e),n.pending+2<=n.pending_buf_size&&(L(n,255&e.adler),L(n,e.adler>>8&255),e.adler=0,n.status=A)):n.status=A),0!==n.pending){if(U(e),0===e.avail_out)return n.last_flush=-1,l}else if(0===e.avail_in&&D(t)<=D(r)&&t!==d)return M(e,-5);if(666===n.status&&0!==e.avail_in)return M(e,-5);if(0!==e.avail_in||0!==n.lookahead||t!==u&&666!==n.status){var p=2===n.strategy?function(e,t){for(var r;;){if(0===e.lookahead&&(Y(e),0===e.lookahead)){if(t===u)return w;break}if(e.match_length=0,r=o._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,r&&(x(e,!1),0===e.strm.avail_out))return w}return e.insert=0,t===d?(x(e,!0),0===e.strm.avail_out?O:P):e.last_lit&&(x(e,!1),0===e.strm.avail_out)?w:k}(n,t):3===n.strategy?function(e,t){for(var r,i,n,s,a=e.window;;){if(e.lookahead<=E){if(Y(e),e.lookahead<=E&&t===u)return w;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=R&&0<e.strstart&&(i=a[n=e.strstart-1])===a[++n]&&i===a[++n]&&i===a[++n]){s=e.strstart+E;do{}while(i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&n<s);e.match_length=E-(s-n),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=R?(r=o._tr_tally(e,1,e.match_length-R),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(r=o._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),r&&(x(e,!1),0===e.strm.avail_out))return w}return e.insert=0,t===d?(x(e,!0),0===e.strm.avail_out?O:P):e.last_lit&&(x(e,!1),0===e.strm.avail_out)?w:k}(n,t):i[n.level].func(n,t);if(p!==O&&p!==P||(n.status=666),p===w||p===O)return 0===e.avail_out&&(n.last_flush=-1),l;if(p===k&&(1===t?o._tr_align(n):5!==t&&(o._tr_stored_block(n,0,0,!1),3===t&&(N(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),U(e),0===e.avail_out))return n.last_flush=-1,l}return t!==d?l:n.wrap<=0?1:(2===n.wrap?(L(n,255&e.adler),L(n,e.adler>>8&255),L(n,e.adler>>16&255),L(n,e.adler>>24&255),L(n,255&e.total_in),L(n,e.total_in>>8&255),L(n,e.total_in>>16&255),L(n,e.total_in>>24&255)):(B(n,e.adler>>>16),B(n,65535&e.adler)),U(e),0<n.wrap&&(n.wrap=-n.wrap),0!==n.pending?l:1)},r.deflateEnd=function(e){var t;return e&&e.state?(t=e.state.status)!==C&&69!==t&&73!==t&&91!==t&&103!==t&&t!==A&&666!==t?M(e,h):(e.state=null,t===A?M(e,-3):l):h},r.deflateSetDictionary=function(e,t){var r,i,o,a,c,u,d,f,p=t.length;if(!e||!e.state)return h;if(2===(a=(r=e.state).wrap)||1===a&&r.status!==C||r.lookahead)return h;for(1===a&&(e.adler=s(e.adler,t,p,0)),r.wrap=0,p>=r.w_size&&(0===a&&(N(r.head),r.strstart=0,r.block_start=0,r.insert=0),f=new n.Buf8(r.w_size),n.arraySet(f,t,p-r.w_size,r.w_size,0),t=f,p=r.w_size),c=e.avail_in,u=e.next_in,d=e.input,e.avail_in=p,e.next_in=0,e.input=t,Y(r);r.lookahead>=R;){for(i=r.strstart,o=r.lookahead-(R-1);r.ins_h=(r.ins_h<<r.hash_shift^r.window[i+R-1])&r.hash_mask,r.prev[i&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=i,i++,--o;);r.strstart=i,r.lookahead=R-1,Y(r)}return r.strstart+=r.lookahead,r.block_start=r.strstart,r.insert=r.lookahead,r.lookahead=0,r.match_length=r.prev_length=R-1,r.match_available=0,e.next_in=u,e.input=d,e.avail_in=c,r.wrap=a,l},r.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,t,r){t.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,t,r){t.exports=function(e,t){var r,i,n,o,s,a,c,u,d,l,h,f,p,m,g,_,S,v,y,I,T,R,E,b,C;r=e.state,i=e.next_in,b=e.input,n=i+(e.avail_in-5),o=e.next_out,C=e.output,s=o-(t-e.avail_out),a=o+(e.avail_out-257),c=r.dmax,u=r.wsize,d=r.whave,l=r.wnext,h=r.window,f=r.hold,p=r.bits,m=r.lencode,g=r.distcode,_=(1<<r.lenbits)-1,S=(1<<r.distbits)-1;e:do{p<15&&(f+=b[i++]<<p,p+=8,f+=b[i++]<<p,p+=8),v=m[f&_];t:for(;;){if(f>>>=y=v>>>24,p-=y,0==(y=v>>>16&255))C[o++]=65535&v;else{if(!(16&y)){if(0==(64&y)){v=m[(65535&v)+(f&(1<<y)-1)];continue t}if(32&y){r.mode=12;break e}e.msg="invalid literal/length code",r.mode=30;break e}I=65535&v,(y&=15)&&(p<y&&(f+=b[i++]<<p,p+=8),I+=f&(1<<y)-1,f>>>=y,p-=y),p<15&&(f+=b[i++]<<p,p+=8,f+=b[i++]<<p,p+=8),v=g[f&S];r:for(;;){if(f>>>=y=v>>>24,p-=y,!(16&(y=v>>>16&255))){if(0==(64&y)){v=g[(65535&v)+(f&(1<<y)-1)];continue r}e.msg="invalid distance code",r.mode=30;break e}if(T=65535&v,p<(y&=15)&&(f+=b[i++]<<p,(p+=8)<y&&(f+=b[i++]<<p,p+=8)),c<(T+=f&(1<<y)-1)){e.msg="invalid distance too far back",r.mode=30;break e}if(f>>>=y,p-=y,(y=o-s)<T){if(d<(y=T-y)&&r.sane){e.msg="invalid distance too far back",r.mode=30;break e}if(E=h,(R=0)===l){if(R+=u-y,y<I){for(I-=y;C[o++]=h[R++],--y;);R=o-T,E=C}}else if(l<y){if(R+=u+l-y,(y-=l)<I){for(I-=y;C[o++]=h[R++],--y;);if(R=0,l<I){for(I-=y=l;C[o++]=h[R++],--y;);R=o-T,E=C}}}else if(R+=l-y,y<I){for(I-=y;C[o++]=h[R++],--y;);R=o-T,E=C}for(;2<I;)C[o++]=E[R++],C[o++]=E[R++],C[o++]=E[R++],I-=3;I&&(C[o++]=E[R++],1<I&&(C[o++]=E[R++]))}else{for(R=o-T;C[o++]=C[R++],C[o++]=C[R++],C[o++]=C[R++],2<(I-=3););I&&(C[o++]=C[R++],1<I&&(C[o++]=C[R++]))}break}}break}}while(i<n&&o<a);i-=I=p>>3,f&=(1<<(p-=I<<3))-1,e.next_in=i,e.next_out=o,e.avail_in=i<n?n-i+5:5-(i-n),e.avail_out=o<a?a-o+257:257-(o-a),r.hold=f,r.bits=p}},{}],49:[function(e,t,r){var i=e("../utils/common"),n=e("./adler32"),o=e("./crc32"),s=e("./inffast"),a=e("./inftrees"),c=1,u=2,d=0,l=-2,h=1,f=852,p=592;function m(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function g(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new i.Buf16(320),this.work=new i.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function _(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=h,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new i.Buf32(f),t.distcode=t.distdyn=new i.Buf32(p),t.sane=1,t.back=-1,d):l}function S(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,_(e)):l}function v(e,t){var r,i;return e&&e.state?(i=e.state,t<0?(r=0,t=-t):(r=1+(t>>4),t<48&&(t&=15)),t&&(t<8||15<t)?l:(null!==i.window&&i.wbits!==t&&(i.window=null),i.wrap=r,i.wbits=t,S(e))):l}function y(e,t){var r,i;return e?(i=new g,(e.state=i).window=null,(r=v(e,t))!==d&&(e.state=null),r):l}var I,T,R=!0;function E(e){if(R){var t;for(I=new i.Buf32(512),T=new i.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(a(c,e.lens,0,288,I,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;a(u,e.lens,0,32,T,0,e.work,{bits:5}),R=!1}e.lencode=I,e.lenbits=9,e.distcode=T,e.distbits=5}function b(e,t,r,n){var o,s=e.state;return null===s.window&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new i.Buf8(s.wsize)),n>=s.wsize?(i.arraySet(s.window,t,r-s.wsize,s.wsize,0),s.wnext=0,s.whave=s.wsize):(n<(o=s.wsize-s.wnext)&&(o=n),i.arraySet(s.window,t,r-n,o,s.wnext),(n-=o)?(i.arraySet(s.window,t,r-n,n,0),s.wnext=n,s.whave=s.wsize):(s.wnext+=o,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=o))),0}r.inflateReset=S,r.inflateReset2=v,r.inflateResetKeep=_,r.inflateInit=function(e){return y(e,15)},r.inflateInit2=y,r.inflate=function(e,t){var r,f,p,g,_,S,v,y,I,T,R,C,A,w,k,O,P,M,D,N,U,x,L,B,V=0,Y=new i.Buf8(4),j=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return l;12===(r=e.state).mode&&(r.mode=13),_=e.next_out,p=e.output,v=e.avail_out,g=e.next_in,f=e.input,S=e.avail_in,y=r.hold,I=r.bits,T=S,R=v,x=d;e:for(;;)switch(r.mode){case h:if(0===r.wrap){r.mode=13;break}for(;I<16;){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}if(2&r.wrap&&35615===y){Y[r.check=0]=255&y,Y[1]=y>>>8&255,r.check=o(r.check,Y,2,0),I=y=0,r.mode=2;break}if(r.flags=0,r.head&&(r.head.done=!1),!(1&r.wrap)||(((255&y)<<8)+(y>>8))%31){e.msg="incorrect header check",r.mode=30;break}if(8!=(15&y)){e.msg="unknown compression method",r.mode=30;break}if(I-=4,U=8+(15&(y>>>=4)),0===r.wbits)r.wbits=U;else if(U>r.wbits){e.msg="invalid window size",r.mode=30;break}r.dmax=1<<U,e.adler=r.check=1,r.mode=512&y?10:12,I=y=0;break;case 2:for(;I<16;){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}if(r.flags=y,8!=(255&r.flags)){e.msg="unknown compression method",r.mode=30;break}if(57344&r.flags){e.msg="unknown header flags set",r.mode=30;break}r.head&&(r.head.text=y>>8&1),512&r.flags&&(Y[0]=255&y,Y[1]=y>>>8&255,r.check=o(r.check,Y,2,0)),I=y=0,r.mode=3;case 3:for(;I<32;){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}r.head&&(r.head.time=y),512&r.flags&&(Y[0]=255&y,Y[1]=y>>>8&255,Y[2]=y>>>16&255,Y[3]=y>>>24&255,r.check=o(r.check,Y,4,0)),I=y=0,r.mode=4;case 4:for(;I<16;){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}r.head&&(r.head.xflags=255&y,r.head.os=y>>8),512&r.flags&&(Y[0]=255&y,Y[1]=y>>>8&255,r.check=o(r.check,Y,2,0)),I=y=0,r.mode=5;case 5:if(1024&r.flags){for(;I<16;){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}r.length=y,r.head&&(r.head.extra_len=y),512&r.flags&&(Y[0]=255&y,Y[1]=y>>>8&255,r.check=o(r.check,Y,2,0)),I=y=0}else r.head&&(r.head.extra=null);r.mode=6;case 6:if(1024&r.flags&&(S<(C=r.length)&&(C=S),C&&(r.head&&(U=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Array(r.head.extra_len)),i.arraySet(r.head.extra,f,g,C,U)),512&r.flags&&(r.check=o(r.check,f,C,g)),S-=C,g+=C,r.length-=C),r.length))break e;r.length=0,r.mode=7;case 7:if(2048&r.flags){if(0===S)break e;for(C=0;U=f[g+C++],r.head&&U&&r.length<65536&&(r.head.name+=String.fromCharCode(U)),U&&C<S;);if(512&r.flags&&(r.check=o(r.check,f,C,g)),S-=C,g+=C,U)break e}else r.head&&(r.head.name=null);r.length=0,r.mode=8;case 8:if(4096&r.flags){if(0===S)break e;for(C=0;U=f[g+C++],r.head&&U&&r.length<65536&&(r.head.comment+=String.fromCharCode(U)),U&&C<S;);if(512&r.flags&&(r.check=o(r.check,f,C,g)),S-=C,g+=C,U)break e}else r.head&&(r.head.comment=null);r.mode=9;case 9:if(512&r.flags){for(;I<16;){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}if(y!==(65535&r.check)){e.msg="header crc mismatch",r.mode=30;break}I=y=0}r.head&&(r.head.hcrc=r.flags>>9&1,r.head.done=!0),e.adler=r.check=0,r.mode=12;break;case 10:for(;I<32;){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}e.adler=r.check=m(y),I=y=0,r.mode=11;case 11:if(0===r.havedict)return e.next_out=_,e.avail_out=v,e.next_in=g,e.avail_in=S,r.hold=y,r.bits=I,2;e.adler=r.check=1,r.mode=12;case 12:if(5===t||6===t)break e;case 13:if(r.last){y>>>=7&I,I-=7&I,r.mode=27;break}for(;I<3;){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}switch(r.last=1&y,I-=1,3&(y>>>=1)){case 0:r.mode=14;break;case 1:if(E(r),r.mode=20,6!==t)break;y>>>=2,I-=2;break e;case 2:r.mode=17;break;case 3:e.msg="invalid block type",r.mode=30}y>>>=2,I-=2;break;case 14:for(y>>>=7&I,I-=7&I;I<32;){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}if((65535&y)!=(y>>>16^65535)){e.msg="invalid stored block lengths",r.mode=30;break}if(r.length=65535&y,I=y=0,r.mode=15,6===t)break e;case 15:r.mode=16;case 16:if(C=r.length){if(S<C&&(C=S),v<C&&(C=v),0===C)break e;i.arraySet(p,f,g,C,_),S-=C,g+=C,v-=C,_+=C,r.length-=C;break}r.mode=12;break;case 17:for(;I<14;){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}if(r.nlen=257+(31&y),y>>>=5,I-=5,r.ndist=1+(31&y),y>>>=5,I-=5,r.ncode=4+(15&y),y>>>=4,I-=4,286<r.nlen||30<r.ndist){e.msg="too many length or distance symbols",r.mode=30;break}r.have=0,r.mode=18;case 18:for(;r.have<r.ncode;){for(;I<3;){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}r.lens[j[r.have++]]=7&y,y>>>=3,I-=3}for(;r.have<19;)r.lens[j[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,L={bits:r.lenbits},x=a(0,r.lens,0,19,r.lencode,0,r.work,L),r.lenbits=L.bits,x){e.msg="invalid code lengths set",r.mode=30;break}r.have=0,r.mode=19;case 19:for(;r.have<r.nlen+r.ndist;){for(;O=(V=r.lencode[y&(1<<r.lenbits)-1])>>>16&255,P=65535&V,!((k=V>>>24)<=I);){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}if(P<16)y>>>=k,I-=k,r.lens[r.have++]=P;else{if(16===P){for(B=k+2;I<B;){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}if(y>>>=k,I-=k,0===r.have){e.msg="invalid bit length repeat",r.mode=30;break}U=r.lens[r.have-1],C=3+(3&y),y>>>=2,I-=2}else if(17===P){for(B=k+3;I<B;){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}I-=k,U=0,C=3+(7&(y>>>=k)),y>>>=3,I-=3}else{for(B=k+7;I<B;){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}I-=k,U=0,C=11+(127&(y>>>=k)),y>>>=7,I-=7}if(r.have+C>r.nlen+r.ndist){e.msg="invalid bit length repeat",r.mode=30;break}for(;C--;)r.lens[r.have++]=U}}if(30===r.mode)break;if(0===r.lens[256]){e.msg="invalid code -- missing end-of-block",r.mode=30;break}if(r.lenbits=9,L={bits:r.lenbits},x=a(c,r.lens,0,r.nlen,r.lencode,0,r.work,L),r.lenbits=L.bits,x){e.msg="invalid literal/lengths set",r.mode=30;break}if(r.distbits=6,r.distcode=r.distdyn,L={bits:r.distbits},x=a(u,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,L),r.distbits=L.bits,x){e.msg="invalid distances set",r.mode=30;break}if(r.mode=20,6===t)break e;case 20:r.mode=21;case 21:if(6<=S&&258<=v){e.next_out=_,e.avail_out=v,e.next_in=g,e.avail_in=S,r.hold=y,r.bits=I,s(e,R),_=e.next_out,p=e.output,v=e.avail_out,g=e.next_in,f=e.input,S=e.avail_in,y=r.hold,I=r.bits,12===r.mode&&(r.back=-1);break}for(r.back=0;O=(V=r.lencode[y&(1<<r.lenbits)-1])>>>16&255,P=65535&V,!((k=V>>>24)<=I);){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}if(O&&0==(240&O)){for(M=k,D=O,N=P;O=(V=r.lencode[N+((y&(1<<M+D)-1)>>M)])>>>16&255,P=65535&V,!(M+(k=V>>>24)<=I);){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}y>>>=M,I-=M,r.back+=M}if(y>>>=k,I-=k,r.back+=k,r.length=P,0===O){r.mode=26;break}if(32&O){r.back=-1,r.mode=12;break}if(64&O){e.msg="invalid literal/length code",r.mode=30;break}r.extra=15&O,r.mode=22;case 22:if(r.extra){for(B=r.extra;I<B;){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}r.length+=y&(1<<r.extra)-1,y>>>=r.extra,I-=r.extra,r.back+=r.extra}r.was=r.length,r.mode=23;case 23:for(;O=(V=r.distcode[y&(1<<r.distbits)-1])>>>16&255,P=65535&V,!((k=V>>>24)<=I);){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}if(0==(240&O)){for(M=k,D=O,N=P;O=(V=r.distcode[N+((y&(1<<M+D)-1)>>M)])>>>16&255,P=65535&V,!(M+(k=V>>>24)<=I);){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}y>>>=M,I-=M,r.back+=M}if(y>>>=k,I-=k,r.back+=k,64&O){e.msg="invalid distance code",r.mode=30;break}r.offset=P,r.extra=15&O,r.mode=24;case 24:if(r.extra){for(B=r.extra;I<B;){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}r.offset+=y&(1<<r.extra)-1,y>>>=r.extra,I-=r.extra,r.back+=r.extra}if(r.offset>r.dmax){e.msg="invalid distance too far back",r.mode=30;break}r.mode=25;case 25:if(0===v)break e;if(C=R-v,r.offset>C){if((C=r.offset-C)>r.whave&&r.sane){e.msg="invalid distance too far back",r.mode=30;break}A=C>r.wnext?(C-=r.wnext,r.wsize-C):r.wnext-C,C>r.length&&(C=r.length),w=r.window}else w=p,A=_-r.offset,C=r.length;for(v<C&&(C=v),v-=C,r.length-=C;p[_++]=w[A++],--C;);0===r.length&&(r.mode=21);break;case 26:if(0===v)break e;p[_++]=r.length,v--,r.mode=21;break;case 27:if(r.wrap){for(;I<32;){if(0===S)break e;S--,y|=f[g++]<<I,I+=8}if(R-=v,e.total_out+=R,r.total+=R,R&&(e.adler=r.check=r.flags?o(r.check,p,R,_-R):n(r.check,p,R,_-R)),R=v,(r.flags?y:m(y))!==r.check){e.msg="incorrect data check",r.mode=30;break}I=y=0}r.mode=28;case 28:if(r.wrap&&r.flags){for(;I<32;){if(0===S)break e;S--,y+=f[g++]<<I,I+=8}if(y!==(4294967295&r.total)){e.msg="incorrect length check",r.mode=30;break}I=y=0}r.mode=29;case 29:x=1;break e;case 30:x=-3;break e;case 31:return-4;default:return l}return e.next_out=_,e.avail_out=v,e.next_in=g,e.avail_in=S,r.hold=y,r.bits=I,(r.wsize||R!==e.avail_out&&r.mode<30&&(r.mode<27||4!==t))&&b(e,e.output,e.next_out,R-e.avail_out)?(r.mode=31,-4):(T-=e.avail_in,R-=e.avail_out,e.total_in+=T,e.total_out+=R,r.total+=R,r.wrap&&R&&(e.adler=r.check=r.flags?o(r.check,p,R,e.next_out-R):n(r.check,p,R,e.next_out-R)),e.data_type=r.bits+(r.last?64:0)+(12===r.mode?128:0)+(20===r.mode||15===r.mode?256:0),(0==T&&0===R||4===t)&&x===d&&(x=-5),x)},r.inflateEnd=function(e){if(!e||!e.state)return l;var t=e.state;return t.window&&(t.window=null),e.state=null,d},r.inflateGetHeader=function(e,t){var r;return e&&e.state?0==(2&(r=e.state).wrap)?l:((r.head=t).done=!1,d):l},r.inflateSetDictionary=function(e,t){var r,i=t.length;return e&&e.state?0!==(r=e.state).wrap&&11!==r.mode?l:11===r.mode&&n(1,t,i,0)!==r.check?-3:b(e,t,i,i)?(r.mode=31,-4):(r.havedict=1,d):l},r.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,t,r){var i=e("../utils/common"),n=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],o=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],s=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],a=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(e,t,r,c,u,d,l,h){var f,p,m,g,_,S,v,y,I,T=h.bits,R=0,E=0,b=0,C=0,A=0,w=0,k=0,O=0,P=0,M=0,D=null,N=0,U=new i.Buf16(16),x=new i.Buf16(16),L=null,B=0;for(R=0;R<=15;R++)U[R]=0;for(E=0;E<c;E++)U[t[r+E]]++;for(A=T,C=15;1<=C&&0===U[C];C--);if(C<A&&(A=C),0===C)return u[d++]=20971520,u[d++]=20971520,h.bits=1,0;for(b=1;b<C&&0===U[b];b++);for(A<b&&(A=b),R=O=1;R<=15;R++)if(O<<=1,(O-=U[R])<0)return-1;if(0<O&&(0===e||1!==C))return-1;for(x[1]=0,R=1;R<15;R++)x[R+1]=x[R]+U[R];for(E=0;E<c;E++)0!==t[r+E]&&(l[x[t[r+E]]++]=E);if(S=0===e?(D=L=l,19):1===e?(D=n,N-=257,L=o,B-=257,256):(D=s,L=a,-1),R=b,_=d,k=E=M=0,m=-1,g=(P=1<<(w=A))-1,1===e&&852<P||2===e&&592<P)return 1;for(;;){for(v=R-k,I=l[E]<S?(y=0,l[E]):l[E]>S?(y=L[B+l[E]],D[N+l[E]]):(y=96,0),f=1<<R-k,b=p=1<<w;u[_+(M>>k)+(p-=f)]=v<<24|y<<16|I|0,0!==p;);for(f=1<<R-1;M&f;)f>>=1;if(0!==f?(M&=f-1,M+=f):M=0,E++,0==--U[R]){if(R===C)break;R=t[r+l[E]]}if(A<R&&(M&g)!==m){for(0===k&&(k=A),_+=b,O=1<<(w=R-k);w+k<C&&!((O-=U[w+k])<=0);)w++,O<<=1;if(P+=1<<w,1===e&&852<P||2===e&&592<P)return 1;u[m=M&g]=A<<24|w<<16|_-d|0}}return 0!==M&&(u[_+M]=R-k<<24|64<<16|0),h.bits=A,0}},{"../utils/common":41}],51:[function(e,t,r){t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,t,r){var i=e("../utils/common"),n=0,o=1;function s(e){for(var t=e.length;0<=--t;)e[t]=0}var a=0,c=29,u=256,d=u+1+c,l=30,h=19,f=2*d+1,p=15,m=16,g=7,_=256,S=16,v=17,y=18,I=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],T=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],R=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],E=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],b=new Array(2*(d+2));s(b);var C=new Array(2*l);s(C);var A=new Array(512);s(A);var w=new Array(256);s(w);var k=new Array(c);s(k);var O,P,M,D=new Array(l);function N(e,t,r,i,n){this.static_tree=e,this.extra_bits=t,this.extra_base=r,this.elems=i,this.max_length=n,this.has_stree=e&&e.length}function U(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function x(e){return e<256?A[e]:A[256+(e>>>7)]}function L(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function B(e,t,r){e.bi_valid>m-r?(e.bi_buf|=t<<e.bi_valid&65535,L(e,e.bi_buf),e.bi_buf=t>>m-e.bi_valid,e.bi_valid+=r-m):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=r)}function V(e,t,r){B(e,r[2*t],r[2*t+1])}function Y(e,t){for(var r=0;r|=1&e,e>>>=1,r<<=1,0<--t;);return r>>>1}function j(e,t,r){var i,n,o=new Array(p+1),s=0;for(i=1;i<=p;i++)o[i]=s=s+r[i-1]<<1;for(n=0;n<=t;n++){var a=e[2*n+1];0!==a&&(e[2*n]=Y(o[a]++,a))}}function F(e){var t;for(t=0;t<d;t++)e.dyn_ltree[2*t]=0;for(t=0;t<l;t++)e.dyn_dtree[2*t]=0;for(t=0;t<h;t++)e.bl_tree[2*t]=0;e.dyn_ltree[2*_]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function H(e){8<e.bi_valid?L(e,e.bi_buf):0<e.bi_valid&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function K(e,t,r,i){var n=2*t,o=2*r;return e[n]<e[o]||e[n]===e[o]&&i[t]<=i[r]}function z(e,t,r){for(var i=e.heap[r],n=r<<1;n<=e.heap_len&&(n<e.heap_len&&K(t,e.heap[n+1],e.heap[n],e.depth)&&n++,!K(t,i,e.heap[n],e.depth));)e.heap[r]=e.heap[n],r=n,n<<=1;e.heap[r]=i}function W(e,t,r){var i,n,o,s,a=0;if(0!==e.last_lit)for(;i=e.pending_buf[e.d_buf+2*a]<<8|e.pending_buf[e.d_buf+2*a+1],n=e.pending_buf[e.l_buf+a],a++,0===i?V(e,n,t):(V(e,(o=w[n])+u+1,t),0!==(s=I[o])&&B(e,n-=k[o],s),V(e,o=x(--i),r),0!==(s=T[o])&&B(e,i-=D[o],s)),a<e.last_lit;);V(e,_,t)}function G(e,t){var r,i,n,o=t.dyn_tree,s=t.stat_desc.static_tree,a=t.stat_desc.has_stree,c=t.stat_desc.elems,u=-1;for(e.heap_len=0,e.heap_max=f,r=0;r<c;r++)0!==o[2*r]?(e.heap[++e.heap_len]=u=r,e.depth[r]=0):o[2*r+1]=0;for(;e.heap_len<2;)o[2*(n=e.heap[++e.heap_len]=u<2?++u:0)]=1,e.depth[n]=0,e.opt_len--,a&&(e.static_len-=s[2*n+1]);for(t.max_code=u,r=e.heap_len>>1;1<=r;r--)z(e,o,r);for(n=c;r=e.heap[1],e.heap[1]=e.heap[e.heap_len--],z(e,o,1),i=e.heap[1],e.heap[--e.heap_max]=r,e.heap[--e.heap_max]=i,o[2*n]=o[2*r]+o[2*i],e.depth[n]=(e.depth[r]>=e.depth[i]?e.depth[r]:e.depth[i])+1,o[2*r+1]=o[2*i+1]=n,e.heap[1]=n++,z(e,o,1),2<=e.heap_len;);e.heap[--e.heap_max]=e.heap[1],function(e,t){var r,i,n,o,s,a,c=t.dyn_tree,u=t.max_code,d=t.stat_desc.static_tree,l=t.stat_desc.has_stree,h=t.stat_desc.extra_bits,m=t.stat_desc.extra_base,g=t.stat_desc.max_length,_=0;for(o=0;o<=p;o++)e.bl_count[o]=0;for(c[2*e.heap[e.heap_max]+1]=0,r=e.heap_max+1;r<f;r++)g<(o=c[2*c[2*(i=e.heap[r])+1]+1]+1)&&(o=g,_++),c[2*i+1]=o,u<i||(e.bl_count[o]++,s=0,m<=i&&(s=h[i-m]),a=c[2*i],e.opt_len+=a*(o+s),l&&(e.static_len+=a*(d[2*i+1]+s)));if(0!==_){do{for(o=g-1;0===e.bl_count[o];)o--;e.bl_count[o]--,e.bl_count[o+1]+=2,e.bl_count[g]--,_-=2}while(0<_);for(o=g;0!==o;o--)for(i=e.bl_count[o];0!==i;)u<(n=e.heap[--r])||(c[2*n+1]!==o&&(e.opt_len+=(o-c[2*n+1])*c[2*n],c[2*n+1]=o),i--)}}(e,t),j(o,u,e.bl_count)}function q(e,t,r){var i,n,o=-1,s=t[1],a=0,c=7,u=4;for(0===s&&(c=138,u=3),t[2*(r+1)+1]=65535,i=0;i<=r;i++)n=s,s=t[2*(i+1)+1],++a<c&&n===s||(a<u?e.bl_tree[2*n]+=a:0!==n?(n!==o&&e.bl_tree[2*n]++,e.bl_tree[2*S]++):a<=10?e.bl_tree[2*v]++:e.bl_tree[2*y]++,o=n,u=(a=0)===s?(c=138,3):n===s?(c=6,3):(c=7,4))}function J(e,t,r){var i,n,o=-1,s=t[1],a=0,c=7,u=4;for(0===s&&(c=138,u=3),i=0;i<=r;i++)if(n=s,s=t[2*(i+1)+1],!(++a<c&&n===s)){if(a<u)for(;V(e,n,e.bl_tree),0!=--a;);else 0!==n?(n!==o&&(V(e,n,e.bl_tree),a--),V(e,S,e.bl_tree),B(e,a-3,2)):a<=10?(V(e,v,e.bl_tree),B(e,a-3,3)):(V(e,y,e.bl_tree),B(e,a-11,7));o=n,u=(a=0)===s?(c=138,3):n===s?(c=6,3):(c=7,4)}}s(D);var X=!1;function Q(e,t,r,n){B(e,(a<<1)+(n?1:0),3),function(e,t,r,n){H(e),n&&(L(e,r),L(e,~r)),i.arraySet(e.pending_buf,e.window,t,r,e.pending),e.pending+=r}(e,t,r,!0)}r._tr_init=function(e){X||(function(){var e,t,r,i,n,o=new Array(p+1);for(i=r=0;i<c-1;i++)for(k[i]=r,e=0;e<1<<I[i];e++)w[r++]=i;for(w[r-1]=i,i=n=0;i<16;i++)for(D[i]=n,e=0;e<1<<T[i];e++)A[n++]=i;for(n>>=7;i<l;i++)for(D[i]=n<<7,e=0;e<1<<T[i]-7;e++)A[256+n++]=i;for(t=0;t<=p;t++)o[t]=0;for(e=0;e<=143;)b[2*e+1]=8,e++,o[8]++;for(;e<=255;)b[2*e+1]=9,e++,o[9]++;for(;e<=279;)b[2*e+1]=7,e++,o[7]++;for(;e<=287;)b[2*e+1]=8,e++,o[8]++;for(j(b,d+1,o),e=0;e<l;e++)C[2*e+1]=5,C[2*e]=Y(e,5);O=new N(b,I,u+1,d,p),P=new N(C,T,0,l,p),M=new N(new Array(0),R,0,h,g)}(),X=!0),e.l_desc=new U(e.dyn_ltree,O),e.d_desc=new U(e.dyn_dtree,P),e.bl_desc=new U(e.bl_tree,M),e.bi_buf=0,e.bi_valid=0,F(e)},r._tr_stored_block=Q,r._tr_flush_block=function(e,t,r,i){var s,a,c=0;0<e.level?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,r=4093624447;for(t=0;t<=31;t++,r>>>=1)if(1&r&&0!==e.dyn_ltree[2*t])return n;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return o;for(t=32;t<u;t++)if(0!==e.dyn_ltree[2*t])return o;return n}(e)),G(e,e.l_desc),G(e,e.d_desc),c=function(e){var t;for(q(e,e.dyn_ltree,e.l_desc.max_code),q(e,e.dyn_dtree,e.d_desc.max_code),G(e,e.bl_desc),t=h-1;3<=t&&0===e.bl_tree[2*E[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),s=e.opt_len+3+7>>>3,(a=e.static_len+3+7>>>3)<=s&&(s=a)):s=a=r+5,r+4<=s&&-1!==t?Q(e,t,r,i):4===e.strategy||a===s?(B(e,2+(i?1:0),3),W(e,b,C)):(B(e,4+(i?1:0),3),function(e,t,r,i){var n;for(B(e,t-257,5),B(e,r-1,5),B(e,i-4,4),n=0;n<i;n++)B(e,e.bl_tree[2*E[n]+1],3);J(e,e.dyn_ltree,t-1),J(e,e.dyn_dtree,r-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,c+1),W(e,e.dyn_ltree,e.dyn_dtree)),F(e),i&&H(e)},r._tr_tally=function(e,t,r){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&r,e.last_lit++,0===t?e.dyn_ltree[2*r]++:(e.matches++,t--,e.dyn_ltree[2*(w[r]+u+1)]++,e.dyn_dtree[2*x(t)]++),e.last_lit===e.lit_bufsize-1},r._tr_align=function(e){B(e,2,3),V(e,_,b),function(e){16===e.bi_valid?(L(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):8<=e.bi_valid&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)}},{"../utils/common":41}],53:[function(e,t,r){t.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,t,r){(function(e){!function(e,t){if(!e.setImmediate){var r,i,n,o,s=1,a={},c=!1,u=e.document,d=Object.getPrototypeOf&&Object.getPrototypeOf(e);d=d&&d.setTimeout?d:e,r="[object process]"==={}.toString.call(e.process)?function(e){!function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];xg.push(new jg(e,t)),1!==xg.length||Lg||Ng(Yg)}((function(){h(e)}))}:function(){if(e.postMessage&&!e.importScripts){var t=!0,r=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=r,t}}()?(o="setImmediate$"+Math.random()+"$",e.addEventListener?e.addEventListener("message",f,!1):e.attachEvent("onmessage",f),function(t){e.postMessage(o+t,"*")}):e.MessageChannel?((n=new MessageChannel).port1.onmessage=function(e){h(e.data)},function(e){n.port2.postMessage(e)}):u&&"onreadystatechange"in u.createElement("script")?(i=u.documentElement,function(e){var t=u.createElement("script");t.onreadystatechange=function(){h(e),t.onreadystatechange=null,i.removeChild(t),t=null},i.appendChild(t)}):function(e){setTimeout(h,0,e)},d.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),i=0;i<t.length;i++)t[i]=arguments[i+1];var n={callback:e,args:t};return a[s]=n,r(s),s++},d.clearImmediate=l}function l(e){delete a[e]}function h(e){if(c)setTimeout(h,0,e);else{var r=a[e];if(r){c=!0;try{!function(e){var r=e.callback,i=e.args;switch(i.length){case 0:r();break;case 1:r(i[0]);break;case 2:r(i[0],i[1]);break;case 3:r(i[0],i[1],i[2]);break;default:r.apply(t,i)}}(r)}finally{l(e),c=!1}}}}function f(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(o)&&h(+t.data.slice(o.length))}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,void 0!==i?i:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[10])(10)}(Kg);var zg=Kg.exports,Wg="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView,Gg=Jr,qg=ti,Jg=ci,Xg=RangeError,Qg=function(e){if(void 0===e)return 0;var t=qg(e),r=Jg(t);if(t!==r)throw Xg("Wrong length or index");return r},$g=Array,Zg=Math.abs,e_=Math.pow,t_=Math.floor,r_=Math.log,i_=Math.LN2,n_={pack:function(e,t,r){var i,n,o,s=$g(r),a=8*r-t-1,c=(1<<a)-1,u=c>>1,d=23===t?e_(2,-24)-e_(2,-77):0,l=e<0||0===e&&1/e<0?1:0,h=0;for((e=Zg(e))!=e||e===1/0?(n=e!=e?1:0,i=c):(i=t_(r_(e)/i_),e*(o=e_(2,-i))<1&&(i--,o*=2),(e+=i+u>=1?d/o:d*e_(2,1-u))*o>=2&&(i++,o/=2),i+u>=c?(n=0,i=c):i+u>=1?(n=(e*o-1)*e_(2,t),i+=u):(n=e*e_(2,u-1)*e_(2,t),i=0));t>=8;)s[h++]=255&n,n/=256,t-=8;for(i=i<<t|n,a+=t;a>0;)s[h++]=255&i,i/=256,a-=8;return s[--h]|=128*l,s},unpack:function(e,t){var r,i=e.length,n=8*i-t-1,o=(1<<n)-1,s=o>>1,a=n-7,c=i-1,u=e[c--],d=127&u;for(u>>=7;a>0;)d=256*d+e[c--],a-=8;for(r=d&(1<<-a)-1,d>>=-a,a+=t;a>0;)r=256*r+e[c--],a-=8;if(0===d)d=1-s;else{if(d===o)return r?NaN:u?-1/0:1/0;r+=e_(2,t),d-=s}return(u?-1:1)*r*e_(2,d-t)}},o_=Ne,s_=oi,a_=di,c_=function(e){for(var t=o_(this),r=a_(t),i=arguments.length,n=s_(i>1?arguments[1]:void 0,r),o=i>2?arguments[2]:void 0,s=void 0===o?r:s_(o,r);s>n;)t[n++]=e;return t},u_=dt,d_=Ct,l_=y,h_=oi,f_=di,p_=function(e,t,r){var i=u_(t);i in e?d_.f(e,i,l_(0,r)):e[i]=r},m_=Array,g_=Math.max,__=function(e,t,r){for(var i=f_(e),n=h_(t,i),o=h_(void 0===r?i:r,i),s=m_(g_(o-n,0)),a=0;n<o;n++,a++)p_(s,a,e[n]);return s.length=a,s},S_=s,v_=C,y_=u,I_=Wg,T_=$t,R_=zt,E_=function(e,t,r){for(var i in t)Gg(e,i,t[i],r);return e},b_=c,C_=yn,A_=ti,w_=ci,k_=Qg,O_=n_,P_=nd,M_=cn,D_=Xr.f,N_=Ct.f,U_=c_,x_=__,L_=hn,B_=T_.PROPER,V_=T_.CONFIGURABLE,Y_=Mr.get,j_=Mr.set,F_="ArrayBuffer",H_="DataView",K_="Wrong index",z_=S_.ArrayBuffer,W_=z_,G_=W_&&W_.prototype,q_=S_.DataView,J_=q_&&q_.prototype,X_=Object.prototype,Q_=S_.Array,$_=S_.RangeError,Z_=v_(U_),eS=v_([].reverse),tS=O_.pack,rS=O_.unpack,iS=function(e){return[255&e]},nS=function(e){return[255&e,e>>8&255]},oS=function(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]},sS=function(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]},aS=function(e){return tS(e,23,4)},cS=function(e){return tS(e,52,8)},uS=function(e,t){N_(e.prototype,t,{get:function(){return Y_(this)[t]}})},dS=function(e,t,r,i){var n=k_(r),o=Y_(e);if(n+t>o.byteLength)throw $_(K_);var s=Y_(o.buffer).bytes,a=n+o.byteOffset,c=x_(s,a,a+t);return i?c:eS(c)},lS=function(e,t,r,i,n,o){var s=k_(r),a=Y_(e);if(s+t>a.byteLength)throw $_(K_);for(var c=Y_(a.buffer).bytes,u=s+a.byteOffset,d=i(+n),l=0;l<t;l++)c[u+l]=d[o?l:t-l-1]};if(I_){var hS=B_&&z_.name!==F_;if(b_((function(){z_(1)}))&&b_((function(){new z_(-1)}))&&!b_((function(){return new z_,new z_(1.5),new z_(NaN),hS&&!V_})))hS&&V_&&R_(z_,"name",F_);else{(W_=function(e){return C_(this,G_),new z_(k_(e))}).prototype=G_;for(var fS,pS=D_(z_),mS=0;pS.length>mS;)(fS=pS[mS++])in W_||R_(W_,fS,z_[fS]);G_.constructor=W_}M_&&P_(J_)!==X_&&M_(J_,X_);var gS=new q_(new W_(2)),_S=v_(J_.setInt8);gS.setInt8(0,2147483648),gS.setInt8(1,2147483649),!gS.getInt8(0)&&gS.getInt8(1)||E_(J_,{setInt8:function(e,t){_S(this,e,t<<24>>24)},setUint8:function(e,t){_S(this,e,t<<24>>24)}},{unsafe:!0})}else W_=function(e){C_(this,G_);var t=k_(e);j_(this,{bytes:Z_(Q_(t),0),byteLength:t}),y_||(this.byteLength=t)},G_=W_.prototype,q_=function(e,t,r){C_(this,J_),C_(e,G_);var i=Y_(e).byteLength,n=A_(t);if(n<0||n>i)throw $_("Wrong offset");if(n+(r=void 0===r?i-n:w_(r))>i)throw $_("Wrong length");j_(this,{buffer:e,byteLength:r,byteOffset:n}),y_||(this.buffer=e,this.byteLength=r,this.byteOffset=n)},J_=q_.prototype,y_&&(uS(W_,"byteLength"),uS(q_,"buffer"),uS(q_,"byteLength"),uS(q_,"byteOffset")),E_(J_,{getInt8:function(e){return dS(this,1,e)[0]<<24>>24},getUint8:function(e){return dS(this,1,e)[0]},getInt16:function(e){var t=dS(this,2,e,arguments.length>1?arguments[1]:void 0);return(t[1]<<8|t[0])<<16>>16},getUint16:function(e){var t=dS(this,2,e,arguments.length>1?arguments[1]:void 0);return t[1]<<8|t[0]},getInt32:function(e){return sS(dS(this,4,e,arguments.length>1?arguments[1]:void 0))},getUint32:function(e){return sS(dS(this,4,e,arguments.length>1?arguments[1]:void 0))>>>0},getFloat32:function(e){return rS(dS(this,4,e,arguments.length>1?arguments[1]:void 0),23)},getFloat64:function(e){return rS(dS(this,8,e,arguments.length>1?arguments[1]:void 0),52)},setInt8:function(e,t){lS(this,1,e,iS,t)},setUint8:function(e,t){lS(this,1,e,iS,t)},setInt16:function(e,t){lS(this,2,e,nS,t,arguments.length>2?arguments[2]:void 0)},setUint16:function(e,t){lS(this,2,e,nS,t,arguments.length>2?arguments[2]:void 0)},setInt32:function(e,t){lS(this,4,e,oS,t,arguments.length>2?arguments[2]:void 0)},setUint32:function(e,t){lS(this,4,e,oS,t,arguments.length>2?arguments[2]:void 0)},setFloat32:function(e,t){lS(this,4,e,aS,t,arguments.length>2?arguments[2]:void 0)},setFloat64:function(e,t){lS(this,8,e,cS,t,arguments.length>2?arguments[2]:void 0)}});L_(W_,F_),L_(q_,H_);var SS={ArrayBuffer:W_,DataView:q_},vS=Zi,yS=C,IS=c,TS=Pt,RS=oi,ES=ci,bS=eo,CS=SS.ArrayBuffer,AS=SS.DataView,wS=AS.prototype,kS=yS(CS.prototype.slice),OS=yS(wS.getUint8),PS=yS(wS.setUint8);vS({target:"ArrayBuffer",proto:!0,unsafe:!0,forced:IS((function(){return!new CS(2).slice(1,void 0).byteLength}))},{slice:function(e,t){if(kS&&void 0===t)return kS(TS(this),e);for(var r=TS(this).byteLength,i=RS(e,r),n=RS(void 0===t?r:t,r),o=new(bS(this,CS))(ES(n-i)),s=new AS(this),a=new AS(o),c=0;i<n;)PS(a,c++,OS(s,i++));return o}});var MS,DS,NS,US={exports:{}},xS=Wg,LS=u,BS=s,VS=j,YS=H,jS=Le,FS=wn,HS=fe,KS=zt,zS=Jr,WS=Ct.f,GS=q,qS=nd,JS=cn,XS=Ze,QS=Fe,$S=Mr.enforce,ZS=Mr.get,ev=BS.Int8Array,tv=ev&&ev.prototype,rv=BS.Uint8ClampedArray,iv=rv&&rv.prototype,nv=ev&&qS(ev),ov=tv&&qS(tv),sv=Object.prototype,av=BS.TypeError,cv=XS("toStringTag"),uv=QS("TYPED_ARRAY_TAG"),dv="TypedArrayConstructor",lv=xS&&!!JS&&"Opera"!==FS(BS.opera),hv=!1,fv={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},pv={BigInt64Array:8,BigUint64Array:8},mv=function(e){var t=qS(e);if(YS(t)){var r=ZS(t);return r&&jS(r,dv)?r.TypedArrayConstructor:mv(t)}},gv=function(e){if(!YS(e))return!1;var t=FS(e);return jS(fv,t)||jS(pv,t)};for(MS in fv)(NS=(DS=BS[MS])&&DS.prototype)?$S(NS).TypedArrayConstructor=DS:lv=!1;for(MS in pv)(NS=(DS=BS[MS])&&DS.prototype)&&($S(NS).TypedArrayConstructor=DS);if((!lv||!VS(nv)||nv===Function.prototype)&&(nv=function(){throw av("Incorrect invocation")},lv))for(MS in fv)BS[MS]&&JS(BS[MS],nv);if((!lv||!ov||ov===sv)&&(ov=nv.prototype,lv))for(MS in fv)BS[MS]&&JS(BS[MS].prototype,ov);if(lv&&qS(iv)!==ov&&JS(iv,ov),LS&&!jS(ov,cv))for(MS in hv=!0,WS(ov,cv,{get:function(){return YS(this)?this[uv]:void 0}}),fv)BS[MS]&&KS(BS[MS],uv,MS);var _v={NATIVE_ARRAY_BUFFER_VIEWS:lv,TYPED_ARRAY_TAG:hv&&uv,aTypedArray:function(e){if(gv(e))return e;throw av("Target is not a typed array")},aTypedArrayConstructor:function(e){if(VS(e)&&(!JS||GS(nv,e)))return e;throw av(HS(e)+" is not a typed array constructor")},exportTypedArrayMethod:function(e,t,r,i){if(LS){if(r)for(var n in fv){var o=BS[n];if(o&&jS(o.prototype,e))try{delete o.prototype[e]}catch(kD){try{o.prototype[e]=t}catch(s){}}}ov[e]&&!r||zS(ov,e,r?t:lv&&tv[e]||t,i)}},exportTypedArrayStaticMethod:function(e,t,r){var i,n;if(LS){if(JS){if(r)for(i in fv)if((n=BS[i])&&jS(n,e))try{delete n[e]}catch(kD){}if(nv[e]&&!r)return;try{return zS(nv,e,r?t:lv&&nv[e]||t)}catch(kD){}}for(i in fv)!(n=BS[i])||n[e]&&!r||zS(n,e,t)}},getTypedArrayConstructor:mv,isView:function(e){if(!YS(e))return!1;var t=FS(e);return"DataView"===t||jS(fv,t)||jS(pv,t)},isTypedArray:gv,TypedArray:nv,TypedArrayPrototype:ov},Sv=s,vv=c,yv=gc,Iv=_v.NATIVE_ARRAY_BUFFER_VIEWS,Tv=Sv.ArrayBuffer,Rv=Sv.Int8Array,Ev=!Iv||!vv((function(){Rv(1)}))||!vv((function(){new Rv(-1)}))||!yv((function(e){new Rv,new Rv(null),new Rv(1.5),new Rv(e)}),!0)||vv((function(){return 1!==new Rv(new Tv(2),1,void 0).length})),bv=H,Cv=Math.floor,Av=Number.isInteger||function(e){return!bv(e)&&isFinite(e)&&Cv(e)===e},wv=ti,kv=RangeError,Ov=function(e){var t=wv(e);if(t<0)throw kv("The argument can't be less than 0");return t},Pv=RangeError,Mv=function(e,t){var r=Ov(e);if(r%t)throw Pv("Wrong offset");return r},Dv=uo,Nv=f,Uv=Xn,xv=Ne,Lv=di,Bv=qa,Vv=ja,Yv=xa,jv=_v.aTypedArrayConstructor,Fv=Zi,Hv=s,Kv=f,zv=u,Wv=Ev,Gv=_v,qv=SS,Jv=yn,Xv=y,Qv=zt,$v=Av,Zv=ci,ey=Qg,ty=Mv,ry=dt,iy=Le,ny=wn,oy=H,sy=le,ay=Yu,cy=q,uy=cn,dy=Xr.f,ly=function(e){var t,r,i,n,o,s,a=Uv(this),c=xv(e),u=arguments.length,d=u>1?arguments[1]:void 0,l=void 0!==d,h=Vv(c);if(h&&!Yv(h))for(s=(o=Bv(c,h)).next,c=[];!(n=Nv(s,o)).done;)c.push(n.value);for(l&&u>2&&(d=Dv(d,arguments[2])),r=Lv(c),i=new(jv(a))(r),t=0;r>t;t++)i[t]=l?d(c[t],t):c[t];return i},hy=xh.forEach,fy=_n,py=Ct,my=a,gy=Up,_y=Mr.get,Sy=Mr.set,vy=Mr.enforce,yy=py.f,Iy=my.f,Ty=Math.round,Ry=Hv.RangeError,Ey=qv.ArrayBuffer,by=Ey.prototype,Cy=qv.DataView,Ay=Gv.NATIVE_ARRAY_BUFFER_VIEWS,wy=Gv.TYPED_ARRAY_TAG,ky=Gv.TypedArray,Oy=Gv.TypedArrayPrototype,Py=Gv.aTypedArrayConstructor,My=Gv.isTypedArray,Dy="BYTES_PER_ELEMENT",Ny="Wrong length",Uy=function(e,t){Py(e);for(var r=0,i=t.length,n=new e(i);i>r;)n[r]=t[r++];return n},xy=function(e,t){yy(e,t,{get:function(){return _y(this)[t]}})},Ly=function(e){var t;return cy(by,e)||"ArrayBuffer"==(t=ny(e))||"SharedArrayBuffer"==t},By=function(e,t){return My(e)&&!sy(t)&&t in e&&$v(+t)&&t>=0},Vy=function(e,t){return t=ry(t),By(e,t)?Xv(2,e[t]):Iy(e,t)},Yy=function(e,t,r){return t=ry(t),!(By(e,t)&&oy(r)&&iy(r,"value"))||iy(r,"get")||iy(r,"set")||r.configurable||iy(r,"writable")&&!r.writable||iy(r,"enumerable")&&!r.enumerable?yy(e,t,r):(e[t]=r.value,e)};zv?(Ay||(my.f=Vy,py.f=Yy,xy(Oy,"buffer"),xy(Oy,"byteOffset"),xy(Oy,"byteLength"),xy(Oy,"length")),Fv({target:"Object",stat:!0,forced:!Ay},{getOwnPropertyDescriptor:Vy,defineProperty:Yy}),US.exports=function(e,t,r){var i=e.match(/\d+$/)[0]/8,n=e+(r?"Clamped":"")+"Array",o="get"+e,s="set"+e,a=Hv[n],c=a,u=c&&c.prototype,d={},l=function(e,t){yy(e,t,{get:function(){return function(e,t){var r=_y(e);return r.view[o](t*i+r.byteOffset,!0)}(this,t)},set:function(e){return function(e,t,n){var o=_y(e);r&&(n=(n=Ty(n))<0?0:n>255?255:255&n),o.view[s](t*i+o.byteOffset,n,!0)}(this,t,e)},enumerable:!0})};Ay?Wv&&(c=t((function(e,t,r,n){return Jv(e,u),gy(oy(t)?Ly(t)?void 0!==n?new a(t,ty(r,i),n):void 0!==r?new a(t,ty(r,i)):new a(t):My(t)?Uy(c,t):Kv(ly,c,t):new a(ey(t)),e,c)})),uy&&uy(c,ky),hy(dy(a),(function(e){e in c||Qv(c,e,a[e])})),c.prototype=u):(c=t((function(e,t,r,n){Jv(e,u);var o,s,a,d=0,h=0;if(oy(t)){if(!Ly(t))return My(t)?Uy(c,t):Kv(ly,c,t);o=t,h=ty(r,i);var f=t.byteLength;if(void 0===n){if(f%i)throw Ry(Ny);if((s=f-h)<0)throw Ry(Ny)}else if((s=Zv(n)*i)+h>f)throw Ry(Ny);a=s/i}else a=ey(t),o=new Ey(s=a*i);for(Sy(e,{buffer:o,byteOffset:h,byteLength:s,length:a,view:new Cy(o)});d<a;)l(e,d++)})),uy&&uy(c,ky),u=c.prototype=ay(Oy)),u.constructor!==c&&Qv(u,"constructor",c),vy(u).TypedArrayConstructor=c,wy&&Qv(u,wy,n);var h=c!=a;d[n]=c,Fv({global:!0,constructor:!0,forced:h,sham:!Ay},d),Dy in c||Qv(c,Dy,i),Dy in u||Qv(u,Dy,i),fy(n)}):US.exports=function(){},(0,US.exports)("Uint8",(function(e){return function(t,r,i){return e(this,t,r,i)}}));var jy=at,Fy=TypeError,Hy=c_,Ky=function(e){var t=jy(e,"number");if("number"==typeof t)throw Fy("Can't convert number to bigint");return BigInt(t)},zy=wn,Wy=f,Gy=c,qy=_v.aTypedArray,Jy=_v.exportTypedArrayMethod,Xy=C("".slice);Jy("fill",(function(e){var t=arguments.length;qy(this);var r="Big"===Xy(zy(this),0,3)?Ky(e):+e;return Wy(Hy,this,r,t>1?arguments[1]:void 0,t>2?arguments[2]:void 0)}),Gy((function(){var e=0;return new Int8Array(2).fill({valueOf:function(){return e++}}),1!==e})));var Qy=s,$y=f,Zy=_v,eI=di,tI=Mv,rI=Ne,iI=c,nI=Qy.RangeError,oI=Qy.Int8Array,sI=oI&&oI.prototype,aI=sI&&sI.set,cI=Zy.aTypedArray,uI=Zy.exportTypedArrayMethod,dI=!iI((function(){var e=new Uint8ClampedArray(2);return $y(aI,e,{length:1,0:3},1),3!==e[1]})),lI=dI&&Zy.NATIVE_ARRAY_BUFFER_VIEWS&&iI((function(){var e=new oI(2);return e.set(1),e.set("2",1),0!==e[0]||2!==e[1]}));uI("set",(function(e){cI(this);var t=tI(arguments.length>1?arguments[1]:void 0,1),r=rI(e);if(dI)return $y(aI,this,r,t);var i=this.length,n=eI(r),o=0;if(n+t>i)throw nI("Wrong length");for(;o<n;)this[t+o]=r[o++]}),!dI||lI);var hI=__,fI=Math.floor,pI=function(e,t){var r=e.length,i=fI(r/2);return r<8?mI(e,t):gI(e,pI(hI(e,0,i),t),pI(hI(e,i),t),t)},mI=function(e,t){for(var r,i,n=e.length,o=1;o<n;){for(i=o,r=e[o];i&&t(e[i-1],r)>0;)e[i]=e[--i];i!==o++&&(e[i]=r)}return e},gI=function(e,t,r,i){for(var n=t.length,o=r.length,s=0,a=0;s<n||a<o;)e[s+a]=s<n&&a<o?i(t[s],r[a])<=0?t[s++]:r[a++]:s<n?t[s++]:r[a++];return e},_I=pI,SI=J.match(/firefox\/(\d+)/i),vI=!!SI&&+SI[1],yI=/MSIE|Trident/.test(J),II=J.match(/AppleWebKit\/(\d+)\./),TI=!!II&&+II[1],RI=C,EI=c,bI=_e,CI=_I,AI=vI,wI=yI,kI=re,OI=TI,PI=_v.aTypedArray,MI=_v.exportTypedArrayMethod,DI=s.Uint16Array,NI=DI&&RI(DI.prototype.sort),UI=!(!NI||EI((function(){NI(new DI(2),null)}))&&EI((function(){NI(new DI(2),{})}))),xI=!!NI&&!EI((function(){if(kI)return kI<74;if(AI)return AI<67;if(wI)return!0;if(OI)return OI<602;var e,t,r=new DI(516),i=Array(516);for(e=0;e<516;e++)t=e%4,r[e]=515-e,i[e]=e-2*t+3;for(NI(r,(function(e,t){return(e/4|0)-(t/4|0)})),e=0;e<516;e++)if(r[e]!==i[e])return!0}));MI("sort",(function(e){return void 0!==e&&bI(e),xI?NI(this,e):CI(PI(this),function(e){return function(t,r){return void 0!==e?+e(t,r)||0:r!=r?-1:t!=t?1:0===t&&0===r?1/t>0&&1/r<0?1:-1:t>r}}(e))}),!xI||UI);var LI,BI={exports:{}},VI={exports:{}},YI=n(Object.freeze({__proto__:null,default:{}}));function jI(){return LI||(LI=1,function(e,t){var r;e.exports=(r=r||function(e,t){var r;if("undefined"!=typeof window&&window.crypto&&(r=window.crypto),"undefined"!=typeof self&&self.crypto&&(r=self.crypto),"undefined"!=typeof globalThis&&globalThis.crypto&&(r=globalThis.crypto),!r&&"undefined"!=typeof window&&window.msCrypto&&(r=window.msCrypto),!r&&void 0!==i&&i.crypto&&(r=i.crypto),!r)try{r=YI}catch(g){}var n=function(){if(r){if("function"==typeof r.getRandomValues)try{return r.getRandomValues(new Uint32Array(1))[0]}catch(g){}if("function"==typeof r.randomBytes)try{return r.randomBytes(4).readInt32LE()}catch(g){}}throw new Error("Native crypto module could not be used to get secure random number.")},o=Object.create||function(){function e(){}return function(t){var r;return e.prototype=t,r=new e,e.prototype=null,r}}(),s={},a=s.lib={},c=a.Base={extend:function(e){var t=o(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},u=a.WordArray=c.extend({init:function(e,r){e=this.words=e||[],this.sigBytes=r!=t?r:4*e.length},toString:function(e){return(e||l).stringify(this)},concat:function(e){var t=this.words,r=e.words,i=this.sigBytes,n=e.sigBytes;if(this.clamp(),i%4)for(var o=0;o<n;o++){var s=r[o>>>2]>>>24-o%4*8&255;t[i+o>>>2]|=s<<24-(i+o)%4*8}else for(var a=0;a<n;a+=4)t[i+a>>>2]=r[a>>>2];return this.sigBytes+=n,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4)},clone:function(){var e=c.clone.call(this);return e.words=this.words.slice(0),e},random:function(e){for(var t=[],r=0;r<e;r+=4)t.push(n());return new u.init(t,e)}}),d=s.enc={},l=d.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,i=[],n=0;n<r;n++){var o=t[n>>>2]>>>24-n%4*8&255;i.push((o>>>4).toString(16)),i.push((15&o).toString(16))}return i.join("")},parse:function(e){for(var t=e.length,r=[],i=0;i<t;i+=2)r[i>>>3]|=parseInt(e.substr(i,2),16)<<24-i%8*4;return new u.init(r,t/2)}},h=d.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,i=[],n=0;n<r;n++){var o=t[n>>>2]>>>24-n%4*8&255;i.push(String.fromCharCode(o))}return i.join("")},parse:function(e){for(var t=e.length,r=[],i=0;i<t;i++)r[i>>>2]|=(255&e.charCodeAt(i))<<24-i%4*8;return new u.init(r,t)}},f=d.Utf8={stringify:function(e){try{return decodeURIComponent(escape(h.stringify(e)))}catch(lw){throw new Error("Malformed UTF-8 data")}},parse:function(e){return h.parse(unescape(encodeURIComponent(e)))}},p=a.BufferedBlockAlgorithm=c.extend({reset:function(){this._data=new u.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=f.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var r,i=this._data,n=i.words,o=i.sigBytes,s=this.blockSize,a=o/(4*s),c=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*s,d=e.min(4*c,o);if(c){for(var l=0;l<c;l+=s)this._doProcessBlock(n,l);r=n.splice(0,c),i.sigBytes-=d}return new u.init(r,d)},clone:function(){var e=c.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});a.Hasher=p.extend({cfg:c.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){p.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new m.HMAC.init(e,r).finalize(t)}}});var m=s.algo={};return s}(Math),r)}(VI)),VI.exports}var FI,HI={exports:{}};function KI(){return FI||(FI=1,function(e,t){var r;e.exports=(r=jI(),function(e){var t=r,i=t.lib,n=i.Base,o=i.WordArray,s=t.x64={};s.Word=n.extend({init:function(e,t){this.high=e,this.low=t}}),s.WordArray=n.extend({init:function(t,r){t=this.words=t||[],this.sigBytes=r!=e?r:8*t.length},toX32:function(){for(var e=this.words,t=e.length,r=[],i=0;i<t;i++){var n=e[i];r.push(n.high),r.push(n.low)}return o.create(r,this.sigBytes)},clone:function(){for(var e=n.clone.call(this),t=e.words=this.words.slice(0),r=t.length,i=0;i<r;i++)t[i]=t[i].clone();return e}})}(),r)}(HI)),HI.exports}var zI,WI={exports:{}};function GI(){return zI||(zI=1,function(e,t){var r;e.exports=(r=jI(),function(){if("function"==typeof ArrayBuffer){var e=r.lib.WordArray,t=e.init,i=e.init=function(e){if(e instanceof ArrayBuffer&&(e=new Uint8Array(e)),(e instanceof Int8Array||"undefined"!=typeof Uint8ClampedArray&&e instanceof Uint8ClampedArray||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array)&&(e=new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),e instanceof Uint8Array){for(var r=e.byteLength,i=[],n=0;n<r;n++)i[n>>>2]|=e[n]<<24-n%4*8;t.call(this,i,r)}else t.apply(this,arguments)};i.prototype=e}}(),r.lib.WordArray)}(WI)),WI.exports}var qI,JI={exports:{}};function XI(){return qI||(qI=1,function(e,t){var r;e.exports=(r=jI(),function(){var e=r,t=e.lib.WordArray,i=e.enc;function n(e){return e<<8&4278255360|e>>>8&16711935}i.Utf16=i.Utf16BE={stringify:function(e){for(var t=e.words,r=e.sigBytes,i=[],n=0;n<r;n+=2){var o=t[n>>>2]>>>16-n%4*8&65535;i.push(String.fromCharCode(o))}return i.join("")},parse:function(e){for(var r=e.length,i=[],n=0;n<r;n++)i[n>>>1]|=e.charCodeAt(n)<<16-n%2*16;return t.create(i,2*r)}},i.Utf16LE={stringify:function(e){for(var t=e.words,r=e.sigBytes,i=[],o=0;o<r;o+=2){var s=n(t[o>>>2]>>>16-o%4*8&65535);i.push(String.fromCharCode(s))}return i.join("")},parse:function(e){for(var r=e.length,i=[],o=0;o<r;o++)i[o>>>1]|=n(e.charCodeAt(o)<<16-o%2*16);return t.create(i,2*r)}}}(),r.enc.Utf16)}(JI)),JI.exports}var QI,$I={exports:{}};function ZI(){return QI||(QI=1,function(e,t){var r;e.exports=(r=jI(),function(){var e=r,t=e.lib.WordArray;function i(e,r,i){for(var n=[],o=0,s=0;s<r;s++)if(s%4){var a=i[e.charCodeAt(s-1)]<<s%4*2|i[e.charCodeAt(s)]>>>6-s%4*2;n[o>>>2]|=a<<24-o%4*8,o++}return t.create(n,o)}e.enc.Base64={stringify:function(e){var t=e.words,r=e.sigBytes,i=this._map;e.clamp();for(var n=[],o=0;o<r;o+=3)for(var s=(t[o>>>2]>>>24-o%4*8&255)<<16|(t[o+1>>>2]>>>24-(o+1)%4*8&255)<<8|t[o+2>>>2]>>>24-(o+2)%4*8&255,a=0;a<4&&o+.75*a<r;a++)n.push(i.charAt(s>>>6*(3-a)&63));var c=i.charAt(64);if(c)for(;n.length%4;)n.push(c);return n.join("")},parse:function(e){var t=e.length,r=this._map,n=this._reverseMap;if(!n){n=this._reverseMap=[];for(var o=0;o<r.length;o++)n[r.charCodeAt(o)]=o}var s=r.charAt(64);if(s){var a=e.indexOf(s);-1!==a&&(t=a)}return i(e,t,n)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),r.enc.Base64)}($I)),$I.exports}var eT,tT={exports:{}};function rT(){return eT||(eT=1,function(e,t){var r;e.exports=(r=jI(),function(){var e=r,t=e.lib.WordArray;function i(e,r,i){for(var n=[],o=0,s=0;s<r;s++)if(s%4){var a=i[e.charCodeAt(s-1)]<<s%4*2|i[e.charCodeAt(s)]>>>6-s%4*2;n[o>>>2]|=a<<24-o%4*8,o++}return t.create(n,o)}e.enc.Base64url={stringify:function(e,t=!0){var r=e.words,i=e.sigBytes,n=t?this._safe_map:this._map;e.clamp();for(var o=[],s=0;s<i;s+=3)for(var a=(r[s>>>2]>>>24-s%4*8&255)<<16|(r[s+1>>>2]>>>24-(s+1)%4*8&255)<<8|r[s+2>>>2]>>>24-(s+2)%4*8&255,c=0;c<4&&s+.75*c<i;c++)o.push(n.charAt(a>>>6*(3-c)&63));var u=n.charAt(64);if(u)for(;o.length%4;)o.push(u);return o.join("")},parse:function(e,t=!0){var r=e.length,n=t?this._safe_map:this._map,o=this._reverseMap;if(!o){o=this._reverseMap=[];for(var s=0;s<n.length;s++)o[n.charCodeAt(s)]=s}var a=n.charAt(64);if(a){var c=e.indexOf(a);-1!==c&&(r=c)}return i(e,r,o)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_safe_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"}}(),r.enc.Base64url)}(tT)),tT.exports}var iT,nT={exports:{}};function oT(){return iT||(iT=1,function(e,t){var r;e.exports=(r=jI(),function(e){var t=r,i=t.lib,n=i.WordArray,o=i.Hasher,s=t.algo,a=[];!function(){for(var t=0;t<64;t++)a[t]=4294967296*e.abs(e.sin(t+1))|0}();var c=s.MD5=o.extend({_doReset:function(){this._hash=new n.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,t){for(var r=0;r<16;r++){var i=t+r,n=e[i];e[i]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8)}var o=this._hash.words,s=e[t+0],c=e[t+1],f=e[t+2],p=e[t+3],m=e[t+4],g=e[t+5],_=e[t+6],S=e[t+7],v=e[t+8],y=e[t+9],I=e[t+10],T=e[t+11],R=e[t+12],E=e[t+13],b=e[t+14],C=e[t+15],A=o[0],w=o[1],k=o[2],O=o[3];A=u(A,w,k,O,s,7,a[0]),O=u(O,A,w,k,c,12,a[1]),k=u(k,O,A,w,f,17,a[2]),w=u(w,k,O,A,p,22,a[3]),A=u(A,w,k,O,m,7,a[4]),O=u(O,A,w,k,g,12,a[5]),k=u(k,O,A,w,_,17,a[6]),w=u(w,k,O,A,S,22,a[7]),A=u(A,w,k,O,v,7,a[8]),O=u(O,A,w,k,y,12,a[9]),k=u(k,O,A,w,I,17,a[10]),w=u(w,k,O,A,T,22,a[11]),A=u(A,w,k,O,R,7,a[12]),O=u(O,A,w,k,E,12,a[13]),k=u(k,O,A,w,b,17,a[14]),A=d(A,w=u(w,k,O,A,C,22,a[15]),k,O,c,5,a[16]),O=d(O,A,w,k,_,9,a[17]),k=d(k,O,A,w,T,14,a[18]),w=d(w,k,O,A,s,20,a[19]),A=d(A,w,k,O,g,5,a[20]),O=d(O,A,w,k,I,9,a[21]),k=d(k,O,A,w,C,14,a[22]),w=d(w,k,O,A,m,20,a[23]),A=d(A,w,k,O,y,5,a[24]),O=d(O,A,w,k,b,9,a[25]),k=d(k,O,A,w,p,14,a[26]),w=d(w,k,O,A,v,20,a[27]),A=d(A,w,k,O,E,5,a[28]),O=d(O,A,w,k,f,9,a[29]),k=d(k,O,A,w,S,14,a[30]),A=l(A,w=d(w,k,O,A,R,20,a[31]),k,O,g,4,a[32]),O=l(O,A,w,k,v,11,a[33]),k=l(k,O,A,w,T,16,a[34]),w=l(w,k,O,A,b,23,a[35]),A=l(A,w,k,O,c,4,a[36]),O=l(O,A,w,k,m,11,a[37]),k=l(k,O,A,w,S,16,a[38]),w=l(w,k,O,A,I,23,a[39]),A=l(A,w,k,O,E,4,a[40]),O=l(O,A,w,k,s,11,a[41]),k=l(k,O,A,w,p,16,a[42]),w=l(w,k,O,A,_,23,a[43]),A=l(A,w,k,O,y,4,a[44]),O=l(O,A,w,k,R,11,a[45]),k=l(k,O,A,w,C,16,a[46]),A=h(A,w=l(w,k,O,A,f,23,a[47]),k,O,s,6,a[48]),O=h(O,A,w,k,S,10,a[49]),k=h(k,O,A,w,b,15,a[50]),w=h(w,k,O,A,g,21,a[51]),A=h(A,w,k,O,R,6,a[52]),O=h(O,A,w,k,p,10,a[53]),k=h(k,O,A,w,I,15,a[54]),w=h(w,k,O,A,c,21,a[55]),A=h(A,w,k,O,v,6,a[56]),O=h(O,A,w,k,C,10,a[57]),k=h(k,O,A,w,_,15,a[58]),w=h(w,k,O,A,E,21,a[59]),A=h(A,w,k,O,m,6,a[60]),O=h(O,A,w,k,T,10,a[61]),k=h(k,O,A,w,f,15,a[62]),w=h(w,k,O,A,y,21,a[63]),o[0]=o[0]+A|0,o[1]=o[1]+w|0,o[2]=o[2]+k|0,o[3]=o[3]+O|0},_doFinalize:function(){var t=this._data,r=t.words,i=8*this._nDataBytes,n=8*t.sigBytes;r[n>>>5]|=128<<24-n%32;var o=e.floor(i/4294967296),s=i;r[15+(n+64>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),r[14+(n+64>>>9<<4)]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),t.sigBytes=4*(r.length+1),this._process();for(var a=this._hash,c=a.words,u=0;u<4;u++){var d=c[u];c[u]=16711935&(d<<8|d>>>24)|4278255360&(d<<24|d>>>8)}return a},clone:function(){var e=o.clone.call(this);return e._hash=this._hash.clone(),e}});function u(e,t,r,i,n,o,s){var a=e+(t&r|~t&i)+n+s;return(a<<o|a>>>32-o)+t}function d(e,t,r,i,n,o,s){var a=e+(t&i|r&~i)+n+s;return(a<<o|a>>>32-o)+t}function l(e,t,r,i,n,o,s){var a=e+(t^r^i)+n+s;return(a<<o|a>>>32-o)+t}function h(e,t,r,i,n,o,s){var a=e+(r^(t|~i))+n+s;return(a<<o|a>>>32-o)+t}t.MD5=o._createHelper(c),t.HmacMD5=o._createHmacHelper(c)}(Math),r.MD5)}(nT)),nT.exports}var sT,aT={exports:{}};function cT(){return sT||(sT=1,function(e,t){var r;e.exports=(r=jI(),function(){var e=r,t=e.lib,i=t.WordArray,n=t.Hasher,o=e.algo,s=[],a=o.SHA1=n.extend({_doReset:function(){this._hash=new i.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var r=this._hash.words,i=r[0],n=r[1],o=r[2],a=r[3],c=r[4],u=0;u<80;u++){if(u<16)s[u]=0|e[t+u];else{var d=s[u-3]^s[u-8]^s[u-14]^s[u-16];s[u]=d<<1|d>>>31}var l=(i<<5|i>>>27)+c+s[u];l+=u<20?1518500249+(n&o|~n&a):u<40?1859775393+(n^o^a):u<60?(n&o|n&a|o&a)-1894007588:(n^o^a)-899497514,c=a,a=o,o=n<<30|n>>>2,n=i,i=l}r[0]=r[0]+i|0,r[1]=r[1]+n|0,r[2]=r[2]+o|0,r[3]=r[3]+a|0,r[4]=r[4]+c|0},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,i=8*e.sigBytes;return t[i>>>5]|=128<<24-i%32,t[14+(i+64>>>9<<4)]=Math.floor(r/4294967296),t[15+(i+64>>>9<<4)]=r,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e}});e.SHA1=n._createHelper(a),e.HmacSHA1=n._createHmacHelper(a)}(),r.SHA1)}(aT)),aT.exports}var uT,dT={exports:{}};function lT(){return uT||(uT=1,function(e,t){var r;e.exports=(r=jI(),function(e){var t=r,i=t.lib,n=i.WordArray,o=i.Hasher,s=t.algo,a=[],c=[];!function(){function t(t){for(var r=e.sqrt(t),i=2;i<=r;i++)if(!(t%i))return!1;return!0}function r(e){return 4294967296*(e-(0|e))|0}for(var i=2,n=0;n<64;)t(i)&&(n<8&&(a[n]=r(e.pow(i,.5))),c[n]=r(e.pow(i,1/3)),n++),i++}();var u=[],d=s.SHA256=o.extend({_doReset:function(){this._hash=new n.init(a.slice(0))},_doProcessBlock:function(e,t){for(var r=this._hash.words,i=r[0],n=r[1],o=r[2],s=r[3],a=r[4],d=r[5],l=r[6],h=r[7],f=0;f<64;f++){if(f<16)u[f]=0|e[t+f];else{var p=u[f-15],m=(p<<25|p>>>7)^(p<<14|p>>>18)^p>>>3,g=u[f-2],_=(g<<15|g>>>17)^(g<<13|g>>>19)^g>>>10;u[f]=m+u[f-7]+_+u[f-16]}var S=i&n^i&o^n&o,v=(i<<30|i>>>2)^(i<<19|i>>>13)^(i<<10|i>>>22),y=h+((a<<26|a>>>6)^(a<<21|a>>>11)^(a<<7|a>>>25))+(a&d^~a&l)+c[f]+u[f];h=l,l=d,d=a,a=s+y|0,s=o,o=n,n=i,i=y+(v+S)|0}r[0]=r[0]+i|0,r[1]=r[1]+n|0,r[2]=r[2]+o|0,r[3]=r[3]+s|0,r[4]=r[4]+a|0,r[5]=r[5]+d|0,r[6]=r[6]+l|0,r[7]=r[7]+h|0},_doFinalize:function(){var t=this._data,r=t.words,i=8*this._nDataBytes,n=8*t.sigBytes;return r[n>>>5]|=128<<24-n%32,r[14+(n+64>>>9<<4)]=e.floor(i/4294967296),r[15+(n+64>>>9<<4)]=i,t.sigBytes=4*r.length,this._process(),this._hash},clone:function(){var e=o.clone.call(this);return e._hash=this._hash.clone(),e}});t.SHA256=o._createHelper(d),t.HmacSHA256=o._createHmacHelper(d)}(Math),r.SHA256)}(dT)),dT.exports}var hT,fT={exports:{}};var pT,mT={exports:{}};function gT(){return pT||(pT=1,function(e,t){var r;e.exports=(r=jI(),KI(),function(){var e=r,t=e.lib.Hasher,i=e.x64,n=i.Word,o=i.WordArray,s=e.algo;function a(){return n.create.apply(n,arguments)}var c=[a(1116352408,3609767458),a(1899447441,602891725),a(3049323471,3964484399),a(3921009573,2173295548),a(961987163,4081628472),a(1508970993,3053834265),a(2453635748,2937671579),a(2870763221,3664609560),a(3624381080,2734883394),a(310598401,1164996542),a(607225278,1323610764),a(1426881987,3590304994),a(1925078388,4068182383),a(2162078206,991336113),a(2614888103,633803317),a(3248222580,3479774868),a(3835390401,2666613458),a(4022224774,944711139),a(264347078,2341262773),a(604807628,2007800933),a(770255983,1495990901),a(1249150122,1856431235),a(1555081692,3175218132),a(1996064986,2198950837),a(2554220882,3999719339),a(2821834349,766784016),a(2952996808,2566594879),a(3210313671,3203337956),a(3336571891,1034457026),a(3584528711,2466948901),a(113926993,3758326383),a(338241895,168717936),a(666307205,1188179964),a(773529912,1546045734),a(1294757372,1522805485),a(1396182291,2643833823),a(1695183700,2343527390),a(1986661051,1014477480),a(2177026350,1206759142),a(2456956037,344077627),a(2730485921,1290863460),a(2820302411,3158454273),a(3259730800,3505952657),a(3345764771,106217008),a(3516065817,3606008344),a(3600352804,1432725776),a(4094571909,1467031594),a(275423344,851169720),a(430227734,3100823752),a(506948616,1363258195),a(659060556,3750685593),a(883997877,3785050280),a(958139571,3318307427),a(1322822218,3812723403),a(1537002063,2003034995),a(1747873779,3602036899),a(1955562222,1575990012),a(2024104815,1125592928),a(2227730452,2716904306),a(2361852424,442776044),a(2428436474,593698344),a(2756734187,3733110249),a(3204031479,2999351573),a(3329325298,3815920427),a(3391569614,3928383900),a(3515267271,566280711),a(3940187606,3454069534),a(4118630271,4000239992),a(116418474,1914138554),a(174292421,2731055270),a(289380356,3203993006),a(460393269,320620315),a(685471733,587496836),a(852142971,1086792851),a(1017036298,365543100),a(1126000580,2618297676),a(1288033470,3409855158),a(1501505948,4234509866),a(1607167915,987167468),a(1816402316,1246189591)],u=[];!function(){for(var e=0;e<80;e++)u[e]=a()}();var d=s.SHA512=t.extend({_doReset:function(){this._hash=new o.init([new n.init(1779033703,4089235720),new n.init(3144134277,2227873595),new n.init(1013904242,4271175723),new n.init(2773480762,1595750129),new n.init(1359893119,2917565137),new n.init(2600822924,725511199),new n.init(528734635,4215389547),new n.init(1541459225,327033209)])},_doProcessBlock:function(e,t){for(var r=this._hash.words,i=r[0],n=r[1],o=r[2],s=r[3],a=r[4],d=r[5],l=r[6],h=r[7],f=i.high,p=i.low,m=n.high,g=n.low,_=o.high,S=o.low,v=s.high,y=s.low,I=a.high,T=a.low,R=d.high,E=d.low,b=l.high,C=l.low,A=h.high,w=h.low,k=f,O=p,P=m,M=g,D=_,N=S,U=v,x=y,L=I,B=T,V=R,Y=E,j=b,F=C,H=A,K=w,z=0;z<80;z++){var W,G,q=u[z];if(z<16)G=q.high=0|e[t+2*z],W=q.low=0|e[t+2*z+1];else{var J=u[z-15],X=J.high,Q=J.low,$=(X>>>1|Q<<31)^(X>>>8|Q<<24)^X>>>7,Z=(Q>>>1|X<<31)^(Q>>>8|X<<24)^(Q>>>7|X<<25),ee=u[z-2],te=ee.high,re=ee.low,ie=(te>>>19|re<<13)^(te<<3|re>>>29)^te>>>6,ne=(re>>>19|te<<13)^(re<<3|te>>>29)^(re>>>6|te<<26),oe=u[z-7],se=oe.high,ae=oe.low,ce=u[z-16],ue=ce.high,de=ce.low;G=(G=(G=$+se+((W=Z+ae)>>>0<Z>>>0?1:0))+ie+((W+=ne)>>>0<ne>>>0?1:0))+ue+((W+=de)>>>0<de>>>0?1:0),q.high=G,q.low=W}var le,he=L&V^~L&j,fe=B&Y^~B&F,pe=k&P^k&D^P&D,me=O&M^O&N^M&N,ge=(k>>>28|O<<4)^(k<<30|O>>>2)^(k<<25|O>>>7),_e=(O>>>28|k<<4)^(O<<30|k>>>2)^(O<<25|k>>>7),Se=(L>>>14|B<<18)^(L>>>18|B<<14)^(L<<23|B>>>9),ve=(B>>>14|L<<18)^(B>>>18|L<<14)^(B<<23|L>>>9),ye=c[z],Ie=ye.high,Te=ye.low,Re=H+Se+((le=K+ve)>>>0<K>>>0?1:0),Ee=_e+me;H=j,K=F,j=V,F=Y,V=L,Y=B,L=U+(Re=(Re=(Re=Re+he+((le+=fe)>>>0<fe>>>0?1:0))+Ie+((le+=Te)>>>0<Te>>>0?1:0))+G+((le+=W)>>>0<W>>>0?1:0))+((B=x+le|0)>>>0<x>>>0?1:0)|0,U=D,x=N,D=P,N=M,P=k,M=O,k=Re+(ge+pe+(Ee>>>0<_e>>>0?1:0))+((O=le+Ee|0)>>>0<le>>>0?1:0)|0}p=i.low=p+O,i.high=f+k+(p>>>0<O>>>0?1:0),g=n.low=g+M,n.high=m+P+(g>>>0<M>>>0?1:0),S=o.low=S+N,o.high=_+D+(S>>>0<N>>>0?1:0),y=s.low=y+x,s.high=v+U+(y>>>0<x>>>0?1:0),T=a.low=T+B,a.high=I+L+(T>>>0<B>>>0?1:0),E=d.low=E+Y,d.high=R+V+(E>>>0<Y>>>0?1:0),C=l.low=C+F,l.high=b+j+(C>>>0<F>>>0?1:0),w=h.low=w+K,h.high=A+H+(w>>>0<K>>>0?1:0)},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,i=8*e.sigBytes;return t[i>>>5]|=128<<24-i%32,t[30+(i+128>>>10<<5)]=Math.floor(r/4294967296),t[31+(i+128>>>10<<5)]=r,e.sigBytes=4*t.length,this._process(),this._hash.toX32()},clone:function(){var e=t.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:32});e.SHA512=t._createHelper(d),e.HmacSHA512=t._createHmacHelper(d)}(),r.SHA512)}(mT)),mT.exports}var _T,ST={exports:{}};var vT,yT={exports:{}};function IT(){return vT||(vT=1,function(e,t){var r;e.exports=(r=jI(),KI(),function(e){var t=r,i=t.lib,n=i.WordArray,o=i.Hasher,s=t.x64.Word,a=t.algo,c=[],u=[],d=[];!function(){for(var e=1,t=0,r=0;r<24;r++){c[e+5*t]=(r+1)*(r+2)/2%64;var i=(2*e+3*t)%5;e=t%5,t=i}for(e=0;e<5;e++)for(t=0;t<5;t++)u[e+5*t]=t+(2*e+3*t)%5*5;for(var n=1,o=0;o<24;o++){for(var a=0,l=0,h=0;h<7;h++){if(1&n){var f=(1<<h)-1;f<32?l^=1<<f:a^=1<<f-32}128&n?n=n<<1^113:n<<=1}d[o]=s.create(a,l)}}();var l=[];!function(){for(var e=0;e<25;e++)l[e]=s.create()}();var h=a.SHA3=o.extend({cfg:o.cfg.extend({outputLength:512}),_doReset:function(){for(var e=this._state=[],t=0;t<25;t++)e[t]=new s.init;this.blockSize=(1600-2*this.cfg.outputLength)/32},_doProcessBlock:function(e,t){for(var r=this._state,i=this.blockSize/2,n=0;n<i;n++){var o=e[t+2*n],s=e[t+2*n+1];o=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),s=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),(w=r[n]).high^=s,w.low^=o}for(var a=0;a<24;a++){for(var h=0;h<5;h++){for(var f=0,p=0,m=0;m<5;m++)f^=(w=r[h+5*m]).high,p^=w.low;var g=l[h];g.high=f,g.low=p}for(h=0;h<5;h++){var _=l[(h+4)%5],S=l[(h+1)%5],v=S.high,y=S.low;for(f=_.high^(v<<1|y>>>31),p=_.low^(y<<1|v>>>31),m=0;m<5;m++)(w=r[h+5*m]).high^=f,w.low^=p}for(var I=1;I<25;I++){var T=(w=r[I]).high,R=w.low,E=c[I];E<32?(f=T<<E|R>>>32-E,p=R<<E|T>>>32-E):(f=R<<E-32|T>>>64-E,p=T<<E-32|R>>>64-E);var b=l[u[I]];b.high=f,b.low=p}var C=l[0],A=r[0];for(C.high=A.high,C.low=A.low,h=0;h<5;h++)for(m=0;m<5;m++){var w=r[I=h+5*m],k=l[I],O=l[(h+1)%5+5*m],P=l[(h+2)%5+5*m];w.high=k.high^~O.high&P.high,w.low=k.low^~O.low&P.low}w=r[0];var M=d[a];w.high^=M.high,w.low^=M.low}},_doFinalize:function(){var t=this._data,r=t.words;this._nDataBytes;var i=8*t.sigBytes,o=32*this.blockSize;r[i>>>5]|=1<<24-i%32,r[(e.ceil((i+1)/o)*o>>>5)-1]|=128,t.sigBytes=4*r.length,this._process();for(var s=this._state,a=this.cfg.outputLength/8,c=a/8,u=[],d=0;d<c;d++){var l=s[d],h=l.high,f=l.low;h=16711935&(h<<8|h>>>24)|4278255360&(h<<24|h>>>8),f=16711935&(f<<8|f>>>24)|4278255360&(f<<24|f>>>8),u.push(f),u.push(h)}return new n.init(u,a)},clone:function(){for(var e=o.clone.call(this),t=e._state=this._state.slice(0),r=0;r<25;r++)t[r]=t[r].clone();return e}});t.SHA3=o._createHelper(h),t.HmacSHA3=o._createHmacHelper(h)}(Math),r.SHA3)}(yT)),yT.exports}var TT,RT={exports:{}};var ET,bT={exports:{}};function CT(){return ET||(ET=1,function(e,t){var r;e.exports=(r=jI(),void function(){var e=r,t=e.lib.Base,i=e.enc.Utf8;e.algo.HMAC=t.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=i.parse(t));var r=e.blockSize,n=4*r;t.sigBytes>n&&(t=e.finalize(t)),t.clamp();for(var o=this._oKey=t.clone(),s=this._iKey=t.clone(),a=o.words,c=s.words,u=0;u<r;u++)a[u]^=1549556828,c[u]^=909522486;o.sigBytes=s.sigBytes=n,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,r=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(r))}})}())}(bT)),bT.exports}var AT,wT={exports:{}};var kT,OT={exports:{}};function PT(){return kT||(kT=1,function(e,t){var r;e.exports=(r=jI(),cT(),CT(),function(){var e=r,t=e.lib,i=t.Base,n=t.WordArray,o=e.algo,s=o.MD5,a=o.EvpKDF=i.extend({cfg:i.extend({keySize:4,hasher:s,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){for(var r,i=this.cfg,o=i.hasher.create(),s=n.create(),a=s.words,c=i.keySize,u=i.iterations;a.length<c;){r&&o.update(r),r=o.update(e).finalize(t),o.reset();for(var d=1;d<u;d++)r=o.finalize(r),o.reset();s.concat(r)}return s.sigBytes=4*c,s}});e.EvpKDF=function(e,t,r){return a.create(r).compute(e,t)}}(),r.EvpKDF)}(OT)),OT.exports}var MT,DT={exports:{}};function NT(){return MT||(MT=1,function(e,t){var r;e.exports=(r=jI(),PT(),void(r.lib.Cipher||function(e){var t=r,i=t.lib,n=i.Base,o=i.WordArray,s=i.BufferedBlockAlgorithm,a=t.enc;a.Utf8;var c=a.Base64,u=t.algo.EvpKDF,d=i.Cipher=s.extend({cfg:n.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,r){this.cfg=this.cfg.extend(r),this._xformMode=e,this._key=t,this.reset()},reset:function(){s.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function e(e){return"string"==typeof e?v:_}return function(t){return{encrypt:function(r,i,n){return e(i).encrypt(t,r,i,n)},decrypt:function(r,i,n){return e(i).decrypt(t,r,i,n)}}}}()});i.StreamCipher=d.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var l=t.mode={},h=i.BlockCipherMode=n.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t}}),f=l.CBC=function(){var t=h.extend();function r(t,r,i){var n,o=this._iv;o?(n=o,this._iv=e):n=this._prevBlock;for(var s=0;s<i;s++)t[r+s]^=n[s]}return t.Encryptor=t.extend({processBlock:function(e,t){var i=this._cipher,n=i.blockSize;r.call(this,e,t,n),i.encryptBlock(e,t),this._prevBlock=e.slice(t,t+n)}}),t.Decryptor=t.extend({processBlock:function(e,t){var i=this._cipher,n=i.blockSize,o=e.slice(t,t+n);i.decryptBlock(e,t),r.call(this,e,t,n),this._prevBlock=o}}),t}(),p=(t.pad={}).Pkcs7={pad:function(e,t){for(var r=4*t,i=r-e.sigBytes%r,n=i<<24|i<<16|i<<8|i,s=[],a=0;a<i;a+=4)s.push(n);var c=o.create(s,i);e.concat(c)},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t}};i.BlockCipher=d.extend({cfg:d.cfg.extend({mode:f,padding:p}),reset:function(){var e;d.reset.call(this);var t=this.cfg,r=t.iv,i=t.mode;this._xformMode==this._ENC_XFORM_MODE?e=i.createEncryptor:(e=i.createDecryptor,this._minBufferSize=1),this._mode&&this._mode.__creator==e?this._mode.init(this,r&&r.words):(this._mode=e.call(i,this,r&&r.words),this._mode.__creator=e)},_doProcessBlock:function(e,t){this._mode.processBlock(e,t)},_doFinalize:function(){var e,t=this.cfg.padding;return this._xformMode==this._ENC_XFORM_MODE?(t.pad(this._data,this.blockSize),e=this._process(!0)):(e=this._process(!0),t.unpad(e)),e},blockSize:4});var m=i.CipherParams=n.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}}),g=(t.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext,r=e.salt;return(r?o.create([1398893684,1701076831]).concat(r).concat(t):t).toString(c)},parse:function(e){var t,r=c.parse(e),i=r.words;return 1398893684==i[0]&&1701076831==i[1]&&(t=o.create(i.slice(2,4)),i.splice(0,4),r.sigBytes-=16),m.create({ciphertext:r,salt:t})}},_=i.SerializableCipher=n.extend({cfg:n.extend({format:g}),encrypt:function(e,t,r,i){i=this.cfg.extend(i);var n=e.createEncryptor(r,i),o=n.finalize(t),s=n.cfg;return m.create({ciphertext:o,key:r,iv:s.iv,algorithm:e,mode:s.mode,padding:s.padding,blockSize:e.blockSize,formatter:i.format})},decrypt:function(e,t,r,i){return i=this.cfg.extend(i),t=this._parse(t,i.format),e.createDecryptor(r,i).finalize(t.ciphertext)},_parse:function(e,t){return"string"==typeof e?t.parse(e,this):e}}),S=(t.kdf={}).OpenSSL={execute:function(e,t,r,i){i||(i=o.random(8));var n=u.create({keySize:t+r}).compute(e,i),s=o.create(n.words.slice(t),4*r);return n.sigBytes=4*t,m.create({key:n,iv:s,salt:i})}},v=i.PasswordBasedCipher=_.extend({cfg:_.cfg.extend({kdf:S}),encrypt:function(e,t,r,i){var n=(i=this.cfg.extend(i)).kdf.execute(r,e.keySize,e.ivSize);i.iv=n.iv;var o=_.encrypt.call(this,e,t,n.key,i);return o.mixIn(n),o},decrypt:function(e,t,r,i){i=this.cfg.extend(i),t=this._parse(t,i.format);var n=i.kdf.execute(r,e.keySize,e.ivSize,t.salt);return i.iv=n.iv,_.decrypt.call(this,e,t,n.key,i)}})}()))}(DT)),DT.exports}var UT,xT={exports:{}};function LT(){return UT||(UT=1,function(e,t){var r;e.exports=(r=jI(),NT(),r.mode.CFB=function(){var e=r.lib.BlockCipherMode.extend();function t(e,t,r,i){var n,o=this._iv;o?(n=o.slice(0),this._iv=void 0):n=this._prevBlock,i.encryptBlock(n,0);for(var s=0;s<r;s++)e[t+s]^=n[s]}return e.Encryptor=e.extend({processBlock:function(e,r){var i=this._cipher,n=i.blockSize;t.call(this,e,r,n,i),this._prevBlock=e.slice(r,r+n)}}),e.Decryptor=e.extend({processBlock:function(e,r){var i=this._cipher,n=i.blockSize,o=e.slice(r,r+n);t.call(this,e,r,n,i),this._prevBlock=o}}),e}(),r.mode.CFB)}(xT)),xT.exports}var BT,VT={exports:{}};function YT(){return BT||(BT=1,function(e,t){var r,i,n;e.exports=(n=jI(),NT(),n.mode.CTR=(r=n.lib.BlockCipherMode.extend(),i=r.Encryptor=r.extend({processBlock:function(e,t){var r=this._cipher,i=r.blockSize,n=this._iv,o=this._counter;n&&(o=this._counter=n.slice(0),this._iv=void 0);var s=o.slice(0);r.encryptBlock(s,0),o[i-1]=o[i-1]+1|0;for(var a=0;a<i;a++)e[t+a]^=s[a]}}),r.Decryptor=i,r),n.mode.CTR)}(VT)),VT.exports}var jT,FT={exports:{}};function HT(){return jT||(jT=1,function(e,t){var r;e.exports=(r=jI(),NT(),
/** @preserve
  			 * Counter block mode compatible with  Dr Brian Gladman fileenc.c
  			 * derived from CryptoJS.mode.CTR
  			 * Jan Hruby jhruby.web@gmail.com
  			 */
r.mode.CTRGladman=function(){var e=r.lib.BlockCipherMode.extend();function t(e){if(255==(e>>24&255)){var t=e>>16&255,r=e>>8&255,i=255&e;255===t?(t=0,255===r?(r=0,255===i?i=0:++i):++r):++t,e=0,e+=t<<16,e+=r<<8,e+=i}else e+=1<<24;return e}function i(e){return 0===(e[0]=t(e[0]))&&(e[1]=t(e[1])),e}var n=e.Encryptor=e.extend({processBlock:function(e,t){var r=this._cipher,n=r.blockSize,o=this._iv,s=this._counter;o&&(s=this._counter=o.slice(0),this._iv=void 0),i(s);var a=s.slice(0);r.encryptBlock(a,0);for(var c=0;c<n;c++)e[t+c]^=a[c]}});return e.Decryptor=n,e}(),r.mode.CTRGladman)}(FT)),FT.exports}var KT,zT={exports:{}};function WT(){return KT||(KT=1,function(e,t){var r,i,n;e.exports=(n=jI(),NT(),n.mode.OFB=(r=n.lib.BlockCipherMode.extend(),i=r.Encryptor=r.extend({processBlock:function(e,t){var r=this._cipher,i=r.blockSize,n=this._iv,o=this._keystream;n&&(o=this._keystream=n.slice(0),this._iv=void 0),r.encryptBlock(o,0);for(var s=0;s<i;s++)e[t+s]^=o[s]}}),r.Decryptor=i,r),n.mode.OFB)}(zT)),zT.exports}var GT,qT={exports:{}};var JT,XT={exports:{}};var QT,$T={exports:{}};var ZT,eR={exports:{}};var tR,rR={exports:{}};var iR,nR={exports:{}};var oR,sR={exports:{}};var aR,cR={exports:{}};var uR,dR={exports:{}};function lR(){return uR||(uR=1,function(e,t){var r;e.exports=(r=jI(),ZI(),oT(),PT(),NT(),function(){var e=r,t=e.lib,i=t.WordArray,n=t.BlockCipher,o=e.algo,s=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4],a=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32],c=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],u=[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}],d=[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679],l=o.DES=n.extend({_doReset:function(){for(var e=this._key.words,t=[],r=0;r<56;r++){var i=s[r]-1;t[r]=e[i>>>5]>>>31-i%32&1}for(var n=this._subKeys=[],o=0;o<16;o++){var u=n[o]=[],d=c[o];for(r=0;r<24;r++)u[r/6|0]|=t[(a[r]-1+d)%28]<<31-r%6,u[4+(r/6|0)]|=t[28+(a[r+24]-1+d)%28]<<31-r%6;for(u[0]=u[0]<<1|u[0]>>>31,r=1;r<7;r++)u[r]=u[r]>>>4*(r-1)+3;u[7]=u[7]<<5|u[7]>>>27}var l=this._invSubKeys=[];for(r=0;r<16;r++)l[r]=n[15-r]},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._subKeys)},decryptBlock:function(e,t){this._doCryptBlock(e,t,this._invSubKeys)},_doCryptBlock:function(e,t,r){this._lBlock=e[t],this._rBlock=e[t+1],h.call(this,4,252645135),h.call(this,16,65535),f.call(this,2,858993459),f.call(this,8,16711935),h.call(this,1,1431655765);for(var i=0;i<16;i++){for(var n=r[i],o=this._lBlock,s=this._rBlock,a=0,c=0;c<8;c++)a|=u[c][((s^n[c])&d[c])>>>0];this._lBlock=s,this._rBlock=o^a}var l=this._lBlock;this._lBlock=this._rBlock,this._rBlock=l,h.call(this,1,1431655765),f.call(this,8,16711935),f.call(this,2,858993459),h.call(this,16,65535),h.call(this,4,252645135),e[t]=this._lBlock,e[t+1]=this._rBlock},keySize:2,ivSize:2,blockSize:2});function h(e,t){var r=(this._lBlock>>>e^this._rBlock)&t;this._rBlock^=r,this._lBlock^=r<<e}function f(e,t){var r=(this._rBlock>>>e^this._lBlock)&t;this._lBlock^=r,this._rBlock^=r<<e}e.DES=n._createHelper(l);var p=o.TripleDES=n.extend({_doReset:function(){var e=this._key.words;if(2!==e.length&&4!==e.length&&e.length<6)throw new Error("Invalid key length - 3DES requires the key length to be 64, 128, 192 or >192.");var t=e.slice(0,2),r=e.length<4?e.slice(0,2):e.slice(2,4),n=e.length<6?e.slice(0,2):e.slice(4,6);this._des1=l.createEncryptor(i.create(t)),this._des2=l.createEncryptor(i.create(r)),this._des3=l.createEncryptor(i.create(n))},encryptBlock:function(e,t){this._des1.encryptBlock(e,t),this._des2.decryptBlock(e,t),this._des3.encryptBlock(e,t)},decryptBlock:function(e,t){this._des3.decryptBlock(e,t),this._des2.encryptBlock(e,t),this._des1.decryptBlock(e,t)},keySize:6,ivSize:2,blockSize:2});e.TripleDES=n._createHelper(p)}(),r.TripleDES)}(dR)),dR.exports}var hR,fR={exports:{}};var pR,mR={exports:{}};var gR,_R={exports:{}};!function(e,t){var r;e.exports=(r=jI(),KI(),GI(),XI(),ZI(),rT(),oT(),cT(),lT(),hT||(hT=1,function(e,t){var r;e.exports=(r=jI(),lT(),function(){var e=r,t=e.lib.WordArray,i=e.algo,n=i.SHA256,o=i.SHA224=n.extend({_doReset:function(){this._hash=new t.init([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428])},_doFinalize:function(){var e=n._doFinalize.call(this);return e.sigBytes-=4,e}});e.SHA224=n._createHelper(o),e.HmacSHA224=n._createHmacHelper(o)}(),r.SHA224)}(fT)),gT(),_T||(_T=1,function(e,t){var r;e.exports=(r=jI(),KI(),gT(),function(){var e=r,t=e.x64,i=t.Word,n=t.WordArray,o=e.algo,s=o.SHA512,a=o.SHA384=s.extend({_doReset:function(){this._hash=new n.init([new i.init(3418070365,3238371032),new i.init(1654270250,914150663),new i.init(2438529370,812702999),new i.init(355462360,4144912697),new i.init(1731405415,4290775857),new i.init(2394180231,1750603025),new i.init(3675008525,1694076839),new i.init(1203062813,3204075428)])},_doFinalize:function(){var e=s._doFinalize.call(this);return e.sigBytes-=16,e}});e.SHA384=s._createHelper(a),e.HmacSHA384=s._createHmacHelper(a)}(),r.SHA384)}(ST)),IT(),TT||(TT=1,function(e,t){var r;e.exports=(r=jI(),
/** @preserve
  			(c) 2012 by CÃ©dric Mesnil. All rights reserved.

  			Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

  			    - Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
  			    - Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.

  			THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  			*/
function(e){var t=r,i=t.lib,n=i.WordArray,o=i.Hasher,s=t.algo,a=n.create([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]),c=n.create([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),u=n.create([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),d=n.create([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),l=n.create([0,1518500249,1859775393,2400959708,2840853838]),h=n.create([1352829926,1548603684,1836072691,2053994217,0]),f=s.RIPEMD160=o.extend({_doReset:function(){this._hash=n.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var r=0;r<16;r++){var i=t+r,n=e[i];e[i]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8)}var o,s,f,y,I,T,R,E,b,C,A,w=this._hash.words,k=l.words,O=h.words,P=a.words,M=c.words,D=u.words,N=d.words;for(T=o=w[0],R=s=w[1],E=f=w[2],b=y=w[3],C=I=w[4],r=0;r<80;r+=1)A=o+e[t+P[r]]|0,A+=r<16?p(s,f,y)+k[0]:r<32?m(s,f,y)+k[1]:r<48?g(s,f,y)+k[2]:r<64?_(s,f,y)+k[3]:S(s,f,y)+k[4],A=(A=v(A|=0,D[r]))+I|0,o=I,I=y,y=v(f,10),f=s,s=A,A=T+e[t+M[r]]|0,A+=r<16?S(R,E,b)+O[0]:r<32?_(R,E,b)+O[1]:r<48?g(R,E,b)+O[2]:r<64?m(R,E,b)+O[3]:p(R,E,b)+O[4],A=(A=v(A|=0,N[r]))+C|0,T=C,C=b,b=v(E,10),E=R,R=A;A=w[1]+f+b|0,w[1]=w[2]+y+C|0,w[2]=w[3]+I+T|0,w[3]=w[4]+o+R|0,w[4]=w[0]+s+E|0,w[0]=A},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,i=8*e.sigBytes;t[i>>>5]|=128<<24-i%32,t[14+(i+64>>>9<<4)]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8),e.sigBytes=4*(t.length+1),this._process();for(var n=this._hash,o=n.words,s=0;s<5;s++){var a=o[s];o[s]=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8)}return n},clone:function(){var e=o.clone.call(this);return e._hash=this._hash.clone(),e}});function p(e,t,r){return e^t^r}function m(e,t,r){return e&t|~e&r}function g(e,t,r){return(e|~t)^r}function _(e,t,r){return e&r|t&~r}function S(e,t,r){return e^(t|~r)}function v(e,t){return e<<t|e>>>32-t}t.RIPEMD160=o._createHelper(f),t.HmacRIPEMD160=o._createHmacHelper(f)}(),r.RIPEMD160)}(RT)),CT(),AT||(AT=1,function(e,t){var r;e.exports=(r=jI(),cT(),CT(),function(){var e=r,t=e.lib,i=t.Base,n=t.WordArray,o=e.algo,s=o.SHA1,a=o.HMAC,c=o.PBKDF2=i.extend({cfg:i.extend({keySize:4,hasher:s,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){for(var r=this.cfg,i=a.create(r.hasher,e),o=n.create(),s=n.create([1]),c=o.words,u=s.words,d=r.keySize,l=r.iterations;c.length<d;){var h=i.update(t).finalize(s);i.reset();for(var f=h.words,p=f.length,m=h,g=1;g<l;g++){m=i.finalize(m),i.reset();for(var _=m.words,S=0;S<p;S++)f[S]^=_[S]}o.concat(h),u[0]++}return o.sigBytes=4*d,o}});e.PBKDF2=function(e,t,r){return c.create(r).compute(e,t)}}(),r.PBKDF2)}(wT)),PT(),NT(),LT(),YT(),HT(),WT(),GT||(GT=1,function(e,t){var r,i;e.exports=(i=jI(),NT(),i.mode.ECB=((r=i.lib.BlockCipherMode.extend()).Encryptor=r.extend({processBlock:function(e,t){this._cipher.encryptBlock(e,t)}}),r.Decryptor=r.extend({processBlock:function(e,t){this._cipher.decryptBlock(e,t)}}),r),i.mode.ECB)}(qT)),JT||(JT=1,function(e,t){var r;e.exports=(r=jI(),NT(),r.pad.AnsiX923={pad:function(e,t){var r=e.sigBytes,i=4*t,n=i-r%i,o=r+n-1;e.clamp(),e.words[o>>>2]|=n<<24-o%4*8,e.sigBytes+=n},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t}},r.pad.Ansix923)}(XT)),QT||(QT=1,function(e,t){var r;e.exports=(r=jI(),NT(),r.pad.Iso10126={pad:function(e,t){var i=4*t,n=i-e.sigBytes%i;e.concat(r.lib.WordArray.random(n-1)).concat(r.lib.WordArray.create([n<<24],1))},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t}},r.pad.Iso10126)}($T)),ZT||(ZT=1,function(e,t){var r;e.exports=(r=jI(),NT(),r.pad.Iso97971={pad:function(e,t){e.concat(r.lib.WordArray.create([2147483648],1)),r.pad.ZeroPadding.pad(e,t)},unpad:function(e){r.pad.ZeroPadding.unpad(e),e.sigBytes--}},r.pad.Iso97971)}(eR)),tR||(tR=1,function(e,t){var r;e.exports=(r=jI(),NT(),r.pad.ZeroPadding={pad:function(e,t){var r=4*t;e.clamp(),e.sigBytes+=r-(e.sigBytes%r||r)},unpad:function(e){var t=e.words,r=e.sigBytes-1;for(r=e.sigBytes-1;r>=0;r--)if(t[r>>>2]>>>24-r%4*8&255){e.sigBytes=r+1;break}}},r.pad.ZeroPadding)}(rR)),iR||(iR=1,function(e,t){var r;e.exports=(r=jI(),NT(),r.pad.NoPadding={pad:function(){},unpad:function(){}},r.pad.NoPadding)}(nR)),oR||(oR=1,function(e,t){var r;e.exports=(r=jI(),NT(),function(e){var t=r,i=t.lib.CipherParams,n=t.enc.Hex;t.format.Hex={stringify:function(e){return e.ciphertext.toString(n)},parse:function(e){var t=n.parse(e);return i.create({ciphertext:t})}}}(),r.format.Hex)}(sR)),aR||(aR=1,function(e,t){var r;e.exports=(r=jI(),ZI(),oT(),PT(),NT(),function(){var e=r,t=e.lib.BlockCipher,i=e.algo,n=[],o=[],s=[],a=[],c=[],u=[],d=[],l=[],h=[],f=[];!function(){for(var e=[],t=0;t<256;t++)e[t]=t<128?t<<1:t<<1^283;var r=0,i=0;for(t=0;t<256;t++){var p=i^i<<1^i<<2^i<<3^i<<4;p=p>>>8^255&p^99,n[r]=p,o[p]=r;var m=e[r],g=e[m],_=e[g],S=257*e[p]^16843008*p;s[r]=S<<24|S>>>8,a[r]=S<<16|S>>>16,c[r]=S<<8|S>>>24,u[r]=S,S=16843009*_^65537*g^257*m^16843008*r,d[p]=S<<24|S>>>8,l[p]=S<<16|S>>>16,h[p]=S<<8|S>>>24,f[p]=S,r?(r=m^e[e[e[_^m]]],i^=e[e[i]]):r=i=1}}();var p=[0,1,2,4,8,16,32,64,128,27,54],m=i.AES=t.extend({_doReset:function(){if(!this._nRounds||this._keyPriorReset!==this._key){for(var e=this._keyPriorReset=this._key,t=e.words,r=e.sigBytes/4,i=4*((this._nRounds=r+6)+1),o=this._keySchedule=[],s=0;s<i;s++)s<r?o[s]=t[s]:(u=o[s-1],s%r?r>6&&s%r==4&&(u=n[u>>>24]<<24|n[u>>>16&255]<<16|n[u>>>8&255]<<8|n[255&u]):(u=n[(u=u<<8|u>>>24)>>>24]<<24|n[u>>>16&255]<<16|n[u>>>8&255]<<8|n[255&u],u^=p[s/r|0]<<24),o[s]=o[s-r]^u);for(var a=this._invKeySchedule=[],c=0;c<i;c++){if(s=i-c,c%4)var u=o[s];else u=o[s-4];a[c]=c<4||s<=4?u:d[n[u>>>24]]^l[n[u>>>16&255]]^h[n[u>>>8&255]]^f[n[255&u]]}}},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._keySchedule,s,a,c,u,n)},decryptBlock:function(e,t){var r=e[t+1];e[t+1]=e[t+3],e[t+3]=r,this._doCryptBlock(e,t,this._invKeySchedule,d,l,h,f,o),r=e[t+1],e[t+1]=e[t+3],e[t+3]=r},_doCryptBlock:function(e,t,r,i,n,o,s,a){for(var c=this._nRounds,u=e[t]^r[0],d=e[t+1]^r[1],l=e[t+2]^r[2],h=e[t+3]^r[3],f=4,p=1;p<c;p++){var m=i[u>>>24]^n[d>>>16&255]^o[l>>>8&255]^s[255&h]^r[f++],g=i[d>>>24]^n[l>>>16&255]^o[h>>>8&255]^s[255&u]^r[f++],_=i[l>>>24]^n[h>>>16&255]^o[u>>>8&255]^s[255&d]^r[f++],S=i[h>>>24]^n[u>>>16&255]^o[d>>>8&255]^s[255&l]^r[f++];u=m,d=g,l=_,h=S}m=(a[u>>>24]<<24|a[d>>>16&255]<<16|a[l>>>8&255]<<8|a[255&h])^r[f++],g=(a[d>>>24]<<24|a[l>>>16&255]<<16|a[h>>>8&255]<<8|a[255&u])^r[f++],_=(a[l>>>24]<<24|a[h>>>16&255]<<16|a[u>>>8&255]<<8|a[255&d])^r[f++],S=(a[h>>>24]<<24|a[u>>>16&255]<<16|a[d>>>8&255]<<8|a[255&l])^r[f++],e[t]=m,e[t+1]=g,e[t+2]=_,e[t+3]=S},keySize:8});e.AES=t._createHelper(m)}(),r.AES)}(cR)),lR(),hR||(hR=1,function(e,t){var r;e.exports=(r=jI(),ZI(),oT(),PT(),NT(),function(){var e=r,t=e.lib.StreamCipher,i=e.algo,n=i.RC4=t.extend({_doReset:function(){for(var e=this._key,t=e.words,r=e.sigBytes,i=this._S=[],n=0;n<256;n++)i[n]=n;n=0;for(var o=0;n<256;n++){var s=n%r,a=t[s>>>2]>>>24-s%4*8&255;o=(o+i[n]+a)%256;var c=i[n];i[n]=i[o],i[o]=c}this._i=this._j=0},_doProcessBlock:function(e,t){e[t]^=o.call(this)},keySize:8,ivSize:0});function o(){for(var e=this._S,t=this._i,r=this._j,i=0,n=0;n<4;n++){r=(r+e[t=(t+1)%256])%256;var o=e[t];e[t]=e[r],e[r]=o,i|=e[(e[t]+e[r])%256]<<24-8*n}return this._i=t,this._j=r,i}e.RC4=t._createHelper(n);var s=i.RC4Drop=n.extend({cfg:n.cfg.extend({drop:192}),_doReset:function(){n._doReset.call(this);for(var e=this.cfg.drop;e>0;e--)o.call(this)}});e.RC4Drop=t._createHelper(s)}(),r.RC4)}(fR)),pR||(pR=1,function(e,t){var r;e.exports=(r=jI(),ZI(),oT(),PT(),NT(),function(){var e=r,t=e.lib.StreamCipher,i=e.algo,n=[],o=[],s=[],a=i.Rabbit=t.extend({_doReset:function(){for(var e=this._key.words,t=this.cfg.iv,r=0;r<4;r++)e[r]=16711935&(e[r]<<8|e[r]>>>24)|4278255360&(e[r]<<24|e[r]>>>8);var i=this._X=[e[0],e[3]<<16|e[2]>>>16,e[1],e[0]<<16|e[3]>>>16,e[2],e[1]<<16|e[0]>>>16,e[3],e[2]<<16|e[1]>>>16],n=this._C=[e[2]<<16|e[2]>>>16,4294901760&e[0]|65535&e[1],e[3]<<16|e[3]>>>16,4294901760&e[1]|65535&e[2],e[0]<<16|e[0]>>>16,4294901760&e[2]|65535&e[3],e[1]<<16|e[1]>>>16,4294901760&e[3]|65535&e[0]];for(this._b=0,r=0;r<4;r++)c.call(this);for(r=0;r<8;r++)n[r]^=i[r+4&7];if(t){var o=t.words,s=o[0],a=o[1],u=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),d=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8),l=u>>>16|4294901760&d,h=d<<16|65535&u;for(n[0]^=u,n[1]^=l,n[2]^=d,n[3]^=h,n[4]^=u,n[5]^=l,n[6]^=d,n[7]^=h,r=0;r<4;r++)c.call(this)}},_doProcessBlock:function(e,t){var r=this._X;c.call(this),n[0]=r[0]^r[5]>>>16^r[3]<<16,n[1]=r[2]^r[7]>>>16^r[5]<<16,n[2]=r[4]^r[1]>>>16^r[7]<<16,n[3]=r[6]^r[3]>>>16^r[1]<<16;for(var i=0;i<4;i++)n[i]=16711935&(n[i]<<8|n[i]>>>24)|4278255360&(n[i]<<24|n[i]>>>8),e[t+i]^=n[i]},blockSize:4,ivSize:2});function c(){for(var e=this._X,t=this._C,r=0;r<8;r++)o[r]=t[r];for(t[0]=t[0]+1295307597+this._b|0,t[1]=t[1]+3545052371+(t[0]>>>0<o[0]>>>0?1:0)|0,t[2]=t[2]+886263092+(t[1]>>>0<o[1]>>>0?1:0)|0,t[3]=t[3]+1295307597+(t[2]>>>0<o[2]>>>0?1:0)|0,t[4]=t[4]+3545052371+(t[3]>>>0<o[3]>>>0?1:0)|0,t[5]=t[5]+886263092+(t[4]>>>0<o[4]>>>0?1:0)|0,t[6]=t[6]+1295307597+(t[5]>>>0<o[5]>>>0?1:0)|0,t[7]=t[7]+3545052371+(t[6]>>>0<o[6]>>>0?1:0)|0,this._b=t[7]>>>0<o[7]>>>0?1:0,r=0;r<8;r++){var i=e[r]+t[r],n=65535&i,a=i>>>16,c=((n*n>>>17)+n*a>>>15)+a*a,u=((4294901760&i)*i|0)+((65535&i)*i|0);s[r]=c^u}e[0]=s[0]+(s[7]<<16|s[7]>>>16)+(s[6]<<16|s[6]>>>16)|0,e[1]=s[1]+(s[0]<<8|s[0]>>>24)+s[7]|0,e[2]=s[2]+(s[1]<<16|s[1]>>>16)+(s[0]<<16|s[0]>>>16)|0,e[3]=s[3]+(s[2]<<8|s[2]>>>24)+s[1]|0,e[4]=s[4]+(s[3]<<16|s[3]>>>16)+(s[2]<<16|s[2]>>>16)|0,e[5]=s[5]+(s[4]<<8|s[4]>>>24)+s[3]|0,e[6]=s[6]+(s[5]<<16|s[5]>>>16)+(s[4]<<16|s[4]>>>16)|0,e[7]=s[7]+(s[6]<<8|s[6]>>>24)+s[5]|0}e.Rabbit=t._createHelper(a)}(),r.Rabbit)}(mR)),gR||(gR=1,function(e,t){var r;e.exports=(r=jI(),ZI(),oT(),PT(),NT(),function(){var e=r,t=e.lib.StreamCipher,i=e.algo,n=[],o=[],s=[],a=i.RabbitLegacy=t.extend({_doReset:function(){var e=this._key.words,t=this.cfg.iv,r=this._X=[e[0],e[3]<<16|e[2]>>>16,e[1],e[0]<<16|e[3]>>>16,e[2],e[1]<<16|e[0]>>>16,e[3],e[2]<<16|e[1]>>>16],i=this._C=[e[2]<<16|e[2]>>>16,4294901760&e[0]|65535&e[1],e[3]<<16|e[3]>>>16,4294901760&e[1]|65535&e[2],e[0]<<16|e[0]>>>16,4294901760&e[2]|65535&e[3],e[1]<<16|e[1]>>>16,4294901760&e[3]|65535&e[0]];this._b=0;for(var n=0;n<4;n++)c.call(this);for(n=0;n<8;n++)i[n]^=r[n+4&7];if(t){var o=t.words,s=o[0],a=o[1],u=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),d=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8),l=u>>>16|4294901760&d,h=d<<16|65535&u;for(i[0]^=u,i[1]^=l,i[2]^=d,i[3]^=h,i[4]^=u,i[5]^=l,i[6]^=d,i[7]^=h,n=0;n<4;n++)c.call(this)}},_doProcessBlock:function(e,t){var r=this._X;c.call(this),n[0]=r[0]^r[5]>>>16^r[3]<<16,n[1]=r[2]^r[7]>>>16^r[5]<<16,n[2]=r[4]^r[1]>>>16^r[7]<<16,n[3]=r[6]^r[3]>>>16^r[1]<<16;for(var i=0;i<4;i++)n[i]=16711935&(n[i]<<8|n[i]>>>24)|4278255360&(n[i]<<24|n[i]>>>8),e[t+i]^=n[i]},blockSize:4,ivSize:2});function c(){for(var e=this._X,t=this._C,r=0;r<8;r++)o[r]=t[r];for(t[0]=t[0]+1295307597+this._b|0,t[1]=t[1]+3545052371+(t[0]>>>0<o[0]>>>0?1:0)|0,t[2]=t[2]+886263092+(t[1]>>>0<o[1]>>>0?1:0)|0,t[3]=t[3]+1295307597+(t[2]>>>0<o[2]>>>0?1:0)|0,t[4]=t[4]+3545052371+(t[3]>>>0<o[3]>>>0?1:0)|0,t[5]=t[5]+886263092+(t[4]>>>0<o[4]>>>0?1:0)|0,t[6]=t[6]+1295307597+(t[5]>>>0<o[5]>>>0?1:0)|0,t[7]=t[7]+3545052371+(t[6]>>>0<o[6]>>>0?1:0)|0,this._b=t[7]>>>0<o[7]>>>0?1:0,r=0;r<8;r++){var i=e[r]+t[r],n=65535&i,a=i>>>16,c=((n*n>>>17)+n*a>>>15)+a*a,u=((4294901760&i)*i|0)+((65535&i)*i|0);s[r]=c^u}e[0]=s[0]+(s[7]<<16|s[7]>>>16)+(s[6]<<16|s[6]>>>16)|0,e[1]=s[1]+(s[0]<<8|s[0]>>>24)+s[7]|0,e[2]=s[2]+(s[1]<<16|s[1]>>>16)+(s[0]<<16|s[0]>>>16)|0,e[3]=s[3]+(s[2]<<8|s[2]>>>24)+s[1]|0,e[4]=s[4]+(s[3]<<16|s[3]>>>16)+(s[2]<<16|s[2]>>>16)|0,e[5]=s[5]+(s[4]<<8|s[4]>>>24)+s[3]|0,e[6]=s[6]+(s[5]<<16|s[5]>>>16)+(s[4]<<16|s[4]>>>16)|0,e[7]=s[7]+(s[6]<<8|s[6]>>>24)+s[5]|0}e.RabbitLegacy=t._createHelper(a)}(),r.RabbitLegacy)}(_R)),r)}(BI);const SR=window.crypto||window.webkitCrypto||window.mozCrypto||window.oCrypto||window.msCrypto,vR={Mac:/(mac os x)\s+([\w_]+)/,Windows:/(windows nt)\s+([\w.]+)/,Ios:/(i(?:pad|phone|pod)).*cpu(?: i(?:pad|phone|pod))? os (\d+(?:[.|_]\d+)+)/,Android:/(android)\s+([\d.]+)/,Ipad:/(ipad).*os\s([\d_]+)/,Iphone:/(iphone\sos)\s([\d_]+)/,Linux:/(x11;)\s(linux)\s(x86_64|mips64|aarch64)/,ChromiumOS:/(x11;)\s(cros)\s(x86_64|mips64|aarch64)\s([\w.]+)\)/},yR=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","-","_"];let IR,TR;const RR="CommonUtil";class ER{constructor(){this.uuidCount=0,this.timeDiff=0,this.platform=(()=>{const e=navigator.userAgent.toLowerCase(),t=e.match(/(micromessenger)\/([\w.()]+)/i),r=t?"-WeChat".concat(t[2]):"";for(const i in vR)if(Object.prototype.hasOwnProperty.call(vR,i)){const t=e.match(vR[i]);if(t)return TR="Ios"===i?t[2].replace(/_/g,"."):"Linux"===i?t[3]:"ChromiumOS"===i?t[4]:t[2],IR=["Ios","Ipad","Iphone"].includes(i)?"IOS":i,i+TR+r}return"unknown"})(),this.userAgent=(()=>{const e=navigator.userAgent.match(/(chrome|safari|firefox|microMessenger)\/(\d+(\.\d+)*)/i);return e?"".concat(e[1],"-").concat(e[2]):""})()}async sleep(e){return new Promise((t=>{const r=setTimeout((()=>{clearTimeout(r),t()}),e)}))}getDeviceID(){return this.deviceID||(this.deviceID=this.generateStandardUuid()),this.deviceID}generateStandardUuid(){let e;if(SR&&(e="function"==typeof SR.randomUUID?SR.randomUUID():""),!e){let t=(new Date).getTime();window.performance&&"function"==typeof window.performance.now&&(t+=performance.now()),e="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx".replace(/[x]/g,(()=>{const e=(t+16*this.getRandom())%16|0;return t=Math.floor(t/16),e.toString(16)}))}return e}static getRandomArray(e){const t=new Uint8Array(e);return SR&&SR.getRandomValues(t),t}getRandom(){return ER.getRandomArray(1)[0]/256}getRandomUint32(){const e=ER.getRandomArray(4);return new DataView(e.buffer).getUint32(0)}generateUuid(e){let t="";const r=ER.getRandomArray(33),i=e?22:33;for(let s=0;s<i;s++)t+=yR[Math.round(r[s]%64)];let n="";for(let s=0;s<33-i;s++)n+=yR[63&e],e>>=6;let o=this.uuidCount.toString(16);for(let s=3-o.length;s>0;s--)o="0"+o;return this.uuidCount>4094?this.uuidCount=0:this.uuidCount++,"".concat(t).concat(n).concat(o)}generateRandomId(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:62,r="";const i=ER.getRandomArray(e);for(let n=0;n<e;n++)r+=yR[Math.round(i[n]%t)];return r}getPlatform(){return this.platform}getSystemType(){return IR}getRomVersion(){return TR}getUserAgent(){return this.userAgent}getNetworkType(){const e=navigator.userAgent.match(/NetType\/\w+/),t=e?e[0].toLowerCase().replace("nettype/",""):"";return["wifi","4g","3g","3gnet","2g"].includes(t)?t.toUpperCase():"other"}syncLocalTime(e){try{if(e){console.debug(RR,"syncLocalTime, serverTime: ".concat(e));const t=new Date(e).getTime();this.timeDiff=(new Date).getTime()-t,console.debug(RR,"syncLocalTime, timeDiff: ".concat(this.timeDiff))}}catch(kD){console.error(RR,"syncLocalTime error: ".concat(kD))}}getCurrentTimestamp(){return(new Date).getTime()-this.timeDiff}getCurrentTime(){const e=new Date(this.getCurrentTimestamp()),t=e.getFullYear(),r=e.getMonth()+1,i=r<10?"0".concat(r):r,n=e.getDate(),o=n<10?"0".concat(n):n,s=e.getHours(),a=s<10?"0".concat(s):s,c=e.getMinutes(),u=c<10?"0".concat(c):c,d=e.getSeconds(),l=d<10?"0".concat(d):d,h=e.getMilliseconds(),f="".concat(h+1e3).substring(1),p=e.getTimezoneOffset()/60,m=p>=0?p:-p,g=(p<=0?"+":"-")+(m<10?"0".concat(m):"".concat(m))+":00";return{year:"".concat(t),month:"".concat(i),day:"".concat(o),hour:"".concat(a),min:"".concat(u),sec:"".concat(l),millsec:f,zoneOff:g}}adjustTimeByOffset(e){return e-this.timeDiff}convertString2Timestamp(e){return new Date(e).getTime()}generateStreamId(){return"2xxxxxxx-8xxx-xxxx-yxxx-xxxx".replace(/[xy]/g,(e=>{const t=16*this.getRandom()|0;return("x"==e?t:3&t|8).toString(16)}))}isWKWebview(){return/I.*-WeChat.*/gi.test(this.platform)}isAppleDevice(){return/^(Mac|I).*/gi.test(this.platform)}isMobileDevice(){return!/^(Mac|Windows).*/gi.test(this.platform)}isMobileWeChatBrowser(){return this.isMobileDevice()&&/.*MicroMessenger.*/gi.test(navigator.userAgent)}isSupportConstraints(e){var t;return!!(null===(t=navigator.mediaDevices)||void 0===t?void 0:t.getSupportedConstraints())[e]}async calculateSha256(e){return new Promise((t=>{const r=new FileReader;r.onloadend=e=>{if(e.target.readyState==FileReader.DONE){const r=BI.exports.lib.WordArray.create(e.target.result),i=BI.exports.SHA256(r).toString();t(i)}},r.readAsArrayBuffer(e)}))}getValue(e,t){return e||t}shieldIpAddress(e){return e?e.replace(/\b(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])\.(?:25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])\.(?:25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])\b/g,"$1.*.*.$2"):null}shieldUrlParameters(e){if(!e)return e;const t=e.match(/([^?|=|&]+)=([^&]+)/g);return t&&t.forEach((t=>{const r=/([^=]*)=(.*)/g.exec(t);e=e.replace(t,"".concat(r[1],"=").concat(this.secretString(r[2])))})),e}shieldNickname(e){if(!e)return e;let t="";for(let r=0;r<e.length;r++)t=r%3==0?"".concat(t,"*"):"".concat(t).concat(e.charAt(r));return t}secretString(e){if(!e)return null;const t="********",r=Math.ceil(e.length/3),i=Math.ceil((e.length-r)/2);return 0===i?"".concat(e.substr(0,r)).concat(t):"".concat(e.substr(0,r)).concat(t).concat(e.substr(-i,i))}}const bR=new ER;function CR(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function AR(e){for(var r=1;r<arguments.length;r++){var i=null!=arguments[r]?arguments[r]:{};r%2?CR(Object(i),!0).forEach((function(r){t(e,r,i[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):CR(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const wR=Symbol("hrtc_".concat(bR.getCurrentTimestamp())),kR=new Map,OR=new Map;class PR{constructor(){t(this,"logBuffer",[]),t(this,"logBufferSize",5e3)}error(e,t,r){this.log("error",e,t,r)}warn(e,t,r){this.log("warn",e,t,r)}info(e,t,r){this.log("info",e,t,r)}debug(e,t,r){this.log("debug",e,t,r)}log(e,t,r,i){OR.forEach(((e,t)=>{r.includes(t)&&(r=r.replace(e.pattern,e.newString))}));const n=bR.getCurrentTime(),o=["".concat(n.year,"-").concat(n.month,"-").concat(n.day," ").concat(n.hour,":").concat(n.min,":").concat(n.sec,".").concat(n.millsec),e];Object.entries(AR(AR({},i),{},{tag:t,msg:r})).forEach((e=>{let[t,r]=e;"string"==typeof r&&o.push("[".concat(t,": ").concat(r,"]"))}));const s=o.join(" ");for(this.logBuffer.push(s);this.logBuffer.length>=this.logBufferSize;)this.logBuffer.shift();const a=["".concat(n.year,"-").concat(n.month,"-").concat(n.day," ").concat(n.hour,":").concat(n.min,":").concat(n.sec,".").concat(n.millsec)];Om.indexOf(MR.logLevel)>=Om.indexOf(e)&&console[e](a+" [HRTC] "+"[".concat(e,"] [").concat(t,"] [").concat(r,"]"))}clearLogs(){this.logBuffer=[]}setLogBufferSize(e){this.logBufferSize=e}getLogBufferSize(){return this.logBufferSize}getLogBuffer(){return this.logBuffer}}class MR{static getLogger(e){const t=e||wR;if(!kR.has(t)){const e=new PR;return kR.set(t,e),e}return kR.get(t)}static setAllLogLevel(e){if(!(Om.indexOf(e)>=0))throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"log level is invalid");MR.logLevel=e}static addPrivacyString(e){if(!e)return;if(OR.has(e))return;const t=bR.secretString(e);if(!t)return;const r={pattern:new RegExp("\\b"+e+"\\b","g"),newString:t};OR.set(e,r)}static async getLogFile(e,t){const r=e.logger,i=bR.getCurrentTime(),n="".concat(i.year,"-").concat(i.month,"-").concat(i.day,"T").concat(i.hour,":").concat(i.min,":").concat(i.sec).concat(i.zoneOff),o="".concat(i.year,"-").concat(i.month,"-").concat(i.day,"T").concat(i.hour,".").concat(i.min,".").concat(i.sec).concat(i.zoneOff.replace(":",".")),s=MR.getLogger(),a=r.getLogBuffer(),c=s.getLogBuffer();if(0===a.length&&0===c.length)return null;const u=e.getInfo(),d="".concat(u.userName,"_").concat(u.userId,"##").concat(u.domain,"##").concat(u.appId,"##").concat(o),l=bR.getDeviceID(),h=encodeURIComponent("".concat(t,"##").concat(l,"##").concat(u.appId,"##").concat(n)),f=new zg,p=f.folder("".concat(u.userName,"_").concat(u.userId,"##").concat(u.roomId,"##").concat(u.domain,"##").concat(u.appId));p.file("".concat(d,".log"),"".concat(a.join("\n"))),p.file("hrtc##".concat(n,".log"),"".concat(c.join("\n")));const m=await f.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}});return{sha256:await bR.calculateSha256(m),length:m.size,content:m,urlFileNameEncode:h}}}t(MR,"logLevel",Om[3]);var DR=Zi,NR=Ss,UR=c,xR=G,LR=j,BR=eo,VR=Fc,YR=Jr,jR=NR&&NR.prototype;if(DR({target:"Promise",proto:!0,real:!0,forced:!!NR&&UR((function(){jR.finally.call({then:function(){}},(function(){}))}))},{finally:function(e){var t=BR(this,xR("Promise")),r=LR(e);return this.then(r?function(r){return VR(t,e()).then((function(){return r}))}:e,r?function(r){return VR(t,e()).then((function(){throw r}))}:e)}}),LR(NR)){var FR=xR("Promise").prototype.finally;jR.finally!==FR&&YR(jR,"finally",FR,{unsafe:!0})}var HR=f,KR=_e,zR=Pt,WR=function(){for(var e=zR(this),t=KR(e.add),r=0,i=arguments.length;r<i;r++)HR(t,e,arguments[r]);return e};Zi({target:"Set",proto:!0,real:!0,forced:!0},{addAll:WR}),Zi({target:"Set",proto:!0,real:!0,forced:!0},{deleteAll:Zd});var GR=G,qR=f,JR=_e,XR=Pt,QR=eo,$R=lc;Zi({target:"Set",proto:!0,real:!0,forced:!0},{difference:function(e){var t=XR(this),r=new(QR(t,GR("Set")))(t),i=JR(r.delete);return $R(e,(function(e){qR(i,r,e)})),r}});var ZR=f,eE=function(e){return ZR(Set.prototype.values,e)},tE=Pt,rE=uo,iE=eE,nE=lc;Zi({target:"Set",proto:!0,real:!0,forced:!0},{every:function(e){var t=tE(this),r=iE(t),i=rE(e,arguments.length>1?arguments[1]:void 0);return!nE(r,(function(e,r){if(!i(e,e,t))return r()}),{IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var oE=G,sE=f,aE=_e,cE=Pt,uE=uo,dE=eo,lE=eE,hE=lc;Zi({target:"Set",proto:!0,real:!0,forced:!0},{filter:function(e){var t=cE(this),r=lE(t),i=uE(e,arguments.length>1?arguments[1]:void 0),n=new(dE(t,oE("Set"))),o=aE(n.add);return hE(r,(function(e){i(e,e,t)&&sE(o,n,e)}),{IS_ITERATOR:!0}),n}});var fE=Pt,pE=uo,mE=eE,gE=lc;Zi({target:"Set",proto:!0,real:!0,forced:!0},{find:function(e){var t=fE(this),r=mE(t),i=pE(e,arguments.length>1?arguments[1]:void 0);return gE(r,(function(e,r){if(i(e,e,t))return r(e)}),{IS_ITERATOR:!0,INTERRUPTED:!0}).result}});var _E=G,SE=f,vE=_e,yE=Pt,IE=eo,TE=lc;Zi({target:"Set",proto:!0,real:!0,forced:!0},{intersection:function(e){var t=yE(this),r=new(IE(t,_E("Set"))),i=vE(t.has),n=vE(r.add);return TE(e,(function(e){SE(i,t,e)&&SE(n,r,e)})),r}});var RE=f,EE=_e,bE=Pt,CE=lc;Zi({target:"Set",proto:!0,real:!0,forced:!0},{isDisjointFrom:function(e){var t=bE(this),r=EE(t.has);return!CE(e,(function(e,i){if(!0===RE(r,t,e))return i()}),{INTERRUPTED:!0}).stopped}});var AE=G,wE=f,kE=_e,OE=j,PE=Pt,ME=qa,DE=lc;Zi({target:"Set",proto:!0,real:!0,forced:!0},{isSubsetOf:function(e){var t=ME(this),r=PE(e),i=r.has;return OE(i)||(r=new(AE("Set"))(e),i=kE(r.has)),!DE(t,(function(e,t){if(!1===wE(i,r,e))return t()}),{IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var NE=f,UE=_e,xE=Pt,LE=lc;Zi({target:"Set",proto:!0,real:!0,forced:!0},{isSupersetOf:function(e){var t=xE(this),r=UE(t.has);return!LE(e,(function(e,i){if(!1===NE(r,t,e))return i()}),{INTERRUPTED:!0}).stopped}});var BE=Zi,VE=Pt,YE=Qc,jE=eE,FE=lc,HE=C([].join),KE=[].push;BE({target:"Set",proto:!0,real:!0,forced:!0},{join:function(e){var t=VE(this),r=jE(t),i=void 0===e?",":YE(e),n=[];return FE(r,KE,{that:n,IS_ITERATOR:!0}),HE(n,i)}});var zE=G,WE=uo,GE=f,qE=_e,JE=Pt,XE=eo,QE=eE,$E=lc;Zi({target:"Set",proto:!0,real:!0,forced:!0},{map:function(e){var t=JE(this),r=QE(t),i=WE(e,arguments.length>1?arguments[1]:void 0),n=new(XE(t,zE("Set"))),o=qE(n.add);return $E(r,(function(e){GE(o,n,i(e,e,t))}),{IS_ITERATOR:!0}),n}});var ZE=_e,eb=Pt,tb=eE,rb=lc,ib=TypeError;Zi({target:"Set",proto:!0,real:!0,forced:!0},{reduce:function(e){var t=eb(this),r=tb(t),i=arguments.length<2,n=i?void 0:arguments[1];if(ZE(e),rb(r,(function(r){i?(i=!1,n=r):n=e(n,r,r,t)}),{IS_ITERATOR:!0}),i)throw ib("Reduce of empty set with no initial value");return n}});var nb=Pt,ob=uo,sb=eE,ab=lc;Zi({target:"Set",proto:!0,real:!0,forced:!0},{some:function(e){var t=nb(this),r=sb(t),i=ob(e,arguments.length>1?arguments[1]:void 0);return ab(r,(function(e,r){if(i(e,e,t))return r()}),{IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var cb=G,ub=f,db=_e,lb=Pt,hb=eo,fb=lc;Zi({target:"Set",proto:!0,real:!0,forced:!0},{symmetricDifference:function(e){var t=lb(this),r=new(hb(t,cb("Set")))(t),i=db(r.delete),n=db(r.add);return fb(e,(function(e){ub(i,r,e)||ub(n,r,e)})),r}});var pb=G,mb=_e,gb=Pt,_b=eo,Sb=lc;Zi({target:"Set",proto:!0,real:!0,forced:!0},{union:function(e){var t=gb(this),r=new(_b(t,pb("Set")))(t);return Sb(e,mb(r.add),{that:r}),r}});var vb=_e,yb=Ne,Ib=U,Tb=di,Rb=TypeError,Eb=function(e){return function(t,r,i,n){vb(r);var o=yb(t),s=Ib(o),a=Tb(o),c=e?a-1:0,u=e?-1:1;if(i<2)for(;;){if(c in s){n=s[c],c+=u;break}if(c+=u,e?c<0:a<=c)throw Rb("Reduce of empty array with no initial value")}for(;e?c>=0:a>c;c+=u)c in s&&(n=r(n,s[c],c,o));return n}},bb={left:Eb(!1),right:Eb(!0)}.left,Cb=re,Ab=en;Zi({target:"Array",proto:!0,forced:!Bh("reduce")||!Ab&&Cb>79&&Cb<83},{reduce:function(e){var t=arguments.length;return bb(this,e,t,t>1?arguments[1]:void 0)}});const wb="player-state-change",kb="screen-sharing-stopped",Ob="audio-mixing-finished",Pb="audio-mixing-played",Mb="player-state-trace",Db=["camera-capture"],Nb={CameraCapture:Db[0]};let Ub;!function(e){e[e.encode=0]="encode",e[e.decode=1]="decode",e[e.codec=2]="codec"}(Ub||(Ub={}));const xb={low:{sampleRate:16e3,channelCount:1,bitrate:24e3},standard:{sampleRate:48e3,channelCount:1,bitrate:4e4},high:{sampleRate:48e3,channelCount:1,bitrate:128e3}},Lb=["low","standard","high"],Bb={"90p_1":{width:160,height:90,frameRate:15,minBitrate:64e3,maxBitrate:11e4},"90p_2":{width:120,height:90,frameRate:15,minBitrate:64e3,maxBitrate:11e4},"120p_1":{width:160,height:120,frameRate:15,minBitrate:64e3,maxBitrate:12e4},"120p_2":{width:120,height:120,frameRate:15,minBitrate:64e3,maxBitrate:11e4},"180p_1":{width:320,height:180,frameRate:15,minBitrate:8e4,maxBitrate:32e4},"180p_2":{width:240,height:180,frameRate:15,minBitrate:8e4,maxBitrate:17e4},"180p_3":{width:180,height:180,frameRate:15,minBitrate:64e3,maxBitrate:13e4},"240p_1":{width:320,height:240,frameRate:15,minBitrate:1e5,maxBitrate:4e5},"240p_2":{width:240,height:240,frameRate:15,minBitrate:8e4,maxBitrate:32e4},"270p_1":{width:480,height:270,frameRate:15,minBitrate:16e4,maxBitrate:6e5},"300p_1":{width:400,height:300,frameRate:15,minBitrate:2e5,maxBitrate:5e5},"360p_1":{width:640,height:360,frameRate:15,minBitrate:2e5,maxBitrate:8e5},"360p_2":{width:480,height:360,frameRate:15,minBitrate:2e5,maxBitrate:7e5},"360p_3":{width:360,height:360,frameRate:15,minBitrate:15e4,maxBitrate:6e5},"450p_1":{width:800,height:450,frameRate:15,minBitrate:3e5,maxBitrate:95e4},"480p_1":{width:640,height:480,frameRate:15,minBitrate:25e4,maxBitrate:9e5},"480p_2":{width:480,height:480,frameRate:15,minBitrate:2e5,maxBitrate:8e5},"540p_1":{width:960,height:540,frameRate:15,minBitrate:4e5,maxBitrate:1e6},"630p_1":{width:1120,height:630,frameRate:15,minBitrate:45e4,maxBitrate:115e4},"720p_1":{width:1280,height:720,frameRate:15,minBitrate:5e5,maxBitrate:15e5},"720p_2":{width:960,height:720,frameRate:15,minBitrate:45e4,maxBitrate:11e5},"1080p_1":{width:1920,height:1080,frameRate:15,minBitrate:6e5,maxBitrate:2e6},"1080p_2":{width:1440,height:1080,frameRate:15,minBitrate:55e4,maxBitrate:17e5}},Vb=["90p_1","90p_2","120p_1","120p_2","180p_1","180p_2","180p_3","240p_1","240p_2","270p_1","300p_1","360p_1","360p_2","360p_3","450p_1","480p_1","480p_2","540p_1","630p_1","720p_1","720p_2","1080p_1","1080p_2"],Yb={"720p":{width:1280,height:720,frameRate:15,bitrate:12e5},"1080p":{width:1920,height:1080,frameRate:15,bitrate:2e6}},jb=["720p","1080p"],Fb="inbound-rtp-audio",Hb="inbound-rtp-video",Kb="outbound-rtp-audio",zb="outbound-rtp-video",Wb="remote-inbound-rtp-audio",Gb="remote-inbound-rtp-video";let qb;!function(e){e[e.IDLE=0]="IDLE",e[e.INIT=1]="INIT",e[e.PLAY=2]="PLAY",e[e.PAUSE=3]="PAUSE"}(qb||(qb={}));const Jb=["IDLE","DISCONNECTED","CONNECTING","RECONNECTING","CONNECTED"];let Xb,Qb,$b,Zb,eC;!function(e){e[e.IDLE=0]="IDLE",e[e.DISCONNECTED=1]="DISCONNECTED",e[e.CONNECTING=2]="CONNECTING",e[e.RECONNECTING=3]="RECONNECTING",e[e.CONNECTED=4]="CONNECTED"}(Xb||(Xb={})),function(e){e[e.MediaStatusAvailable=1]="MediaStatusAvailable",e[e.MediaStatusUnavailable=2]="MediaStatusUnavailable"}(Qb||(Qb={})),function(e){e[e.StreamPkgsSend=1]="StreamPkgsSend",e[e.NoStreamPkgsSend=2]="NoStreamPkgsSend"}($b||($b={})),function(e){e[e.BackgroundMusic=1]="BackgroundMusic",e[e.Audio=2]="Audio",e[e.Video=3]="Video",e[e.Aux=4]="Aux"}(Zb||(Zb={})),function(e){e[e.MediaOffline=0]="MediaOffline",e[e.MediaMuted=1]="MediaMuted",e[e.MediaUnmuted=2]="MediaUnmuted"}(eC||(eC={}));const tC=new Set(["TOP_AUDIO"]);let rC,iC;async function nC(){return new Promise(((e,t)=>{navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices||t(new qc(Wc.RTC_ERR_CODE_NOT_SUPPORT_MEDIA_DEVICES)),navigator.mediaDevices.enumerateDevices().then((r=>{r&&0!==r.length?e(r):t(new qc(Wc.RTC_ERR_CODE_NO_AVAILABLE_DEVICES))})).catch((e=>{t(e)}))}))}!function(e){e.configNotify="NOTIFY_CONFIG",e.watchStreamNotify="WATCH_STREAM_NOTIFY",e.disconnectNotify="DISCONNECT_NOTIFY",e.pushStreamNotify="PUSH_STREAM_NOTIFY",e.reconnectNotify="RECONNECT_NOTIFY",e.stopPushStreamNotify="STOP_PUSH_STREAM_NOTIFY",e.changeStreamStatusNotify="CHANGE_STREAM_STATUS_NOTIFY",e.appDataChangeNotify="APP_DATA_NOTIFY",e.top3AudioVolumeNotify="TOP_AUDIO",e.statusChangeNotify="NOTIFY_STATUS",e.publishStatusNotify="PUBLISH_STATUS_NOTIFY",e.uploadLogNotify="UPLOAD_LOG_NOTIFY",e.roomStreamStatusNotify="ROOM_STREAM_STATUS_NOTIFY"}(rC||(rC={})),function(e){e.main="main",e.middle1="middle1",e.middle2="middle2",e.middle3="middle3",e.middle4="middle4",e.slides="slides",e.desktop="desktop"}(iC||(iC={}));const oC="0",sC=-1e3;let aC,cC,uC,dC,lC;!function(e){e[e.Idle=0]="Idle",e[e.Joining=1]="Joining",e[e.Joined=2]="Joined",e[e.Leaving=3]="Leaving",e[e.Rejoining=4]="Rejoining"}(aC||(aC={})),function(e){e[e.DEFAULT_BANDWIDTH_4M=4096e3]="DEFAULT_BANDWIDTH_4M",e[e.MIN_BAND_WIDTH=3072]="MIN_BAND_WIDTH",e[e.MAX_BAND_WIDTH=51200]="MAX_BAND_WIDTH"}(cC||(cC={})),function(e){e[e.HRTC_LEAVE_REASON_USER_LEAVE_ROOM=0]="HRTC_LEAVE_REASON_USER_LEAVE_ROOM",e[e.HRTC_LEAVE_REASON_SERVER_ERROR=1]="HRTC_LEAVE_REASON_SERVER_ERROR",e[e.HRTC_LEAVE_REASON_BREAKDOWN=2]="HRTC_LEAVE_REASON_BREAKDOWN",e[e.HRTC_LEAVE_REASON_SERVICE_UNREACHABLE=3]="HRTC_LEAVE_REASON_SERVICE_UNREACHABLE",e[e.HRTC_LEAVE_REASON_INTERNAL_ERROR=4]="HRTC_LEAVE_REASON_INTERNAL_ERROR",e[e.HRTC_LEAVE_REASON_KICKED_OFF=5]="HRTC_LEAVE_REASON_KICKED_OFF",e[e.HRTC_LEAVE_REASON_SIGNATURE_EXPIRED=6]="HRTC_LEAVE_REASON_SIGNATURE_EXPIRED",e[e.HRTC_LEAVE_REASON_RECONNECT_FAILED=7]="HRTC_LEAVE_REASON_RECONNECT_FAILED",e[e.HRTC_LEAVE_REASON_NETWORK_TEST=8]="HRTC_LEAVE_REASON_NETWORK_TEST",e[e.HRTC_LEAVE_REASON_USER_REMOVED=9]="HRTC_LEAVE_REASON_USER_REMOVED",e[e.HRTC_LEAVE_REASON_ROOM_DISMISSED=10]="HRTC_LEAVE_REASON_ROOM_DISMISSED"}(uC||(uC={})),function(e){e[e.ON=1]="ON",e[e.OFF=2]="OFF"}(dC||(dC={})),function(e){e[e.portNormal=1]="portNormal",e[e.portReduce=2]="portReduce"}(lC||(lC={}));const hC={Error:"Error",StreamAdded:"stream-added",StreamRemoved:"stream-removed",StreamUpdated:"stream-updated",StreamSubscribed:"stream-subscribed",ClientBanned:"client-banned",NetworkQuality:"network-quality",ConnectionStateChanged:"connection-state-changed",PeerJoin:"peer-join",PeerLeave:"peer-leave",MuteAudio:"mute-audio",UnmuteAudio:"unmute-audio",MuteVideo:"mute-video",UnmuteVideo:"unmute-video",LogUploaded:"log-upload-result",SignatureExpired:"signature-expired",CameraChanged:"camera-changed",RecordingDeviceChanged:"recording-device-changed",PlaybackDeviceChanged:"playback-device-changed",StreamInterrupted:"stream-interrupted",StreamRecovered:"stream-recovered",VolumeIndicator:"volume-indicator",UserNameChanged:"remote-user-name-changed",BatchSubscribeFailed:"batch-subscribe-failed",LiveStreamingUpdated:"live-streaming-updated",RtcStats:"rtc-stats",CmdMsgReceived:"cmd-msg-received",CmdChannelEstablished:"cmd-channel-established",CmdChannelDisconnect:"cmd-channel-disconnect",MediaConnectionStateChanged:"media-connection-state-changed",TransportProtocolChanged:"transport-protocol-changed",TransportStats:"transport-stats",RoomStreamStatus:"room-stream-status"};let fC,pC,mC,gC,_C,SC,vC,yC,IC,TC,RC,EC,bC;!function(e){e[e.NON_ENCRYPTION=0]="NON_ENCRYPTION",e[e.ENCRYPTION_FRAME_SDK=1]="ENCRYPTION_FRAME_SDK",e[e.ENCRYPTION_FRAME_APP=2]="ENCRYPTION_FRAME_APP",e[e.ENCRYPTION_E2E_WITHOUT_MEDIA=3]="ENCRYPTION_E2E_WITHOUT_MEDIA"}(fC||(fC={})),function(e){e.Connected="CONNECTED",e.Reconnecting="RECONNECTING",e.DisConnected="DISCONNECTED"}(pC||(pC={})),function(e){e.WEBSOCKET="WebSocket",e.DATA_CHANNEL="DataChannel"}(mC||(mC={})),function(e){e[e.ARRAY_BUFFER=0]="ARRAY_BUFFER",e[e.STRING=1]="STRING"}(gC||(gC={})),function(e){e[e.MSG_BIND=0]="MSG_BIND",e[e.MSG_DATA=1]="MSG_DATA"}(_C||(_C={})),function(e){e[e.PAUSE=0]="PAUSE",e[e.NORMAL=1]="NORMAL"}(SC||(SC={})),function(e){e[e.NET_OR_SERVERIP_ERROR=1]="NET_OR_SERVERIP_ERROR",e[e.ROOM_NOT_AVAILABLE=2]="ROOM_NOT_AVAILABLE",e[e.SERVER_ERROR=3]="SERVER_ERROR",e[e.SERVER_NO_RESPONSE=4]="SERVER_NO_RESPONSE",e[e.AUTHENTICATION_FAILED=5]="AUTHENTICATION_FAILED",e[e.RETRY_AUTHENTICATION=6]="RETRY_AUTHENTICATION",e[e.SYNCHRONIZE_FAILED=7]="SYNCHRONIZE_FAILED",e[e.URL_ERROR=8]="URL_ERROR",e[e.TERMINAL_ERROR=9]="TERMINAL_ERROR"}(vC||(vC={})),function(e){e[e.LEAVE_ROOM_SUCCESS=0]="LEAVE_ROOM_SUCCESS",e[e.LEAVE_ROOM_ERROR=1]="LEAVE_ROOM_ERROR"}(yC||(yC={})),function(e){e[e.ACTION_START=0]="ACTION_START",e[e.ACTION_STOP=1]="ACTION_STOP"}(IC||(IC={})),function(e){e[e.RESULT_SUCCESS=0]="RESULT_SUCCESS",e[e.RESULT_ERROR=1]="RESULT_ERROR"}(TC||(TC={})),function(e){e[e.OUTPUT_AUDIO=0]="OUTPUT_AUDIO",e[e.INPUT_AUDIO=1]="INPUT_AUDIO",e[e.INPUT_VIDEO=2]="INPUT_VIDEO"}(RC||(RC={})),function(e){e[e.AUDIO=0]="AUDIO",e[e.VIDEO=1]="VIDEO",e[e.AUX=2]="AUX"}(EC||(EC={})),function(e){e[e.SUCCESS=0]="SUCCESS",e[e.FAIL=1]="FAIL"}(bC||(bC={}));const CC=0,AC=1;let wC,kC,OC,PC,MC,DC,NC,UC,xC,LC,BC;!function(e){e[e.SIGNAL=0]="SIGNAL",e[e.MEDIA=1]="MEDIA"}(wC||(wC={})),function(e){e[e.CLOSED=0]="CLOSED",e[e.CONNECTED=1]="CONNECTED"}(kC||(kC={})),function(e){e[e.EVENT_JOIN_ROOM=1]="EVENT_JOIN_ROOM",e[e.EVENT_LEAVE_ROOM=2]="EVENT_LEAVE_ROOM",e[e.EVENT_WATCH=3]="EVENT_WATCH",e[e.EVENT_OPT_AUDIO=5]="EVENT_OPT_AUDIO",e[e.EVENT_SWITCH_NET=6]="EVENT_SWITCH_NET",e[e.EVENT_OPT_VIDEO=7]="EVENT_OPT_VIDEO",e[e.EVENT_SWITCH_DEVICE=9]="EVENT_SWITCH_DEVICE",e[e.EVENT_DNS_TIME=10]="EVENT_DNS_TIME",e[e.EVENT_SWITCH_ROLE=11]="EVENT_SWITCH_ROLE",e[e.EVENT_SEND_MEDIA=12]="EVENT_SEND_MEDIA",e[e.EVENT_START_MEDIA=13]="EVENT_START_MEDIA",e[e.EVENT_SEND_AUX_STREAM=14]="EVENT_SEND_AUX_STREAM",e[e.EVENT_SUBSCIBE=16]="EVENT_SUBSCIBE",e[e.EVENT_CONNECT_OTHER_ROOM=17]="EVENT_CONNECT_OTHER_ROOM",e[e.EVENT_CONNECTION_CHANNEL_STATUS=18]="EVENT_CONNECTION_CHANNEL_STATUS",e[e.EVENT_SET_UP_STREAM=19]="EVENT_SET_UP_STREAM",e[e.EVENT_SET_AUDIO_POLICY=20]="EVENT_SET_AUDIO_POLICY"}(OC||(OC={})),function(e){e[e.QoS_UP_STREAM_VIDEO=1001]="QoS_UP_STREAM_VIDEO",e[e.QoS_DOWN_STREAM_VIDEO=1002]="QoS_DOWN_STREAM_VIDEO",e[e.QoS_UP_STREAM_AUDIO=1003]="QoS_UP_STREAM_AUDIO",e[e.QoS_DOWN_STREAM_AUDIO=1004]="QoS_DOWN_STREAM_AUDIO",e[e.QoS_AUX_UP_STREAM_VIDEO=1005]="QoS_AUX_UP_STREAM_VIDEO",e[e.QoS_AUX_DOWN_STREAM_VIDEO=1006]="QoS_AUX_DOWN_STREAM_VIDEO",e[e.QoS_DOWN_STREAM_AUDIO_STAT=1007]="QoS_DOWN_STREAM_AUDIO_STAT",e[e.QoS_UP_STREAM_VIDEO_SUM=1011]="QoS_UP_STREAM_VIDEO_SUM",e[e.QoS_DOWN_STREAM_VIDEO_SUM=1012]="QoS_DOWN_STREAM_VIDEO_SUM",e[e.QoS_UP_STREAM_AUDIO_SUM=1013]="QoS_UP_STREAM_AUDIO_SUM",e[e.QoS_DOWN_STREAM_AUDIO_SUM=1014]="QoS_DOWN_STREAM_AUDIO_SUM"}(PC||(PC={})),function(e){e[e.DEVICE_RT_SYSTEM=2001]="DEVICE_RT_SYSTEM",e[e.DEVICE_RT_CAMERA=2002]="DEVICE_RT_CAMERA",e[e.DEVICE_RT_SPEAKER=2003]="DEVICE_RT_SPEAKER",e[e.DEVICE_RT_MICROPHONE=2004]="DEVICE_RT_MICROPHONE"}(MC||(MC={})),function(e){e[e.DEVICE_STATUS_SPEAKER=3001]="DEVICE_STATUS_SPEAKER",e[e.DEVICE_STATUS_CAMERA=3002]="DEVICE_STATUS_CAMERA",e[e.DEVICE_STATUS_MICROPHONE=3003]="DEVICE_STATUS_MICROPHONE",e[e.DEVICE_STATUS_DEVICE_CHANGE=3004]="DEVICE_STATUS_DEVICE_CHANGE",e[e.DEVICE_STATUS_ERROR=3005]="DEVICE_STATUS_ERROR",e[e.DEVICE_STATUS_MEDIA_QUALITY=3006]="DEVICE_STATUS_MEDIA_QUALITY",e[e.DEVICE_STATUS_USERAGENT=3007]="DEVICE_STATUS_USERAGENT"}(DC||(DC={})),function(e){e[e.SIGNAL_REQUEST=401]="SIGNAL_REQUEST",e[e.SIGNAL_RESPONSE=402]="SIGNAL_RESPONSE"}(NC||(NC={})),function(e){e[e.API_CALL=501]="API_CALL",e[e.CALLBACK_API=502]="CALLBACK_API"}(UC||(UC={})),function(e){e[e.FirstFrame=606]="FirstFrame"}(xC||(xC={})),function(e){e[e.TraceNuwa=2998]="TraceNuwa"}(LC||(LC={})),function(e){e[e.SUCCESS=0]="SUCCESS",e[e.FAIL=1]="FAIL"}(BC||(BC={}));const VC=["watch","batch_watch","cancel_watch"];let YC;!function(e){e[e.SUCCESS=0]="SUCCESS",e[e.NETWORK_CONNECT_ERROR=1]="NETWORK_CONNECT_ERROR",e[e.CLIENT_NOT_IDEL=2]="CLIENT_NOT_IDEL",e[e.SERVER_ERROR=3]="SERVER_ERROR",e[e.INTERNAL_ERROR=9]="INTERNAL_ERROR"}(YC||(YC={}));const jC="2.0.8.301",FC="95f4253",HC="v3",KC=5e3,zC=1e4,WC=5,GC=6,qC=120,JC="https://rtc-sdk.obs.cn-north-4.myhuaweicloud.com:443/WebRTCSDK-Release/whitelist/browserSupportWhiteList.conf?AccessKeyId=J8YMIPY8O5U8D7REC0IM&Expires=1698541564&Signature=f8dGtzjfDERoMWQcW9MVlSqu/Y8%3D",XC="https://logservice.hicloud.com:443",QC="1090",$C=4,ZC=["webCongestionAlgorithm"];class eA{static checkStringParameter(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0;if(!e&&0===r)return;if("string"!=typeof e)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"invalid type: ".concat(e));const n=this.getStringBytes(e);if(n>t||n<r)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"invalid length: ".concat(e));if(i){if(!new RegExp(i).test(e))throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"invalid format: ".concat(e))}}static checkAppid(e){this.checkStringParameter(e,128,1,"^[a-zA-Z0-9!$%()+-:;=@[\\]_~,]{1,128}$")}static checkCountryCode(e){e&&this.checkStringParameter(e,2,2,"^[A-Z]{2}$")}static checkDomain(e){this.checkStringParameter(e,128,1,"^[a-zA-Z0-9-:;<=.>?@[\\]^_{}|~,]{1,128}$")}static checkRoomId(e){this.checkStringParameter(e,64,1,"^[a-zA-Z0-9-_]{1,64}$")}static checkUserId(e){this.checkStringParameter(e,64,1,"^[a-zA-Z0-9-_]{1,64}$")}static checkUserName(e){this.checkStringParameter(e,256,0)}static checkUserRole(e){if("number"!=typeof e)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"invalid parameter: ".concat(e));this.checkStringParameter("".concat(e),1,1,"^[0|2]$")}static checkSFUResourceType(e){if(null!=e){if("number"!=typeof e)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"invalid paramter: ".concat(e));this.checkStringParameter("".concat(e),1,1,"^[0|1|2|3]$")}}static checkResourceTags(e){if(null!=e&&(!Array.isArray(e)||e.filter((e=>"string"!=typeof e)).length>0))throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"invalid paramter of resourceTags: ".concat(e))}static checkUserInfo(e){if("object"!=typeof e)throw this.logger.error("ParameterValidator","userInfo type invalid "),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"userInfo type invalid");this.checkUserId(e.userId),this.checkUserName(e.userName),this.checkUserRole(e.role),this.checkUserOptionInfo(e.optionInfo)}static checkJoinParams(e,t){this.checkRoomId(e),this.checkUserInfo(t)}static getStringBytes(e){if(!e)return 0;if("string"!=typeof e)return e.byteLength;let t=0;if(window.TextEncoder){return t=(new TextEncoder).encode(e).length,t}const r=e.length;for(let i=0;i<r;i++)e.charCodeAt(i)>255?t+=3:t++;return t}static checkUserOptionInfo(e){if(e&&![!0,!1,null,void 0].includes(e.recordPlaceholder))throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"invalid parameter: ".concat(e.recordPlaceholder))}static checkSrcMultiRoomInfo(e){if(!e.authorization||!e.ctime||"0"!==e.userId)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"invalid paramters: ".concat(e.authorization," ").concat(e.ctime," ").concat(e.userId))}static checkDstMultiRoomInfo(e,t){this.checkRoomId(e.roomId),this.checkUserRole(t);const r=e.role>=t;if(!e.authorization||!e.ctime||!r)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"invalid paramters: ".concat(e.authorization," ").concat(e.ctime," ").concat(e.role))}static checkCmdMsgValid(e){const t=eA.getStringBytes(e);if(t>32768)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"invalid msg length: ".concat(t))}}t(eA,"logger",MR.getLogger());var tA=new class{setPorxyServer(e){eA.checkStringParameter(e,256,1);const t=/(.*:\/\/)?([^:]+):?(.*)?/.exec(e);let r=e;/^((\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))(\.|$)){4}$/.test(t[2])?t[1]||(r="http://".concat(t[2]).concat(t[3]?":":"").concat(t[3]||"")):t[1]||(r="https://".concat(t[2]).concat(t[3]?":":"").concat(t[3]||"")),this.proxyServer=r}getProxyServer(){return this.proxyServer}};function rA(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function iA(e){for(var r=1;r<arguments.length;r++){var i=null!=arguments[r]?arguments[r]:{};r%2?rA(Object(i),!0).forEach((function(r){t(e,r,i[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):rA(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const nA="httpRequest";const oA=new class{constructor(){this.defaultRequestOption={method:"GET",mode:"cors",cache:"default"},this.logger=MR.getLogger()}getFetchUrl(e){const t=tA.getProxyServer();let r;if(t){const i=/http(?:s)?:\/\/([^/]+)(.*)/.exec(e);if(i&&3===i.length){const n=i[1].split(":");r=n[1]||(/^http:.*/gi.test(e)?"80":"443"),e="".concat(t).concat(i[2]).concat(i[2].indexOf("?")<0?"?":"&","org_domain=").concat(n[0],"&org_port=").concat(r)}return e}return e}async fetch(e){let t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2e4,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5?arguments[5]:void 0,a=0;for(;a<o+1;){const c={};t=bR.generateRandomId(16,10);try{this.logger.debug(nA,"[HTTP_ID:".concat(t,"] fetch request start: ").concat(bR.shieldUrlParameters(e))),this.extendInfosHandle(e,"start",c,s);const u=await this.doFetch(e,r,i,n,t);return a=o+1,this.extendInfosHandle(e,"end",c,s,u),this.logger.debug(nA,"[HTTP_ID:".concat(t,"] fetch request success")),u}catch(kD){if(this.logger.error(nA,"[HTTP_ID:".concat(t,"], requestUrl: ").concat(bR.shieldUrlParameters(e),", fetch request failed")),this.extendInfosHandle(e,"end",c,s,kD),kD instanceof qc&&kD.getCode()===Wc.RTC_ERR_CODE_REGION_NOT_COVERED)throw a=o+1,kD;if(!(a<o))throw kD;await bR.sleep(500*bR.getRandom()+500),a++}}}doFetch(e){let t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0;const s=new Promise(((e,r)=>{t=setTimeout((()=>{clearTimeout(t),r(new qc(Wc.RTC_ERR_CODE_WAIT_RSP_TIMEOUT))}),n)})),a=new Promise(((n,s)=>{fetch(this.getFetchUrl(e),iA(iA(iA({},this.defaultRequestOption),r),{headers:i})).then((t=>{if(bR.syncLocalTime(t.headers.get("Date")),!t.ok)return 504===t.status?this.logger.error(nA,"[HTTP_ID:".concat(o,"] doFetch failed: 504")):0===t.status?this.logger.error(nA,"[HTTP_ID:".concat(o,"] doFetch failed: 0")):this.logger.error(nA,"[HTTP_ID:".concat(o,"] doFetch failed: ").concat(t.status)),void s(new qc(t.status,"network error"));let r;const a=t.headers.get("Content-Type")||i["Content-Type"];r=/.*application\/json.*/.test(a)?t.json():/^text.*/.test(a)?t.text():t.arrayBuffer(),r.then((e=>{n({httpCode:t.status,data:e})})).catch((t=>{this.logger.error(nA,"[HTTP_ID:".concat(o,"], requestUrl: ").concat(bR.shieldUrlParameters(e),", doFetch get response failed: ").concat(t)),s(new qc(null==t?void 0:t.name,null==t?void 0:t.message))}))})).catch((t=>{this.logger.error(nA,"[HTTP_ID:".concat(o,"], requestUrl: ").concat(bR.shieldUrlParameters(e),", doFetch failed for exception: ").concat(t)),s(new qc(null==t?void 0:t.name,null==t?void 0:t.message))})).finally((()=>{clearTimeout(t)}))}));return Promise.race([s,a])}extendInfosHandle(e,t,r,i,n){i&&("start"===t?Object.assign(r,{id:i.length+1,domain:e,start_ms:bR.getCurrentTimestamp(),delay_ms:0,stepName:"dispatch",rspCode:"",errMsg:""}):"end"===t?((/v1\/dns/.test(e)||/global\.talk-cloud\.net/.test(e))&&(r.start_ms=bR.adjustTimeByOffset(r.start_ms)),n instanceof qc?(r.delay_ms=bR.getCurrentTimestamp()-r.start_ms,r.rspCode="".concat(n.getCode()),r.errMsg=n.getMsg()):(r.delay_ms=bR.getCurrentTimestamp()-r.start_ms,r.rspCode=n.httpCode||"200"),i.push(r)):this.logger.info(nA,"cannot handle"))}};let sA=!0,aA=!0;function cA(e,t,r){const i=e.match(t);return i&&i.length>=r&&parseInt(i[r],10)}function uA(e,t,r){if(!e.RTCPeerConnection)return;const i=e.RTCPeerConnection.prototype,n=i.addEventListener;i.addEventListener=function(e,i){if(e!==t)return n.apply(this,arguments);const o=e=>{const t=r(e);t&&(i.handleEvent?i.handleEvent(t):i(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(i,o),n.apply(this,[e,o])};const o=i.removeEventListener;i.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(r))return o.apply(this,arguments);const i=this._eventMap[t].get(r);return this._eventMap[t].delete(r),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,o.apply(this,[e,i])},Object.defineProperty(i,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function dA(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(sA=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function lA(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(aA=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function hA(){if("object"==typeof window){if(sA)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function fA(e,t){aA&&console.warn(e+" is deprecated, please use "+t+" instead.")}function pA(e){return"[object Object]"===Object.prototype.toString.call(e)}function mA(e){return pA(e)?Object.keys(e).reduce((function(t,r){const i=pA(e[r]),n=i?mA(e[r]):e[r],o=i&&!Object.keys(n).length;return void 0===n||o?t:Object.assign(t,{[r]:n})}),{}):e}function gA(e,t,r){t&&!r.has(t.id)&&(r.set(t.id,t),Object.keys(t).forEach((i=>{i.endsWith("Id")?gA(e,e.get(t[i]),r):i.endsWith("Ids")&&t[i].forEach((t=>{gA(e,e.get(t),r)}))})))}function _A(e,t,r){const i=r?"outbound-rtp":"inbound-rtp",n=new Map;if(null===t)return n;const o=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&o.push(e)})),o.forEach((t=>{e.forEach((r=>{r.type===i&&r.trackId===t.id&&gA(e,r,n)}))})),n}const SA=hA;function vA(e,t){const r=e&&e.navigator;if(!r.mediaDevices)return;const i=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((r=>{if("require"===r||"advanced"===r||"mediaSource"===r)return;const i="object"==typeof e[r]?e[r]:{ideal:e[r]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);const n=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==i.ideal){t.optional=t.optional||[];let e={};"number"==typeof i.ideal?(e[n("min",r)]=i.ideal,t.optional.push(e),e={},e[n("max",r)]=i.ideal,t.optional.push(e)):(e[n("",r)]=i.ideal,t.optional.push(e))}void 0!==i.exact&&"number"!=typeof i.exact?(t.mandatory=t.mandatory||{},t.mandatory[n("",r)]=i.exact):["min","max"].forEach((e=>{void 0!==i[e]&&(t.mandatory=t.mandatory||{},t.mandatory[n(e,r)]=i[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},n=function(e,n){if(t.version>=61)return n(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=i(e.audio)}if(e&&"object"==typeof e.video){let o=e.video.facingMode;o=o&&("object"==typeof o?o:{ideal:o});const s=t.version<66;if(o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!r.mediaDevices.getSupportedConstraints||!r.mediaDevices.getSupportedConstraints().facingMode||s)){let t;if(delete e.video.facingMode,"environment"===o.exact||"environment"===o.ideal?t=["back","rear"]:"user"!==o.exact&&"user"!==o.ideal||(t=["front"]),t)return r.mediaDevices.enumerateDevices().then((r=>{r=r.filter((e=>"videoinput"===e.kind));let s=r.find((e=>t.some((t=>e.label.toLowerCase().includes(t)))));return!s&&r.length&&t.includes("back")&&(s=r[r.length-1]),s&&(e.video.deviceId=o.exact?{exact:s.deviceId}:{ideal:s.deviceId}),e.video=i(e.video),SA("chrome: "+JSON.stringify(e)),n(e)}))}e.video=i(e.video)}return SA("chrome: "+JSON.stringify(e)),n(e)},o=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(r.getUserMedia=function(e,t,i){n(e,(e=>{r.webkitGetUserMedia(e,t,(e=>{i&&i(o(e))}))}))}.bind(r),r.mediaDevices.getUserMedia){const e=r.mediaDevices.getUserMedia.bind(r.mediaDevices);r.mediaDevices.getUserMedia=function(t){return n(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(o(e))))))}}}function yA(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function IA(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(r=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===r.track.id)):{track:r.track};const n=new Event("track");n.track=r.track,n.receiver=i,n.transceiver={receiver:i},n.streams=[t.stream],this.dispatchEvent(n)})),t.stream.getTracks().forEach((r=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===r.id)):{track:r};const n=new Event("track");n.track=r,n.receiver=i,n.transceiver={receiver:i},n.streams=[t.stream],this.dispatchEvent(n)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else uA(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function TA(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){let n=r.apply(this,arguments);return n||(n=t(this,e),this._senders.push(n)),n};const i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){i.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],r.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function RA(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,i]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const n=function(e){const t={};return e.result().forEach((e=>{const r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{r[t]=e.stat(t)})),t[r.id]=r})),t},o=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const i=function(e){r(o(n(e)))};return t.apply(this,[i,e])}return new Promise(((e,r)=>{t.apply(this,[function(t){e(o(n(t)))},r])})).then(r,i)}}function EA(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>_A(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),uA(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>_A(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,r,i;return this.getSenders().forEach((r=>{r.track===e&&(t?i=!0:t=r)})),this.getReceivers().forEach((t=>(t.track===e&&(r?i=!0:r=t),t.track===e))),i||t&&r?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():r?r.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function bA(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const i=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(i)&&this._shimmedLocalStreams[r.id].push(i):this._shimmedLocalStreams[r.id]=[r,i],i};const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{const t=this.getSenders().find((t=>t.track===e));if(t)throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();r.apply(this,arguments);const i=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(i)};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],i.apply(this,arguments)};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const r=this._shimmedLocalStreams[t].indexOf(e);-1!==r&&this._shimmedLocalStreams[t].splice(r,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),n.apply(this,arguments)}}function CA(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return bA(e);const r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=r.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{const t=this.getSenders().find((t=>t.track===e));if(t)throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const r=new e.MediaStream(t.getTracks());this._streams[t.id]=r,this._reverseStreams[r.id]=t,t=r}i.apply(this,[t])};const n=e.RTCPeerConnection.prototype.removeStream;function o(e,t){let r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const i=e._reverseStreams[t],n=e._streams[i.id];r=r.replace(new RegExp(n.id,"g"),i.id)})),new RTCSessionDescription({type:t.type,sdp:r})}function s(e,t){let r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const i=e._reverseStreams[t],n=e._streams[i.id];r=r.replace(new RegExp(i.id,"g"),n.id)})),new RTCSessionDescription({type:t.type,sdp:r})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},n.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,r){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const n=this.getSenders().find((e=>e.track===t));if(n)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const o=this._streams[r.id];if(o)o.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const i=new e.MediaStream([t]);this._streams[r.id]=i,this._reverseStreams[i.id]=r,this.addStream(i)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],i={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(this,[t=>{const r=o(this,t);e[0].apply(null,[r])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):r.apply(this,arguments).then((e=>o(this,e)))}};e.RTCPeerConnection.prototype[t]=i[t]}));const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=s(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=c.get.apply(this);return""===e.type?e:o(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((r=>{this._streams[r].getTracks().find((t=>e.track===t))&&(t=this._streams[r])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function AA(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],i={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=i[t]}))}function wA(e,t){uA(e,"negotiationneeded",(e=>{const r=e.target;if(!(t.version<72||r.getConfiguration&&"plan-b"===r.getConfiguration().sdpSemantics)||"stable"===r.signalingState)return e}))}var kA=Object.freeze({__proto__:null,shimMediaStream:yA,shimOnTrack:IA,shimGetSendersWithDtmf:TA,shimGetStats:RA,shimSenderReceiverGetStats:EA,shimAddTrackRemoveTrackWithNative:bA,shimAddTrackRemoveTrack:CA,shimPeerConnection:AA,fixNegotiationNeeded:wA,shimGetUserMedia:vA,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(r){return t(r).then((t=>{const i=r.video&&r.video.width,n=r.video&&r.video.height,o=r.video&&r.video.frameRate;return r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:o||3}},i&&(r.video.mandatory.maxWidth=i),n&&(r.video.mandatory.maxHeight=n),e.navigator.mediaDevices.getUserMedia(r)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}});function OA(e,t){const r=e&&e.navigator,i=e&&e.MediaStreamTrack;if(r.getUserMedia=function(e,t,i){fA("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(t,i)},!(t.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){const e=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])},t=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(r){return"object"==typeof r&&"object"==typeof r.audio&&(r=JSON.parse(JSON.stringify(r)),e(r.audio,"autoGainControl","mozAutoGainControl"),e(r.audio,"noiseSuppression","mozNoiseSuppression")),t(r)},i&&i.prototype.getSettings){const t=i.prototype.getSettings;i.prototype.getSettings=function(){const r=t.apply(this,arguments);return e(r,"mozAutoGainControl","autoGainControl"),e(r,"mozNoiseSuppression","noiseSuppression"),r}}if(i&&i.prototype.applyConstraints){const t=i.prototype.applyConstraints;i.prototype.applyConstraints=function(r){return"audio"===this.kind&&"object"==typeof r&&(r=JSON.parse(JSON.stringify(r)),e(r,"autoGainControl","mozAutoGainControl"),e(r,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[r])}}}}function PA(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function MA(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],i={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=i[t]}));const r={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,n,o]=arguments;return i.apply(this,[e||null]).then((e=>{if(t.version<53&&!n)try{e.forEach((e=>{e.type=r[e.type]||e.type}))}catch(lw){if("TypeError"!==lw.name)throw lw;e.forEach(((t,i)=>{e.set(i,Object.assign({},t,{type:r[t.type]||t.type}))}))}return e})).then(n,o)}}function DA(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function NA(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),uA(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function UA(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){fA("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function xA(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function LA(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],r=e&&"sendEncodings"in e;r&&e.sendEncodings.forEach((e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const i=t.apply(this,arguments);if(r){const{sender:t}=i,r=t.getParameters();(!("encodings"in r)||1===r.encodings.length&&0===Object.keys(r.encodings[0]).length)&&(r.encodings=e.sendEncodings,t.sendEncodings=e.sendEncodings,this.setParametersPromises.push(t.setParameters(r).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return i})}function BA(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function VA(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function YA(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}var jA=Object.freeze({__proto__:null,shimOnTrack:PA,shimPeerConnection:MA,shimSenderGetStats:DA,shimReceiverGetStats:NA,shimRemoveStream:UA,shimRTCDataChannel:xA,shimAddTransceiver:LA,shimGetParameters:BA,shimCreateOffer:VA,shimCreateAnswer:YA,shimGetUserMedia:OA,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(r){if(!r||!r.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===r.video?r.video={mediaSource:t}:r.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(r)})}});function FA(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((r=>t.call(this,r,e))),e.getVideoTracks().forEach((r=>t.call(this,r,e)))},e.RTCPeerConnection.prototype.addTrack=function(e,...r){return r&&r.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const r=e.getTracks();this.getSenders().forEach((e=>{r.includes(e.track)&&this.removeTrack(e)}))})}}function HA(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const r=new Event("addstream");r.stream=t,e.dispatchEvent(r)}))}),t.apply(e,arguments)}}}function KA(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,r=t.createOffer,i=t.createAnswer,n=t.setLocalDescription,o=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],n=r.apply(this,[i]);return t?(n.then(e,t),Promise.resolve()):n},t.createAnswer=function(e,t){const r=arguments.length>=2?arguments[2]:arguments[0],n=i.apply(this,[r]);return t?(n.then(e,t),Promise.resolve()):n};let a=function(e,t,r){const i=n.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i};t.setLocalDescription=a,a=function(e,t,r){const i=o.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i},t.setRemoteDescription=a,a=function(e,t,r){const i=s.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i},t.addIceCandidate=a}function zA(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,r=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>r(WA(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,i){t.mediaDevices.getUserMedia(e).then(r,i)}.bind(t))}function WA(e){return e&&void 0!==e.video?Object.assign({},e,{video:mA(e.video)}):e}function GA(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){const t=[];for(let r=0;r<e.iceServers.length;r++){let i=e.iceServers[r];!i.hasOwnProperty("urls")&&i.hasOwnProperty("url")?(fA("RTCIceServer.url","RTCIceServer.urls"),i=JSON.parse(JSON.stringify(i)),i.urls=i.url,delete i.url,t.push(i)):t.push(e.iceServers[r])}e.iceServers=t}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function qA(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function JA(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const r=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==e.offerToReceiveVideo||r||this.addTransceiver("video")}return t.apply(this,arguments)}}function XA(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var QA=Object.freeze({__proto__:null,shimLocalStreamsAPI:FA,shimRemoteStreamsAPI:HA,shimCallbacksAPI:KA,shimGetUserMedia:zA,shimConstraints:WA,shimRTCIceServerUrls:GA,shimTrackEventTransceiver:qA,shimCreateOfferLegacy:JA,shimAudioContext:XA}),$A={exports:{}};!function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((e=>e.trim()))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>(t>0?"m="+e:e).trim()+"\r\n"))},t.getDescription=function(e){const r=t.splitSections(e);return r&&r[0]},t.getMediaSections=function(e){const r=t.splitSections(e);return r.shift(),r},t.matchPrefix=function(e,r){return t.splitLines(e).filter((e=>0===e.indexOf(r)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const r={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let i=8;i<t.length;i+=2)switch(t[i]){case"raddr":r.relatedAddress=t[i+1];break;case"rport":r.relatedPort=parseInt(t[i+1],10);break;case"tcptype":r.tcpType=t[i+1];break;case"ufrag":r.ufrag=t[i+1],r.usernameFragment=t[i+1];break;default:void 0===r[t[i]]&&(r[t[i]]=t[i+1])}return r},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const r=e.component;"rtp"===r?t.push(1):"rtcp"===r?t.push(2):t.push(r),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const i=e.type;return t.push("typ"),t.push(i),"host"!==i&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){let t=e.substr(9).split(" ");const r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){const t={};let r;const i=e.substr(e.indexOf(" ")+1).split(";");for(let n=0;n<i.length;n++)r=i[n].trim().split("="),t[r[0].trim()]=r[1];return t},t.writeFmtp=function(e){let t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const i=[];Object.keys(e.parameters).forEach((t=>{void 0!==e.parameters[t]?i.push(t+"="+e.parameters[t]):i.push(t)})),t+="a=fmtp:"+r+" "+i.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},i=e.indexOf(":",t);return i>-1?(r.attribute=e.substr(t+1,i-t-1),r.value=e.substr(i+1)):r.attribute=e.substr(t+1),r},t.parseSsrcGroup=function(e){const t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const r=t.matchPrefix(e,"a=mid:")[0];if(r)return r.substr(6)},t.parseFingerprint=function(e){const t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,r){return{role:"auto",fingerprints:t.matchPrefix(e+r,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let r="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),r},t.parseCryptoLine=function(e){const t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,r){return t.matchPrefix(e+r,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,r){const i=t.matchPrefix(e+r,"a=ice-ufrag:")[0],n=t.matchPrefix(e+r,"a=ice-pwd:")[0];return i&&n?{usernameFragment:i.substr(12),password:n.substr(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const r={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=t.splitLines(e)[0].split(" ");for(let n=3;n<i.length;n++){const o=i[n],s=t.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(s){const i=t.parseRtpMap(s),n=t.matchPrefix(e,"a=fmtp:"+o+" ");switch(i.parameters=n.length?t.parseFmtp(n[0]):{},i.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(t.parseRtcpFb),r.codecs.push(i),i.name.toUpperCase()){case"RED":case"ULPFEC":r.fecMechanisms.push(i.name.toUpperCase())}}}return t.matchPrefix(e,"a=extmap:").forEach((e=>{r.headerExtensions.push(t.parseExtmap(e))})),r},t.writeRtpDescription=function(e,r){let i="";i+="m="+e+" ",i+=r.codecs.length>0?"9":"0",i+=" UDP/TLS/RTP/SAVPF ",i+=r.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",r.codecs.forEach((e=>{i+=t.writeRtpMap(e),i+=t.writeFmtp(e),i+=t.writeRtcpFb(e)}));let n=0;return r.codecs.forEach((e=>{e.maxptime>n&&(n=e.maxptime)})),n>0&&(i+="a=maxptime:"+n+"\r\n"),r.headerExtensions&&r.headerExtensions.forEach((e=>{i+=t.writeExtmap(e)})),i},t.parseRtpEncodingParameters=function(e){const r=[],i=t.parseRtpParameters(e),n=-1!==i.fecMechanisms.indexOf("RED"),o=-1!==i.fecMechanisms.indexOf("ULPFEC"),s=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),a=s.length>0&&s[0].ssrc;let c;const u=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substr(17).split(" ").map((e=>parseInt(e,10)))));u.length>0&&u[0].length>1&&u[0][0]===a&&(c=u[0][1]),i.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10)};a&&c&&(t.rtx={ssrc:c}),r.push(t),n&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:a,mechanism:o?"red+ulpfec":"red"},r.push(t))}})),0===r.length&&a&&r.push({ssrc:a});let d=t.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substr(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substr(5),10)*.95-16e3:void 0,r.forEach((e=>{e.maxBitrate=d}))),r},t.parseRtcpParameters=function(e){const r={},i=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];i&&(r.cname=i.value,r.ssrc=i.ssrc);const n=t.matchPrefix(e,"a=rtcp-rsize");r.reducedSize=n.length>0,r.compound=0===n.length;const o=t.matchPrefix(e,"a=rtcp-mux");return r.mux=o.length>0,r},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let r;const i=t.matchPrefix(e,"a=msid:");if(1===i.length)return r=i[0].substr(7).split(" "),{stream:r[0],track:r[1]};const n=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return n.length>0?(r=n[0].value.split(" "),{stream:r[0],track:r[1]}):void 0},t.parseSctpDescription=function(e){const r=t.parseMLine(e),i=t.matchPrefix(e,"a=max-message-size:");let n;i.length>0&&(n=parseInt(i[0].substr(19),10)),isNaN(n)&&(n=65536);const o=t.matchPrefix(e,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substr(12),10),protocol:r.fmt,maxMessageSize:n};const s=t.matchPrefix(e,"a=sctpmap:");if(s.length>0){const e=s[0].substr(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:n}}},t.writeSctpDescription=function(e,t){let r=[];return r="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&r.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),r.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,r,i){let n;const o=void 0!==r?r:2;n=e||t.generateSessionId();return"v=0\r\no="+(i||"thisisadapterortc")+" "+n+" "+o+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,r){const i=t.splitLines(e);for(let t=0;t<i.length;t++)switch(i[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[t].substr(2)}return r?t.getDirection(r):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const r=t.splitLines(e)[0].substr(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},t.parseOLine=function(e){const r=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const r=t.splitLines(e);for(let t=0;t<r.length;t++)if(r[t].length<2||"="!==r[t].charAt(1))return!1;return!0},e.exports=t}($A);var ZA=$A.exports,ew=e({__proto__:null,default:ZA},[$A.exports]);function tw(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const r=new t(e),i=ZA.parseCandidate(e.candidate),n=Object.assign(r,i);return n.toJSON=function(){return{candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex,usernameFragment:n.usernameFragment}},n}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,uA(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function rw(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const r=function(e){if(!e||!e.sdp)return!1;const t=ZA.splitSections(e.sdp);return t.shift(),t.some((e=>{const t=ZA.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},i=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const r=parseInt(t[1],10);return r!=r?-1:r},n=function(e){let r=65536;return"firefox"===t.browser&&(r=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),r},o=function(e,r){let i=65536;"firefox"===t.browser&&57===t.version&&(i=65535);const n=ZA.matchPrefix(e.sdp,"a=max-message-size:");return n.length>0?i=parseInt(n[0].substr(19),10):"firefox"===t.browser&&-1!==r&&(i=2147483637),i},s=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(r(arguments[0])){const e=i(arguments[0]),t=n(e),r=o(arguments[0],e);let s;s=0===t&&0===r?Number.POSITIVE_INFINITY:0===t||0===r?Math.max(t,r):Math.min(t,r);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>s}),this._sctp=a}return s.apply(this,arguments)}}function iw(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const r=e.send;e.send=function(){const i=arguments[0],n=i.length||i.size||i.byteLength;if("open"===e.readyState&&t.sctp&&n>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)}}const r=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=r.apply(this,arguments);return t(e,this),e},uA(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function nw(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const r=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const r=new Event("connectionstatechange",e);t.dispatchEvent(r)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}}))}function ow(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const r=t.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:r}):t.sdp=r}return r.apply(this,arguments)}}function sw(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const r=e.RTCPeerConnection.prototype.addIceCandidate;r&&0!==r.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function aw(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const r=e.RTCPeerConnection.prototype.setLocalDescription;r&&0!==r.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!=typeof e||e.type&&e.sdp)return r.apply(this,arguments);if(e={type:e.type,sdp:e.sdp},!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer"}if(e.sdp||"offer"!==e.type&&"answer"!==e.type)return r.apply(this,[e]);const t="offer"===e.type?this.createOffer:this.createAnswer;return t.apply(this).then((e=>r.apply(this,[e])))})}var cw=Object.freeze({__proto__:null,shimRTCIceCandidate:tw,shimMaxMessageSize:rw,shimSendThrowTypeError:iw,shimConnectionState:nw,removeExtmapAllowMixed:ow,shimAddIceCandidateNullOrEmpty:sw,shimParameterlessSetLocalDescription:aw});const uw=function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){const r=hA,i=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:r}=e;if(r.mozGetUserMedia)t.browser="firefox",t.version=cA(r.userAgent,/Firefox\/(\d+)\./,1);else if(r.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)t.browser="chrome",t.version=cA(r.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!e.RTCPeerConnection||!r.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=cA(r.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}(e),n={browserDetails:i,commonShim:cw,extractVersion:cA,disableLog:dA,disableWarnings:lA,sdp:ew};switch(i.browser){case"chrome":if(!kA||!AA||!t.shimChrome)return r("Chrome shim is not included in this adapter release."),n;if(null===i.version)return r("Chrome shim can not determine version, not shimming."),n;r("adapter.js shimming chrome."),n.browserShim=kA,sw(e,i),aw(e),vA(e,i),yA(e),AA(e,i),IA(e),CA(e,i),TA(e),RA(e),EA(e),wA(e,i),tw(e),nw(e),rw(e,i),iw(e),ow(e,i);break;case"firefox":if(!jA||!MA||!t.shimFirefox)return r("Firefox shim is not included in this adapter release."),n;r("adapter.js shimming firefox."),n.browserShim=jA,sw(e,i),aw(e),OA(e,i),MA(e,i),PA(e),UA(e),DA(e),NA(e),xA(e),LA(e),BA(e),VA(e),YA(e),tw(e),nw(e),rw(e,i),iw(e);break;case"safari":if(!QA||!t.shimSafari)return r("Safari shim is not included in this adapter release."),n;r("adapter.js shimming safari."),n.browserShim=QA,sw(e,i),aw(e),GA(e),JA(e),KA(e),FA(e),HA(e),qA(e),zA(e),XA(e),tw(e),rw(e,i),iw(e),ow(e,i);break;default:r("Unsupported browser!")}return n}({window:"undefined"==typeof window?void 0:window});window.AudioContext=window.AudioContext||window.webkitAudioContext,window.RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection;class dw{static async checkSystemRequirements(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!window||!navigator)throw new qc(Wc.RTC_ERR_CODE_WEBRTC_UNSUPPORTED,"window or navigator error");if("chrome"===uw.browserDetails.browser&&dw.getBrowserVersion()<67)throw new qc(Wc.RTC_ERR_CODE_WEBRTC_UNSUPPORTED,"browser not support: ".concat(navigator.userAgent));if(!("WebSocket"in window))throw new qc(Wc.RTC_ERR_CODE_WEBRTC_UNSUPPORTED,"WebSocket error");if(!window.RTCPeerConnection)throw new qc(Wc.RTC_ERR_CODE_WEBRTC_UNSUPPORTED,"RTCPeerConnection Object not exist");try{(new RTCPeerConnection).close()}catch(kD){throw new qc(Wc.RTC_ERR_CODE_WEBRTC_UNSUPPORTED,"RTCPeerConnection construct error: ".concat(kD.message))}if(!("mediaDevices"in navigator))throw new qc(Wc.RTC_ERR_CODE_MEDIA_UPSTREAM_UNSUPPORTED,"navigator.mediaDevices is not supported");return!bR.isMobileWeChatBrowser()||!e||await dw.checkwWeChatSupported()}static async checkwWeChatSupported(){let e=[".*(iphone|ipad).*OS\\s1[4-9]_.*MicroMessenger.*",".*huawei.*(TBS|XWEB).*MicroMessenger.*",".*honor.*(TBS|XWEB).*MicroMessenger.*"];if(localStorage){const r=JSON.parse(localStorage.getItem("supportDeviceWhiteList")||"{}");var t;if(bR.getCurrentTimestamp()-parseInt(r.expire||"0")<=3e4)e=r.rules;else null===(t=localStorage)||void 0===t||t.removeItem("supportDeviceWhiteList")}if(dw.checkSupportByRegexRules(e))return!0;try{const e=await oA.fetch(JC,{},{"Cache-Control":"no-cache"},2e3);if(e.data){var r;const t=e.data;if(t.expire=bR.getCurrentTimestamp(),null===(r=localStorage)||void 0===r||r.setItem("supportDeviceWhiteList",JSON.stringify(t)),dw.checkSupportByRegexRules(t.rules))return!0}else{var i;null===(i=localStorage)||void 0===i||i.removeItem("supportDeviceWhiteList")}throw new Error("browser not support")}catch(kD){throw new qc(Wc.RTC_ERR_CODE_WEBRTC_UNSUPPORTED,"browser not support: ".concat(navigator.userAgent))}}static checkSupportByRegexRules(e){const t=navigator.userAgent;let r=!1;for(const i of e){if(new RegExp(i,"ig").test(t)){r=!0;break}}return r}static isRTCScreenShareSupported(){return"mediaDevices"in navigator&&"getDisplayMedia"in navigator.mediaDevices}static isChrome(){return"chrome"===uw.browserDetails.browser}static isFirefox(){return"firefox"===uw.browserDetails.browser}static getBrowserVersion(){if("safari"===uw.browserDetails.browser){const e=/.*Version\/(\d+).*/gi.exec(navigator.userAgent);if(e&&2===e.length)return parseInt(e[1])}return"chrome"===uw.browserDetails.browser?uw.browserDetails.version||91:uw.browserDetails.version}static isOnlySupportUnfiedPlan(){let e=!0;if("chrome"===uw.browserDetails.browser){e=dw.getBrowserVersion()>90}else"safari"===uw.browserDetails.browser&&(e=uw.browserDetails.supportsUnifiedPlan);return e}static getBrowserInfo(){return"".concat(uw.browserDetails.browser.toLowerCase(),"-").concat(dw.getBrowserVersion())}}function lw(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function hw(e,t,r){e.addEventListener?e.addEventListener(t,r,!1):e.attachEvent("on".concat(t),r)}function fw(e){for(var t=e.split("&"),r=0;r<t.length;r++)if(t[r].split("=")[0].toLocaleLowerCase()==="token".toLocaleLowerCase()){t.splice(r,1);break}return t.join("&")}function pw(e){var t=[];for(var r in e){var i=e[r];if(i.constructor===Array)for(var n in i)t.push(r+"="+i[n]);else t.push(r+"="+i)}return t.join("&")}function mw(){var e=new Uint8Array(16);return(window.crypto||window.webkitCrypto||window.mozCrypto||window.oCrypto||window.msCrypto).getRandomValues(e),Array.from(e,(function(e){return("0"+e.toString(16)).substr(-2)})).join("")}function gw(){return window&&void 0!==window.XMLHttpRequest}function _w(){return window&&window.navigator&&void 0!==window.navigator.sendBeacon}var Sw=function(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()},vw=function(e){return"object"===Sw(e)},yw=function(e){return"string"===Sw(e)},Iw=function(e){return"number"===Sw(e)},Tw=function(e){return"boolean"===Sw(e)},Rw=function(e){if(!e)return null;var t=new RegExp("(^|;)[ ]*"+e+"=([^;]*)").exec(document.cookie);return t?decodeURIComponent(t[2]):0},Ew=function(e,t,r,i,n,o){if(e&&!/^(?:expires|max-age|path|domain|secure)$/i.test(e)){var s="";r&&(s=new Date).setTime(s.getTime()+r),document.cookie="".concat(e,"=").concat(encodeURIComponent(t))+(r?"; expires="+s.toGMTString():"")+"; path="+(i||"/")+(n?"; domain="+n:"")+(o?"; secure":"")}},bw=function(e){var t=new Date;t.setTime(t.getTime()-1);var r=Rw(e);null!=r&&(document.cookie=e+"="+r+";expires="+t.toUTCString()+";path=/")},Cw={get:function(e){return window.localStorage.getItem(e)},set:function(e,t){try{window.localStorage.setItem(e,t)}catch(e){if("QuotaExceededError"===e.name)throw new Error(e.name);console.log(e)}},parse:function(e){var t;try{t=JSON.parse(this.get(e))||null}catch(e){console.log(e)}return t},remove:function(e){window.localStorage.removeItem(e)},isSupport:function(){var e=!0;try{var t="__local_store_support__",r="testIsSupportStorage";this.set(t,r),this.get(t)!==r&&(e=!1),this.remove(t)}catch(t){e=!1}return e},length:function(){return window.localStorage.length},key:function(e){return window.localStorage.key(e)}},Aw=0,ww=0,kw=!0,Ow=(new Date).getTime();function Pw(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"HW_";return e&&Kw.globals.idsite?(t+e+"_"+Kw.globals.idsite+"_"+location.host).replace(/\./g,"_"):""}function Mw(){var e=(new Date).getTime(),t=e+500;if(Kw.config.isInit&&Kw.config.useCookie&&Ew(Pw("viewts"),e,31536e6,"/"),Dw(),Kw.config.baseinfotypeSwitch2&&Uw("baseinfotype",{eventTime:e}),Hw.intervalID&&clearInterval(Hw.intervalID),t){var r,i=0;do{if(r=new Date,++i>1e3)break}while(r.getTime()<t)}}function Dw(){if("hidden"===document.visibilityState&&Kw.config.batchSend&&Kw.batchSendNow(),kw){var e=(new Date).getTime();Aw+=e-(ww||Ow)}else ww=(new Date).getTime();kw=!kw}function Nw(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];Kw.config.baseinfotypeSwitch1&&Uw("baseinfotype",{eventTime:(new Date).getTime()},e,t),document.removeEventListener("DOMContentLoaded",Nw,!1)}function Uw(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(""!==Kw.globals.idsite){Fw();var n=Hw.getEventData(e,t);Kw.config.batchSend&&!i?Hw.addToStorage(n,r):Hw.onceSend(n,r)}else console.error("idsite is empty")}function xw(e,t,r){if(Kw.config.serverUrl)if(Kw.config.batchSend&&r)Bw(e,t);else if(Kw.config.requestMode)switch(Kw.config.requestMode){case"beacon":Yw(e);break;case"ajax":gw()?Bw(e,t):Yw(e);break;case"img":Vw(e)}else Kw.config.isImg?Vw(e):_w()?Yw(e):gw()?Bw(e,t):Vw(e);else console.error("serverUrl is empty")}function Lw(){var e="",t=Kw.globals.idsite,r=Kw.config,i=r.debugMode,n=r.customUrlParams,o=r.serverUrl;return i&&(e="x_hasdk_debug=true"),e=e?e+"&idsite="+t:"idsite="+t,pw(n)&&(e=e+"&"+pw(n)),o+"?"+e}function Bw(e,t){var r=pw(e),i=new XMLHttpRequest;for(var n in i.open("POST",Lw(),!0),Kw.config.defaultHeaders)i.setRequestHeader(n,Kw.config.defaultHeaders[n]);Kw.config.batchSend&&(i.timeout=Kw.config.batchSend.timeout),i.send(r),i.onreadystatechange=function(){i.readyState==i.DONE&&t&&"function"==typeof t&&t(i)}}function Vw(e){var t=pw(e);Kw.config.debugMode&&(t="x_hasdk_debug=true&"+t);var r=new Image(1,1);r.onerror=function(){},r.src=Kw.config.serverUrl+"?"+t}function Yw(e){var t=pw(e),r=new Blob([t],{type:"application/x-www-form-urlencoded;charset=UTF-8"});navigator.sendBeacon(Lw(),r)}function jw(){if(Kw.config.isInit=!0,Kw.config.useCookie){var e=Pw("id"),t=Pw("idts"),r=Rw(e),i=Rw(t);r||(r=mw(),Ew(e,r,31536e6,"/"),i=(new Date).getTime(),Ew(t,i,31536e6,"/")),Kw.globals.id=r,Kw.globals.idts=i||(new Date).getTime();var n=Pw("refts"),o=Rw(n);o||document.referrer&&(o=(new Date).getTime(),Ew(n,o,15552e6,"/")),Kw.globals.refts=o||(new Date).getTime();var s=Pw("viewts"),a=Rw(s);Kw.globals.viewts=a||(new Date).getTime();var c=Pw("idvc"),u=Rw(c);u=u?Number(u)+1:1,Ew(c,u,31536e6,"/"),Kw.globals.idvc=u}else Kw.globals.id="unknown",Kw.globals.idts=(new Date).getTime(),Kw.globals.refts=(new Date).getTime(),Kw.globals.viewts=(new Date).getTime(),Kw.globals.idvc=0;Fw()}function Fw(){var e=Pw("idn"),t=Rw(e);t||(t=mw()),Kw.globals.idn=t,Kw.config.useCookie&&Ew(e,t,Kw.config.intervalTime,"/")}var Hw={state:0,keys:[],queue:[],intervalID:null,init:function(){var e=this;Kw.config.batchSend?!this.intervalID&&Kw.config.batchSend.interval&&(this.intervalID=setInterval((function(){e.batchSend()}),Kw.config.batchSend.interval)):this.intervalID&&clearInterval(this.intervalID)},getEventData:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=Kw.globals,i=r.title,n=r.id,o=r.CXX,s=r.idsite,a=r.uid,c=r.cvar,u=r.idts,d=r.idvc,l=r.idn,h=r.refts,f=r.viewts,p=Kw.config.usedPageUrl,m={url:fw(p?window.location.href:"/"),title:i,at:Ow,rf:fw(document.referrer)};"baseinfotype"===e?(m.res="".concat(window.screen.width," X ").concat(window.screen.height),m.cwt=t.eventTime,m.dt=Aw):"customEvent"===e||"clickEvent"===e?(m.en=t.eventName,m.el=t.eventLabel,m.cd=t.customData):"elementEvent"===e&&(m.ei=t.elementId===document?"#document":t.elementId,m.ec=t.cls,m.ps=t.position,m.data=t.data||"");var g={type:e,vf:n,rt:t.eventTime,ut:navigator.userAgent.match(/AppleWebKit.*Mobile.*/)?-1!==navigator.userAgent.indexOf(" wv")?2:1:0,cxx:o,idsite:s,suid:a,cvar:t.cvar||c,idts:u,idvc:d,idn:l,refts:h,viewts:f,hsv:"2.1.7-500",data:m};return g},getFinalSendData:function(e){var t=new Date,r=Kw.globals,i=r.title,n=r.id,o=r.idsite,s=r.cvar,a=r.idts,c=r.idvc,u=r.idn,d=r.refts,l=r.viewts,h=Kw.config.usedPageUrl;return{action_name:encodeURIComponent(i),idsite:encodeURIComponent(o),rec:"1",r:"886244",h:t.getHours(),m:t.getMinutes(),s:t.getSeconds(),url:encodeURIComponent(fw(h?window.location.href:"/")),_id:encodeURIComponent(n),_idts:a,_idvc:c,_idn:u,urlref:document.referrer,_refts:d,_viewts:l,scd:"24",vpr:"".concat(window.screen.width," X ").concat(window.screen.height),cvar:encodeURIComponent(e.cvar||s),pdf:"1",qt:"0",data:encodeURIComponent(JSON.stringify(e))}},batchSend:function(){var e=this,t=this.getEventsToSendFromStorage();0!==t.length&&(this.state=1,xw(this.getFinalSendData(t),(function(t){e.state=0,200===t.status&&e.keys.forEach((function(e){Cw.remove(e)})),e.batchSend(),e.queue.length>0&&(e[e.queue[0][0]].apply(e,Array.prototype.slice.call(e.queue[0][1])),e.queue=e.queue.splice(0,1))}),!0))},onceSend:function(e,t){xw(this.getFinalSendData(e),t,!1)},addToStorage:function(e,t){try{Cw.set(Pw(mw(),"HWBS_"),JSON.stringify(e))}catch(fw){"QuotaExceededError"===fw.message&&(Hw.onceSend(e,t),Hw.batchSend())}},getEventsToSendFromStorage:function(){var e=[],t=Cw.length();t>=Kw.config.batchSend.maxLength&&(t=Kw.config.batchSend.maxLength);for(var r=0;r<t;r++){var i=Cw.key(r);0===i.indexOf("HWBS_")&&(this.keys.push(i),e.push(JSON.parse(Cw.get(i))))}return e}},Kw={config:{serverUrl:"",useCookie:!0,isInit:!1,usedPageUrl:!0,requestMode:"",isImg:!1,debugMode:!1,baseinfotypeSwitch1:!1,baseinfotypeSwitch2:!1,intervalTime:18e5,customUrlParams:{},defaultHeaders:{"Content-type":"application/x-www-form-urlencoded;charset=UTF-8"},batchSend:!1},globals:{idsite:"",title:document.title,id:"unknown",idts:(new Date).getTime(),idvc:1,idn:"",refts:(new Date).getTime(),viewts:(new Date).getTime(),CXX:"",uid:"",cvar:""},push:function(){for(var e,t,r=0;r<arguments.length;r+=1){e=(t=arguments[r]).shift();try{"string"==typeof e||e instanceof String?this[e].apply(this,t):this.apply(this,t)}catch(t){console.error("Invalid method:"+e+", please check!")}}return this},setBaseinfotypeSwitch:function(e){return Tw(e)?(this.config.baseinfotypeSwitch1=e,this):(console.error("baseinfotypeSwitch1 type should be boolean."),this)},setWindowCloseSwitch:function(e){return Tw(e)?(this.config.baseinfotypeSwitch2=e,this):(console.error("baseinfotypeSwitch2 type should be boolean."),this)},setSessionTimeoutDuration:function(e){return Iw(e)?(this.config.intervalTime=e,this):(console.error("intervalTime type should be number."),this)},setHttpHeader:function(e){return vw(e)?(Object.assign(this.config.defaultHeaders,e),this):(console.error("customheader type should be object."),this)},setCustomUrlParams:function(e){if(!vw(e))return console.error("customUrlParams type should be object"),this;for(var t in e){if(-1!==["x_hasdk_debug","url","_id","_idts","_idvc","h","m","s"].indexOf(t))return console.error("customUrlParams can'n include x_hasdk_debug, url, _id, _idts, _idvc, h, m, s"),this;var r=e[t];if(!r||!Iw(r)&&!yw(r))return console.error("customUrlParams object value should be number or string"),this;if(!new RegExp("^[a-zA-Z0-9_./][A-Za-z0-9_./]*$").test(t)||!new RegExp("^[a-zA-Z_0-9_./][A-Za-z0-9_./]*$").test(r))return console.error("customUrlParams object include invalid key or value"),this;Object.assign(this.config.customUrlParams,lw({},t,e[t]))}return this},setIstUseUrl:function(e){return Tw(e)?(this.config.usedPageUrl=e,this):(console.error("usedPageUrl type should be boolean."),this)},setIsUseCookie:function(e){if(!Tw(e))return console.error("useCookie type should be boolean"),this;if(this.config.useCookie=e,!this.config.useCookie){for(var t=document.cookie.split("; "),r=/^(HW_)(id|idts|idvc|idn|viewts|refts)_/,i=0;i<t.length;i++){var n=t[i].split("=");r.test(n[0])&&bw(n[0])}jw()}return this},setDebugMode:function(e){return Tw(e)?(this.config.debugMode=e,this):(console.error("debugMode type should be boolean"),this)},setReportMethod:function(e){return Tw(e)?(this.config.isImg=e,this):(console.error("isImg type should be boolean."),this)},setRequestMode:function(e){return"ajax"!==e||gw()||console.error("XMLHttpRequest is not supported."),"beacon"!==e||_w()||console.error("navigator.sendBeacon() is not supported."),-1!==["beacon","ajax","img"].indexOf(e)&&(this.config.requestMode=e),this},setBatchSend:function(e){if(!Cw.isSupport())return console.error("localStorage is not supported, so batch send is not supported."),this;if(gw()){var t={timeout:6e3,interval:6e3,maxLength:6};return Tw(e)&&e?this.config.batchSend=Object.assign({},t):vw(e)&&(this.config.batchSend=Object.assign(t,e)),Hw.init(),this}console.error("XMLHttpRequest is not supported, so batch send is not supported.")},setOnReportUrl:function(e){return this.config.serverUrl=e||"",this},setIdsite:function(e){return yw(e)?new RegExp("^[a-zA-Z0-9_./][A-Za-z0-9_./]*$").test(e)?(this.globals.idsite=e,jw(),this):(console.error("idsite is invalid."),this):(console.error("idsite type should be string."),this)},setTitle:function(e){return this.globals.title=e||"",this},setUserAccount:function(e){return this.globals.id=e||"",this},setUid:function(e){return this.globals.uid=e||"",this},setCXX:function(e){return this.globals.CXX=e||"",this},setPageData:function(e){return this.globals.cvar=e||"",this},sendPageinfo:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return Aw=0,ww=0,kw=!0,Ow=(new Date).getTime(),this.config.baseinfotypeSwitch1=!0,Nw(e,t),this},sendPageClose:function(){return this.config.baseinfotypeSwitch2=!0,Mw(),this},sendData:function(e,t,r,i,n){var o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s={eventTime:(new Date).getTime(),eventName:e||"",eventLabel:t||"",customData:r||"",cvar:i||""};return Uw("customEvent",s,n,o),this},sendClickData:function(e,t,r,i,n){var o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s={eventTime:(new Date).getTime(),eventName:e||"",eventLabel:t||"",customData:r||"",cvar:i||""};return Uw("clickEvent",s,n,o),this},bindclick:function(e,t,r,i,n){var o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s=e===document?document:document.getElementById(e);return s?(hw(s,t,(function(t){var a=t.screenX,c=t.screenY,u=t.clientX,d=t.clientY,l=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,h=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;Uw("elementEvent",{eventTime:(new Date).getTime(),elementId:e,cls:s.className,data:r,cvar:i,position:{res:"".concat(a,"X").concat(c),vpr:"".concat(u,"X").concat(d),doc:"".concat(h,"X").concat(l)}},n,o)})),this):this},batchSendNow:function(){return Hw.batchSend(),this}};Array.of("batchSend").forEach((function(e){var t=Hw[e];Hw[e]=function(){0===Hw.state?t.apply(Hw,arguments):Hw.queue.push([e,arguments])}})),hw(document,"DOMContentLoaded",Nw),hw(window,"beforeunload",(function(){Mw()})),hw(document,"visibilitychange",Dw);const zw={},Ww={grs_sdk_global_route_config_hwrtc:{applications:[],services:[{name:"com.huawei.cloud.videortn",routeBy:"ser_country>geo_ip",servings:[{countryOrAreaGroup:"DR1",addresses:{GLOBAL:"wss://rtc.platform.dbankcloud.com",ROOT:"wss://rtc-drcn.platform.dbankcloud.com"}},{countryOrAreaGroup:"DR2",addresses:{GLOBAL:"wss://rtc.platform.dbankcloud.com",ROOT:"wss://rtc-dra.platform.dbankcloud.com"}},{countryOrAreaGroup:"DR3",addresses:{GLOBAL:"wss://rtc.platform.dbankcloud.com",ROOT:"wss://rtc-dre.platform.dbankcloud.com"}},{countryOrAreaGroup:"DR4",addresses:{GLOBAL:"wss://rtc.platform.dbankcloud.com",ROOT:"wss://rtc-drru.platform.dbankcloud.com"}}],countryOrAreaGroups:[]}],countryOrAreaGroups:[{id:"DR1",name:"China",countriesOrAreas:["CN"],description:"China zone"},{id:"DR2",name:"Asian-African-Latin American",countriesOrAreas:["AE","AF","AG","AI","AM","AO","AQ","AR","AS","AW","AZ","BB","BD","BF","BH","BI","BJ","BL","BM","BN","BO","BR","BS","BT","BV","BW","BY","BZ","CC","CD","CF","CG","CI","CK","CL","CM","CO","CR","CU","CV","CX","DJ","DM","DO","DZ","EC","EG","EH","ER","ET","FJ","FK","FM","GA","GD","GE","GF","GH","GM","GN","GP","GQ","GS","GT","GU","GW","GY","HK","HM","HN","HT","ID","IN","IO","IQ","JM","JO","JP","KE","KG","KH","KI","KM","KN","KP","KR","KW","KY","KZ","LA","LB","LC","LK","LR","LS","LY","MA","MG","MH","ML","MM","MN","MO","MP","MQ","MR","MS","MU","MV","MW","MX","MY","MZ","NA","NC","NE","NF","NG","NI","NP","NR","NU","OM","PA","PE","PF","PG","PH","PK","PN","PR","PS","PW","PY","QA","RE","RW","SA","SB","SC","SD","SG","SH","SL","SN","SO","SR","SS","ST","SV","SY","SZ","TC","TD","TF","TG","TH","TJ","TK","TL","TM","TN","TO","TT","TV","TW","TZ","UG","UY","UZ","VE","VG","VI","VN","VU","WF","WS","YE","YT","ZA","ZM","ZW"],description:"Asian-African-Latin American zone"},{id:"DR3",name:"Europe",countriesOrAreas:["AD","AL","AN","AT","AU","AX","BA","BE","BG","BQ","CA","CH","CW","CY","CZ","DE","DK","EE","ES","FI","FO","FR","GB","GG","GI","GL","GR","HR","HU","IE","IL","IM","IS","IT","JE","LI","LT","LU","LV","MC","MD","ME","MF","MK","MT","NL","NO","NZ","PL","PM","PT","RO","RS","SE","SI","SJ","SK","SM","SX","TR","UA","UM","US","VA","VC","XK","YK"],description:"Europe zone"},{id:"DR4",name:"Russia",countriesOrAreas:["RU"],description:"Russia zone"},{id:"DR5",name:"A2",countriesOrAreas:["IR"],description:"A2 zone"}]},grs_sdk_global_route_config_rtcha:{applications:[],services:[{name:"com.huawei.cloud.hianalytics",routeBy:"ser_country",servings:[{countryOrAreaGroup:"DR1",addresses:{ROOT:"https://metrics1.data.hicloud.com:6447"}},{countryOrAreaGroup:"DR2",addresses:{ROOT:"https://metrics3.data.hicloud.com:6447"}},{countryOrAreaGroup:"DR3",addresses:{ROOT:"https://metrics2.data.hicloud.com:6447"}},{countryOrAreaGroup:"DR4",addresses:{ROOT:"https://metrics5.data.hicloud.com:6447"}},{countryOrAreaGroup:"DR5",addresses:{ROOT:"https://metrics4.data.hicloud.com:6447"}}],countryOrAreaGroups:[]},{name:"com.huawei.cloud.hianalytics.aspg",routeBy:"ser_country",servings:[{countryOrAreaGroup:"DR1",addresses:{ROOT:"https://metrics1.data.hicloud.com:6447"}},{countryOrAreaGroup:"DR2",addresses:{ROOT:"https://metrics-dra.dt.hicloud.com:6447"}},{countryOrAreaGroup:"DR3",addresses:{ROOT:"https://metrics2.data.hicloud.com:6447"}},{countryOrAreaGroup:"DR4",addresses:{ROOT:"https://metrics5.data.hicloud.com:6447"}},{countryOrAreaGroup:"DR5",addresses:{ROOT:"https://metrics4.data.hicloud.com:6447"}}],countryOrAreaGroups:[]}],countryOrAreaGroups:[{id:"DR1",name:"China",countriesOrAreas:["CN"],description:"China zone"},{id:"DR2",name:"Asian-African-Latin American",countriesOrAreas:["AE","AF","AG","AI","AM","AO","AQ","AR","AS","AW","AZ","BB","BD","BF","BH","BI","BJ","BL","BM","BN","BO","BR","BS","BT","BV","BW","BY","BZ","CC","CD","CF","CG","CI","CK","CL","CM","CO","CR","CU","CV","CX","DJ","DM","DO","DZ","EC","EG","EH","ER","ET","FJ","FK","FM","GA","GD","GE","GF","GH","GM","GN","GP","GQ","GS","GT","GU","GW","GY","HK","HM","HN","HT","ID","IN","IO","IQ","JM","JO","JP","KE","KG","KH","KI","KM","KN","KP","KR","KW","KY","KZ","LA","LB","LC","LK","LR","LS","LY","MA","MG","MH","ML","MM","MN","MO","MP","MQ","MR","MS","MU","MV","MW","MX","MY","MZ","NA","NC","NE","NF","NG","NI","NP","NR","NU","OM","PA","PE","PF","PG","PH","PK","PN","PR","PS","PW","PY","QA","RE","RW","SA","SB","SC","SD","SG","SH","SL","SN","SO","SR","SS","ST","SV","SY","SZ","TC","TD","TF","TG","TH","TJ","TK","TL","TM","TN","TO","TT","TV","TW","TZ","UG","UY","UZ","VE","VG","VI","VN","VU","WF","WS","YE","YT","ZA","ZM","ZW"],description:"Asian-African-Latin American zone"},{id:"DR3",name:"Europe",countriesOrAreas:["AD","AL","AN","AT","AU","AX","BA","BE","BG","BQ","CA","CH","CW","CY","CZ","DE","DK","EE","ES","FI","FO","FR","GB","GG","GI","GL","GR","HR","HU","IE","IL","IM","IS","IT","JE","LI","LT","LU","LV","MC","MD","ME","MF","MK","MT","NL","NO","NZ","PL","PM","PT","RO","RS","SE","SI","SJ","SK","SM","SX","TR","UA","UM","US","VA","VC","XK","YK"],description:"Europe zone"},{id:"DR4",name:"Russia",countriesOrAreas:["RU"],description:"Russia zone"},{id:"DR5",name:"A2",countriesOrAreas:["IR"],description:"A2 zone"}]}},Gw="RTCReport";const qw=new class{constructor(){this.logger=MR.getLogger(),this.regularReport(KC),Kw.push(["setOnReportUrl","".concat(Ww.grs_sdk_global_route_config_rtcha.services[0].servings[0].addresses.ROOT,"/webv4")]),Kw.push(["setIdsite","com.huawei.rtcsdk"]),Kw.setBatchSend({timeout:13e3,interval:!1,maxLength:200}),this.records=[],dw.isFirefox()||(window.onbeforeunload=()=>{this.logger.info("stat","window is closing, emergency report"),this.records.length>0&&this.reportRecordsBeacon(this.records),this.clearData()})}setReportServer(e){this.opsServer=null;const t=tA.getProxyServer();if(t){const r=e.replace(/http(s)?:\/\//,"");this.opsServer="".concat(t,"/").concat(r,"/webv4")}else this.opsServer="".concat(e,"/webv4");Kw.push(["setOnReportUrl",this.opsServer])}regularReport(e){this.reportInterval&&clearInterval(this.reportInterval),this.reportInterval=setInterval((()=>{if(this.opsServer&&0!=this.records.length)try{Kw.setRequestMode("ajax"),this.records.forEach((e=>{const t=e.event.toString(),r={rtc_sdk:e};Kw.push(["sendData",t,t,r,null,null])})),this.clearData(),Kw.batchSendNow()}catch(kD){this.logger.error(Gw,"regularReport failed")}}),e)}async addRecords(e){this.records=this.records.concat(e||[]),this.adjustRecordsLength(this.records)}async addRecord(e){this.records.push(e),this.adjustRecordsLength(this.records)}adjustRecordsLength(e){e.length>1e4&&e.splice(0,e.length-1e4)}clearData(){this.records.length=0}immediateReportRecords(){this.opsServer&&(this.reportRecords(this.records),this.clearData())}reportRecords(e){if(this.opsServer)try{Kw.setRequestMode("ajax"),e.forEach((e=>{const t=e.event.toString(),r={rtc_sdk:e};Kw.push(["sendData",t,t,r,null,t=>{4===t.readyState&&200===t.status||this.addRecord(e)},!0])}))}catch(kD){throw this.logger.error(Gw,"fetch request failed"),kD}}async reportRecordsBeacon(e){if(this.opsServer)try{Kw.setRequestMode("beacon"),e.forEach((e=>{const t=e.event.toString(),r={rtc_sdk:e};Kw.push(["sendData",t,t,r,null,null,!0])}))}catch(kD){throw this.logger.error(Gw,"beacon request failed"),kD}}},Jw="STATISTIC_ENABLE",Xw="ACCESS_RESOURCE_TYPE",Qw="RESOURCE_TAGS",$w="FRAME_ENCRYPTION_MODE",Zw="PORT_TYPE",ek="ENVIRONMENT_SUFFIX",tk="GRS_LOCAL_EXT_INFO",rk={ACCESS_RESOURCE_TYPE:e=>eA.checkSFUResourceType(e),RESOURCE_TAGS:e=>eA.checkResourceTags(e)},ik="ParametersUtil";const nk=new class{constructor(){this.logger=MR.getLogger(),this.parameters=new Map}setParameter(e,t){if(!e)return this.logger.error(ik,"setParameter, parameterKey is null"),!1;try{return this.logger.debug(ik,"setParameter, parameterKey: ".concat(e,", parameterValue: ").concat(t)),rk[e]&&rk[e](t),this.parameters.set(e.toLowerCase(),t),!0}catch(kD){return this.logger.error(ik,"setParameter occur error: ".concat(kD)),!1}}getParameter(e){try{return e&&this.parameters.has(e.toLowerCase())?this.parameters.get(e.toLowerCase()):null}catch(kD){return this.logger.error(ik,"getParameter occur error: ".concat(kD)),null}}};let ok,sk,ak,ck,uk;!function(e){e.TRACK_TYPE_AUDIO="audio",e.TRACK_TYPE_VIDEO="video",e.TYPE_APPLICATION="application"}(ok||(ok={})),function(e){e.STREAM_TYPE_MAIN="main",e.STREAM_TYPE_AUX="aux"}(sk||(sk={})),function(e){e[e.USER_SUBSCRIBE_AUDIOPOLICY=0]="USER_SUBSCRIBE_AUDIOPOLICY",e[e.TOPN_AUDIOPOLICY=1]="TOPN_AUDIOPOLICY"}(ak||(ak={})),function(e){e[e.USER_SUBSCRIBE_AUDIOPOLICY=2]="USER_SUBSCRIBE_AUDIOPOLICY",e[e.TOPN_AUDIOPOLICY=3]="TOPN_AUDIOPOLICY"}(ck||(ck={})),function(e){e[e.COMMON_SFU_RESOURCE=0]="COMMON_SFU_RESOURCE",e[e.COMPANY_SFU_RESOURCE=1]="COMPANY_SFU_RESOURCE",e[e.MPC_SFU_RESOURCE=2]="MPC_SFU_RESOURCE",e[e.LLL_SFU_RESOURCE=3]="LLL_SFU_RESOURCE"}(uk||(uk={}));let dk,lk,hk;!function(e){e[e.NETWORK_QUALITY_UNKNOW=0]="NETWORK_QUALITY_UNKNOW",e[e.NETWORK_QUALITY_GREAT=1]="NETWORK_QUALITY_GREAT",e[e.NETWORK_QUALITY_GOOD=2]="NETWORK_QUALITY_GOOD",e[e.NETWORK_QUALITY_DEFECTS=3]="NETWORK_QUALITY_DEFECTS",e[e.NETWORK_QUALITY_WEAK=4]="NETWORK_QUALITY_WEAK",e[e.NETWORK_QUALITY_BAD=5]="NETWORK_QUALITY_BAD",e[e.NETWORK_QUALITY_DISCONNECT=6]="NETWORK_QUALITY_DISCONNECT"}(dk||(dk={})),function(e){e[e.NotJoin=0]="NotJoin",e[e.Joined=1]="Joined",e[e.Rejoining=2]="Rejoining"}(lk||(lk={})),function(e){e[e.normal=0]="normal",e[e.resolutionChange=1]="resolutionChange",e[e.remoteRejoinCache=2]="remoteRejoinCache",e[e.localRejoin=3]="localRejoin"}(hk||(hk={}));const fk={"90p-":{width:120,height:90},"90p":{width:160,height:90},"120p":{width:160,height:120},"180p-":{width:240,height:180},"180p":{width:320,height:180},"240p":{width:320,height:240},"270p":{width:480,height:270},"300p":{width:400,height:300},"360p-":{width:480,height:360},"360p":{width:640,height:360},"450p":{width:800,height:450},"480p":{width:640,height:480},"540p":{width:960,height:540},"630p":{width:1120,height:630},"720p-":{width:960,height:720},"720p":{width:1280,height:720},"1080p":{width:1920,height:1080}};class pk{static getResolution(e,t){const r=Math.min(e,t);return r<180?"LD":r<360?"SD":r<720?"HD":"FHD"}static getResolutionType(e,t){return Object.keys(fk).find((r=>fk[r].width===e&&fk[r].height===t))}}class mk{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50;this.elements=new Array(e+1),this.front=0,this.tail=0,this._size=0}getCapacity(){return this.elements.length-1}isEmpty(){return this.front===this.tail}size(){return this._size}push(e){this._size===this.getCapacity()&&this.dequeue(),this.elements[this.tail]=e,this.tail=(this.tail+1)%this.elements.length,this._size++}dequeue(){if(this.isEmpty())throw new Error("Cannot dequeue from an empty queue.");const e=this.elements[this.front];return this.elements[this.front]=null,this.front=(this.front+1)%this.elements.length,this._size--,e}getFront(){return this.isEmpty()?null:this.elements[this.front]}getTail(){if(this.isEmpty())return null;const e=0===this.tail?this.elements.length-1:this.tail-1;return this.elements[e]}getElement(e){return e<0||e>=this.size()?null:this.elements[(this.front+e)%this.elements.length]}}const gk=new class{constructor(){t(this,"isFireFox",dw.isFirefox()),this.reportSymbol=Symbol("RTCInterval_".concat(bR.getCurrentTimestamp())),this.mapInterval=new mk}getSymbol(){return this.reportSymbol}reset(){delete this.mapInterval,this.mapInterval=new mk,clearTimeout(this.gatherTimer),this.gatherTimer=null}addConnection(e,t){this.connectionsManagers||(this.connectionsManagers=new Map),this.connectionsManagers.set(e,t),this.execMyInterval((async()=>{await this.execInterval()}),100)}checkIsMediaStatsType(e){return["inbound-rtp","outbound-rtp","remote-inbound-rtp","remote-outbound-rtp"].includes(e.type)}checkCandidatePair(e){const t="candidate-pair"===e.type.toString()&&"succeeded"===e.state.toString();return this.isFireFox?t&&e.selected:t}async getStatsData(e,t){const r=await(null==t?void 0:t.getStats());r&&r.forEach(((t,r)=>{this.checkIsMediaStatsType(t)?e.set(t.type+"-"+t.kind+"_"+t.ssrc,t):this.checkCandidatePair(t)?(t.currentRoundTripTime=t.currentRoundTripTime||Math.abs(t.lastPacketReceivedTimestamp-t.lastPacketSentTimestamp),e.set(t.type,t)):"track"===t.type.toString()&&e.set(r,t)}))}async getData(e,t,r){const i=e.getConnection(r);await this.getStatsData(t,i)}async execInterval(){const e=new Map;for(const t of this.connectionsManagers.keys()){const r=new Map,i=new Map,n=new Map,o=[];o.push(this.getData(this.connectionsManagers.get(t),i,sk.STREAM_TYPE_MAIN)),o.push(this.getData(this.connectionsManagers.get(t),n,sk.STREAM_TYPE_AUX)),await Promise.all(o),r.set(sk.STREAM_TYPE_MAIN,i),r.set(sk.STREAM_TYPE_AUX,n),e.set(t,r)}this.mapInterval.push(e)}getLatestRemoteInboundStats(e,t,r){var i,n;const o=null===(i=this.mapInterval.getTail())||void 0===i||null===(n=i.get(e))||void 0===n?void 0:n.get(t);if(this.isFireFox){const t=r.split("_"),i=parseInt(t[1]),n=this.connectionsManagers.get(e).getMappingSsrcs(i),s=t[0].concat("_").concat(n).toString();return o&&o.get(s)}return o&&o.get(r)?o.get(r):null}getLatestStatsByTrackId(e,t,r){var i,n;const o=null===(i=this.mapInterval.getTail())||void 0===i||null===(n=i.get(e))||void 0===n?void 0:n.get(t);return o&&o.get(r)?o.get(r):null}getLatestReport(e,t){var r,i;return null===(r=this.mapInterval.getTail())||void 0===r||null===(i=r.get(e))||void 0===i?void 0:i.get(t)}getLatestStats(e,t,r){const i=this.getLatestReport(e,t);return this.getStatsBySsrcLabel(i,r,e)}getElementStats(e,t,r,i){var n,o;const s=null===(n=this.mapInterval.getElement(i))||void 0===n||null===(o=n.get(e))||void 0===o?void 0:o.get(t);return this.getStatsBySsrcLabel(s,r,e)}getStatsBySsrcLabel(e,t,r){if(!e)return null;if(this.isFireFox){const i=t.split("_"),n=parseInt(i[1]),o=this.connectionsManagers.get(r).getMappingSsrcs(n),s=i[0].concat("_").concat(o).toString();return e.get(s)}return e.get(t)}getLatestValue(e,t,r,i){const n=this.getLatestStats(e,t,r);return n?n[i]:null}getAllNumber(e,t,r,i){const n=this.mapInterval.size(),o=new Array(n);for(let s=0;s<n;s++){const n=this.getElementStats(e,t,r,s);o[s]=n?n[i]:null}return o}getFreeze(e,t,r,i,n){const o=this.getAllNumber(e,t,r,i),s=o.length;let a=0,c=0;for(let u=1;u<s;u++)o[u-1]&&o[u]&&o[u-1]===o[u]?a+=100:(a>n&&(c+=a),a=0);return a>n&&(c+=a),c}execMyInterval(e,t){const r=()=>{this.gatherTimer=setTimeout((()=>{e(),r()}),t)};e(),r()}};class _k{constructor(e){t(this,"videoFreezeKey",dw.isFirefox()?"packetsReceived":"framesReceived"),t(this,"mediaStatInfo",[]),t(this,"mediaStatDebugInfo",[]),t(this,"mediaStatSumInfo",[]),t(this,"mediaStatSumDebugInfo",[]),t(this,"ACSAddr",""),t(this,"SFUAddr",""),t(this,"lastSenderInfo",new Map),t(this,"lastSenderDebugInfo",new Map),t(this,"encryUserId",new Map),t(this,"remoteStreamInfo",[]),t(this,"audioPolicy",ak.USER_SUBSCRIBE_AUDIOPOLICY),t(this,"LocalStreamInfo",new Map),t(this,"auxsStreamInfo",new Map),t(this,"audioReceiveInfo",{audioReceivePackets:new Map,audioReceivePacketsLost:new Map,audioReceiveBytes:new Map}),t(this,"videoReceiveInfo",{videoReceivePackets:new Map,videoReceivePacketsLost:new Map,videoReceiveBytes:new Map,videoReceiveFrame:new Map}),t(this,"audioReceiveDebugInfo",{audioReceivePackets:new Map,audioReceivePacketsLost:new Map,audioReceiveBytes:new Map}),t(this,"videoReceiveDebugInfo",{videoReceivePackets:new Map,videoReceivePacketsLost:new Map,videoReceiveBytes:new Map,videoReceiveFrame:new Map}),t(this,"inBoundAudioSsrcInfos",[]),t(this,"audioPolicyLastCycle",ak.USER_SUBSCRIBE_AUDIOPOLICY),t(this,"audioStreamReceiverMap",new Map),t(this,"ssrcChangeCount",0),t(this,"audioStreamInfos",[]),t(this,"audioCount",0),t(this,"audioStreamAllInfos",[]),t(this,"audioAllCount",0),t(this,"audioStreamTop3Count",0),t(this,"module_","MediaStats"),t(this,"tempStat",{bytesSent:0,bytesReceived:0,sendBitrate:0,recvBitrate:0,rtt:0,upPktsLostRate:0,downPktsLostRate:0}),t(this,"stat",{bytesSent:0,bytesReceived:0,sendBitrate:0,recvBitrate:0,rtt:0,upPktsLostRate:0,downPktsLostRate:0}),t(this,"audioLevelInfo",{localAudio:new Map,remoteAudio:new Map,top3Audio:new Map}),t(this,"remoteUserMuteStatus",new Map),this.logger=e}setEncryInfo(e,t){this.encryUserId.set(e,t)}getEncryInfo(e){return this.encryUserId.get(e)}clearEncryUserId(){this.encryUserId.clear()}setRemoteUserManager(e){this.remoteUserManager=e}setStartSsrc(e){this.startSsrc=e}updateAudioLevel(e){if("local"===e.type){if(!this.audioLevelInfo.localAudio.get("local")){const e=[];this.audioLevelInfo.localAudio.set("local",e)}this.audioLevelInfo.localAudio.get("local").push(e.level)}else if("remoteTop3"===e.type){if(!this.audioLevelInfo.top3Audio.get("".concat(null==e?void 0:e.ssrc))){const t=[];this.audioLevelInfo.top3Audio.set("".concat(null==e?void 0:e.ssrc),t)}this.audioLevelInfo.top3Audio.get("".concat(null==e?void 0:e.ssrc)).push(e.level)}else{if(!this.audioLevelInfo.remoteAudio.get("".concat(null==e?void 0:e.ssrc,"_").concat(null==e?void 0:e.userId))){const t=[];this.audioLevelInfo.remoteAudio.set("".concat(null==e?void 0:e.ssrc,"_").concat(null==e?void 0:e.userId),t)}this.audioLevelInfo.remoteAudio.get("".concat(null==e?void 0:e.ssrc,"_").concat(null==e?void 0:e.userId)).push(e.level)}}getAudioLevel(e,t,r){let i=0,n=0;return"local"===e&&this.audioLevelInfo.localAudio.get("local")?(this.audioLevelInfo.localAudio.get("local").forEach((e=>{i+=e||0,n++})),this.audioLevelInfo.localAudio.clear()):"remoteTop3"===e&&this.audioLevelInfo.top3Audio.get("".concat(t))?(this.audioLevelInfo.top3Audio.get("".concat(t)).forEach((e=>{i+=e||0,n++})),this.audioLevelInfo.top3Audio.clear()):"remote"===e&&this.audioLevelInfo.remoteAudio.get("".concat(t,"_").concat(r))&&(this.audioLevelInfo.remoteAudio.get("".concat(t,"_").concat(r)).forEach((e=>{i+=e||0,n++})),this.audioLevelInfo.remoteAudio.clear()),0===n?0:Math.ceil(i/n)}setConnectionsManager(e){this.logger.info(this.module_,"setConnectionsManager"),this.connectionsManager=e}setSubscribeInfo(e){var t,r,i,n;if(!e)return;const o=this.remoteStreamInfo.find((t=>t.userId===e.userId));if(!o)return this.clearRemoteStreamInfoCache(e),void this.remoteStreamInfo.push(e);(null===(t=e.mainStream)||void 0===t||null===(r=t.tracks)||void 0===r?void 0:r.length)>0&&e.mainStream.tracks.forEach((t=>{o.mainStream.tracks.find((e=>e.trackId===t.trackId))||(this.doClearRemoteStreamInfoCache(e,e.userId,t.cssrc),o.mainStream.tracks.push(t))})),(null===(i=e.auxStream)||void 0===i||null===(n=i.tracks)||void 0===n?void 0:n.length)>0&&e.auxStream.tracks.forEach((t=>{o.auxStream.tracks.find((e=>e.trackId===t.trackId))||(this.doClearRemoteStreamInfoCache(e,e.userId,t.cssrc),o.auxStream.tracks.push(t))}))}doClearRemoteStreamInfoCache(e,t,r){let i=null;if(e.mainStream.tracks.forEach((e=>{e.cssrc===r&&(i=e.type)})),e.auxStream.tracks.forEach((e=>{e.cssrc===r&&(i=e.type)})),i===ok.TRACK_TYPE_AUDIO){const e="".concat(r,"-").concat(t);this.audioReceiveInfo.audioReceivePackets.delete(e),this.audioReceiveInfo.audioReceivePacketsLost.delete(e),this.audioReceiveInfo.audioReceiveBytes.delete(e)}else if(i===ok.TRACK_TYPE_VIDEO){const e="".concat(r,"-").concat(t);this.videoReceiveInfo.videoReceivePackets.delete(e),this.videoReceiveInfo.videoReceivePacketsLost.delete(e),this.videoReceiveInfo.videoReceiveBytes.delete(e),this.videoReceiveInfo.videoReceiveFrame.delete(e)}}clearRemoteStreamInfoCache(e){this.remoteStreamInfo.filter((t=>t.userId===e.userId)).forEach((t=>{this.clearRemoteStreamInfoCache4Stream(e,t.mainStream),this.clearRemoteStreamInfoCache4Stream(e,t.auxStream)}))}clearRemoteStreamInfoCache4Stream(e,t){t.tracks.forEach((t=>{const r=t.trackId,i=t.cssrc,n=e.userId;e.mainStream.tracks.forEach((t=>{t.cssrc===i&&t.trackId!==r&&this.doClearRemoteStreamInfoCache(e,n,i)}))}))}clearLocalStreamInfoCache(e){e&&this.LocalStreamInfo.forEach((t=>{e.ssrc===t.ssrc&&e.uid===t.uid&&e.streamId!==t.streamId&&this.lastSenderInfo.delete("".concat(e.ssrc,"-").concat(e.uid))}))}clearAuxsStreamInfoCache(e){e&&this.auxsStreamInfo.forEach((t=>{e.ssrc===t.ssrc&&e.uid===t.uid&&e.streamId!==t.streamId&&this.lastSenderInfo.delete("".concat(e.ssrc,"-").concat(e.uid))}))}setLocalMainStreamInfo(e,t){return!(!t||0===t.length)&&(this.LocalStreamInfo.clear(),t.forEach((t=>{const r={uid:e,streamId:"",ssrc:t.ssrc,type:t.type};t.type===ok.TRACK_TYPE_AUDIO?r.streamId=t.upstream.streamUid.toString():(r.streamId=t.upstream.streamUid.toString(),r.width=t.upstream.width,r.height=t.upstream.height,r.frame=t.upstream.fps),this.clearLocalStreamInfoCache(r),this.LocalStreamInfo.set(t.resolutionId,r)})),!0)}setLocalAuxsStreamInfo(e,t){if(!t)return!1;const r=Array.from(t.localTrackPublishInfos.values());return!!r&&(this.auxsStreamInfo.clear(),r.forEach((r=>{const i={uid:e,streamId:r.upstream.streamUid.toString(),ssrc:r.ssrc,type:r.type};r.type===ok.TRACK_TYPE_VIDEO&&(i.publishInfo={stream:t.localStream}),this.clearAuxsStreamInfoCache(i),this.auxsStreamInfo.set(r.resolutionId,i)})),!0)}deleteSubscribeInfo(e,t,r){if(r||t){if(t){const i=this.remoteStreamInfo.find((t=>t.userId===e));if(!i)return;const n=t===sk.STREAM_TYPE_MAIN?i.mainStream:i.auxStream;n.tracks=r?n.tracks.filter((e=>e.trackId!==r)):null}}else this.remoteStreamInfo=this.remoteStreamInfo.filter((t=>t.userId!==e))}setAudioPolicy(e){this.audioPolicyLastCycle=this.audioPolicy,this.audioPolicy=e,this.setAudioStreamInfo()}setSFUAddr(e){this.SFUAddr=e}setACSAddr(e){this.ACSAddr=e}leaveRoom(){this.mediaStatInfo=[]}getAudioPolicy(){return this.audioPolicy}getTransportMediaStats(){return this.stat}getMediaStatInfo(){const e=this.mediaStatInfo;return this.mediaStatInfo=[],e}getMediaStatSum(){const e=this.mediaStatSumInfo;return this.mediaStatSumInfo=[],e}getInBoundAudioSsrc(){const e=this.inBoundAudioSsrcInfos;return this.inBoundAudioSsrcInfos=[],e}async dealStats(){this.connectionsManager.isConnectionsExist()?(this.getAudioStreamInfo(),await this.getSenderInfo(!1),await this.getReceiverInfo(!1),this.stat.bytesSent+=this.tempStat.bytesSent,this.stat.bytesReceived+=this.tempStat.bytesReceived,this.stat.sendBitrate=this.tempStat.sendBitrate,this.stat.recvBitrate=this.tempStat.recvBitrate,this.clearTempStats()):this.logger.debug(this.module_,"peerConnection is undefined")}clearTempStats(){this.tempStat.bytesSent=0,this.tempStat.bytesReceived=0,this.tempStat.sendBitrate=0,this.tempStat.recvBitrate=0}clearMediaStatBytes(){this.stat.bytesSent=0,this.stat.bytesReceived=0}cleanAudioStreamInfos(){this.audioCount=this.audioStreamInfos.length,this.audioAllCount=this.audioStreamAllInfos.length,this.audioStreamInfos=[],this.audioStreamAllInfos=[]}updateAudioStreamInfos(e,t){if("add"===t){let t=0;this.remoteStreamInfo.forEach((r=>{if(e===r.userId){const e=r.mainStream.tracks.filter((e=>e.streamType===sk.STREAM_TYPE_MAIN&&e.type===ok.TRACK_TYPE_AUDIO));t=e.length>0?e[0].cssrc:0}}));const r={userid:e,audioSsrc:t};this.audioStreamInfos=this.audioStreamInfos.filter((r=>r.userid!=e||r.audioSsrc!=t)),this.audioStreamAllInfos=this.audioStreamAllInfos.filter((r=>r.userid!=e||r.audioSsrc!=t)),this.audioStreamInfos.push(r),this.audioStreamAllInfos.push(r)}"delete"!==t&&"removed"!==t||(this.audioStreamInfos=this.audioStreamInfos.filter((t=>t.userid!==e)),this.audioStreamAllInfos=this.audioStreamAllInfos.filter((t=>t.userid!==e))),this.audioPolicy!==ak.USER_SUBSCRIBE_AUDIOPOLICY&&this.audioCount===this.audioStreamInfos.length||this.ssrcChangeCount++,this.audioPolicy!==ak.TOPN_AUDIOPOLICY&&this.audioAllCount===this.audioStreamAllInfos.length||this.ssrcChangeCount++}updateAudioStreamTop3(e){this.audioStreamTop3CountTimer&&clearTimeout(this.audioStreamTop3CountTimer),this.audioStreamTop3CountTimer=setTimeout((()=>{this.audioStreamTop3Count=0}),4e3),this.audioStreamTop3Count=e}checkAudioStreamInfosIsExist(e,t){return 0!==this.audioStreamInfos.filter((r=>r.userid===e&&r.audioSsrc===t)).length}setAudioStreamInfo(){this.audioPolicy!==this.audioPolicyLastCycle&&(this.ssrcChangeCount=1,this.audioStreamReceiverMap.clear(),this.audioStreamTop3Count=0,this.audioReceiveInfo.audioReceiveBytes.clear(),this.audioReceiveInfo.audioReceivePackets.clear(),this.audioReceiveInfo.audioReceivePacketsLost.clear())}async getAudioStreamInfo(){this.audioPolicy===ak.TOPN_AUDIOPOLICY?await this.buildAudioStreamInfo3():this.audioPolicy===ak.USER_SUBSCRIBE_AUDIOPOLICY?await this.buildAudioStreamInfo2():this.logger.debug(this.module_,"mode 1 not uesed")}async buildAudioStreamInfo3(){const e=[],t={timestamp:bR.getCurrentTimestamp(),event:PC.QoS_DOWN_STREAM_AUDIO_STAT,access_addr:this.ACSAddr,sfu_addr:this.SFUAddr,audio_policy:this.audioPolicy,topn:3,audios_change_cnt:0,audios:e,no_stream_cnt:0};for(let n=0;n<3;n++){var r;const i=this.startSsrc+n,o="".concat(Fb,"_").concat(i),s=gk.getLatestStats(null===(r=this.connectionsManager)||void 0===r?void 0:r.getConnectionId(),sk.STREAM_TYPE_MAIN,o);if(s){const r=this.connectionsManager.calcChangedStatistic(s.id,s.packetsReceived||0,["packetsReceived"])||s.packetsReceived,n=this.audioStreamReceiverMap.get(i)||0;let o=!0;0===r?o=!1:void 0===n?o=!0:r===n&&(o=!1),e.push({ssrc:i,userid:"",packet_cnt:r-n}),this.audioStreamReceiverMap.set(i,r),o||t.no_stream_cnt++}}const i=this.audioAllCount<3?this.audioAllCount:3;if(i<3){const e=t.no_stream_cnt-(3-i);t.no_stream_cnt=e<0?0:e}t.audios_change_cnt=this.ssrcChangeCount,this.inBoundAudioSsrcInfos.push(t)}async buildAudioStreamInfo2(){const e=[],t={timestamp:bR.getCurrentTimestamp(),event:PC.QoS_DOWN_STREAM_AUDIO_STAT,access_addr:this.ACSAddr,sfu_addr:this.SFUAddr,audio_policy:this.audioPolicy,topn:17,audios_change_cnt:0,audios:e,no_stream_cnt:0};this.remoteStreamInfo.every((r=>{var i;if(-1===this.audioStreamInfos.findIndex((e=>e.userid===r.userId)))return!0;const n=Array.from(r.mainStream.tracks.values()).find((e=>e.type===ok.TRACK_TYPE_AUDIO)),o="".concat(Fb,"_").concat(null==n?void 0:n.cssrc),s=gk.getLatestStats(null===(i=this.connectionsManager)||void 0===i?void 0:i.getConnectionId(),sk.STREAM_TYPE_MAIN,o);if(r&&n&&s){const i=r.userId,o=this.connectionsManager.calcChangedStatistic(s.id,s.packetsReceived||0,["packetsReceived"])||s.packetsReceived,a=this.audioStreamReceiverMap.get(n.cssrc)||0;let c=!0;0===o?c=!1:void 0===a?c=!0:o===a&&(c=!1);const u=this.getEncryInfo(r.userId)||bR.secretString(r.userId)||"";e.push({ssrc:n.cssrc,userid:u,packet_cnt:o-a}),this.audioStreamReceiverMap.set(n.cssrc,o),!c&&this.checkAudioStreamInfosIsExist(i,n.cssrc)&&t.no_stream_cnt++}return!0})),t.audios_change_cnt=this.ssrcChangeCount,e.length>0&&this.inBoundAudioSsrcInfos.push(t)}async getVideoReceiverFrameDecodedMap(){const e=new Map;return await this.buildFrameDecodedMap(sk.STREAM_TYPE_MAIN,e),await this.buildFrameDecodedMap(sk.STREAM_TYPE_AUX,e),e}async buildFrameDecodedMap(e,t){const r=e===sk.STREAM_TYPE_AUX,i=this.connectionsManager.getReceivers(r?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN);for(let n=0;n<i.length;n++){if("function"!=typeof i[n].getStats)return void this.logger.warn(this.module_,"rtpreceiver is not support getStats");this.remoteStreamInfo.forEach((i=>{const n={};(r?i.auxStream.tracks:i.mainStream.tracks).forEach((o=>{var s;const a=gk.getLatestStats(null===(s=this.connectionsManager)||void 0===s?void 0:s.getConnectionId(),e,"".concat(Hb,"_").concat(o.cssrc));if(a){n.userId=i.userId,n.isAux=r,n.decodedFrame=this.connectionsManager.calcChangedStatistic(a.id,a.framesDecoded||0,["framesDecoded"]);const e="".concat(i.userId,",").concat(r?"1":"0");t.get(e)||t.set(e,n)}}))}))}}async getReceiverInfo(e){const t={timestamp:bR.getCurrentTimestamp(),event:PC.QoS_DOWN_STREAM_AUDIO_SUM,real_band_width:0,bytes:0,pkt_loss:0},r={timestamp:bR.getCurrentTimestamp(),event:PC.QoS_DOWN_STREAM_VIDEO_SUM,real_band_width:0,tmmbr:0,video_tmmbr:0,req_band_width:0,pkt_loss:0,jitter:0,frame_rate:0,first_frame_count:0,bytes:0},i={isAudio:!1,isVideo:!1};await this.buildReceiverInfo(sk.STREAM_TYPE_MAIN,t,r,i,e),await this.buildReceiverInfo(sk.STREAM_TYPE_AUX,t,r,i,e),i.isAudio&&(e?this.mediaStatSumDebugInfo.push(t):this.mediaStatSumInfo.push(t)),i.isVideo&&(e?this.mediaStatSumDebugInfo.push(r):this.mediaStatSumInfo.push(r))}async buildReceiverInfo(e,t,r,i,n){const o=e===sk.STREAM_TYPE_AUX,s={timestamp:bR.getCurrentTimestamp(),event:PC.QoS_DOWN_STREAM_AUDIO,streams:[]},a={timestamp:bR.getCurrentTimestamp(),event:o?PC.QoS_AUX_DOWN_STREAM_VIDEO:PC.QoS_DOWN_STREAM_VIDEO,qos_estimate:3,streams:[]};o||this.buildAudioReceiverInfo(s,t,n),this.buildVideoReceiverInfo(e,a,r,n),0!==a.streams.length&&(n?this.mediaStatDebugInfo.push(a):this.mediaStatInfo.push(a),i.isVideo=!0),0!==s.streams.length&&(n?this.mediaStatDebugInfo.push(s):this.mediaStatInfo.push(s),i.isAudio=!0)}checkMuteStatusIsChange(e){const t=this.remoteUserManager.checkSsrcIsMute(e),r=this.remoteUserMuteStatus.get(e),i=!t&&t===r;return this.remoteUserMuteStatus.set(e,t),i}buildAudioReceiverInfo(e,t,r){let i=null,n=null,o=null,s=0;if(r?(i=this.audioReceiveDebugInfo.audioReceivePackets,n=this.audioReceiveDebugInfo.audioReceivePacketsLost,o=this.audioReceiveDebugInfo.audioReceiveBytes,s=this.rtcStatsInteval):(i=this.audioReceiveInfo.audioReceivePackets,n=this.audioReceiveInfo.audioReceivePacketsLost,o=this.audioReceiveInfo.audioReceiveBytes,s=5),this.audioPolicy===ak.TOPN_AUDIOPOLICY){for(let u=0;u<3;u++){var a;const d={ssrc_uid:"",stream_uid:"",sfu_addr:"",dst_rcv_vel:0,dst_rcv_nel:0,bit_rate:0,pkt_loss:0,rtt:0,jitter:0,bytes:0,pkts:0,lost_pkt_cnt:0,srtp_decode_err:0,max_cont_lost_pkts:0,mos:0,jb_depth:0,play_err:0,play_total_time:5e3,freeze_loss_time:0,freeze_time:0,jitter90:0,jitter95:0,jitter100:0,tsm_count:0,ts_exp_cnt:0,ssrc_change_cnt:0,audio_pkt_error:0,audio_decode_error:0,dst_burst_pkt_lost_cnt:0,dst_burst_cnt:0,dst_burst_pkt_lost_rate:0,dst_audio_jb_discard_lost_rate:0,net_loss:0,rtp_loss:0,dst_mean_lost_rate:0,buffer_max_length:0,buffer_mean_length:0,net_ate_max_delay:0,net_ate_cur_delay:0,jb_max_num_delay:0,jb_cur_num_delay:0,pkt_recv_max_interval:0,pkt_recv_mean_interval:0,ui_sample_rate:0,ui_channels:0,en_codec_type:0,ui_total_pkt_loss:0,ui_buffer_total_length:0,ui_buffer_cal_cnt:0,ui_rec_pkt_cnt:0,i_channel_id:0,ui_dst_inc_bytes:0,ui_recv_redn_rate:0,ui_plc_count:0,bad_pkt_cnt:0,empty_pkt_cnt:0,buf_drop_pkt_cnt:0},l=this.startSsrc+u,h="".concat(Fb,"_").concat(l),f=gk.getLatestStats(null===(a=this.connectionsManager)||void 0===a?void 0:a.getConnectionId(),sk.STREAM_TYPE_MAIN,h);if(f){d.ssrc_uid="".concat(l,"-").concat(l),d.stream_uid="STREAMUUID-".concat(l),d.sfu_addr=this.SFUAddr,this.connectionsManager.calcChangedStatistic(f.id,f,["bytesReceived","packetsReceived","packetsLost"]);const e=f.bytesReceived||0;o.get(l)||o.set(l,0),d.bytes=e<o.get(l)?e:e-o.get(l);const t=f.packetsReceived||0;d.jitter=Math.round(1e3*(f.jitter||0)),d.bit_rate=Math.round(d.bytes/(1024*s)*8),r||(this.tempStat.bytesReceived+=d.bytes,this.tempStat.recvBitrate+=d.bit_rate),o.set(l,e);const a=f.packetsLost||0;i.get(l)||i.set(l,0),n.get(l)||n.set(l,0);const u=a>n.get(l)?a-n.get(l):0;d.lost_pkt_cnt=u;const p=t<i.get(l)?t:t-i.get(l);d.pkts=p,d.pkt_loss=0===p?0:Math.round(u/(p+u)*100),n.set(l,a),i.set(l,t),d.dst_rcv_vel=this.getAudioLevel("remoteTop3",l);const m=this.remoteUserManager.checkRemoteTop3NeedReport();var c;if(this.remoteUserManager&&m)d.freeze_loss_time=gk.getFreeze(null===(c=this.connectionsManager)||void 0===c?void 0:c.getConnectionId(),sk.STREAM_TYPE_MAIN,h,"packetsReceived",100)}d.ssrc_uid&&(e.streams.push(d),t.real_band_width+=Math.round(d.bytes/(1024*s)*8))}return}const u={audioReceivePackets:i,audioReceivePacketsLost:n,audioReceiveBytes:o,interval:s};this.buildAudioReceiver4SubscribedMode(u,e,t,r)}buildAudioReceiver4SubscribedMode(e,t,r,i){this.remoteStreamInfo.forEach((n=>{var o;const s={ssrc_uid:"",stream_uid:"",sfu_addr:"",dst_rcv_vel:0,dst_rcv_nel:0,bit_rate:0,pkt_loss:0,rtt:0,jitter:0,bytes:0,pkts:0,lost_pkt_cnt:0,srtp_decode_err:0,max_cont_lost_pkts:0,mos:0,jb_depth:0,play_err:0,play_total_time:5e3,freeze_loss_time:0,freeze_time:0,jitter90:0,jitter95:0,jitter100:0,tsm_count:0,ts_exp_cnt:0,ssrc_change_cnt:0,audio_pkt_error:0,audio_decode_error:0,dst_burst_pkt_lost_cnt:0,dst_burst_cnt:0,dst_burst_pkt_lost_rate:0,dst_audio_jb_discard_lost_rate:0,net_loss:0,rtp_loss:0,dst_mean_lost_rate:0,buffer_max_length:0,buffer_mean_length:0,net_ate_max_delay:0,net_ate_cur_delay:0,jb_max_num_delay:0,jb_cur_num_delay:0,pkt_recv_max_interval:0,pkt_recv_mean_interval:0,ui_sample_rate:0,ui_channels:0,en_codec_type:0,ui_total_pkt_loss:0,ui_buffer_total_length:0,ui_buffer_cal_cnt:0,ui_rec_pkt_cnt:0,i_channel_id:0,ui_dst_inc_bytes:0,ui_recv_redn_rate:0,ui_plc_count:0,bad_pkt_cnt:0,empty_pkt_cnt:0,buf_drop_pkt_cnt:0},a=Array.from(n.mainStream.tracks.values()).find((e=>e.type===ok.TRACK_TYPE_AUDIO&&e.state===hk.normal)),c="".concat(Fb,"_").concat(null==a?void 0:a.cssrc),u=gk.getLatestStats(null===(o=this.connectionsManager)||void 0===o?void 0:o.getConnectionId(),sk.STREAM_TYPE_MAIN,c);if(n&&a&&u){const t=this.getEncryInfo(n.userId)||bR.secretString(n.userId),r="".concat(a.cssrc,"-").concat(t);s.ssrc_uid=r,s.stream_uid="".concat(a.trackId)||"STREAMUUID-".concat(a.cssrc),s.sfu_addr=this.SFUAddr,this.connectionsManager.calcChangedStatistic(u.id,u,["bytesReceived","packetsReceived","packetsLost"]);const o=u.bytesReceived||0;e.audioReceiveBytes.get(r)||e.audioReceiveBytes.set(r,0),s.bytes=o<e.audioReceiveBytes.get(r)?o:o-e.audioReceiveBytes.get(r);const l=u.packetsReceived;s.jitter=Math.round(1e3*(u.jitter||0)),s.bit_rate=Math.round(s.bytes/(1024*e.interval)*8),i||(this.tempStat.bytesReceived+=s.bytes,this.tempStat.recvBitrate+=s.bit_rate),e.audioReceiveBytes.set(r,o);const h=u.packetsLost||0;e.audioReceivePackets.get(r)||e.audioReceivePackets.set(r,0),e.audioReceivePacketsLost.get(r)||e.audioReceivePacketsLost.set(r,0);const f=h>e.audioReceivePacketsLost.get(r)?h-e.audioReceivePacketsLost.get(r):0;s.lost_pkt_cnt=f;const p=l<e.audioReceivePackets.get(r)?l:l-e.audioReceivePackets.get(r);s.pkts=p,s.pkt_loss=0===p?0:Math.round(f/(p+f)*100),e.audioReceivePacketsLost.set(r,h),e.audioReceivePackets.set(r,l),s.dst_rcv_vel=this.getAudioLevel("remote",a.cssrc,n.userId);const m=this.checkMuteStatusIsChange(null==a?void 0:a.cssrc);var d;if(this.remoteUserManager&&m)s.freeze_loss_time=gk.getFreeze(null===(d=this.connectionsManager)||void 0===d?void 0:d.getConnectionId(),sk.STREAM_TYPE_MAIN,c,"packetsReceived",100)}s.ssrc_uid&&(t.streams.push(s),r.real_band_width+=Math.round(s.bytes/(1024*e.interval)*8))}))}buildVideoReceiverInfo(e,t,r,i){let n="",o=null,s=null,a=null,c=null,u=0;i?(o=this.videoReceiveDebugInfo.videoReceivePackets,s=this.videoReceiveDebugInfo.videoReceivePacketsLost,a=this.videoReceiveDebugInfo.videoReceiveBytes,c=this.videoReceiveDebugInfo.videoReceiveFrame,u=this.rtcStatsInteval):(o=this.videoReceiveInfo.videoReceivePackets,s=this.videoReceiveInfo.videoReceivePacketsLost,a=this.videoReceiveInfo.videoReceiveBytes,c=this.videoReceiveInfo.videoReceiveFrame,u=5),this.remoteStreamInfo.forEach((d=>{(e===sk.STREAM_TYPE_MAIN?d.mainStream.tracks.filter((e=>e.type===ok.TRACK_TYPE_VIDEO&&e.state===hk.normal)):d.auxStream.tracks.filter((e=>e.type===ok.TRACK_TYPE_VIDEO&&e.state===hk.normal))).forEach((l=>{var h,f;const p={ssrc_uid:"",stream_uid:"",sfu_addr:"",expect_pic_w:0,expect_pic_h:0,image_width:0,image_height:0,roc:0,buffered:0,bit_rate:0,frame_rate:0,pkt_loss:0,rtt:0,jitter:0,bytes:0,jb_depth:0,fir_req_cnt:0,parse_srtp_fail:0,fir_frame_cnt:0,freeze_200ms_cnt:0,freeze_600ms_cnt:0,freeze_1000ms_cnt:0,freeze_200ms_time:0,freeze_600ms_time:0,freeze_1000ms_time:0,dec_key_frame_cnt:0,dec_key_frame_size:0,max_cont_lost_pkts:0,freeze_cnt:0,act_dec_runtime:5e3,ui_first_rcv_seq:0,ui_max_decode_delay:0,ui_min_decode_delay:0,ui_mean_decode_delay:0,ui_current_decode_delay:0,ui_max_channel_decode_delay:0,ui_min_channel_decode_delay:0,ui_mean_channel_decode_delay:0,ui_current_channel_decode_delay:0,ui_abnormal_pkt_count:0,ui_codec_pt_error:0,ui_no_dec_data_cnt:0,jb_discard_bytes:0,net_lost_pkt_counts:0,rcv_frame_counts:0,dec_bytes_out:0,rcv_red_bytes:0,dec_delay_over_time_cnt:0,channel_decode_over_time_cnt:0,dec_non_key_frame_size:0,dec_non_key_frame_cnt:0,us_loss_frame_rate:0,ui_pkt_rate:0,us_residual_pkt_loss:0,ul_decoder_start_time:0,us_mean_pkt_loss:0,ui_mean_rtt:0,e_dec_protocol:0,ui_distribute_tmmbr:0,frame_fail_cnt:0,advanced_frame_count:0,base_frame_count:0,before_postprocess_frames_rate:0,after_postprocess_frames_rate:0,red_rate:0,recover_rate:0,jb_listpacket_num:0,not_recv_pkt_cnt:0,not_recv_pkt_total_time:0,nack_request_cnt:0,send_key_request_cnt:0,jb_jitter:0,recv_frame_rate:0,recv_base_layer_frame_cnt:0,recv_mid_layer_frame_cnt:0,recv_out_layer_frame_cnt:0,jb_total_frame_cnt:0,jb_listframe_num:0,output_total_freezetime:0,output_freeze_cnt:0,ref_frame_error_cnt:0,force_out4_key_cnt:0,force_out4_struct_cnt:0,current_output_diftime:0,current_complete_type:0,jb_base_layer_frame_num:0,jb_mid_layer_frame_num:0,jb_out_layer_frame_num:0,freeze_400ms_cnt:0,freeze_400ms_time:0,freeze_200ms_rate:0,freeze_400ms_rate:0,freeze_600ms_rate:0,freeze_1000ms_rate:0,freeze_loss_time:0,first_frame_cnt:0,p_frame_cnt:0,lost_pkt_cnt:0,play_err:0,bad_pkt_cnt:0,empty_pkt_cnt:0,buf_drop_pkt_cnt:0},m="".concat(Hb,"_").concat(l.cssrc),g=gk.getLatestStats(null===(h=this.connectionsManager)||void 0===h?void 0:h.getConnectionId(),e,m);if(g){const t=this.getEncryInfo(d.userId)||bR.secretString(d.userId),r="".concat(l.cssrc,"-").concat(t);p.ssrc_uid=r,this.connectionsManager.calcChangedStatistic(g.id,g,["keyFramesDecoded","packetsReceived","packetsLost","bytesReceived","framesDecoded","freezeCount"]),this.buildCommonVideoRecvInfo(p,g,l),this.buildBitRateVideoRecvInfo(g,r,o,s,p);const h=bR.getValue(g.bytesReceived,0),f=a.get(r)||0;p.bytes=h<f?h:h-f,p.bit_rate=Math.round(p.bytes/(1024*u)*8),i||(this.tempStat.bytesReceived+=p.bytes,this.tempStat.recvBitrate+=p.bit_rate),a.set(r,h);const S=c.get(r)||0,v=g.framesDecoded||0,y=v<S?v:v-S;var _;if(p.dec_frame_cnt=y,p.frame_rate=y/u,c.set(r,v),n=g.trackId,p.freeze_200ms_cnt=g.framesDropped,p.fir_req_cnt=g.firCount||0,p.fir_frame_cnt=g.pliCount||0,p.nack_request_cnt=g.nackCount||0,e===sk.STREAM_TYPE_MAIN&&this.remoteUserManager&&this.checkMuteStatusIsChange(l.cssrc))p.freeze_600ms_time=gk.getFreeze(null===(_=this.connectionsManager)||void 0===_?void 0:_.getConnectionId(),e,m,this.videoFreezeKey,500)}const S=gk.getLatestStatsByTrackId(null===(f=this.connectionsManager)||void 0===f?void 0:f.getConnectionId(),e,n);n&&S&&_k.buildVideoTrackInfo(p,S),p.ssrc_uid&&(t.streams.push(p),r.real_band_width+=Math.round(p.bytes/(1024*u)*8)),p.rtt=1e3*gk.getLatestValue(d.roomId,e,"candidate-pair","currentRoundTripTime")||0}))}))}buildBitRateVideoRecvInfo(e,t,r,i,n){const o=bR.getValue(e.packetsReceived,0),s=bR.getValue(e.packetsLost,0),a=r.get(t)||0,c=i.get(t)||0,u=s>c?s-c:0;n.real_lost_pkt_cnt=u;const d=o<a?o:o-a;n.pkts=d,n.pkt_loss=0===d?0:Math.round(u/(d+u)*100),i.set(t,s),r.set(t,o)}static buildVideoTrackInfo(e,t){e.image_width=t.frameWidth||0,e.image_height=t.frameHeight||0,e.freeze_cnt=t.freezeCount||0}buildCommonVideoRecvInfo(e,t,r){e.sfu_addr=this.SFUAddr,e.stream_uid=r.trackId||"",e.expect_pic_w=r.width||0,e.expect_pic_h=r.height||0,e.dec_key_frame_cnt=t.keyFramesDecoded||0,e.jitter=Math.round(1e3*(t.jitter||0))}async getSenderInfo(e){const t={timestamp:bR.getCurrentTimestamp(),event:PC.QoS_UP_STREAM_AUDIO_SUM,tmmbr:0,video_tmmbr:0,resp_band_width:0,real_band_width:0,bytes:0,pkt_loss:0},r={timestamp:bR.getCurrentTimestamp(),event:PC.QoS_UP_STREAM_VIDEO_SUM,tmmbr:0,video_tmmbr:0,resp_band_width:0,real_band_width:0,pkt_loss:0,jitter:0,frame_rate:0,first_frame_count:0,bytes:0},i={isAudio:!1,isVideo:!1};await this.buildSenderInfo(!1,t,r,i,e),await this.buildSenderInfo(!0,t,r,i,e),i.isAudio&&(e?this.mediaStatSumDebugInfo.push(t):this.mediaStatSumInfo.push(t)),i.isVideo&&(e?this.mediaStatSumDebugInfo.push(r):this.mediaStatSumInfo.push(r))}async buildSenderInfo(e,t,r,i,n){const o=[],s=[],a={ssrc_uid:"",stream_uid:"",sfu_addr:"",src_chan_input_vol_scale:0,src_snd_vel:0,src_snd_nel:0,bit_rate:0,pkt_loss:0,rtt:0,jitter:0,bytes:0,pkts:0,pkt_rate:0,redn_rate:0,ui_bgm_mean_speech_level:0,ui_bgm_mean_noise_level:0,up_vqe_max_delay:0,up_vqe_mean_delay:0,up_capture_max_interval:0,up_capture_mean_interval:0,pre_send_max_delay:0,pre_send_mean_delay:0,up_enc_send_max_delay:0,up_enc_send_mean_delay:0,ui_sample_rate:0,ui_channels:0,en_codec_type:0,i_channel_id:0,ui_src_inc_bytes:0,ui_up_mean_delay:0,ui_up_max_delay:0,ui_up_capture_cnt:0,ui_up_vqe_total_delay:0,ui_pre_send_total_delay:0,ui_up_enc_send_pkt_cnt:0,ui_up_enc_send_total_delay:0,estimate_bit_rate:0,tmmbr:0,bad_pkt_cnt:0},c=e?Array.from(this.auxsStreamInfo.values()).filter((e=>e.type!==ok.TRACK_TYPE_AUDIO)):Array.from(this.LocalStreamInfo.values());if(0===c.length)return;const u=c.find((e=>e.type===ok.TRACK_TYPE_AUDIO)),d=c.filter((e=>e.type===ok.TRACK_TYPE_VIDEO)),l=n?this.rtcStatsInteval:5;this.buildAudioSenderInfo(u,a,n),a.ssrc_uid&&(t.real_band_width+=Math.round(a.bytes/(1024*l)*8),i.isAudio=!0,s.push(a)),null==d||d.forEach((t=>{const s={ssrc_uid:"",stream_uid:"",sfu_addr:"",expect_pic_w:0,expect_pic_h:0,expect_frame_rate:0,image_width:0,image_height:0,frame_rate:0,bit_rate:0,max_cont_loss:0,pkt_loss:0,rtt:0,jitter:0,bytes:0,pkts:0,roc:0,first_req_count:0,first_frame_count:0,frame_count:0,redn_rate:0,ui_first_send_seq:0,ui_no_ref_redundance_rate:0,ui_enc_max_bit_rate_set:0,ui_enc_min_bit_rate_set:0,ui_enc_current_bit_rate_set:0,ui_max_encode_delay:0,ui_min_encode_delay:0,ui_mean_encode_delay:0,ui_current_encode_delay:0,ui_buffer_data:0,ui_snd_fir_frame_key_count:0,ui_snd_fir_frame_arq_count:0,ui_snd_fir_frame_period_count:0,ui_max_channel_encode_delay:0,ui_min_channel_encode_delay:0,ui_mean_channel_encode_delay:0,ui_current_channel_encode_delay:0,ui_enc_frame_counts:0,ui_enc_bytes_out:0,ui_estimate_bitrate:0,ui_red_bytes_out:0,ui_nack_bytes_out:0,ui_enc_over_time_cnt:0,ui_enc_delay_over_time_cnt:0,ui_channel_encode_over_time_cnt:0,ui_before_pre_process_frm_cnt:0,ui_after_pre_process_frm_cnt:0,repeat_red_pkt_count:0,usable_bitrate:0,available_enc_bitrate:0,send_pkt_hungry_cnt:0,send_buffer_frm_cnt:0,advanced_frame_cnt:0,base_frame_cnt:0,avg_pre_process_time_in_period:0,max_pre_process_time:0,before_encode_lost_frm_cnt:0,us_sent_mean_lost_rate:0,ui_mean_r_t_t:0,ui_cumulative_lost:0,ui_extended_max_seq_num:0,ui_pkt_rate:0,ui_send_bit_rate:0,f_key_redundance_rate:0,f_ref_redundance_rate:0,f_no_ref_redundance_rate:0,e_enc_protocol:0,before_encode_frames_rate:0,before_send_frames_rate:0,after_send_frames_rate:0,data_cache_bytes:0,input_frame_cnt:0,input_pacing_pkt_cnt:0,input_pacing_fec_pkt_cnt:0,input_pacing_arq_pkt_cnt:0,send_fec_pkt_cnt:0,send_arq_pkt_cnt:0,nack_not_rsp_for_not_find_cnt:0,nack_not_rsp_for_key_cnt:0,nack_not_rsp_for_rtt_cnt:0,nack_not_rsp_for_time_cnt:0,nack_not_rsp_for_bw_cnt:0,deliver_red_rate:0,output_frame_cnt:0,estimate_bit_rate:0,tmmbr:0,p_frame_count:0,key_frame_count:0,bad_pkt_cnt:0,qos_estimate:3};this.buildVideoSenderInfo(t,s,e,n),s.ssrc_uid&&(r.real_band_width+=Math.round(s.bytes/(1024*l)*8),i.isVideo=!0,o.push(s))}));const h=this.getConnectionRemb(e);if(r.video_tmmbr=h>0?Math.round(h/1024):0,r.tmmbr+=r.video_tmmbr,s.length>0){const e={timestamp:bR.getCurrentTimestamp()};e.event=PC.QoS_UP_STREAM_AUDIO,e.streams=s,n?this.mediaStatDebugInfo.push(e):this.mediaStatInfo.push(e)}if(o.length>0){const t={timestamp:bR.getCurrentTimestamp()};t.event=e?PC.QoS_AUX_UP_STREAM_VIDEO:PC.QoS_UP_STREAM_VIDEO,t.streams=o,n?this.mediaStatDebugInfo.push(t):this.mediaStatInfo.push(t)}}buildAudioSenderInfo(e,t,r){var i,n;if(!e)return;const o=r?this.lastSenderDebugInfo:this.lastSenderInfo,s=r?this.rtcStatsInteval:5,a=o.get("".concat(e.ssrc,"-").concat(e.uid))||{audioSendPackets:0,audioSendPacketsLost:0,audioSendBytes:0,videoSendPackets:0,videoSendPacketsLost:0,videoSendBytes:0};let c="".concat(Kb,"_").concat(e.ssrc),u=gk.getLatestStats(null===(i=this.connectionsManager)||void 0===i?void 0:i.getConnectionId(),sk.STREAM_TYPE_MAIN,c);if(u){const i=this.getEncryInfo(e.uid)||bR.secretString(e.uid);t.ssrc_uid="".concat(e.ssrc,"-").concat(i),t.stream_uid=e.streamId,t.sfu_addr=this.SFUAddr;const n=u.bytesSent||0;t.bytes=n<a.audioSendBytes?n:n-a.audioSendBytes;const o=u.packetsSent||0;t.pkts=o<a.audioSendPackets?o:o-a.audioSendPackets,t.bit_rate=Math.round(t.bytes/(1024*s)*8)||0,r||(this.tempStat.bytesSent+=t.bytes,this.tempStat.sendBitrate+=t.bit_rate),a.audioSendBytes=n,a.audioSendPackets=o,t.src_snd_vel=this.getAudioLevel("local",e.ssrc)}if(c="".concat(Wb,"_").concat(e.ssrc),u=gk.getLatestStats(null===(n=this.connectionsManager)||void 0===n?void 0:n.getConnectionId(),sk.STREAM_TYPE_MAIN,c),u){t.jitter=Math.round(1e3*u.jitter),t.rtt=Math.round(1e3*(u.roundTripTime||0));const e=u.packetsLost||0,r=e>a.audioSendPacketsLost?e-a.audioSendPacketsLost:0,i=t.pkts;t.pkt_loss=i>0?Math.round(r/(i+r)*100):0,a.audioSendPacketsLost=e}o.set("".concat(e.ssrc,"-").concat(e.uid),a)}addExpectInfo(e,t){t.expect_pic_w=(null==e?void 0:e.width)||0,t.expect_pic_h=(null==e?void 0:e.height)||0,t.expect_frame_rate=(null==e?void 0:e.frame)||0}addRembInfo(e,t){const r=this.getConnectionRemb(e);t.usable_bitrate=r>0?Math.round(r/1024):0}getConnectionRemb(e){let t=0;return this.connectionsManager.isConnectionsExist()?(t+=e?this.getRemb(sk.STREAM_TYPE_AUX):this.getRemb(sk.STREAM_TYPE_MAIN),t):t}getRemb(e){let t=0;try{const r=gk.getLatestReport(this.connectionsManager.getConnectionId(),e);if(r){const e=r.get("candidate-pair");e&&Object.prototype.hasOwnProperty.call(e,"availableOutgoingBitrate")&&(t=e.availableOutgoingBitrate||0)}}catch(kD){this.logger.error(this.module_,"getRemb failed",kD)}return t}buildVideoSenderInfo(e,t,r,i){var n,o;if(!e)return;const s=i?this.lastSenderDebugInfo:this.lastSenderInfo,a=i?this.rtcStatsInteval:5,c=s.get("".concat(e.ssrc,"-").concat(e.uid))||{audioSendPackets:0,audioSendPacketsLost:0,audioSendBytes:0,videoSendPackets:0,videoSendPacketsLost:0,videoSendBytes:0};this.addExpectInfo(e,t),this.addRembInfo(r,t);const u="".concat(zb,"_").concat(e.ssrc),d=gk.getLatestStats(null===(n=this.connectionsManager)||void 0===n?void 0:n.getConnectionId(),r?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN,u);if(d){const n=this.getEncryInfo(e.uid)||bR.secretString(e.uid);t.ssrc_uid="".concat(e.ssrc,"-").concat(n),t.stream_uid=e.streamId,t.sfu_addr=this.SFUAddr,_k.buildCommonVideoSendInfo(t,d,e,r);const o=bR.getValue(d.bytesSent,0);t.bytes=o<c.videoSendBytes?o:o-c.videoSendBytes;const s=bR.getValue(d.packetsSent,0);t.pkts=s<c.videoSendPackets?s:s-c.videoSendPackets,c.videoSendPackets=s,t.bit_rate=Math.round(t.bytes/(1024*a)*8)||0,i||(this.tempStat.bytesSent+=t.bytes,this.tempStat.sendBitrate+=t.bit_rate),c.videoSendBytes=o}const l="".concat(Gb,"_").concat(e.ssrc),h=gk.getLatestRemoteInboundStats(null===(o=this.connectionsManager)||void 0===o?void 0:o.getConnectionId(),r?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN,l);if(h){t.jitter=Math.round(1e3*(h.jitter||0));const e=h.packetsLost||0;if(0!==e){const r=e>c.videoSendPacketsLost?e-c.videoSendPacketsLost:0,i=t.pkts;t.pkt_loss=Math.round(r/(i+r)*100)}else t.pkt_loss=0;c.videoSendPacketsLost=e,t.rtt=Math.round(1e3*(h.roundTripTime||0))}s.set("".concat(e.ssrc,"-").concat(e.uid),c)}static buildCommonVideoSendInfo(e,t,r,i){if(i){var n;const t=null===(n=r.publishInfo)||void 0===n?void 0:n.stream;e.image_width=(null==t?void 0:t.getScreenWidth())||0,e.image_height=(null==t?void 0:t.getScreenHeight())||0,e.frame_rate=(null==t?void 0:t.getScreenFrameRate())||0}else e.image_width=(null==r?void 0:r.width)||0,e.image_height=(null==r?void 0:r.height)||0,e.frame_rate=(null==r?void 0:r.frame)||0;e.image_width=t.frameWidth||0,e.image_height=t.frameHeight||0,e.frame_rate=Math.round(t.framesPerSecond||0),e.first_frame_count=t.firCount||0,e.frame_count=t.framesSent||0}async buildRtcStatsDebugInfo(e){this.rtcStatsInteval=e;const t={mediaStatsDebugInfo:null,mediaStatsSumDebugInfo:null};return this.connectionsManager.isConnectionsExist()?(await this.getSenderInfo(!0),await this.getReceiverInfo(!0),t.mediaStatsDebugInfo=this.mediaStatDebugInfo,t.mediaStatsSumDebugInfo=this.mediaStatSumDebugInfo,this.mediaStatDebugInfo=[],this.mediaStatSumDebugInfo=[],t):(this.logger.debug(this.module_,"peerConnection is undefined"),t)}}class Sk{constructor(e,r){t(this,"eventInfoMap",new Map),t(this,"reqInfoMap",new Map),t(this,"sfuInfo",{ipAddress:"",videoPort:0,audioPort:0,auxPort:0}),t(this,"deviceInfo",{audioOutputId:void 0,audioInputId:void 0,videoInputId:void 0}),t(this,"mediaOpsData",[]),t(this,"signalSendMsgs",[]),t(this,"signalReceiveMsgs",[]),t(this,"parentSpanIdMap",new Map),t(this,"spanIdMap",new Map),this.logger=e,this.mediaStats=new _k(e),this.module_="RTCStat",this.commInfo={},this.commInfo.instance_id=bR.getDeviceID(),r&&(this.commInfo.appid=r.appId,this.commInfo.domain=r.domain),this.commInfo.sdk_name="hwwebrtc",this.commInfo.corp="",this.commInfo.service_name="rtc",this.commInfo.operator="",this.commInfo.sdk_version="web-".concat(jC,"-").concat(FC),this.signalSendMsgs.push("BYE"),this.signalSendMsgs.push("PUSH_STREAM_RES_ALL"),this.signalSendMsgs.push("APPLY_PUSH_STREAM"),this.signalSendMsgs.push("AUDIO_POLICY"),this.signalSendMsgs.push("SWITCH_ROLE"),this.signalSendMsgs.push("CHANGE_STREAM_STATUS"),this.signalSendMsgs.push("APP_DATA"),this.signalSendMsgs.push("ENABLE_AUDIO"),this.signalSendMsgs.push("DISABLE_AUDIO"),this.signalSendMsgs.push("ENABLE_VIDEO"),this.signalSendMsgs.push("DISABLE_VIDEO"),this.signalSendMsgs.push("JOIN_ROOM"),this.signalSendMsgs.push("EXIT_ROOM"),this.signalSendMsgs.push("PING"),this.signalSendMsgs.push("PUSH_STREAM_RESULT"),this.signalSendMsgs.push("GET_ROOM_USERINFO"),this.signalSendMsgs.push("QUERY_PUBLISH"),this.signalSendMsgs.push("START_PUBLISH"),this.signalSendMsgs.push("STOP_PUSH_STREAM"),this.signalSendMsgs.push("STOP_PUBLISH"),this.signalSendMsgs.push("CANCEL_SUBS_STREAM"),this.signalSendMsgs.push("SUBS_STREAM"),this.signalSendMsgs.push("UPDATE_PUBLISH"),this.signalReceiveMsgs.push("WATCH_STREAM_NOTIFY")}static isStatiscEnable(){return"off"!==nk.getParameter(Jw)}addCommInfo(e){return e.timestamp=bR.getCurrentTimestamp(),e.trace_id=this.commInfo.trace_id||"",e.instance_id=this.commInfo.instance_id,e.room_uid=this.commInfo.room_uid||"",e.domain=this.commInfo.domain||"",e.event_name=(null==e?void 0:e.event_name)||"",e.appid=this.commInfo.appid||"",e.corp=this.commInfo.corp||"",e.room_id=this.commInfo.room_id||"",e.user_id=this.getMediaStat().getEncryInfo(this.commInfo.user_id)||bR.secretString(this.commInfo.user_id)||"",e.sdk_version=this.commInfo.sdk_version||"",e.sdk_name=this.commInfo.sdk_name||"",e.service_name=this.commInfo.service_name||"",e.operator=this.commInfo.operator||"",e.net_type=bR.getNetworkType()||"",e.country="",e.province="",e.city="",e}setRemoteUserManager(e){this.remoteUserManager=e,this.mediaStats.setRemoteUserManager(e)}clearMediaStatBytes(){this.mediaStats.clearMediaStatBytes()}async collectReceiverDecodedFrameMap(){return this.mediaStats.getVideoReceiverFrameDecodedMap()}setLocalUserInfo(e){this.commInfo.room_id=e.roomId,this.commInfo.user_id=e.userId,this.user=e}setTraceInfo(e){this.commInfo.trace_id=e}setRoomUid(e){this.commInfo.room_uid=e}setSFUAddress(e){this.sfuInfo=e,e.ipAddress&&this.mediaStats.setSFUAddr(e.ipAddress)}getMediaStat(){return this.mediaStats}leaveRoom(){this.mediaCollectionTimer&&clearTimeout(this.mediaCollectionTimer),this.mediaStats.leaveRoom()}startMediaCollector(){clearTimeout(this.mediaCollectionTimer),this.mediaCollectionTimer=setTimeout((async()=>{try{await this.mediaStats.dealStats(),this.setMediaStatInfo(),this.setMediaStatSumInfo(),this.setInBoundAudioSsrcInfos(),qw.addRecords(this.mediaOpsData),this.mediaOpsData.length=0}catch(kD){this.logger.error(this.module_,"startMediaCollector failed ".concat(kD))}finally{this.startMediaCollector()}}),5e3)}reportAudioMuteInfo(e,t){const r=t?1:3;let i;i=1===e?RC.INPUT_AUDIO:RC.OUTPUT_AUDIO,this.reportSwitchDevicesInfo(i,this.deviceInfo.audioInputId,0,r)}reportVideoMuteInfo(e,t){const r=t?4:5;this.reportSwitchDevicesInfo(RC.INPUT_VIDEO,this.deviceInfo.videoInputId,0,r)}async setDeviceStatusInfo(){(async function(){return new Promise(((e,t)=>{navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices||t(new qc(Wc.RTC_ERR_CODE_NOT_SUPPORT_MEDIA_DEVICES)),navigator.mediaDevices.enumerateDevices().then((r=>{if(r&&0!==r.length){const t={};r.forEach((e=>{"default"!==e.deviceId&&"communications"!==e.deviceId&&(t[e.kind]=[...t[e.kind]||[],e])})),e(t)}else t(new qc(Wc.RTC_ERR_CODE_NO_AVAILABLE_DEVICES))})).catch((e=>{t(e)}))}))})().then((e=>{this.setSpeakerDeviceInfo(e.audiooutput||[]),this.setCameraDeviceInfo(e.videoinput||[]),this.setMicrophoneDeviceInfo(e.audioinput||[])})).catch((e=>{this.logger.error(this.module_,"getRTCDeviceGroups failed ".concat(e))}))}recordUploadRequsetInfo(e){if(null!=e&&e.type&&"PING"!==e.type)switch(this.reqInfoMap.set(e.requestId,e),e.type){case"JOIN_ROOM":e.eventId=OC.EVENT_JOIN_ROOM,this.eventInfoMap.set(e.eventId,e);break;case"EXIT_ROOM":e.eventId=OC.EVENT_LEAVE_ROOM,this.eventInfoMap.set(e.eventId,e);break;case"SWITCH_ROLE":e.eventId=OC.EVENT_SWITCH_ROLE,this.eventInfoMap.set(e.eventId,e);break;case"PUSH_STREAM_RES_ALL":if(e.videoStreams&&e.videoStreams.length>0){e.videoStreams.find((e=>(null==e?void 0:e.content)===iC.desktop))&&(e.eventId=OC.EVENT_SEND_AUX_STREAM,this.eventInfoMap.set(e.eventId,e))}}}getDownloadRequestInfo(e){if(null==e||!e.requestId)return"";if("PONG"===e.resultMessage)return"PONG";const t=this.reqInfoMap.get(e.requestId);return t&&(null==t?void 0:t.type)||""}recordDownloadRequestInfo(e){if(null==e||!e.requestId)return;if("PONG"===e.resultMessage)return;const t=this.reqInfoMap.get(e.requestId);if(t){switch(this.reportSignalRepForServer2Web(t,e),t.type){case"SUBS_STREAM":t.videoUpstreams&&this.reportVideoSub(t.videoSubType,t.requestId,t.videoUpstreams,e.resultCode,e.resultMessage),t.audioUpstreams&&this.reportAudioSub(t.audioSubType,t.requestId,t.audioUpstreams,e.resultCode);break;case"PUSH_STREAM_RES_ALL":t.videoStreams&&t.videoStreams.length>0&&this.reportUpStreamVideoInfo(t.videoStreams,t.requestId,e.resultCode);break;case"AUDIO_POLICY":this.reportAudioPolicyInfo(t.audioPolicy,t.requestId,e.resultCode)}this.reqInfoMap.delete(e.requestId)}}setMediaStatInfo(){const e=this.mediaStats.getMediaStatInfo()||[];e.forEach((e=>{this.addCommInfo(e)})),this.mediaOpsData=this.mediaOpsData.concat(e)}setMediaStatSumInfo(){const e=this.mediaStats.getMediaStatSum()||[];e.forEach((e=>{this.addCommInfo(e)})),this.mediaOpsData=this.mediaOpsData.concat(e)}setInBoundAudioSsrcInfos(){const e=this.mediaStats.getInBoundAudioSsrc()||[];e.forEach((e=>{this.addCommInfo(e)})),this.mediaOpsData=this.mediaOpsData.concat(e)}setRequestId(e){const t=this.eventInfoMap.get(e.event);return t&&(e.request_id=t.requestId),this}transformJoinInfoResult(e){if(!e&&0!==e)return YC.INTERNAL_ERROR;let t=YC.INTERNAL_ERROR;switch(e){case Wc.RTC_ERR_CODE_SUCCESS:t=YC.SUCCESS;break;case Wc.RTC_ERR_CODE_WEBSOCKET_NOT_CONNECTED:case Wc.RTC_ERR_CODE_WEBSOCKET_INTERRUPTED:case Wc.RTC_ERR_CODE_WEBSOCKET_RECONNECT_TIMEOUT:case Wc.RTC_ERR_CODE_WEBSOCKET_CONNECT_TIMEOUT:case Wc.RTC_ERR_CODE_WEBSOCKET_CONNECT_ERROR:case Wc.RTC_ERR_CODE_STATUS_ERROR:t=YC.NETWORK_CONNECT_ERROR;break;case Wc.RTC_ERR_CODE_WAIT_CONFIG_FAIL:case Wc.RTC_ERR_CODE_WEBSOCKET_NOT_OPEN:t=YC.SERVER_ERROR;break;case Wc.RTC_ERR_CODE_INVALID_PARAMETER:t=YC.INTERNAL_ERROR}return t}reportJoinInfo(e,t,r,i,n){var o,s;this.getMediaStat().setACSAddr(t);const a={};a.event=OC.EVENT_JOIN_ROOM,a.access_addr=t,a.sfu_addr=this.sfuInfo.ipAddress,a.aport=this.sfuInfo.audioPort,a.vport=this.sfuInfo.videoPort,this.setRequestId(a),a.result=this.transformJoinInfoResult(e),a.platform="web-"+bR.getPlatform(),a.user_agent="web-"+bR.getUserAgent(),a.role=null===(o=this.user)||void 0===o?void 0:o.role,a.join_qos=JSON.stringify(i||{}),a.is_rejoin=r?1:0,a.nick_name=bR.shieldNickname((null===(s=this.user)||void 0===s?void 0:s.userName)||""),a.time_diff_server=0,a.failMessage="".concat(e||"  ").concat(n||" "),this.addCommInfo(a),this.joinTime=a.timestamp,this.eventInfoMap.delete(OC.EVENT_JOIN_ROOM),qw.reportRecords([a])}reportRelayJoinInfo(e){var t;const r={};r.event=OC.EVENT_JOIN_ROOM,r.access_addr=e.acsAddr,r.sfu_addr=this.sfuInfo.ipAddress,r.aport=this.sfuInfo.audioPort,r.vport=this.sfuInfo.videoPort,r.request_id=e.requestId,r.result=this.transformJoinInfoResult(e.code),r.platform="web-"+bR.getPlatform(),r.user_agent="web-"+bR.getUserAgent(),r.role=e.role,r.join_qos=JSON.stringify({}),r.is_rejoin=0,r.nick_name=bR.shieldNickname((null===(t=this.user)||void 0===t?void 0:t.userName)||""),r.time_diff_server=0,r.failMessage="".concat(e.code||"  ").concat(e.failMessage||" "),this.addCommInfo(r),r.trace_id=e.traceId,r.room_id=e.roomId,r.room_uid=String(e.roomUid),qw.reportRecords([r])}reportRelayLeavInfo(e){const t={};t.event=OC.EVENT_LEAVE_ROOM,t.reason=0,t.result=e.code,t.a_snd_lost_mean=0,t.v_snd_lost_mean=0,t.a_snd_band_width_mean=0,t.v_snd_band_width_mean=0,t.a_snd_rtt_mean=0,t.a_recv_rtt_mean=0,t.v_snd_rtt_mean=0,t.v_recv_rtt_mean=0,t.a_recv_lost_mean=0,t.v_recv_lost_mean=0,t.a_recv_band_width_mean=0,t.v_recv_band_width_mean=0,t.freeze_200ms_cnt=0,t.freeze_600ms_cnt=0,t.freeze_1000ms_cnt=0,t.stut_time_mean=0,t.freeze_400ms_cnt=0,t.freeze_200ms_rate=0,t.freeze_400ms_rate=0,t.freeze_600ms_rate=0,t.freeze_1000ms_rate=0,t.v_snd_frame_rate=0,t.v_snd_pkt_rate=0,t.a_snd_pkt_rate=0,t.v_recv_frame_rate=0,t.v_recv_pkt_rate=0,t.a_recv_pkt_rate=0,t.v_snd_jitter=0,t.v_recv_jitter=0,this.addCommInfo(t),t.trace_id=e.traceId,t.room_id=e.roomId,t.room_uid=String(e.roomUid),t.request_id=e.requestId,t.elapsed=0,qw.reportRecords([t])}reportLeavInfo(e){const t={};t.event=OC.EVENT_LEAVE_ROOM,t.reason=0,t.result=e,t.a_snd_lost_mean=0,t.v_snd_lost_mean=0,t.a_snd_band_width_mean=0,t.v_snd_band_width_mean=0,t.a_snd_rtt_mean=0,t.a_recv_rtt_mean=0,t.v_snd_rtt_mean=0,t.v_recv_rtt_mean=0,t.a_recv_lost_mean=0,t.v_recv_lost_mean=0,t.a_recv_band_width_mean=0,t.v_recv_band_width_mean=0,t.freeze_200ms_cnt=0,t.freeze_600ms_cnt=0,t.freeze_1000ms_cnt=0,t.stut_time_mean=0,t.freeze_400ms_cnt=0,t.freeze_200ms_rate=0,t.freeze_400ms_rate=0,t.freeze_600ms_rate=0,t.freeze_1000ms_rate=0,t.v_snd_frame_rate=0,t.v_snd_pkt_rate=0,t.a_snd_pkt_rate=0,t.v_recv_frame_rate=0,t.v_recv_pkt_rate=0,t.a_recv_pkt_rate=0,t.v_snd_jitter=0,t.v_recv_jitter=0,t.elapsed=(bR.getCurrentTimestamp()-this.joinTime)/1e3,this.addCommInfo(t),this.setRequestId(t),this.eventInfoMap.delete(OC.EVENT_LEAVE_ROOM),qw.reportRecords([t])}reportVideoSub(e,t,r,i,n){const o=[],s=[],a=[],c=[],u=[];null==r||r.forEach((e=>{const t=this.getMediaStat().getEncryInfo(e.pUserId)||bR.secretString(e.pUserId)||"";s.push(t),o.push(e.pSsrcId),u.push((null==e?void 0:e.code)||0);const r=this.remoteUserManager.getStreamInfoByPStreamUid(e.pStreamUid);if(r){const e=pk.getResolutionType(r.width,r.height);a.push(e&&e.toUpperCase().replace("-",""))}else this.logger.warn(this.module_,"Can not getStreamInfoByPStreamUid for reportVideoSub");c.push(String(e.pStreamUid))}));const d={event:OC.EVENT_WATCH,action:VC[e],request_id:t,ssrc_list:o.join(","),stream_uid_list:c.join(","),uid_list:s.join(","),img_list:a.join(","),reasonList:u.join(","),result:i,failMessage:0===i?"":n};this.addCommInfo(d),qw.reportRecords([d])}reportSwitchDevicesInfo(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:6;e===RC.OUTPUT_AUDIO?this.deviceInfo.audioOutputId=t:e==RC.INPUT_AUDIO?this.deviceInfo.audioInputId=t:e===RC.INPUT_VIDEO&&(this.deviceInfo.videoInputId=t);const n={event:OC.EVENT_SWITCH_DEVICE,type:e,name:t,result:r,opt:i};this.addCommInfo(n),qw.addRecord(n)}reportSwitchRoleInfo(e,t){const r={event:OC.EVENT_SWITCH_ROLE,role:e,result:t};this.setRequestId(r),this.addCommInfo(r),qw.addRecord(r)}reportStartSendMediaStream(e,t){const r={event:OC.EVENT_SEND_MEDIA,type:e,opt:t};this.addCommInfo(r),qw.reportRecords([r])}setMediaCaptureSucc(e,t){const r={event:OC.EVENT_START_MEDIA,type:e,dev_name:t};this.addCommInfo(r),qw.addRecord(r)}reportAuxiliaryStreamShareInfo(e,t){const r={event:OC.EVENT_SEND_AUX_STREAM,action:e,result:t};this.setRequestId(r),this.addCommInfo(r),qw.reportRecords([r])}setAudioSubscribeInfo(e,t,r){const i=[];let n;null==e||e.forEach((e=>{const t={uid:this.getMediaStat().getEncryInfo(null==e?void 0:e.userid)||bR.secretString(null==e?void 0:e.userid)||"",ssrc:(null==e?void 0:e.ssrc)||0};i.push(t),n=e.action-1}));const o={event:OC.EVENT_SUBSCIBE,request_id:t,policy:this.getMediaStat().getAudioPolicy(),streams:i,action:n,result:r};this.addCommInfo(o),qw.reportRecords([o])}reportAudioSub(e,t,r,i){const n=[];null==r||r.forEach((e=>{const t={uid:this.getMediaStat().getEncryInfo(null==e?void 0:e.pUserId)||bR.secretString(null==e?void 0:e.pUserId)||"",ssrc:(null==e?void 0:e.pSsrcId)||0,reason:(null==e?void 0:e.code)||0};n.push(t)}));const o={event:OC.EVENT_SUBSCIBE,request_id:t,policy:this.getMediaStat().getAudioPolicy(),streams:n,action:e,result:i};this.addCommInfo(o),qw.reportRecords([o])}setConnectionStatusInfo(e,t){const r={timestamp:0,event:OC.EVENT_CONNECTION_CHANNEL_STATUS,type:t,on:e};this.addCommInfo(r),qw.reportRecords([r])}reportUpStreamVideoInfo(e,t,r){const i=[],n=[];e.forEach((e=>{n.push(pk.getResolution(e.width,e.height)),i.push("".concat(e.width,"*").concat(e.height))}));const o={event:OC.EVENT_SET_UP_STREAM,request_id:t,resolution_name_list:n.join(","),width_height_list:i.join(","),result:0===r?bC.SUCCESS:bC.FAIL};this.addCommInfo(o),qw.addRecord(o)}reportAudioPolicyInfo(e,t,r){const i={event:OC.EVENT_SET_AUDIO_POLICY,request_id:t,policy:e,result:r,topn:e===ak.TOPN_AUDIOPOLICY?3:17};this.addCommInfo(i),qw.addRecord(i)}setSysBasicInfo(){const e={event:MC.DEVICE_RT_SYSTEM,device_cpu:0,app_cpu:0,mem_ratio:0};this.addCommInfo(e),qw.addRecord(e)}setCameraInfo(e,t){const r={event:MC.DEVICE_RT_CAMERA,cap_format:0,cap_width:(null==e?void 0:e.width)||0,cap_height:(null==e?void 0:e.height)||0,cap_frame_rate:(null==e?void 0:e.frameRate)||0,out_width:(null==t?void 0:t.width)||0,out_height:(null==t?void 0:t.height)||0,out_cap_frames:(null==t?void 0:t.frameRate)||0,cap_overtime_cnt:0,frame_capture_time:0,render_frame_rate:0,frame_render_time:0};this.addCommInfo(r),qw.addRecord(r)}setSpeakerInputInfo(){const e={event:MC.DEVICE_RT_SPEAKER,dst_down_vel:0,dst_down_nel:0,speaker_vol:0,speaker_play_err_num:0};this.addCommInfo(e),qw.addRecord(e)}setMicrophoneInfo(){const e={event:MC.DEVICE_RT_MICROPHONE,src_cap_vel:0,src_cap_nel:0,src_mic_vol_scale:0,capture_abnormal:0,mic_vol:0,mic_recoder_err_num:0};this.addCommInfo(e),qw.addRecord(e)}async setSpeakerDeviceInfo(e){const t=[];for(let i=0;i<e.length;i++)t.push("".concat(e[i].deviceId,"(").concat(e[i].label,")"));const r={event:DC.DEVICE_STATUS_SPEAKER,device_nums:e.length,device_list:t.join(",")};this.addCommInfo(r),qw.addRecord(r)}async setCameraDeviceInfo(e){const t=[];for(let i=0;i<e.length;i++)t.push("".concat(e[i].deviceId,"(").concat(e[i].label,")"));const r={event:DC.DEVICE_STATUS_CAMERA,device_nums:e.length,device_list:t.join(",")};this.addCommInfo(r),qw.addRecord(r)}async setMicrophoneDeviceInfo(e){const t=[];for(let i=0;i<e.length;i++)t.push("".concat(e[i].deviceId,"(").concat(e[i].label,")"));const r={event:DC.DEVICE_STATUS_MICROPHONE,device_nums:e.length,device_list:t.join(",")};this.addCommInfo(r),qw.addRecord(r)}setDeviceChangedInfo(e,t,r){this.logger.debug(this.module_,"setDeviceChangedInfo type[".concat(e,"] deviceId[").concat(t,"] state[").concat(r,"]"));let i=0;"audioinput"===e?i=1:"videoinput"===e&&(i=2);const n={timestamp:bR.getCurrentTimestamp(),event:DC.DEVICE_STATUS_DEVICE_CHANGE,type:i,name:t,state:r};this.addCommInfo(n),qw.addRecord(n),this.setDeviceStatusInfo()}setDeviceUserAgent(){const e={timestamp:bR.getCurrentTimestamp(),event:DC.DEVICE_STATUS_USERAGENT,user_agent:navigator.userAgent};this.addCommInfo(e),qw.reportRecords([e])}reportSignalReqForLogUpload(e){if(!Sk.isStatiscEnable())return;const t={event:NC.SIGNAL_REQUEST,event_name:"EVENT^log_upload^SDK^OPS",send_time:bR.getCurrentTimestamp(),req_body:e,result:0,source:"sdk",target:"access"};this.addCommInfo(t),qw.addRecord(t)}reportSignalReqForHeartBeatLost(e,t){var r;if(!Sk.isStatiscEnable()||"PING"!==e.type)return;let i="";null!==(r=e.body)&&void 0!==r&&r.action&&(i="#"+e.body.action);const n={timestamp:t,event:NC.SIGNAL_REQUEST,event_name:"SIGNAL^".concat(e.type).concat(i,"^SDK^ACS"),request_id:e.requestId,send_time:t,req_body:JSON.stringify(e),result:0,source:"sdk",target:"access"};this.addCommInfo(n),qw.addRecord(n)}reportSignalReqForWeb2Server(e){if(!Sk.isStatiscEnable()||!e.type||"PING"===e.type)return;const t="SIGNAL^".concat(e.type,"^SDK^ACS"),r=bR.getCurrentTimestamp(),i={timestamp:r,event:NC.SIGNAL_REQUEST,event_name:t,request_id:e.requestId,send_time:r,req_body:JSON.stringify(e),result:0,source:"sdk",target:"access"};this.addCommInfo(i),qw.addRecord(i)}reportSignalReqForServer2Web(e){if(Sk.isStatiscEnable()&&e.type)switch(e.type){case"WATCH_STREAM_NOTIFY":case"APP_DATA_NOTIFY":case"PUBLISH_STATUS_NOTIFY":case"NOTIFY_STATUS":case"UPLOAD_LOG_NOTIFY":case"DISCONNECT_NOTIFY":case"PUSH_STREAM_NOTIFY":case"RECONNECT_NOTIFY":case"STOP_PUSH_STREAM_NOTIFY":case"CHANGE_STREAM_STATUS_NOTIFY":{const t="SIGNAL^".concat(e.type),r={event:NC.SIGNAL_REQUEST,event_name:"".concat(t,"^ACS^SDK"),request_id:e.requestId,send_time:bR.getCurrentTimestamp(),req_body:JSON.stringify(e),result:0,source:"access",target:"sdk"};this.addCommInfo(r),qw.addRecord(r);break}}}reportSignalRepForLogUpload(e,t){if(!Sk.isStatiscEnable())return;const r={timestamp:bR.getCurrentTimestamp(),event:NC.SIGNAL_RESPONSE,event_name:"EVENT^log_upload^OPS^SDK",recv_time:bR.getCurrentTimestamp(),rsp_body:e,rsp_code:t,result:0,source:"access",target:"sdk"};this.addCommInfo(r),qw.addRecord(r)}reportSignalRepForServer2Web(e,t){if(!Sk.isStatiscEnable())return;const r="SIGNAL^".concat(e.type,"^SDK^ACS"),i=bR.getCurrentTimestamp(),n={event:NC.SIGNAL_RESPONSE,eventName:r,request_id:t.requestId,recv_time:i,rsp_body:JSON.stringify(t),rsp_code:t.result||0,result:t.result||0,source:"access",target:"sdk"};this.addCommInfo(n),qw.addRecord(n)}setApiCallInfo(e,t,r,i,n){if(!Sk.isStatiscEnable())return;const o="API^web#".concat(e,"^APP^SDK");for(var s=arguments.length,a=new Array(s>5?s-5:0),c=5;c<s;c++)a[c-5]=arguments[c];const u={api_call_id:bR.generateUuid(),api_name:o,start_time:t,end_time:r,event:UC.API_CALL,event_name:o,params:JSON.stringify(a)};i?u.exception="".concat(i.code," - ").concat(i.message):u.ret=n?JSON.stringify(n):"",this.addCommInfo(u),/checkSystemRequirements/.test(e)?qw.reportRecords([u]):qw.addRecord(u)}recordCallbackInfo(e,t,r,i,n,o){if(!Sk.isStatiscEnable())return;if(-1!==Db.indexOf(e))return;const s=o((null==n?void 0:n.stream)||n),a={event:UC.CALLBACK_API,event_name:"CALLBACK^web#".concat(t,"$#").concat(e,"#^SDK^APP"),api_call_id:bR.generateUuid(),callback_name:"CALLBACK^web#".concat(t,"$#").concat(e,"#^SDK^APP"),callback_type:e,params:s,start_time:r,end_time:i};this.addCommInfo(a),qw.addRecord(a)}recordCallbackInfoBeacon(e,t,r,i,n,o){if(!Sk.isStatiscEnable())return;if(-1!==Db.indexOf(e))return;const s=o((null==n?void 0:n.stream)||n),a={event:UC.CALLBACK_API,event_name:"CALLBACK^web#".concat(t,"$#").concat(e,"#^SDK^APP"),api_call_id:bR.generateUuid(),callback_name:"CALLBACK^web#".concat(t,"$#").concat(e,"#^SDK^APP"),callback_type:e,params:s,start_time:r,end_time:i};this.addCommInfo(a),qw.reportRecordsBeacon([a])}setFirstFrameInfo(e){if(!Sk.isStatiscEnable())return;const t={event:xC.FirstFrame,startupqos:e};this.addCommInfo(t),qw.addRecord(t)}setSpanId(e,t){t&&""!==t&&e&&""!==e&&this.spanIdMap.set(e,t)}getSpanId(e){if(e&&""!==e){const t=this.spanIdMap.get(e);return t&&this.spanIdMap.delete(e),t||""}return""}setParentSpanId(e,t){e&&""!==e&&t&&""!==t&&this.parentSpanIdMap.set(e,t)}getParentSpanId(e){if(e&&""!==e){const t=this.parentSpanIdMap.get(e);return t&&this.parentSpanIdMap.delete(e),t||""}return""}checkSignalReceiveMsgs(e){return this.signalReceiveMsgs.includes(e)}checkSignalSendMsgs(e){return this.signalSendMsgs.includes(e)}reportTraceInfo2Nuwa(e){if(!Sk.isStatiscEnable())return;const t={event:LC.TraceNuwa,trace_info:"".concat(e.version,"|").concat(e.startTimestamp,"|").concat(e.traceId,"|").concat(e.spanId,"|").concat(e.parentSpanId,"|").concat(e.ip,"|").concat(e.source,"|").concat(e.target,"|").concat(e.spanName,"|").concat(e.status,"|").concat(e.endTimestamp,"||||||||").concat(e.scope)};this.addCommInfo(t),qw.addRecord(t)}async buildRtcStatsDebugInfo(e){return this.mediaStats.buildRtcStatsDebugInfo(e)}}const vk={videoinput:"CameraChanged",audioinput:"RecordingDeviceChanged",audiooutput:"PlaybackDeviceChanged"},yk="ADD",Ik="REMOVE",Tk="DeviceChangeListener";const Rk=new class{constructor(){this.internalEventEmitters=[],this.clientEventEmitter=null,this.deviceChangeCallBack=[],this.initFlag=!1,this.logger=MR.getLogger(),this.stat=new Sk(this.logger)}initDeviceChangedNotify(e,t){this.addEventEmitter(e,t),this.initFlag||(this.initFlag=!0,this.registerDeviceChangedNotify())}addEventEmitter(e,t){t?this.internalEventEmitters.push(e):this.clientEventEmitter=e}removeEventEmitter(e){e!==this.clientEventEmitter?this.internalEventEmitters=this.internalEventEmitters.filter((t=>t!==e)):this.clientEventEmitter=null}registerDeviceChangedNotify(){let e=!1;nC().then((e=>{(!e||e.length<=0)&&this.logger.info(Tk,"no device available now"),e=e||[],this.preDevices=new Map;for(const t of e)MR.addPrivacyString(t.deviceId),t.deviceId&&"default"!==t.deviceId&&"communications"!==t.deviceId&&this.preDevices.set(t.deviceId,t.kind)})).finally((()=>{navigator.mediaDevices.ondevicechange=async t=>{if(t.isTrusted){if(this.deviceChangeCallBack.push(this.handleDeviceChangeEvent.bind(this)),!e)for(;this.deviceChangeCallBack.length>0;)e=!0,await this.deviceChangeCallBack.shift()(),this.deviceChangeCallBack.length<1&&(e=!1)}else this.logger.error(Tk,"device change event trigger by script")}}))}async handleDeviceChangeEvent(){let e=await nC();e=e||[];const t=new Map;for(const i of e)i.deviceId&&"default"!==i.deviceId&&"communications"!==i.deviceId&&t.set(i.deviceId,i.kind);let r=this.internalEventEmitters;this.clientEventEmitter&&(r=[...this.internalEventEmitters,this.clientEventEmitter]),this.preDevices.forEach(((e,i)=>{t.has(i)||(this.logger.info(Tk,"deviceType: ".concat(e," deviceId: ").concat(i," remove")),r.forEach((t=>{t.emit(hC[vk[e]],{deviceId:i,state:Ik})})),this.stat.setDeviceChangedInfo(e,i,1))})),t.forEach(((e,t)=>{this.preDevices.has(t)||(this.logger.info(Tk,"deviceType: ".concat(e," deviceId: ").concat(t," add")),r.forEach((r=>{r.emit(hC[vk[e]],{deviceId:t,state:yk})})),this.stat.setDeviceChangedInfo(e,t,0))})),this.preDevices=t}};function Ek(){}function bk(){bk.init.call(this)}function Ck(e){return void 0===e._maxListeners?bk.defaultMaxListeners:e._maxListeners}function Ak(e,t,r){if(t)e.call(r);else for(var i=e.length,n=Uk(e,i),o=0;o<i;++o)n[o].call(r)}function wk(e,t,r,i){if(t)e.call(r,i);else for(var n=e.length,o=Uk(e,n),s=0;s<n;++s)o[s].call(r,i)}function kk(e,t,r,i,n){if(t)e.call(r,i,n);else for(var o=e.length,s=Uk(e,o),a=0;a<o;++a)s[a].call(r,i,n)}function Ok(e,t,r,i,n,o){if(t)e.call(r,i,n,o);else for(var s=e.length,a=Uk(e,s),c=0;c<s;++c)a[c].call(r,i,n,o)}function Pk(e,t,r,i){if(t)e.apply(r,i);else for(var n=e.length,o=Uk(e,n),s=0;s<n;++s)o[s].apply(r,i)}function Mk(e,t,r,i){var n,o,s;if("function"!=typeof r)throw new TypeError('"listener" argument must be a function');if((o=e._events)?(o.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),o=e._events),s=o[t]):(o=e._events=new Ek,e._eventsCount=0),s){if("function"==typeof s?s=o[t]=i?[r,s]:[s,r]:i?s.unshift(r):s.push(r),!s.warned&&(n=Ck(e))&&n>0&&s.length>n){s.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=e,a.type=t,a.count=s.length,function(e){"function"==typeof console.warn?console.warn(e):console.log(e)}(a)}}else s=o[t]=r,++e._eventsCount;return e}function Dk(e,t,r){var i=!1;function n(){e.removeListener(t,n),i||(i=!0,r.apply(e,arguments))}return n.listener=r,n}function Nk(e){var t=this._events;if(t){var r=t[e];if("function"==typeof r)return 1;if(r)return r.length}return 0}function Uk(e,t){for(var r=new Array(t);t--;)r[t]=e[t];return r}Ek.prototype=Object.create(null),bk.EventEmitter=bk,bk.usingDomains=!1,bk.prototype.domain=void 0,bk.prototype._events=void 0,bk.prototype._maxListeners=void 0,bk.defaultMaxListeners=10,bk.init=function(){this.domain=null,bk.usingDomains&&undefined.active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new Ek,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},bk.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},bk.prototype.getMaxListeners=function(){return Ck(this)},bk.prototype.emit=function(e){var t,r,i,n,o,s,a,c="error"===e;if(s=this._events)c=c&&null==s.error;else if(!c)return!1;if(a=this.domain,c){if(t=arguments[1],!a){if(t instanceof Error)throw t;var u=new Error('Uncaught, unspecified "error" event. ('+t+")");throw u.context=t,u}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=a,t.domainThrown=!1,a.emit("error",t),!1}if(!(r=s[e]))return!1;var d="function"==typeof r;switch(i=arguments.length){case 1:Ak(r,d,this);break;case 2:wk(r,d,this,arguments[1]);break;case 3:kk(r,d,this,arguments[1],arguments[2]);break;case 4:Ok(r,d,this,arguments[1],arguments[2],arguments[3]);break;default:for(n=new Array(i-1),o=1;o<i;o++)n[o-1]=arguments[o];Pk(r,d,this,n)}return!0},bk.prototype.addListener=function(e,t){return Mk(this,e,t,!1)},bk.prototype.on=bk.prototype.addListener,bk.prototype.prependListener=function(e,t){return Mk(this,e,t,!0)},bk.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,Dk(this,e,t)),this},bk.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,Dk(this,e,t)),this},bk.prototype.removeListener=function(e,t){var r,i,n,o,s;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(i=this._events))return this;if(!(r=i[e]))return this;if(r===t||r.listener&&r.listener===t)0==--this._eventsCount?this._events=new Ek:(delete i[e],i.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(n=-1,o=r.length;o-- >0;)if(r[o]===t||r[o].listener&&r[o].listener===t){s=r[o].listener,n=o;break}if(n<0)return this;if(1===r.length){if(r[0]=void 0,0==--this._eventsCount)return this._events=new Ek,this;delete i[e]}else!function(e,t){for(var r=t,i=r+1,n=e.length;i<n;r+=1,i+=1)e[r]=e[i];e.pop()}(r,n);i.removeListener&&this.emit("removeListener",e,s||t)}return this},bk.prototype.removeAllListeners=function(e){var t,r;if(!(r=this._events))return this;if(!r.removeListener)return 0===arguments.length?(this._events=new Ek,this._eventsCount=0):r[e]&&(0==--this._eventsCount?this._events=new Ek:delete r[e]),this;if(0===arguments.length){for(var i,n=Object.keys(r),o=0;o<n.length;++o)"removeListener"!==(i=n[o])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=new Ek,this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},bk.prototype.listeners=function(e){var t,r,i=this._events;return r=i&&(t=i[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(t):[],r},bk.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):Nk.call(e,t)},bk.prototype.listenerCount=Nk,bk.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};const xk=new class{constructor(){t(this,"eventHandlers",{visibilitychange:()=>{let e="FOREGROUND";document.hidden&&(e="BACKGROUND");for(const t of this.eventBus.values())t.emit(e)}}),t(this,"eventListeners",{visibilitychange:e=>{"ADD"===e?document.addEventListener("visibilitychange",this.eventHandlers.visibilitychange):document.removeEventListener("visibilitychange",this.eventHandlers.visibilitychange)}}),this.eventBus=new Map,this.addListener("visibilitychange",bR.isMobileDevice.bind(bR))}register(e){const t=bR.generateRandomId(32);return this.eventBus.set(t,e),t}unregister(e){e&&this.eventBus.delete(e)}addListener(e,t){t&&!t()||this.eventListeners[e]&&this.eventListeners[e]("ADD")}removeListener(e){this.eventListeners[e]&&this.eventListeners[e]("REMOVE")}};class Lk{constructor(){this.context_=new AudioContext,this.script_=this.context_.createScriptProcessor(2048,1,1),this.script_.onaudioprocess=e=>{const t=e.inputBuffer.getChannelData(0);let r=0,i=0;for(let n=0;n<t.length;n++)r+=t[n]*t[n],Math.abs(t[n])>.99&&(i+=1);this.instant_=Math.sqrt(r/t.length),this.slow_=.95*this.slow_+.05*this.instant_,this.clip_=i/t.length},this.instant_=0,this.slow_=0,this.clip_=0}connectToSource(e){return new Promise(((t,r)=>{try{const r=new MediaStream;r.addTrack(e),this.mic_=this.context_.createMediaStreamSource(r),this.mic_.connect(this.script_),this.script_.connect(this.context_.destination),t()}catch(lw){r(lw)}}))}stop(){this.mic_.disconnect(),this.script_.disconnect(),this.context_.close()}getVolume(){return parseFloat(this.instant_.toFixed(2))}}class Bk{constructor(e){this.module_="RTCPlayer",this.mediaStream_=new MediaStream,this.log_=e.logger,this.track_=e.track,this.playerDiv_=e.playerDiv,this.playerId_=e.playerId,this.playerElement_=null,this.state_="NONE",this.event_=new bk,this.pauseCount=0,this.listenHandlers={canPlayHandler:this.canPlayHandler.bind(this),playingHandler:this.playingHandler.bind(this),playerEndedHandler:this.playerEndedHandler.bind(this),playerPausedHandler:this.playerPausedHandler.bind(this),trackEndedHandler:this.trackEndedHandler.bind(this),trackMutedHandler:this.trackMutedHandler.bind(this),trackUnmutedHandler:this.trackUnmutedHandler.bind(this),playHandler:null,backgroundHandler:this.backgroundHandler.bind(this),foregroundHandler:this.foregroundHandler.bind(this)}}on(e,t){this.event_.on(e,t)}off(e,t){this.event_.removeListener(e,t)}foregroundHandler(){this.log_.debug("".concat(this.module_,"#").concat(this.playerId_),"handleEvents, application is foreground"),this.module_.indexOf("Audio")>0&&this.track_&&this.trackEnable!==this.track_.enabled&&(this.track_.enabled=this.trackEnable),"PAUSED"===this.state_&&(this.module_.indexOf("Video")>0?this.event_.emit("videoCanPlay"):this.event_.emit("audioCanPlay"))}backgroundHandler(){this.log_.debug("".concat(this.module_,"#").concat(this.playerId_),"handleEvents, application is background"),this.module_.indexOf("Audio")>0&&this.track_&&(this.trackEnable=this.track_.enabled,this.trackEnable&&(this.track_.enabled=!1))}canPlayHandler(){this.log_.debug("".concat(this.module_,"#").concat(this.playerId_),"handleEvents, player is canplay status"),this.event_.emit(this.module_.indexOf("Video")>0?"videoCanPlay":"audioCanPlay"),this.event_.emit(Mb,{event:"playerCanplay",type:"".concat(this.module_),streamId:this.playerId_})}playingHandler(){this.log_.debug("".concat(this.module_,"#").concat(this.playerId_),"handleEvents, player is starting playing"),this.event_.emit(Mb,{event:"playerPlaying",type:"".concat(this.module_),streamId:this.playerId_}),this.state_="PLAYING",this.event_.emit(wb,{state:this.state_,reason:"playing"})}playerEndedHandler(){this.log_.debug("".concat(this.module_,"#").concat(this.playerId_),"handleEvents, player is ended"),this.event_.emit(Mb,{event:"playerEnded",type:"".concat(this.module_),streamId:this.playerId_}),"STOPPED"!==this.state_&&(this.state_="STOPPED",this.event_.emit(wb,{state:this.state_,reason:"ended"}))}playerPausedHandler(){this.log_.debug("".concat(this.module_,"#").concat(this.playerId_),"handleEvents, player is paused"),this.event_.emit(Mb,{event:"playerPause",type:"".concat(this.module_),streamId:this.playerId_}),this.state_="PAUSED",this.event_.emit(wb,{state:this.state_,reason:"pause"}),this.module_.indexOf("Video")>0?(this.log_.debug("".concat(this.module_,"#").concat(this.playerId_),"try to play again"),this.event_.emit("videoCanPlay")):(this.log_.debug("".concat(this.module_,"#").concat(this.playerId_),"try to play again"),this.event_.emit("audioCanPlay"))}trackEndedHandler(){this.log_.debug("".concat(this.module_,"#").concat(this.playerId_),"handleEvents, player track is ended"),this.event_.emit(Mb,{event:"trackEnded",type:"".concat(this.module_),streamId:this.playerId_}),"STOPPED"!==this.state_&&(this.state_="STOPPED",this.event_.emit(wb,{state:this.state_,reason:"ended",trackEnded:!0}))}trackMutedHandler(){this.log_.debug("".concat(this.module_,"#").concat(this.playerId_),"handleEvents, track is muted"),this.event_.emit(Mb,{event:"trackMute",type:"".concat(this.module_),streamId:this.playerId_}),"PAUSED"!==this.state_&&(this.state_="PAUSED",this.event_.emit(wb,{state:this.state_,reason:"mute"}))}trackUnmutedHandler(){this.log_.debug("".concat(this.module_,"#[").concat(this.playerId_,"]"),"handleEvents, track is unmuted"),this.event_.emit(Mb,{event:"trackUnmute",type:"".concat(this.module_),streamId:this.playerId_}),"PAUSED"===this.state_&&(this.state_="PLAYING",this.event_.emit(wb,{state:this.state_,reason:"unmute"}))}closeAllEvents(){var e,t,r,i,n,o,s,a,c;null===(e=this.playerElement_)||void 0===e||e.removeEventListener("canplay",this.listenHandlers.canPlayHandler),null===(t=this.playerElement_)||void 0===t||t.removeEventListener("playing",this.listenHandlers.playingHandler),null===(r=this.playerElement_)||void 0===r||r.removeEventListener("ended",this.listenHandlers.playerEndedHandler),null===(i=this.playerElement_)||void 0===i||i.removeEventListener("pause",this.listenHandlers.playerPausedHandler),null===(n=this.track_)||void 0===n||n.removeEventListener("ended",this.listenHandlers.trackEndedHandler),null===(o=this.track_)||void 0===o||o.removeEventListener("mute",this.listenHandlers.trackMutedHandler),null===(s=this.track_)||void 0===s||s.removeEventListener("unmute",this.listenHandlers.trackUnmutedHandler),null===(a=this.event_)||void 0===a||a.removeListener("videoCanPlay",this.listenHandlers.playHandler),null===(c=this.event_)||void 0===c||c.removeListener("audioCanPlay",this.listenHandlers.playHandler),this.event_.removeListener("FOREGROUND",this.listenHandlers.foregroundHandler),this.event_.removeListener("BACKGROUND",this.listenHandlers.backgroundHandler),xk.unregister(this.sysEventRegisterUid)}handleEvents(){this.playerElement_.addEventListener("canplay",this.listenHandlers.canPlayHandler),this.playerElement_.addEventListener("playing",this.listenHandlers.playingHandler),this.playerElement_.addEventListener("ended",this.listenHandlers.playerEndedHandler),this.playerElement_.addEventListener("pause",this.listenHandlers.playerPausedHandler),this.track_.addEventListener("ended",this.listenHandlers.trackEndedHandler),this.track_.addEventListener("mute",this.listenHandlers.trackMutedHandler),this.track_.addEventListener("unmute",this.listenHandlers.trackUnmutedHandler),this.event_.on("FOREGROUND",this.listenHandlers.foregroundHandler),this.event_.on("BACKGROUND",this.listenHandlers.backgroundHandler),this.sysEventRegisterUid=xk.register(this.event_)}stop(){this.closeAllEvents(),this.playerElement_&&(this.playerElement_.srcObject=null),this.playerElement_=null,this.mediaStream_=new MediaStream,this.log_.info(this.module_,"stop success")}replaceTrack(e){this.log_.info(this.module_,"replaceTrack start");const t=this.module_.indexOf("Audio")>0?this.mediaStream_.getAudioTracks():this.mediaStream_.getVideoTracks(),r=t.length?t[0]:null;r!==e&&(r&&this.mediaStream_.removeTrack(r),this.mediaStream_.addTrack(e),this.track_=e)}async resume(e){return new Promise(((t,r)=>{this.playerElement_?this.playerElement_.play().then((()=>{this.log_.info(this.module_,"audio player resume success, streamId:".concat(this.playerId_,", playParameters: ").concat(JSON.stringify(e))),t(null)})).catch((t=>{this.log_.error(this.module_,"player resume failed, errmsg=".concat(t," , playParameters: ").concat(JSON.stringify(e))),"NotAllowedError"===t.name?r(new qc(Wc.RTC_ERR_CODE_PLAY_NOT_ALLOW)):r(new qc(Wc.RTC_ERR_CODE_RTC_SDK_ERROR,t.message))})):r(new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"resume failed, element is null"))}))}async multiPlatformAdapter(){return new Promise((e=>{if(bR.isWKWebview()){const t=window.WeixinJSBridge;t?(this.log_.info(this.module_,"multiPlatformAdapter handle begin"),t.invoke("getNetworkType",{},(()=>{e()}),!1)):document.addEventListener("WeixinJSBridgeReady",(()=>{this.log_.info(this.module_,"multiPlatformAdapter WeixinJSBridgeReady,  handle begin"),t.invoke("getNetworkType",{},(()=>{e()}),!1)}))}else e()}))}async doPlay(e,t,r){let i;return await this.multiPlatformAdapter(),i=this.module_.indexOf("Video")>0?", screenFit:".concat(r.objectFit,", mirror:").concat(r.mirror):", deviceId:".concat(r.outputDeviceId,", volume:").concat(r.volume,", muted:").concat(r.muted),this.playerElement_.play().then((()=>{var t,r;this.log_.info(this.module_,"play success, parentDiv id:".concat(null===(t=this.playerDiv_)||void 0===t?void 0:t.id,", resolutionId or streamId:").concat(this.playerId_,", physical track id:").concat(null===(r=this.track_)||void 0===r?void 0:r.id).concat(i)),this.afterPlayStrategy(),e(null)})).catch((e=>{var r,n;this.log_.error(this.module_,"play failed, errmsg=".concat(e,",parentDiv id:").concat(null===(r=this.playerDiv_)||void 0===r?void 0:r.id,", resolutionId or streamId:").concat(this.playerId_,", physical track id:").concat(null===(n=this.track_)||void 0===n?void 0:n.id).concat(i)),"NotAllowedError"===e.name?t(new qc(Wc.RTC_ERR_CODE_PLAY_NOT_ALLOW)):t(new qc(Wc.RTC_ERR_CODE_RTC_SDK_ERROR,e.message))})).finally((()=>{clearTimeout(this.playTimeOutTimer)}))}afterPlayStrategy(){if(!this.pauseCount&&bR.getPlatform().indexOf("Ios15")>=0){this.log_.error(this.module_,bR.getPlatform());const e=setTimeout((()=>{clearTimeout(e),this.playerElement_.pause(),this.pauseCount++}),100)}}}class Vk extends Bk{constructor(e){super({logger:e.logger,track:e.track,playerDiv:e.playerDiv,playerId:e.playerId}),this.module_="RTCAudioPlayer",this.muted_=e.muted,this.outputDeviceId_="",this.volume_="number"==typeof(null==e?void 0:e.volume)?e.volume:.5,this.soundMeter_=null}async play(){return new Promise(((e,t)=>{let r,i=!0;var n;(r=this.playerDiv_?this.playerDiv_.querySelector("#audio_".concat(this.playerId_)):this.playerElement_,r)||(r=document.createElement("audio"),r.muted=this.muted_,r.setAttribute("id","audio_".concat(this.playerId_)),r.setAttribute("autoplay",""),r.setAttribute("playsinline",""),r.setAttribute("muted",""),null===(n=this.playerDiv_)||void 0===n||n.appendChild(r),i=!1);"sinkId"in HTMLMediaElement.prototype&&this.outputDeviceId_&&r.setSinkId(this.outputDeviceId_),0===this.mediaStream_.getAudioTracks().length&&this.mediaStream_.addTrack(this.track_),r.srcObject=this.mediaStream_,this.playerElement_=r,this.setVolume(this.volume_),this.handleEvents(),clearTimeout(this.playTimeOutTimer),this.playTimeOutTimer=setTimeout((()=>{this.log_.info(this.module_,"trigger audioCanPlay event by Timer"),this.event_.emit("audioCanPlay"),this.playTimeOutTimer&&(clearTimeout(this.playTimeOutTimer),this.playTimeOutTimer=setTimeout((()=>{this.log_.info(this.module_,"audio playing timeout"),clearTimeout(this.playTimeOutTimer),this.playTimeOutTimer=null,e(null)}),2e3))}),i?0:1e3),this.listenHandlers.playHandler&&this.event_.removeListener("audioCanPlay",this.listenHandlers.playHandler),this.listenHandlers.playHandler=this.doPlay.bind(this,e,t,{deviceId:this.outputDeviceId_,volume:this.volume_,muted:this.muted_}),this.event_.on("audioCanPlay",this.listenHandlers.playHandler)}))}async setSinkId(e){this.outputDeviceId_!==e&&(await this.playerElement_.setSinkId(e),this.outputDeviceId_=e)}setVolume(e){this.playerElement_.volume=e}getAudioLevel(){return this.soundMeter_||(this.soundMeter_=new Lk,this.soundMeter_.connectToSource(this.track_)),this.soundMeter_.getVolume()}stop(){super.stop(),this.soundMeter_&&(this.soundMeter_.stop(),this.soundMeter_=null)}async resume(){return super.resume({streamId:this.playerId_,deviceId:this.outputDeviceId_,volume:this.volume_,muted:this.muted_})}replaceTrack(e){super.replaceTrack(e),this.soundMeter_&&(this.soundMeter_.stop(),this.soundMeter_=null)}}class Yk extends Bk{constructor(e){super({logger:e.logger,track:e.track,playerDiv:e.parentDiv,playerId:e.playerId}),this.module_="RTCVideoPlayer",this.objectFit_=e.objectFit,this.mirror_=e.mirror}async play(){return new Promise(((e,t)=>{let r=this.playerDiv_.querySelector("#video_".concat(this.playerId_)),i=!0;if(!r){r=document.createElement("video"),r.muted=!0;let e="0";this.mirror_&&(e="180deg"),r.setAttribute("id","video_".concat(this.playerId_)),r.style.width="100%",r.style.height="100%",r.style.position="absolute",r.style.transform="rotateY(".concat(e,")"),r.style["object-fit"]=this.objectFit_,r.setAttribute("autoplay",""),r.setAttribute("playsinline",""),r.setAttribute("muted",""),this.playerDiv_.appendChild(r),i=!1}0===this.mediaStream_.getVideoTracks().length&&this.mediaStream_.addTrack(this.track_),r.srcObject=this.mediaStream_,this.playerElement_=r,this.handleEvents(),clearTimeout(this.playTimeOutTimer),this.playTimeOutTimer=setTimeout((()=>{this.log_.info(this.module_,"trigger videoCanPlay event by Timer"),this.event_.emit("videoCanPlay"),this.playTimeOutTimer&&(clearTimeout(this.playTimeOutTimer),this.playTimeOutTimer=setTimeout((()=>{this.log_.info(this.module_,"video playing timeout"),clearTimeout(this.playTimeOutTimer),this.playTimeOutTimer=null,e(null)}),2e3))}),i?0:1e3),this.listenHandlers.playHandler&&this.event_.removeListener("videoCanPlay",this.listenHandlers.playHandler),this.listenHandlers.playHandler=this.doPlay.bind(this,e,t,{objectFit:this.objectFit_,mirror:this.mirror_}),this.event_.on("videoCanPlay",this.listenHandlers.playHandler)}))}async resume(){return super.resume({streamId:this.playerId_,screentFit:this.objectFit_,mirror:this.mirror_})}getVideoFrame(){const e=document.createElement("canvas");return e.width=this.playerElement_.videoWidth,e.height=this.playerElement_.videoHeight,e.getContext("2d").drawImage(this.playerElement_,0,0),e.toDataURL("image/png")}}function jk(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function Fk(e){for(var r=1;r<arguments.length;r++){var i=null!=arguments[r]?arguments[r]:{};r%2?jk(Object(i),!0).forEach((function(r){t(e,r,i[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):jk(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function Hk(e){const t=Vb.find((t=>t.startsWith("".concat(e.height))&&Bb[t].width===e.width||parseInt(t)>e.height));t&&(e.maxBitrate&&e.minBitrate||(e.maxBitrate=Bb[t].maxBitrate,e.minBitrate=Bb[t].minBitrate),e.frameRate||(e.frameRate=Bb[t].frameRate))}class Kk{static getLocalProfileByTrack(e){const t={},r=e.getSettings();if(e.kind===ok.TRACK_TYPE_AUDIO)t.sampleRate=r.sampleRate,t.channelCount=1;else{var i,n,o,s;const a=e.getConstraints();t.width=("number"==typeof a.width?a.width:null===(i=a.width)||void 0===i?void 0:i.ideal)||r.width,t.height=("number"==typeof a.height?a.height:null===(n=a.height)||void 0===n?void 0:n.ideal)||r.height,t.frameRate=("number"==typeof a.frameRate?a.frameRate:null===(o=a.frameRate)||void 0===o?void 0:o.ideal)||parseInt(null===(s=r.frameRate)||void 0===s?void 0:s.toString()),t.minBitrate=null,t.maxBitrate=null,Hk(t)}return t}static formatVideoProfile(e){let t={};if(!e){return t=Fk({},Bb["360p_2"]),t}if("string"==typeof e){if(Vb.includes(e)){t=Fk({},Bb[e])}}else t.height=e.height,t.width=e.width,t.frameRate=e.frameRate,t.maxBitrate=e.maxBitrate,t.minBitrate=e.minBitrate,void 0!==t.width&&void 0!==t.height||(t.width=Bb["360p_2"].width,t.height=Bb["360p_2"].height),Hk(t);return t}static formatAudioProfile(e){let t={};if(!e){return t=Fk({},xb.standard),t}if("string"==typeof e){if(Lb.includes(e)){t=Fk({},xb[e])}}else t.bitrate=e.bitrate,t.channelCount=e.channelCount,t.sampleRate=e.sampleRate,t.sampleRate||(t.sampleRate=16e3),t.channelCount||(t.channelCount=1),t.bitrate||(t.bitrate=24e3);return t}static formatScreenProfile(e){let t={};if(!e){return t=Fk({},Yb["720p"]),t}if("string"==typeof e){if(jb.includes(e)){t=Fk({},Yb[e])}}else t.height=e.height,t.width=e.width,t.bitrate=e.bitrate,t.frameRate=e.frameRate,t.width&&t.height||(t.width=Yb["720p"].width,t.height=Yb["720p"].height),t.frameRate||(t.frameRate=15),t.bitrate||(t.bitrate=Yb["720p"].bitrate);return t}}class zk{static getOptimalVideoConstraint(e,t){const r={},i=[];["user","environment","left","right"].includes(e)?r.facingMode={exact:e}:r.deviceId={exact:e};const n=[{width:t.width,height:t.height},{aspectRatio:t.width/t.height}];i.push(...n),bR.isSupportConstraints("aspectRatio")&&(r.aspectRatio={ideal:t.width/t.height}),r.width={min:Bb["90p_2"].width,ideal:t.width},r.height={min:Bb["90p_2"].height,ideal:t.height},r.frameRate={ideal:t.frameRate},r.advanced=i;const o={};return o.video=r,o}static getSuboptimalVideoConstraint(e,t){const r={};["user","environment","left","right"].includes(e)?r.facingMode={exact:e}:r.deviceId={exact:e},bR.isSupportConstraints("aspectRatio")&&(r.aspectRatio={exact:t.width/t.height}),r.width={min:Bb["90p_2"].width,ideal:t.width},r.height={min:Bb["90p_2"].height,ideal:t.height},r.frameRate={ideal:t.frameRate};const i={};return i.video=r,i}static getNextVideoConstraint(e,t){const r={};["user","environment","left","right"].includes(e)?r.facingMode={exact:e}:r.deviceId={exact:e},bR.isSupportConstraints("aspectRatio")&&(r.aspectRatio={ideal:t.width/t.height}),r.width={min:Bb["90p_2"].width,ideal:t.width},r.height={min:Bb["90p_2"].height,ideal:t.height},r.frameRate={ideal:t.frameRate};const i={};return i.video=r,i}static getWorstVideoConstraint(e,t){const r={};["user","environment","left","right"].includes(e)?r.facingMode={ideal:e}:r.deviceId={ideal:e},bR.isSupportConstraints("aspectRatio")&&(r.aspectRatio={ideal:t.width/t.height}),r.width={min:Bb["90p_2"].width,ideal:t.width},r.height={min:Bb["90p_2"].height,ideal:t.height},r.frameRate={ideal:t.frameRate};const i={};return i.video=r,i}static getRecoveryVideoConstraint(){const e={video:!0};return e}static initScreenShareConstraint(e,t){const r={};if(r.video={width:t.width||void 0,height:t.height||void 0,frameRate:{ideal:t.frameRate}},e){const e={sampleRate:xb.high.sampleRate,channelCount:1,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0};dw.isChrome()&&(e.googNoiseSuppression=!0,e.googAutoGainControl=!0,e.googAutoGainControl2=!0),r.audio=e}return r}static initAudioConstraint(e,t){const r={},i={sampleRate:t.sampleRate,channelCount:t.channelCount,deviceId:e,echoCancellation:!0};return dw.isFirefox()&&e&&(i.deviceId={exact:e}),i.noiseSuppression=!0,i.autoGainControl=!0,dw.isChrome()&&(i.googNoiseSuppression=!0,i.googAutoGainControl=!0,i.googAutoGainControl2=!0),r.audio=i,r}}var Wk;!function(e){e[e.Stopped=0]="Stopped",e[e.Playing=1]="Playing",e[e.Closed=2]="Closed"}(Wk||(Wk={}));const Gk="HRTCTrack";class qk{constructor(e){this.log_=e.logger||MR.getLogger(),this.trackType_=e.trackType,this.streamType_=e.streamType,this.isRemote_=e.isRemote,this.resolutionId_=e.resolutionId,e.track?this.setLocalProfileByTrack(e.track):this.setTrackProfile(e.trackProfile),this.track_=e.track,this.playState_=Wk.Closed,this.trackMuted_=!1,this.event_=e.event||new bk,this.trackType_===ok.TRACK_TYPE_AUDIO?this.statusChangeReporter_=e=>{this.event_.emit(wb,{type:ok.TRACK_TYPE_AUDIO,id:this.getResolutionId(),state:e.state,reason:e.reason})}:this.statusChangeReporter_=e=>{this.event_.emit(wb,{type:ok.TRACK_TYPE_VIDEO,id:this.getResolutionId(),state:e.state,reason:e.reason})},this.statusTraceReporter_=e=>{this.event_.emit(Mb,e)}}async initScreenShare(e){const t=zk.initScreenShareConstraint(e,this.profile_);this.log_.info(Gk,"initScreenShare, screen constraints: ".concat(JSON.stringify(t)));const r=[],i={type:ok.TRACK_TYPE_AUDIO},n={type:ok.TRACK_TYPE_VIDEO};return new Promise((o=>{navigator.mediaDevices.getDisplayMedia(t).then((t=>{const r=t.getVideoTracks()[0];this.track_&&(this.track_.stop(),this.player_&&this.player_.replaceTrack(r)),this.track_=r,n.track=r,this.content=iC.desktop,r.onended=()=>{this.event_.emit(kb,this.trackId_||this.resolutionId_)},e&&(0===(t.getAudioTracks()||[]).length?this.log_.info(Gk,"initScreenShare, cannot capture system output audio, pls make sure checked the share Audio option in share page"):i.track=t.getAudioTracks()[0])})).catch((e=>{this.log_.error(Gk,"initScreenShare, getDisplayMedia failed, errMsg= ".concat(e)),i.error=this.handleCaptureError(e),n.error=i.error})).finally((()=>{r.push(i),r.push(n),o(r)}))}))}async initAudioCapture(e){const t=zk.initAudioConstraint(e,this.profile_);return await this.getUserMedia(t,ok.TRACK_TYPE_AUDIO,iC.main)}async initVideoCapture(e,t){let r;return this.log_.info(Gk,"initVideoCapture, try getOptimalVideoConstraint"),r=await this.getUserMedia(zk.getOptimalVideoConstraint(e,this.profile_),ok.TRACK_TYPE_VIDEO,t),qk.isTrackAvailable(r.track)?r:(this.log_.info(Gk,"initVideoCapture, try getSuboptimalVideoConstraint"),r=await this.getUserMedia(zk.getSuboptimalVideoConstraint(e,this.profile_),ok.TRACK_TYPE_VIDEO,t),qk.isTrackAvailable(r.track)?r:(this.log_.info(Gk,"initVideoCapture, try getNextVideoConstraint"),r=await this.getUserMedia(zk.getNextVideoConstraint(e,this.profile_),ok.TRACK_TYPE_VIDEO,t),qk.isTrackAvailable(r.track)?r:(this.log_.info(Gk,"initVideoCapture, try getWorstVideoConstraint"),r=await this.getUserMedia(zk.getWorstVideoConstraint(e,this.profile_),ok.TRACK_TYPE_VIDEO,t),qk.isTrackAvailable(r.track)?r:(this.log_.info(Gk,"initVideoCapture, try getRecoveryVideoConstraint"),await this.getUserMedia(zk.getRecoveryVideoConstraint(),ok.TRACK_TYPE_VIDEO,t)))))}async getUserMedia(e,t,r){const i={type:t};try{var n;null===(n=this.track_)||void 0===n||n.stop();const o=await navigator.mediaDevices.getUserMedia(e),s=t===ok.TRACK_TYPE_VIDEO?o.getVideoTracks()[0]:o.getAudioTracks()[0];return await this.replaceTrack(s),i.track=this.track_,this.content=r,i.type===ok.TRACK_TYPE_VIDEO&&this.setCameraCaptureReport(),i}catch(kD){return i.error=this.handleCaptureError(kD,t),i}}static isTrackAvailable(e){return!!e&&(e.enabled&&!e.muted&&"live"===e.readyState)}setCameraCaptureReport(){this.cameraCaptureHandleTimer&&clearInterval(this.cameraCaptureHandleTimer),this.cameraCaptureHandleTimer=setInterval((()=>{if(this.track_&&this.profile_){var e;const t=this.track_.getSettings(),r={width:this.profile_.width,height:this.profile_.height,frameRate:parseInt(null===(e=this.profile_.frameRate)||void 0===e?void 0:e.toString())||0};this.event_.emit(Nb.CameraCapture,t,r)}}),2e3)}clearCameraCaptureReport(){this.cameraCaptureHandleTimer&&clearInterval(this.cameraCaptureHandleTimer)}handleCaptureError(e,t){if(/.*Malformed constraints.*/gi.test(e.message))return this.log_.warn(Gk,"init ".concat(t||"screen","capture getUserMedia failed, handleCaptureError: ").concat(e)),null;const r=e.name||"";let i;return i=/.*NotAllowedError.*/gi.test(r)?new qc(Wc.RTC_ERR_CODE_CAPTURE_PERMISSION_DENIED):/.*OverConstrainedError.*/gi.test(r)?new qc(Wc.RTC_ERR_CODE_CAPTURE_OVER_CONSTRAINED):/.*NotReadableError.*/gi.test(r)?new qc(Wc.RTC_ERR_CODE_CAPTURE_DEVICE_NOT_READABLE):/.*NotFoundError.*/gi.test(r)?new qc(Wc.RTC_ERR_CODE_CAPTURE_DEVICE_NOT_FOUND):new qc(Wc.RTC_ERR_CODE_RTC_SDK_ERROR,e.message),this.log_.error(Gk,"init ".concat(t||"screen","capture getUserMedia failed, handleCaptureError: ").concat(i)),i}isClosed(){return this.playState_===Wk.Closed}isPlaying(){return this.playState_===Wk.Playing}getTrackType(){return this.trackType_}getResolutionId(){return this.resolutionId_}getTrackId(){return this.trackId_}getElementId(){return this.elementId_}getObjectFit(){return this.objectFit_}setTrackId(e){this.trackId_=e}getTrackProfile(){return this.profile_}setTrackContentType(e){this.content=e}getTrackContentType(){return this.content||iC.main}updateTrackProfile(e){this.trackType_===ok.TRACK_TYPE_VIDEO&&e&&(this.profile_.width=e.width,this.profile_.height=e.height)}setTrackProfile(e){this.log_.info(Gk,"setTrackProfile begin,uniqueId_:".concat(this.resolutionId_,", ").concat(this.trackType_,",")+"".concat(this.streamType_,", profile:").concat(JSON.stringify(e))),this.trackType_!==ok.TRACK_TYPE_AUDIO?this.trackType_!==ok.TRACK_TYPE_VIDEO||this.streamType_!==sk.STREAM_TYPE_MAIN?this.trackType_===ok.TRACK_TYPE_VIDEO&&this.streamType_===sk.STREAM_TYPE_AUX&&(this.profile_=Kk.formatScreenProfile(e)):this.profile_=Kk.formatVideoProfile(e):this.profile_=Kk.formatAudioProfile(e)}getTrack(){return this.track_}async replaceTrack(e){var t;if(e){var r;if(null===(t=this.player_)||void 0===t||t.replaceTrack(e),!this.isRemote_)null===(r=this.track_)||void 0===r||r.stop();this.track_=e,this.track_.enabled=!this.trackMuted_,this.isRemote_||(this.setLocalProfileByTrack(e),this.playState_===Wk.Playing&&await this.restart())}}setLocalProfileByTrack(e){this.profile_=Kk.getLocalProfileByTrack(e),this.log_.info(Gk,"setLocalProfileByTrack, this.profile_:".concat(JSON.stringify(this.profile_)))}removeTrack(){var e;(this.player_&&this.player_.stop(),this.isRemote_)||(null===(e=this.track_)||void 0===e||e.stop());this.track_=null}async play(e,t,r){const i=this.getTrackType();if(this.log_.info(Gk,"".concat(i," track begin play, elementId:").concat(t,", playerDiv.id:").concat(e.id,", options:").concat(JSON.stringify(r)," ")),this.playState_===Wk.Playing)return this.log_.info(Gk,"".concat(i," track is playing, return")),{trackType:i,error:null};if(!this.track_)return this.log_.error(Gk,"".concat(i," track is empty")),{trackType:i,error:new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"".concat(i," track is empty"))};switch(this.elementId_=t,this.trackType_){case ok.TRACK_TYPE_AUDIO:this.player_||(this.log_.info(Gk,"create AudioPlayer"),this.player_=new Vk({logger:this.log_,playerDiv:e,playerId:this.getTrackId()||this.getResolutionId(),track:this.track_,muted:r.muted,volume:this.audioVolume_}));break;case ok.TRACK_TYPE_VIDEO:this.objectFit_=r.objectFit,this.player_||(this.log_.info(Gk,"create VideoPlayer"),this.player_=new Yk({logger:this.log_,parentDiv:e,playerId:this.getTrackId()||this.getResolutionId(),track:this.track_,objectFit:r.objectFit,mirror:r.mirror}))}this.player_.off(wb,this.statusChangeReporter_),this.player_.on(wb,this.statusChangeReporter_),this.player_.off(Mb,this.statusTraceReporter_),this.player_.on(Mb,this.statusTraceReporter_),this.log_.info(Gk,"play ".concat(i," track start")),this.playState_=Wk.Playing;try{return await this.player_.play(),{trackType:i,error:null}}catch(kD){const t=kD instanceof qc&&/.*timeout.*/i.test(kD.getMsg());return this.log_[t?"warn":"error"](Gk,"play ".concat(i," failed: ").concat(kD)),this.playState_=Wk.Stopped,{trackType:i,error:kD}}}async replay(){if(!this.player_)return this.log_.info(Gk,"".concat(this.getTrackType()," player is null")),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"".concat(this.getTrackType()," player is null"));this.player_.off(wb,this.statusChangeReporter_),this.player_.on(wb,this.statusChangeReporter_),this.player_.off(Mb,this.statusTraceReporter_),this.player_.on(Mb,this.statusTraceReporter_),this.log_.info(Gk,"rePlay ".concat(this.getTrackType()," track start")),this.playState_=Wk.Playing;try{return await this.player_.play(),null}catch(kD){return this.log_.error(Gk,"replay".concat(this.getTrackType(),", replay failed: ").concat(kD)),this.playState_=Wk.Stopped,kD}}stop(){this.player_?(this.player_.off(wb,this.statusChangeReporter_),this.player_.stop(),this.player_=null,this.playState_=Wk.Stopped,this.trackMuted_=!1,this.log_.info(Gk,"".concat(this.getTrackType()," stop player success"))):this.log_.info(Gk,"".concat(this.getTrackType()," player is null"))}close(){var e;(this.stop(),this.isRemote_)||(null===(e=this.track_)||void 0===e||e.stop());this.elementId_="",this.log_.info(Gk,"".concat(this.getTrackType()," close success")),this.playState_=Wk.Closed,this.clearCameraCaptureReport()}async resume(){if(!this.player_)return this.log_.info(Gk,"".concat(this.getTrackType()," player is null")),null;try{return await this.player_.resume(),null}catch(kD){return this.log_.error(Gk,"".concat(this.getTrackType()," resume failed: ").concat(kD)),kD}}async restart(){this.player_&&(this.player_.stop(),await this.player_.play(),this.log_.info(Gk,"restart success"))}getTrackMuted(){return this.track_?!this.track_.enabled:this.trackMuted_}muteTrack(){this.track_&&(this.track_.enabled=!1),this.trackMuted_=!0}unmuteTrack(){this.track_&&(this.track_.enabled=!0),this.trackMuted_=!1}async setSinkId(e){this.trackType_===ok.TRACK_TYPE_AUDIO&&this.player_&&await this.player_.setSinkId(e)}setAudioVolume(e){this.trackType_===ok.TRACK_TYPE_AUDIO&&(this.audioVolume_=e/100,this.player_&&this.player_.setVolume(this.audioVolume_))}getAudioLevel(){return this.trackType_===ok.TRACK_TYPE_AUDIO&&this.player_?this.player_.getAudioLevel():0}getVideoFrame(){return this.trackType_===ok.TRACK_TYPE_VIDEO&&this.player_?this.player_.getVideoFrame():null}setAudioOutput(e){this.trackType_===ok.TRACK_TYPE_AUDIO&&this.player_&&this.player_.setSinkId(e)}}const Jk="AsyncLock";class Xk{constructor(){t(this,"callback_",[]),this.callback_=[],this.logger=MR.getLogger()}async lock(e){this.logger.info(Jk,"".concat(e," try to get lock")),await new Promise((t=>{const r={callbackFunc:()=>t(),lockTrigger:"".concat(e)};this.callback_.push(r),1===this.callback_.length&&(this.callback_[0].callbackFunc(),this.logger.info(Jk,"".concat(this.callback_[0].lockTrigger," got lock")))}))}unlock(e){if(this.logger.info(Jk,"".concat(e," try to unlock")),this.callback_.length>0){const e=this.callback_.shift();this.logger.info(Jk,"".concat(e.lockTrigger," unlocked")),this.callback_.length>0&&(this.callback_[0].callbackFunc(),this.logger.info(Jk,"".concat(this.callback_[0].lockTrigger," got lock")))}else this.logger.error(Jk,"unlock, but no lock exist")}clear(){for(;this.callback_.length>0;)this.unlock(this.callback_[0].lockTrigger)}}const Qk=new Xk;function $k(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function Zk(e){for(var r=1;r<arguments.length;r++){var i=null!=arguments[r]?arguments[r]:{};r%2?$k(Object(i),!0).forEach((function(r){t(e,r,i[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):$k(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function eO(e){return(t,r,i)=>{const n=i.value;return Zk(Zk({},i),{},{async value(){const t=this.locker||Qk;try{var i,o;null===(i=this.log)||void 0===i||i.info(e,"function ".concat(r," is wating for lock. ")),await t.lock(e),null===(o=this.log)||void 0===o||o.info(e,"function ".concat(r," get a lock. "));for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await n.apply(this,a)}finally{var u;null===(u=this.log)||void 0===u||u.info(e,"function ".concat(r," release a lock. ")),t.unlock(e)}}})}}function tO(e){return(t,r,i)=>{const n=i.value,o=e.substr(0,e.indexOf("$"));return Zk(Zk({},i),{},{async value(){let t,r;const i=bR.getCurrentTimestamp();for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];const u=a||[],d=iO(u);try{var l,h;null===(l=this.logger)||void 0===l||l.info(o,"".concat(n.name," begin : parameters are ").concat(JSON.stringify(d))),t=await n.apply(this,u);const s=null!=t?iO([t]):[];return null===(h=this.logger)||void 0===h||h.info(o,"".concat(n.name," end success : result is ").concat(JSON.stringify(s))),t}catch(kD){var f;throw null===(f=this.logger)||void 0===f||f.error(o,"".concat(n.name," end error : ").concat(kD)),r=kD,kD}finally{var p;const n=bR.getCurrentTimestamp(),o=iO(this.getStatExtraInfo?[t,...u,this.getStatExtraInfo()]:[t,...u]);null===(p=this.stat)||void 0===p||p.setApiCallInfo(e,i,n,r,...o)}}})}}function rO(e){return(t,r,i)=>{const n=i.value,o=e.substr(0,e.indexOf("$"));return Zk(Zk({},i),{},{value(){let t,r;const i=bR.getCurrentTimestamp();for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];const u=a||[],d=iO(u);try{var l,h;null===(l=this.logger)||void 0===l||l.info(o,"".concat(n.name," begin : parameters are ").concat(JSON.stringify(d))),r=n.apply(this,u);const s=null!=r?iO([r]):[];return null===(h=this.logger)||void 0===h||h.info(o,"".concat(n.name," end success : result is ").concat(JSON.stringify(s))),r}catch(kD){var f;throw null===(f=this.logger)||void 0===f||f.error(o,"".concat(n.name," end error : ").concat(kD)),t=kD,kD}finally{var p;const n=bR.getCurrentTimestamp(),o=iO(this.getStatExtraInfo?[r,...u,this.getStatExtraInfo()]:[r,...u]);null===(p=this.stat)||void 0===p||p.setApiCallInfo(e,i,n,t,...o)}}})}}function iO(e){try{return e.map((e=>["object","function"].includes(typeof e)?e.getStatInfo?e.getStatInfo():e.getInfo?e.getInfo():e:e))}catch(lw){return e}}class nO{static async callAsyncApi(e,t,r,i){let n,o;const s=bR.getCurrentTimestamp(),a=r||[];try{return o=await t.call(e,...a),o}catch(kD){throw n=kD,kD}finally{const t=bR.getCurrentTimestamp(),r=nO.doFinalParam([o,...a,e]);e.stat.setApiCallInfo(i,s,t,n,...r)}}static doFinalParam(e){return e.map((e=>["object","function"].includes(typeof e)&&e.getStatInfo?e.getStatInfo():e))}static callApi(e,t,r,i){let n,o;const s=bR.getCurrentTimestamp(),a=r||[];try{return o=t.call(e,...a),o}catch(kD){throw n=kD,kD}finally{const t=bR.getCurrentTimestamp(),r=nO.doFinalParam([o,...a,e]);e.stat.setApiCallInfo(i,s,t,n,...r)}}static callWithTimeout(e,t){let r;const i=new qc(Wc.RTC_ERR_CODE_WAIT_RSP_TIMEOUT),n=new Promise(((e,t)=>{r=t}));let o=null;return t&&(o=setTimeout((()=>{o&&clearTimeout(o),r(i)}),t)),Promise.race([e.finally((()=>{o&&clearTimeout(o)})),n])}static async callWithRetryTimes(e,t,r,i,n){let o=r>=0?r+1:-1,s=1,a=!1;for(;-1===o||o;){let c,u;try{u=await e(s)}catch(kD){c=kD,a=n&&n(c),console.warn("FunctionUtil","callWithRetryTimes, func:".concat(e.name,", isInterrupted:").concat(a,",")+"retryTimes:".concat(r,", left times:").concat(-1===o?-1:o-1,", tryNumber:").concat(s,", err: ").concat(c))}finally{if(!((c||!c&&t)&&!a&&(-1===o||--o>0))){if(!c)return u;throw c}{const e="number"==typeof i?i:i(c);await bR.sleep(e),s++}}}}}class oO{constructor(e){"boolean"!=typeof e?this.eventEmitter_=e:e&&(this.eventEmitter_=new bk)}on(e,t){this.eventEmitter.on(e,t)}off(e,t){t?this.eventEmitter.removeListener(e,t):this.eventEmitter.removeAllListeners(e)}emit(e,t){this.eventEmitter.emit(e,t)}get eventEmitter(){return this.eventEmitter_}set eventEmitter(e){this.eventEmitter_=e}}class sO{constructor(e,t){"boolean"!=typeof e?this.logger_=e:e&&(this.logger_=MR.getLogger(t))}get logger(){return this.logger_}set logger(e){this.logger_=e}}class aO{constructor(e,t){"boolean"!=typeof e?this.stat_=e:e&&(this.stat_="boolean"!=typeof t?new Sk(MR.getLogger(),t):new Sk(MR.getLogger()))}set stat(e){this.stat_=e}get stat(){return this.stat_}}var cO,uO,dO,lO,hO,fO,pO,mO,gO,_O,SO,vO,yO,IO,TO,RO,EO,bO,CO,AO,wO,kO,OO,PO,MO,DO,NO,UO,xO,LO,BO,VO,YO=new class{constructor(){this.gen=(()=>{let e=0;return()=>e++})()}getSequence(){return this.gen()}};class jO{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{emitter:!1,logger:!1,stat:!1,config:!1},r=arguments.length>1?arguments[1]:void 0;t(this,"onCallbackMap_",new Map),this.identifiedID_=r||Symbol("identifiedID_".concat(YO.getSequence())),!1!==e.emitter&&(this.emitterAble_=new oO(e.emitter)),!1!==e.logger&&(this.loggerAble_=new sO(e.logger,this.identifiedID_)),!1!==e.stat&&(this.statisticAble_=new aO(e.stat,e.config))}on(e,t,r){var i;r?this.onWithTimeout(e,t):null===(i=this.emitterAble_)||void 0===i||i.on(e,t)}off(e,t,r){var i;r?this.offWithTimeout(e,t):null===(i=this.emitterAble_)||void 0===i||i.off(e,t)}emit(e,t){var r;null===(r=this.emitterAble_)||void 0===r||r.emit(e,t)}onWithTimeout(e,t){var r;const i=this.getOnCallback(e,t);null===(r=this.emitterAble_)||void 0===r||r.on(e,i)}offWithTimeout(e,t){var r;null===(r=this.emitterAble_)||void 0===r||r.off(e,this.getOffCallback(e,t)||t)}getOnCallback(e,t){const r=async r=>{const i=bR.getCurrentTimestamp();let n;try{await nO.callWithTimeout(Promise.resolve(await t&&t(r)),1e4),n=bR.getCurrentTimestamp()}catch(kD){n=i+5e3}finally{var o,s;null===(o=this.stat)||void 0===o||o.recordCallbackInfo(e.toString(),null===(s=this.getInfo())||void 0===s?void 0:s.moduleName,i,n,r,(e=>["object","function"].includes(typeof e)&&e.getStatInfo?JSON.stringify(e.getStatInfo()):JSON.stringify(e||{})))}},i=this.onCallbackMap_.get(e)||[];return i.push({func:t,callbackFun:r}),this.onCallbackMap_.set(e,i),r}getOffCallback(e,t){const r=this.onCallbackMap_.get(e)||[],i=r.findIndex((e=>e.func===t));if(i>-1){var n;const e=null===(n=r[i])||void 0===n?void 0:n.callbackFun;return r.splice(i,1),e}return null}get stat(){var e;return null===(e=this.statisticAble_)||void 0===e?void 0:e.stat}get logger(){var e;return null===(e=this.loggerAble_)||void 0===e?void 0:e.logger}get eventEmitter(){if(!this.emitterAble_||!this.emitterAble_.eventEmitter)throw new qc(Wc.RTC_ERR_CODE_RTC_SDK_ERROR);return this.emitterAble_.eventEmitter}get identifiedID(){return this.identifiedID_}getStatInfo(){}}class FO extends qc{constructor(e,t,r){super(e,t),this.captureResults=r}getMediaCaptureResult(){return this.captureResults}getMediaCaptureResultByType(e){var t;return null===(t=this.captureResults)||void 0===t?void 0:t.find((t=>t.type===e))}toString(){return'["code": '.concat(this.code,', "message": "').concat(this.message," : ").concat(JSON.stringify(this.captureResults),'"]')}}let HO=(cO=rO("Stream$getStreamInfo#StreamInfo"),uO=tO("Stream$play#Promise<void>#string#{ objectFit?: string; muted: boolean; resolutionId?: string; playerElementHidden?: boolean }#string"),dO=rO("Stream$stop#void#StreamOption"),lO=tO("Stream$resume#Promise<void>#StreamOption"),hO=rO("Stream$close#void#StreamOption"),fO=rO("Stream$muteAudio#boolean"),pO=rO("Stream$muteVideo#boolean"),mO=rO("Stream$unmuteAudio#boolean"),gO=rO("Stream$unmuteVideo#boolean"),_O=tO("Stream$setAudioOutput#Promise<void>#string"),SO=rO("Stream$setAudioVolume#void#number"),vO=class extends jO{constructor(e){super({emitter:!0,logger:e.log||!0,stat:!0}),t(this,"module_","Stream"),this.isRemote_=e.isRemote,this.id_=bR.generateStreamId(),this.type_=e.type,this.isAuxiliary_="auxiliary"===e.type,this.tracks={video:new Map,audio:new Map},this.playDivContainers=new Map,this.traceHandler=this.playerStatusTrace.bind(this)}getStreamInfo(){return this.getStreamInfoImpl()}getStreamInfoImpl(){const e={videoProfiles:[]};for(const[r,i]of this.tracks[ok.TRACK_TYPE_VIDEO])if(i.getTrackType()===ok.TRACK_TYPE_VIDEO){const t={resolutionId:r,hasTrack:!!i.getTrack(),width:i.getTrackProfile().width,height:i.getTrackProfile().height,frameRate:i.getTrackProfile().frameRate,minBitrate:i.getTrackProfile().minBitrate,maxBitrate:i.getTrackProfile().maxBitrate};e.videoProfiles.push(t)}const t=this.getAnyAudioHRTCTrack();return t&&(e.audioProfile={sampleRate:t.getTrackProfile().sampleRate,channelCount:t.getTrackProfile().channelCount,bitrate:t.getTrackProfile().bitrate}),this.logger.info(this.module_,"getStreamInfoImpl success: ".concat(JSON.stringify(e))),e}getMaxResolutionHRTCTrack(e){let t;const r=Array.from(this.tracks[ok.TRACK_TYPE_VIDEO].values()),i=e?r:r.filter((e=>e.getTrack()));for(const n of i)t?t&&Math.max(n.getTrackProfile().width,n.getTrackProfile().height)-Math.max(t.getTrackProfile().width,t.getTrackProfile().height)>0&&(t=n):t=n;return t}getMaxResolutionProfile(e){if(0===e.size)return null;let t,r;for(const[i,n]of e)t?Math.max(n.width,n.height)-Math.max(t.width,t.height)>0&&(t=n,r=i):(t=n,r=i);return t?{resolutionId:r,width:t.width,height:t.height,frameRate:t.frameRate,minBitrate:t.minBitrate,maxBitrate:t.maxBitrate}:null}getHRTCTracks(e){const t=[],r=Array.from(this.tracks[ok.TRACK_TYPE_AUDIO].values()),i=Array.from(this.tracks[ok.TRACK_TYPE_VIDEO].values());if(!e)return[...r,...i];const n=void 0===e.hasTrack?r:r.filter((t=>!!t.getTrack()===e.hasTrack)),o=void 0===e.hasTrack?i:i.filter((t=>!!t.getTrack()===e.hasTrack));return e.mediaType?e.mediaType===ok.TRACK_TYPE_VIDEO?t.push(...o):t.push(...n):(t.push(...n),t.push(...o)),t}getHRTCTrackIds(e){const t=[];for(const r of this.getHRTCTracks(e))t.push(r.getTrackId());return t}getAnyVideoHRTCTrack(e){let t;return t=e?this.tracks[ok.TRACK_TYPE_VIDEO].get(e):this.getMaxResolutionHRTCTrack(!0),t}getVideoHRTCTrack(e){var t;let r;return r=e?this.tracks[ok.TRACK_TYPE_VIDEO].get(e):this.getMaxResolutionHRTCTrack(),null!==(t=r)&&void 0!==t&&t.getTrack()?r:null}getAnyAudioHRTCTrack(){return this.isAuxiliary_?this.tracks[ok.TRACK_TYPE_AUDIO].get("auxAudio"):this.tracks[ok.TRACK_TYPE_AUDIO].get("mainAudio")}getUninitializedAudioHRTCTrack(){const e=this.getAnyAudioHRTCTrack();return null!=e&&e.getTrack()?null:e}getUninitializedVideoHRTCTrack(e){var t;let r;return r=e?this.tracks[ok.TRACK_TYPE_VIDEO].get(e):this.getMaxResolutionHRTCTrack(!0),null!==(t=r)&&void 0!==t&&t.getTrack()?null:r}getAudioHRTCTrack(){const e=this.getAnyAudioHRTCTrack();return null!=e&&e.getTrack()?e:null}getUniqueId(){return this.id_}getInfo(){return{moduleName:"Stream",appId:"",roomId:"",userName:"",userId:"",domain:""}}startupPlay(e,t){this.client_.forEach((r=>{r.startupQoSReportPlay(e,t)}))}async play(e,t){const r=bR.getCurrentTimestamp();this.startupPlay(this.getUniqueId(),r),await this.playImpl(e,t)}async playImpl(e,t){let r;if(null!=t&&t.objectFit){if(!/^cover|contain|fill$/.test(t.objectFit))throw this.logger.error(this.module_,"invalid play options.objectFit: ".concat(t.objectFit)),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"invalid play options.objectFit: ".concat(t.objectFit));r=t.objectFit}else r=this.isRemote_&&"auxiliary"===this.getType()?"contain":"cover";const i=!(null==t||!t.muted);if(this.logger.info(this.module_,"stream start to play with elementId: ".concat(e,", options.objectFit: ").concat(r,",options.muted: ").concat(i," resolutionId:").concat(null==t?void 0:t.resolutionId)),!e)throw this.logger.error(this.module_,"elementId:".concat(e," not a invalid HTMLElement Id")),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"elementId:".concat(e," not a invalid HTMLElement Id"));const n=document.getElementById(e);if(!n)throw this.logger.error(this.module_,"document.getElementById by elementId:".concat(e," failed")),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"document.getElementById by elementId:".concat(e," failed"));let o;const s=null!=t&&t.resolutionId?this.getVideoHRTCTrack(t.resolutionId):this.getMaxResolutionHRTCTrack(),a=s?s.getResolutionId():this.id_,c=this.playDivContainers.get(e);if(c){var u;o=c.HTMLElement,n.querySelector("#".concat(o.id))||n.appendChild(o),this.logger.info(this.module_,"get exist player div, key:".concat(e,", div: ").concat(null===(u=c.HTMLElement)||void 0===u?void 0:u.id))}else{o=document.createElement("div"),o.setAttribute("id","player_".concat(a)),o.style.width="100%",o.style.height="100%",o.style.position="relative",o.style.overflow="hidden",o.style["background-color"]="#000",n.appendChild(o);const t={HTMLElement:o,hasVideoTrack:!1,hasAudioTrack:!1};this.playDivContainers.set(e,t),this.logger.info(this.module_,"new player div, key:".concat(e,", div: ").concat(o.id))}o.style.display=null!=t&&t.playerElementHidden?"none":"block",await this.playTracks(e,o,r,i,null==t?void 0:t.resolutionId)}reportCanPlay(e){this.client_.forEach((t=>{t.startupQoSReportCanPlay(e)}))}playerStatusTrace(e){this.logger.debug(this.module_,"playerStatusTrace, ".concat(JSON.stringify(e))),null!=e&&e.event&&"playerCanplay"===e.event&&(e.id=this.getUniqueId(),this.reportCanPlay(e))}async playTracks(e,t,r,i,n){const o=[],s=this.isAuxiliary_?null:this.getAudioHRTCTrack(),a=n?this.getVideoHRTCTrack(n):this.getMaxResolutionHRTCTrack();null!=a&&a.getTrack()&&o.push(a.play(t,e,{objectFit:r,mirror:this.mirror_})),null!=s&&s.getTrack()&&o.push(s.play(t,e,{muted:i})),0!==o.length?(this.off(Mb,this.traceHandler),this.on(Mb,this.traceHandler),await Promise.all(o).then((r=>{const i=r.filter((e=>null!==e.error));i.length===o.length&&t&&t.remove();const n=r.filter((e=>null===e.error)),s=null==n?void 0:n.some((e=>e.trackType===ok.TRACK_TYPE_AUDIO)),a=null==n?void 0:n.some((e=>e.trackType===ok.TRACK_TYPE_VIDEO));if(this.playDivContainers.has(e)&&this.playDivContainers.set(e,{HTMLElement:t,hasAudioTrack:s,hasVideoTrack:a}),i.length>0)throw i[0].error}))):this.logger.warn(this.module_,"no available track for play")}stop(e){this.stopImpl(e)}stopImpl(e){var t;this.logger.info(this.module_,"stopImpl begin, option:".concat(JSON.stringify(e)));const r=this.getHRTCTracks({hasTrack:!0,mediaType:ok.TRACK_TYPE_VIDEO}),i=[];var n;(!e||e.video&&!e.resolutionIds?i.push(...r):e.video&&null!==(t=e.resolutionIds)&&void 0!==t&&t.length&&e.resolutionIds.forEach((e=>{const t=this.getVideoHRTCTrack(e);t&&i.push(t)})),i.forEach((e=>{e.stop()})),!e||e.audio)&&(null===(n=this.getAudioHRTCTrack())||void 0===n||n.stop())}async resume(e){await this.resumeImpl(e)}async resumeImpl(e){var t;this.logger.info(this.module_,"resumeImpl begin, option:".concat(JSON.stringify(e)));const r=this.getHRTCTracks({hasTrack:!0,mediaType:ok.TRACK_TYPE_VIDEO}),i=[];!e||e.video&&!e.resolutionIds?i.push(...r):e.video&&null!==(t=e.resolutionIds)&&void 0!==t&&t.length&&e.resolutionIds.forEach((e=>{const t=this.getVideoHRTCTrack(e);t&&i.push(t)}));const n=[];if(i.forEach((e=>{n.push(e.resume())})),!e||e.audio){const e=this.getAudioHRTCTrack();e&&n.push(e.resume())}await Promise.all(n)}close(e){this.closeImpl(e)}closeImpl(e){if(this.logger.info(this.module_,"closeImpl begin, options:".concat(JSON.stringify(e))),!e||e.video&&!e.resolutionIds&&e.audio){for(const e of this.getHRTCTracks({hasTrack:!0}))e.close();for(const e of this.playDivContainers.values())e.HTMLElement&&e.HTMLElement.remove();return this.playDivContainers.clear(),void Rk.removeEventEmitter(this.eventEmitter)}if(e.video){var t;const r=[];if(null!==(t=e.resolutionIds)&&void 0!==t&&t.length)e.resolutionIds.forEach((e=>{const t=this.getVideoHRTCTrack(e);t&&r.push(t)}));else{const e=this.getHRTCTracks({hasTrack:!0,mediaType:ok.TRACK_TYPE_VIDEO});r.push(...e)}r.forEach((e=>{const t=null==e?void 0:e.getElementId();if(e.close(),t){const e=this.playDivContainers.get(t);var r,i,n;if(e)if(e.hasVideoTrack=!1,this.logger.debug(this.module_,"closeImpl, elementId:".concat(t,", divInfo: ").concat(null===(r=e.HTMLElement)||void 0===r?void 0:r.id,", hasAudioTrack: ").concat(e.hasAudioTrack,", hasVideoTrack: ").concat(e.hasVideoTrack,"}")),!e.hasAudioTrack)null===(i=this.playDivContainers.get(t))||void 0===i||null===(n=i.HTMLElement)||void 0===n||n.remove(),this.playDivContainers.delete(t),this.logger.info(this.module_,"closeImpl, release elementId: ".concat(t))}}))}e.audio&&this.closeAudio();this.getHRTCTracks({hasTrack:!0}).every((e=>e.isClosed()))&&(Rk.removeEventEmitter(this.eventEmitter),this.mediaStream=null)}closeAudio(){const e=this.getAudioHRTCTrack();if(e){const n=e.getElementId();if(e.close(),n){const e=this.playDivContainers.get(n);var t,r,i;if(e)if(e.hasAudioTrack=!1,this.logger.debug(this.module_,"closeAudio, elementId:".concat(n,", divInfo: ").concat(null===(t=e.HTMLElement)||void 0===t?void 0:t.id,", hasAudioTrack: ").concat(e.hasAudioTrack,", hasVideoTrack: ").concat(e.hasVideoTrack,"}")),!e.hasVideoTrack)null===(r=this.playDivContainers.get(n))||void 0===r||null===(i=r.HTMLElement)||void 0===i||i.remove(),this.playDivContainers.delete(n),this.logger.info(this.module_,"closeAudio, release elementId: ".concat(n))}}}muteAudio(){return this.muteAudioImpl()}muteAudioImpl(){try{const e=this.getAudioHRTCTrack();return!!e&&(e.muteTrack(),!0)}catch(kD){return this.logger.error(this.module_,"muteAudio failed: ".concat(kD)),!1}}muteVideo(){return this.muteVideoImpl()}muteVideoImpl(){try{if(!this.hasVideoTrack())return!1;for(const e of this.getHRTCTracks({hasTrack:!0,mediaType:ok.TRACK_TYPE_VIDEO}))e.muteTrack();return!0}catch(kD){return this.logger.error(this.module_,"muteVideo failed: ".concat(kD)),!1}}unmuteAudio(){return this.unmuteAudioImpl()}unmuteAudioImpl(){try{const e=this.getAudioHRTCTrack();return!!e&&(e.unmuteTrack(),!0)}catch(kD){return this.logger.error(this.module_,"unmuteAudio failed: ".concat(kD)),!1}}unmuteVideo(){return this.unmuteVideoImpl()}unmuteVideoImpl(){try{if(!this.hasVideoTrack())return!1;for(const e of this.getHRTCTracks({hasTrack:!0,mediaType:ok.TRACK_TYPE_VIDEO}))e.unmuteTrack();return!0}catch(kD){return this.logger.error(this.module_,"unmuteVideo failed: ".concat(kD)),!1}}getId(){var e;return null===(e=this.getMaxResolutionHRTCTrack(!0))||void 0===e?void 0:e.getTrackId()}getUserId(){return this.userId_}getType(){return this.type_}async setAudioOutput(e){return this.setAudioOutputImpl(e)}async setAudioOutputImpl(e){try{const t=this.getAudioHRTCTrack();t&&await t.setSinkId(e),this.stat.reportSwitchDevicesInfo(RC.OUTPUT_AUDIO,e,BC.SUCCESS)}catch(kD){throw this.stat.reportSwitchDevicesInfo(RC.OUTPUT_AUDIO,e,BC.FAIL),kD}}setAudioVolume(e){this.setAudioVolumeImpl(e)}setAudioVolumeImpl(e){const t=this.getAudioHRTCTrack();t&&t.setAudioVolume(e)}getAudioLevel(){const e=this.getAudioHRTCTrack();return e?e.getAudioLevel():0}hasAudioTrack(){return!!this.getAudioHRTCTrack()}hasVideoTrack(){return Array.from(this.tracks[ok.TRACK_TYPE_VIDEO].values()).filter((e=>e.getTrack())).length>0}isAuxiliary(){return this.isAuxiliary_}getAudioTrack(){const e=this.getAudioHRTCTrack();return e?e.getTrack():null}getVideoTrack(e){const t=this.getVideoHRTCTrack(e);return t?t.getTrack():null}getVideoFrame(e){const t=this.getVideoHRTCTrack(e);return t?t.getVideoFrame():null}on(e,t){super.on(e,t,-1===Db.indexOf(e.toString()))}off(e,t){super.off(e,t,-1===Db.indexOf(e.toString()))}async restart(e){var t;if(e)return void(await(null===(t=this.getVideoHRTCTrack(e))||void 0===t?void 0:t.restart()));const r=[];for(const i of this.getHRTCTracks({hasTrack:!0}))r.push(i.restart());await Promise.all(r)}async rePlayAudio(){const e=this.getAudioHRTCTrack();e&&!e.isPlaying()&&await e.replay()}getStatInfo(){return{isRemote_:this.isRemote_,type_:this.type_,userId_:this.userId_,id_:this.id_,isAuxiliary_:this.isAuxiliary_}}getStatExtraInfo(){return{isRemote:this.isRemote_,id:this.id_,userId:this.userId_}}hasAudio(){var e;const t=!!(null===(e=this.getAudioHRTCTrack())||void 0===e?void 0:e.getTrack());return this.logger.debug(this.module_,"hasAudio: ".concat(t)),t}hasVideo(){const e=this.hasVideoTrack();return this.logger.debug(this.module_,"hasVideo: ".concat(e)),e}},r(vO.prototype,"getStreamInfo",[cO],Object.getOwnPropertyDescriptor(vO.prototype,"getStreamInfo"),vO.prototype),r(vO.prototype,"play",[uO],Object.getOwnPropertyDescriptor(vO.prototype,"play"),vO.prototype),r(vO.prototype,"stop",[dO],Object.getOwnPropertyDescriptor(vO.prototype,"stop"),vO.prototype),r(vO.prototype,"resume",[lO],Object.getOwnPropertyDescriptor(vO.prototype,"resume"),vO.prototype),r(vO.prototype,"close",[hO],Object.getOwnPropertyDescriptor(vO.prototype,"close"),vO.prototype),r(vO.prototype,"muteAudio",[fO],Object.getOwnPropertyDescriptor(vO.prototype,"muteAudio"),vO.prototype),r(vO.prototype,"muteVideo",[pO],Object.getOwnPropertyDescriptor(vO.prototype,"muteVideo"),vO.prototype),r(vO.prototype,"unmuteAudio",[mO],Object.getOwnPropertyDescriptor(vO.prototype,"unmuteAudio"),vO.prototype),r(vO.prototype,"unmuteVideo",[gO],Object.getOwnPropertyDescriptor(vO.prototype,"unmuteVideo"),vO.prototype),r(vO.prototype,"setAudioOutput",[_O],Object.getOwnPropertyDescriptor(vO.prototype,"setAudioOutput"),vO.prototype),r(vO.prototype,"setAudioVolume",[SO],Object.getOwnPropertyDescriptor(vO.prototype,"setAudioVolume"),vO.prototype),vO),KO=(yO=tO("LocalStream$initialize#Promise<StreamInitializeResult>"),IO=tO("LocalStream$addAudioTrackCapture#Promise<MediaStreamTrack>#string"),TO=tO("LocalStream$addVideoTrackCapture#Promise<MediaStreamTrack>#VideoCaptureOption"),RO=rO("LocalStream$setAudioProfile#void#string|RTCAudioProfile"),EO=tO("LocalStream$setVideoProfile#void#string|RTCVideoProfile"),bO=tO("LocalStream$addResolution#Promise<RTCVideoProfileInfo>#string|RTCVideoProfile#boolean"),CO=tO("LocalStream$removeResolution#Promise<void>#string"),AO=rO("LocalStream$setScreenProfile#void#string|RTCScreenProfile"),wO=tO("LocalStream$switchDevice#Promise<void>#string#string"),kO=tO("LocalStream$addTrack#Promise<void>#MediaStreamTrack#string"),OO=tO("LocalStream$removeTrack#Promise<void>#MediaStreamTrack#string"),PO=tO("LocalStream$replaceTrack#Promise<void>#MediaStreamTrack#string#string"),MO=rO("LocalStream$bindScreenAudio2RelatedStream#void#LocalStream#boolean"),DO=tO("LocalStream$startAudioMixing#Promise<void>#AudioMixOption"),NO=tO("LocalStream$stopAudioMixing#Promise<void>"),UO=rO("LocalStream$pauseAudioMixing#void"),xO=rO("LocalStream$resumeAudioMixing#void"),LO=rO("LocalStream$setAudioMixingVolume#void#number"),BO=rO("LocalStream$setAudioMixingPosition#void#number"),VO=class extends HO{constructor(e){super({isRemote:!1,type:"local",log:null}),this.module_="LocalStream",this.userId_=e.userId,this.audio_=e.audio,this.microphoneId_=e.microphoneId,this.video_=e.video,this.cameraId_=e.cameraId,this.facingMode_=e.facingMode,this.screen_=e.screen,this.isAuxiliary_=!!this.screen_,this.screenAudio_=e.screenAudio,this.audioSource_=e.audioSource,this.videoSource_=e.videoSource,this.mirror_=e.mirror,this.client_=[],this.audioMixOption_={filePath:null,startTime:0,replace:!1,loop:!1,repeatCount:1},this.audioMixInfo_={audioMixState:qb.IDLE,audioCtx:null,mediaNode:null,sourceNode:null,buffer:null,destNode:null,gainNode:null,gainValue:.5,startAt:0,pauseAt:0,pauseDur:0,playAutoEnded:!1,totalDur:0},this.mutePackageData=new Uint8Array([255,241,80,128,3,223,252,222,2,0,76,97,118,99,53,56,46,55,53,46,49,48,48,0,66,32,8,193,24,56,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28,255,241,80,128,1,191,252,33,16,4,96,140,28]).buffer,this.muteSendInfo={audioMixState:qb.IDLE,audioCtx:null,mediaNode:null,sourceNode:null,destNode:null},this.screenShareMixInfo={bindStream:null,screenShareAudioNode:null,destNode:null,gainNode:null,gainValue:.5,status:qb.INIT,muteMainAudio:!1},this.videoProfiles_=new Map,this.videoContents=new Map,this.logger.info(this.module_,"new local stream, stream config: ".concat(JSON.stringify(e)))}setMediaStream(e){this.mediaStream||(this.mediaStream=new MediaStream),this.mediaStream.addTrack(e)}getMediaStream(){return this.mediaStream}getLocalId(){return this.id_}async initialize(){return await this.initializeImpl()}setVideoContentHint(e){if("detail"!==e&&"motion"!==e&&"text"!==e){const e=new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"invalid input parameter type");throw this.logger.error(this.module_,"setVideoContentHint fail, errMsg: ".concat(e)),e}const t=this.getVideoTrack();t&&"contentHint"in t?(t.contentHint=e,this.logger.info(this.module_,"set video track contentHint to: ".concat(e))):this.logger.info(this.module_,"no video track or no video contentHint in track")}async reset(){this.closeImpl();for(const e of this.getHRTCTracks({hasTrack:!0})){const t=e.getTrack();t&&await this.removeTrack(t)}this.tracks[ok.TRACK_TYPE_VIDEO].clear(),this.tracks[ok.TRACK_TYPE_AUDIO].clear()}initAuxStreamWithTrack(e,t){const r=[];if(e){const t=new qk({streamType:sk.STREAM_TYPE_AUX,trackType:ok.TRACK_TYPE_AUDIO,isRemote:!1,logger:this.logger,resolutionId:this.generateResolutionId(),track:e,event:this.eventEmitter});this.tracks[ok.TRACK_TYPE_AUDIO].set("auxAudio",t),r.push({type:ok.TRACK_TYPE_AUDIO,track:e})}if(t){const e=new qk({streamType:sk.STREAM_TYPE_AUX,trackType:ok.TRACK_TYPE_VIDEO,isRemote:!1,logger:this.logger,resolutionId:this.generateResolutionId(),track:t,event:this.eventEmitter});this.tracks[ok.TRACK_TYPE_VIDEO].set(e.getResolutionId(),e),r.push({type:ok.TRACK_TYPE_VIDEO,track:t})}return this.appendDefaultLocalTrack(this.getMaxResolutionProfile(this.videoProfiles_),this.audioProfile_),new FO(Wc.RTC_ERR_CODE_SUCCESS,"",r)}async initAuxStream(){if(this.audioSource_||this.videoSource_)return this.initAuxStreamWithTrack(this.audioSource_,this.videoSource_);{var e,t,r,i;const n=new qk({streamType:sk.STREAM_TYPE_AUX,trackType:ok.TRACK_TYPE_VIDEO,isRemote:!1,trackProfile:this.screenProfile_,logger:this.logger,resolutionId:this.generateResolutionId(),event:this.eventEmitter}),o=await n.initScreenShare(this.screenAudio_),s=null===(e=o.find((e=>e.error)))||void 0===e?void 0:e.error;if(s)throw this.logger.error(this.module_,"initAuxStream, fail, errMsg = ".concat(s)),s instanceof qc?new FO(s.getCode(),s.getMsg(),o):s;this.stat.setMediaCaptureSucc(EC.AUX,null===(t=n.getTrack())||void 0===t?void 0:t.label),this.tracks[ok.TRACK_TYPE_VIDEO].set(n.getResolutionId(),n),this.setMediaStream(null===(r=o.find((e=>e.type===ok.TRACK_TYPE_VIDEO&&e.track)))||void 0===r?void 0:r.track),this.setVideoContentHint("detail");const a=null===(i=o.find((e=>e.type===ok.TRACK_TYPE_AUDIO&&e.track)))||void 0===i?void 0:i.track;return a&&this.tracks[ok.TRACK_TYPE_AUDIO].set("auxAudio",new qk({streamType:sk.STREAM_TYPE_AUX,trackType:ok.TRACK_TYPE_AUDIO,isRemote:!1,logger:this.logger,resolutionId:this.generateResolutionId(),track:a,event:this.eventEmitter})),this.auxStreamStopByNativeHandler=()=>{this.close(),this.eventEmitter.removeListener(kb,this.auxStreamStopByNativeHandler)},this.eventEmitter.on(kb,this.auxStreamStopByNativeHandler),new FO(Wc.RTC_ERR_CODE_SUCCESS,"",o)}}async initMainStreamWithCfg(){const e=this.getMaxResolutionProfile(this.videoProfiles_);return await this.addCaptureWithCfg(this.video_,this.audio_,e,this.audioProfile_,iC.main)}async initMainStream(){return Rk.initDeviceChangedNotify(this.eventEmitter,!0),this.on(hC.CameraChanged,(e=>{"REMOVE"===e.state&&this.clearEffectiveDeviceId(e.deviceId,"videoInput")})),this.on(hC.RecordingDeviceChanged,(e=>{"REMOVE"===e.state&&this.client_.length>0&&this.client_[0].getPublishAudioSender()&&(this.startSendMutePackage(),this.clearEffectiveDeviceId(e.deviceId,"audioInput"))})),this.on(Nb.CameraCapture,((e,t)=>{this.setCameraCaptureReport(e,t)})),this.audioSource_||this.videoSource_?this.initMainStreamWithTrack(this.audioSource_,this.videoSource_):await this.initMainStreamWithCfg()}async initializeImpl(){this.logger.info(this.module_,"initializeImpl begin");try{return await this.reset(),this.screen_?await this.initAuxStream():await this.initMainStream()}catch(kD){throw this.logger.error(this.module_,"initializeImpl fail, errMsg:".concat(kD)),"function"!=typeof kD.getMediaCaptureResult&&"function"==typeof kD.getCode?new FO(kD.getCode(),kD.getMsg(),null):kD}}setCameraCaptureReport(e,t){this.client_.forEach((r=>{r.setCameraCaptureReport(e,t)}))}async addCaptureWithCfg(e,t,r,i,n){this.logger.info(this.module_,"addCaptureWithCfg begin, video:".concat(e,", audio:").concat(t,",")+"camera:".concat(this.getCurrentCameraId(),", microphone:").concat(this.getCurrentMicrophoneId(),",")+"videoProfileInfo:".concat(JSON.stringify(r),", audioProfile:").concat(JSON.stringify(i)));if((this.tracks&&this.tracks[ok.TRACK_TYPE_VIDEO].size)>=2){const e=new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"resolution count can not be greater than ".concat(2));throw this.logger.error(this.module_,"addCaptureWithCfg fail, errMsg is=".concat(e)),e}const o=[];let s,a;e&&(s=new qk({streamType:sk.STREAM_TYPE_MAIN,trackType:ok.TRACK_TYPE_VIDEO,isRemote:!1,trackProfile:r,logger:this.logger,resolutionId:r?r.resolutionId:this.generateResolutionId(),event:this.eventEmitter}),o.push(s.initVideoCapture(this.getCurrentCameraId()||this.facingMode_,n))),t&&(a=new qk({streamType:sk.STREAM_TYPE_MAIN,trackType:ok.TRACK_TYPE_AUDIO,isRemote:!1,trackProfile:i,logger:this.logger,resolutionId:this.generateResolutionId(),event:this.eventEmitter}),o.push(a.initAudioCapture(this.getCurrentMicrophoneId())));const c=await Promise.all(o);let u=null;for(const l of c)if(l.error)u="".concat(u).concat(u?"":";").concat(l.error.getMsg());else{var d;if(l.type===ok.TRACK_TYPE_AUDIO)this.tracks[ok.TRACK_TYPE_AUDIO].set("mainAudio",a),this.stat.setMediaCaptureSucc(EC.AUDIO,a.getTrack().label);else Array.from(Array.from(this.tracks[ok.TRACK_TYPE_VIDEO].values()).values()).some((e=>e.getTrackMuted()))&&s.muteTrack(),this.tracks[ok.TRACK_TYPE_VIDEO].set(s.getResolutionId(),s),this.stat.setMediaCaptureSucc(EC.VIDEO,null===(d=s.getTrack())||void 0===d?void 0:d.label),r&&this.videoProfiles_.set(s.getResolutionId(),r),this.videoContents.set(s.getResolutionId(),n);this.setMediaStream(l.track),this.appendDefaultLocalTrack(r,i),this.updateEffectiveDeviceInfo(l)}if(u){const e=new FO(Wc.RTC_ERR_CODE_INVALID_OPERATION,"browser initialize capture fail, ".concat(u),c);throw this.logger.error(this.module_,"addCaptureWithCfg fail, errMsg= ".concat(e)),e}return this.logger.info(this.module_,"addCaptureWithCfg success, camera:".concat(this.getCurrentCameraId(),", microphone:").concat(this.getCurrentMicrophoneId())),new FO(Wc.RTC_ERR_CODE_SUCCESS,"",c)}appendDefaultLocalTrack(e,t){if(!this.getAnyAudioHRTCTrack()){const e=new qk({streamType:sk.STREAM_TYPE_MAIN,trackType:ok.TRACK_TYPE_AUDIO,isRemote:!1,trackProfile:t,logger:this.logger,resolutionId:this.generateResolutionId(),event:this.eventEmitter});e.setTrackContentType(iC.main),this.tracks[ok.TRACK_TYPE_AUDIO].set("mainAudio",e),this.logger.info(this.module_,"addDefaultEmptyTrack success, audioTrack:".concat(e.getResolutionId(),",")+"track profile:".concat(JSON.stringify(e.getTrackProfile())))}if(!this.getAnyVideoHRTCTrack(null==e?void 0:e.resolutionId)){const t=new qk({streamType:sk.STREAM_TYPE_MAIN,trackType:ok.TRACK_TYPE_VIDEO,isRemote:!1,trackProfile:e,logger:this.logger,resolutionId:e?e.resolutionId:this.generateResolutionId(),event:this.eventEmitter});t.setTrackContentType(iC.main),this.tracks[ok.TRACK_TYPE_VIDEO].set(t.getResolutionId(),t),this.logger.info(this.module_,"addDefaultEmptyTrack success, videoTrack:".concat(t.getResolutionId(),",")+"track profile:".concat(JSON.stringify(t.getTrackProfile())))}}generateResolutionId(){return this.id_+"-"+bR.generateRandomId(8,16)}initMainStreamWithTrack(e,t){const r=[];if(e){const t=new qk({streamType:sk.STREAM_TYPE_MAIN,trackType:ok.TRACK_TYPE_AUDIO,isRemote:!1,logger:this.logger,resolutionId:this.generateResolutionId(),track:e,event:this.eventEmitter});this.tracks[ok.TRACK_TYPE_AUDIO].set("mainAudio",t),r.push({type:ok.TRACK_TYPE_AUDIO,track:e})}if(t){const e=new qk({streamType:sk.STREAM_TYPE_MAIN,trackType:ok.TRACK_TYPE_VIDEO,isRemote:!1,logger:this.logger,resolutionId:this.generateResolutionId(),track:t,event:this.eventEmitter});this.tracks[ok.TRACK_TYPE_VIDEO].set(e.getResolutionId(),e),r.push({type:ok.TRACK_TYPE_VIDEO,track:t})}return this.appendDefaultLocalTrack(this.getMaxResolutionProfile(this.videoProfiles_),this.audioProfile_),new FO(Wc.RTC_ERR_CODE_SUCCESS,"",r)}async addAudioTrackCapture(e){return await this.addAudioTrackCaptureImpl(e)}async addAudioTrackCaptureImpl(e){var t;this.logger.info(this.module_,"addAudioTrackCaptureImpl, microphoneId: ".concat(e));const r=new qk({streamType:sk.STREAM_TYPE_MAIN,trackType:ok.TRACK_TYPE_AUDIO,isRemote:!1,trackProfile:this.audioProfile_,logger:this.logger,resolutionId:this.generateResolutionId(),event:this.eventEmitter}),i=await r.initAudioCapture(e||this.microphoneId_);if(i.error)throw this.logger.error(this.module_,"addAudioTrackCaptureImpl fail, errMsg: ".concat(i.error)),i.error;return this.stat.setMediaCaptureSucc(EC.AUDIO,null===(t=i.track)||void 0===t?void 0:t.label),this.updateEffectiveDeviceInfo(i),await this.addTrackImpl(i.track),i.track}async addVideoTrackCapture(e){return await this.addVideoTrackCaptureImpl(e)}async addVideoTrackCaptureImpl(e){var t;this.logger.info(this.module_,"addVideoTrackCaptureImpl, option: ".concat(JSON.stringify(e)));const r=null==e?void 0:e.resolutionId,i=r?this.videoProfiles_.get(r):this.getMaxResolutionProfile(this.videoProfiles_),n=new qk({streamType:sk.STREAM_TYPE_MAIN,trackType:ok.TRACK_TYPE_VIDEO,isRemote:!1,trackProfile:i,logger:this.logger,resolutionId:this.generateResolutionId(),event:this.eventEmitter}),o=(null==e?void 0:e.cameraId)||this.cameraId_||this.facingMode_,s=await n.initVideoCapture(o,r?this.videoContents.get(r):iC.main);if(s.error)throw this.logger.error(this.module_,"addVideoTrackCaptureImpl fail, errMsg: ".concat(s.error)),s.error;return this.updateEffectiveDeviceInfo(s),this.stat.setMediaCaptureSucc(EC.AUDIO,null===(t=s.track)||void 0===t?void 0:t.label),await this.addTrackImpl(s.track,r),s.track}updateEffectiveDeviceInfo(e){e.type===ok.TRACK_TYPE_VIDEO?(this.effectiveCameraId_=e.track.getSettings().deviceId,this.logger.info(this.module_,"updateEffectiveDeviceInfo, effectiveCameraId_: ".concat(this.effectiveCameraId_))):e.type===ok.TRACK_TYPE_AUDIO&&(this.effectiveMicrophoneId_=e.track.getSettings().deviceId,this.logger.info(this.module_,"updateEffectiveDeviceInfo, effectiveMicrophoneId_: ".concat(this.effectiveMicrophoneId_)))}getCurrentCameraId(){return this.cameraId_||this.effectiveCameraId_}getCurrentMicrophoneId(){return this.microphoneId_||this.effectiveMicrophoneId_}getAudioSendBitrate(){const e=this.getAudioHRTCTrack();return e?e.getTrackProfile().bitrate:0}isAudioMuted(){const e=this.getAudioHRTCTrack();return!e||e.getTrackMuted()}isVideoMuted(e){const t=this.getVideoHRTCTrack(e);return!t||t.getTrackMuted()}setAudioProfile(e){this.setAudioProfileImpl(e)}setAudioProfileImpl(e){const t=this.getAudioHRTCTrack();this.audioProfile_=e,null==t||t.setTrackProfile(e)}getVideoMaxBitrate(e){var t;const r=null===(t=this.getVideoHRTCTrack(e))||void 0===t?void 0:t.getTrackProfile();return r?r.maxBitrate:0}getVideoMaxSendBitrate(e){var t;const r=null===(t=this.getVideoHRTCTrack(e))||void 0===t?void 0:t.getTrackProfile();return r?r.maxBitrate<35e4?r.maxBitrate-2e4:r.maxBitrate:0}getVideoMiniBitrate(e){var t;const r=null===(t=this.getVideoHRTCTrack(e))||void 0===t?void 0:t.getTrackProfile();return r?r.minBitrate:0}getVideoWidth(e){var t;const r=null===(t=this.getVideoHRTCTrack(e))||void 0===t?void 0:t.getTrackProfile();return r?r.width:0}getVideoHeight(e){var t;const r=null===(t=this.getVideoHRTCTrack(e))||void 0===t?void 0:t.getTrackProfile();return r?r.height:0}getVideoFrameRate(e){var t;const r=null===(t=this.getVideoHRTCTrack(e))||void 0===t?void 0:t.getTrackProfile();return r?r.frameRate:0}getVideoProfile(e){var t;return null===(t=this.getVideoHRTCTrack(e))||void 0===t?void 0:t.getTrackProfile()}async setVideoProfile(e,t){await this.setVideoProfileImpl(e,t)}async addResolution(e,t){return await this.addResolutionImpl(e,t)}async addResolutionImpl(e,t){try{if(this.videoSource_||this.audioSource_)throw new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"localStream created by videoSource or audioSource");const r=Kk.formatVideoProfile(e),i={resolutionId:this.generateResolutionId(),width:r.width,height:r.height,frameRate:r.frameRate,minBitrate:r.minBitrate,maxBitrate:r.maxBitrate};this.logger.info(this.module_,"addResolutionImpl begin, profile:".concat(JSON.stringify(i)," ")),await this.addCaptureWithCfg(!0,t,i,this.audioProfile_,iC.slides);for(const e of this.client_)await e.publish(this);return this.logger.info(this.module_,"addResolutionImpl success"),i}catch(kD){throw this.logger.error(this.module_,"addResolutionImpl fail, errMsg:".concat(kD)),"function"!=typeof kD.getMediaCaptureResult?new FO(kD.getCode(),kD.getMsg(),null):kD}}async removeResolution(e){return this.removeResolutionImpl(e)}async removeResolutionImpl(e){this.logger.info(this.module_,"removeResolutionImpl begin, resolutionId:".concat(e));const t=this.getVideoHRTCTrack(e);if(!t)throw this.logger.error(this.module_,"removeResolutionImpl, resolutionId:".concat(e," not found ")),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"resolutionId:".concat(e," not found"));this.tracks[ok.TRACK_TYPE_VIDEO].delete(e),t.removeTrack();const r=this.getHRTCTracks({mediaType:ok.TRACK_TYPE_VIDEO});r&&0!==r.length||this.tracks[ok.TRACK_TYPE_AUDIO].delete("mainAudio");for(const i of this.client_)await i.publish(this);this.logger.info(this.module_,"removeResolutionImpl success, resolutionId:".concat(e))}async setVideoProfileImpl(e,t){var r;this.logger.info(this.module_,"setVideoProfile begin, profile: ".concat(JSON.stringify(e)));const i=this.getVideoHRTCTrack(t),n=Kk.formatVideoProfile(e);if(!i){const e=this.generateResolutionId();return void this.videoProfiles_.set(e,n)}const o={};bR.isSupportConstraints("aspectRatio")&&(o.aspectRatio={ideal:n.width/n.height}),o.width={ideal:n.width},o.height={ideal:n.height},o.frameRate={ideal:n.frameRate},await(null===(r=i.getTrack())||void 0===r?void 0:r.applyConstraints(o).then((()=>{this.logger.info(this.module_,"setVideoProfile, constraint: ".concat(JSON.stringify(i.getTrack().getConstraints()))),i.setLocalProfileByTrack(i.getTrack()),this.videoProfiles_.set(i.getResolutionId(),n),this.client_.forEach((async e=>{if(e){const t=e.getMainStreamSenderByTrack(i.getTrackId());await e.setSendBitrate(t,this.getVideoMaxSendBitrate(i.getResolutionId()),this.isAuxiliary()?"auxVideo":"mainVideo"),await e.publish(this)}}))})))}getScreenSendBitrate(){const e=this.getVideoHRTCTrack();return e?e.getTrackProfile().bitrate:0}getScreenWidth(){const e=this.getVideoHRTCTrack();return e?e.getTrackProfile().width:0}getScreenHeight(){const e=this.getVideoHRTCTrack();return e?e.getTrackProfile().height:0}getScreenFrameRate(){const e=this.getVideoHRTCTrack();return e?e.getTrackProfile().frameRate:0}setScreenProfile(e){this.setScreenProfileImpl(e)}setScreenProfileImpl(e){const t=this.getVideoHRTCTrack();this.screenProfile_=e,t&&t.setTrackProfile(e)}async switchVideoDevice(e){var t;this.logger.info(this.module_,"switchVideoDevice begin, cameraId is ".concat(e));const r=this.getHRTCTracks({hasTrack:!0,mediaType:ok.TRACK_TYPE_VIDEO});if(0===r.length)return void this.logger.error(this.module_,"switchVideoDevice failed, no video tracks");const i=[];for(const d of r){var n;null===(n=this.mediaStream)||void 0===n||n.removeTrack(d.getTrack()),d.setTrackProfile(this.videoProfiles_.get(d.getResolutionId())),i.push(d.initVideoCapture(e,d.getTrackContentType()))}const o=await Promise.all(i),s=[];for(const d of o){var a,c,u;if(d.error)throw d.error;null===(a=this.mediaStream)||void 0===a||a.addTrack(d.track);const e=d.track.getConstraints(),t=d.track.getSettings(),i="number"==typeof e.width?e.width:(null===(c=e.width)||void 0===c?void 0:c.ideal)||t.width,n="number"==typeof e.height?e.height:(null===(u=e.height)||void 0===u?void 0:u.ideal)||t.height,o=r.find((e=>{const t=e.getTrackProfile();return t.width===i&&t.height===n}));for(const r of this.client_){const e=r.getMainStreamSenderByTrack(null==o?void 0:o.getTrackId());e&&s.push(e.replaceTrack(d.track))}}if(o.length&&(this.cameraId_=e,this.effectiveCameraId_=e),0!==s.length){this.stat.setMediaCaptureSucc(EC.VIDEO,null===(t=o[0].track)||void 0===t?void 0:t.label),await Promise.all(s);for(const e of this.client_)await e.publish(this);this.logger.info(this.module_,"switchVideoDevice success")}else this.logger.debug(this.module_,"switchVideoDevice, no need replace sender track")}async switchAudioDevice(e){var t,r,i;this.logger.info(this.module_,"switchAudioDevice begin, microphoneId is ".concat(e));const n=this.getAudioHRTCTrack();if(!n)return void this.logger.error(this.module_,"switchAudioDevice failed, no audio tracks");null===(t=this.mediaStream)||void 0===t||t.removeTrack(n.getTrack());const o=await n.initAudioCapture(e);if(o.error)throw o.error;this.stat.setMediaCaptureSucc(EC.AUDIO,null===(r=o.track)||void 0===r?void 0:r.label),this.replaceMixAudioTrack(o.track),null===(i=this.mediaStream)||void 0===i||i.addTrack(o.track);const s=[];this.client_.forEach((e=>{const t=e.getPublishAudioSender();t&&s.push(t.replaceTrack(this.getPublishAudioTrack()))})),0===s.length&&this.logger.info(this.module_,"switchAudioDevice, no need replace sender track"),this.microphoneId_=e,this.effectiveMicrophoneId_=e,await Promise.all(s)}async switchDevice(e,t){return await this.switchDeviceImpl(e,t)}async switchDeviceImpl(e,t){return new Promise(((r,i)=>{if(this.logger.info(this.module_,"switchDeviceImpl begin, type:".concat(e,", deviceId:").concat(t)),e===ok.TRACK_TYPE_AUDIO){if("default"!==t&&(this.effectiveMicrophoneId_===t||this.audioSource_))return void r();this.switchAudioDevice(t).then((()=>{this.stopSendMutePackage(),this.stat.reportSwitchDevicesInfo(RC.INPUT_AUDIO,t,BC.SUCCESS),r()})).catch((e=>{this.stat.reportSwitchDevicesInfo(RC.INPUT_AUDIO,t,BC.FAIL),this.logger.error(this.module_,"switchDevice failed, errmsg= ".concat(e)),i(new qc(Wc.RTC_ERR_CODE_RTC_SDK_ERROR))}))}else if(e===ok.TRACK_TYPE_VIDEO){if(this.effectiveCameraId_===t||this.videoSource_)return void r();this.switchVideoDevice(t).then((()=>{this.stat.reportSwitchDevicesInfo(RC.INPUT_VIDEO,t,BC.SUCCESS),r()})).catch((e=>{this.stat.reportSwitchDevicesInfo(RC.INPUT_VIDEO,t,BC.FAIL),this.logger.error(this.module_,"switchDevice failed, errmsg= ".concat(e)),i(new qc(Wc.RTC_ERR_CODE_RTC_SDK_ERROR))}))}else i(new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"invalid media type:".concat(e)))}))}async addTrack(e,t){return await this.addTrackImpl(e,t)}async addTrackImpl(e,t){var r;if(!e)throw this.logger.error(this.module_,"addTrack, track is null"),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"track is null");if(this.logger.info(this.module_,"addTrackImpl begin, resolutionId:".concat(t,", physical track id:").concat(e.id)),e.kind===ok.TRACK_TYPE_AUDIO){const r=this.getUninitializedAudioHRTCTrack();if(!r)throw this.logger.error(this.module_,"addTrackImpl failed, audio track already exist"),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"audio track already exist");{await r.replaceTrack(e),this.replaceMixAudioTrack(e);const i=this.getAnyVideoHRTCTrack(t),n=null!=i&&i.isPlaying()?i:null;n&&await this.play(n.getElementId(),{objectFit:n.getObjectFit(),muted:n.getTrackMuted(),resolutionId:n.getResolutionId()}),this.logger.info(this.module_,"addTrackImpl success , track type is audio,"+"physical track id:".concat(e.id))}}else{const r=this.getUninitializedVideoHRTCTrack(t);if(!r)throw this.logger.error(this.module_,"addTrackImpl failed, video track already exist"),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"video track already exist");{await r.replaceTrack(e);const t=this.getAnyAudioHRTCTrack(),i=null!=t&&t.isPlaying()?t:null;i&&await this.play(i.getElementId(),{objectFit:i.getObjectFit(),muted:i.getTrackMuted(),resolutionId:null}),this.logger.info(this.module_,"addTrackImpl success , track type is video,"+"physical track id:".concat(e.id))}}null===(r=this.mediaStream)||void 0===r||r.addTrack(e);for(const i of this.client_)i&&await i.publish(this)}async removeTrack(e){return await this.removeTrackImpl(e)}async removeTrackImpl(e){var t;if(!e)throw this.logger.error(this.module_,"removeTrack, track is null"),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"track is null");if(e.kind===ok.TRACK_TYPE_AUDIO)for(const[n,o]of this.tracks[ok.TRACK_TYPE_AUDIO]){var r;e.id===(null==o||null===(r=o.getTrack())||void 0===r?void 0:r.id)&&(o.removeTrack(),this.tracks[ok.TRACK_TYPE_AUDIO].set(n,o),this.logger.info(this.module_,"removeTrackImpl success , track type is ".concat(o.getTrackType(),",")+"physical track id:".concat(e.id)))}else for(const[n,o]of this.tracks[ok.TRACK_TYPE_VIDEO]){var i;e.id===(null==o||null===(i=o.getTrack())||void 0===i?void 0:i.id)&&(o.removeTrack(),this.tracks[ok.TRACK_TYPE_VIDEO].set(n,o),this.logger.info(this.module_,"removeTrackImpl success , track type is ".concat(o.getTrackType(),",")+"physical track id:".concat(e.id)))}null===(t=this.mediaStream)||void 0===t||t.removeTrack(e);for(const n of this.client_)n&&await n.publish(this)}async replaceTrack(e,t,r){return await this.replaceTrackImpl(e,t,r)}async replaceTrackImpl(e,t,r){var i,n,o;if(!e)throw this.logger.error(this.module_,"replaceTrack, track is null"),new qc(Wc.RTC_ERR_CODE_RTC_SDK_ERROR);let s;t===ok.TRACK_TYPE_AUDIO?(s=this.getAudioHRTCTrack(),this.replaceMixAudioTrack(e)):t===ok.TRACK_TYPE_VIDEO&&(s=this.getVideoHRTCTrack(r)),null===(i=this.mediaStream)||void 0===i||i.removeTrack(s.getTrack()),null===(n=this.mediaStream)||void 0===n||n.addTrack(e),await(null===(o=s)||void 0===o?void 0:o.replaceTrack(e));for(const a of this.client_)a&&await a.publish(this)}addClient(e){this.client_=this.client_.filter((t=>t&&t.getSymbol()!==e.getSymbol())),e&&this.client_.push(e)}removeClient(e){e&&-1!==this.client_.indexOf(e)&&this.client_.splice(this.client_.indexOf(e),1)}muteAudio(){return!!super.muteAudio()&&(this.stat.reportAudioMuteInfo(1,!0),this.client_.forEach((e=>{e.changeStreamMuteStatusNotify(!0,ok.TRACK_TYPE_AUDIO),e.reportAudioMuteInfo(1,!0)})),!0)}muteVideo(){return!!super.muteVideo()&&(this.stat.reportVideoMuteInfo(this.userId_,!0),this.client_.forEach((e=>{var t;const r=(null===(t=this.getHRTCTracks({hasTrack:!0,mediaType:ok.TRACK_TYPE_VIDEO}))||void 0===t?void 0:t.length)>1;e.changeStreamMuteStatusNotify(!0,ok.TRACK_TYPE_VIDEO,this.isAuxiliary_?iC.desktop:iC.main,r),e.reportVideoMuteInfo(this.userId_,!0)})),!0)}unmuteAudio(){return!!super.unmuteAudio()&&(this.stat.reportAudioMuteInfo(1,!1),this.client_.forEach((e=>{e.changeStreamMuteStatusNotify(!1,ok.TRACK_TYPE_AUDIO),e.reportAudioMuteInfo(1,!1)})),!0)}unmuteVideo(){return!!super.unmuteVideo()&&(this.stat.reportVideoMuteInfo(this.userId_,!1),this.client_.forEach((e=>{var t;const r=(null===(t=this.getHRTCTracks({hasTrack:!0,mediaType:ok.TRACK_TYPE_VIDEO}))||void 0===t?void 0:t.length)>1;e.changeStreamMuteStatusNotify(!1,ok.TRACK_TYPE_VIDEO,this.isAuxiliary_?iC.desktop:iC.main,r),e.reportVideoMuteInfo(this.userId_,!1)})),!0)}closeImpl(e){!1!==(null==e?void 0:e.audio)&&(this.closeScreenShareAudio(),this.isAuxiliary()||this.audioMixInfo_.playAutoEnded||this.audioMixInfo_.audioMixState===qb.IDLE||this.audioMixInfo_.audioMixState===qb.INIT||this.stopAudioMixing()),super.closeImpl(e)}clearEffectiveDeviceId(e,t){this.logger.info(this.module_,"clearEffectiveDeviceId, Input:".concat(e,", type:").concat(t)),"audioInput"===t?this.effectiveMicrophoneId_===e&&(this.effectiveMicrophoneId_="",this.logger.info(this.module_,"clearEffectiveDeviceId, audioInput:".concat(e))):"videoInput"===t&&this.effectiveCameraId_===e&&(this.effectiveCameraId_="",this.logger.info(this.module_,"clearEffectiveDeviceId, videoInput:".concat(e)))}startSendMutePackage(){var e;this.logger.debug(this.module_,"start SendMutePackage");const t=null===(e=this.getAudioHRTCTrack())||void 0===e?void 0:e.getTrack();if(!t||"ended"!==t.readyState)return void this.logger.info(this.module_,"removed device is not in use, startSendMutePackage end");if(this.muteSendInfo.audioMixState!=qb.IDLE||!this.client_[0].getPublishAudioSender())return void this.logger.info(this.module_,"the condition is not met, startSendMutePackage end");this.muteSendInfo.audioCtx||(this.muteSendInfo.audioCtx=new AudioContext);let r=this.mutePackageData.slice(0);this.muteSendInfo.audioCtx.decodeAudioData(r,(e=>{var t;this.muteSendInfo.destNode=this.muteSendInfo.audioCtx.createMediaStreamDestination(),this.muteSendInfo.sourceNode=this.muteSendInfo.audioCtx.createBufferSource(),this.muteSendInfo.sourceNode.buffer=e,this.muteSendInfo.sourceNode.connect(this.muteSendInfo.destNode),this.muteSendInfo.sourceNode.loop=!0,this.muteSendInfo.sourceNode.start(0,0),this.muteSendInfo.audioMixState=qb.PLAY,null===(t=this.client_[0].getPublishAudioSender())||void 0===t||t.replaceTrack(this.muteSendInfo.destNode.stream.getAudioTracks()[0]),this.logger.info(this.module_,"startSendMutePackage success"),r=null}),(()=>{this.muteSendInfo.audioMixState=qb.IDLE,this.logger.info(this.module_,"startSendMutePackage failed"),r=null}))}stopSendMutePackage(){var e,t,r;this.logger.info(this.module_,"stopSendMutePackage begin"),this.muteSendInfo.audioMixState===qb.PLAY?(null===(e=this.muteSendInfo.mediaNode)||void 0===e||e.connect(this.muteSendInfo.destNode),null===(t=this.muteSendInfo.sourceNode)||void 0===t||t.stop(),null===(r=this.muteSendInfo.sourceNode)||void 0===r||r.disconnect(),this.muteSendInfo.sourceNode=null,this.muteSendInfo.audioMixState=qb.IDLE):this.logger.info(this.module_,"stopSendMutePackage end")}bindScreenAudio2RelatedStream(e,t){this.bindScreenAudio2RelatedStreamImpl(e,t)}bindScreenAudio2RelatedStreamImpl(e,t){if(this.logger.info(this.module_,"bindScreenAudio2RelatedStreamImpl, streamId: ".concat(e.getId())),t&&!e.hasAudioTrack()){const t=this.getAudioTrack();if(t){const r=new qk({streamType:sk.STREAM_TYPE_MAIN,trackType:ok.TRACK_TYPE_AUDIO,isRemote:!1,logger:this.logger,resolutionId:this.generateResolutionId(),track:t,event:this.eventEmitter});e.tracks[ok.TRACK_TYPE_AUDIO].set("mainAudio",r)}}this.screenShareMixInfo.bindStream=e,e.screenShareMixInfo.bindStream=this;this.mixScreenAudio(t)||(this.screenShareMixInfo.bindStream=null,e.screenShareMixInfo.bindStream=null)}mixScreenAudio(){var e;let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const r=this.screenShareMixInfo.bindStream;if(!this.isAuxiliary()||null==r||!r.getAudioHRTCTrack()||!this.getAudioHRTCTrack())return this.logger.error(this.module_,"mixScreenAudio2MainStreamAudio failed, isAuxiliary: ".concat(this.isAuxiliary()," ,main stream or audio track is null")),!1;if(this.screenShareMixInfo.status=qb.PLAY,!r.audioMixInfo_.audioCtx){var i;r.audioMixInfo_.audioCtx=new AudioContext,r.audioMixInfo_.destNode=r.audioMixInfo_.audioCtx.createMediaStreamDestination();const e=null===(i=r.getAudioHRTCTrack())||void 0===i?void 0:i.getTrack();e&&(r.audioMixInfo_.mediaNode=r.audioMixInfo_.audioCtx.createMediaStreamSource(new MediaStream([e])),r.audioMixInfo_.mediaNode.connect(r.audioMixInfo_.destNode))}t&&(r.audioMixInfo_.mediaNode.disconnect(r.screenShareMixInfo.destNode),this.logger.info(this.module_,"mixScreenAudio2MainStreamAudio, only play screen share audio stream"));const n=null===(e=this.getAudioHRTCTrack())||void 0===e?void 0:e.getTrack();return this.screenShareMixInfo.screenShareAudioNode=r.audioMixInfo_.audioCtx.createMediaStreamSource(new MediaStream([n])),this.screenShareMixInfo.destNode=r.audioMixInfo_.destNode,this.screenShareMixInfo.gainNode=r.audioMixInfo_.audioCtx.createGain(),this.screenShareMixInfo.gainNode.gain.value=this.screenShareMixInfo.gainValue,this.screenShareMixInfo.screenShareAudioNode.connect(this.screenShareMixInfo.gainNode),this.screenShareMixInfo.gainNode.connect(this.screenShareMixInfo.destNode),this.screenShareMixInfo.muteMainAudio=t,!0}getPublishAudioTrack(){var e;if(this.isAuxiliary()){if(this.screenShareMixInfo.destNode&&this.screenShareMixInfo.destNode.stream){const e=this.screenShareMixInfo.destNode.stream.getAudioTracks();if(e&&e.length>0)return e[0]}}else{const e=this.screenShareMixInfo.bindStream;if(e){const t=e.client_.length>0&&e.client_[0].getPublishVideoSender(sk.STREAM_TYPE_AUX).length,r=this.audioMixInfo_.audioMixState===qb.PAUSE||this.audioMixInfo_.audioMixState===qb.PLAY;if((t||r)&&this.audioMixInfo_.destNode&&this.audioMixInfo_.destNode.stream){const e=this.audioMixInfo_.destNode.stream.getAudioTracks();if(e&&e.length>0)return e[0]}}else if(this.audioMixInfo_.destNode&&this.audioMixInfo_.destNode.stream){const e=this.audioMixInfo_.destNode.stream.getAudioTracks();if(e&&e.length>0)return e[0]}}return null===(e=super.getAudioHRTCTrack())||void 0===e?void 0:e.getTrack()}async resumeMixScreenAudio(){const e=this.screenShareMixInfo.bindStream;if(!(this.isAuxiliary()&&e&&this.screenShareMixInfo.gainNode&&this.screenShareMixInfo.destNode))return void this.logger.info(this.module_,"cannot resumeMixScreenAudio, isAuxiliary: ".concat(this.isAuxiliary()));this.screenShareMixInfo.gainNode.connect(this.screenShareMixInfo.destNode);const t=e.client_.length>0&&e.client_[0].getPublishAudioSender(),r=this.client_.length>0&&this.client_[0].getPublishVideoSender(sk.STREAM_TYPE_AUX).length;t&&r&&await e.client_[0].getPublishAudioSender().replaceTrack(this.getPublishAudioTrack())}async stopMixScreenAudio(){this.screenShareMixInfo.gainNode&&this.screenShareMixInfo.destNode?this.screenShareMixInfo.gainNode.disconnect(this.screenShareMixInfo.destNode):this.logger.info(this.module_,"stopScreenAudio gainNode or destNode is null")}setAudioVolume(e){if(this.isAuxiliary()){if(!this.screenShareMixInfo.bindStream||this.screenShareMixInfo.status!==qb.PLAY)return void this.logger.error(this.module_,"setScreenAudioVolume failed for play status error");const t=e/100;this.logger.info(this.module_,"setScreenAudioVolume: "+t),this.screenShareMixInfo.gainNode.gain.value=t,this.screenShareMixInfo.gainValue=t}else super.setAudioVolume(e)}closeScreenShareAudio(){if(this.isAuxiliary())this.screenShareMixInfo.gainNode&&this.screenShareMixInfo.gainNode.disconnect(),this.screenShareMixInfo.screenShareAudioNode&&this.screenShareMixInfo.screenShareAudioNode.disconnect(),this.screenShareMixInfo.gainNode=null,this.screenShareMixInfo.gainValue=.5,this.screenShareMixInfo.screenShareAudioNode=null,this.screenShareMixInfo.bindStream=null,this.screenShareMixInfo.status=qb.INIT;else{const e=this.screenShareMixInfo.bindStream;if(!e)return void this.logger.debug(this.module_,"closeScreenShareAudio, no need closeScreenShareAudio, aux stream is null");e.closeScreenShareAudio(),this.screenShareMixInfo.bindStream=null}}async startAudioMixing(e){await this.startAudioMixingImpl(e),this.eventEmitter.emit(Pb),this.logger.info(this.module_,"emit ".concat(Pb," at startAudioMixing"))}async startAudioMixingImpl(e){var t,r;if(this.logger.info(this.module_,"startAudioMixing start at: "+e.startTime),this.checkAudioMixingParameter(),this.audioMixInfo_.audioMixState===qb.IDLE&&this.initIdleAudioMixInfo(),this.audioMixInfo_.audioMixState!==qb.INIT)throw this.logger.error(this.module_,"startAudioMixing status: ".concat(this.audioMixInfo_.audioMixState)),new qc(Wc.RTC_ERR_CODE_STATUS_ERROR,"startAudioMixing status: ".concat(this.audioMixInfo_.audioMixState));(this.setAudioMixOption(e),this.audioMixOption_.replace)?this.logger.info(this.module_,"startAudioMixing: replace"):null===(r=this.audioMixInfo_.mediaNode)||void 0===r||r.connect(this.audioMixInfo_.destNode);await(null===(t=this.client_[0].getPublishAudioSender())||void 0===t?void 0:t.replaceTrack(this.audioMixInfo_.destNode.stream.getAudioTracks()[0]));try{const e=await oA.fetch(this.audioMixOption_.filePath);await this.audioMixInfo_.audioCtx.decodeAudioData(e.data,(e=>{this.audioMixInfo_.startAt=bR.getCurrentTimestamp(),this.audioMixInfo_.pauseAt=0,this.audioMixInfo_.pauseDur=0,this.audioMixInfo_.playAutoEnded=!1,this.audioMixInfo_.totalDur=0,this.audioMixInfo_.sourceNode=this.audioMixInfo_.audioCtx.createBufferSource(),this.audioMixInfo_.sourceNode.onended=()=>{Math.abs(this.audioMixInfo_.totalDur-(bR.getCurrentTimestamp()-this.audioMixInfo_.startAt-this.audioMixInfo_.pauseDur))<200&&(this.stopAudioMixing(),this.audioMixInfo_.playAutoEnded=!0,this.eventEmitter.emit(Ob),this.logger.info(this.module_,"emit ".concat(Ob," at startAudioMixingImpl")))},this.audioMixInfo_.sourceNode.buffer=e,this.audioMixInfo_.buffer=e,this.audioMixInfo_.sourceNode.connect(this.audioMixInfo_.gainNode),this.audioMixInfo_.gainNode.connect(this.audioMixInfo_.destNode),this.audioMixInfo_.audioMixState=qb.PLAY,this.logger.info(this.module_,"startAudioMixing, duration: ".concat(this.getAudioMixingDuration())),this.doAudioMixing(),this.logger.info(this.module_,"startAudioMixing end")}),(e=>{throw this.logger.error(this.module_,"startAudioMixing, decode audio failed"),e}))}catch(kD){var i,n,o;if(this.logger.error(this.module_,"startAudioMixing failed: ".concat(kD)),this.audioMixInfo_.audioMixState=qb.INIT,!this.audioMixOption_.replace)null===(o=this.audioMixInfo_.mediaNode)||void 0===o||o.disconnect(this.audioMixInfo_.destNode);throw null===(i=this.client_[0].getPublishAudioSender())||void 0===i||i.replaceTrack(null===(n=this.getAudioHRTCTrack())||void 0===n?void 0:n.getTrack()),kD}}doAudioMixing(){if(this.audioMixOption_.repeatCount>1){if(this.audioMixOption_.startTime>=this.getAudioMixingDuration())throw this.logger.error(this.module_,"startAudioMixing: ".concat(this.audioMixInfo_.audioMixState)),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"startAudioMixing: not valid startTime");this.audioMixInfo_.sourceNode.loop=!0;const e=this.audioMixOption_.repeatCount*this.getAudioMixingDuration()-this.audioMixOption_.startTime;this.audioMixInfo_.totalDur=e,this.audioMixInfo_.sourceNode.start(0,this.audioMixOption_.startTime/1e3,e/1e3)}else this.audioMixInfo_.sourceNode.loop=this.audioMixOption_.loop,this.audioMixOption_.loop?this.audioMixInfo_.totalDur=1/0:(this.getAudioMixingDuration()<=this.audioMixOption_.startTime&&(this.logger.info(this.module_,"startAudioMixing, bookmark: ".concat(this.audioMixOption_.startTime," invalid and reset to begin.")),this.audioMixOption_.startTime=0),this.audioMixInfo_.totalDur=this.getAudioMixingDuration()-this.audioMixOption_.startTime),this.audioMixInfo_.sourceNode.start(0,this.audioMixOption_.startTime/1e3)}setAudioMixOption(e){e.replace||(e.replace=!1),e.startTime||(e.startTime=0),e.loop||(e.loop=!1),e.repeatCount&&!e.loop||(e.repeatCount=0),this.audioMixOption_=e}initIdleAudioMixInfo(){if(!this.audioMixInfo_.audioCtx){var e;this.audioMixInfo_.audioCtx=new AudioContext,this.audioMixInfo_.destNode=this.audioMixInfo_.audioCtx.createMediaStreamDestination();const t=null===(e=this.getAudioHRTCTrack())||void 0===e?void 0:e.getTrack();t&&(this.audioMixInfo_.mediaNode=this.audioMixInfo_.audioCtx.createMediaStreamSource(new MediaStream([t])))}this.audioMixInfo_.gainNode=this.audioMixInfo_.audioCtx.createGain(),this.audioMixInfo_.gainNode.gain.value=this.audioMixInfo_.gainValue,this.audioMixInfo_.audioMixState=qb.INIT}checkAudioMixingParameter(){if(!this.client_||this.client_.length<1||!this.client_[0].getPublishAudioSender())throw this.logger.error(this.module_,"startAudioMixing failed"),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"no mediaStream or no client or no audio!")}replaceMixAudioTrack(e){if(this.audioMixInfo_.audioMixState!==qb.IDLE&&this.audioMixInfo_.audioMixState!==qb.INIT&&this.audioMixInfo_.mediaNode&&this.audioMixInfo_.destNode){if(this.audioMixOption_.replace)return;return this.audioMixInfo_.mediaNode.disconnect(this.audioMixInfo_.destNode),this.audioMixInfo_.mediaNode=null,this.audioMixInfo_.mediaNode=this.audioMixInfo_.audioCtx.createMediaStreamSource(new MediaStream([e])),void this.audioMixInfo_.mediaNode.connect(this.audioMixInfo_.destNode)}if(!this.isAuxiliary_){var t;const r=null===(t=this.screenShareMixInfo.bindStream)||void 0===t?void 0:t.screenShareMixInfo;r&&!r.muteMainAudio&&this.audioMixInfo_.audioCtx&&this.audioMixInfo_.destNode&&(this.audioMixInfo_.mediaNode=this.audioMixInfo_.audioCtx.createMediaStreamSource(new MediaStream([e])),this.audioMixInfo_.mediaNode.connect(this.audioMixInfo_.destNode))}}async stopAudioMixing(){await this.stopAudioMixingImpl()}async stopAudioMixingImpl(){if(!this.audioMixInfo_.playAutoEnded)if(this.audioMixInfo_.audioMixState!==qb.IDLE&&this.audioMixInfo_.audioMixState!==qb.INIT){try{var e,t;await(null===(e=this.client_[0].getPublishAudioSender())||void 0===e?void 0:e.replaceTrack(null===(t=this.getAudioHRTCTrack())||void 0===t?void 0:t.getTrack()))}catch(lw){throw this.logger.error(this.module_,"stopAudioMixing: ".concat(this.audioMixInfo_.audioMixState,", errMsg = ").concat(lw)),new qc(Wc.RTC_ERR_CODE_RTC_SDK_ERROR)}var r;if(this.logger.info(this.module_,"stopAudioMixing"),!this.audioMixOption_.replace&&this.audioMixInfo_.audioMixState!==qb.PAUSE)null===(r=this.audioMixInfo_.mediaNode)||void 0===r||r.disconnect(this.audioMixInfo_.destNode);this.audioMixInfo_.sourceNode.stop(),this.audioMixInfo_.buffer=null,this.audioMixInfo_.sourceNode.disconnect(),this.audioMixInfo_.gainNode.disconnect(),this.audioMixInfo_.gainValue=.5,this.audioMixInfo_.sourceNode=null,this.audioMixInfo_.playAutoEnded=!1,this.audioMixInfo_.audioMixState=qb.INIT}else this.logger.info(this.module_,"stopAudioMixing: ".concat(this.audioMixInfo_.audioMixState))}pauseAudioMixing(){this.pauseAudioMixingImpl()}pauseAudioMixingImpl(){if(this.audioMixInfo_.audioMixState===qb.PLAY){this.logger.info(this.module_,"pauseAudioMixing"),this.audioMixOption_.replace||this.audioMixInfo_.mediaNode.disconnect(this.audioMixInfo_.destNode);try{var e,t;null===(e=this.client_[0].getPublishAudioSender())||void 0===e||e.replaceTrack(null===(t=this.getAudioHRTCTrack())||void 0===t?void 0:t.getTrack())}catch(lw){throw this.logger.error(this.module_,"pauseAudioMixing, errMsg = ".concat(lw)),new qc(Wc.RTC_ERR_CODE_RTC_SDK_ERROR)}this.audioMixInfo_.sourceNode.stop(),this.audioMixInfo_.sourceNode.disconnect(),this.audioMixInfo_.gainNode.disconnect(),this.audioMixInfo_.pauseAt=bR.getCurrentTimestamp(),this.audioMixInfo_.audioMixState=qb.PAUSE}else this.logger.error(this.module_,"pauseAudioMixing: ".concat(this.audioMixInfo_.audioMixState))}resumeAudioMixing(){this.resumeAudioMixingImpl(),this.eventEmitter.emit(Pb),this.logger.info(this.module_,"emit ".concat(Pb," at resumeAudioMixing"))}resumeAudioMixingImpl(){if(this.audioMixInfo_.audioMixState!==qb.PAUSE)return void this.logger.error(this.module_,"resumeAudioMixing: ".concat(this.audioMixInfo_.audioMixState));this.logger.info(this.module_,"resumeAudioMixing"),this.audioMixOption_.replace||this.audioMixInfo_.mediaNode.connect(this.audioMixInfo_.destNode);try{var e;null===(e=this.client_[0].getPublishAudioSender())||void 0===e||e.replaceTrack(this.audioMixInfo_.destNode.stream.getAudioTracks()[0])}catch(lw){throw this.logger.error(this.module_,"pauseAudioMixing, errMsg = ".concat(lw)),new qc(Wc.RTC_ERR_CODE_RTC_SDK_ERROR)}this.audioMixInfo_.sourceNode=this.audioMixInfo_.audioCtx.createBufferSource(),this.audioMixInfo_.sourceNode.onended=()=>{Math.abs(this.audioMixInfo_.totalDur-(bR.getCurrentTimestamp()-this.audioMixInfo_.startAt-this.audioMixInfo_.pauseDur))<200&&(this.stopAudioMixing(),this.audioMixInfo_.playAutoEnded=!0,this.eventEmitter.emit(Ob),this.logger.info(this.module_,"emit ".concat(Ob," at resumeAudioMixingImpl")))},this.audioMixInfo_.sourceNode.buffer=this.audioMixInfo_.buffer,this.audioMixInfo_.sourceNode.connect(this.audioMixInfo_.gainNode),this.audioMixInfo_.gainNode.connect(this.audioMixInfo_.destNode);const t=this.audioMixInfo_.pauseAt-this.audioMixInfo_.startAt-this.audioMixInfo_.pauseDur,r=t+this.audioMixOption_.startTime;if(this.audioMixOption_.repeatCount>1){this.audioMixInfo_.sourceNode.loop=!0;const e=this.audioMixOption_.repeatCount*this.getAudioMixingDuration()-this.audioMixOption_.startTime-t;this.audioMixInfo_.sourceNode.start(0,r%this.getAudioMixingDuration()/1e3,e/1e3)}else this.audioMixInfo_.sourceNode.loop=this.audioMixOption_.loop,this.audioMixInfo_.sourceNode.start(0,r%this.getAudioMixingDuration()/1e3);this.audioMixInfo_.pauseDur=this.audioMixInfo_.pauseDur+bR.getCurrentTimestamp()-this.audioMixInfo_.pauseAt,this.audioMixInfo_.audioMixState=qb.PLAY}getAudioMixingCurrentPosition(){let e=0;if(this.audioMixInfo_.audioMixState===qb.PAUSE)e=this.audioMixInfo_.pauseAt;else{if(this.audioMixInfo_.audioMixState!==qb.PLAY)return 0;e=bR.getCurrentTimestamp()}const t=this.getAudioMixingDuration();let r=(e-this.audioMixInfo_.startAt-this.audioMixInfo_.pauseDur+this.audioMixOption_.startTime)%t;return r=Math.min(Math.round(r),t),this.logger.debug(this.module_,"getAudioMixingDuration: ".concat(r)),r}getAudioMixingDuration(){if(this.audioMixInfo_.audioMixState!==qb.PLAY&&this.audioMixInfo_.audioMixState!==qb.PAUSE)return this.logger.error(this.module_,"getAudioMixingDuration failed for play status error"),0;const e=1e3*this.audioMixInfo_.sourceNode.buffer.duration;return this.logger.debug(this.module_,"getAudioMixingDuration: ".concat(e)),e}setAudioMixingVolume(e){this.setAudioMixingVolumeImpl(e)}setAudioMixingVolumeImpl(e){if(this.audioMixInfo_.audioMixState!==qb.PLAY&&this.audioMixInfo_.audioMixState!==qb.PAUSE)return void this.logger.error(this.module_,"setAudioMixingVolume failed for play status error");const t=e/100;this.logger.debug(this.module_,"setAudioMixingVolume: "+t),this.audioMixInfo_.gainValue=t,this.audioMixInfo_.gainNode.gain.value=t}setAudioMixingPosition(e){this.setAudioMixingPositionImpl(e)}setAudioMixingPositionImpl(e){if(this.audioMixInfo_.audioMixState!==qb.PLAY&&this.audioMixInfo_.audioMixState!==qb.PAUSE)return void this.logger.error(this.module_,"setAudioMixingPosition failed for play status error");const t=this.getAudioMixingDuration();if(e<0||e>t)return void this.logger.error(this.module_,"setAudioMixingPosition failed for params error");let r;this.logger.debug(this.module_,"setAudioMixingPosition: ".concat(e)),this.audioMixInfo_.mediaNode.connect(this.audioMixInfo_.destNode),this.audioMixInfo_.sourceNode.stop(),this.audioMixInfo_.sourceNode.disconnect(),this.audioMixInfo_.gainNode.disconnect(),this.audioMixInfo_.sourceNode=null,r=this.audioMixInfo_.audioMixState===qb.PAUSE?this.audioMixInfo_.pauseAt:bR.getCurrentTimestamp();const i=r-this.audioMixInfo_.startAt-this.audioMixInfo_.pauseDur+this.audioMixOption_.startTime;if(this.audioMixOption_.replace&&(this.audioMixInfo_.mediaNode.disconnect(this.audioMixInfo_.destNode),this.logger.info(this.module_,"resumeAudioMixing: replace")),this.audioMixInfo_.startAt=bR.getCurrentTimestamp(),this.audioMixInfo_.pauseAt=0,this.audioMixInfo_.pauseDur=0,this.audioMixInfo_.playAutoEnded=!1,this.audioMixInfo_.sourceNode=this.audioMixInfo_.audioCtx.createBufferSource(),this.audioMixInfo_.sourceNode.onended=()=>{Math.abs(this.audioMixInfo_.totalDur-(bR.getCurrentTimestamp()-this.audioMixInfo_.startAt-this.audioMixInfo_.pauseDur))<200&&(this.stopAudioMixing(),this.audioMixInfo_.playAutoEnded=!0,this.eventEmitter.emit(Ob),this.logger.info(this.module_,"emit ".concat(Ob," at setAudioMixingPositionImpl")))},this.audioMixInfo_.sourceNode.buffer=this.audioMixInfo_.buffer,this.audioMixInfo_.sourceNode.connect(this.audioMixInfo_.gainNode),this.audioMixInfo_.gainNode.connect(this.audioMixInfo_.destNode),i>=t&&this.audioMixOption_.repeatCount>1&&(this.audioMixOption_.repeatCount=Math.max(0,this.audioMixOption_.repeatCount-Math.floor(i/t))),this.audioMixOption_.repeatCount>1){this.audioMixInfo_.sourceNode.loop=!0;const r=this.audioMixOption_.repeatCount*t-e;this.audioMixInfo_.totalDur=r,this.audioMixInfo_.sourceNode.start(0,e/1e3,r/1e3)}else this.audioMixOption_.loop?this.audioMixInfo_.totalDur=1/0:this.audioMixInfo_.totalDur=t-e,this.audioMixInfo_.sourceNode.loop=this.audioMixOption_.loop,this.audioMixInfo_.sourceNode.start(0,e/1e3);this.audioMixOption_.startTime=e,this.audioMixInfo_.audioMixState===qb.PAUSE&&this.pauseAudioMixing()}getStatInfo(){return{audioProfile_:this.audioProfile_,videoProfile_:this.videoProfiles_,screenProfile_:this.screenProfile_,audio_:this.audio_,video_:this.video_,cameraId_:this.getCurrentCameraId(),facingMode_:this.facingMode_,microphoneId_:this.getCurrentMicrophoneId(),screen_:this.screen_,screenAudio_:this.screenAudio_}}},r(VO.prototype,"initialize",[yO],Object.getOwnPropertyDescriptor(VO.prototype,"initialize"),VO.prototype),r(VO.prototype,"addAudioTrackCapture",[IO],Object.getOwnPropertyDescriptor(VO.prototype,"addAudioTrackCapture"),VO.prototype),r(VO.prototype,"addVideoTrackCapture",[TO],Object.getOwnPropertyDescriptor(VO.prototype,"addVideoTrackCapture"),VO.prototype),r(VO.prototype,"setAudioProfile",[RO],Object.getOwnPropertyDescriptor(VO.prototype,"setAudioProfile"),VO.prototype),r(VO.prototype,"setVideoProfile",[EO],Object.getOwnPropertyDescriptor(VO.prototype,"setVideoProfile"),VO.prototype),r(VO.prototype,"addResolution",[bO],Object.getOwnPropertyDescriptor(VO.prototype,"addResolution"),VO.prototype),r(VO.prototype,"removeResolution",[CO],Object.getOwnPropertyDescriptor(VO.prototype,"removeResolution"),VO.prototype),r(VO.prototype,"setScreenProfile",[AO],Object.getOwnPropertyDescriptor(VO.prototype,"setScreenProfile"),VO.prototype),r(VO.prototype,"switchDevice",[wO],Object.getOwnPropertyDescriptor(VO.prototype,"switchDevice"),VO.prototype),r(VO.prototype,"addTrack",[kO],Object.getOwnPropertyDescriptor(VO.prototype,"addTrack"),VO.prototype),r(VO.prototype,"removeTrack",[OO],Object.getOwnPropertyDescriptor(VO.prototype,"removeTrack"),VO.prototype),r(VO.prototype,"replaceTrack",[PO],Object.getOwnPropertyDescriptor(VO.prototype,"replaceTrack"),VO.prototype),r(VO.prototype,"bindScreenAudio2RelatedStream",[MO],Object.getOwnPropertyDescriptor(VO.prototype,"bindScreenAudio2RelatedStream"),VO.prototype),r(VO.prototype,"startAudioMixing",[DO],Object.getOwnPropertyDescriptor(VO.prototype,"startAudioMixing"),VO.prototype),r(VO.prototype,"stopAudioMixing",[NO],Object.getOwnPropertyDescriptor(VO.prototype,"stopAudioMixing"),VO.prototype),r(VO.prototype,"pauseAudioMixing",[UO],Object.getOwnPropertyDescriptor(VO.prototype,"pauseAudioMixing"),VO.prototype),r(VO.prototype,"resumeAudioMixing",[xO],Object.getOwnPropertyDescriptor(VO.prototype,"resumeAudioMixing"),VO.prototype),r(VO.prototype,"setAudioMixingVolume",[LO],Object.getOwnPropertyDescriptor(VO.prototype,"setAudioMixingVolume"),VO.prototype),r(VO.prototype,"setAudioMixingPosition",[BO],Object.getOwnPropertyDescriptor(VO.prototype,"setAudioMixingPosition"),VO.prototype),VO);class zO extends HO{constructor(e){super({isRemote:!0,type:e.type,log:e.log}),this.userId_=e.userId,this.client_=[],this.client_.push(e.client),this.module_="RemoteStream",this.roomId_=e.roomId}muteAudio(){return!!super.muteAudio()&&(this.stat.reportAudioMuteInfo(2,!0),!0)}unmuteAudio(){return!!super.unmuteAudio()&&(this.stat.reportAudioMuteInfo(2,!1),!0)}getVideoHRTCTrackByTrackId(e){let t;for(const r of this.tracks[ok.TRACK_TYPE_VIDEO].values())if(r.getTrackId()===e){t=r;break}return t}updateRemoteResolutions(e,t,r){if(!t)return;const i=this.getHRTCTrackIds({mediaType:ok.TRACK_TYPE_VIDEO}),n=t.map((e=>e.streamId));for(const a of i)if(null==n||!n.includes(a))for(const t of this.getHRTCTracks({mediaType:ok.TRACK_TYPE_VIDEO}))if((null==t?void 0:t.getTrackId())===a){this.logger.info(this.module_,"updateRemoteResolutions, streamType:".concat(e,",delete track:").concat(a)),this.stop({audio:!1,video:!0,resolutionIds:[a]}),this.removeRemoteVideoTrack(a),this.tracks[ok.TRACK_TYPE_VIDEO].delete(t.getResolutionId());break}for(const a of t){if(i.includes(a.streamId)){var o;null===(o=this.getVideoHRTCTrackByTrackId(a.streamId))||void 0===o||o.updateTrackProfile(a);continue}const t=new qk({streamType:e,trackType:ok.TRACK_TYPE_VIDEO,isRemote:!0,trackProfile:{width:a.width,height:a.height},logger:this.logger,resolutionId:a.streamId,event:this.eventEmitter});t.setTrackId(a.streamId||t.getResolutionId()),this.tracks[ok.TRACK_TYPE_VIDEO].set(a.streamId,t)}const s=this.getAnyAudioHRTCTrack();if(r){if(!s){const t=new qk({streamType:e,trackType:ok.TRACK_TYPE_AUDIO,isRemote:!0,logger:this.logger,resolutionId:this.id_,event:this.eventEmitter});this.tracks[ok.TRACK_TYPE_AUDIO].set("mainAudio",t)}}else s&&(this.logger.info(this.module_,"updateRemoteResolutions, streamType:".concat(e,",delete audio track")),this.stop({audio:!0,video:!1}),this.removeRemoteAudioTrack(),this.tracks[ok.TRACK_TYPE_AUDIO].delete("mainAudio"));this.logger.info(this.module_,"updateResolutions success,userId:".concat(this.getUserId(),", streamType:").concat(e,",")+"new resolution is ".concat(this.getHRTCTracksProfileString(),"  hasAudio: ").concat(this.hasAudioTrack()))}getHRTCTracksProfileString(){const e=this.getHRTCTracks();let t="";return e.forEach((e=>{t=t+e.getTrackId()+":"+JSON.stringify(e.getTrackProfile())+","})),t}addRemoteTrack(e,t){if(e.kind===ok.TRACK_TYPE_AUDIO){const t=this.getAnyAudioHRTCTrack();null==t||t.replaceTrack(e)}else{const r=Array.from(this.tracks[ok.TRACK_TYPE_VIDEO].values()).find((e=>e.getTrackId()===t));null==r||r.replaceTrack(e)}this.logger.info(this.module_,"addRemoteTrack MediaStreamTrack for trackId:".concat(t," success,userId:").concat(this.getUserId(),", type:").concat(this.getType(),",")+"new resolution is ".concat(this.getHRTCTracksProfileString(),", hasAudio: ").concat(this.hasAudioTrack()))}isTracksReady(e,t){if(this.isRemote_){let r=!0;if(null!=e&&e.length){const t=this.getHRTCTrackIds();for(const i of e)if(!t.includes(i)||!this.getVideoHRTCTrackByTrackId(i).getTrack()){r=!1;break}}const i=this.getAudioHRTCTrack(),n=i&&!!i.getTrack(),o=r&&(!t||n);return this.logger.debug(this.module_,"isTracksReady userId:".concat(this.getUserId(),", type:").concat(this.getType(),",")+"result: ".concat(o,",videoTrackIds: ").concat(e,", isVideoReady:").concat(r,", isAudioReady:").concat(n)),o}return!0}isTrackReady(e,t){if(this.isRemote_){var r;if(e===ok.TRACK_TYPE_VIDEO)return!(null===(r=this.getVideoHRTCTrackByTrackId(t))||void 0===r||!r.getTrack());return!!this.getAudioHRTCTrack()}return!1}removeRemoteAudioTrack(){const e=this.getAnyAudioHRTCTrack();e&&e.removeTrack()}removeRemoteVideoTrack(e){const t=this.tracks[ok.TRACK_TYPE_VIDEO].get(e);t&&t.removeTrack()}}const WO=0,GO=2;let qO,JO;!function(e){e.JOINER="anchor",e.PLAYER="audience"}(qO||(qO={})),function(e){e[e.JOINER=0]="JOINER",e[e.PLAYER=2]="PLAYER"}(JO||(JO={}));class XO{get identifiedID(){return this.identifiedID_}set identifiedID(e){this.identifiedID_=e}get roomId(){return this.roomId_}set roomId(e){this.roomId_=e}get signature(){return this.signature_}set signature(e){this.signature_=e}get ctime(){return this.ctime_}set ctime(e){this.ctime_=e}get userId(){return this.userId_}set userId(e){this.userId_=e}get encUserId(){return this.encUserId_}set encUserId(e){this.encUserId_=e}get userName(){return this.userName_}set userName(e){this.userName_=e}get role(){return this.role_}set role(e){this.role_=e}get roleSignalType(){return GO===this.role_?qO.PLAYER:qO.JOINER}get appData(){return this.appData_}set appData(e){this.appData_=e}removeRelayInfo(e){this.relayInfos_=this.relayInfos_.filter((t=>t.roomId!==e))}addRelayInfo(e,t){this.relayInfos_||(this.relayInfos_=[]),this.relayInfos_.push({roomId:e,role:t})}getRelayInfos(){return this.relayInfos_}}const QO=new Map;class $O{static get(e){return QO.get(e)}static delete(e){QO.delete(e)}static init(e,t,r){const i=new XO;return i.identifiedID=e,i.userId=r.userId,i.userName=r.userName,i.role=r.role,i.signature=r.signature,i.ctime=r.ctime,i.appData={},r.userName&&(i.appData.nickname=r.userName),r.optionInfo&&[!0,!1].includes(r.optionInfo.recordPlaceholder)&&(i.appData.show_window=r.optionInfo.recordPlaceholder),i.roomId=t,QO.set(e,i),i}static transLocalUserToJoinConfig(e){var t;return{userId:e.userId,userName:e.userName,signature:e.signature,ctime:e.ctime,role:e.role,optionInfo:{recordPlaceholder:null===(t=e.appData)||void 0===t?void 0:t.show_window}}}static renewSignature(e,t,r){if(QO.has(e)){const i=QO.get(e);return i.ctime=t,i.signature=r,i}return null}}let ZO,eP,tP;!function(e){e.ReceiveData="ReceiveData",e.ConnectionQuality="ConnectionQuality",e.Reconnected="Reconnected",e.SessionUnavailable="SessionUnavailable",e.ConnectionUnavailable="ConnectionUnavailable",e.ConnectionStateChanged="ConnectionStateChanged",e.AuthenticateFail="AuthenticateFail",e.SignatureExpired="SignatureExpired",e.ClientBanned="ClientBanned"}(ZO||(ZO={})),function(e){e[e.NonRelation=-1]="NonRelation",e[e.Equal=0]="Equal",e[e.UnEqual=1]="UnEqual"}(eP||(eP={}));class rP extends class{constructor(){t(this,"state_",[])}default(e){return this.defaultVal_=e,this}get(){return 0!=this.state_.length?this.state_[this.state_.length-1]:null}set(e){return 2==this.state_.length&&this.state_.unshift(),this.state_.push(e),this}pre(){return this.state_.length>=2?this.state_[this.state_.length-2]:null}reset(){return this.state_=[],this.state_[0]=this.defaultVal_,this}get state(){return this.state_}}{isChanged(){return this.state.length>1&&this.get()!==this.pre()}getDiffInfo(){return this.isChanged()?{updated:this.state[1]}:{}}}!function(e){e[e.Health=1]="Health",e[e.SubHealth=4]="SubHealth",e[e.Unavailable=6]="Unavailable"}(tP||(tP={}));const iP="HealthMonitor";class nP extends jO{constructor(e){super({emitter:!0,logger:e.logger}),this.client=e,this.reset()}reset(){this.streamDetectTimer&&(clearInterval(this.streamDetectTimer),this.streamDetectTimer=null),this.streamStats={mainStream:{bytesIn:(new rP).default(0).set(0).set(0),bytesOut:(new rP).default(0).set(0).set(0)},auxStream:{bytesIn:(new rP).default(0).set(0).set(0),bytesOut:(new rP).default(0).set(0).set(0)},upQuality:(new rP).default(dk.NETWORK_QUALITY_UNKNOW).set(dk.NETWORK_QUALITY_UNKNOW).set(dk.NETWORK_QUALITY_UNKNOW),downQuality:(new rP).default(dk.NETWORK_QUALITY_UNKNOW).set(dk.NETWORK_QUALITY_UNKNOW).set(dk.NETWORK_QUALITY_UNKNOW)}}isStreamAvailable(){if(!this.client)return!1;const e=this.isAvailableStreamIncoming(sk.STREAM_TYPE_MAIN),t=this.isAvailableStreamIncoming(sk.STREAM_TYPE_AUX),r=this.isAvailableStreamOutgoing(sk.STREAM_TYPE_MAIN),i=this.isAvailableStreamOutgoing(sk.STREAM_TYPE_AUX);return e||t||r||i}getWsConnectionHealthStatus(){return this.streamDetectTimer?this.isStreamAvailable()?tP.SubHealth:tP.Unavailable:tP.Health}startStreamStateDetection(){this.streamDetectTimer||(this.streamDetectTimer=setInterval((async()=>{if(this.client){const e=this.client.getICETransportStat(sk.STREAM_TYPE_MAIN);e&&this.updateStreamStat(e,sk.STREAM_TYPE_MAIN);const t=this.client.getICETransportStat(sk.STREAM_TYPE_AUX);t&&this.updateStreamStat(t,sk.STREAM_TYPE_AUX),this.updateConnectionQuality(this.getWsConnectionHealthStatus())}}),3e3))}stopStreamStateDetection(){this.streamDetectTimer&&(clearInterval(this.streamDetectTimer),this.streamDetectTimer=null,this.updateConnectionQuality(this.getWsConnectionHealthStatus()))}updateConnectionQuality(e){if(!this.client)return;const t=this.client.isSendingStream()?e:dk.NETWORK_QUALITY_UNKNOW,r=this.client.isReceivingStream()?e:dk.NETWORK_QUALITY_UNKNOW;this.updateSignalQuality(t,r)}isAvailableStreamIncoming(e){const t=e===sk.STREAM_TYPE_MAIN?this.streamStats.mainStream:this.streamStats.auxStream;return t.bytesIn.get()-t.bytesIn.pre()>nP.getMinAvailableBytes()}static getMinAvailableBytes(){return xb.low.bitrate/8*3}isAvailableStreamOutgoing(e){const t=e===sk.STREAM_TYPE_MAIN?this.streamStats.mainStream:this.streamStats.auxStream;return t.bytesOut.get()-t.bytesOut.pre()>nP.getMinAvailableBytes()}updateStreamStat(e,t){const r=t===sk.STREAM_TYPE_MAIN?this.streamStats.mainStream:this.streamStats.auxStream;this.logger.info(iP,"".concat(t," : bytesIn:").concat(e.bytesReceived," ,bytesOut:").concat(e.bytesSent)),r.bytesIn.set(e.bytesReceived),r.bytesOut.set(e.bytesSent)}updateSignalQuality(e,t){if(this.streamStats.upQuality.set(e),this.streamStats.downQuality.set(t),this.logger.info(iP,"upQuality:".concat(this.streamStats.upQuality.pre(),",").concat("".concat(e)," ,downQuality:").concat(this.streamStats.downQuality.pre(),",").concat("".concat(t))),this.streamStats.upQuality.isChanged()||this.streamStats.downQuality.isChanged()){const r={uplinkNetworkQuality:e,downlinkNetworkQuality:t};this.logger.info(iP,"emit network-quality:".concat(JSON.stringify(r))),this.eventEmitter.emit(ZO.ConnectionQuality,r)}}getInfo(){return{moduleName:"HealthMonitor"}}}function oP(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}const sP="Socket",aP="heartbeat",cP="reconnectingEnd";var uP;!function(e){e[e.normal=1e3]="normal",e[e.multiKickoff=4e3]="multiKickoff",e[e.authenticateFail=4001]="authenticateFail",e[e.kickoff=4002]="kickoff",e[e.releaseRoom=4003]="releaseRoom",e[e.heartbeatTimeout=4004]="heartbeatTimeout",e[e.serverReconnectReq=4005]="serverReconnectReq",e[e.serveReconnectReqWithoutSfu=4006]="serveReconnectReqWithoutSfu",e[e.signatureFail=4009]="signatureFail"}(uP||(uP={}));let dP=0;class lP extends jO{constructor(e,r,i){super({emitter:!0,logger:i.logger,stat:i.stat}),t(this,"callbacks",new Map),this.taskId=1e3,this.appId=e,this.edgeNodeDomains=r,this.clientConfig=i.clientConfig;const n=new rP;n.default(Xb.IDLE).reset().set(Xb.IDLE),this.wsStatus={state:n,isHeartbeat:!1,isWsReconnecting:!1,hasEverConnected:!1},this.healthMonitor=new nP(i),this.healthMonitor.on(ZO.ConnectionQuality,this.getConnectionQualityListener()),this.wsReset()}setKeepAliveParams(e){this.heartBeatConfig=e}setTraceId(e){this.traceId=e}wsReset(){var e;this.closeConnection(),this.traceId="",this.connectId="",this.wsUrl="",this.acsIP="",this.wsStatus.state.reset(),this.wsStatus.hasEverConnected=!1,this.userInfo=void 0,null===(e=this.healthMonitor)||void 0===e||e.reset()}wsDisconnect(){this.healthMonitor.off(ZO.ConnectionQuality),this.wsReset(),this.healthMonitor=void 0}getConnectionQualityListener(){return e=>{this.emit(ZO.ConnectionQuality,e)}}async wsConnect(e,t,r,i,n,o,s){this.logger.info(sP,"wsConnect, acsIP:".concat(t,", firstTimeout:").concat(n,", retryTimeout:").concat(o,", retryCount:").concat(i,",retryInterval:").concat(s)),this.wsStatus.isWsReconnecting&&(this.logger.info(sP,"wsConnect, waiting for reconnecting ending"),await this.stopReconnecting(),this.logger.info(sP,"wsConnect, reconnecting end")),this.acsIP=t,this.userInfo=e,this.wsStatus.state.set(Xb.DISCONNECTED),await this.doConnect(t,r,i,n,o,s,!1)}refreshUserInfo(e){this.userInfo=e}async startHeartbeat(){try{if(this.wsStatus.isHeartbeat)return void this.logger.warn(sP,"startHeartbeat, isHeartbeat so return");this.wsStatus.isHeartbeat=!0;const e=async e=>await this.sendHeartbeat(e);return await nO.callWithRetryTimes(e,!0,-1,this.getAsyncInterval(1e3*this.heartBeatConfig.heartBeatPeriod),this.needInterrupted())}catch(kD){this.logger.warn(sP,"startHeartbeat, error:".concat(kD))}finally{this.wsStatus.isHeartbeat=!1}}async wsSendRequest(e,t,r,i,n){this.logger.debug(sP,"wsSendRequest: ".concat(e.type," - ").concat(e.requestId));return await nO.callWithRetryTimes((async i=>await this.wsSendReqOnce(e.requestId,e,t,r,i)),!1,i,this.getAsyncInterval(n),this.needInterrupted())}wsSendResponse(e){this.ws.send(e)}generateRequestId(){return this.traceId,this.traceId+"Web"+(this.taskId++).toString()}async doConnect(e,t,r,i,n,o,s){return await nO.callWithRetryTimes((async r=>await this.wsConnectOnce(e,t,i,n,r,s)),!1,r,this.getAsyncInterval(o),this.needInterrupted())}async wsConnectOnce(e,t,r,i,n,o){if([Xb.IDLE,Xb.CONNECTING].includes(this.wsStatus.state.get())||!this.userInfo)throw new qc(Wc.RTC_ERR_CODE_WEBSOCKET_INTERRUPTED);if(this.wsStatus.state.get()!==Xb.DISCONNECTED)return this.logger.error(sP,"wsConnectOnce, cusState:".concat(this.wsStatus.state.get(),", not DISCONNECTED, return")),null;this.connectId=this.taskId.toString(),this.wsUrl=this.getWsUrl(e,o);const s=bR.getCurrentTimestamp();this.ws=new WebSocket(this.wsUrl),this.logger.info(sP,"wsConnectOnce, url:".concat(bR.shieldUrlParameters(this.wsUrl),", connectId:").concat(this.connectId,", begin create websocket connection with server ")),1!==n||o?this.triggerConnectStatesChangeEvent(Xb.RECONNECTING):this.triggerConnectStatesChangeEvent(Xb.CONNECTING),this.ws.onopen=this.onopen.bind(this),this.ws.onerror=this.onerror.bind(this),this.ws.onmessage=this.onmessage.bind(this),this.ws.onclose=this.onclose.bind(this);const a={id:((null==t?void 0:t.length)||0)+1,domain:this.edgeNodeDomains.get(e),start_ms:bR.getCurrentTimestamp(),delay_ms:0,stepName:"wsConnect",rspCode:"",errMsg:""};try{const e=1===n?r:i;await this.getConnectionResp(e),a.delay_ms=bR.getCurrentTimestamp()-a.start_ms,a.rspCode="101"}catch(kD){throw this.logger.error(sP,"wsConnectOnce, connect occur exception, connectId:".concat(this.connectId,", error: ").concat(kD)),a.delay_ms=bR.getCurrentTimestamp()-a.start_ms,"function"==typeof kD.getCode&&(a.rspCode="".concat(kD.getCode()),a.errMsg=kD.getMsg()),kD}finally{null==t||t.push(a);const e=bR.getCurrentTimestamp(),r={version:"v1",startTimestamp:s,traceId:this.xNuwaTraceId,spanId:this.xNuwaSpanId,parentSpanId:"0000000000000000",ip:"",source:"SDK",target:"WiseCloudRtcAccessService",spanName:"connect",status:"0",endTimestamp:e,url:"",httpMethod:"",requestSize:"",responseSize:"",statusCode:"",tag:"",Events:"",scope:"videortn"};this.stat.reportTraceInfo2Nuwa(r)}}async stopReconnecting(){let e=null;this.wsStatus.state.set(Xb.IDLE);const t=[new Promise((t=>{this.callbacks.set(cP,(r=>{e&&clearTimeout(e),t(r)}))})),new Promise(((t,r)=>{e=setTimeout((()=>{r(new qc(Wc.RTC_ERR_CODE_WEBSOCKET_RECONNECT_TIMEOUT))}),3e4)}))];return await Promise.race(t).then((e=>e)).finally((()=>{this.callbacks.delete(cP)}))}async getConnectionResp(e){const t=this.connectId;await nO.callWithTimeout(new Promise(((e,r)=>{this.callbacks.set(t,(i=>{if(i.isSuccess)this.logger.info(sP,"getConnectionResp, connectId:".concat(t,", connect success")),this.triggerConnectStatesChangeEvent(Xb.CONNECTED),e();else{const e=lP.newSocketException(i);this.logger.info(sP,"getConnectionResp, connectId:".concat(t,", connect fail, errMsg=").concat(e)),r(e)}}))})),e).catch((r=>{if(this.triggerConnectStatesChangeEvent(Xb.DISCONNECTED),r.getCode()!==Wc.RTC_ERR_CODE_WAIT_RSP_TIMEOUT)throw r;throw this.logger.error(sP,"getConnectionResp, connectId:".concat(t,", websocket connect timeout after ").concat(e," ms")),this.ws&&this.ws.readyState===this.ws.CONNECTING&&(this.logger.info(sP,"getConnectionResp, connectId:".concat(t,",websocket connect timeout, close webSocket manual")),this.ws.close()),new qc(Wc.RTC_ERR_CODE_WEBSOCKET_CONNECT_TIMEOUT)})).finally((()=>{this.callbacks.delete(t)}))}static newSocketException(e){if(e.isSuccess)return null;const t=Wc.RTC_ERR_CODE_WEBSOCKET_CONNECT_ERROR,r=e.code,i="".concat(r||""," websocket connect error");return new qc(t,i)}getWsUrl(e,t){let r,i;this.xNuwaTraceId=bR.generateRandomId(32,16),this.xNuwaSpanId=bR.generateRandomId(16,16);let n,o="443";const s=/ws(?:s)?:\/\/([^/]+)(.*)/.exec(this.edgeNodeDomains.get(e));if(s&&3===s.length){const e=s[1].split(":");i=e[0],o=e[1]||"443",n=s[2]}else i=this.edgeNodeDomains.get(e),n="/websocket";const a=tA.getProxyServer();return r=a?/^http.*/.test(a)?a.replace("http","ws"):a.replace("https","wss"):"".concat("wss","://").concat(i,":").concat(o),r="".concat(r).concat(n,"?appId=").concat(escape(this.appId),"&roomId=").concat(escape(this.userInfo.roomId))+"&userId=".concat(escape(this.userInfo.userId),"&role=").concat(this.userInfo.roleSignalType,"&Authorization=").concat(escape(this.userInfo.signature))+"&ctime=".concat(this.userInfo.ctime,"&clientVersion=").concat(jC,"&clientType=").concat(bR.getSystemType())+"&romVersion=".concat(bR.getRomVersion(),"&agentType=").concat(2,"&netType=").concat(bR.getNetworkType())+"&traceId=".concat(this.traceId,"&x-nuwa-trace-id=").concat(this.xNuwaTraceId,"&x-nuwa-span-id=").concat(this.xNuwaSpanId)+"&HoldTime=".concat(120).concat(t?"&reconnect=true":"")+"&instanceId=".concat(bR.getDeviceID().replace(/[-]/g,"")).concat(this.clientConfig.countryCode?"&clientCountryCode=".concat(this.clientConfig.countryCode):""),a&&(r="".concat(r,"&org_domain=").concat(i,"&org_port=").concat(o)),r}cancelWsCloseCallBack(){this.ws&&(this.ws.onclose=e=>{this.logger.info(sP,"cancelWsCloseCallBack, connect close,code:".concat(e.code,", reason:").concat(e.reason))})}closeConnection(){this.ws&&(this.logger.info(sP,"close ws when reset"),this.cancelWsCloseCallBack(),this.ws.close(),this.ws=null)}triggerConnectStatesChangeEvent(e,r){this.wsStatus.state.set(e);const i=function(e){for(var r=1;r<arguments.length;r++){var i=null!=arguments[r]?arguments[r]:{};r%2?oP(Object(i),!0).forEach((function(r){t(e,r,i[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):oP(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({prevState:Jb[this.wsStatus.state.pre()],curState:Jb[this.wsStatus.state.get()]},r);this.wsStatus.state.isChanged()&&(this.logger.info(sP,"triggerConnectStatesChangeEvent, emit:".concat(hC.ConnectionStateChanged,", body:").concat(JSON.stringify(i))),this.emit(ZO.ConnectionStateChanged,i))}static removeWatchType(e){if(null!=e&&e.watchType){const t=JSON.parse(JSON.stringify(e));return delete t.watchType,t}return e}needInterrupted(){return e=>"function"==typeof(null==e?void 0:e.getCode)&&e.getCode()===Wc.RTC_ERR_CODE_WEBSOCKET_INTERRUPTED}getAsyncInterval(e){return t=>"function"==typeof(null==t?void 0:t.getCode)&&t.getCode()===Wc.RTC_ERR_CODE_WAIT_RSP_TIMEOUT?0:e}async wsSendReqOnce(e,t,r,i,n){const o=lP.removeWatchType(t),s=bR.getCurrentTimestamp();try{if(this.wsStatus.state.get()===Xb.IDLE)throw new qc(Wc.RTC_ERR_CODE_WEBSOCKET_INTERRUPTED);if(!this.ws||this.ws.readyState!==this.ws.OPEN)throw new qc(Wc.RTC_ERR_CODE_WEBSOCKET_NOT_OPEN);n>1&&this.logger.debug(sP,"wsSendReq: ".concat(e,", retry send message"));const a=JSON.stringify(o);this.ws.send(a),this.stat&&(this.stat.reportSignalReqForWeb2Server(o),this.stat.recordUploadRequsetInfo(t));const c=1===n?r:i;return await this.getResponse(o,c)}catch(kD){throw this.logger.error(sP,"wsSendReq: ".concat(e,", type: ").concat(o.type,", tryNumber: ").concat(n,",error: ").concat(kD)),"PING"===t.type&&this.healthMonitor.startStreamStateDetection(),this.recordWsException(t,kD,s),kD}finally{const e=this.stat.checkSignalSendMsgs((null==o?void 0:o.type)||""),t=o["x-nuwa-span-id"],r=bR.getCurrentTimestamp(),i={version:"v1",startTimestamp:s,traceId:o["x-nuwa-trace-id"],spanId:t,parentSpanId:e?"0000000000000000":this.stat.getParentSpanId(o["x-nuwa-span-id"]),ip:"",source:"SDK",target:"WiseCloudRtcAccessService",spanName:(null==o?void 0:o.type)||"",status:"0",endTimestamp:r,url:"",httpMethod:"",requestSize:"",responseSize:"",statusCode:"",tag:"",Events:"",scope:"videortn"};this.stat.reportTraceInfo2Nuwa(i)}}recordWsException(e,t,r){if("PING"!==e.type)switch(e.type){case"SUBS_STREAM":{const r=t.getCode(),i=t.getMsg();e.videoUpstreams&&this.stat.reportVideoSub(e.videoSubType,e.requestId,e.videoUpstreams,r,i),e.audioUpstreams&&this.stat.reportAudioSub(e.audioSubType,e.requestId,e.audioUpstreams,r);break}}else this.stat.reportSignalReqForHeartBeatLost(e,r)}async getResponse(e,t){let r=null;const i=[new Promise((t=>{const i="PING"===e.type?aP:e.requestId;this.callbacks.set(i,(e=>{r&&clearTimeout(r),t(e)}))})),new Promise(((e,i)=>{r=setTimeout((()=>{i(new qc(Wc.RTC_ERR_CODE_WAIT_RSP_TIMEOUT))}),t)}))];return await Promise.race(i).finally((()=>{const t="PING"===e.type?aP:e.requestId;this.callbacks.delete(t)}))}onopen(e){this.callbacks.has(this.connectId)&&this.callbacks.get(this.connectId)({isSuccess:!0}),this.logger.info(sP,"onopen, wss[".concat(bR.shieldUrlParameters(this.wsUrl),"], connectId:").concat(this.connectId,", connect success, ").concat(JSON.stringify(e))),this.stat.setConnectionStatusInfo(kC.CONNECTED,wC.SIGNAL)}onerror(e){this.logger.error(sP,"onerror, connectId:".concat(this.connectId,", websocket occur error:").concat(JSON.stringify(e))),this.stat.setConnectionStatusInfo(kC.CLOSED,wC.SIGNAL),this.callbacks.has(this.connectId)&&this.callbacks.get(this.connectId)({isSuccess:!1})}onmessage(e){if(null==e||!e.data)return;const t=JSON.parse(e.data);this.wsStatus.hasEverConnected=!0,dP=0;const r=this.callbacks.get(aP);if(r&&r(t),t.type)this.emit(ZO.ReceiveData,t);else{const e=this.callbacks.get(t.requestId);e&&e(t)}this.stat.reportSignalReqForServer2Web(t);const i=this.stat.getDownloadRequestInfo(t);this.stat.recordDownloadRequestInfo(t);const n=this.stat.checkSignalReceiveMsgs((null==t?void 0:t.type)||""),o=bR.generateRandomId(16,16),s=t["x-nuwa-span-id"];n&&this.stat.setSpanId(s,o);const a=bR.getCurrentTimestamp(),c={version:"v1",startTimestamp:a,traceId:t["x-nuwa-trace-id"],spanId:o,parentSpanId:s,ip:"",source:"WiseCloudRtcAccessService",target:"SDK",spanName:(null==t?void 0:t.type)||i,status:"0",endTimestamp:a,url:"",httpMethod:"",requestSize:"",responseSize:"",statusCode:"",tag:"",Events:"",scope:"videortn"};this.stat.reportTraceInfo2Nuwa(c)}async onclose(e){const t=e.code,r=e.reason;if(this.logger.warn(sP,"onclose,connectId:".concat(this.connectId,", code:").concat(t,", reason:").concat(r)),this.stat.setConnectionStatusInfo(kC.CLOSED,wC.SIGNAL),this.callbacks.has(this.connectId)&&this.callbacks.get(this.connectId)({isSuccess:!1,code:t,reason:r}),this.triggerConnectStatesChangeEvent(Xb.DISCONNECTED,{code:t,reason:r}),lP.isServerAuthFail(t))this.handleServerAuthFail();else{if(!lP.isSignatureFail(t))return lP.isKickedOff(t)?(this.logger.warn(sP,"handleKickedOff, emit:".concat(ZO.ClientBanned)),void this.emit(ZO.ClientBanned)):lP.isServerSessionValidateFail(t)?(this.logger.warn(sP,"onclose, emit:".concat(ZO.SessionUnavailable)),void this.emit(ZO.SessionUnavailable)):void(t===uP.heartbeatTimeout||t===uP.serveReconnectReqWithoutSfu||t>1e3&&t<4e3?await this.reconnect():this.logger.error(sP,"onclose, no handler"));this.handleSignatureFail()}}handleServerAuthFail(){this.logger.error(sP,"handleServerAuthFail, auth failed to leave room"),this.logger.warn(sP,"handleServerAuthFail, emit:".concat(ZO.AuthenticateFail," ")),this.emit(ZO.AuthenticateFail)}async handleSignatureFail(){this.logger.warn(sP,"handle signature fail, emit:".concat(ZO.SignatureExpired)),this.wsStatus.hasEverConnected?(this.emit(ZO.SignatureExpired,{type:"reconnect"}),dP<5?(this.logger.warn(sP,"signature expired, try reconnect: retry times: ".concat(dP+1)),await this.reconnect(),dP++):this.emit(ZO.SessionUnavailable)):this.emit(ZO.SignatureExpired,{type:"join"})}async reconnect(){if(this.logger.info(sP,"reconnect, not user call leave, network error, go ws reconnecting"),!this.wsStatus.hasEverConnected)return this.logger.info(sP,"reconnect, haven't connect yet, so return"),null;if(this.wsStatus.isWsReconnecting)return this.logger.info(sP,"reconnect, isWsReConnecting so return"),null;try{this.wsStatus.isWsReconnecting=!0;const e=12e3,t=1e3;await this.doConnect(this.acsIP,null,-1,e,e,t,!0),this.logger.info(sP,"wsReconnect, success");const r=this.callbacks.get(cP);r&&r("success"),this.logger.warn(sP,"emit:".concat(ZO.Reconnected)),this.emit(ZO.Reconnected)}catch(kD){this.logger.error(sP,"wsReconnect, errMsg:".concat(kD));const t=this.callbacks.get(cP);t&&t(kD)}finally{this.wsStatus.isWsReconnecting=!1}}static isServerAuthFail(e){return[uP.authenticateFail,uP.releaseRoom].includes(e)}static isSignatureFail(e){return[uP.signatureFail].includes(e)}static isKickedOff(e){return[uP.multiKickoff,uP.kickoff].includes(e)}static isServerSessionValidateFail(e){return[uP.serverReconnectReq].includes(e)}async sendHeartbeat(e){try{if([Xb.IDLE,Xb.CONNECTING].includes(this.wsStatus.state.get()))throw this.logger.info(sP,"sendHeartbeat, but wsStatus is IDLE or CONNECTING, interrupted"),new qc(Wc.RTC_ERR_CODE_WEBSOCKET_INTERRUPTED);if(!this.traceId)throw this.logger.error(sP,"sendHeartbeat, traceId is null"),new qc(Wc.RTC_ERR_CODE_WEBSOCKET_INTERRUPTED);const e={type:"PING",traceId:this.traceId,requestId:this.generateRequestId(),version:HC,"x-nuwa-trace-id":bR.generateRandomId(32,16),"x-nuwa-span-id":bR.generateRandomId(16,16)};await this.wsSendRequest(e,1e3*this.heartBeatConfig.heartBeatPeriod,1e3*this.heartBeatConfig.heartBeatPeriod,this.heartBeatConfig.heartBeatRetryTimes,1e3*this.heartBeatConfig.heartBeatPeriod),this.healthMonitor.stopStreamStateDetection()}catch(kD){this.logger.info(sP,"sendHeartbeatï¼father tryNumber:".concat(e,",child heartbeat retry out of limit:").concat(this.heartBeatConfig.heartBeatRetryTimes," and fail, error:").concat(kD)),this.handleHeartbeatFail(kD)}}handleHeartbeatFail(e){if("function"==typeof(null==e?void 0:e.getCode)&&e.getCode()===Wc.RTC_ERR_CODE_WEBSOCKET_INTERRUPTED)throw this.logger.warn(sP,"handleHeartbeatFail, ErrorCode.RTC_ERR_CODE_WEBSOCKET_INTERRUPTED"),e;const t=this.healthMonitor.getWsConnectionHealthStatus();this.logger.warn(sP,"handleHeartbeatFail, healthStatus:".concat(t)),t===tP.Unavailable&&(this.logger.info(sP,"handleHeartbeatFail, connection unavailable when error:".concat(e)),this.logger.warn(sP,"emit:".concat(ZO.ConnectionUnavailable)),this.emit(ZO.ConnectionUnavailable))}getInfo(){return{moduleName:"Socket"}}}let hP,fP,pP,mP,gP,_P;!function(e){e[e.MAIN=0]="MAIN",e[e.DESKTOP=1]="DESKTOP"}(hP||(hP={})),function(e){e.SEND_RECV="sendrecv",e.SEND_ONLY="sendonly",e.RECV_ONLY="recvonly",e.INACTIVE="inactive"}(fP||(fP={})),function(e){e[e.cmdPayload=99]="cmdPayload"}(pP||(pP={})),function(e){e[e.opusPayload=112]="opusPayload"}(mP||(mP={})),function(e){e[e.rtxPayLoad=107]="rtxPayLoad",e[e.h264PayLoad=122]="h264PayLoad",e[e.redPayLoad=110]="redPayLoad",e[e.ulpfecPayLoad=127]="ulpfecPayLoad"}(gP||(gP={})),function(e){e.H264="H264",e.H265="H265",e.H264H265="H264H265",e.OPUS="opus"}(_P||(_P={}));const SP="signal",vP=5e3;class yP extends jO{constructor(e,t,r){super({emitter:!0,logger:r.logger,stat:r.stat},r.getSymbol()),this.edgeNodeDomains=t,this.socket=new lP(e,t,r),this.onSocketEvent(),this.reset()}on(e,t){super.on(e,t)}off(e,t){super.off(e,t)}reset(){var e;this.traceId="",this.isConnecting=!1,null===(e=this.socket)||void 0===e||e.wsReset()}disconnect(){var e;this.offSocketEvent(),this.reset(),null===(e=this.socket)||void 0===e||e.wsDisconnect(),this.socket=void 0}getConnectionQualityListener(){return e=>{this.emit(hC.NetworkQuality,e)}}getConnectionStateChangedListener(){return e=>{this.emit(hC.ConnectionStateChanged,e)}}getSignatureExpiredListener(){return e=>{this.emit(ZO.SignatureExpired,e)}}getReceiveDataListener(){return e=>{this.receiveMsg(e)}}getSessionUnavailableListener(){return e=>{this.emit(ZO.SessionUnavailable,e)}}getConnectionUnavailableListener(){return e=>{this.emit(ZO.ConnectionUnavailable,e)}}getReconnectedListener(){return e=>{this.emit(ZO.Reconnected,e)}}getAuthenticateFailListener(){return e=>{this.emit(ZO.AuthenticateFail,e)}}getKickedOffListener(){return e=>{this.emit(ZO.ClientBanned,e)}}onSocketEvent(){this.socket&&(this.socket.on(ZO.ConnectionQuality,this.getConnectionQualityListener()),this.socket.on(ZO.ConnectionStateChanged,this.getConnectionStateChangedListener()),this.socket.on(ZO.SignatureExpired,this.getSignatureExpiredListener()),this.socket.on(ZO.ReceiveData,this.getReceiveDataListener()),this.socket.on(ZO.SessionUnavailable,this.getSessionUnavailableListener()),this.socket.on(ZO.ConnectionUnavailable,this.getConnectionUnavailableListener()),this.socket.on(ZO.Reconnected,this.getReconnectedListener()),this.socket.on(ZO.AuthenticateFail,this.getAuthenticateFailListener()),this.socket.on(ZO.ClientBanned,this.getKickedOffListener()))}offSocketEvent(){this.socket&&(this.socket.off(ZO.ConnectionQuality),this.socket.off(ZO.ConnectionStateChanged),this.socket.off(ZO.SignatureExpired),this.socket.off(ZO.ReceiveData),this.socket.off(ZO.SessionUnavailable),this.socket.off(ZO.ConnectionUnavailable),this.socket.off(ZO.Reconnected),this.socket.off(ZO.AuthenticateFail),this.socket.off(ZO.ClientBanned))}getRandomAcsIp(){let e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(1===this.edgeNodeDomains.size||t)return this.selectedAcsIp="default",this.selectedAcsIp;let r=0;return this.selectedAcsIp?(e=[...this.edgeNodeDomains.keys()].filter((e=>"default"!==e&&e!==this.selectedAcsIp)),e.length<1||(r=Math.round(bR.getRandom()*(e.length-1)),this.selectedAcsIp=e[r]),this.selectedAcsIp):(e=[...this.edgeNodeDomains.keys()].filter((e=>"default"!==e)),r=Math.round(bR.getRandom()*(e.length-1)),this.selectedAcsIp=e[r],this.selectedAcsIp)}async connect(e,t){if(this.isConnecting)return this.logger.info(SP,"connect, isConnecting so return"),null;this.traceId=bR.generateStandardUuid(),this.socket.setTraceId(this.traceId);try{this.isConnecting=!0;const r=async r=>await this.connectOnce(e,t,r);return await nO.callWithRetryTimes(r,!1,2,this.getAsyncInterval(),this.needInterrupted())}finally{this.isConnecting=!1}}refreshUserInfo(e){this.socket.refreshUserInfo(e)}needInterrupted(){return e=>"function"==typeof(null==e?void 0:e.getCode)&&e.getCode()===Wc.RTC_ERR_CODE_WEBSOCKET_INTERRUPTED}getAsyncInterval(){return()=>Math.round(500*bR.getRandom()+500)}async connectOnce(e,t,r){const i=this.getRandomAcsIp(yP.isLastTry(2,r));if(!i)throw this.logger.error(SP,"selectedAcsIP is null"),new qc(Wc.RTC_ERR_CODE_WEBSOCKET_NOT_CONNECTED,"no available servers to connect");return await this.socket.wsConnect(e,i,t,0,1e4,0,0),"default"===i?this.edgeNodeDomains.get("default"):i}static isLastTry(e,t){return t===e+1}async join(e,t,r,i,n,o,s,a){return new Promise(((c,u)=>{const d=yP.setJoinRequest(e,t,r,i,n,o,s,a);this.sendRequest(d).then((e=>{var t;0!==e.resultCode?(this.logger.error(SP,"join code:".concat(e.resultCode,",msg:").concat(e.resultMessage)),u(new qc(Number(e.resultCode),e.resultMessage))):(null===(t=e.userInfos)||void 0===t||t.forEach((e=>{MR.addPrivacyString(e.userId),MR.addPrivacyString(e.appData.nickname)})),c(e))})).catch((e=>{u(e)}))}))}async subscribe(e,t,r){const i={type:"SUBS_STREAM",videoUpstreams:e,audioUpstreams:t,videoSubType:1,audioSubType:1,watchType:r,"x-nuwa-trace-id":bR.generateRandomId(32,16),"x-nuwa-span-id":bR.generateRandomId(16,16)},n=await this.sendRequest(i);if(0!==n.resultCode){const e=JSON.stringify(i);throw this.logger.error(SP,"subscribe fail,err_code:".concat(n.resultCode,",")+"error_msg:".concat(n.resultMessage,",request ").concat(e)),new qc(Number(n.resultCode),n.resultMessage)}return this.logger.info(SP,"subscribe send msg result:".concat(n.resultMessage)),n}async queryRoomUsers(e){var t;const r={type:"GET_ROOM_USERINFO","x-nuwa-trace-id":bR.generateRandomId(32,16),"x-nuwa-span-id":bR.generateRandomId(16,16)};null!=e&&e.length&&(r.userIds=e);const i=await this.sendRequest(r);if(0!==i.resultCode)throw this.logger.error(SP,"queryRoomUsers fail,err_code:".concat(i.resultCode,",error_msg:").concat(i.resultMessage)),new qc(Number(i.resultCode),i.resultMessage);return null===(t=i.userInfos)||void 0===t||t.forEach((e=>{MR.addPrivacyString(e.userId),MR.addPrivacyString(e.appData.nickname)})),this.logger.info(SP,"queryRoomUsers send msg result:".concat(i.resultMessage)),i}async leave(){try{const e=await this.sendRequest({type:"EXIT_ROOM"});if(0!==e.resultCode)throw this.logger.error(SP,"leave, exit room, err_code:".concat(e.resultCode,",error_msg:").concat(e.resultMessage)),new qc(Number(e.resultCode),e.resultMessage);const t=await this.sendRequest({type:"BYE"});if(0!==t.resultCode)throw this.logger.error(SP,"leave, exit room, err_code:".concat(t.resultCode,",error_msg:").concat(t.resultMessage)),new qc(Number(t.resultCode),t.resultMessage)}catch(kD){throw new qc(Wc.RTC_ERR_CODE_RTC_SDK_ERROR)}}async changeStreamStatus(e){try{return e.type="CHANGE_STREAM_STATUS",await this.sendRequest(e)}catch(kD){throw this.logger.error(SP,"changeStreamStatus fail, error:".concat(kD)),new qc(Wc.RTC_ERR_CODE_RTC_SDK_ERROR)}}static setJoinRequest(e,t,r,i,n,o,s,a){const c={type:"JOIN_ROOM",sdp:{secCap:"sec3.0",sfuType:nk.getParameter(Xw)||uk.COMMON_SFU_RESOURCE,crypto:{type:1},frameType:nk.getParameter($w)||fC.NON_ENCRYPTION,audios:[{content:iC.main,codecs:[{codec:_P.OPUS,pt:mP.opusPayload,ability:2}],audioLevel:3}],videos:[{content:iC.main,codecs:[{codec:_P.H264,pt:gP.h264PayLoad,ability:2}]},{content:iC.slides,codecs:[{codec:_P.H264,pt:gP.h264PayLoad,ability:2}]}],desktopVideos:[{content:iC.desktop,codecs:[{codec:_P.H264,pt:gP.h264PayLoad,ability:2}]}],audioPolicy:i,bandwidths:n},negSdp:[{type:hP.MAIN,sdp:t},{type:hP.DESKTOP,sdp:r}],scenario:1,relayMode:0,agentType:2,appData:e.appData,mediaData:{portType:o},"x-nuwa-trace-id":bR.generateRandomId(32,16),"x-nuwa-span-id":bR.generateRandomId(16,16)},u=nk.getParameter(Qw);return u&&(c.sdp.resourceTags=u),s&&(c.sdp.command={codecs:[{codec:_P.OPUS,pt:pP.cmdPayload}],content:"cmd=1"}),Object.assign(c.mediaData,a||{}),c}async switchRole(e,t){const r=yP.setSwitchRoleRequest(e,t),i=await this.sendRequest(r);if(0!==i.resultCode)throw this.logger.error(SP,"switch user role fail,err_code:".concat(i.resultCode,",error_msg:").concat(i.resultMessage)),new qc(Number(i.resultCode),i.resultMessage);return i}static setSwitchRoleRequest(e,t){return{type:"SWITCH_ROLE",role:e===WO?qO.JOINER:qO.PLAYER,authorization:t.signature,ctime:parseInt(t.ctime),"x-nuwa-trace-id":bR.generateRandomId(32,16),"x-nuwa-span-id":bR.generateRandomId(16,16)}}async pushStreamResponse(e){this.logger.info(SP,"pushStreamRep send msg start:");try{await this.socket.wsSendResponse(JSON.stringify(e)),this.logger.info(SP,"pushStreamRep send response")}catch(lw){throw this.logger.error(SP,"pushStreamRep send response fail, errMsg = ".concat(lw)),new qc(Wc.RTC_ERR_CODE_PUBLISH_RESPONSE_FAIL)}}keepAlive(){this.logger.info(SP,"keepAlive"),this.socket.startHeartbeat()}async sendRequest(e){return this.assignCommonMsgInfo(e),await this.socket.wsSendRequest(e,vP,vP,2,vP)}assignCommonMsgInfo(e){Object.assign(e,{traceId:this.traceId,requestId:this.socket.generateRequestId(),version:HC,"x-nuwa-trace-id":bR.generateRandomId(32,16),"x-nuwa-span-id":bR.generateRandomId(16,16)})}async publish(e){return new Promise(((t,r)=>{const i=[],n=[];e.forEach((e=>{e.codec===_P.H264?i.push({content:e.content,mute:e.mute,width:e.width,height:e.height,fps:e.fps,maxFs:e.maxFs,maxMbps:e.maxMbps,codec:e.codec,pt:e.pt,streamData:e.streamData,streamUid:e.streamUid,ssrc:e.ssrc,createDate:e.createDate}):e.codec===_P.OPUS&&n.push({content:e.content,mute:e.mute,channels:e.channels,sampleRate:e.sampleRate,maxMbps:e.maxMbps,codec:e.codec,pt:e.pt,streamData:e.streamData,streamUid:e.streamUid,ssrc:e.ssrc,createDate:e.createDate})}));const o={type:"PUSH_STREAM_RES_ALL",pushStreamType:0,videoStreams:i,audioStreams:n,"x-nuwa-trace-id":bR.generateRandomId(32,16),"x-nuwa-span-id":bR.generateRandomId(16,16)};this.sendRequest(o).then((e=>{0!==e.resultCode?(this.logger.error(SP,"publish resp code:".concat(e.resultCode,",msg:").concat(e.resultMessage)),r(new qc(Number(e.resultCode),e.resultMessage))):t(e)})).catch((e=>{r(e)}))}))}async appData(e,t,r){return new Promise(((i,n)=>{const o={};Object.assign(o,e),o[t]=r;const s={type:"APP_DATA",appData:o};this.sendRequest(s).then((e=>{0!==e.resultCode?(this.logger.error(SP,"appset code:".concat(e.resultCode,",msg:").concat(e.resultMessage)),n(new qc(Number(e.resultCode),e.resultMessage))):i(e)})).catch((e=>{n(e)}))}))}async changeAudioPolicy(e){return new Promise(((t,r)=>{const i={type:"AUDIO_POLICY",audioPolicy:e,"x-nuwa-trace-id":bR.generateRandomId(32,16),"x-nuwa-span-id":bR.generateRandomId(16,16)};this.sendRequest(i).then((n=>{if(0!==n.resultCode){const t=JSON.stringify(i);this.logger.error(SP,"change audioPolicy code:".concat(n.resultCode,",audioPolicy:").concat(e,",msg:").concat(n.resultMessage," request ").concat(t)),r(new qc(Number(n.resultCode),n.resultMessage))}else this.logger.info(SP,"change audioPolicy  ".concat(e," success")),t(n)})).catch((t=>{this.logger.info(SP,"change audioPolicy  ".concat(e," exception")),r(t)}))}))}async updateLiveStreaming(e,t,r){return new Promise(((i,n)=>{const o={type:"UPDATE_PUBLISH",traceId:bR.generateStandardUuid(),taskId:e,config:t,userInfos:r,"x-nuwa-trace-id":bR.generateRandomId(32,16),"x-nuwa-span-id":bR.generateRandomId(16,16)};this.sendRequest(o).then((e=>{if(0!==e.resultCode){const t=JSON.stringify(o);this.logger.error(SP,"updateLiveStreaming code:".concat(e.resultCode,", msg:").concat(e.resultMessage,", request ").concat(t)),n(new qc(Number(e.resultCode),e.resultMessage))}else this.logger.info(SP,"updateLiveStreaming success"),i(e)})).catch((e=>{this.logger.info(SP,"updateLiveStreaming failed: ".concat(e)),n(e)}))}))}async startLiveStreaming(e,t,r,i){return new Promise(((n,o)=>{const s={type:"START_PUBLISH",traceId:bR.generateStandardUuid(),taskId:e,config:r,userInfos:i,urls:t,"x-nuwa-trace-id":bR.generateRandomId(32,16),"x-nuwa-span-id":bR.generateRandomId(16,16)};this.sendRequest(s).then((e=>{if(0!==e.resultCode){const t=JSON.stringify(s);this.logger.error(SP,"startLiveStreamRequest code:".concat(e.resultCode,", msg:").concat(e.resultMessage,", request ").concat(t)),o(new qc(Number(e.resultCode),e.resultMessage))}else this.logger.info(SP,"startLiveStreamRequest success"),n(e)})).catch((e=>{this.logger.info(SP,"startLiveStreamRequest failed: ".concat(e)),o(e)}))}))}async stopLiveStreaming(e){return new Promise(((t,r)=>{const i={type:"STOP_PUBLISH",traceId:bR.generateStandardUuid(),taskId:e,"x-nuwa-trace-id":bR.generateRandomId(32,16),"x-nuwa-span-id":bR.generateRandomId(16,16)};this.sendRequest(i).then((e=>{if(0!==e.resultCode){const t=JSON.stringify(i);this.logger.error(SP,"stopLiveStreaming code:".concat(e.resultCode,", msg:").concat(e.resultMessage,", request ").concat(t)),r(new qc(Number(e.resultCode),e.resultMessage))}else this.logger.info(SP,"stopLiveStreaming success"),t(e)})).catch((e=>{this.logger.info(SP,"stopLiveStreaming failed: ".concat(e)),r(e)}))}))}receiveMsg(e){if(e.type)switch(tC.has("".concat(e.type))||this.logger.info(SP,"message type: ".concat(e.type)),e.type){case rC.statusChangeNotify:var t;null===(t=e.infos)||void 0===t||t.forEach((e=>{MR.addPrivacyString(e.userId),MR.addPrivacyString(e.appData.nickname)})),this.emit(rC.statusChangeNotify,e);break;case rC.uploadLogNotify:this.emit(rC.uploadLogNotify,e);break;case rC.pushStreamNotify:{const t=e;MR.addPrivacyString(t.userId),this.emit(rC.pushStreamNotify,e);break}case rC.stopPushStreamNotify:{const t=e;MR.addPrivacyString(t.userId),this.emit(rC.stopPushStreamNotify,e);break}case rC.watchStreamNotify:this.emit(rC.watchStreamNotify,e);break;case rC.changeStreamStatusNotify:{const t=e;MR.addPrivacyString(t.userId),this.emit(rC.changeStreamStatusNotify,e);break}case rC.disconnectNotify:{const t=e;MR.addPrivacyString(t.userId),this.emit(rC.disconnectNotify,e);break}case rC.reconnectNotify:{const t=e;MR.addPrivacyString(t.userId),this.emit(rC.reconnectNotify,e);break}case rC.configNotify:this.emit(rC.configNotify,e);break;case rC.appDataChangeNotify:{const t=e;MR.addPrivacyString(t.userId),this.emit(rC.appDataChangeNotify,e);break}case rC.top3AudioVolumeNotify:var r;null===(r=e.topUserAudios)||void 0===r||r.forEach((e=>{MR.addPrivacyString(e.userId)})),this.emit(rC.top3AudioVolumeNotify,e);break;case rC.publishStatusNotify:this.emit(rC.publishStatusNotify,e);break;case rC.roomStreamStatusNotify:this.emit(rC.roomStreamStatusNotify,e);break;default:this.logger.error(SP,"unknown message type ".concat(e.type))}else this.logger.error(SP,"unknown message:".concat(e))}setConfigParams(e){this.socket.setKeepAliveParams(e)}getInfo(){return{traceId:this.traceId}}mediaRelay(e,t,r){return new Promise(((i,n)=>{var o,s,a;const c={type:"ROOM_MEDIA_RELAY",srcRoomToken:{roomId:r.roomId,userId:(null===(o=e.srcRoomRelayInfo)||void 0===o?void 0:o.userId)||"0",role:0===r.role?qO.JOINER:qO.PLAYER,ctime:null===(s=e.srcRoomRelayInfo)||void 0===s?void 0:s.ctime,token:null===(a=e.srcRoomRelayInfo)||void 0===a?void 0:a.authorization}};c[t?"addDstRoomInfo":"removeDstRoomInfo"]=e.dstRoomRelayInfo.map((e=>({roomId:e.roomId,userId:r.userId,role:0===e.role?qO.JOINER:qO.PLAYER,ctime:e.ctime,token:e.authorization}))),this.sendRequest(c).then((e=>{0!==e.resultCode?n(new qc(Number(e.resultCode),e.resultMessage)):(this.logger.info(SP,"mediaRelay success"),i(e))})).catch((e=>{this.logger.info(SP,"mediaRelay failed: ".concat(e)),n(e)}))}))}}class IP{constructor(){this.audioStreams=new Map,this.logger=MR.getLogger()}getAudioStreams(){return[...this.audioStreams.values()]}getAudioStream(e){return this.audioStreams.get(e)}addAudioStream(e,t){const r={audioPlayer:null,audioMediaTrack:null,streamId:e,ssrc:t,playStatus:"init"};this.audioStreams.set(e,r)}updateAudioStream(e,t){const r=this.audioStreams.get(e);r.audioMediaTrack=t,r.audioPlayer=new Vk({logger:this.logger,playerId:e,track:t})}getAudioLevel(){const e=[];for(const r of this.audioStreams.values()){var t;e.push({streamId:r.streamId,ssrc:r.ssrc,level:null===(t=r.audioPlayer)||void 0===t?void 0:t.getAudioLevel()})}return e}async setAudioOutput(e){if("sinkId"in HTMLMediaElement.prototype&&e)for(const t of this.audioStreams.values())await t.audioPlayer.setSinkId(e)}setAudioVolume(e){const t=e/100;for(const i of this.audioStreams.values()){var r;if("notAllow"===i.playStatus)this.resume(i.streamId).then((()=>{var e;null===(e=i.audioPlayer)||void 0===e||e.setVolume(t)}));else null===(r=i.audioPlayer)||void 0===r||r.setVolume(t)}}muteAudio(e){for(const t of this.audioStreams.values())e||"notAllow"!==t.playStatus?t.audioMediaTrack.enabled=!e:this.resume(t.streamId).then((()=>{t.audioMediaTrack.enabled=!e}))}isAudioMuted(){const e=Array.from(this.audioStreams.values());return!e.every((e=>"normal"===e.playStatus))||!e.every((e=>e.audioMediaTrack.enabled))}async play(e){for(const i of this.audioStreams.values())try{var t;if(e){if(i.streamId===e){var r;await(null===(r=i.audioPlayer)||void 0===r?void 0:r.play()),i.playStatus="normal";break}}else await(null===(t=i.audioPlayer)||void 0===t?void 0:t.play()),i.playStatus="normal"}catch(kD){this.logger.error("RemoteTopNAudioStreams","resume failed, error: ".concat(kD)),i.playStatus="notAllow"}}async resume(e){for(const i of this.audioStreams.values())try{var t;if(e){if(i.streamId===e){var r;await(null===(r=i.audioPlayer)||void 0===r?void 0:r.resume()),i.playStatus="normal";break}}else await(null===(t=i.audioPlayer)||void 0===t?void 0:t.resume()),i.playStatus="normal"}catch(kD){this.logger.error("RemoteTopNAudioStreams","resume failed, error: ".concat(kD)),i.playStatus="notAllow"}}setAudioVolume4Id(e,t){for(const r of this.audioStreams.values())if(r.streamId===e&&r.audioPlayer){"notAllow"===r.playStatus?this.resume(e).then((()=>{r.audioPlayer.setVolume(t/100)})):r.audioPlayer.setVolume(t/100);break}}close(e){if(e&&this.audioStreams.has(e)){const t=this.audioStreams.get(e);return t.audioPlayer.stop(),t.audioMediaTrack=null,t.audioPlayer=null,t.playStatus="init",void this.audioStreams.delete(e)}for(const t of this.audioStreams.values())t.audioPlayer.stop(),t.audioMediaTrack=null,t.audioPlayer=null,t.playStatus="init";this.audioStreams.clear()}}const TP="LocalStreamPublishManager";class RP{constructor(){this.logger=MR.getLogger(),this.localStreams=new Map,this.sdpRepInfo=null}reset(){Array.from(this.localStreams.values()).forEach((e=>{e.localTrackPublishInfos.clear()})),this.logger.info(TP,"reset successfully")}getStreamTrackInfo(e){const t=[];let r;return e.getHRTCTracks({hasTrack:!0}).forEach((i=>{const n=i.getTrackProfile();if(i.getTrackType()===ok.TRACK_TYPE_AUDIO)i.setTrackId(this.sdpRepInfo.audio.streamCodecs[0].streamUid.toString()),r={type:ok.TRACK_TYPE_AUDIO,resolutionId:i.getResolutionId(),upstream:{content:iC.main,mute:i.getTrackMuted(),maxMbps:Math.round((n.bitrate||0)/1e3),sampleRate:n.sampleRate,channels:n.channelCount,codec:_P.OPUS,pt:mP.opusPayload,streamUid:this.sdpRepInfo.audio.streamCodecs[0].streamUid,ssrc:this.sdpRepInfo.audio.sendSsrcBegin}};else{let t;if(e.isAuxiliary())i.setTrackId(this.sdpRepInfo.desktopVideo.streamCodecs[0].streamUid.toString()),t={content:iC.desktop,mute:i.getTrackMuted(),width:n.width,height:n.height,fps:n.frameRate,maxMbps:Math.round((n.maxBitrate||0)/1e3),maxFs:n.frameRate,codec:_P.H264,pt:gP.h264PayLoad,streamUid:this.sdpRepInfo.desktopVideo.streamCodecs[0].streamUid,ssrc:this.sdpRepInfo.desktopVideo.sendSsrcBegin};else{const e=i.getTrackContentType(),r=this.sdpRepInfo.video.streamCodecs.find((t=>t.content===e)).streamUid;i.setTrackId(r.toString()),t={content:e,mute:i.getTrackMuted(),width:n.width,height:n.height,fps:n.frameRate,maxMbps:Math.round((n.maxBitrate||0)/1e3),maxFs:n.frameRate,codec:_P.H264,pt:gP.h264PayLoad,streamUid:r,ssrc:e===iC.main?this.sdpRepInfo.video.sendSsrcBegin:this.sdpRepInfo.video.sendSsrcEnd}}r={type:ok.TRACK_TYPE_VIDEO,resolutionId:i.getResolutionId(),upstream:t}}t.push(r)})),this.logger.debug(TP,"getStreamTrackInfo, get trackInfos: ".concat(JSON.stringify(t))),t}getLocalStream(e){const t=this.localStreams.get(e);return t?t.localStream:null}generatePubInfoWhenPublish(e,t){const r={allTracks2Publish:[],tracks2NewPublish:[],tracks2KeepPublish:[],tracks2UnPublish:[]},i=e.isAuxiliary()?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN,n=this.localStreams.get(i);return n&&0!==n.localTrackPublishInfos.size?this.isSameStreamId(e)?this.updateStream(e,r):this.replaceStream(e,r):this.addStream(e,r,t),this.buildAll2PublishTrackInfo(r.allTracks2Publish,e.isAuxiliary(),!0),this.logger.info(TP,"generatePubInfoWhenPublish tracks2Update input: ".concat(JSON.stringify(r))),r}setSdpRepInfo(e){this.sdpRepInfo=e}buildAll2PublishTrackInfo(e,t,r){t?(this.buildMediaPubInfo(e,ok.TRACK_TYPE_VIDEO,sk.STREAM_TYPE_MAIN),this.buildMediaPubInfo(e,ok.TRACK_TYPE_AUDIO,sk.STREAM_TYPE_MAIN),r&&this.buildMediaPubInfo(e,ok.TRACK_TYPE_VIDEO,sk.STREAM_TYPE_AUX)):(this.buildMediaPubInfo(e,ok.TRACK_TYPE_VIDEO,sk.STREAM_TYPE_AUX),r&&(this.buildMediaPubInfo(e,ok.TRACK_TYPE_VIDEO,sk.STREAM_TYPE_MAIN),this.buildMediaPubInfo(e,ok.TRACK_TYPE_AUDIO,sk.STREAM_TYPE_MAIN)))}buildMediaPubInfo(e,t,r){var i;const n=null===(i=this.localStreams.get(r))||void 0===i?void 0:i.localTrackPublishInfos;n&&Array.from(n.values()).filter((e=>e.type===t)).forEach((t=>{t.sender&&(t.upstream.mute=!t.sender.track.enabled),e.push(t)}))}isSameStreamId(e){const t=e.isAuxiliary()?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN;return this.localStreams.get(t).streamId===e.getLocalId()}static getString4TrackPublishInfos(e){let t;for(const r of e.entries())t="".concat(t||""," resolutionId: ").concat(r[0],", track type: ").concat(r[1].type,"ï¼ watched: ").concat(r[1].watched,", published: ").concat(r[1].published);return t}updateStream(e,t){this.logger.info(TP,"updateStream, update stream begin");const r=[],i=e.isAuxiliary()?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN,n=this.getStreamTrackInfo(e),o=this.localStreams.get(i);n.forEach((e=>{const n=o.localTrackPublishInfos.get(e.resolutionId);r.push(e),n?(n.upstream.mute=e.upstream.mute,n.published&&t.tracks2KeepPublish.push(n),n.watched&&!n.published&&t.tracks2NewPublish.push(n)):this.addTrack(i,e,t,o)}));const s=[];Array.from(o.localTrackPublishInfos.values()).forEach((e=>{const i=r.find((t=>t.resolutionId===e.resolutionId));if(i){if(!RP.isSameResolution(i,e)){const t={type:i.type,resolutionId:i.resolutionId,upstream:i.upstream,published:e.published,watched:e.watched,ssrc:e.ssrc,sender:e.sender};o.localTrackPublishInfos.set(i.resolutionId,t)}}else e.published&&t.tracks2UnPublish.push(e),s.push(e.resolutionId)})),s.forEach((e=>{o.localTrackPublishInfos.delete(e)})),this.logger.info(TP,"updateStream, update stream ".concat(e.getLocalId()," successfully\n    ").concat(RP.getString4TrackPublishInfos(o.localTrackPublishInfos)))}static isSameResolution(e,t){return e.upstream.height===t.upstream.height&&e.upstream.width===t.upstream.width}replaceStream(e,t){return this.logger.info(TP,"replaceStream begin"),this.addStream(e,t)}addStream(e,t,r){const i=e.isAuxiliary()?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN,n=this.getStreamTrackInfo(e),o={localStream:e,streamId:e.getLocalId(),localTrackPublishInfos:new Map};n.forEach((e=>{this.addTrack(i,e,t,o,r)})),this.localStreams.set(i,o),this.logger.info(TP,"addStream, add stream ".concat(e.getLocalId()," successfully ,\n    ").concat(RP.getString4TrackPublishInfos(o.localTrackPublishInfos)))}generatePubInfoWhenUnPublish(e){const t=e.isAuxiliary()?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN,r={allTracks2Publish:[],tracks2KeepPublish:[],tracks2NewPublish:[],tracks2UnPublish:[]},i=this.localStreams.get(t);return i?(Array.from(i.localTrackPublishInfos.values()).filter((e=>e.published)).forEach((e=>{r.tracks2UnPublish.push(e)})),this.buildAll2PublishTrackInfo(r.allTracks2Publish,e.isAuxiliary(),!1),r):(this.logger.warn(TP,"stream not publish"),r.allTracks2Publish=null,r)}removeStream(e){const t=e.isAuxiliary()?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN;if(!this.localStreams.has(t))throw this.logger.error(TP,"removeStream, stream not exist"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);this.localStreams.delete(t)}generatePubInfoWhenWatch(e,t,r){if(this.logger.info(TP,"generatePubInfoWhenWatch watch ".concat(e," streams")),!t||!r)return null;const i={allTracks2Publish:null,tracks2KeepPublish:[],tracks2NewPublish:[],tracks2UnPublish:[]},n=this.localStreams.get(e);if(!n)return this.logger.warn(TP,"generatePubInfoWhenWatch, stream not exist"),null;const o=Array.from(n.localTrackPublishInfos.values());return 0===t.length&&0===r.length&&o.forEach((e=>{this.renewTrack2Update(!1,e,i)})),o.forEach((e=>{if(t.length>0&&e.type===ok.TRACK_TYPE_VIDEO){const r=t.find((t=>t===e.upstream.ssrc));this.renewTrack2Update(!!r,e,i)}if(r.length>0&&e.type===ok.TRACK_TYPE_AUDIO){const t=r.find((t=>t===e.upstream.ssrc));this.renewTrack2Update(!!t,e,i)}})),t.forEach((e=>{o.some((t=>e===t.upstream.ssrc))||this.logger.error(TP,"generatePubInfoWhenWatch, watch video ssrc:".concat(e," is not exist"))})),r.forEach((e=>{o.some((t=>e===t.upstream.ssrc))||this.logger.error(TP,"generatePubInfoWhenWatch, watch audio ssrc:".concat(e," is not exist"))})),i}renewTrack2Update(e,t,r){e?t.published?(r.tracks2KeepPublish.push(t),this.logger.info(TP,"generatePubInfoWhenWatch, keep ".concat(t.type," ssrc:").concat(t.ssrc))):(t.watched=!0,r.tracks2NewPublish.push(t),this.logger.info(TP,"generatePubInfoWhenWatch, new publish ".concat(t.type," ssrc:").concat(t.ssrc))):t.published&&(t.watched=!1,r.tracks2UnPublish.push(t),this.logger.info(TP,"generatePubInfoWhenWatch, new unpublish ".concat(t.type," ssrc:").concat(t.ssrc)))}addTrack(e,t,r,i,n){const o=RP.getDefaultWatchFlag(e,t.type,n),s={type:t.type,resolutionId:t.resolutionId,published:!1,watched:o,upstream:t.upstream,ssrc:t.upstream.ssrc,sender:null};s.watched&&r.tracks2NewPublish.push(s),i.localTrackPublishInfos.set(t.resolutionId,s),this.logger.info(TP,"addTrack, add track for resolutionId ".concat(t.resolutionId," successfully"))}static getDefaultWatchFlag(e,t,r){return e===sk.STREAM_TYPE_MAIN&&t===ok.TRACK_TYPE_AUDIO||(null==r?void 0:r.autoPushVideo)&&t===ok.TRACK_TYPE_VIDEO}publishAuxVideoTrackOK(e,t){this.publishTrackSuccess(sk.STREAM_TYPE_AUX,ok.TRACK_TYPE_VIDEO,e,t)}publishMainVideoTrackOK(e,t,r){this.publishTrackSuccess(sk.STREAM_TYPE_MAIN,ok.TRACK_TYPE_VIDEO,e,t,r)}publishMainAudioTrackOK(e,t){this.publishTrackSuccess(sk.STREAM_TYPE_MAIN,ok.TRACK_TYPE_AUDIO,e,t)}publishTrackSuccess(e,t,r,i,n){const o=this.localStreams.get(e);if(!o)throw this.logger.error(TP,"stream is empty"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);const s=this.getTrackInfo(o,t,n);if(!s)throw this.logger.error(TP,"getTrackInfo return empty"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);s.published&&this.logger.info(TP,"stream already published"),s.published=!0,s.sender=r,this.logger.info(TP,"publish track for trackId: ".concat(n," successfully"))}unPublishTrackSuccess(e,t,r){const i=this.localStreams.get(e);if(!i)throw this.logger.error(TP,"stream is empty"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);if(t===ok.TRACK_TYPE_VIDEO&&!r)throw this.logger.error(TP,"video trackId is empty"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);const n=this.getTrackInfo(i,t,r);n?(n.published||this.logger.info(TP,"stream already unPublished"),n.published=!1,n.sender=null,this.logger.info(TP,"unPublish track for trackId: ".concat(r," successfully"))):this.logger.info(TP,"getTrackInfo return empty")}getMainStreamVideoPublishInfo(){return this.getTrackPublishInfos(sk.STREAM_TYPE_MAIN,ok.TRACK_TYPE_VIDEO)}getPublishedMainVideoTrackInfo(e){const t=this.getTrackPublishInfo(sk.STREAM_TYPE_MAIN,ok.TRACK_TYPE_VIDEO,e);return null!=t&&t.published&&t.sender?t:null}getPublishedMainAudioTrackInfo(){const e=this.getTrackPublishInfo(sk.STREAM_TYPE_MAIN,ok.TRACK_TYPE_AUDIO);return null!=e&&e.published&&e.sender?e:null}getPublishedAuxVideoTrackInfo(){const e=this.getTrackPublishInfo(sk.STREAM_TYPE_AUX,ok.TRACK_TYPE_VIDEO);return null!=e&&e.published&&e.sender?e:null}getPublishedMainVideoTrackInfos(){const e=this.getTrackPublishInfos(sk.STREAM_TYPE_MAIN,ok.TRACK_TYPE_VIDEO);return(null==e?void 0:e.length)>0?e.filter((e=>e.published&&e.sender)):null}getPublishedMainStreamInfos(){const e=this.getTrackPublishInfos(sk.STREAM_TYPE_MAIN);return(null==e?void 0:e.length)>0?e.filter((e=>e.published&&e.sender)):null}getPublishedAuxStreamInfo(){const e=this.localStreams.get(sk.STREAM_TYPE_AUX);if(!e)return null;return Array.from(e.localTrackPublishInfos.values()).find((e=>e.published&&e.sender))?e:null}getTrackPublishInfos(e,t){const r=this.localStreams.get(e);return r?t?Array.from(r.localTrackPublishInfos.values()).filter((e=>e.type===t)):Array.from(r.localTrackPublishInfos.values()):(this.logger.info(TP,"getTrackPublishInfos, not found"),null)}getTrackPublishInfo(e,t,r){const i=this.localStreams.get(e);return i?this.getTrackInfo(i,t,r):null}isAuxVideoTrackPublished(){const e=this.isTrackPublished(sk.STREAM_TYPE_AUX,ok.TRACK_TYPE_VIDEO);return this.logger.info(TP,"isAuxVideoTrackPublished: ".concat(e)),e}isMainStreamPublished(){const e=this.isTrackPublished(sk.STREAM_TYPE_MAIN,ok.TRACK_TYPE_VIDEO)||this.isTrackPublished(sk.STREAM_TYPE_MAIN,ok.TRACK_TYPE_AUDIO);return this.logger.info(TP,"isMainVideoTrackPublished: ".concat(e)),e}isTrackPublished(e,t,r){const i=this.localStreams.get(e);if(!i)return this.logger.info(TP,"isTrackPublished, not found"),!1;const n=this.getTrackInfo(i,t,r);return n?n.published&&!!n.sender:(this.logger.info(TP,"isTrackPublished, not found"),!1)}getTrackInfo(e,t,r){if(!e||0===e.localTrackPublishInfos.size)return null;if(t===ok.TRACK_TYPE_AUDIO)return Array.from(e.localTrackPublishInfos.values()).find((e=>e.type===ok.TRACK_TYPE_AUDIO));if(r)return Array.from(e.localTrackPublishInfos.values()).find((e=>e.type===ok.TRACK_TYPE_VIDEO&&e.upstream.streamUid.toString()===r));const i=RP.getMaxResolutionId(e);return i?e.localTrackPublishInfos.get(i):null}static getMaxResolutionId(e){var t,r;return null==e||null===(t=e.localStream)||void 0===t||null===(r=t.getMaxResolutionHRTCTrack())||void 0===r?void 0:r.getResolutionId()}unPublishAuxStreamOK(){this.unPublishStreamSuccess(sk.STREAM_TYPE_AUX)}unPublishMainStreamOK(){this.unPublishStreamSuccess(sk.STREAM_TYPE_MAIN)}unPublishStreamSuccess(e){var t;const r=this.localStreams.get(e);r?(null===(t=r.localStream)||void 0===t||t.getHRTCTracks({hasTrack:!0,mediaType:ok.TRACK_TYPE_VIDEO}).forEach((e=>e&&e.setTrackId(""))),this.removeStream(r.localStream),this.logger.info(TP,"unPublishStreamSuccess, ".concat(e))):this.logger.warn(TP,"stream not publish")}isAuxVideoTrackValid(e){return this.isTrackValid(sk.STREAM_TYPE_AUX,ok.TRACK_TYPE_VIDEO,e)}isTrackValid(e,t,r){const i=this.localStreams.get(e);return i?Array.from(i.localTrackPublishInfos.values()).some((e=>e.type===t&&e.upstream.streamUid.toString()===r)):(this.logger.info(TP,"isTrackValid, not found"),!1)}generateOptTags(e,t){const r=[],i=this.localStreams.get(e);if(!i)return r;return Array.from(i.localTrackPublishInfos.values()).filter((e=>e.type===t&&e.published&&e.sender)).forEach((e=>{if(t===ok.TRACK_TYPE_VIDEO){const t=e.upstream?e.upstream.height:0,i=e.upstream?e.upstream.width:0,n="".concat(e.ssrc,":").concat(t,"*").concat(i);r.push(n)}else{var n;const t=null===(n=i.localStream.getAudioHRTCTrack())||void 0===n?void 0:n.getTrackProfile(),o="".concat(e.ssrc,":").concat(t?t.sampleRate:0);r.push(o)}})),r}generateMainAudioOptTag(){const e=this.generateOptTags(sk.STREAM_TYPE_MAIN,ok.TRACK_TYPE_AUDIO);return e.length>0?e[0]:null}generateAuxOptTag(){const e=this.generateOptTags(sk.STREAM_TYPE_AUX,ok.TRACK_TYPE_VIDEO);return e.length>0?e[0]:null}generateMainVideoOptTags(){const e=this.generateOptTags(sk.STREAM_TYPE_MAIN,ok.TRACK_TYPE_VIDEO);return e.length>0?e:null}}var EP={},bP={exports:{}},CP=bP.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(CP).forEach((function(e){CP[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))})),function(e){var t=function(e){return String(Number(e))===e?Number(e):e},r=function(e,r,i){var n=e.name&&e.names;e.push&&!r[e.push]?r[e.push]=[]:n&&!r[e.name]&&(r[e.name]={});var o=e.push?{}:n?r[e.name]:r;!function(e,r,i,n){if(n&&!i)r[n]=t(e[1]);else for(var o=0;o<i.length;o+=1)null!=e[o+1]&&(r[i[o]]=t(e[o+1]))}(i.match(e.reg),o,e.names,e.name),e.push&&r[e.push].push(o)},i=bP.exports,n=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},o=[],s=t;return e.split(/(\r\n|\r|\n)/).filter(n).forEach((function(e){var t=e[0],n=e.slice(2);"m"===t&&(o.push({rtp:[],fmtp:[]}),s=o[o.length-1]);for(var a=0;a<(i[t]||[]).length;a+=1){var c=i[t][a];if(c.reg.test(n))return r(c,s,n)}})),t.media=o,t};var o=function(e,r){var i=r.split(/=(.+)/,2);return 2===i.length?e[i[0]]=t(i[1]):1===i.length&&r.length>1&&(e[i[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(o,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var r=[],i=e.split(" ").map(t),n=0;n<i.length;n+=3)r.push({component:i[n],ip:i[n+1],port:i[n+2]});return r},e.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(o,{})}))},e.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var r,i=!1;return"~"!==e[0]?r=t(e):(r=t(e.substring(1,e.length)),i=!0),{scid:r,paused:i}}))}))}}(EP);var AP=bP.exports,wP=/%[sdv%]/g,kP=function(e){var t=1,r=arguments,i=r.length;return e.replace(wP,(function(e){if(t>=i)return e;var n=r[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}}))},OP=function(e,t,r){var i=[e+"="+(t.format instanceof Function?t.format(t.push?r:r[t.name]):t.format)];if(t.names)for(var n=0;n<t.names.length;n+=1){var o=t.names[n];t.name?i.push(r[t.name][o]):i.push(r[t.names[n]])}else i.push(r[t.name]);return kP.apply(null,i)},PP=["v","o","s","i","u","e","p","c","b","t","r","z","a"],MP=["i","c","b","a"],DP=EP,NP=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var r=t.outerOrder||PP,i=t.innerOrder||MP,n=[];return r.forEach((function(t){AP[t].forEach((function(r){r.name in e&&null!=e[r.name]?n.push(OP(t,r,e)):r.push in e&&null!=e[r.push]&&e[r.push].forEach((function(e){n.push(OP(t,r,e))}))}))})),e.media.forEach((function(e){n.push(OP("m",AP.m[0],e)),i.forEach((function(t){AP[t].forEach((function(r){r.name in e&&null!=e[r.name]?n.push(OP(t,r,e)):r.push in e&&null!=e[r.push]&&e[r.push].forEach((function(e){n.push(OP(t,r,e))}))}))}))})),n.join("\r\n")+"\r\n"},UP=NP,xP=DP.parse,LP=DP.parseParams;const BP="packetization-mode",VP="profile-level-id",YP=["groups","media"],jP=["candidates","connection","direction","mid","payloads","port","protocol","rtp","type","fmtp","ssrcs"];class FP{constructor(e){t(this,"module_","sdp"),t(this,"ssrcAttrCname_","cname"),t(this,"ssrcAttrMslabel_","mslabel"),t(this,"ssrcAttrLabel_","label"),t(this,"ssrcAttrMsid_","msid"),t(this,"validateIp",(e=>/^((\d|[1-9]\d|1\d\d|2([0-4]\d|5[0-5]))(\.|$)){4}$/.test(e))),this.logger_=e}setPortType(e){this.portType_=e}parseSdp(e){if(!e)return void this.logger_.error(this.module_,"parseSdp failed : sdp  is null ");const t=xP(e);if(0!==t.media.length)return t;this.logger_.error(this.module_,"parseSdp failed : the media of sdp is null ")}printSdpInfo(e){const t=this.parseSdp(e);if(t){for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&(YP.includes(e)||delete t[e],"media"===e&&t[e].forEach((e=>{for(const t in e)jP.includes(t)||delete e[t]})));return bR.shieldIpAddress(UP(t))}}getMedias(e,t){return e.media.filter((e=>{let{type:r}=e;return r===t}))}deleteUnexpectedMedia(e){e.media&&(e.media=e.media.filter((e=>{let{type:t}=e;return t===ok.TRACK_TYPE_VIDEO||t===ok.TRACK_TYPE_AUDIO||t===ok.TYPE_APPLICATION})),this.portType_===lC.portNormal&&e.groups&&(e.groups=e.groups.filter((e=>{let{type:t}=e;return"BUNDLE"!==t.toLocaleUpperCase()}))))}transformVideoPayload(e){if(!e.rtp)return void this.logger_.warn(this.module_,"transformVideoPayload failed ,rtp is null");let t=null,r=null,i=0;for(const n of e.rtp){if(n.codec.toUpperCase()!==_P.H264)continue;r||(r=n.payload,this.logger_.info(this.module_,"record firstPayload, firstPayload: ".concat(r)));const o=FP.getPacketizationMode(e.fmtp,n.payload),s=FP.getProfileLevelId(e.fmtp,n.payload);if(1===o&&(0===i&&(r=n.payload,i=1),"42e01f"===s)){t=n.payload,this.logger_.info(this.module_,"set retainPayload in transformVideoPayload, retainPayload: ".concat(t));break}}t||(t=r,this.logger_.info(this.module_,"no expected payload, use firstPayload as retainPayload, retainPayload: ".concat(t))),t?(FP.deletePayload(e,t),FP.modifyPayload(e,gP.h264PayLoad),FP.addVideoFec(e),FP.addFmtpAttr(e,gP.h264PayLoad,"max-br","5000000"),FP.addFmtpAttr(e,gP.rtxPayLoad,"apt","".concat(gP.h264PayLoad))):this.logger_.error(this.module_,"transformVideoPayload failed,can not find expected payload.")}transformAudioPayload(e){if(!e.rtp)return void this.logger_.warn(this.module_,"transformAudioPayload failed, rtp is null");let t;for(const r of e.rtp)if(r.codec.toLowerCase()===_P.OPUS){t=r.payload;break}t?(FP.deletePayload(e,t),FP.modifyPayload(e,mP.opusPayload),FP.addNack(e)):this.logger_.error(this.module_,"transformAudioPayload failed,can not find expected payload.")}deleteRetransmissionSsrc(e){if(!e.ssrcGroups||!e.ssrcs)return;const t=[];e.ssrcGroups.forEach((e=>{let{ssrcs:r}=e;const i=this.getRetransmissionSsrc(r);null!=i&&t.push(i)})),0!==t.length&&(e.ssrcGroups=void 0,e.ssrcs=e.ssrcs.filter((e=>{let{id:r}=e;return!t.includes(r.toString())})))}addVideoSsrcRange(e,t){!t||t.length<1||(e.invalid||(e.invalid=[]),e.invalid.push({value:"send-ssrc-list:".concat(t.join(","))}))}static addAudioSsrcRange(e,t,r){if(t)if(e.invalid||(e.invalid=[]),r){const r=bR.getRandomUint32();e.invalid.push({value:"send-ssrc-list:".concat(t,",").concat(r)})}else e.invalid.push({value:"send-ssrc-list:".concat(t)})}modifyCandidate(e,t){if(this.validateIp(e.connection.ip)&&"0.0.0.0"!==e.connection.ip||(e.connection.ip="127.0.0.1"),!e.candidates){const r=null==t?void 0:t.find((t=>"".concat(e.mid)==="".concat(t.sdpMid)));if(r){const t=/.*generation\s(\d+).*/.exec(r.candidate)||[],i=/.*network\-id\s(\d+).*/.exec(r.candidate)||[],n=/.*network\-cost\s(\d+).*/.exec(r.candidate)||[];e.candidates=e.candidates||[],e.candidates.push({foundation:r.foundation,component:"rtp"===r.component?1:2,transport:r.protocol,priority:r.priority,ip:r.address,port:r.port,type:r.type,raddr:r.relatedAddress,rport:r.relatedPort,tcptype:r.tcpType,generation:2===t.length?parseInt(t[1]):void 0,"network-id":2===i.length?parseInt(i[1]):void 0,"network-cost":2===n.length?parseInt(n[1]):void 0})}}if(e.candidates)for(let r=0;r<e.candidates.length;r++)this.validateIp(e.candidates[r].ip)&&"0.0.0.0"!==e.candidates[r].ip||(e.candidates[r].ip="127.0.0.1")}static getPacketizationMode(e,t){if(!e)return 1;for(const r of e){if(r.payload!==t)continue;if(!r.config.includes(BP))return 1;const e=LP(r.config);return null==e["packetization-mode"]?1:parseInt(String(e["packetization-mode"]),10)}return 1}static getProfileLevelId(e,t){if(!e)return"";for(const r of e){if(r.payload!==t)continue;if(!r.config.includes(VP))return"";const e=LP(r.config);return e["profile-level-id"]?String(e["profile-level-id"]):""}return""}static deletePayload(e,t){e.rtp&&(e.rtp=e.rtp.filter((e=>{let{payload:r}=e;return r===t}))),e.rtcpFb&&(e.rtcpFb=e.rtcpFb.filter((e=>{let{payload:r}=e;return r===t}))),e.fmtp&&(e.fmtp=e.fmtp.filter((e=>{let{payload:r}=e;return r===t}))),e.payloads=t.toString()}static modifyPayload(e,t){e.rtp&&e.rtp.forEach((e=>{e.payload=t})),e.rtcpFb&&e.rtcpFb.forEach((e=>{e.payload=t})),e.fmtp&&e.fmtp.forEach((r=>{r.payload=t,e.type===ok.TRACK_TYPE_AUDIO&&/stereo/.test(r.config)&&(r.config=r.config.replace("stereo=1","stereo=0"))})),e.payloads=t.toString()}static addVideoFec(e){e.rtp||(e.rtp=[]),e.rtp.push({payload:gP.rtxPayLoad,codec:"rtx",rate:9e4}),e.rtp.push({payload:gP.redPayLoad,codec:"red",rate:9e4}),e.rtp.push({payload:gP.ulpfecPayLoad,codec:"ulpfec",rate:9e4}),e.payloads="".concat(gP.rtxPayLoad," ").concat(e.payloads," ").concat(gP.redPayLoad," ").concat(gP.ulpfecPayLoad)}static addFmtpAttr(e,t,r,i){if(!e.fmtp||0===e.fmtp.length)return e.fmtp=[],void e.fmtp.push({payload:t,config:r+"="+i});const n=e.fmtp.find((e=>e.payload===t));if(n){if(LP(n.config)[r])return;n.config=n.config+";"+r+"="+i}else e.fmtp.push({payload:t,config:r+"="+i})}static addNack(e){const t=e.rtp[0].payload;e.rtcpFb||(e.rtcpFb=[]),e.rtcpFb.push({payload:t,type:"ccm",subtype:"fir"}),e.rtcpFb.push({payload:t,type:"nack"}),e.rtcpFb.push({payload:t,type:"nack",subtype:"pli"})}getRetransmissionSsrc(e){if(!e)return void this.logger_.warn(this.module_,"getRetransmissionSsrc failed, ssrcs is null");const t=e.split(" ");if(2===t.length)return t[1];this.logger_.warn(this.module_,"getRetransmissionSsrc failed, ssrcs(".concat(e,") is invalid"))}static generateSsrcLabel(){return"".concat(bR.generateRandomId(8,36),"-").concat(bR.generateRandomId(4,36),"-").concat(bR.generateRandomId(4,36),"-").concat(bR.generateRandomId(4,36),"-").concat(bR.generateRandomId(12,36))}static addSsrcAttr(e,t,r){e.ssrcs||(e.ssrcs=[]);for(let i=0;i<r.length;i++)e.ssrcs.push({id:t,attribute:r[i][0],value:r[i][1]})}static deleteSsrcAttr(e,t){e.ssrcs&&(e.ssrcs=e.ssrcs.filter((e=>{let{id:r}=e;return!t.find((e=>e.toString()===r.toString()))})))}static getNegCmdInfoAndDelete(e){let t="",r="",i=!1;for(let n=0;n<e.length;n++)"application"===e[n].type&&(/TCP\/WSS?\/RTP/gi.test(e[n].protocol)?(e[n].invalid.forEach((e=>{e.value.indexOf("bindCrypto-key")>=0&&(t=e.value.substring("bindCrypto-key:".length)),e.value.indexOf("websocket-uri")>=0&&(r=e.value.substring("websocket-uri:".length))})),e.splice(n,1)):/SCTP/gi.test(e[n].protocol)&&(i=!0));return{bindCryptoKey:t,wsUrl:r,dataChannelEnable:i}}generateSsrcMslabel(){return bR.generateRandomId(36)}containsValidVideoPayload(e){this.logger_.debug(this.module_,"containsValidVideoPayload, offerSdp: ".concat(this.printSdpInfo(e)));const t=this.parseSdp(e);if(!t)return this.logger_.error(this.module_,"containsValidVideoPayload failed,the sdp is invalid"),!1;return this.getMedias(t,ok.TRACK_TYPE_VIDEO).some((e=>{var t;return null===(t=e.rtp)||void 0===t?void 0:t.some((e=>e.codec.toUpperCase()===_P.H264))}))}transformOfferSdp(e){this.logger_.info(this.module_,"transformOfferSdp begin");const t=this.parseSdp(e);if(!t)return void this.logger_.error(this.module_,"transformOfferSdp failed,the sdp is invalid");this.deleteUnexpectedMedia(t);const r=this.getMedias(t,ok.TRACK_TYPE_VIDEO),i=this.getMedias(t,ok.TRACK_TYPE_AUDIO);r.forEach((e=>{this.transformVideoPayload(e),this.deleteRetransmissionSsrc(e)})),i.forEach((e=>{this.transformAudioPayload(e),this.deleteRetransmissionSsrc(e)}));const n=UP(t);return this.logger_.debug(this.module_,"transformOfferSdp success, sdp: ".concat(this.printSdpInfo(n))),n}editOrigin(e){e.origin&&(e.origin.username=dw.getBrowserInfo())}modifyAuxSdpInfo(e,t,r){const i=this.parseSdp(e);if(!i)return void this.logger_.error(this.module_,"modifyAuxSdpInfo failed,the sdp is invalid : ".concat(e));this.editOrigin(i);const n=this.getMedias(i,ok.TRACK_TYPE_VIDEO);n&&n.length>0&&(this.addVideoSsrcRange(n[0],r),this.modifyCandidate(n[0],t));const o=UP(i);return this.logger_.debug(this.module_,"modifyAuxSdpInfo success, sdp: ".concat(this.printSdpInfo(o))),o}modifyMainSdpInfo(e,t,r,i,n,o){const s=this.parseSdp(e);if(!s)return void this.logger_.error(this.module_,"modifyMainSdpInfo failed, the sdp is invalid : ".concat(e));this.editOrigin(s);const a=this.getMedias(s,ok.TRACK_TYPE_VIDEO),c=this.getMedias(s,ok.TRACK_TYPE_AUDIO);let u="",d="";if(a&&a.length>0&&(this.addVideoSsrcRange(a[0],r),this.modifyCandidate(a[0],t),d=a[0].mid,a.length>1))for(let h=0;h<s.media.length;h++)s.media[h].type!==ok.TRACK_TYPE_AUDIO&&s.media[h].mid!==a[0].mid&&delete s.media[h];c&&c.length>0&&(FP.addAudioSsrcRange(c[0],i,n),this.modifyCandidate(c[0],t),u=c[0].mid);for(const h of s.groups||[])if("BUNDLE"===h.type){h.mids="".concat(u," ").concat(d);break}n&&this.addNegCmdInfo(s,o);const l=UP(s);return this.logger_.debug(this.module_,"modifyMainSdpInfo success, sdp: ".concat(this.printSdpInfo(l))),l}addNegCmdInfo(e,t){if(t){const r=this.parseSdp(t).media.find((e=>e.type===ok.TYPE_APPLICATION)),i=e.media.filter((e=>null==e?void 0:e.type)),n=i[i.length-1];r.mid=["audio","video"].includes(n.mid)?"data":n.mid+1,e.media.push(r),e.groups.forEach((e=>{"BUNDLE"===e.type&&(e.mids="".concat(e.mids," ").concat(r.mid))}))}const r={type:"application",port:443,protocol:"TCP/WSS/RTP *",setup:"active",invalid:[]};r.invalid.push({value:"connection:new"}),r.invalid.push({value:"content:cmd"}),r.invalid.push({value:"bindCrypto-type:0"}),r.invalid.push({value:"bindCrypto-method:hmac-share256"}),e.media.push(r)}getSfuInfo(e,t){const r=this.parseSdp(e),i={ipAddress:"",auxPort:0};let n;const o=this.getMedias(r,ok.TRACK_TYPE_AUDIO);o&&o.length>0&&(i.audioPort=o[0].port,n=o[0].connection);const s=this.getMedias(r,ok.TRACK_TYPE_VIDEO);if(s&&s.length>0&&(i.videoPort=s[0].port,n=s[0].connection),n&&(i.ipAddress=n.ip),t){const e=this.parseSdp(t),r=this.getMedias(e,ok.TRACK_TYPE_VIDEO);r&&r.length>0&&r[0].connection&&(i.auxPort=r[0].port)}return i}}class HP extends FP{static modifyDirection(e){e.ssrcs&&0!==e.ssrcs.length?e.direction=fP.SEND_RECV:e.direction=fP.RECV_ONLY}hasSSRC(e,t){const r=this.parseSdp(e);if(!r)return this.logger_.error(this.module_,"hasSSRC failed"),!1;const i=this.getMedias(r,t);return i&&i.length>0&&!!i[0].ssrcs}getMslabelByCname(e,t){if(!e)return null;if(!e.ssrcs)return null;let r;for(const i of e.ssrcs)if(i.attribute.toLocaleLowerCase()===this.ssrcAttrCname_&&i.value===t){r=i.id;break}if(!r)return null;for(const i of e.ssrcs)if(i.id===r&&i.attribute.toLocaleLowerCase()===this.ssrcAttrMslabel_)return i.value;return null}addSsrc(e,t,r,i,n,o){const s=r,a=this.getMslabelByCname(e,s),c=this.getMslabelByCname(t,s);let u,d,l=!1,h=!1;if(a&&a===i||!n||(h=!0),c&&c===i||!o||(l=!0),h&&(u=c||i||this.generateSsrcMslabel()),l&&(d=i||this.generateSsrcMslabel()),this.logger_.debug(this.module_,"addSsrc, userId: ".concat(r,", audioMslabel: ").concat(u," videooMslabel: ").concat(d)),u){const t=FP.generateSsrcLabel(),r=[[this.ssrcAttrCname_,s],[this.ssrcAttrMslabel_,u],[this.ssrcAttrLabel_,t],[this.ssrcAttrMsid_,u+" "+t]];FP.addSsrcAttr(e,n,r)}if(d){const e=FP.generateSsrcLabel(),r=[[this.ssrcAttrCname_,s],[this.ssrcAttrMslabel_,d],[this.ssrcAttrLabel_,e],[this.ssrcAttrMsid_,d+" "+e]];FP.addSsrcAttr(t,o,r)}return d||u}static modifyMediaSsrc(e,t){if(!e.ssrcs)return;for(let r=0;r<t.length;r++)for(let i=0;i<4;i++)e.ssrcs[4*r+i].id=t[r]}transformAnswerSdp(e){this.logger_.debug(this.module_,"transformAnswerSdp, answerSdp: ".concat(this.printSdpInfo(e)));const t=this.parseSdp(e);if(!t)return void this.logger_.error(this.module_,"transformAnswerSdp failed,the sdp is invalid");const r=this.getMedias(t,ok.TRACK_TYPE_VIDEO),i=this.getMedias(t,ok.TRACK_TYPE_AUDIO);r&&r.length>0&&(this.portType_===lC.portNormal&&(r[0].rtcpMux=void 0),HP.modifyDirection(r[0])),i&&i.length>0&&(this.portType_===lC.portNormal&&(i[0].rtcpMux=void 0),HP.modifyDirection(i[0])),this.portType_===lC.portNormal&&(t.groups=void 0);const{bindCryptoKey:n,wsUrl:o,dataChannelEnable:s}=FP.getNegCmdInfoAndDelete(t.media),a=UP(t);return this.logger_.debug(this.module_,"transformAnswerSdp success,answerSdp: ".concat(this.printSdpInfo(a))),{remoteDescription:a,bindCryptoKey:n,wsUrl:o,dataChannelEnable:s}}deleteSSRC(e,t,r){if(0===t.length&&!r)return e;this.logger_.info(this.module_,"deleteVideoSSRC ".concat(t,", ").concat(r));const i=this.parseSdp(e);if(!i)return void this.logger_.error(this.module_,"deleteVideoSSRC failed");const n=this.getMedias(i,ok.TRACK_TYPE_VIDEO);n&&n.length>0&&(t&&FP.deleteSsrcAttr(n[0],t),HP.modifyDirection(n[0]));const o=this.getMedias(i,ok.TRACK_TYPE_AUDIO);o&&o.length>0&&(r&&FP.deleteSsrcAttr(o[0],[r]),HP.modifyDirection(o[0]));const s=UP(i);return this.logger_.info(this.module_,"deleteVideoSSRC ".concat(t," success")),s}addUser(e,t,r,i){const n=this.parseSdp(e);if(!n)return void this.logger_.error(this.module_,"addUser failed,the sdp is invalid : ".concat(e));const o=this.getMedias(n,ok.TRACK_TYPE_VIDEO),s=this.getMedias(n,ok.TRACK_TYPE_AUDIO);let a,c;o&&o.length>0&&(a=o[0]),s&&s.length>0&&(c=s[0]);const u=this.addSsrc(c,a,t,r,i.audioSsrc,i.videoSsrc);a&&HP.modifyDirection(a),c&&HP.modifyDirection(c);const d=UP(n);return this.logger_.debug(this.module_,"addUser success, answerSdp: ".concat(this.printSdpInfo(d))),{answerSdp:d,streamId:u}}deleteUser(e,t,r){const i=this.parseSdp(e);if(!i)return void this.logger_.error(this.module_,"deleteUser failed,the sdp is invalid : ".concat(e));if((null==t?void 0:t.length)>0){const e=this.getMedias(i,ok.TRACK_TYPE_VIDEO);e&&e.length>0&&(t.forEach((t=>{t&&FP.deleteSsrcAttr(e[0],[t])})),HP.modifyDirection(e[0]))}if((null==r?void 0:r.length)>0){const e=this.getMedias(i,ok.TRACK_TYPE_AUDIO);e&&e.length>0&&(r.forEach((t=>{t&&FP.deleteSsrcAttr(e[0],[t])})),HP.modifyDirection(e[0]))}const n=UP(i);return this.logger_.debug(this.module_,"deleteUser success, answerSdp: ".concat(this.printSdpInfo(n))),n}modifyPublishOfferSdp(e,t,r){this.logger_.debug(this.module_,"modifyPublishOfferSdp start, sdp: ".concat(this.printSdpInfo(e)));const i=this.parseSdp(e);if(!i)return void this.logger_.error(this.module_,"modifyPublishOfferSdp failed, the sdp is invalid: ".concat(e));this.deleteUnexpectedMedia(i);const n=this.getMedias(i,ok.TRACK_TYPE_VIDEO),o=this.getMedias(i,ok.TRACK_TYPE_AUDIO);if(n&&n.length>0&&(this.transformVideoPayload(n[0]),this.deleteRetransmissionSsrc(n[0]),t&&t.length>0&&HP.modifyMediaSsrc(n[0],t)),o&&o.length>0&&(this.transformAudioPayload(o[0]),this.deleteRetransmissionSsrc(o[0]),r)){const e=[r];HP.modifyMediaSsrc(o[0],e)}const s=UP(i);return this.logger_.debug(this.module_,"modifyPublishOfferSdp success, sdp: ".concat(this.printSdpInfo(s))),s}}class KP extends FP{static modifyDirectionWhenAddUser(e,t){e&&(e.direction===fP.RECV_ONLY?e.direction=fP.SEND_RECV:e.direction===fP.INACTIVE&&(e.direction=fP.SEND_ONLY)),t&&(t.direction===fP.SEND_ONLY?t.direction=fP.SEND_RECV:t.direction===fP.INACTIVE&&(t.direction=fP.RECV_ONLY))}addSSRC(e,t,r,i){const n=r||this.generateSsrcMslabel();this.logger_.debug(this.module_,"addSSRC, userId:".concat(t,", mslabel:").concat(n,", streamId:").concat(r,", ssrc:").concat(i)),e.ssrcs&&delete e.ssrcs;const o=FP.generateSsrcLabel(),s=[[this.ssrcAttrCname_,t],[this.ssrcAttrMslabel_,n],[this.ssrcAttrLabel_,o],[this.ssrcAttrMsid_,n+" "+o]];return FP.addSsrcAttr(e,i,s),n}static modifyDirectionWhenDelUser(e,t){e.direction===fP.SEND_RECV?e.direction=fP.RECV_ONLY:e.direction===fP.SEND_ONLY&&(e.direction=fP.INACTIVE),t.direction===fP.SEND_RECV?t.direction=fP.SEND_ONLY:t.direction===fP.RECV_ONLY&&(t.direction=fP.INACTIVE)}hasSSRC(e,t){const r=this.parseSdp(e);if(!r)return this.logger_.error(this.module_,"hasSSRC failed"),!1;return this.getMedias(r,t).some((e=>(e.direction===fP.SEND_ONLY||e.direction===fP.SEND_RECV)&&!!e.ssrcs))}delteInvalidLines(e){this.deleteUnexpectedMedia(e);const t=this.getMedias(e,ok.TRACK_TYPE_VIDEO),r=this.getMedias(e,ok.TRACK_TYPE_AUDIO);t.forEach((e=>{this.transformVideoPayload(e),this.deleteRetransmissionSsrc(e)})),r.forEach((e=>{this.transformAudioPayload(e),this.deleteRetransmissionSsrc(e)}))}getAvailableSenderMedia(e,t){return e.media.filter((e=>{let{type:r,direction:i}=e;return r===t&&(i===fP.SEND_ONLY||i===fP.SEND_RECV)}))}modifyUnifiedMediaSsrc(e,t,r){if(e.ssrcs&&0!==e.ssrcs.length)e.ssrcs.forEach((e=>{e.attribute===this.ssrcAttrCname_&&(e.value=r),e.id=t}));else{const i=[[this.ssrcAttrCname_,r]];FP.addSsrcAttr(e,t,i)}}static modifyBundle(e,t){for(const r of e.groups||[])if("BUNDLE"===r.type){r.mids.split(" ").includes("".concat(t))||(r.mids="".concat(r.mids," ").concat(t));break}}modifyAnswerDirection(e,t){var r;const i=this.parseSdp(e);if(!i)return void this.logger_.error(this.module_,"modifyAnswerDirection failed,the sdp is invalid");const n=null===(r=i.media)||void 0===r?void 0:r.find((e=>"".concat(e.mid)==="".concat(t)));return n&&(n.direction===fP.INACTIVE?n.direction=fP.RECV_ONLY:n.direction===fP.SEND_ONLY&&(n.direction=fP.SEND_RECV)),UP(i)}transformAnswerSdp(e,t){this.logger_.debug(this.module_,"transformAnswerSdp, answerSdp: ".concat(this.printSdpInfo(e)));const r=this.parseSdp(e),i=this.parseSdp(t);if(!r||!i)return void this.logger_.error(this.module_,"transformAnswerSdp failed,the sdp is invalid");this.getMedias(r,ok.TRACK_TYPE_AUDIO).forEach((e=>{this.portType_===lC.portNormal&&(e.rtcpMux=void 0),e.ssrcs||(e.direction=fP.INACTIVE)}));let n=this.getMedias(r,ok.TRACK_TYPE_VIDEO);const o=this.getMedias(i,ok.TRACK_TYPE_VIDEO);if(o.length!==n.length){const e=n.map((e=>"".concat(e.mid)));o.forEach((t=>{if(!e.includes("".concat(t.mid))){const e=JSON.parse(JSON.stringify(n[0]));e.mid=t.mid,r.media.push(e),KP.modifyBundle(r,t.mid)}}))}n=this.getMedias(r,ok.TRACK_TYPE_VIDEO),n.forEach((e=>{this.portType_===lC.portNormal&&(e.rtcpMux=void 0),e.direction=fP.INACTIVE})),this.portType_===lC.portNormal&&(r.groups=void 0);const{bindCryptoKey:s,wsUrl:a,dataChannelEnable:c}=FP.getNegCmdInfoAndDelete(r.media),u=this.getMedias(r,ok.TYPE_APPLICATION);if(r.media=r.media.filter((e=>e.type!==ok.TYPE_APPLICATION)),u.length>0){const e=this.getMedias(r,ok.TRACK_TYPE_VIDEO).map((e=>parseInt("".concat(e.mid))));u[0].mid="".concat(Math.max(...e)+1),dw.isFirefox()&&(u[0].port=9),r.media.push(...u),KP.modifyBundle(r,"".concat(u[0].mid))}const d=UP(r);return this.logger_.debug(this.module_,"transformAnswerSdp success,answerSdp: ".concat(this.printSdpInfo(d))),{remoteDescription:d,bindCryptoKey:s,wsUrl:a,dataChannelEnable:c}}addUser(e,t,r,i,n,o){var s,a;const c=this.parseSdp(e);if(!c)return this.logger_.error(this.module_,"addUser failed,the sdp is invalid : ".concat(e)),null;const u=this.parseSdp(t);if(!u)return this.logger_.error(this.module_,"addUser failed,the sdp is invalid : ".concat(t)),null;this.delteInvalidLines(u);const d=null===(s=u.media)||void 0===s?void 0:s.find((e=>"".concat(e.mid)===r)),l=null===(a=c.media)||void 0===a?void 0:a.find((e=>e.type===d.type)),h=JSON.parse(JSON.stringify(l));h.mid=r,h.direction=fP.SEND_ONLY,h.type===ok.TRACK_TYPE_AUDIO&&this.portType_===lC.portReduce&&delete h.candidates;const f=this.addSSRC(h,i,n,o);c.media.push(h),KP.modifyBundle(c,r),KP.modifyDirectionWhenAddUser(h,d);const p=UP(c),m=UP(u);return this.logger_.debug(this.module_,"addUser success, offer: ".concat(this.printSdpInfo(m)," answer: ").concat(this.printSdpInfo(p))),{offerSdp:m,answerSdp:p,streamId:f}}async deleteUser(e,t,r,i,n){const o=this.parseSdp(e);if(!o)return this.logger_.error(this.module_,"deleteUser failed,the sdp is invalid : ".concat(e)),null;const s=this.parseSdp(t);if(!s)return this.logger_.error(this.module_,"deleteUser failed,the sdp is invalid : ".concat(t)),null;for(const u of o.media)if(u.ssrcs&&u.ssrcs.some((e=>r.includes(parseInt("".concat(e.id)))))){KP.modifyDirectionWhenDelUser(u,s.media.find((e=>e.mid===u.mid))),u.ssrcs.forEach((e=>{e.value="-"}));const e=i.find((e=>"".concat(e.mid)==="".concat(u.mid)));e&&(e.direction=e.currentDirection===fP.SEND_RECV||e.currentDirection===fP.SEND_ONLY?fP.SEND_ONLY:fP.INACTIVE,await n(e.receiver))}const a=UP(o),c=UP(s);return this.logger_.debug(this.module_,"deleteUser success, offer: ".concat(this.printSdpInfo(c)," answer: ").concat(this.printSdpInfo(a))),{offerSdp:c,answerSdp:a}}modifySdpByMid(e,t,r,i,n,o){var s,a;const c=this.parseSdp(e);if(!c)return this.logger_.error(this.module_,"modifySdpByMid failed,the sdp is invalid : ".concat(e)),null;const u=null===(s=c.media)||void 0===s?void 0:s.find((e=>"".concat(e.mid)===r)),d=this.addSSRC(u,i,n,o),l=this.parseSdp(t);l||this.logger_.error(this.module_,"modifySdpByMid failed,the sdp is invalid : ".concat(t));const h=null===(a=l.media)||void 0===a?void 0:a.find((e=>"".concat(e.mid)===r));KP.modifyDirectionWhenAddUser(u,h);const f=UP(c),p=UP(l);return this.logger_.debug(this.module_,"modifySdpByMid success, offer: ".concat(this.printSdpInfo(p)," answer: ").concat(this.printSdpInfo(f))),{offerSdp:p,answerSdp:f,streamId:d}}getAllMidsByType(e,t){var r;const i=this.parseSdp(e),n=[];return i?(null===(r=i.media)||void 0===r||r.forEach((e=>{e.type===t&&n.push("".concat(e.mid))})),n):(this.logger_.error(this.module_,"getAllMidsByType failed,the sdp is invalid : ".concat(e)),n)}getIdleTransceiverWithSameSsrc(e,t,r){if(!t||0===t.length)return null;const i=this.parseSdp(e);if(!i)return this.logger_.error(this.module_,"getIdleMidWithSameSsrc failed,the sdp is invalid : ".concat(e)),null;const n=i.media.find((e=>!(!e.ssrcs||0===e.ssrcs.length)&&e.ssrcs[0].id===r));let o;for(const s of t)if(n){if("".concat(n.mid)==="".concat(s.mid)){o=t.splice(t.indexOf(s),1)[0];break}}else{const e=i.media.find((e=>"".concat(e.mid)==="".concat(s.mid)));if(!e.ssrcs||0===e.ssrcs.length){o=t.shift();break}}return o}deleteSSRC(e,t,r,i){if(0===r.length&&!i)return e;this.logger_.info(this.module_,"deleteSSRC ".concat(r,", ").concat(i));const n=this.parseSdp(e),o=this.parseSdp(t);if(!n)return void this.logger_.error(this.module_,"deleteSSRC failed");null==r||r.forEach((e=>{n.media.filter((e=>e.type===ok.TRACK_TYPE_VIDEO)).forEach((t=>{var r;if(null!==(r=t.ssrcs)&&void 0!==r&&r.find((t=>t.id===e))){var i;const e=null===(i=o.media)||void 0===i?void 0:i.find((e=>"".concat(e.mid)==="".concat(t.mid)));KP.modifyDirectionWhenPublish(t,e,!1),t.ssrcs=void 0}}))})),n.media.filter((e=>e.type===ok.TRACK_TYPE_AUDIO)).forEach((e=>{var t;if(null!==(t=e.ssrcs)&&void 0!==t&&t.find((e=>e.id===i))){var r;const t=null===(r=o.media)||void 0===r?void 0:r.find((t=>"".concat(t.mid)==="".concat(e.mid)));KP.modifyDirectionWhenPublish(e,t,!1),e.ssrcs=void 0}}));const s=UP(n),a=UP(o);return this.logger_.debug(this.module_,"deleteSSRC ".concat(r," success, offer: ").concat(this.printSdpInfo(s)," answer: ").concat(this.printSdpInfo(a))),{offerSdp:s,answerSdp:a}}modifyPublishOfferSdp(e,t,r,i,n){this.logger_.debug(this.module_,"modifyPublishOfferSdp start, sdp: ".concat(this.printSdpInfo(e)));const o=this.parseSdp(e),s=this.parseSdp(t);if(!o)return void this.logger_.error(this.module_,"modifyPublishOfferSdp failed, the sdp is invalid: ".concat(e));if(this.deleteUnexpectedMedia(o),i&&i.length>0){let e=this.getAvailableSenderMedia(o,ok.TRACK_TYPE_VIDEO);null==i||i.forEach((t=>{var i;let n=e.find((e=>{var r;return null===(r=e.ssrcs)||void 0===r?void 0:r.find((e=>"".concat(e.id)==="".concat(t)))}));n?e=e.filter((e=>{var r;return!e.ssrcs||(null===(r=e.ssrcs)||void 0===r?void 0:r.find((e=>"".concat(e.id)!=="".concat(t))))})):n=e.shift(),this.transformVideoPayload(n),this.deleteRetransmissionSsrc(n),this.modifyUnifiedMediaSsrc(n,t,r);const o=null===(i=s.media)||void 0===i?void 0:i.find((e=>"".concat(e.mid)==="".concat(n.mid)));KP.modifyDirectionWhenPublish(n,o,!0)}))}o.media.filter((e=>{let{type:t,direction:r}=e;return t===ok.TRACK_TYPE_VIDEO&&r!==fP.SEND_ONLY&&r!==fP.SEND_RECV})).forEach((e=>{this.transformVideoPayload(e),this.deleteRetransmissionSsrc(e),e.ssrcs=void 0}));const a=this.getAvailableSenderMedia(o,ok.TRACK_TYPE_AUDIO);if(a&&a.length>0){const e=a[0];if(this.transformAudioPayload(e),this.deleteRetransmissionSsrc(e),n){var c;const t=null===(c=s.media)||void 0===c?void 0:c.find((t=>"".concat(t.mid)==="".concat(e.mid)));this.modifyUnifiedMediaSsrc(e,n,r),KP.modifyDirectionWhenPublish(e,t,!0)}}const u=UP(o),d=UP(s);return this.logger_.debug(this.module_,"modifyPublishOfferSdp success, offerSdp: ".concat(this.printSdpInfo(u),", answerSdp: ").concat(this.printSdpInfo(d))),{offerSdp:u,answerSdp:d}}static modifyDirectionWhenPublish(e,t,r){r?e.direction===fP.RECV_ONLY?e.direction=fP.SEND_RECV:e.direction===fP.INACTIVE&&(e.direction=fP.SEND_ONLY):e.direction===fP.SEND_ONLY?e.direction=fP.INACTIVE:e.direction===fP.SEND_RECV&&(e.direction=fP.RECV_ONLY),r?t.direction===fP.SEND_ONLY?t.direction=fP.SEND_RECV:t.direction===fP.INACTIVE&&(t.direction=fP.RECV_ONLY):t.direction===fP.SEND_RECV?t.direction=fP.SEND_ONLY:t.direction===fP.RECV_ONLY&&(t.direction=fP.INACTIVE)}generateMatchedAnswerWithOffer(e,t,r){this.logger_.debug(this.module_,"generateCorrespondingRemoteSdpMedia start, sdp: ".concat(this.printSdpInfo(e)));const i=this.parseSdp(e);this.portType_!==lC.portNormal&&KP.modifyBundle(i,t);const n=this.getMedias(i,r);if(!n||0===n.length)return e;const o=JSON.parse(JSON.stringify(n[0]));o.mid=t,delete o.ssrcs,delete o.candidates,o.direction=fP.INACTIVE,i.media.push(o);const s=UP(i);return this.logger_.debug(this.module_,"generateCorrespondingRemoteSdpMedia success, sdp: ".concat(this.printSdpInfo(s))),s}getBrowserDefaultSsrc(e){const t=this.parseSdp(e),r=this.getMedias(t,ok.TRACK_TYPE_VIDEO),i=this.getMedias(t,ok.TRACK_TYPE_AUDIO),n=[];let o;if(r&&r.length>0&&r.forEach((e=>{e.ssrcs&&e.ssrcs.length>0&&n.push(parseInt(e.ssrcs[0].id.toString()))})),i&&i.length>0)for(const s of i)if(s.ssrcs&&s.ssrcs.length>0){o=parseInt(s.ssrcs[0].id.toString());break}return{videoSsrcs:n,audioSsrc:o}}getLeastMid(e){const t=this.parseSdp(e);if(!t)return void this.logger_.error(this.module_,"getLeastMid failed, the sdp is invalid : ".concat(e));let r;for(const i of t.groups||[])if("BUNDLE"===i.type){const e=(i.mids||"").split(" ");r=e[e.length-1];break}return r}}const zP="PeerConnectionsManager";class WP extends jO{constructor(e,r,i){super({logger:e,stat:r,emitter:i}),t(this,"isFireFox",dw.isFirefox()),this.peerConnections=new Map,dw.isOnlySupportUnfiedPlan()?(this.sdpDescMode="unified-plan",this.rtcSdp=new KP(this.logger)):(this.sdpDescMode="plan-b",this.rtcSdp=new HP(this.logger)),this.logger.debug(zP,"ConnectionsManager, SDP mode: ".concat(this.sdpDescMode)),this.setPortType(lC.portReduce),this.mainReceiverPreStatisticMap=new Map,this.auxReceiverPreStatisticMap=new Map}setPortType(e){const t=nk.getParameter(Zw)||0;0!==t&&(e=t),e===lC.portNormal&&dw.isOnlySupportUnfiedPlan()&&(e=lC.portReduce),this.portType=e,this.portType===lC.portNormal&&(this.sdpDescMode="plan-b",this.rtcSdp=new HP(this.logger)),this.logger.debug(zP,"ConnectionsManager, portType: ".concat(1===this.portType?"normal":"reduce")),this.rtcSdp.setPortType(this.portType)}getPortType(){return this.portType}setTurnServer(e){this.turnServerConfig=e}isConnectionsExist(){return this.peerConnections.size>0}getConnectionId(){return this.uniqueId}getReceivers(e){var t;const r=null===(t=this.peerConnections.get(e))||void 0===t?void 0:t.connection;if("plan-b"===this.sdpDescMode)return null==r?void 0:r.getReceivers();const i=[],n=null==r?void 0:r.getTransceivers();if(!n)return null;for(const o of n)o.currentDirection!==fP.SEND_RECV&&o.currentDirection!==fP.RECV_ONLY||i.push(o.receiver);return i}getSenders(e){var t;const r=null===(t=this.peerConnections.get(e))||void 0===t?void 0:t.connection;if("plan-b"===this.sdpDescMode)return null==r?void 0:r.getSenders();const i=[],n=null==r?void 0:r.getTransceivers();if(!n)return null;for(const o of n)o.currentDirection!==fP.SEND_RECV&&o.currentDirection!==fP.SEND_ONLY||i.push(o.sender);return i}calcChangedStatistic(e,t,r){if(this.mainReceiverPreStatisticMap.has(e)||this.auxReceiverPreStatisticMap.has(e)){const i=this.mainReceiverPreStatisticMap.get(e)||this.auxReceiverPreStatisticMap.get(e);if("number"==typeof t)return Object.prototype.hasOwnProperty.call(i,r[0])?t>=i[r[0]]?t-i[r[0]]:(this.clearReveiverPreStatisticBySsrcLabel(e),t):t;this.doCalcChangedStatisticObject(e,t,i,r)}else if("number"==typeof t)return t}doCalcChangedStatisticObject(e,t,r,i){if(i&&i.length>0){let n=0;for(const e of i)Object.prototype.hasOwnProperty.call(r,e)&&(t[e]>=r[e]?t[e]=t[e]-r[e]:n++);n>=i.length-1&&this.clearReveiverPreStatisticBySsrcLabel(e)}else{let i=0;for(const e in t)Object.prototype.hasOwnProperty.call(r,e)&&(t[e]>=r[e]?t[e]=t[e]-r[e]:i++);i===Object.keys(t).length&&this.clearReveiverPreStatisticBySsrcLabel(e)}}clearReveiverPreStatisticBySsrcLabel(e){this.mainReceiverPreStatisticMap.delete(e)||this.auxReceiverPreStatisticMap.delete(e)}async initConnectionAndSdp(e,t,r,i){this.uniqueId=e;const n=this.createPeerConnection(t),o="main"!==t;let s=await this.createOffer(t,{offerToReceiveAudio:!o,offerToReceiveVideo:!0});if(this.isFireFox){t===sk.STREAM_TYPE_MAIN&&(await n.connection.setLocalDescription({type:"offer",sdp:this.rtcSdp.transformOfferSdp(s.sdp)}),n.connection.addTransceiver("video",{direction:fP.INACTIVE}),s=await n.connection.createOffer());const e=this.rtcSdp.getBrowserDefaultSsrc(s.sdp);n.videoSendSsrcs=e.videoSsrcs,n.sendSsrcsMapping=new Map,e.videoSsrcs.forEach(((e,t)=>{n.sendSsrcsMapping.set(t,e)})),!o&&e.audioSsrc&&(n.audioSendSsrc=e.audioSsrc,n.sendSsrcsMapping.set(2,e.audioSsrc))}const a=this.rtcSdp.transformOfferSdp(s.sdp);if(await n.connection.setLocalDescription({type:"offer",sdp:a}),await this.iceAddressCollect(n.connection),!this.isFireFox){const e=n.connection.localDescription.sdp;this.logger.debug(zP,"setLocalDescription, ".concat(t,"sdp offer: ").concat(this.rtcSdp.printSdpInfo(e))),await n.connection.setLocalDescription({type:"offer",sdp:this.rtcSdp.transformOfferSdp(e)})}o?this.onConnection(n,r.onTrackHandler,!0):this.rtcSdp.containsValidVideoPayload(s.sdp)||i?this.onConnection(n,r.onTrackHandler,!1):(this.destroyPeerConnection(t),this.logger.error(zP,"initConnectionAndSdp, no H264 payload and try createOffer again"),await this.initConnectionAndSdp(e,t,r,!0))}setSsrcsMapping(e){const t=this.peerConnections.get(sk.STREAM_TYPE_MAIN);t.sendSsrcsMapping&&t.sendSsrcsMapping.size>0&&(t.sendSsrcsMapping.has(0)&&(t.sendSsrcsMapping.set(e.video.sendSsrcBegin,t.sendSsrcsMapping.get(0)),t.sendSsrcsMapping.delete(0)),t.sendSsrcsMapping.has(1)&&(t.sendSsrcsMapping.set(e.video.sendSsrcEnd,t.sendSsrcsMapping.get(1)),t.sendSsrcsMapping.delete(1)),t.sendSsrcsMapping.has(2)&&(t.sendSsrcsMapping.set(e.audio.sendSsrcBegin,t.sendSsrcsMapping.get(2)),t.sendSsrcsMapping.delete(2)));const r=this.peerConnections.get(sk.STREAM_TYPE_AUX);r.sendSsrcsMapping&&r.sendSsrcsMapping.size>0&&r.sendSsrcsMapping.has(0)&&(r.sendSsrcsMapping.set(e.desktopVideo.sendSsrcBegin,r.sendSsrcsMapping.get(0)),r.sendSsrcsMapping.delete(0))}getMappingSsrcs(e,t){if(!e)return;let r;return t||"number"!=typeof e?(r=this.peerConnections.get(t),!r.sendSsrcsMapping||r.sendSsrcsMapping.size<1?e:"number"==typeof e?r.sendSsrcsMapping.has(e)?r.sendSsrcsMapping.get(e):e:e.map((e=>r.sendSsrcsMapping.has(e)?r.sendSsrcsMapping.get(e):e))):(r=this.peerConnections.get(sk.STREAM_TYPE_MAIN),r.sendSsrcsMapping.has(e)?r.sendSsrcsMapping.get(e):(r=this.peerConnections.get(sk.STREAM_TYPE_AUX),r.sendSsrcsMapping.get(e)||e))}async createOffer(e,t){const r=this.peerConnections.get(e).connection,i=await r.createOffer(t);return"plan-b"!==this.sdpDescMode&&r.getTransceivers().forEach((e=>{e.direction=fP.INACTIVE})),i}iceCandidateListener(e,t){this.logger.info(zP,"iceCandidateListener of ".concat(t)),e.connection.onicecandidate=r=>{var i;r.candidate&&"udp"===r.candidate.protocol&&(this.logger.info(zP,"".concat(t," onicecandidate: ").concat(bR.shieldIpAddress(null===(i=r.candidate)||void 0===i?void 0:i.candidate))),e.candidate||(e.candidate=[]),e.candidate.push(r.candidate))}}iceRestart(e,t,r){if(this.stat.setConnectionStatusInfo(kC.CLOSED,wC.MEDIA),e.connectFailedTimes++,this.logger.error(zP,"".concat(t?"aux":"main"," connection statechange, connectFailedTimes: ").concat(e.connectFailedTimes,".")),e.connectFailedTimes<=30&&(this.logger.error(zP,"".concat(t?"aux":"main"," connection statechange, emit media error event.")),e.connectFailedTimes%2==0&&this.eventEmitter.emit(hC.Error,{errCode:Wc.RTC_ERR_CODE_MEDIA_NETWORK_ERROR,errDesc:"".concat(t?"aux":"main"," peerConnection: ").concat(Gc[Wc.RTC_ERR_CODE_MEDIA_NETWORK_ERROR])}),30===e.connectFailedTimes))return this.eventEmitter.emit(hC.MediaConnectionStateChanged,{roomId:this.uniqueId,type:t?"aux":"main",state:pC.DisConnected}),void(e.connectFailedTimes=0);e.connection.createOffer({iceRestart:!0}).then((r=>{this.eventEmitter.emit(hC.MediaConnectionStateChanged,{roomId:this.uniqueId,type:t?"aux":"main",state:pC.Reconnecting}),e.connection.setLocalDescription({type:"offer",sdp:this.rtcSdp.transformOfferSdp(r.sdp)}),e.connection.setRemoteDescription({sdp:e.connection.remoteDescription.sdp,type:"answer"})})).finally((()=>{r&&r()}))}onConnection(e,t,r){e.connection.ontrack=e=>{t(e,r)},e.connection.onconnectionstatechange=()=>{if(this.logger.info(zP,"onconnectionstatechange, ".concat(r?"aux":"main"," connect state is: ").concat(e.connection.connectionState," ;iceConnectionState: ").concat(e.connection.iceConnectionState)),"disconnected"!==e.connection.iceConnectionState)clearTimeout(e.disConnectDelayHandleTimer),e.disConnectDelayHandleTimer=null,"failed"===e.connection.iceConnectionState||"closed"===e.connection.iceConnectionState?(this.logger.info(zP,"connect state failed go iceRestart: ".concat(e.connection.iceConnectionState)),this.iceRestart(e,r)):"connected"===e.connection.iceConnectionState&&(this.logger.info(zP,"connect state connect: ".concat(e.connection.iceConnectionState)),this.stat.setConnectionStatusInfo(kC.CONNECTED,wC.MEDIA),e.connectFailedTimes=0,this.eventEmitter.emit(hC.MediaConnectionStateChanged,{roomId:this.uniqueId,type:r?"aux":"main",state:pC.Connected}),e.connection.getStats().then((e=>{let t=null;e.forEach((e=>{"candidate-pair"===e.type&&(this.isFireFox&&e.selected||e.nominated)&&(t=e.localCandidateId)})),t&&e.forEach((e=>{e.id===t&&(this.logger.info(zP,"transport protocol changed, candidateType: ".concat(e.candidateType,", protocol: ").concat(e.protocol)),this.eventEmitter.emit(hC.TransportProtocolChanged,{protocol:e.protocol,candidateType:e.candidateType}))}))})));else{if(e.disConnectDelayHandleTimer)return;e.disConnectDelayHandleTimer=setTimeout((()=>{this.logger.info(zP,"disConnect state delay handler, go iceRestart: ".concat(e.connection.iceConnectionState)),this.iceRestart(e,r,(()=>{clearTimeout(e.disConnectDelayHandleTimer),e.disConnectDelayHandleTimer=null}))}),5e3)}}}async iceAddressCollect(e){await new Promise((t=>{let r=null;const i=()=>{this.logger.info(zP,"ICE collect Gathering State change: ".concat(e.iceGatheringState)),"complete"===e.iceGatheringState&&(clearTimeout(r),this.logger.info(zP,"ICE collect complete"),e.removeEventListener("icegatheringstatechange",i),t())};e.addEventListener("icegatheringstatechange",i),r=setTimeout((()=>{this.logger.error(zP,"ICE collect timeout"),clearTimeout(r),t()}),6e3)}))}createPeerConnection(e){const t={rtcpMuxPolicy:this.portType===lC.portReduce?"require":"negotiate",bundlePolicy:this.portType===lC.portReduce?"max-bundle":"balanced"},r=[];if(this.turnServerConfig){for(const e of this.turnServerConfig.turnServers)r.push("turn:".concat(e,":").concat(this.turnServerConfig.udpPort||3478,"?transport=udp"));t.iceServers=[{urls:r,username:this.turnServerConfig.userName,credential:this.turnServerConfig.credential}],t.iceTransportPolicy="relay"}t.sdpSemantics=this.sdpDescMode;const i=new RTCPeerConnection(t);var n;this.peerConnections.has(e)&&(null===(n=this.peerConnections.get(e).connection)||void 0===n||n.close());const o={connection:i,connectFailedTimes:0};return this.peerConnections.set(e,o),this.iceCandidateListener(o,e),o}destroyPeerConnection(e,t){const r=this.peerConnections.get(e);r&&(clearTimeout(r.disConnectDelayHandleTimer),r.connectFailedTimes=0,"closed"!==r.connection.signalingState&&(null==t||t.forEach((e=>r.connection.removeTrack(e))),r.connection.close()),"main"===e?this.mainReceiverPreStatisticMap.clear():this.auxReceiverPreStatisticMap.clear(),this.peerConnections.delete(e))}async modifySdpInfo(e,t){const r=this.peerConnections.get(e);let i=null;if(r)if("main"===e){const e=await this.getDataChannelTemplate(t);i=this.rtcSdp.modifyMainSdpInfo(r.connection.localDescription.sdp,r.candidate,r.videoSendSsrcs,r.audioSendSsrc,t,e)}else i=this.rtcSdp.modifyAuxSdpInfo(r.connection.localDescription.sdp,r.candidate,r.videoSendSsrcs);return i}async getDataChannelTemplate(e){let t=null;if(!e)return t;let r=null;try{r=new RTCPeerConnection,r.createDataChannel("dataChannelTemplate"),t=(await r.createOffer()).sdp}catch(kD){this.logger.error(zP,"getDataChannelTemplate failed, unsupport datachannel: ".concat(kD))}finally{r&&r.close()}return t}async setLocalDescriptionShim(e,t){let r;!this.isFireFox&&t||(r=(await e.createOffer()).sdp),await e.setLocalDescription({type:"offer",sdp:this.rtcSdp.transformOfferSdp(r||t)})}async handleAnswerSdpFromServer(e,t,r){const i=this.peerConnections.get(e).connection,{remoteDescription:n,bindCryptoKey:o,wsUrl:s,dataChannelEnable:a}=this.rtcSdp.transformAnswerSdp(t,i.localDescription.sdp);let c;this.logger.debug(zP,"handleAnswerSdpFromServer, ".concat(e," sdp answer: ").concat(this.rtcSdp.printSdpInfo(n))),c=r?await r({remoteDescription:n,bindCryptoKey:o,wsUrl:s,dataChannelEnable:a}):{answerSdp:n},c.offerSdp&&c.offerSdp!==i.localDescription.sdp&&await this.setLocalDescriptionShim(i,c.offerSdp);try{await i.setRemoteDescription({type:"answer",sdp:c.answerSdp})}catch(kD){throw this.logger.error(zP,"setRemoteDescription error, answer sdp invalid or offer sdp invalid"),new qc(Wc.RTC_ERR_CODE_ANSWER_SDP_INVALID,(null==kD?void 0:kD.message)||"setRemoteDescription error, answer sdp invalid or offer sdp invalid")}}getSfuInfoFromSdp(e,t){return this.rtcSdp.getSfuInfo(e,t)}async generateAndSetOfferSdpByHandler(e,t){const r=this.peerConnections.get(e).connection;let i;i=t?await t(r.localDescription.sdp):r.localDescription.sdp,await this.setLocalDescriptionShim(r,i)}async generateAndSetAnswerSdpByHandler(e,t){const r=this.peerConnections.get(e).connection;let i;i=t?(await t(r.remoteDescription.sdp)).answerSdp:r.remoteDescription.sdp,await r.setRemoteDescription({type:"answer",sdp:i})}async deleteUser(e,t,r){const i=this.peerConnections.get(e).connection,n=i.remoteDescription.sdp;let o={offerSdp:i.localDescription.sdp,answerSdp:n};if("plan-b"===this.sdpDescMode)o.answerSdp=this.rtcSdp.deleteUser(o.answerSdp,t,r);else{const n=i.getTransceivers();t&&t.length>0&&(o=await this.rtcSdp.deleteUser(o.answerSdp,o.offerSdp,t,n,(t=>this.recordCurrentReceiverStatistic(e,t)))),r&&r.length>0&&(o=await this.rtcSdp.deleteUser(o.answerSdp,o.offerSdp,r,n,(t=>this.recordCurrentReceiverStatistic(e,t))))}await this.setLocalDescriptionShim(i,o.offerSdp),await i.setRemoteDescription({type:"answer",sdp:o.answerSdp})}async recordCurrentReceiverStatistic(e,t){const r=await t.getStats();r&&r.forEach(((t,r)=>{(this.isFireFox||/RTCInboundRTP(Video|Audio)Stream_.*/gi.test(r))&&this["main"===e?"mainReceiverPreStatisticMap":"auxReceiverPreStatisticMap"].set(r,t)}))}getAllIdleReceiverTransceivers(e,t,r){const i=e.getTransceivers(),n=this.rtcSdp.getAllMidsByType(r,t);return i.filter((e=>n.includes("".concat(e.mid))&&e.currentDirection!==fP.SEND_RECV&&e.currentDirection!==fP.RECV_ONLY))}getIdleSendTransceiver(e,t,r){const i=e.getTransceivers(),n=this.rtcSdp.getAllMidsByType(r,t);return null==i?void 0:i.find((e=>n.includes("".concat(e.mid))&&e.currentDirection!==fP.SEND_ONLY&&e.currentDirection!==fP.SEND_RECV))}async addTrack(e,t,r){const i=this.peerConnections.get(e).connection;if("plan-b"===this.sdpDescMode)return i.addTrack(t,r);const n=i.localDescription.sdp;let o=this.getIdleSendTransceiver(i,"audio"===t.kind?ok.TRACK_TYPE_AUDIO:ok.TRACK_TYPE_VIDEO,n);if(o){await o.sender.replaceTrack(t),o.direction=o.currentDirection===fP.RECV_ONLY?fP.SEND_RECV:fP.SEND_ONLY;const e=this.rtcSdp.modifyAnswerDirection(i.remoteDescription.sdp,o.mid);await this.setLocalDescriptionShim(i),await i.setRemoteDescription({type:"answer",sdp:e})}else this.logger.info(zP,"addTrack, no available sender, addTranscevier"),o=await this.addTransceiver(i,ok.TRACK_TYPE_VIDEO),await o.sender.replaceTrack(t),o.direction=o.currentDirection===fP.RECV_ONLY?fP.SEND_RECV:fP.SEND_ONLY;return o.sender}removeTrack(e,t){const r=this.peerConnections.get(e).connection;"closed"!==r.signalingState&&r.removeTrack(t)}async modifyPublishOfferSdp(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;const s=this.peerConnections.get(e).connection;let a,c,u=(await s.createOffer()).sdp;return(n&&n.length>0||o)&&("plan-b"===this.sdpDescMode?u=this.rtcSdp.deleteSSRC(u,n,o):a=this.rtcSdp.deleteSSRC(u,s.remoteDescription.sdp,this.getMappingSsrcs(n,e),this.getMappingSsrcs(o,e))),"plan-b"===this.sdpDescMode?u=this.rtcSdp.modifyPublishOfferSdp(u,r,i):a=this.rtcSdp.modifyPublishOfferSdp(a?a.offerSdp:u,a?a.answerSdp:s.remoteDescription.sdp,t,this.getMappingSsrcs(r,e),this.getMappingSsrcs(i,e)),"plan-b"===this.sdpDescMode?(await s.setLocalDescription({type:"offer",sdp:u}),await s.setRemoteDescription(s.remoteDescription),c=u):(await this.setLocalDescriptionShim(s,a.offerSdp),await s.setRemoteDescription({type:"answer",sdp:a.answerSdp}),c=a.offerSdp),c}async addTopAudioUserBatch(e,t,r,i){const n=this.peerConnections.get("main").connection;let o,s={offerSdp:n.localDescription.sdp,answerSdp:e};"plan-b"!==this.sdpDescMode&&(o=this.getAllIdleReceiverTransceivers(n,ok.TRACK_TYPE_AUDIO,s.answerSdp));for(let a=0;a<r;a++){const e=t+a,r="WebAudio".concat(a)+this.rtcSdp.generateSsrcMslabel(),c={videoSsrc:null,audioSsrc:e};if("plan-b"===this.sdpDescMode)s=this.rtcSdp.addUser(s.answerSdp,r,null,c);else{let t=this.rtcSdp.getIdleTransceiverWithSameSsrc(s.answerSdp,o,e);t||(t=await this.addTransceiver(n,ok.TRACK_TYPE_AUDIO,s)),t.direction=t.currentDirection===fP.SEND_ONLY?fP.SEND_RECV:fP.RECV_ONLY,s=this.rtcSdp.modifySdpByMid(s.answerSdp,s.offerSdp,t.mid,r,null,e),await this.setLocalDescriptionShim(n,s.offerSdp)}i(s.streamId,e)}return s}async addUserBatch(e,t){if(t.size<1)return void this.logger.debug(zP,"addUserBatch interrupted for ssrcInfos is null");const r=this.peerConnections.get(e).connection,i=r.remoteDescription.sdp,n=r.localDescription.sdp;let o,s,a={offerSdp:n,answerSdp:i};"plan-b"!==this.sdpDescMode&&(o=this.getAllIdleReceiverTransceivers(r,ok.TRACK_TYPE_AUDIO,i),s=this.getAllIdleReceiverTransceivers(r,ok.TRACK_TYPE_VIDEO,i));for(const[c,u]of t)for(const e of u){if("plan-b"===this.sdpDescMode)a=this.rtcSdp.addUser(a.answerSdp,c,e.streamId,{videoSsrc:e.videoSsrc,audioSsrc:e.audioSsrc}),a.offerSdp=n;else if(e.audioSsrc){let t=this.rtcSdp.getIdleTransceiverWithSameSsrc(a.answerSdp,o,e.audioSsrc);t||(t=await this.addTransceiver(r,ok.TRACK_TYPE_AUDIO,a)),t.direction=t.currentDirection===fP.SEND_ONLY?fP.SEND_RECV:fP.RECV_ONLY,a=this.rtcSdp.modifySdpByMid(a.answerSdp,a.offerSdp,t.mid,c,e.streamId,e.audioSsrc)}else if(e.videoSsrc){let t=this.rtcSdp.getIdleTransceiverWithSameSsrc(a.answerSdp,s,e.videoSsrc);if(t){if(this.isFireFox){t.receiver.track.enabled=!1;const e=setTimeout((()=>{clearTimeout(e),t.receiver.track.enabled=!0}),300)}}else t=await this.addTransceiver(r,ok.TRACK_TYPE_VIDEO,a);t.direction=t.currentDirection===fP.SEND_ONLY?fP.SEND_RECV:fP.RECV_ONLY,a=this.rtcSdp.modifySdpByMid(a.answerSdp,a.offerSdp,t.mid,c,e.streamId,e.videoSsrc)}await this.setLocalDescriptionShim(r,a.offerSdp),await r.setRemoteDescription({type:"answer",sdp:a.answerSdp})}}async addTransceiver(e,t,r){var i;e.addTransceiver(t,{direction:fP.INACTIVE});const n=await e.createOffer();await e.setLocalDescription(n);const o=this.rtcSdp.getLeastMid(n.sdp),s=this.rtcSdp.generateMatchedAnswerWithOffer((null==r?void 0:r.answerSdp)||e.remoteDescription.sdp,o,t);return r&&(r.offerSdp=n.sdp,r.answerSdp=s),await e.setRemoteDescription({type:"answer",sdp:s}),null===(i=e.getTransceivers())||void 0===i?void 0:i.find((e=>"".concat(e.mid)===o))}getConnection(e){var t;return this.isConnectionsExist()&&this.peerConnections.get(e)?null===(t=this.peerConnections.get(e))||void 0===t?void 0:t.connection:null}getConnectionRTT(){let e=0;if(!this.isConnectionsExist())return e;const t=gk.getLatestReport(this.uniqueId,sk.STREAM_TYPE_MAIN);if(t){const r=t.get("candidate-pair");e=r&&r.currentRoundTripTime||0}return e}getICETransportStat(e){if(!e)throw this.logger.error(zP,"getICETransportStat, pcType is null"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"pcType is null");const t=gk.getLatestReport(this.uniqueId,e);if(!t)return null;try{const e=t.get("candidate-pair");return{currentRoundTripTime:e.currentRoundTripTime||0,availableOutgoingBitrate:e.availableOutgoingBitrate||0,bytesSent:e.bytesSent||0,bytesReceived:e.bytesReceived||0}}catch(kD){return this.logger.error(zP,"getICETransportStat failed",kD),null}}getInfo(){return{moduleName:"PeerConnectionsManager"}}async refreshOffer(e){const t=this.peerConnections.get(e).connection,r=await t.createOffer();return await t.setLocalDescription({type:"offer",sdp:this.rtcSdp.transformOfferSdp(r.sdp)}),r}}var GP={exports:{}};!function(e,t){self,e.exports=function(){var e={d:function(t,r){for(var i in r)e.o(r,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:r[i]})},o:function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r:function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{GrsBaseInfo:function(){return O},GrsClient:function(){return M},GrsErrorCode:function(){return s},Logger:function(){return l}});var r=function(e){return"string"!=typeof e||""==e},i=function(e){return void 0===e||null==e||"{}"==JSON.stringify(e)},n=function(e){return!(void 0!==e&&e instanceof Array&&"[]"!=JSON.stringify(e))},o=function(e){if("string"!=typeof e||""==e)return{};try{var t=JSON.parse(e);return void 0===t||null==t?{}:t}catch(e){return{}}},s={ERR_OK:0,ERR_INTERNAL_ERROR:1,ERR_INVALID_PARAM:2,ERR_INIT:3,GRS_SET_ROUTER_DIR:4,GRS_SET_SYSTEM_INFO:5,GRS_SERVICE_CONFIGURE_NO_FILE:6,GRS_SERVICE_CONFIGURE_READ_ERROR:7,GRS_SET_CA_FILE:8,GRS_SERVICE_CONFIGURE_PARSE_ERROR:9,GRS_SERVICE_CONFIGURE_PARSE_VALUE_ERROR:10,GRS_ROUTER_CONFIGURE_EMPTY:11,GRS_ROUTER_APP_CONFIGURE_READ_ERROR:12,GRS_ROUTER_SDK_CONFIGURE_READ_ERROR:13,GRS_ROUTER_CONFIGURE_PARSE_VALUE_ERROR:14,GRS_ROUTER_SERVER_NAME_EMPTY:15,GRS_ROUTER_BY_EMPTY:16,GRS_APK_ROUTER_NO_APPLICATION:17,GRS_NOT_FIND:18,GRS_NOT_FIND_APPLICATION:19,GRS_NOT_FIND_SERVICE_LIST:20,GRS_NOT_FIND_SERVING_COUNTRY_GROUP:21,GRS_NOT_FIND_SERVICE:22,GRS_NOT_FIND_ADDRESS:23,GRS_NOT_FIND_COUNTRY:24};function a(e){return function(e){if(Array.isArray(e))return c(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return c(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?c(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function u(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var l=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,r,i;return t=e,i=[{key:"setExtLogger",value:function(t,r,i){void 0!==t&&"function"==typeof t&&(e.extLogger=t),e.logLevel=r,e.isDebug=i}},{key:"v",value:function(){arguments.length<e.argsSize||(arguments[0]="[Verbose]"+e.TAG_NETWORKKIT_PRE+arguments[0],e.println(e.VERBOSE,arguments))}},{key:"d",value:function(){arguments.length<e.argsSize||(arguments[0]="[Debug]"+e.TAG_NETWORKKIT_PRE+arguments[0],e.println(e.DEBUG,arguments))}},{key:"i",value:function(){arguments.length<e.argsSize||(arguments[0]="[Info]"+e.TAG_NETWORKKIT_PRE+arguments[0],e.println(e.INFO,arguments))}},{key:"w",value:function(){arguments.length<e.argsSize||(arguments[0]="[Warm]"+e.TAG_NETWORKKIT_PRE+arguments[0],e.println(e.WARN,arguments))}},{key:"e",value:function(){arguments.length<e.argsSize||(arguments[0]="[Error]"+e.TAG_NETWORKKIT_PRE+arguments[0],e.println(e.ERROR,arguments))}},{key:"println",value:function(t,r){if((!(t<e.DEBUG)||e.isDebug)&&(e.isDebug||!(t<e.logLevel))&&void 0!==e.extLogger&&"function"==typeof e.extLogger){var i=[].slice.call(r);e.extLogger.apply(e,a(i))}}}],(r=null)&&u(t.prototype,r),i&&u(t,i),Object.defineProperty(t,"prototype",{writable:!1}),e}();d(l,"TAG_NETWORKKIT_PRE","NetworkKit_"),d(l,"extLogger",void 0),d(l,"isDebug",!1),d(l,"VERBOSE",2),d(l,"DEBUG",3),d(l,"INFO",4),d(l,"WARN",5),d(l,"ERROR",6),d(l,"logLevel",l.INFO),d(l,"argsSize",2);var h=function(e,t,i,o,s,a,c,u){var d=e.name,l=t;if(n(e.countryOrAreaGroups)||(l=e.countryOrAreaGroups),n(l))i[d]="GRS_NOT_FIND_SERVING_COUNTRY_GROUP";else{var h=e.routeBy;if(r(h))i[d]="GRS_ROUTER_BY_EMPTY";else if("unconditional"!==h){var m=f(h,s,a,c,u);if(r(m))i[d]="GRS_NOT_FIND_COUNTRY";else{var g=p(l,m);if(r(g))i[d]="GRS_COUNTRY_CODE_NOT_IN_GROUP";else{var _=e.servings,S=!1;for(var v in _)if(_[v].countryOrAreaGroup===g){o[d]=_[v].addresses,S=!0;break}S||(i[d]="GRS_NOT_FIND_ADDRESS")}}}else o[d]=e.servings[0].addresses}},f=function(e,t,i,n,o){var s="",a=e.split(">");for(var c in a){if("ser_country"===a[c]&&!r(t)){s=t;break}if("reg_country"===a[c]&&!r(i)){s=i;break}if("issue_country"===a[c]&&!r(n)){s=n;break}if("geo_ip"===a[c]&&!r(o)){s=o;break}}return s},p=function(e,t){var r="";for(var i in e)if(e[i].countriesOrAreas.includes(t)){r=e[i].id;break}return r},m=function(e,t){var r={};if(i(e))return r;var n=e.errorList;if(!i(n)&&t in n)return r.results=n[t],r.status="failure",r;var o=e.services;return!i(o)&&t in o?(r.results=o[t],r.status="success",r):(r.results="GRS_NOT_FIND_SERVICE",r.status="notFindService",r)},g=function(e,t,r,i){var n="",o=m(e,r);if("success"===o.status&&i in o.results)return l.i("getGrsUrl","Return The Server Cached Data"),o.results[i];l.i("getGrsUrl","Cannot find "+r+"("+i+") in serverUrlInfo: ",JSON.stringify(e));var s=m(t,r);return"success"===s.status&&i in s.results?(l.i("getGrsUrl","Return The Local JSON Data"),n=s.results[i]):l.i("getGrsUrl","Cannot find "+r+"("+i+") in localUrlInfo: ",JSON.stringify(t)),n},_=function(e,t,r){var i={},n=m(e,r);if("success"===n.status)return l.i("getGrsUrl","Return The Server Cached Data"),n.results;l.i("getGrsUrl","Cannot find "+r+" in serverUrlInfo: ",JSON.stringify(e));var o=m(t,r);return"success"===o.status?i=o.results:l.i("getGrsUrl","Cannot find "+r+" in localUrlInfo: ",JSON.stringify(t)),i};function S(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function v(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?S(Object(r),!0).forEach((function(t){y(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):S(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function y(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function I(e){return function(e){if(Array.isArray(e))return T(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return T(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?T(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function T(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}var R=function(e,t,r,i){return new Promise((function(n,o){var s={};(function(e,t){return new Promise((function(r,i){var n=setTimeout((function(){i(new Error("TIMEOUT"))}),t);e.then((function(e){clearTimeout(n),r(e)})).catch((function(e){clearTimeout(n),i(e)}))}))})(fetch(e,{method:"POST",mode:"cors",cache:"no-cache",body:JSON.stringify(t),headers:r,redirect:"follow",referrer:"no-referrer"}),i).then((function(e){s.header=I(e.headers).reduce((function(e,t){return v(v({},e),{},y({},t[0],t[1]))}),{}),s.statusCode=e.status,s.success=!0,s["cache-time"]=(new Date).getTime(),e.json().then((function(e){s.data=e,n(s)}),(function(e){s.success=!1,s.header["cache-control"]="private,max-age=300",s.data=e,s["cache-time"]=(new Date).getTime(),o(s)}))})).catch((function(e){var t={};s.success=!1,t["cache-control"]="private,max-age=300",s.data=e,s.header=t,s["cache-time"]=(new Date).getTime(),o(s)}))}))},E=function(e){return new Promise((function(t,n){var s=e.uniqueCode(),a=o(localStorage.getItem(s)),c="&";if(l.i("getGrsDataFromServerOrCache","Get uniqueCode key From Cache: key(%s): ",s,a),i(a)||r(JSON.stringify(a)))return l.i("getGrsDataFromServerOrCache","The New GrsClient Not any Cache, start to Query GRS Server"),void b(t,e,a,s,c);var u=a.header["cache-control"].split("=");if(a["cache-time"]+1e3*u[1]>=(new Date).getTime())return l.i("getGrsDataFromServerOrCache","During The Suppression Or The Cache Not Expired"),void t(a);c=r(a.header.ETag)?"&":a.header.ETag,b(t,e,a,s,c)}))},b=function(e,t,n,o,s){C(t,s).then((function(t){if(l.d("getGrsDataFromServerOrCache","handleGrsDataFromServer: ",t),t.success){if(200===t.statusCode)return localStorage.setItem(o,JSON.stringify(t)),void e(t);if(304===t.statusCode)return n["cache-time"]=(new Date).getTime(),n.header=t.header,localStorage.setItem(o,JSON.stringify(n)),void e(n);if(503===t.statusCode)return void function(e,t,n,o){i(e)||r(e)?(t.header["cache-control"]="privateï¼max-age="+t.header["Retry-After"],localStorage.setItem(n,JSON.stringify(t)),o(t)):(e["cache-time"]=(new Date).getTime(),e.header["cache-control"]="privateï¼max-age="+t.header["Retry-After"],localStorage.setItem(n,JSON.stringify(e)),o(e))}(n,t,o,e);i(n)||r(n)?(t.header["cache-control"]="privateï¼max-age=300",localStorage.setItem(o,JSON.stringify(t)),e(t)):(n["cache-time"]=(new Date).getTime(),n.header["cache-control"]="privateï¼max-age=300",localStorage.setItem(o,JSON.stringify(n)),e(n))}})).catch((function(t){l.i("getGrsDataFromServerOrCache","handleGrsDataFromServer catch: ",t),i(n)||r(n)?(localStorage.setItem(o,JSON.stringify(t)),e(t)):(n["cache-time"]=(new Date).getTime(),n.header["cache-control"]="privateï¼max-age=300",localStorage.setItem(o,JSON.stringify(n)),e(n))}))},C=function(e,t){var r=e.getServerConfig().grs_server.grs_query_timeout,i=e.getServerConfig().grs_server.grs_base_url,n=e.getServerConfig().grs_server.grs_query_endpoint,o=[];for(var s in i)o.push(i[s]+n+"?"+e.getGrsReqParamJoint());return function(e,t,r,i){l.i("post","urls: ",e);var n=[];return e.forEach((function(e){n.push(R(e,t,r,1e3*i))})),Promise.race(n)}(o,e._servicList,{"Content-Type":"application/json;charset=UTF-8","User-Agent":e.getUserAgent(),"If-None-Match":t},r)};function A(e){return function(e){if(Array.isArray(e))return w(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return w(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?w(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function k(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var O=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.packageName="",this.versionName="",this.productName="",this.productLine="",this.appName="",this.serCountry="",this.regCountry="",this.issueCountry="",this.countrySource="",this.serverConfig={},this.apkRouteConfig={},this.sdkRouteConfig={},this._servicList={services:[]},this._cacheControl=3600,this._serviceName="no_service_name",this._keyName="no_key_name"}var t,n;return t=e,(n=[{key:"setPackageName",value:function(e){this.packageName=e}},{key:"getPackageName",value:function(){return this.packageName}},{key:"setVersionName",value:function(e){this.versionName=e}},{key:"getVersionName",value:function(){return this.versionName}},{key:"setProductName",value:function(e){this.productName=e}},{key:"setProductLine",value:function(e){this.productLine=e}},{key:"getProductLine",value:function(){return this.productLine}},{key:"setAppName",value:function(e){this.appName=e}},{key:"getAppName",value:function(){return this.appName}},{key:"setSerCountry",value:function(e){this.serCountry=e.toUpperCase()}},{key:"getSerCountry",value:function(){return this.serCountry}},{key:"setRegCountry",value:function(e){this.regCountry=e.toUpperCase()}},{key:"getRegCountry",value:function(){return this.regCountry}},{key:"setIssueCountry",value:function(e){this.issueCountry=e.toUpperCase()}},{key:"getIssueCountry",value:function(){return this.issueCountry}},{key:"setCountrySource",value:function(e){this.countrySource=e}},{key:"getCountrySource",value:function(){return this.countrySource}},{key:"setServerConfig",value:function(e){this.serverConfig=e}},{key:"getServerConfig",value:function(){return this.serverConfig}},{key:"setApkRouteConfig",value:function(e){if(!i(e)){if(!e.hasOwnProperty("applications")||!e.hasOwnProperty("services")||!e.hasOwnProperty("countryOrAreaGroups"))return;if(e.applications.length<1)return;this.apkRouteConfig=e,this.appName=e.applications[0].name,e.applications[0].hasOwnProperty("cacheControl")&&(this._cacheControl=e.applications[0].cacheControl);var t=new Set([]),r=e.applications[0].customservices;for(var n in r)t.add(r[n].name);var o=e.services;for(var s in o)t.add(o[s].name);var a=e.applications[0].services;for(var c in a)t.add(a[c]);for(var u in this._servicList.services)t.add(this._servicList.services[u]);this._servicList.services=A(t).sort()}}},{key:"getApkRouteConfig",value:function(){return this.apkRouteConfig}},{key:"setSdkRouteConfig",value:function(e){this.sdkRouteConfig=e;var t=new Set([]);for(var r in e){var i=e[r].services;for(var n in i)t.add(i[n].name)}for(var o in this._servicList.services)t.add(this._servicList.services[o]);this._servicList.services=A(t).sort()}},{key:"getSdkRouteConfig",value:function(){return this.sdkRouteConfig}},{key:"setServiceKeyName",value:function(e,t){this._serviceName=e,this._keyName=t}},{key:"hashCode",value:function(){for(var e=0,t=this.packageName+JSON.stringify(this.serverConfig.grs_server.grs_base_url)+JSON.stringify(this._servicList),r=0;r<t.length;r++)e=Math.imul(31,e)+t.charCodeAt(r)|0;return e}},{key:"uniqueCode",value:function(){return this.appName+"#"+this.serCountry+"#"+this.regCountry+"#"+this.issueCountry+"#"+this.hashCode()}},{key:"getGrsReqParamJoint",value:function(){var e="";return r(this.appName)||(e+="app_name="+this.appName),r(this.versionName)||(r(e)||(e+="&"),e+="app_version="+this.versionName),r(this.packageName)||(r(e)||(e+="&"),e+="package_name="+this.packageName),r(this.serCountry)||(r(e)||(e+="&"),e+="ser_country="+this.serCountry),r(this.regCountry)||(r(e)||(e+="&"),e+="reg_country="+this.regCountry),r(this.issueCountry)||(r(e)||(e+="&"),e+="issue_country="+this.issueCountry),r(this.countrySource)||(r(e)||(e+="&"),e+="country_source="+this.countrySource),e}},{key:"getUserAgent",value:function(){var e,t;try{e=((t=navigator.userAgent.toLowerCase()).indexOf("msie")>0?t.match(/msie [\d.]+;/gi):t.indexOf("firefox")>0?t.match(/firefox\/[\d.]+/gi):t.indexOf("chrome")>0?t.match(/chrome\/[\d.]+/gi):t.indexOf("safari")>0&&t.indexOf("chrome")<0?t.match(/safari\/[\d.]+/gi):void 0)[0].replace("/","; ")}catch(t){e="unknown; web-browser"}return this.packageName+"/"+this.versionName+" ("+e+"; NA) network-grs-web/5.0.9.300 "+this.serviceName}}])&&k(t.prototype,n),Object.defineProperty(t,"prototype",{writable:!1}),e}();function P(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var M=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._grsBaseInfo=t,this._localUrlInfo={},this._serverUrlInfo={},this._cacheExpirationTime=0,this._isLocalInit=!1}var t,a;return t=e,(a=[{key:"initLocal",value:function(){if(!(this._grsBaseInfo instanceof O))return l.i("GrsClient","new GrsClient(grsBaseInfo): the grsBaseInfo not instanceof GrsBaseInfo",this._grsBaseInfo),s.ERR_INVALID_PARAM;l.i("GrsClient","entry initLocal with GrsBaseInfo: ",this._grsBaseInfo);var e,t=(e=this._grsBaseInfo,r(e.packageName)||r(e.versionName)||r(e.productName)||r(e.productLine)?(l.i("checkGrsBaseInfo","The packageName, versionName, productName, productLine Must Be Set",e),s.ERR_INVALID_PARAM):i(e.getServerConfig())?(l.i("checkGrsBaseInfo","The getServerConfig Must Be Set",e),s.GRS_SERVICE_CONFIGURE_NO_FILE):r(e.getAppName())&&i(e.getSdkRouteConfig())?(l.i("checkGrsBaseInfo","Either set the appName or Give the contents of the SDK file",e),s.ERR_INVALID_PARAM):s.ERR_OK);if(t!==s.ERR_OK)return t;var a=function(e,t){var r=[],o=[],a=[],c=[],u={status:s.ERR_OK};if(!i(e)){if(!e.hasOwnProperty("applications")||!e.hasOwnProperty("services")||!e.hasOwnProperty("countryOrAreaGroups"))return l.e("getAllServicesFromLocal","The Apk Route Config File Must has Property: applications, services and countryOrAreaGroups"),u.status=s.GRS_APK_ROUTER_NO_APPLICATION,u.message="GRS_APK_ROUTER_NO_APPLICATION",u;a=e.applications[0].services;var d=e.applications[0].customservices;for(var h in d)o.includes(d[h].name)||(o.push(d[h].name),r.push(d[h]));var f=e.services;for(var p in f)o.includes(f[p].name)||(o.push(f[p].name),r.push(f[p]));c=e.countryOrAreaGroups}if(!i(t))for(var m in t){if(!t[m].hasOwnProperty("services")||!t[m].hasOwnProperty("countryOrAreaGroups"))return l.e("getAllServicesFromLocal","The Sdk Route Config File Must has Property:  services and countryOrAreaGroups"),u.status=s.GRS_ROUTER_SDK_CONFIGURE_READ_ERROR,u.message="GRS_ROUTER_SDK_CONFIGURE_READ_ERROR",u;n(c)&&(c=t[m].countryOrAreaGroups);var g=t[m].services;for(var _ in g)o.includes(g[_].name)||(o.push(g[_].name),r.push(g[_]))}for(var S in a)o.includes(a[S])||o.push(a[S]);return u.services=r,u.countryOrAreaGroups=c,u}(this._grsBaseInfo.getApkRouteConfig(),this._grsBaseInfo.getSdkRouteConfig());if(a.status!=s.ERR_OK)return a.status;this._localUrlInfo=function(e,t,r,n,o,s){var a={},c={};for(var u in e){var d=e[u];h(d,t,a,c,r,n,o,s)}var l={};return i(a)||(l.errorList=a),i(c)||(l.services=c),l}(a.services,a.countryOrAreaGroups,this._grsBaseInfo.getSerCountry(),this._grsBaseInfo.getRegCountry(),this._grsBaseInfo.getIssueCountry(),"");var c=this._grsBaseInfo.uniqueCode(),u=o(localStorage.getItem(c));if(void 0!==u&&null!=u&&"{}"!=JSON.stringify(u)&&u.success&&(200==u.statusCode||304==u.statusCode)){this._serverUrlInfo=u.data;var d=u.header["cache-control"].split("=");this._cacheExpirationTime=u["cache-time"]+1e3*d[1]}return this._isLocalInit=!0,s.ERR_OK}},{key:"syncGetGrsUrl",value:function(e,t){var i=this;return this._grsBaseInfo.setServiceKeyName(e,t),new Promise((function(n,o){if(i._isLocalInit){var s=new Date;if(i._cacheExpirationTime<s.getTime())return l.w("GrsClient","SyncGetGrsUrl: The cache has expired. Request To The server asynchronously"),void E(i._grsBaseInfo).then((function(s){l.i("GrsClient","data: ",s),i._serverUrlInfo=s.data;var a=s.header["cache-control"].split("=");i._cacheExpirationTime=s["cache-time"]+1e3*a[1],s.success&&200===s.statusCode?l.i("GrsClient","Success:  Synchronization of GRS server data",s):l.i("GrsClient","Failure:  Synchronization of GRS server data",s);var c=g(i._serverUrlInfo,i._localUrlInfo,e,t);r(c)?o(new Error("Cannot Get GRS url from serverUrlInfo and localUrlInfo")):n(c)}));var a=g(i._serverUrlInfo,i._localUrlInfo,e,t);r(a)?o(new Error("Cannot Get GRS url from serverUrlInfo and localUrlInfo")):n(a)}else o(new Error("Init() must be Success called before calling the SyncGetGrsUrl()"))}))}},{key:"syncGetGrsUrls",value:function(e){var t=this;return this._grsBaseInfo.setServiceKeyName(e,"no_key_name"),new Promise((function(r,n){if(t._isLocalInit){var o=new Date;if(t._cacheExpirationTime<o.getTime())return l.w("GrsClient","SyncGetGrsUrls: The cache has expired. Request To The server asynchronously"),void E(t._grsBaseInfo).then((function(o){t._serverUrlInfo=o.data;var s=o.header["cache-control"].split("=");t._cacheExpirationTime=o["cache-time"]+1e3*s[1],o.success&&200===o.statusCode?l.i("GrsClient","Success:  Synchronization of GRS server data",o):l.i("GrsClient","Failure:  Synchronization of GRS server data",o);var a=_(t._serverUrlInfo,t._localUrlInfo,e);i(a)?n(new Error("Cannot Get GRS urls from serverUrlInfo and localUrlInfo")):r(a)}));var s=_(t._serverUrlInfo,t._localUrlInfo,e);i(s)?n(new Error("Cannot Get GRS url from serverUrlInfo and localUrlInfo")):r(s)}else n(new Error("Init() must be Success called before calling the SyncGetGrsUrls()"))}))}},{key:"asyncGetGrsUrl",value:function(e,t,r,i){this.syncGetGrsUrl(e,t).then((function(e){r(e)})).catch((function(e){i(e)}))}},{key:"asyncGetGrsUrls",value:function(e,t,r){this.syncGetGrsUrls(e).then((function(e){t(e)})).catch((function(e){r(e)}))}}])&&P(t.prototype,a),Object.defineProperty(t,"prototype",{writable:!1}),e}();return t}()}(GP);const qP={grs_server:{grs_base_url:["https://grs-pub.platform.dbankcloud.com","https://grs-pub.platform.dbankcloud.cn","https://grs-pub.platform.dbankcloud.ru"],grs_query_endpoint:"/grs/2.0/router",grs_query_timeout:2}};function JP(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function XP(e){for(var r=1;r<arguments.length;r++){var i=null!=arguments[r]?arguments[r]:{};r%2?JP(Object(i),!0).forEach((function(r){t(e,r,i[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):JP(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const QP="access",$P="com.huawei.cloud.hianalytics.aspg",ZP="com.huawei.cloud.videortn";var eM,tM,rM;!function(e){e.GLOBAL="GLOBAL",e.ROOT="ROOT"}(eM||(eM={}));class iM{constructor(e){this.logger=e,this.edgeNodeDomains=new Map}async getAccessInfo(e,t){this.edgeNodeDomains.clear();const r=nk.getParameter(ek);if(!e)return this.edgeNodeDomains.set("default",iM.generateUrl(ZP,Ww.grs_sdk_global_route_config_hwrtc.services[0].servings[0].addresses.GLOBAL,r)),this.edgeNodeDomains;const i={id:((null==t?void 0:t.length)||0)+1,domain:"GRS",start_ms:bR.getCurrentTimestamp(),delay_ms:0,stepName:"getAccessInfo",rspCode:"",errMsg:""};let n=null,o=null;try{this.grsClient||(this.grsClient=this.createGrsClient(e)),n=await this.getUrlByGrs(ZP,e,r),o=await this.getUrlByGrs($P,e,r),i.delay_ms=bR.getCurrentTimestamp()-i.start_ms,i.rspCode="ok",i.errMsg="success"}catch(kD){this.logger.error(QP,"getAccessInfo failed: ".concat(kD)),i.delay_ms=bR.getCurrentTimestamp()-i.start_ms,i.rspCode=kD.name,i.errMsg=kD.message}finally{n||(n=this.getDefaultUrlByCountry(ZP,e,r)),this.edgeNodeDomains.set("default",n),o||(o=this.getDefaultUrlByCountry($P,e,r)),qw.setReportServer(o),this.logger.info(QP,"doAccess, accessUrl: ".concat(n,", haUrl: ").concat(o))}return t.push(i),this.edgeNodeDomains}async setOpsUrl(e){this.grsClient||(this.grsClient=this.createGrsClient(e));const t=await this.getUrlByGrs($P,e);qw.setReportServer(t),this.logger.info(QP,"getOpsUrl, haUrl: ".concat(t))}createGrsClient(e){this.logger.info(QP,"createGrsClient, countryCode:".concat(e)),"none"!==MR.logLevel&&GP.exports.Logger.setExtLogger(this.logger[MR.logLevel].bind(this.logger),GP.exports.Logger.ERROR+1-Om.indexOf(MR.logLevel),MR.logLevel===Om[Om.length-1]);const t=new GP.exports.GrsBaseInfo;t.setPackageName("rtc"),t.setVersionName(jC),t.setProductLine("rtsa"),t.setProductName("WEB");const r=nk.getParameter(tk)||{},i=r.grs_server_config||qP,n=tA.getProxyServer(),o=[];if(n)for(const u of i.grs_server.grs_base_url){const e=u.replace(/http(s)?:\/\//,"");o.push("".concat(n,"/").concat(e))}else o.push(...i.grs_server.grs_base_url);const s=XP(XP({},i.grs_server),{grs_base_url:o});t.setServerConfig({grs_server:s}),t.setSdkRouteConfig(r.rtc_webjs_grs_sdk_global_route_config||Ww),t.setApkRouteConfig(r.grs_app_global_route_config||zw),e&&(t.setSerCountry(e),t.setRegCountry(e),t.setIssueCountry(e));const a=new GP.exports.GrsClient(t),c=a.initLocal();if(c!==GP.exports.GrsErrorCode.ERR_OK)throw this.logger.error(QP,"createGrsClient failed,status: ".concat(c)),new qc(Wc.RTC_ERR_CODE_RTC_SDK_ERROR,"createGrsClient failed,status: ".concat(c));return this.logger.info(QP,"createGrsClient success"),a}async getUrlByGrs(e,t,r){let i=null;try{this.logger.info(QP,"getGrsUrl begin, serviceName:".concat(e,", countryCode:").concat(t,", envInfo:").concat(JSON.stringify(r||{})));const n=e===ZP?iM.getGrsKey(t,r):eM.ROOT;this.logger.info(QP,"getGrsUrl , serviceName:".concat(e,", envKey:").concat(n));const o=await this.grsClient.syncGetGrsUrl(e,n);i=o?iM.generateUrl(e,o,r):this.getDefaultUrlByCountry(e,t,r),this.logger.info(QP,"getGrsUrl for serviceName:".concat(e," success:").concat(i))}catch(kD){this.logger.error(QP,"serviceName:".concat(e," failed to getGrsUrl: ").concat(kD))}finally{i||(i=this.getDefaultUrlByCountry(e,t,r))}return i}getDefaultUrlByCountry(e,t,r){let i=null;if(e===ZP){const e=Ww.grs_sdk_global_route_config_hwrtc.countryOrAreaGroups;let r="DR1";for(const i of e)if(i.countriesOrAreas.includes(t)){r=i.id;break}const n=Ww.grs_sdk_global_route_config_hwrtc.services[0].servings;for(const t of n)if(t.countryOrAreaGroup===r){i=t.addresses.ROOT;break}}else{const e=Ww.grs_sdk_global_route_config_rtcha.countryOrAreaGroups;let r="DR1";for(const i of e)if(i.countriesOrAreas.includes(t)){r=i.id;break}const n=Ww.grs_sdk_global_route_config_rtcha.services[1].servings;for(const t of n)if(t.countryOrAreaGroup===r){i=t.addresses.ROOT;break}}return iM.generateUrl(e,i,r)}static getGrsKey(e,t){return t?t.grsKey:e?eM.ROOT:eM.GLOBAL}static generateUrl(e,t,r){return e===$P?t:(r=r||{grsKey:"",pathSuffix:""}).pathSuffix?"".concat(t,"/websocket/").concat(r.pathSuffix):t+"/websocket"}}!function(e){e.joinRoom="JOIN_ROOM_SUC",e.exitRoom="EXIT_ROOM",e.disableVideo="DISABLE_VIDEO",e.disableAudio="DISABLE_AUDIO",e.enableVideo="ENABLE_VIDEO",e.enableAudio="ENABLE_AUDIO"}(tM||(tM={})),function(e){e[e.subscribe=0]="subscribe",e[e.unsubscribe=1]="unsubscribe"}(rM||(rM={}));const nM={LD:{streamUid:-999,pssrc:999,width:160,height:90},SD:{streamUid:-3,pssrc:3,width:320,height:180},HD:{streamUid:-2,pssrc:2,width:640,height:360},FHD:{streamUid:-1,pssrc:1,width:1280,height:720},LD_1:{streamUid:-999,pssrc:999,width:160,height:90},SD_2:{streamUid:-3,pssrc:3,width:320,height:180},HD_3:{streamUid:-2,pssrc:2,width:640,height:360},FHD_4:{streamUid:-1,pssrc:1,width:1280,height:720}};var oM;!function(e){e[e.audio=0]="audio",e[e.mainVideo=1]="mainVideo",e[e.auxVideo=2]="auxVideo"}(oM||(oM={}));const sM="RemoteUserManager";class aM{constructor(e){this.client=e,this.logger=e.logger,this.remoteUserInfos=new Map,this.previousAudioSubscribedUsers=new Map,this.roomSsrc=new Map}checkSsrcIsMute(e){let t=!0;return this.remoteUserInfos.forEach((r=>{r.userState===lk.Joined&&(r.mainStream&&r.mainStream.remoteTrackInfos&&r.mainStream.remoteTrackInfos.forEach((r=>{r.cssrc===e&&(t=r.mute)})),r.auxStream&&r.auxStream.remoteTrackInfos&&r.auxStream.remoteTrackInfos.forEach((r=>{r.cssrc===e&&(t=r.mute)})))})),t}checkRemoteTop3NeedReport(){let e=0;return this.remoteUserInfos.forEach((t=>{t.userState===lk.Joined&&t.mainStream&&t.mainStream.remoteTrackInfos&&t.mainStream.remoteTrackInfos.forEach((t=>{t.type===ok.TRACK_TYPE_AUDIO&&e++}))})),!(e<3)}initialize(e,t){e&&t&&(this.localUserId=e,this.audioCssrcs=this.getCssrcRangeByType(t,oM.audio),this.mainVideoCssrcs=this.getCssrcRangeByType(t,oM.mainVideo),this.auxVideoCssrcs=this.getCssrcRangeByType(t,oM.auxVideo))}getStreamInfoByPStreamUid(e){let t=null;return Array.from(this.remoteUserInfos.values()).forEach((r=>{var i,n,o;if(null!==(i=r.mainStream)&&void 0!==i&&i.remoteTrackInfos.get(e.toString()))t=null===(o=r.mainStream)||void 0===o?void 0:o.remoteTrackInfos.get(e.toString());else if(null!==(n=r.auxStream)&&void 0!==n&&n.remoteTrackInfos.get(e.toString())){var s;t=null===(s=r.auxStream)||void 0===s?void 0:s.remoteTrackInfos.get(e.toString())}})),t}getCssrcRangeByType(e,t){if(!e)throw this.logger.error(sM,"sdpRepInfo is null"),new qc(Wc.RTC_ERR_CODE_RTC_SDK_ERROR);const r=t===oM.audio?e.audio:t===oM.mainVideo?e.video:e.desktopVideo,i=null==r?void 0:r.receiveSsrcBegin,n=null==r?void 0:r.receiveSsrcEnd;if(!i||!n||i>=n)throw this.logger.error(sM,"begin or end is invalid"),new qc(Wc.RTC_ERR_CODE_RTC_SDK_ERROR);return aM.getCssrcRange(i,n)}static getCssrcRange(e,t){const r=[];let i;for(i=e;i<=t;i++)r.push(i);return r}refreshRemoteUserList(e,t,r){const i=[],n=this.getUserStreamUpdatedList(e,t);return n?(n.addedUsers.forEach((t=>{const n=this.addUser(t,e,r);n&&i.push(n)})),n.updatedUsers.forEach((t=>{const n=this.updateUser(t,e,r);n&&i.push(n)})),n.removedUsers.forEach((t=>{const n=this.removeUser(t,e,r);n&&i.push(n)})),this.logger.info(sM,"refreshRemoteUserStreamList success, ".concat(this.getTracksUpdateInfosString(i))),i):null}addUser(e,t,r){return this.updateUser(e,t,r)}updateUser(e,t,r){var i,n,o;if(e.userId===this.localUserId)return null;const s={userId:e.userId,userUid:e.userUid,nickname:e.appData.nickname,roomId:t,relaySrcRoomId:null===(i=e.relayUserSrcInfo)||void 0===i?void 0:i.roomId},a=null===(n=e.videoStreams)||void 0===n?void 0:n.filter((e=>e.content!==iC.desktop)),c=null===(o=e.videoStreams)||void 0===o?void 0:o.filter((e=>e.content===iC.desktop)),u=e.audioStreams,d=this.getUserInfoById(s.userId,s.roomId),l=this.doRefreshRemoteStreamList(s,sk.STREAM_TYPE_MAIN,a,u,r),h=this.doRefreshRemoteStreamList(s,sk.STREAM_TYPE_AUX,c,null,r),f=this.getUserInfoById(s.userId,s.roomId);return{userInfo:f.userInfo,preUserState:d?f.userState:lk.NotJoin,curUserState:f.userState,isUserNameChanged:null,mainStream:l,auxStream:h}}removeUser(e,t,r){if(e.userId===this.localUserId)return null;const i={userId:e.userId,userUid:e.userUid,nickname:e.appData.nickname,roomId:t};this.doRefreshRemoteStreamList(i,sk.STREAM_TYPE_MAIN,[],[],r),this.doRefreshRemoteStreamList(i,sk.STREAM_TYPE_AUX,[],[],r);const n={status:tM.exitRoom,userId:e.userId,userUid:e.userUid},o=this.updateUserListInfo(t,[n]);return o&&0!==o.length?o[0]:null}getUserStreamUpdatedList(e,t){const r=this.getAllUserInfos(e),i=[],n=[],o=[];return r.forEach((e=>{if(e.userInfo.userId===oC)return;const r=t.find((t=>t.userId===e.userInfo.userId)),i=this.getAllTracksByMediaType(e.userInfo.roomId,e.userInfo.userId,ok.TRACK_TYPE_VIDEO),s=this.getAllTracksByMediaType(e.userInfo.roomId,e.userInfo.userId,ok.TRACK_TYPE_AUDIO);if(r){r.audioStreams&&(r.audioStreams=r.audioStreams.filter((e=>"main"===e.content)));const e={userId:r.userId,userUid:r.userUid,appData:r.appData,videoStreams:r.videoStreams,audioStreams:r.audioStreams,relayUserSrcInfo:r.relayUserSrcInfo};n.push(e)}else{const t=i.map((e=>({content:e.content,codec:e.codec,fps:e.fps,height:e.height,maxFs:e.maxFs,maxMbps:e.maxMbps,mute:e.mute,pt:e.pt,ssrc:e.pssrc,streamData:e.streamData,streamUid:parseInt(e.trackId),width:e.width}))),r=s.map((e=>({content:e.content,codec:e.codec,maxMbps:e.maxMbps,mute:e.mute,pt:e.pt,ssrc:e.pssrc,streamData:e.streamData,streamUid:parseInt(e.trackId),channels:e.channels,sampleRate:e.sampleRate}))),n={userId:e.userInfo.userId,userUid:e.userInfo.userUid,appData:{nickname:e.userInfo.nickname},videoStreams:t,audioStreams:r};o.push(n)}})),t.forEach((e=>{if(!r.some((t=>t.userInfo.userId===e.userId))){e.audioStreams&&(e.audioStreams=e.audioStreams.filter((e=>"main"===e.content)));const t={userId:e.userId,userUid:e.userUid,appData:e.appData,videoStreams:e.videoStreams,audioStreams:e.audioStreams,relayUserSrcInfo:e.relayUserSrcInfo};i.push(t)}})),{addedUsers:i,updatedUsers:n,removedUsers:o}}updateUserListInfo(e,t){if(!t||!e)return null;const r=[],i=[];return t.forEach((t=>{var n;const o={userId:t.userId,userUid:t.userUid,roomId:e,nickname:t.appData?t.appData.nickname:null,relaySrcRoomId:null===(n=t.relayUserSrcInfo)||void 0===n?void 0:n.roomId},s=this.updateUserInfo(o,t.status);s&&r.push(s),i.push(t.userId)})),r.push(...this.getOtherRemoteUserPublishInfos(i,e)),this.logger.info(sM,"updateUserListInfo success, ".concat(this.getTracksUpdateInfosString(r))),r}updateUserInfo(e,t){if(this.logger.info(sM,"updateUserInfo begin, updateType:".concat(t,", userInfo: ").concat(JSON.stringify(e))),e.userId===this.localUserId)return null;const r=this.getUserInfoById(e.userId,e.roomId),i=r?r.userState:lk.NotJoin,n=!!r&&aM.isUserNameChanged(r.userInfo,null==e?void 0:e.nickname);switch(t){case tM.exitRoom:if(!r)return this.logger.error(sM,"remote user leaveï¼ but user not exist"),null;break;case tM.joinRoom:r||this.initializeRemoteUser(e,!0);break;default:this.logger.error(sM,"updateUserInfo, unknown user status:".concat(t))}const o=this.getUserInfoById(e.userId,e.roomId),s=t===tM.joinRoom?aM.getUserUpdateInfoWhenJoin(i,n,o):aM.getUserUpdateInfoWhenQuit(i,o);if(t===tM.exitRoom&&o.userState===lk.NotJoin){const t=aM.generateUniqueId(e.userId,e.roomId);this.remoteUserInfos.delete(t)}return s}static getUserUpdateInfoWhenJoin(e,t,r){return r.userState=e===lk.Rejoining?lk.Joined:r.userState,{userInfo:r.userInfo,preUserState:e,curUserState:r.userState,isUserNameChanged:t,mainStream:null,auxStream:null}}static getUserUpdateInfoWhenQuit(e,t){return t.userState=e===lk.Rejoining?e:lk.NotJoin,{userInfo:t.userInfo,preUserState:e,curUserState:t.userState,isUserNameChanged:null,mainStream:aM.getStreamListUpdateInfoWhenQuitOrRejoin(t,sk.STREAM_TYPE_MAIN,e),auxStream:aM.getStreamListUpdateInfoWhenQuitOrRejoin(t,sk.STREAM_TYPE_AUX,e)}}static getStreamListUpdateInfoWhenQuitOrRejoin(e,t,r){return r===lk.Rejoining?aM.getStreamListUpdateInfoWhenRejoin(e,t):aM.getStreamListUpdateInfoWhenQuit(e,t)}static getStreamListUpdateInfoWhenQuit(e,t){const r=t===sk.STREAM_TYPE_MAIN?e.mainStream:e.auxStream,i=aM.getRemoteTrackInfos(r),n=null==i?void 0:i.filter((e=>e.isSubscribed));return{remoteStream:null==r?void 0:r.remoteStream,preTracks:i,curTracks:i,addedTracks:[],updatedTracks:[],removedTracks:i,subscribedTracks:n,tracks4Subscribe:[],tracks4Unsubscribe:n,allSubscribeTracks:[]}}static getStreamListUpdateInfoWhenRejoin(e,t){const r=t===sk.STREAM_TYPE_MAIN?e.mainStream:e.auxStream,i=aM.getRemoteTrackInfos(r),n=null==i?void 0:i.filter((e=>e.isSubscribed));return{remoteStream:null==r?void 0:r.remoteStream,preTracks:i,curTracks:i,addedTracks:[],updatedTracks:[],removedTracks:i,subscribedTracks:n,tracks4Subscribe:[],tracks4Unsubscribe:[],allSubscribeTracks:n}}getTracks4UnSubscribe(e){if(!e)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);const t=[];return e.forEach((e=>{e.isSubscribed&&(e.isSubscribed=!1,t.push(e))})),this.logger.info(sM,"getTracks4UnSubscribe success, tracks4Unsubscribe: ".concat(JSON.stringify(t))),t}cachePlayInfo(e,t,r,i,n){if(!n)return;const o=this.getUserInfoById(e.userId,e.roomId),s=t===sk.STREAM_TYPE_MAIN?o.mainStream:o.auxStream,a=null==s?void 0:s.subscribeOption;return a?aM.isStreamRemoved(r,i)?(a.audio=!1,a.video=!1,void(a.resolutions=null)):void n.forEach((e=>{if(e.isSubscribed){if(a.audio&&e.type===ok.TRACK_TYPE_AUDIO){var t;const r=null==s||null===(t=s.remoteStream)||void 0===t?void 0:t.getAudioHRTCTrack();r&&(a.audioPlayInfo.playElement=r.getElementId(),a.audioPlayInfo.objectFit=r.getObjectFit(),a.audioPlayInfo.muted=r.getTrackMuted(),e.muted=r.getTrackMuted())}if(a.video&&e.type===ok.TRACK_TYPE_VIDEO){var r;const t=null==s||null===(r=s.remoteStream)||void 0===r?void 0:r.getVideoHRTCTrackByTrackId(e.trackId);if(t){var i;const r=null===(i=a.resolutions)||void 0===i?void 0:i.find((t=>t.resolutionId===e.trackId));r&&(r.playElement=t.getElementId(),r.objectFit=t.getObjectFit(),r.muted=t.getTrackMuted(),e.muted=t.getTrackMuted())}}}})):void 0}static isStreamRemoved(e,t){return!(e&&0!==e.length||t&&0!==t.length)}getTracks4Subscribe(e,t,r,i,n){if(this.logger.debug(sM,"getTracks4Subscribe begin"),!(i&&0!==i.length||n&&0!==n.length))return this.logger.debug(sM,"getTracks4Subscribe success, tracks4Subscribe: []"),[];const o=n.filter((e=>e.isSubscribed)),s=[],a=this.isAudioTrackNeedSubscribe(e.userId,e.roomId,t),c=i.find((e=>e.type===ok.TRACK_TYPE_AUDIO));if(a&&c){c.cssrc=this.allocateAudioReceiveSsrc(e.roomId),c.isSubscribed=!0,c.state=hk.resolutionChange;const r=this.getAudioTrackPlayInfo(e.userId,e.roomId,t);r&&(c.playElement=r.playElement,c.objectFit=r.objectFit,c.muted=r.muted);const i=o.find((e=>e.type===ok.TRACK_TYPE_AUDIO));i&&(c.state=i.state,c.muted=i.muted),s.push(c)}const u=o.filter((e=>e.type===ok.TRACK_TYPE_VIDEO)),d=i.filter((e=>e.type===ok.TRACK_TYPE_VIDEO));for(const l of d){const r={resolutionId:l.trackId,width:l.width,height:l.height};if(this.updateVideoSubscribeOption(e.userId,e.roomId,t,r,u)){l.cssrc=this.allocateVideoReceiveSsrc(e.roomId,t),l.isSubscribed=!0,l.state=hk.resolutionChange;const i=this.getVideoTrackPlayInfo(e.userId,e.roomId,t,r);i&&(l.playElement=i.playElement,l.objectFit=i.objectFit,l.muted=i.muted);const n=this.getTrack4Replace(l,u);n&&n.state!==hk.normal&&(l.state=n.state,l.muted=n.muted),s.push(l)}}return this.logger.info(sM,"getTracks4Subscribe success, tracks4Subscribe: ".concat(JSON.stringify(s))),s}getAudioTrackPlayInfo(e,t,r){var i;const n=this.getUserInfoById(e,t);return null===(i=(r===sk.STREAM_TYPE_MAIN?n.mainStream:n.auxStream).subscribeOption)||void 0===i?void 0:i.audioPlayInfo}getVideoTrackPlayInfo(e,t,r,i){var n,o;const s=this.getUserInfoById(e,t),a=null===(n=(r===sk.STREAM_TYPE_MAIN?s.mainStream:s.auxStream).subscribeOption)||void 0===n||null===(o=n.resolutions)||void 0===o?void 0:o.find((e=>e.resolutionId===i.resolutionId));return a?{playElement:a.playElement,objectFit:a.objectFit,muted:a.muted}:null}updateVideoSubscribeOption(e,t,r,i,n){const o=this.getUserInfoById(e,t),s=r===sk.STREAM_TYPE_MAIN?o.mainStream:o.auxStream,a=null==s?void 0:s.subscribeOption;if(!a)return!1;if(!a.video)return!1;const c=a.resolutions.find((e=>e.resolutionId===i.resolutionId||e.height===i.height&&e.width===i.width||(null==n?void 0:n.length)));return c&&(c.resolutionId=i.resolutionId),!!c}enableTopThreeAudioMode(e){const t=this.getAllUserInfos(e);null==t||t.forEach((e=>{var t,r;null!==(t=e.mainStream)&&void 0!==t&&t.subscribeOption&&(e.mainStream.subscribeOption.audio=!1),null!==(r=e.auxStream)&&void 0!==r&&r.subscribeOption&&(e.auxStream.subscribeOption.audio=!1)})),this.logger.info(sM,"enableTopThreeAudioMode success")}isAudioTrackNeedSubscribe(e,t,r){var i;const n=this.getUserInfoById(e,t),o=r===sk.STREAM_TYPE_MAIN?n.mainStream:n.auxStream;return null==o||null===(i=o.subscribeOption)||void 0===i?void 0:i.audio}getTrack4Replace(e,t){return(null==t?void 0:t.find((t=>t.trackId===e.trackId||t.height===e.height&&t.width===e.width)))||(null!=t&&t.length?t[0]:null)}getAllUserStreamsByType(e,t,r){return this.getAllUserInfos(e).map((i=>{const n=t&&t!==sk.STREAM_TYPE_MAIN?null:aM.getStreamInfoByType(i,sk.STREAM_TYPE_MAIN,r),o=t&&t!==sk.STREAM_TYPE_AUX?null:aM.getStreamInfoByType(i,sk.STREAM_TYPE_AUX,r);return{userId:i.userInfo.userId,roomId:e,mainStream:n,auxStream:o}}))}static getStreamInfoByType(e,t,r){const i=t===sk.STREAM_TYPE_MAIN?e.mainStream:e.auxStream,n=aM.getRemoteTrackInfos(i),o=aM.getTracksByType(n,r);return{remoteStream:i?i.remoteStream:null,tracks:o}}getUserInfoById(e,t){const r=aM.generateUniqueId(e,t);return this.remoteUserInfos.get(r)}getUserInfoByUid(e,t){let r=null;for(const i of this.remoteUserInfos.values())if(i.userInfo.userUid===e&&i.userInfo.roomId===t){r=i;break}return r}static getTracksByType(e,t){return e&&0!==e.length?t?e.filter((e=>e.type===t)):e:[]}static isUserNameChanged(e,t){return t&&e&&e.nickname&&e.nickname!==t}static getRemoteTrackInfos(e){return null!=e&&e.remoteTrackInfos?Array.from(e.remoteTrackInfos.values()):null}getAllTracksByMediaType(e,t,r){var i,n;const o=aM.generateUniqueId(t,e),s=this.remoteUserInfos.get(o);if(!s)return null;const a=[],c=null===(i=aM.getRemoteTrackInfos(s.mainStream))||void 0===i?void 0:i.filter((e=>e.type===r));c&&a.push(...c);const u=null===(n=aM.getRemoteTrackInfos(s.auxStream))||void 0===n?void 0:n.filter((e=>e.type===r));return u&&a.push(...u),a}getMaxResolutionTrack(e){let t;for(const r of e)r.type!==ok.TRACK_TYPE_AUDIO&&(t?Math.max(r.width,r.height)-Math.max(t.width,t.height)>0&&(t=r):t=r);return this.logger.info(sM,"getMaxResolutionTrackId, maxResolution: ".concat(JSON.stringify(t))),t}getMaxResolutionTrackId(e){var t;if(!e)return null;const r=Array.from(e.remoteTrackInfos.values());let i;for(const n of r)n.type!==ok.TRACK_TYPE_AUDIO&&(i?Math.max(n.width,n.height)-Math.max(i.width,i.height)>0&&(i=n):i=n);return this.logger.info(sM,"getMaxResolutionTrackId, maxResolution: ".concat(JSON.stringify(i))),null===(t=i)||void 0===t?void 0:t.trackId}getAllSubscribedMainStream(e){const t=this.getAllUserInfos(e),r=[];return t.forEach((e=>{var t;null!==(t=e.mainStream)&&void 0!==t&&t.remoteTrackInfos&&Array.from(e.mainStream.remoteTrackInfos.values()).some((e=>e.isSubscribed))&&r.push(e)})),r}batchSubscribeMainStream(e,t){if(!e||!t)return null;const r=this.getAllSubscribedMainStream(e),i=[],n=t.find((e=>e.userId===oC));if(n){this.getUserInfoById(oC,e)||this.createRemoteShadowUser(e,n.resolutionIds)}return this.getAllUserInfos(e).forEach((n=>{const o=t.find((e=>e.userId===n.userInfo.userId));if(o){const t={video:!0,audio:!1,resolutionIds:o.resolutionIds,autoAdjustResolution:o.autoAdjustResolution,minResolution:o.minResolution},r=this.subscribeSingleStream(o.userId,e,sk.STREAM_TYPE_MAIN,t,ak.TOPN_AUDIOPOLICY,!0);i.push(r)}else{var s;const e=aM.getRemoteTrackInfos(n.mainStream),o=null==e?void 0:e.filter((e=>e.isSubscribed)),a=this.needUnsubscribeMainStream(n,t,r),c=aM.getAnotherStreamUpdateInfo(sk.STREAM_TYPE_MAIN,n),u={userInfo:n.userInfo,curUserState:n.userState,preUserState:n.userState,mainStream:{remoteStream:null===(s=n.mainStream)||void 0===s?void 0:s.remoteStream,preTracks:e,curTracks:e,addedTracks:null,updatedTracks:null,removedTracks:null,subscribedTracks:o,tracks4Subscribe:null,tracks4Unsubscribe:o,allSubscribeTracks:a?null:o},auxStream:c};i.push(u)}})),this.logger.info(sM,"batchSubscribeMainStream success, infos: ".concat(this.getTracksUpdateInfosString(i))),i}needUnsubscribeMainStream(e,t,r){const i=!t.some((t=>t.userId===e.userInfo.userId)),n=r.some((t=>e.userInfo.userId===t.userInfo.userId));return i&&n}createRemoteShadowUser(e,t){const r={userId:oC,userUid:sC,nickname:"",roomId:e},i=[];null==t||t.forEach((e=>{const t=nM[e]||nM.LD,r={content:iC.main,ssrc:t.pssrc,streamUid:t.streamUid,pt:gP.h264PayLoad,width:t.width,height:t.height};i.push(r)})),this.doRefreshRemoteStreamList(r,sk.STREAM_TYPE_MAIN,i,null,!1),this.logger.info(sM,"createRemoteShadowUser success, upstreams: ".concat(JSON.stringify(i)))}subscribeResultCallback(e,t){if(e)try{e.successSubscribeInfos.forEach((e=>{var t,r,i,n;null===(t=e.mainStream)||void 0===t||null===(r=t.tracks)||void 0===r||r.forEach((e=>{e.state=hk.normal})),null===(i=e.auxStream)||void 0===i||null===(n=i.tracks)||void 0===n||n.forEach((e=>{e.state=hk.normal}))})),e.failSubscribeInfos.forEach((e=>this.releaseResource(e,t))),e.successUnsubscribeInfos.forEach((e=>this.releaseResource(e,!1))),e.failUnsubscribeInfos.forEach((e=>this.recoverUnsubscribeResource(e,t))),this.logger.info(sM,"subscribeResultCallback success")}catch(kD){this.logger.error(sM,"subscribeResultCallback fail, errMsg:".concat(kD))}}releaseResource(e,t){var r,i,n,o;const s=this.getUserInfoById(e.userId,e.roomId);null==e||null===(r=e.mainStream)||void 0===r||null===(i=r.tracks)||void 0===i||i.forEach((r=>{if(this.unAllocateReceiveSsrc(e.roomId,sk.STREAM_TYPE_MAIN,r.type,r.cssrc),r.state=hk.normal,r.isSubscribed=!1,r.isTrackReady=!1,r.cssrc=0,t){const e=s.mainStream.subscribeOption;aM.recoverUnsubscribeOption(e,r)}})),null==e||null===(n=e.auxStream)||void 0===n||null===(o=n.tracks)||void 0===o||o.forEach((r=>{if(this.unAllocateReceiveSsrc(e.roomId,sk.STREAM_TYPE_AUX,r.type,r.cssrc),r.state=hk.normal,r.isSubscribed=!1,r.isTrackReady=!1,r.cssrc=0,t){const e=s.mainStream.subscribeOption;aM.recoverUnsubscribeOption(e,r)}}))}recoverUnsubscribeResource(e,t){var r,i,n,o;const s=this.getUserInfoById(e.userId,e.roomId);null==e||null===(r=e.mainStream)||void 0===r||null===(i=r.tracks)||void 0===i||i.forEach((r=>{var i;this.recoverReceiveSsrc(e.roomId,sk.STREAM_TYPE_MAIN,r.type,r.cssrc),r.isSubscribed=!0;const n=null===(i=s.mainStream)||void 0===i?void 0:i.remoteTrackInfos;if(n.has(r.trackId)||n.set(r.trackId,r),t){const e=s.mainStream.subscribeOption;aM.recoverSubscribeOption(e,r)}})),null==e||null===(n=e.auxStream)||void 0===n||null===(o=n.tracks)||void 0===o||o.forEach((r=>{var i;this.recoverReceiveSsrc(e.roomId,sk.STREAM_TYPE_AUX,r.type,r.cssrc),r.isSubscribed=!0;const n=null===(i=s.auxStream)||void 0===i?void 0:i.remoteTrackInfos;if(n.has(r.trackId)||n.set(r.trackId,r),t){const e=s.mainStream.subscribeOption;aM.recoverSubscribeOption(e,r)}}))}static recoverSubscribeOption(e,t){if(t.type===ok.TRACK_TYPE_AUDIO)e.audio=!0;else{e.video=!0;const r={resolutionId:t.trackId,width:t.width,height:t.height};e.resolutions.push(r)}}static recoverUnsubscribeOption(e,t){if(t.type===ok.TRACK_TYPE_AUDIO)e.audio=!1;else{if(!e.video)return;e.resolutions?e.resolutions.forEach((t=>{var r;const i=null==e||null===(r=e.resolutions)||void 0===r?void 0:r.map((e=>e.resolutionId)).indexOf(t.resolutionId);i>-1&&e.resolutions.splice(i,1)})):(e.video=!1,e.resolutions=null)}}subscribeStream(e,t,r,i,n,o,s){const a=this.subscribeSingleStream(e,t,r,i,n,o),c=[];if(s&&(s.streamIds=[]),a){c.push(a);(r===sk.STREAM_TYPE_MAIN?a.mainStream.tracks4Subscribe:a.auxStream.tracks4Subscribe).forEach((e=>{e.trackId&&s&&s.streamIds.push(e.trackId)}))}return c.push(...this.getOtherRemoteUserPublishInfos([e],t)),this.logger.info(sM,"subscribeStream success, ".concat(this.getTracksUpdateInfosString(c))),c}subscribeSingleStream(e,t,r,i,n){var o,s;let a=arguments.length>5&&void 0!==arguments[5]&&arguments[5],c=arguments.length>6&&void 0!==arguments[6]&&arguments[6];if(!e||!t||!i)return null;const u=this.getUserInfoById(e,t);if(!u)return this.logger.error(sM,"subscribeStream fail, user not exist}"),null;const d=[],l=[],h=[],f=aM.getRemoteTrackInfos(u.mainStream),p=aM.getRemoteTrackInfos(u.auxStream),m=r===sk.STREAM_TYPE_MAIN?f:p,g=null==m?void 0:m.filter((e=>e.isSubscribed));this.updateAudioTrackSubInfo(r,i,c,u,n,d,l,h),this.updateVideoTrackSubInfo(r,i,a,u,d,l,h),this.updateSubscribeOption(e,t,r,i,rM.subscribe);const _={remoteStream:r===sk.STREAM_TYPE_MAIN?null===(o=u.mainStream)||void 0===o?void 0:o.remoteStream:null===(s=u.auxStream)||void 0===s?void 0:s.remoteStream,preTracks:m,curTracks:m,addedTracks:null,updatedTracks:null,removedTracks:null,subscribedTracks:g,tracks4Subscribe:d,tracks4Unsubscribe:l,allSubscribeTracks:h},S=aM.getAnotherStreamUpdateInfo(r,u);return{curUserState:u.userState,preUserState:u.userState,userInfo:u.userInfo,mainStream:r===sk.STREAM_TYPE_MAIN?_:S,auxStream:r===sk.STREAM_TYPE_AUX?_:S}}resubscribeMainStreamAudio(e){const t=this.previousAudioSubscribedUsers.get(e),r=t?Array.from(t.values()):null;if(this.logger.info(sM,"resubscribeMainStreamAudio, preAudioSubscribedUsers:  ".concat(r)),!r)return null;const i={video:!1,audio:!0},n=[];r.forEach((t=>{var r,o;const s=this.subscribeSingleStream(t,e,sk.STREAM_TYPE_MAIN,i,ak.USER_SUBSCRIBE_AUDIOPOLICY);(null==s||null===(r=s.mainStream)||void 0===r||null===(o=r.tracks4Subscribe)||void 0===o?void 0:o.length)>0&&n.push(s)}));const o=[];return o.push(...n),o.push(...this.getOtherRemoteUserPublishInfos(r,e)),this.logger.info(sM,"resubscribeMainStreamAudio success, ".concat(this.getTracksUpdateInfosString(o))),n}unsubscribeAllMainStreamAudio(e){const t={video:!1,audio:!0},r=[],i=[];return this.getAllUserInfos(e).forEach((n=>{var o;if(null!==(o=n.mainStream)&&void 0!==o&&o.remoteTrackInfos?Array.from(n.mainStream.remoteTrackInfos.values()).some((e=>e.type===ok.TRACK_TYPE_AUDIO&&e.isSubscribed)):null){i.push(n.userInfo.userId);const o=this.unsubscribeSingleStream(n.userInfo.userId,e,sk.STREAM_TYPE_MAIN,t,ak.TOPN_AUDIOPOLICY);r.push(o)}})),r.push(...this.getOtherRemoteUserPublishInfos(i,e)),this.logger.info(sM,"unsubscribeAllMainStreamAudio success, ".concat(this.getTracksUpdateInfosString(r))),r}updateAudioTrackSubInfo(e,t,r,i,n,o,s,a){if(!i)return;const c=aM.getRemoteTrackInfos(i.mainStream),u=aM.getRemoteTrackInfos(i.auxStream),d=e===sk.STREAM_TYPE_MAIN?c:u,l=null==d?void 0:d.find((e=>e.type===ok.TRACK_TYPE_AUDIO));if(!l)return void this.logger.info(sM,"updateAudioTrackSubInfo: ".concat(e,", no audio track exist"));const h=l.isSubscribed?l:null;if(t.audio&&!l.isSubscribed){n===ak.USER_SUBSCRIBE_AUDIOPOLICY?(l.isSubscribed=!0,l.cssrc=this.allocateAudioReceiveSsrc(i.userInfo.roomId),o.push(l)):this.logger.warn(sM,"updateAudioTrackSubInfo, not common audio mode, but audio option is true, reserve it");const e=this.previousAudioSubscribedUsers.get(i.userInfo.roomId);null==e||e.set(i.userInfo.userId,i.userInfo.userId)}if((h||!h&&o.some((e=>e.type===ok.TRACK_TYPE_AUDIO)))&&a.push(l),r&&!t.audio&&h){l.isSubscribed=!1,s.push(l);const e=this.previousAudioSubscribedUsers.get(i.userInfo.roomId);null==e||e.delete(i.userInfo.userId)}}updateVideoTrackSubInfo(e,t,r,i,n,o,s){const a=aM.getRemoteTrackInfos(i.mainStream),c=aM.getRemoteTrackInfos(i.auxStream),u=e===sk.STREAM_TYPE_MAIN?a:c,d=null==u?void 0:u.filter((e=>e.type===ok.TRACK_TYPE_VIDEO));if(!d||0===d.length)return;const l=[];d.filter((e=>e.isSubscribed)).forEach((e=>{l.push(e)}));const h=[];if(t.video)if(t.resolutionIds)t.resolutionIds.forEach((t=>{const r=i.userInfo.userId===oC?nM[t].streamUid.toString():t,o=d.find((e=>e.trackId.toString()===r));o&&(h.push(o),l.some((e=>e.trackId.toString()===r))||(o.isSubscribed=!0,o.cssrc=this.allocateVideoReceiveSsrc(i.userInfo.roomId,e),n.push(o)))}));else{const t=this.getMaxResolutionTrack(d).trackId,r=t&&d.find((e=>e.trackId===t));r&&(h.push(r),l.some((e=>e.trackId===t))||(r.isSubscribed=!0,r.cssrc=this.allocateVideoReceiveSsrc(i.userInfo.roomId,e),n.push(r)))}const f=n.filter((e=>e.type===ok.TRACK_TYPE_VIDEO));f.forEach((e=>{e.autoAdjustResolution=t.autoAdjustResolution||dC.ON,e.minResolution=t.minResolution||"LD"})),s.push(...f),r?l.forEach((e=>{h.some((t=>t.trackId===e.trackId))?s.push(e):(e.isSubscribed=!1,o.push(e))})):s.push(...l)}unAllocateReceiveSsrc(e,t,r,i){r!==ok.TRACK_TYPE_AUDIO?this.unAllocateVideoReceiveSsrc(e,t,i):this.unAllocateAudioReceiveSsrc(e,i)}recoverReceiveSsrc(e,t,r,i){r!==ok.TRACK_TYPE_AUDIO?this.recoverVideoReceiveSsrc(e,t,i):this.recoverAudioReceiveSsrc(e,i)}unAllocateAudioReceiveSsrc(e,t){const r=this.roomSsrc.get(e);if(!r)throw this.logger.error(sM,"no roomId exist"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);const i=r.audioReceiveSsrcs.indexOf(t);-1===i&&this.logger.error(sM,"unAllocateAudioReceiveSsrc error, ".concat(t," not allocated")),r.audioReceiveSsrcs.splice(i,1),this.logger.info(sM,"unAllocateAudioReceiveSsrc success, ".concat(t))}recoverAudioReceiveSsrc(e,t){const r=this.roomSsrc.get(e);if(!r)throw this.logger.error(sM,"no roomId exist"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);-1===r.audioReceiveSsrcs.indexOf(t)&&r.audioReceiveSsrcs.push(t),this.logger.info(sM,"recoverAudioReceiveSsrc success, ".concat(t))}unAllocateVideoReceiveSsrc(e,t,r){const i=this.roomSsrc.get(e);if(!i)throw this.logger.error(sM,"no roomId exist"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);const n=i.videoReceiveSsrcs.indexOf(r);-1!==n?(i.videoReceiveSsrcs.splice(n,1),this.logger.info(sM,"unAllocateVideoReceiveSsrc success, ".concat(t,", ").concat(r))):this.logger.error(sM,"unAllocateVideoReceiveSsrc error, ".concat(t,",  ").concat(r," not allocated"))}recoverVideoReceiveSsrc(e,t,r){const i=this.roomSsrc.get(e);if(!i)throw this.logger.error(sM,"no roomId exist"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);-1===i.videoReceiveSsrcs.indexOf(r)&&i.videoReceiveSsrcs.push(r),this.logger.info(sM,"recoverVideoReceiveSsrc success, ".concat(t,", ").concat(r))}allocateAudioReceiveSsrc(e){const t=this.roomSsrc.get(e);if(!t)throw this.logger.error(sM,"no roomId exist"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);if(!this.audioCssrcs||0===this.audioCssrcs.length)throw this.logger.error(sM,"audio ssrc not found"),new qc(Wc.RTC_ERR_CODE_RTC_SDK_ERROR);for(const r of this.audioCssrcs)if(!t.audioReceiveSsrcs.includes(r))return t.audioReceiveSsrcs.push(r),this.logger.info(sM,"allocateAudioReceiveSsrc success, ".concat(r)),r;throw this.logger.error(sM,"have no available audio receive ssrc"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER)}allocateVideoReceiveSsrc(e,t){const r=this.roomSsrc.get(e);if(!r)throw this.logger.error(sM,"no roomId exist"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);return t===sk.STREAM_TYPE_AUX?this.doAllocateVideoReceiveSsrc(this.auxVideoCssrcs,r.videoReceiveSsrcs):this.doAllocateVideoReceiveSsrc(this.mainVideoCssrcs,r.videoReceiveSsrcs)}doAllocateVideoReceiveSsrc(e,t){if(!e||0===e.length)throw this.logger.error(sM,"video ssrc not found"),new qc(Wc.RTC_ERR_CODE_RTC_SDK_ERROR);for(const r of e)if(!t.includes(r))return t.push(r),this.logger.info(sM,"allocateVideoReceiveSsrc success, ".concat(r)),r;throw this.logger.error(sM,"have no available video receive ssrc"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER)}unsubscribeStream(e,t,r,i){const n=this.unsubscribeSingleStream(e,t,r,i,ak.USER_SUBSCRIBE_AUDIOPOLICY);this.updateSubscribeOption(e,t,r,i,rM.unsubscribe);const o=[];return n&&o.push(n),o.push(...this.getOtherRemoteUserPublishInfos([e],t)),this.logger.info(sM,"unsubscribeStream success, ".concat(this.getTracksUpdateInfosString(o))),o}updateSubscribeOption(e,t,r,i,n){if(!i)throw this.logger.error(sM,"updateSubscribeOption fail, trackOption is null}"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);const o=this.getUserInfoById(e,t),s=r===sk.STREAM_TYPE_MAIN?o.mainStream:o.auxStream;n===rM.subscribe?s.subscribeOption=this.getFullSubscribeOptions(s,i):(i.audio&&(s.subscribeOption.audio=!1),i.video&&(i.resolutionIds?i.resolutionIds.forEach((e=>{var t,r;const i=null===(t=s.subscribeOption)||void 0===t||null===(r=t.resolutions)||void 0===r?void 0:r.map((e=>e.resolutionId)).indexOf(e);i>-1&&s.subscribeOption.resolutions.splice(i,1)})):(s.subscribeOption.video=!1,s.subscribeOption.resolutions=null)))}getFullSubscribeOptions(e,t){if(!t)throw this.logger.error(sM,"trackOption is null"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);const r=[],i={};if(t.video)if(t.resolutionIds)t.resolutionIds.forEach((t=>{aM.appendResolutions(e,t,r)}));else{const t=this.getMaxResolutionTrackId(e);aM.appendResolutions(e,t,r)}if(t.audio){const t=Array.from(e.remoteTrackInfos.values()).find((e=>e.type===ok.TRACK_TYPE_AUDIO));null!=t&&t.playElement&&(i.playElement=t.playElement,i.objectFit=t.objectFit,i.muted=t.muted)}return{audio:t.audio,video:t.video,resolutions:r,audioPlayInfo:i,autoAdjustResolution:t.autoAdjustResolution,minResolution:t.minResolution}}static appendResolutions(e,t,r){const i=e.remoteTrackInfos.get(t);if(i){const e={resolutionId:t,width:i.width,height:i.height};i.playElement&&(e.playElement=i.playElement,e.objectFit=i.objectFit,e.muted=i.muted),r.push(e)}}getRemoteUserInfoById(e,t){if(!e||!t)return null;const r=this.getUserInfoById(e,t);return r||(this.logger.error(sM,"unsubscribeSingleStream fail, user not exist}"),null)}unsubscribeSingleStream(e,t,r,i,n){var o,s;const a=this.getRemoteUserInfoById(e,t);if(null===a)return null;const c=aM.getRemoteTrackInfos(a.mainStream),u=aM.getRemoteTrackInfos(a.auxStream),d=r===sk.STREAM_TYPE_MAIN?c:u;if(!d||0===d.length)return this.logger.warn(sM,"unsubscribeSingleStream, no track exist ".concat(e)),null;const l=d.filter((e=>e.isSubscribed)),h=[];if(i.audio){const r=d.find((e=>e.type===ok.TRACK_TYPE_AUDIO&&e.isSubscribed));if(r&&(r.isSubscribed=!1,h.push(r),n===ak.USER_SUBSCRIBE_AUDIOPOLICY)){const r=this.previousAudioSubscribedUsers.get(t);null==r||r.delete(e)}}i.video&&this.unsubscribeVideo(i,l,h,e,d);const f={remoteStream:r===sk.STREAM_TYPE_MAIN?null===(o=a.mainStream)||void 0===o?void 0:o.remoteStream:null===(s=a.auxStream)||void 0===s?void 0:s.remoteStream,preTracks:d,curTracks:d,addedTracks:null,updatedTracks:null,removedTracks:null,subscribedTracks:l,tracks4Subscribe:null,tracks4Unsubscribe:h,allSubscribeTracks:Array.from(d.values()).filter((e=>e.isSubscribed))},p=aM.getAnotherStreamUpdateInfo(r,a);return{preUserState:a.userState,curUserState:a.userState,userInfo:a.userInfo,mainStream:r===sk.STREAM_TYPE_MAIN?f:p,auxStream:r===sk.STREAM_TYPE_AUX?f:p}}unsubscribeVideo(e,t,r,i,n){if(e.resolutionIds)e.resolutionIds.forEach((e=>{const t=i===oC?nM[e].streamUid.toString():e,o=null==n?void 0:n.find((e=>e.trackId.toString()===t&&e.isSubscribed));o&&(o.isSubscribed=!1,r.push(o))}));else{const e=null==t?void 0:t.filter((e=>e.type==ok.TRACK_TYPE_VIDEO));null==e||e.forEach((e=>{e.isSubscribed=!1,r.push(e)}))}}updateUserName(e,t,r){const i=this.getUserInfoById(e,t);i?(i.userInfo.nickname=r,this.logger.info(sM,"updateUserName success, userId: ".concat(e,", nickName: ").concat(r))):this.logger.error(sM,"updateUserName fail, user not exist}")}isRemoteUserSubscribed(e,t){var r,i;const n=this.getUserInfoById(e,t);if(!n)return this.logger.info(sM,"isRemoteUserSubscribed, user not exist}"),!1;const o=!(null===(r=n.mainStream)||void 0===r||!r.remoteTrackInfos)&&Array.from(n.mainStream.remoteTrackInfos.values()).filter((e=>e.isSubscribed)).length>0,s=!(null===(i=n.auxStream)||void 0===i||!i.remoteTrackInfos)&&Array.from(n.auxStream.remoteTrackInfos.values()).filter((e=>e.isSubscribed)).length>0;return o||s}getUserInfoByStreamId(e,t){return this.getAllUserInfos(e).find((e=>{var r,i;return(null===(r=e.mainStream)||void 0===r?void 0:r.remoteTrackInfos.has(t))||(null===(i=e.auxStream)||void 0===i?void 0:i.remoteTrackInfos.has(t))}))}getAllUserInfos(e){return Array.from(this.remoteUserInfos.values()).filter((t=>t.userInfo.roomId===e))}getAllSubscribedUpdateInfos4Unsubscribe(e){return this.getAllUserInfos(e).map((e=>{const t=aM.getRemoteTrackInfos(e.mainStream).filter((e=>e.isSubscribed));t.forEach((e=>{e.isSubscribed=!1}));const r=aM.getRemoteTrackInfos(e.auxStream).filter((e=>e.isSubscribed));return r.forEach((e=>{e.isSubscribed=!1})),{userInfo:e.userInfo,preUserState:e.userState,curUserState:e.userState,mainStream:{remoteStream:e.mainStream.remoteStream,tracks4Unsubscribe:t,allSubscribeTracks:[]},auxStream:{remoteStream:e.auxStream.remoteStream,tracks4Unsubscribe:r,allSubscribeTracks:[]}}}))}initializeRemoteUser(e,t){if(!e)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);const r={userInfo:e,userState:t?lk.Joined:lk.NotJoin,mainStream:null,auxStream:null},i=aM.generateUniqueId(e.userId,e.roomId);return this.remoteUserInfos.set(i,r),this.roomSsrc.has(e.roomId)||this.roomSsrc.set(e.roomId,{audioReceiveSsrcs:[],videoReceiveSsrcs:[]}),this.logger.info(sM,"initializeRemoteUser success, userInfo: ".concat(JSON.stringify(e))),r}updateRemoteUser(e){if(!e)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);const t=this.getUserInfoById(e.userId,e.roomId);return t?(e.nickname=e.nickname||t.userInfo.nickname,t.userInfo=e,this.logger.info(sM,"updateRemoteUser success, userInfo: ".concat(JSON.stringify(e))),t):null}initializeRemoteStream(e,t,r){const i=e===sk.STREAM_TYPE_MAIN?"main":"auxiliary",n=new zO({type:i,log:this.logger,userId:t,client:this.client,roomId:r}),o={remoteTrackInfos:new Map,remoteStream:n,subscribeOption:{audio:!1,video:!1}};if(!this.previousAudioSubscribedUsers.has(r)){const e=new Map;this.previousAudioSubscribedUsers.set(r,e)}return this.logger.info(sM,"initializeStreamInfo success, userId: ".concat(t,", type: ").concat(o.remoteStream.getType())),o}refreshRemoteStreamList(e,t,r){const i=null==t?void 0:t.filter((e=>e.content!==iC.desktop)),n=null==t?void 0:t.filter((e=>e.content===iC.desktop)),o=this.getUserInfoById(e.userId,e.roomId),s=this.doRefreshRemoteStreamList(e,sk.STREAM_TYPE_MAIN,i,r,!1),a=this.doRefreshRemoteStreamList(e,sk.STREAM_TYPE_AUX,n,null,!1),c=this.getUserInfoById(e.userId,e.roomId);return this.getAllPublishInfosWhenStreamUpdate(!o,s,a,c)}doRefreshRemoteStreamList(e,t,r,i,n){if(this.logger.info(sM,"doRefreshRemoteStreamList begin, streamType:".concat(t,",isLocalRejoinï¼").concat(n,",")+"userInfo: ".concat(JSON.stringify(e),", allVideoStreams: ").concat(JSON.stringify(r),", allAudioStreams: ").concat(JSON.stringify(i))),e.userId===this.localUserId)return null;const o=this.getUserInfoById(e.userId,e.roomId);e.relaySrcRoomId=e.relaySrcRoomId||(null==o?void 0:o.userInfo.relaySrcRoomId);const s=o?this.updateRemoteUser(e):this.initializeRemoteUser(e,!0),a=this.getStreamInfoByStreamType(t,s,e),c=aM.getRemoteTrackInfos(a),u=null==c?void 0:c.filter((e=>e.isSubscribed)),d=a.remoteTrackInfos,l=[],h=[],f=[];null==c||c.forEach((e=>{this.isPreTrackInvalid(r,i,e,n)&&(n&&e.isSubscribed&&(e.state=hk.localRejoin),f.push(e),d.delete(e.trackId))})),this.refreshTracks(r,i,c,d,n,l,h,f),this.cachePlayInfo(e,t,r,i,f);const p=this.getTracks4Subscribe(e,t,a.remoteStream,l,f),m=this.getTracks4UnSubscribe(f),g=Array.from(a.remoteTrackInfos.values());return this.updateRemoteStreamTracks(g,a.remoteStream),{remoteStream:a.remoteStream,preTracks:c,curTracks:g,addedTracks:l,updatedTracks:h,removedTracks:f,subscribedTracks:u,tracks4Subscribe:p,tracks4Unsubscribe:m,allSubscribeTracks:null==g?void 0:g.filter((e=>e.isSubscribed))}}refreshTracks(e,t,r,i,n,o,s,a){(null!=e&&e.length||null!=t&&t.length)&&(null==r||r.forEach((e=>{e.state===hk.remoteRejoinCache&&(a.push(e),i.delete(e.trackId))}))),this.refreshVideoStreamTracks(e,r,i,n,o,s),this.refreshAudioStreamTracks(t,r,i,n,o,s)}refreshVideoStreamTracks(e,t,r,i,n,o){null==e||e.forEach((e=>{const s=null==t?void 0:t.find((t=>t.trackId===e.streamUid.toString()));if(s){const t=aM.generateUpdateVideoTrack(e,s);r.set(e.streamUid.toString(),t),s.state===hk.remoteRejoinCache||i?(t.isSubscribed=!1,t.isTrackReady=!1,n.push(t)):aM.isSameResolution(s,e)&&!aM.isMuteStatusChange(s,e)||o.push(s)}else{const t=aM.generateNewVideoTrack(e);r.set(e.streamUid.toString(),t),n.push(t)}}))}refreshAudioStreamTracks(e,t,r,i,n,o){null==e||e.forEach((e=>{if("main"===(null==e?void 0:e.content)){const s=null==t?void 0:t.find((t=>t.trackId===e.streamUid.toString()));if(s){const t=aM.generateUpdateAudioTrack(e,s);r.set(e.streamUid.toString(),t),s.state===hk.remoteRejoinCache||i?(t.isSubscribed=!1,t.isTrackReady=!1,n.push(t)):aM.isMuteStatusChange(s,e)&&o.push(s)}else{const t=aM.generateNewAudioTrack(e);r.set(e.streamUid.toString(),t),n.push(t)}}}))}remoteUserReconnect(e){if(!e)return;const t=this.getUserInfoById(e.userId,e.roomId);if(!t)return this.logger.error(sM,"remoteUserReconnect, user not exist"),null;this.isRemoteUserSubscribed(e.userId,e.roomId)&&this.cacheHistorySubscription(t),t.userState=lk.Rejoining,this.logger.info(sM,"remoteUserReconnect, update user state to rejoining")}cacheHistorySubscription(e){if(!e)return null;const t=this.getSubscribedTracksInfo(e.userInfo.userId,e.userInfo.roomId,sk.STREAM_TYPE_MAIN),r=this.getSubscribedTracksInfo(e.userInfo.userId,e.userInfo.roomId,sk.STREAM_TYPE_AUX);null==t||t.forEach((e=>{e.state=hk.remoteRejoinCache})),null==r||r.forEach((e=>{e.state=hk.remoteRejoinCache}))}getSubscribedTracksInfo(e,t,r){var i,n;const o=this.getUserInfoById(e,t);if(!o)return this.logger.error(sM,"getSubscribedMainTracksInfo, user not exist}"),null;const s=r===sk.STREAM_TYPE_MAIN?null===(i=o.mainStream)||void 0===i?void 0:i.remoteTrackInfos:null===(n=o.auxStream)||void 0===n?void 0:n.remoteTrackInfos;return s&&Array.from(s.values()).filter((e=>e.isSubscribed))}getStreamInfoByStreamType(e,t,r){if(!(e===sk.STREAM_TYPE_MAIN?t.mainStream:t.auxStream)){const i=this.initializeRemoteStream(e,r.userId,r.roomId);e===sk.STREAM_TYPE_MAIN?t.mainStream=i:t.auxStream=i}return e===sk.STREAM_TYPE_MAIN?t.mainStream:t.auxStream}static generateNewVideoTrack(e){return{pt:e.pt,content:e.content,streamType:e.content===iC.desktop?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN,trackId:e.streamUid.toString(),isSubscribed:!1,isTrackReady:!1,pssrc:e.ssrc,cssrc:0,type:ok.TRACK_TYPE_VIDEO,width:e.width,height:e.height,state:hk.normal,mute:e.mute,maxFs:e.maxFs,fps:e.fps}}static generateNewAudioTrack(e){return{pt:e.pt,content:e.content,streamType:e.content===iC.desktop?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN,trackId:e.streamUid.toString(),isSubscribed:!1,isTrackReady:!1,pssrc:e.ssrc,cssrc:0,type:ok.TRACK_TYPE_AUDIO,state:hk.normal,mute:e.mute}}static generateUpdateVideoTrack(e,t){return{pt:e.pt,content:e.content,streamType:e.content===iC.desktop?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN,trackId:e.streamUid.toString(),isSubscribed:t.isSubscribed,isTrackReady:t.isTrackReady,pssrc:t.pssrc,cssrc:t.cssrc,type:ok.TRACK_TYPE_VIDEO,width:e.width,height:e.height,state:t.state,mute:e.mute}}static generateUpdateAudioTrack(e,t){return{pt:e.pt,content:e.content,streamType:e.content===iC.desktop?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN,trackId:e.streamUid.toString(),isSubscribed:t.isSubscribed,isTrackReady:t.isTrackReady,pssrc:t.pssrc,cssrc:t.cssrc,type:ok.TRACK_TYPE_AUDIO,state:t.state,mute:e.mute}}updateRemoteStream(e,t,r){const i=null==t?void 0:t.filter((e=>e.content!==iC.desktop)),n=null==t?void 0:t.filter((e=>e.content===iC.desktop)),o=this.doUpdateRemoteStream(e,sk.STREAM_TYPE_MAIN,i,r),s=this.doUpdateRemoteStream(e,sk.STREAM_TYPE_AUX,n,null),a=this.getUserInfoById(e.userId,e.roomId);return{userInfo:a.userInfo,preUserState:a.userState,curUserState:a.userState,isUserNameChanged:null,mainStream:o,auxStream:s}}doUpdateRemoteStream(e,t,r,i){this.logger.info(sM,"updateRemoteStreamInfo begin, streamType:".concat(t)+"userInfo: ".concat(JSON.stringify(e),", videoStreams: ").concat(JSON.stringify(r),", audioStreams: ").concat(JSON.stringify(i),","));if(!this.getUserInfoById(e.userId,e.roomId))return this.logger.error(sM,"updateRemoteStream, user not exist"),null;const n=this.getUserInfoById(e.userId,e.roomId),o=this.getStreamInfoByStreamType(t,n,e),s=aM.getRemoteTrackInfos(o),a=null==s?void 0:s.filter((e=>e.isSubscribed)),c=o.remoteTrackInfos,u=[];null==r||r.forEach((e=>{const t=null==s?void 0:s.find((t=>t.trackId===e.streamUid.toString()));if(t&&(!aM.isSameResolution(t,e)||aM.isMuteStatusChange(t,e))){const r=aM.generateUpdateVideoTrack(e,t);c.set(e.streamUid.toString(),r),u.push(t)}})),null==i||i.forEach((e=>{const t=null==s?void 0:s.find((t=>t.trackId===e.streamUid.toString()));if(t&&aM.isMuteStatusChange(t,e)){const r=aM.generateUpdateAudioTrack(e,t);c.set(e.streamUid.toString(),r),u.push(t)}}));const d=Array.from(o.remoteTrackInfos.values());return this.updateRemoteStreamTracks(d,o.remoteStream),{remoteStream:o.remoteStream,preTracks:s,curTracks:d,addedTracks:[],updatedTracks:u,removedTracks:[],subscribedTracks:a,tracks4Subscribe:[],tracks4Unsubscribe:[],allSubscribeTracks:null==d?void 0:d.filter((e=>e.isSubscribed))}}getAllPublishInfosWhenStreamUpdate(e,t,r,i){const n={userInfo:i.userInfo,preUserState:e?lk.NotJoin:i.userState,curUserState:i.userState,isUserNameChanged:null,mainStream:t,auxStream:r},o=[];return o.push(n),o.push(...this.getOtherRemoteUserPublishInfos([i.userInfo.userId],i.userInfo.roomId)),this.logger.info(sM,"updateRemoteStreamInfo success, ".concat(this.getTracksUpdateInfosString(o))),o}getOtherRemoteUserPublishInfos(e,t){const r=[];return this.getAllUserInfos(t).forEach((t=>{if(!e.includes(t.userInfo.userId)){var i,n,o,s,a,c;const e=null!==(i=t.mainStream)&&void 0!==i&&null!==(n=i.remoteTrackInfos)&&void 0!==n&&n.size?Array.from(t.mainStream.remoteTrackInfos.values()).filter((e=>e.isSubscribed)):null,u=null!==(o=t.auxStream)&&void 0!==o&&null!==(s=o.remoteTrackInfos)&&void 0!==s&&s.size?Array.from(t.auxStream.remoteTrackInfos.values()).filter((e=>e.isSubscribed)):null,d={userInfo:t.userInfo,curUserState:t.userState,preUserState:t.userState,mainStream:{remoteStream:null===(a=t.mainStream)||void 0===a?void 0:a.remoteStream,allSubscribeTracks:e},auxStream:{remoteStream:null===(c=t.auxStream)||void 0===c?void 0:c.remoteStream,allSubscribeTracks:u}};r.push(d)}})),r}static getAnotherStreamUpdateInfo(e,t){const r=e===sk.STREAM_TYPE_MAIN?t.auxStream:t.mainStream,i=aM.getRemoteTrackInfos(r),n=i?i.filter((e=>e.isSubscribed)):null;return{remoteStream:null==r?void 0:r.remoteStream,preTracks:i,curTracks:i,addedTracks:null,updatedTracks:null,removedTracks:null,subscribedTracks:n?[...n]:null,tracks4Subscribe:null,tracks4Unsubscribe:null,allSubscribeTracks:n?[...n]:null}}getTracksUpdateInfosString(e){if(!e)return"";let t="";return e.forEach((e=>{t=t+aM.getTracksUpdateInfoString(e)+" "})),t}static getTracksUpdateInfoString(e){var t,r,i,n,o,s,a,c,u,d,l,h,f,p,m,g,_,S,v,y,I,T,R,E,b,C,A,w,k,O,P,M,D,N,U,x,L,B,V,Y,j,F,H,K,z,W,G,q,J,X,Q,$,Z,ee;return e?"userId:".concat(e.userInfo.userId,", preUserState: ").concat(e.preUserState,",curUserState: ").concat(e.curUserState,",")+"main stream:"+"".concat(null!==(t=e.mainStream)&&void 0!==t&&null!==(r=t.preTracks)&&void 0!==r&&r.length?"preTracks:"+JSON.stringify(null===(i=e.mainStream)||void 0===i?void 0:i.preTracks)+",":"")+"".concat(null!==(n=e.mainStream)&&void 0!==n&&null!==(o=n.curTracks)&&void 0!==o&&o.length?"curTracks:"+JSON.stringify(null===(s=e.mainStream)||void 0===s?void 0:s.curTracks)+",":"")+"".concat(null!==(a=e.mainStream)&&void 0!==a&&null!==(c=a.addedTracks)&&void 0!==c&&c.length?"addedTracks:"+JSON.stringify(null===(u=e.mainStream)||void 0===u?void 0:u.addedTracks)+",":"")+"".concat(null!==(d=e.mainStream)&&void 0!==d&&null!==(l=d.updatedTracks)&&void 0!==l&&l.length?"updatedTracks:"+JSON.stringify(null===(h=e.mainStream)||void 0===h?void 0:h.updatedTracks)+",":"")+"".concat(null!==(f=e.mainStream)&&void 0!==f&&null!==(p=f.removedTracks)&&void 0!==p&&p.length?"removedTracks:"+JSON.stringify(null===(m=e.mainStream)||void 0===m?void 0:m.removedTracks)+",":"")+"".concat(null!==(g=e.mainStream)&&void 0!==g&&null!==(_=g.subscribedTracks)&&void 0!==_&&_.length?"subscribedTracks:"+JSON.stringify(null===(S=e.mainStream)||void 0===S?void 0:S.subscribedTracks)+",":"")+"".concat(null!==(v=e.mainStream)&&void 0!==v&&null!==(y=v.tracks4Subscribe)&&void 0!==y&&y.length?"tracks4Subscribe:"+JSON.stringify(null===(I=e.mainStream)||void 0===I?void 0:I.tracks4Subscribe)+",":"")+"".concat(null!==(T=e.mainStream)&&void 0!==T&&null!==(R=T.tracks4Unsubscribe)&&void 0!==R&&R.length?"tracks4Unsubscribe:"+JSON.stringify(null===(E=e.mainStream)||void 0===E?void 0:E.tracks4Unsubscribe)+",":"")+"".concat(null!==(b=e.mainStream)&&void 0!==b&&null!==(C=b.allSubscribeTracks)&&void 0!==C&&C.length?"allSubscribeTracks:"+JSON.stringify(null===(A=e.mainStream)||void 0===A?void 0:A.allSubscribeTracks)+",":"")+"aux stream:"+"".concat(null!==(w=e.auxStream)&&void 0!==w&&null!==(k=w.preTracks)&&void 0!==k&&k.length?"preTracks:"+JSON.stringify(null===(O=e.auxStream)||void 0===O?void 0:O.preTracks)+",":"")+"".concat(null!==(P=e.auxStream)&&void 0!==P&&null!==(M=P.curTracks)&&void 0!==M&&M.length?"curTracks:"+JSON.stringify(null===(D=e.auxStream)||void 0===D?void 0:D.curTracks)+",":"")+"".concat(null!==(N=e.auxStream)&&void 0!==N&&null!==(U=N.addedTracks)&&void 0!==U&&U.length?"addedTracks:"+JSON.stringify(null===(x=e.auxStream)||void 0===x?void 0:x.addedTracks)+",":"")+"".concat(null!==(L=e.auxStream)&&void 0!==L&&null!==(B=L.updatedTracks)&&void 0!==B&&B.length?"updatedTracks:"+JSON.stringify(null===(V=e.auxStream)||void 0===V?void 0:V.updatedTracks)+",":"")+"".concat(null!==(Y=e.auxStream)&&void 0!==Y&&null!==(j=Y.removedTracks)&&void 0!==j&&j.length?"removedTracks:"+JSON.stringify(null===(F=e.auxStream)||void 0===F?void 0:F.removedTracks)+",":"")+"".concat(null!==(H=e.auxStream)&&void 0!==H&&null!==(K=H.subscribedTracks)&&void 0!==K&&K.length?"subscribedTracks:"+JSON.stringify(null===(z=e.auxStream)||void 0===z?void 0:z.subscribedTracks)+",":"")+"".concat(null!==(W=e.auxStream)&&void 0!==W&&null!==(G=W.tracks4Subscribe)&&void 0!==G&&G.length?"tracks4Subscribe:"+JSON.stringify(null===(q=e.auxStream)||void 0===q?void 0:q.tracks4Subscribe)+",":"")+"".concat(null!==(J=e.auxStream)&&void 0!==J&&null!==(X=J.tracks4Unsubscribe)&&void 0!==X&&X.length?"tracks4Unsubscribe:"+JSON.stringify(null===(Q=e.auxStream)||void 0===Q?void 0:Q.tracks4Unsubscribe)+",":"")+"".concat(null!==($=e.auxStream)&&void 0!==$&&null!==(Z=$.allSubscribeTracks)&&void 0!==Z&&Z.length?"allSubscribeTracks:"+JSON.stringify(null===(ee=e.auxStream)||void 0===ee?void 0:ee.allSubscribeTracks):""):""}updateRemoteStreamTracks(e,t){if(!t)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);if(!e)return void this.logger.error(sM,"updateRemoteStreamTracks , curAllTracks is null");const r=new Map;e.filter((e=>e.type===ok.TRACK_TYPE_VIDEO)).forEach((e=>{r.set(e.trackId.toString(),{streamId:e.trackId.toString(),width:e.width,height:e.height})}));const i=e.some((e=>e.type===ok.TRACK_TYPE_AUDIO)),n=t.isAuxiliary()?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN;t.updateRemoteResolutions(n,[...r.values()],i)}isPreTrackInvalid(e,t,r,i){return!!i||r.state!==hk.remoteRejoinCache&&(r.type===ok.TRACK_TYPE_VIDEO&&this.isPreVideoTrackRemoved(e,r)||r.type===ok.TRACK_TYPE_AUDIO&&this.isPreAudioTrackRemoved(t,r))}isPreVideoTrackRemoved(e,t){return!(null!=e&&e.some((e=>e.streamUid.toString()===t.trackId)))}isPreAudioTrackRemoved(e,t){return!(null!=e&&e.some((e=>e.streamUid.toString()===t.trackId)))}static isSameResolution(e,t){if(!e||!t)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);return e.height===t.height&&e.width===t.width}static isMuteStatusChange(e,t){if(!e||!t)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);return e.mute!==t.mute}clear(e){if(e){for(const o of this.remoteUserInfos.keys())if(o.indexOf("#".concat(e))>0){var t,r,i,n;const e=this.remoteUserInfos.get(o);null===(t=e.mainStream)||void 0===t||null===(r=t.remoteStream)||void 0===r||r.close(),null===(i=e.auxStream)||void 0===i||null===(n=i.remoteStream)||void 0===n||n.close(),this.remoteUserInfos.delete(o)}this.roomSsrc.delete(e),this.previousAudioSubscribedUsers.delete(e)}}static generateUniqueId(e,t){if(!e)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);return"".concat(e,"#").concat(t)}}function cM(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}const uM=[200,201,204];const dM=new class{setLogServerConfigs(e){this.logServerConfigs=function(e){for(var r=1;r<arguments.length;r++){var i=null!=arguments[r]?arguments[r]:{};r%2?cM(Object(i),!0).forEach((function(r){t(e,r,i[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):cM(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({logServerAppId:QC,payLoad:"",signature:""},e),this.logServerConfigs.logServerAppId=this.logServerConfigs.logServerAppId||QC}async uploadLogFile(e,t){let r;try{const i=this.initConfigs(t);if(!i.payLoad||!i.signature)return void e.logger.warn("LogServer","init config failed, do not upload.");const n=await this.getServerInfo(i);if(n&&0===n.resCode){this.serverDomain=n.serverDomain,this.accessToken=n.accessToken;const t=await MR.getLogFile(e,i.shaSN),o=await this.getUploadInfo(t,i);o&&0===o.resCode?(this.fileUniqueFlag=o.fileUniqueFlag,this.method=o.uploadInfoList[0].method,this.uploadUrl=o.uploadInfoList[0].uploadUrl,this.headers=o.uploadInfoList[0].headers,r=await this.upload2Obs(t.content),r&&await this.notifyUploadSucc(i)):e.logger.warn("LogServer","post upload info fail: ".concat(JSON.stringify(o)))}else e.logger.warn("LogServer","get server fail: ".concat(JSON.stringify(n)))}catch(lw){e.logger.warn("LogServer","upload file error: ".concat(lw))}}initConfigs(e){var t,r,i,n;const o=(null==e?void 0:e.taskId)||bR.getDeviceID().replace(/[-]/g,""),s=(null==e?void 0:e.payLoad)||(null===(t=this.logServerConfigs)||void 0===t?void 0:t.payLoad);return{shaSN:o,logServerAppId:(null==e?void 0:e.logServerAppId)||(null===(r=this.logServerConfigs)||void 0===r?void 0:r.logServerAppId),payLoad:s,signature:(null==e?void 0:e.signature)||(null===(i=this.logServerConfigs)||void 0===i?void 0:i.signature),logServerDomain:(null==e?void 0:e.logServerDomain)||(null===(n=this.logServerConfigs)||void 0===n?void 0:n.logServerDomain)||XC}}async getServerInfo(e){const t="".concat(e.payLoad,"&appID=").concat(e.logServerAppId),r=await oA.fetch("".concat(e.logServerDomain,"/v2/getServerDomain?appID=").concat(e.logServerAppId),{method:"POST",mode:"cors",cache:"no-cache",body:t},{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8",Accept:"application/json",Authorization:"HMAC-SHA256 appID=".concat(e.logServerAppId,', signature="').concat(e.signature,'"')});return null==r?void 0:r.data}async getUploadInfo(e,t){const r="".concat(t.payLoad,"&logType=0&fileName=").concat(e.urlFileNameEncode,'&fileHashList=[{"fileMd5":"","fileSha256":"').concat(e.sha256,'","fileSize":"').concat(e.length,'"}]&fileSize=').concat(e.length,"&encryptKey=asdfghhjjfsdafaerqw&patchSize=").concat(104857600,"&patchNum=2&patchVer=0"),i="POST&/v2/getUploadInfo&appID=".concat(t.logServerAppId,"&").concat(r,"&appID=").concat(t.logServerAppId),n=BI.exports.enc.Base64.stringify(BI.exports.HmacSHA256(i,this.accessToken)),o=await oA.fetch("https://".concat(this.serverDomain,"/v2/getUploadInfo?appID=").concat(t.logServerAppId),{method:"POST",mode:"cors",cache:"no-cache",body:r},{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8",Accept:"application/json",Authorization:"HMAC-SHA256 appID=".concat(t.logServerAppId,', signature="').concat(n,'"')});return null==o?void 0:o.data}async upload2Obs(e){const t=await oA.fetch("".concat(this.uploadUrl),{method:"".concat(this.method),mode:"cors",cache:"no-cache",body:e},{Authorization:this.headers.Authorization.toString(),"Content-MD5":"","Content-Type":this.headers["Content-Type"],"x-amz-content-sha256":this.headers["x-amz-content-sha256"],"x-amz-date":this.headers["x-amz-date"]});return uM.includes(null==t?void 0:t.httpCode)}async notifyUploadSucc(e){var t;const r=bR.getCurrentTime(),i="".concat(r.year).concat(r.month).concat(r.day).concat(r.hour).concat(r.min).concat(r.sec),n="".concat(e.payLoad,"&fileUniqueFlag=").concat(this.fileUniqueFlag,"&uploadTime=").concat(i),o="POST&/v2/notifyUploadSucc&appID=".concat(e.logServerAppId,"&").concat(n,"&appID=").concat(e.logServerAppId),s=BI.exports.HmacSHA256(o,this.accessToken),a=BI.exports.enc.Base64.stringify(s),c=await oA.fetch("https://".concat(this.serverDomain,"/v2/notifyUploadSucc?appID=").concat(e.logServerAppId),{method:"POST",mode:"cors",cache:"no-cache",body:n},{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8",Accept:"application/json",Authorization:"HMAC-SHA256 appID=".concat(e.logServerAppId,', signature="').concat(a,'"')});return c&&(null===(t=c.data)||void 0===t?void 0:t.resCode)}},lM="ClientRelayRoomManager";const hM=new class{constructor(){this.relayClients=new Map,this.logger=MR.getLogger()}add(e,t,r){if(this.relayClients.has(e))this.relayClients.get(e).set(t,r);else{const i=new Map;i.set(t,r),this.relayClients.set(e,i)}}find(e,t){if(this.relayClients.has(e))return this.relayClients.get(e).get(t)}remove(e,t){var r;t?null===(r=this.relayClients.get(e))||void 0===r||r.delete(t):this.relayClients.delete(e)}addConnectionCache(e,t,r){this.add(e,t,r)}addRelayConnection(e,t){if(e.status!==aC.Joined)throw this.logger.error(lM,"cannot addRelayConnection before join room"),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"cannot addRelayConnection before join room");if(e.mainRelayRoomSymbol)throw this.logger.error(lM,"addRelayConnection interface cannot call by relayClient"),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"addRelayConnection interface cannot call by relayClient");if(this.relayClients.get(e.clientSymbol).size>$C)throw this.logger.error(lM,"relayClients size over maxium: ".concat($C)),new qc(Wc.RTC_ERR_CODE_CLIENT_RELAY_ROOM_OVER_MAXNUM);if(this.find(e.clientSymbol,t))throw this.logger.error(lM,"addRelayConnection:".concat(t," already exist")),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"addRelayConnection:".concat(t," already exist"));return new mD(e.clientConfig,e.clientSymbol)}getRelayConnection(e,t){return this.find(e.clientSymbol,t)}stopRelayConnection(e,t){e.mainRelayRoomSymbol?(this.find(e.mainRelayRoomSymbol,t)||this.logger.error(lM,"stopRelayClient:".concat(t," not exist")),this.remove(e.mainRelayRoomSymbol,t)):t?this.remove(e.clientSymbol,t):this.remove(e.clientSymbol)}roleValidCheck4RelayRoom(e,t){if(t===JO.JOINER){let t=!1;for(const r of this.relayClients.get(e.mainRelayRoomSymbol||e.clientSymbol).values())if(r.userInfo.role===JO.JOINER){t=!0;break}if(t)throw this.logger.error(lM,"only one joiner can include in relayRooms."),new qc(Wc.RTC_ERR_CODE_CLIENT_RELAY_JOINER_OVER_MAXNUM)}}switchRoleParamsCheck(e,t,r){if(t!==JO.JOINER&&t!==JO.PLAYER||null==r||!r.signature||null==r||!r.ctime)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);this.roleValidCheck4RelayRoom(e,t)}};var fM=_n,pM="ArrayBuffer",mM=SS.ArrayBuffer;Zi({global:!0,constructor:!0,forced:s.ArrayBuffer!==mM},{ArrayBuffer:mM}),fM(pM);var gM={exports:{}};!function(e,t){e.exports=function(){var e=Math.imul,t=Math.clz32;function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var r,i=0;i<t.length;i++)(r=t[i]).enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}function o(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&c(e,t)}function a(e){return a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},a(e)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function u(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function d(){return d=u()?Reflect.construct:function(e,t,r){var i=[null];i.push.apply(i,t);var n=new(Function.bind.apply(e,i));return r&&c(n,r.prototype),n},d.apply(null,arguments)}function l(e){return-1!==Function.toString.call(e).indexOf("[native code]")}function h(e){var t="function"==typeof Map?new Map:void 0;return h=function(e){function r(){return d(e,arguments,a(this).constructor)}if(null===e||!l(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),c(r,e)},h(e)}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return f(e)}function m(e){var t=u();return function(){var r,i=a(e);if(t){var n=a(this).constructor;r=Reflect.construct(i,arguments,n)}else r=i.apply(this,arguments);return p(this,r)}}function g(e,t){return _(e)||S(e,t)||v(e,t)||I()}function _(e){if(Array.isArray(e))return e}function S(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var i,n,o=[],s=!0,a=!1;try{for(r=r.call(e);!(s=(i=r.next()).done)&&(o.push(i.value),!t||o.length!==t);s=!0);}catch(e){a=!0,n=e}finally{try{s||null==r.return||r.return()}finally{if(a)throw n}}return o}}function v(e,t){if(e){if("string"==typeof e)return y(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?y(e,t):void 0}}function y(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=Array(t);r<t;r++)i[r]=e[r];return i}function I(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function T(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=v(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}var R=function(e){var t=Math.abs,n=Math.max,a=Math.floor;function c(e,t){var r;if(i(this,c),(r=u.call(this,e)).sign=t,Object.setPrototypeOf(f(r),c.prototype),e>c.__kMaxLength)throw new RangeError("Maximum BigInt size exceeded");return r}s(c,e);var u=m(c);return o(c,[{key:"toDebugString",value:function(){var e,t=["BigInt["],r=T(this);try{for(r.s();!(e=r.n()).done;){var i=e.value;t.push((i?(i>>>0).toString(16):i)+", ")}}catch(e){r.e(e)}finally{r.f()}return t.push("]"),t.join("")}},{key:"toString",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:10;if(2>e||36<e)throw new RangeError("toString() radix argument must be between 2 and 36");return 0===this.length?"0":0==(e&e-1)?c.__toStringBasePowerOfTwo(this,e):c.__toStringGeneric(this,e,!1)}},{key:"valueOf",value:function(){throw new Error("Convert JSBI instances to native numbers using `toNumber`.")}},{key:"__copy",value:function(){for(var e=new c(this.length,this.sign),t=0;t<this.length;t++)e[t]=this[t];return e}},{key:"__trim",value:function(){for(var e=this.length,t=this[e-1];0===t;)t=this[--e-1],this.pop();return 0===e&&(this.sign=!1),this}},{key:"__initializeDigits",value:function(){for(var e=0;e<this.length;e++)this[e]=0}},{key:"__clzmsd",value:function(){return c.__clz30(this.__digit(this.length-1))}},{key:"__inplaceMultiplyAdd",value:function(e,t,r){r>this.length&&(r=this.length);for(var i=32767&e,n=e>>>15,o=0,s=t,a=0;a<r;a++){var u=this.__digit(a),d=32767&u,l=u>>>15,h=c.__imul(d,i),f=c.__imul(d,n),p=c.__imul(l,i),m=s+h+o;o=m>>>30,m&=1073741823,o+=(m+=((32767&f)<<15)+((32767&p)<<15))>>>30,s=c.__imul(l,n)+(f>>>15)+(p>>>15),this.__setDigit(a,1073741823&m)}if(0!==o||0!==s)throw new Error("implementation bug")}},{key:"__inplaceAdd",value:function(e,t,r){for(var i,n=0,o=0;o<r;o++)n=(i=this.__halfDigit(t+o)+e.__halfDigit(o)+n)>>>15,this.__setHalfDigit(t+o,32767&i);return n}},{key:"__inplaceSub",value:function(e,t,r){var i=0;if(1&t){t>>=1;for(var n=this.__digit(t),o=32767&n,s=0;s<r-1>>>1;s++){var a=e.__digit(s),c=(n>>>15)-(32767&a)-i;i=1&c>>>15,this.__setDigit(t+s,(32767&c)<<15|32767&o),i=1&(o=(32767&(n=this.__digit(t+s+1)))-(a>>>15)-i)>>>15}var u=e.__digit(s),d=(n>>>15)-(32767&u)-i;if(i=1&d>>>15,this.__setDigit(t+s,(32767&d)<<15|32767&o),t+s+1>=this.length)throw new RangeError("out of bounds");0==(1&r)&&(i=1&(o=(32767&(n=this.__digit(t+s+1)))-(u>>>15)-i)>>>15,this.__setDigit(t+e.length,1073709056&n|32767&o))}else{t>>=1;for(var l=0;l<e.length-1;l++){var h=this.__digit(t+l),f=e.__digit(l),p=(32767&h)-(32767&f)-i,m=(h>>>15)-(f>>>15)-(i=1&p>>>15);i=1&m>>>15,this.__setDigit(t+l,(32767&m)<<15|32767&p)}var g=this.__digit(t+l),_=e.__digit(l),S=(32767&g)-(32767&_)-i;i=1&S>>>15;var v=0;0==(1&r)&&(i=1&(v=(g>>>15)-(_>>>15)-i)>>>15),this.__setDigit(t+l,(32767&v)<<15|32767&S)}return i}},{key:"__inplaceRightShift",value:function(e){if(0!==e){for(var t,r=this.__digit(0)>>>e,i=this.length-1,n=0;n<i;n++)t=this.__digit(n+1),this.__setDigit(n,1073741823&t<<30-e|r),r=t>>>e;this.__setDigit(i,r)}}},{key:"__digit",value:function(e){return this[e]}},{key:"__unsignedDigit",value:function(e){return this[e]>>>0}},{key:"__setDigit",value:function(e,t){this[e]=0|t}},{key:"__setDigitGrow",value:function(e,t){this[e]=0|t}},{key:"__halfDigitLength",value:function(){var e=this.length;return 32767>=this.__unsignedDigit(e-1)?2*e-1:2*e}},{key:"__halfDigit",value:function(e){return 32767&this[e>>>1]>>>15*(1&e)}},{key:"__setHalfDigit",value:function(e,t){var r=e>>>1,i=this.__digit(r),n=1&e?32767&i|t<<15:1073709056&i|32767&t;this.__setDigit(r,n)}}],[{key:"BigInt",value:function(e){var t=Number.isFinite;if("number"==typeof e){if(0===e)return c.__zero();if(c.__isOneDigitInt(e))return 0>e?c.__oneDigit(-e,!0):c.__oneDigit(e,!1);if(!t(e)||a(e)!==e)throw new RangeError("The number "+e+" cannot be converted to BigInt because it is not an integer");return c.__fromDouble(e)}if("string"==typeof e){var i=c.__fromString(e);if(null===i)throw new SyntaxError("Cannot convert "+e+" to a BigInt");return i}if("boolean"==typeof e)return!0===e?c.__oneDigit(1,!1):c.__zero();if("object"===r(e)){if(e.constructor===c)return e;var n=c.__toPrimitive(e);return c.BigInt(n)}throw new TypeError("Cannot convert "+e+" to a BigInt")}},{key:"toNumber",value:function(e){var t=e.length;if(0===t)return 0;if(1===t){var r=e.__unsignedDigit(0);return e.sign?-r:r}var i=e.__digit(t-1),n=c.__clz30(i),o=30*t-n;if(1024<o)return e.sign?-1/0:1/0;var s=o-1,a=i,u=t-1,d=n+3,l=32===d?0:a<<d;l>>>=12;var h=d-12,f=12<=d?0:a<<20+d,p=20+d;for(0<h&&0<u&&(u--,l|=(a=e.__digit(u))>>>30-h,f=a<<h+2,p=h+2);0<p&&0<u;)u--,a=e.__digit(u),f|=30<=p?a<<p-30:a>>>30-p,p-=30;var m=c.__decideRounding(e,p,u,a);if((1===m||0===m&&1==(1&f))&&0==(f=f+1>>>0)&&0!=++l>>>20&&(l=0,1023<++s))return e.sign?-1/0:1/0;var g=e.sign?-2147483648:0;return s=s+1023<<20,c.__kBitConversionInts[1]=g|s|l,c.__kBitConversionInts[0]=f,c.__kBitConversionDouble[0]}},{key:"unaryMinus",value:function(e){if(0===e.length)return e;var t=e.__copy();return t.sign=!e.sign,t}},{key:"bitwiseNot",value:function(e){return e.sign?c.__absoluteSubOne(e).__trim():c.__absoluteAddOne(e,!0)}},{key:"exponentiate",value:function(e,t){if(t.sign)throw new RangeError("Exponent must be positive");if(0===t.length)return c.__oneDigit(1,!1);if(0===e.length)return e;if(1===e.length&&1===e.__digit(0))return e.sign&&0==(1&t.__digit(0))?c.unaryMinus(e):e;if(1<t.length)throw new RangeError("BigInt too big");var r=t.__unsignedDigit(0);if(1===r)return e;if(r>=c.__kMaxLengthBits)throw new RangeError("BigInt too big");if(1===e.length&&2===e.__digit(0)){var i=1+(0|r/30),n=new c(i,e.sign&&0!=(1&r));n.__initializeDigits();var o=1<<r%30;return n.__setDigit(i-1,o),n}var s=null,a=e;for(0!=(1&r)&&(s=e),r>>=1;0!==r;r>>=1)a=c.multiply(a,a),0!=(1&r)&&(s=null===s?a:c.multiply(s,a));return s}},{key:"multiply",value:function(e,t){if(0===e.length)return e;if(0===t.length)return t;var r=e.length+t.length;30<=e.__clzmsd()+t.__clzmsd()&&r--;var i=new c(r,e.sign!==t.sign);i.__initializeDigits();for(var n=0;n<e.length;n++)c.__multiplyAccumulate(t,e.__digit(n),i,n);return i.__trim()}},{key:"divide",value:function(e,t){if(0===t.length)throw new RangeError("Division by zero");if(0>c.__absoluteCompare(e,t))return c.__zero();var r,i=e.sign!==t.sign,n=t.__unsignedDigit(0);if(1===t.length&&32767>=n){if(1===n)return i===e.sign?e:c.unaryMinus(e);r=c.__absoluteDivSmall(e,n,null)}else r=c.__absoluteDivLarge(e,t,!0,!1);return r.sign=i,r.__trim()}},{key:"remainder",value:function(e,t){if(0===t.length)throw new RangeError("Division by zero");if(0>c.__absoluteCompare(e,t))return e;var r=t.__unsignedDigit(0);if(1===t.length&&32767>=r){if(1===r)return c.__zero();var i=c.__absoluteModSmall(e,r);return 0===i?c.__zero():c.__oneDigit(i,e.sign)}var n=c.__absoluteDivLarge(e,t,!1,!0);return n.sign=e.sign,n.__trim()}},{key:"add",value:function(e,t){var r=e.sign;return r===t.sign?c.__absoluteAdd(e,t,r):0<=c.__absoluteCompare(e,t)?c.__absoluteSub(e,t,r):c.__absoluteSub(t,e,!r)}},{key:"subtract",value:function(e,t){var r=e.sign;return r===t.sign?0<=c.__absoluteCompare(e,t)?c.__absoluteSub(e,t,r):c.__absoluteSub(t,e,!r):c.__absoluteAdd(e,t,r)}},{key:"leftShift",value:function(e,t){return 0===t.length||0===e.length?e:t.sign?c.__rightShiftByAbsolute(e,t):c.__leftShiftByAbsolute(e,t)}},{key:"signedRightShift",value:function(e,t){return 0===t.length||0===e.length?e:t.sign?c.__leftShiftByAbsolute(e,t):c.__rightShiftByAbsolute(e,t)}},{key:"unsignedRightShift",value:function(){throw new TypeError("BigInts have no unsigned right shift; use >> instead")}},{key:"lessThan",value:function(e,t){return 0>c.__compareToBigInt(e,t)}},{key:"lessThanOrEqual",value:function(e,t){return 0>=c.__compareToBigInt(e,t)}},{key:"greaterThan",value:function(e,t){return 0<c.__compareToBigInt(e,t)}},{key:"greaterThanOrEqual",value:function(e,t){return 0<=c.__compareToBigInt(e,t)}},{key:"equal",value:function(e,t){if(e.sign!==t.sign)return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(e.__digit(r)!==t.__digit(r))return!1;return!0}},{key:"notEqual",value:function(e,t){return!c.equal(e,t)}},{key:"bitwiseAnd",value:function(e,t){if(!e.sign&&!t.sign)return c.__absoluteAnd(e,t).__trim();if(e.sign&&t.sign){var r=n(e.length,t.length)+1,i=c.__absoluteSubOne(e,r),o=c.__absoluteSubOne(t);return i=c.__absoluteOr(i,o,i),c.__absoluteAddOne(i,!0,i).__trim()}if(e.sign){var s=[t,e];e=s[0],t=s[1]}return c.__absoluteAndNot(e,c.__absoluteSubOne(t)).__trim()}},{key:"bitwiseXor",value:function(e,t){if(!e.sign&&!t.sign)return c.__absoluteXor(e,t).__trim();if(e.sign&&t.sign){var r=n(e.length,t.length),i=c.__absoluteSubOne(e,r),o=c.__absoluteSubOne(t);return c.__absoluteXor(i,o,i).__trim()}var s=n(e.length,t.length)+1;if(e.sign){var a=[t,e];e=a[0],t=a[1]}var u=c.__absoluteSubOne(t,s);return u=c.__absoluteXor(u,e,u),c.__absoluteAddOne(u,!0,u).__trim()}},{key:"bitwiseOr",value:function(e,t){var r=n(e.length,t.length);if(!e.sign&&!t.sign)return c.__absoluteOr(e,t).__trim();if(e.sign&&t.sign){var i=c.__absoluteSubOne(e,r),o=c.__absoluteSubOne(t);return i=c.__absoluteAnd(i,o,i),c.__absoluteAddOne(i,!0,i).__trim()}if(e.sign){var s=[t,e];e=s[0],t=s[1]}var a=c.__absoluteSubOne(t,r);return a=c.__absoluteAndNot(a,e,a),c.__absoluteAddOne(a,!0,a).__trim()}},{key:"asIntN",value:function(e,t){if(0===t.length)return t;if(0>(e=a(e)))throw new RangeError("Invalid value: not (convertible to) a safe integer");if(0===e)return c.__zero();if(e>=c.__kMaxLengthBits)return t;var r=0|(e+29)/30;if(t.length<r)return t;var i=t.__unsignedDigit(r-1),n=1<<(e-1)%30;if(t.length===r&&i<n)return t;if((i&n)!==n)return c.__truncateToNBits(e,t);if(!t.sign)return c.__truncateAndSubFromPowerOfTwo(e,t,!0);if(0==(i&n-1)){for(var o=r-2;0<=o;o--)if(0!==t.__digit(o))return c.__truncateAndSubFromPowerOfTwo(e,t,!1);return t.length===r&&i===n?t:c.__truncateToNBits(e,t)}return c.__truncateAndSubFromPowerOfTwo(e,t,!1)}},{key:"asUintN",value:function(e,t){if(0===t.length)return t;if(0>(e=a(e)))throw new RangeError("Invalid value: not (convertible to) a safe integer");if(0===e)return c.__zero();if(t.sign){if(e>c.__kMaxLengthBits)throw new RangeError("BigInt too big");return c.__truncateAndSubFromPowerOfTwo(e,t,!1)}if(e>=c.__kMaxLengthBits)return t;var r=0|(e+29)/30;if(t.length<r)return t;var i=e%30;if(t.length==r){if(0===i)return t;if(0==t.__digit(r-1)>>>i)return t}return c.__truncateToNBits(e,t)}},{key:"ADD",value:function(e,t){if(e=c.__toPrimitive(e),t=c.__toPrimitive(t),"string"==typeof e)return"string"!=typeof t&&(t=t.toString()),e+t;if("string"==typeof t)return e.toString()+t;if(e=c.__toNumeric(e),t=c.__toNumeric(t),c.__isBigInt(e)&&c.__isBigInt(t))return c.add(e,t);if("number"==typeof e&&"number"==typeof t)return e+t;throw new TypeError("Cannot mix BigInt and other types, use explicit conversions")}},{key:"LT",value:function(e,t){return c.__compare(e,t,0)}},{key:"LE",value:function(e,t){return c.__compare(e,t,1)}},{key:"GT",value:function(e,t){return c.__compare(e,t,2)}},{key:"GE",value:function(e,t){return c.__compare(e,t,3)}},{key:"EQ",value:function(e,t){for(;;){if(c.__isBigInt(e))return c.__isBigInt(t)?c.equal(e,t):c.EQ(t,e);if("number"==typeof e){if(c.__isBigInt(t))return c.__equalToNumber(t,e);if("object"!==r(t))return e==t;t=c.__toPrimitive(t)}else if("string"==typeof e){if(c.__isBigInt(t))return null!==(e=c.__fromString(e))&&c.equal(e,t);if("object"!==r(t))return e==t;t=c.__toPrimitive(t)}else if("boolean"==typeof e){if(c.__isBigInt(t))return c.__equalToNumber(t,+e);if("object"!==r(t))return e==t;t=c.__toPrimitive(t)}else if("symbol"===r(e)){if(c.__isBigInt(t))return!1;if("object"!==r(t))return e==t;t=c.__toPrimitive(t)}else{if("object"!==r(e))return e==t;if("object"===r(t)&&t.constructor!==c)return e==t;e=c.__toPrimitive(e)}}}},{key:"NE",value:function(e,t){return!c.EQ(e,t)}},{key:"DataViewGetBigInt64",value:function(e,t){var r=!!(2<arguments.length&&void 0!==arguments[2])&&arguments[2];return c.asIntN(64,c.DataViewGetBigUint64(e,t,r))}},{key:"DataViewGetBigUint64",value:function(e,t){var r=!!(2<arguments.length&&void 0!==arguments[2])&&arguments[2],i=g(r?[4,0]:[0,4],2),n=i[0],o=i[1],s=e.getUint32(t+n,r),a=e.getUint32(t+o,r),u=new c(3,!1);return u.__setDigit(0,1073741823&a),u.__setDigit(1,(268435455&s)<<2|a>>>30),u.__setDigit(2,s>>>28),u.__trim()}},{key:"DataViewSetBigInt64",value:function(e,t,r){var i=!!(3<arguments.length&&void 0!==arguments[3])&&arguments[3];c.DataViewSetBigUint64(e,t,r,i)}},{key:"DataViewSetBigUint64",value:function(e,t,r){var i=!!(3<arguments.length&&void 0!==arguments[3])&&arguments[3],n=0,o=0;if(0<(r=c.asUintN(64,r)).length&&(o=r.__digit(0),1<r.length)){var s=r.__digit(1);o|=s<<30,n=s>>>2,2<r.length&&(n|=r.__digit(2)<<28)}var a=g(i?[4,0]:[0,4],2),u=a[0],d=a[1];e.setUint32(t+u,n,i),e.setUint32(t+d,o,i)}},{key:"__zero",value:function(){return new c(0,!1)}},{key:"__oneDigit",value:function(e,t){var r=new c(1,t);return r.__setDigit(0,e),r}},{key:"__decideRounding",value:function(e,t,r,i){if(0<t)return-1;var n;if(0>t)n=-t-1;else{if(0===r)return-1;r--,i=e.__digit(r),n=29}var o=1<<n;if(0==(i&o))return-1;if(0!=(i&(o-=1)))return 1;for(;0<r;)if(r--,0!==e.__digit(r))return 1;return 0}},{key:"__fromDouble",value:function(e){c.__kBitConversionDouble[0]=e;var t,r=(2047&c.__kBitConversionInts[1]>>>20)-1023,i=1+(0|r/30),n=new c(i,0>e),o=1048575&c.__kBitConversionInts[1]|1048576,s=c.__kBitConversionInts[0],a=20,u=r%30,d=0;if(u<a){var l=a-u;d=l+32,t=o>>>l,o=o<<32-l|s>>>l,s<<=32-l}else if(u===a)d=32,t=o,o=s,s=0;else{var h=u-a;d=32-h,t=o<<h|s>>>32-h,o=s<<h,s=0}n.__setDigit(i-1,t);for(var f=i-2;0<=f;f--)0<d?(d-=30,t=o>>>2,o=o<<30|s>>>2,s<<=30):t=0,n.__setDigit(f,t);return n.__trim()}},{key:"__isWhitespace",value:function(e){return!!(13>=e&&9<=e)||(159>=e?32==e:131071>=e?160==e||5760==e:196607>=e?10>=(e&=131071)||40==e||41==e||47==e||95==e||4096==e:65279==e)}},{key:"__fromString",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,r=0,i=e.length,n=0;if(n===i)return c.__zero();for(var o=e.charCodeAt(n);c.__isWhitespace(o);){if(++n===i)return c.__zero();o=e.charCodeAt(n)}if(43===o){if(++n===i)return null;o=e.charCodeAt(n),r=1}else if(45===o){if(++n===i)return null;o=e.charCodeAt(n),r=-1}if(0===t){if(t=10,48===o){if(++n===i)return c.__zero();if(88===(o=e.charCodeAt(n))||120===o){if(t=16,++n===i)return null;o=e.charCodeAt(n)}else if(79===o||111===o){if(t=8,++n===i)return null;o=e.charCodeAt(n)}else if(66===o||98===o){if(t=2,++n===i)return null;o=e.charCodeAt(n)}}}else if(16===t&&48===o){if(++n===i)return c.__zero();if(88===(o=e.charCodeAt(n))||120===o){if(++n===i)return null;o=e.charCodeAt(n)}}if(0!==r&&10!==t)return null;for(;48===o;){if(++n===i)return c.__zero();o=e.charCodeAt(n)}var s=i-n,a=c.__kMaxBitsPerChar[t],u=c.__kBitsPerCharTableMultiplier-1;if(s>1073741824/a)return null;var d=new c(0|(29+(a*s+u>>>c.__kBitsPerCharTableShift))/30,!1),l=10>t?t:10,h=10<t?t-10:0;if(0==(t&t-1)){a>>=c.__kBitsPerCharTableShift;var f=[],p=[],m=!1;do{for(var g,_=0,S=0;;){if(g=void 0,o-48>>>0<l)g=o-48;else{if(!((32|o)-97>>>0<h)){m=!0;break}g=(32|o)-87}if(S+=a,_=_<<a|g,++n===i){m=!0;break}if(o=e.charCodeAt(n),30<S+a)break}f.push(_),p.push(S)}while(!m);c.__fillFromParts(d,f,p)}else{d.__initializeDigits();var v=!1,y=0;do{for(var I,T=0,R=1;;){if(I=void 0,o-48>>>0<l)I=o-48;else{if(!((32|o)-97>>>0<h)){v=!0;break}I=(32|o)-87}var E=R*t;if(1073741823<E)break;if(R=E,T=T*t+I,y++,++n===i){v=!0;break}o=e.charCodeAt(n)}var b=0|(a*y+(u=30*c.__kBitsPerCharTableMultiplier-1)>>>c.__kBitsPerCharTableShift)/30;d.__inplaceMultiplyAdd(R,T,b)}while(!v)}if(n!==i){if(!c.__isWhitespace(o))return null;for(n++;n<i;n++)if(o=e.charCodeAt(n),!c.__isWhitespace(o))return null}return d.sign=-1===r,d.__trim()}},{key:"__fillFromParts",value:function(e,t,r){for(var i=0,n=0,o=0,s=t.length-1;0<=s;s--){var a=t[s],c=r[s];n|=a<<o,30===(o+=c)?(e.__setDigit(i++,n),o=0,n=0):30<o&&(e.__setDigit(i++,1073741823&n),n=a>>>c-(o-=30))}if(0!==n){if(i>=e.length)throw new Error("implementation bug");e.__setDigit(i++,n)}for(;i<e.length;i++)e.__setDigit(i,0)}},{key:"__toStringBasePowerOfTwo",value:function(e,t){var r=e.length,i=t-1,n=i=(15&(i=(51&(i=(85&i>>>1)+(85&i))>>>2)+(51&i))>>>4)+(15&i),o=t-1,s=e.__digit(r-1),a=0|(30*r-c.__clz30(s)+n-1)/n;if(e.sign&&a++,268435456<a)throw new Error("string too long");for(var u=Array(a),d=a-1,l=0,h=0,f=0;f<r-1;f++){var p=e.__digit(f),m=(l|p<<h)&o;u[d--]=c.__kConversionChars[m];var g=n-h;for(l=p>>>g,h=30-g;h>=n;)u[d--]=c.__kConversionChars[l&o],l>>>=n,h-=n}var _=(l|s<<h)&o;for(u[d--]=c.__kConversionChars[_],l=s>>>n-h;0!==l;)u[d--]=c.__kConversionChars[l&o],l>>>=n;if(e.sign&&(u[d--]="-"),-1!==d)throw new Error("implementation bug");return u.join("")}},{key:"__toStringGeneric",value:function(e,t,r){var i=e.length;if(0===i)return"";if(1===i){var n=e.__unsignedDigit(0).toString(t);return!1===r&&e.sign&&(n="-"+n),n}var o,s,a=30*i-c.__clz30(e.__digit(i-1)),u=c.__kMaxBitsPerChar[t]-1,d=a*c.__kBitsPerCharTableMultiplier,l=1+(d=0|(d+=u-1)/u)>>1,h=c.exponentiate(c.__oneDigit(t,!1),c.__oneDigit(l,!1)),f=h.__unsignedDigit(0);if(1===h.length&&32767>=f){(o=new c(e.length,!1)).__initializeDigits();for(var p,m=0,g=2*e.length-1;0<=g;g--)p=m<<15|e.__halfDigit(g),o.__setHalfDigit(g,0|p/f),m=0|p%f;s=m.toString(t)}else{var _=c.__absoluteDivLarge(e,h,!0,!0);o=_.quotient;var S=_.remainder.__trim();s=c.__toStringGeneric(S,t,!0)}o.__trim();for(var v=c.__toStringGeneric(o,t,!0);s.length<l;)s="0"+s;return!1===r&&e.sign&&(v="-"+v),v+s}},{key:"__unequalSign",value:function(e){return e?-1:1}},{key:"__absoluteGreater",value:function(e){return e?-1:1}},{key:"__absoluteLess",value:function(e){return e?1:-1}},{key:"__compareToBigInt",value:function(e,t){var r=e.sign;if(r!==t.sign)return c.__unequalSign(r);var i=c.__absoluteCompare(e,t);return 0<i?c.__absoluteGreater(r):0>i?c.__absoluteLess(r):0}},{key:"__compareToNumber",value:function(e,r){if(c.__isOneDigitInt(r)){var i=e.sign,n=0>r;if(i!==n)return c.__unequalSign(i);if(0===e.length){if(n)throw new Error("implementation bug");return 0===r?0:-1}if(1<e.length)return c.__absoluteGreater(i);var o=t(r),s=e.__unsignedDigit(0);return s>o?c.__absoluteGreater(i):s<o?c.__absoluteLess(i):0}return c.__compareToDouble(e,r)}},{key:"__compareToDouble",value:function(e,t){if(t!=t)return t;if(t===1/0)return-1;if(t===-1/0)return 1;var r=e.sign;if(r!==0>t)return c.__unequalSign(r);if(0===t)throw new Error("implementation bug: should be handled elsewhere");if(0===e.length)return-1;c.__kBitConversionDouble[0]=t;var i=2047&c.__kBitConversionInts[1]>>>20;if(2047==i)throw new Error("implementation bug: handled elsewhere");var n=i-1023;if(0>n)return c.__absoluteGreater(r);var o=e.length,s=e.__digit(o-1),a=c.__clz30(s),u=30*o-a,d=n+1;if(u<d)return c.__absoluteLess(r);if(u>d)return c.__absoluteGreater(r);var l=1048576|1048575&c.__kBitConversionInts[1],h=c.__kBitConversionInts[0],f=20,p=29-a;if(p!==(0|(u-1)%30))throw new Error("implementation bug");var m,g=0;if(p<f){var _=f-p;g=_+32,m=l>>>_,l=l<<32-_|h>>>_,h<<=32-_}else if(p===f)g=32,m=l,l=h,h=0;else{var S=p-f;g=32-S,m=l<<S|h>>>32-S,l=h<<S,h=0}if((s>>>=0)>(m>>>=0))return c.__absoluteGreater(r);if(s<m)return c.__absoluteLess(r);for(var v=o-2;0<=v;v--){0<g?(g-=30,m=l>>>2,l=l<<30|h>>>2,h<<=30):m=0;var y=e.__unsignedDigit(v);if(y>m)return c.__absoluteGreater(r);if(y<m)return c.__absoluteLess(r)}if(0!==l||0!==h){if(0===g)throw new Error("implementation bug");return c.__absoluteLess(r)}return 0}},{key:"__equalToNumber",value:function(e,r){return c.__isOneDigitInt(r)?0===r?0===e.length:1===e.length&&e.sign===0>r&&e.__unsignedDigit(0)===t(r):0===c.__compareToDouble(e,r)}},{key:"__comparisonResultToBool",value:function(e,t){return 0===t?0>e:1===t?0>=e:2===t?0<e:3===t?0<=e:void 0}},{key:"__compare",value:function(e,t,r){if(e=c.__toPrimitive(e),t=c.__toPrimitive(t),"string"==typeof e&&"string"==typeof t)switch(r){case 0:return e<t;case 1:return e<=t;case 2:return e>t;case 3:return e>=t}if(c.__isBigInt(e)&&"string"==typeof t)return null!==(t=c.__fromString(t))&&c.__comparisonResultToBool(c.__compareToBigInt(e,t),r);if("string"==typeof e&&c.__isBigInt(t))return null!==(e=c.__fromString(e))&&c.__comparisonResultToBool(c.__compareToBigInt(e,t),r);if(e=c.__toNumeric(e),t=c.__toNumeric(t),c.__isBigInt(e)){if(c.__isBigInt(t))return c.__comparisonResultToBool(c.__compareToBigInt(e,t),r);if("number"!=typeof t)throw new Error("implementation bug");return c.__comparisonResultToBool(c.__compareToNumber(e,t),r)}if("number"!=typeof e)throw new Error("implementation bug");if(c.__isBigInt(t))return c.__comparisonResultToBool(c.__compareToNumber(t,e),2^r);if("number"!=typeof t)throw new Error("implementation bug");return 0===r?e<t:1===r?e<=t:2===r?e>t:3===r?e>=t:void 0}},{key:"__absoluteAdd",value:function(e,t,r){if(e.length<t.length)return c.__absoluteAdd(t,e,r);if(0===e.length)return e;if(0===t.length)return e.sign===r?e:c.unaryMinus(e);var i=e.length;(0===e.__clzmsd()||t.length===e.length&&0===t.__clzmsd())&&i++;for(var n,o=new c(i,r),s=0,a=0;a<t.length;a++)s=(n=e.__digit(a)+t.__digit(a)+s)>>>30,o.__setDigit(a,1073741823&n);for(;a<e.length;a++){var u=e.__digit(a)+s;s=u>>>30,o.__setDigit(a,1073741823&u)}return a<o.length&&o.__setDigit(a,s),o.__trim()}},{key:"__absoluteSub",value:function(e,t,r){if(0===e.length)return e;if(0===t.length)return e.sign===r?e:c.unaryMinus(e);for(var i,n=new c(e.length,r),o=0,s=0;s<t.length;s++)o=1&(i=e.__digit(s)-t.__digit(s)-o)>>>30,n.__setDigit(s,1073741823&i);for(;s<e.length;s++){var a=e.__digit(s)-o;o=1&a>>>30,n.__setDigit(s,1073741823&a)}return n.__trim()}},{key:"__absoluteAddOne",value:function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,i=e.length;null===r?r=new c(i,t):r.sign=t;for(var n,o=1,s=0;s<i;s++)o=(n=e.__digit(s)+o)>>>30,r.__setDigit(s,1073741823&n);return 0!==o&&r.__setDigitGrow(i,1),r}},{key:"__absoluteSubOne",value:function(e,t){for(var r,i=e.length,n=new c(t=t||i,!1),o=1,s=0;s<i;s++)o=1&(r=e.__digit(s)-o)>>>30,n.__setDigit(s,1073741823&r);if(0!==o)throw new Error("implementation bug");for(var a=i;a<t;a++)n.__setDigit(a,0);return n}},{key:"__absoluteAnd",value:function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,i=e.length,n=t.length,o=n;if(i<n){o=i;var s=e,a=i;e=t,i=n,t=s,n=a}var u=o;null===r?r=new c(u,!1):u=r.length;for(var d=0;d<o;d++)r.__setDigit(d,e.__digit(d)&t.__digit(d));for(;d<u;d++)r.__setDigit(d,0);return r}},{key:"__absoluteAndNot",value:function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,i=e.length,n=t.length,o=n;i<n&&(o=i);var s=i;null===r?r=new c(s,!1):s=r.length;for(var a=0;a<o;a++)r.__setDigit(a,e.__digit(a)&~t.__digit(a));for(;a<i;a++)r.__setDigit(a,e.__digit(a));for(;a<s;a++)r.__setDigit(a,0);return r}},{key:"__absoluteOr",value:function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,i=e.length,n=t.length,o=n;if(i<n){o=i;var s=e,a=i;e=t,i=n,t=s,n=a}var u=i;null===r?r=new c(u,!1):u=r.length;for(var d=0;d<o;d++)r.__setDigit(d,e.__digit(d)|t.__digit(d));for(;d<i;d++)r.__setDigit(d,e.__digit(d));for(;d<u;d++)r.__setDigit(d,0);return r}},{key:"__absoluteXor",value:function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,i=e.length,n=t.length,o=n;if(i<n){o=i;var s=e,a=i;e=t,i=n,t=s,n=a}var u=i;null===r?r=new c(u,!1):u=r.length;for(var d=0;d<o;d++)r.__setDigit(d,e.__digit(d)^t.__digit(d));for(;d<i;d++)r.__setDigit(d,e.__digit(d));for(;d<u;d++)r.__setDigit(d,0);return r}},{key:"__absoluteCompare",value:function(e,t){var r=e.length-t.length;if(0!=r)return r;for(var i=e.length-1;0<=i&&e.__digit(i)===t.__digit(i);)i--;return 0>i?0:e.__unsignedDigit(i)>t.__unsignedDigit(i)?1:-1}},{key:"__multiplyAccumulate",value:function(e,t,r,i){if(0!==t){for(var n=32767&t,o=t>>>15,s=0,a=0,u=0;u<e.length;u++,i++){var d=r.__digit(i),l=e.__digit(u),h=32767&l,f=l>>>15,p=c.__imul(h,n),m=c.__imul(h,o),g=c.__imul(f,n);s=(d+=a+p+s)>>>30,d&=1073741823,s+=(d+=((32767&m)<<15)+((32767&g)<<15))>>>30,a=c.__imul(f,o)+(m>>>15)+(g>>>15),r.__setDigit(i,1073741823&d)}for(;0!==s||0!==a;i++){var _=r.__digit(i);_+=s+a,a=0,s=_>>>30,r.__setDigit(i,1073741823&_)}}}},{key:"__internalMultiplyAdd",value:function(e,t,r,i,n){for(var o=r,s=0,a=0;a<i;a++){var u=e.__digit(a),d=c.__imul(32767&u,t),l=c.__imul(u>>>15,t),h=d+((32767&l)<<15)+s+o;o=h>>>30,s=l>>>15,n.__setDigit(a,1073741823&h)}if(n.length>i)for(n.__setDigit(i++,o+s);i<n.length;)n.__setDigit(i++,0);else if(0!==o+s)throw new Error("implementation bug")}},{key:"__absoluteDivSmall",value:function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;null===r&&(r=new c(e.length,!1));for(var i=0,n=2*e.length-1;0<=n;n-=2){var o=(i<<15|e.__halfDigit(n))>>>0,s=0|o/t,a=0|(o=((i=0|o%t)<<15|e.__halfDigit(n-1))>>>0)/t;i=0|o%t,r.__setDigit(n>>>1,s<<15|a)}return r}},{key:"__absoluteModSmall",value:function(e,t){for(var r=0,i=2*e.length-1;0<=i;i--)r=0|((r<<15|e.__halfDigit(i))>>>0)%t;return r}},{key:"__absoluteDivLarge",value:function(e,t,r,i){var n=t.__halfDigitLength(),o=t.length,s=e.__halfDigitLength()-n,a=null;r&&(a=new c(s+2>>>1,!1)).__initializeDigits();var u=new c(n+2>>>1,!1);u.__initializeDigits();var d=c.__clz15(t.__halfDigit(n-1));0<d&&(t=c.__specialLeftShift(t,d,0));for(var l=c.__specialLeftShift(e,d,1),h=t.__halfDigit(n-1),f=0,p=s;0<=p;p--){var m=32767,g=l.__halfDigit(p+n);if(g!==h){var _=(g<<15|l.__halfDigit(p+n-1))>>>0;m=0|_/h;for(var S=0|_%h,v=t.__halfDigit(n-2),y=l.__halfDigit(p+n-2);c.__imul(m,v)>>>0>(S<<16|y)>>>0&&(m--,!(32767<(S+=h))););}c.__internalMultiplyAdd(t,m,0,o,u);var I=l.__inplaceSub(u,p,n+1);0!==I&&(I=l.__inplaceAdd(t,p,n),l.__setHalfDigit(p+n,32767&l.__halfDigit(p+n)+I),m--),r&&(1&p?f=m<<15:a.__setDigit(p>>>1,f|m))}if(i)return l.__inplaceRightShift(d),r?{quotient:a,remainder:l}:l;if(r)return a;throw new Error("unreachable")}},{key:"__clz15",value:function(e){return c.__clz30(e)-15}},{key:"__specialLeftShift",value:function(e,t,r){var i=e.length,n=new c(i+r,!1);if(0===t){for(var o=0;o<i;o++)n.__setDigit(o,e.__digit(o));return 0<r&&n.__setDigit(i,0),n}for(var s,a=0,u=0;u<i;u++)s=e.__digit(u),n.__setDigit(u,1073741823&s<<t|a),a=s>>>30-t;return 0<r&&n.__setDigit(i,a),n}},{key:"__leftShiftByAbsolute",value:function(e,t){var r=c.__toShiftAmount(t);if(0>r)throw new RangeError("BigInt too big");var i=0|r/30,n=r%30,o=e.length,s=0!==n&&0!=e.__digit(o-1)>>>30-n,a=o+i+(s?1:0),u=new c(a,e.sign);if(0===n){for(var d=0;d<i;d++)u.__setDigit(d,0);for(;d<a;d++)u.__setDigit(d,e.__digit(d-i))}else{for(var l=0,h=0;h<i;h++)u.__setDigit(h,0);for(var f,p=0;p<o;p++)f=e.__digit(p),u.__setDigit(p+i,1073741823&f<<n|l),l=f>>>30-n;if(s)u.__setDigit(o+i,l);else if(0!==l)throw new Error("implementation bug")}return u.__trim()}},{key:"__rightShiftByAbsolute",value:function(e,t){var r=e.length,i=e.sign,n=c.__toShiftAmount(t);if(0>n)return c.__rightShiftByMaximum(i);var o=0|n/30,s=n%30,a=r-o;if(0>=a)return c.__rightShiftByMaximum(i);var u=!1;if(i)if(0!=(e.__digit(o)&(1<<s)-1))u=!0;else for(var d=0;d<o;d++)if(0!==e.__digit(d)){u=!0;break}u&&0===s&&0==~e.__digit(r-1)&&a++;var l=new c(a,i);if(0===s){l.__setDigit(a-1,0);for(var h=o;h<r;h++)l.__setDigit(h-o,e.__digit(h))}else{for(var f,p=e.__digit(o)>>>s,m=r-o-1,g=0;g<m;g++)f=e.__digit(g+o+1),l.__setDigit(g,1073741823&f<<30-s|p),p=f>>>s;l.__setDigit(m,p)}return u&&(l=c.__absoluteAddOne(l,!0,l)),l.__trim()}},{key:"__rightShiftByMaximum",value:function(e){return e?c.__oneDigit(1,!0):c.__zero()}},{key:"__toShiftAmount",value:function(e){if(1<e.length)return-1;var t=e.__unsignedDigit(0);return t>c.__kMaxLengthBits?-1:t}},{key:"__toPrimitive",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"default";if("object"!==r(e))return e;if(e.constructor===c)return e;if("undefined"!=typeof Symbol&&"symbol"===r(Symbol.toPrimitive)){var i=e[Symbol.toPrimitive];if(i){var n=i(t);if("object"!==r(n))return n;throw new TypeError("Cannot convert object to primitive value")}}var o=e.valueOf;if(o){var s=o.call(e);if("object"!==r(s))return s}var a=e.toString;if(a){var u=a.call(e);if("object"!==r(u))return u}throw new TypeError("Cannot convert object to primitive value")}},{key:"__toNumeric",value:function(e){return c.__isBigInt(e)?e:+e}},{key:"__isBigInt",value:function(e){return"object"===r(e)&&null!==e&&e.constructor===c}},{key:"__truncateToNBits",value:function(e,t){for(var r=0|(e+29)/30,i=new c(r,t.sign),n=r-1,o=0;o<n;o++)i.__setDigit(o,t.__digit(o));var s=t.__digit(n);if(0!=e%30){var a=32-e%30;s=s<<a>>>a}return i.__setDigit(n,s),i.__trim()}},{key:"__truncateAndSubFromPowerOfTwo",value:function(e,t,r){for(var i,n=Math.min,o=0|(e+29)/30,s=new c(o,r),a=0,u=o-1,d=0,l=n(u,t.length);a<l;a++)d=1&(i=0-t.__digit(a)-d)>>>30,s.__setDigit(a,1073741823&i);for(;a<u;a++)s.__setDigit(a,0|1073741823&-d);var h,f=u<t.length?t.__digit(u):0,p=e%30;if(0===p)h=0-f-d,h&=1073741823;else{var m=32-p,g=1<<32-m;h=g-(f=f<<m>>>m)-d,h&=g-1}return s.__setDigit(u,h),s.__trim()}},{key:"__digitPow",value:function(e,t){for(var r=1;0<t;)1&t&&(r*=e),t>>>=1,e*=e;return r}},{key:"__isOneDigitInt",value:function(e){return(1073741823&e)===e}}]),c}(h(Array));return R.__kMaxLength=33554432,R.__kMaxLengthBits=R.__kMaxLength<<5,R.__kMaxBitsPerChar=[0,0,32,51,64,75,83,90,96,102,107,111,115,119,122,126,128,131,134,136,139,141,143,145,147,149,151,153,154,156,158,159,160,162,163,165,166],R.__kBitsPerCharTableShift=5,R.__kBitsPerCharTableMultiplier=1<<R.__kBitsPerCharTableShift,R.__kConversionChars=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],R.__kBitConversionBuffer=new ArrayBuffer(8),R.__kBitConversionDouble=new Float64Array(R.__kBitConversionBuffer),R.__kBitConversionInts=new Int32Array(R.__kBitConversionBuffer),R.__clz30=t?function(e){return t(e)-2}:function(e){var t=Math.LN2,r=Math.log;return 0===e?30:0|29-(0|r(e>>>0)/t)},R.__imul=e||function(e,t){return 0|e*t},R}()}(gM);var _M=gM.exports;const SM="CommandMsgManager";class vM{constructor(e,r){t(this,"RTP_HEADER_V_P_X_CC",144),t(this,"RTP_HEADER_V_P_X_CC_BRODACAST",128),this.event=e,this.remoteUserManager=r,this.cmdMsgPacketSeqNum=0}receivedCmdRtpPacketDecode(e){var t,r;const i=new DataView(e),n=i.getUint16(2),o=i.getUint32(4);MR.getLogger().debug(SM,"receive ".concat(n," msg of timeStamp ").concat(o));const s=i.getUint32(8);if(s!==this.cmdReceiveSsrc)return void MR.getLogger().error(SM,"receive msg ssrc not matched, ".concat(this.cmdReceiveSsrc," - ").concat(s));let a=0;if(0==(16&i.getUint8(0)))a=12;else{a=16+4*i.getUint16(14)}const c=_M.toNumber(_M.DataViewGetBigUint64(i,a)),u=i.buffer.slice(a+16);let d=null;d=this.msgFormat===gC.STRING?yM.ArrayBufferToMsg(u):u,this.event.emit(hC.CmdMsgReceived,{msg:d,srcUserId:null===(t=this.remoteUserManager.getUserInfoByUid(c,this.roomId))||void 0===t||null===(r=t.userInfo)||void 0===r?void 0:r.userId})}genCmdRtpPacketMsg(e){const t=!e.userUid,r=new DataView(new ArrayBuffer(t?28:44));t?r.setUint8(0,this.RTP_HEADER_V_P_X_CC_BRODACAST):r.setUint8(0,this.RTP_HEADER_V_P_X_CC),r.setUint8(1,this.RTP_HEADER_M_PT),r.setUint16(2,this.cmdMsgPacketSeqNum++),r.setUint32(4,Math.floor((new Date).getTime()/1e3)),r.setUint32(8,this.cmdSendSsrc);const{userUid:i=0,msg:n}=e;let o=0;return t?o=12:(r.setUint16(12,4096),r.setUint16(14,3),r.setUint8(16,21),r.setUint8(17,8),_M.DataViewSetBigUint64(r,18,_M.BigInt(i)),r.setUint16(26,0),o=28),_M.DataViewSetBigUint64(r,o,_M.BigInt(this.selfUserUid)),_M.DataViewSetBigUint64(r,o+8,_M.BigInt(0)),yM.concatArrayBuffer(r.buffer,yM.msgBodyToArrayBuffer(n))}sendCommandMsg(e,t,r){let i=0;var n,o;t&&(i=null===(n=this.remoteUserManager.getUserInfoById(t,r))||void 0===n||null===(o=n.userInfo)||void 0===o?void 0:o.userUid);return this.transportChannel.sendMessage(this.genCmdRtpPacketMsg({msg:e,userUid:i}))}setCommandChannelParams(e,t){this.reset(),this.RTP_HEADER_M_PT=t.tranportOptions.payload,this.roomId=e,this.msgFormat=t.msgFormat,this.cmdSendSsrc=t.tranportOptions.sendSsrc,this.cmdReceiveSsrc=t.tranportOptions.receiveSsrc,this.selfUserUid=t.tranportOptions.userUid,this.extraParamsHandle(t),this.initCmdTranportChannel()}}class yM{static msgBodyToArrayBuffer(e){if("string"==typeof e){return(new TextEncoder).encode(e).buffer}return e}static ArrayBufferToMsg(e){return new TextDecoder("utf-8").decode(e)}static concatArrayBuffer(){let e=0;for(var t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];for(const s of r)e+=s.byteLength;const n=new Uint8Array(e);let o=0;for(const s of r){const e=new Uint8Array(s);n.set(e,o),o+=s.byteLength}return n.buffer}static arrayBufferToNumberArray(e){const t=[];for(let r=0;r<e.byteLength;r+=4)t.push(e.getUint32(r));return t}static numberArrayToArrayBuffer(e){const t=new DataView(new ArrayBuffer(4*e.length));for(let r=0;r<e.length;r++)t.setUint32(4*r,e[r]);return t.buffer}}const IM="WebsocketMsgManager";class TM{constructor(){this.event_=new bk,this.connectionCallbacks=new Map}on(e,t){this.event_.on(e,t)}off(e,t){t?this.event_.removeListener(e,t):this.event_.removeAllListeners(e)}async wsConnect(e,t,r,i,n){return await nO.callWithRetryTimes((async t=>await this.wsConnectOnce(e,r,i,t)),!1,t,this.getAsyncInterval(n),this.needInterrupted())}getAsyncInterval(e){return t=>"function"==typeof(null==t?void 0:t.getCode)&&t.getCode()===Wc.RTC_ERR_CODE_WAIT_RSP_TIMEOUT?0:e}needInterrupted(){return e=>"function"==typeof(null==e?void 0:e.getCode)&&e.getCode()===Wc.RTC_ERR_CODE_WEBSOCKET_INTERRUPTED}async wsConnectOnce(e,t,r,i){this.close(),this.connectionId=bR.generateRandomId(32),this.websocket=new WebSocket(e),this.websocket.binaryType="arraybuffer",MR.getLogger().info(IM,"wsConnectOnce, url:".concat(bR.shieldUrlParameters(e),", begin create websocket ").concat(this.connectionId," connection with server ")),this.websocket.onopen=this.onopen.bind(this),this.websocket.onerror=this.onerror.bind(this),this.websocket.onmessage=this.onmessage.bind(this),this.websocket.onclose=this.onclose.bind(this);try{const e=1===i?t:r;await this.getConnectionResp(e,this.connectionId)}catch(kD){throw MR.getLogger().error(IM,"wsConnectOnce, connect occur exception, error: ".concat(kD)),kD}finally{this.connectionCallbacks.delete(this.connectionId)}}async getConnectionResp(e,t){await nO.callWithTimeout(new Promise(((e,r)=>{this.connectionCallbacks.set(t,(i=>{if(i.isSuccess)MR.getLogger().info(IM,"getConnectionResp, connectId:".concat(t,", connect success")),e();else{const e=Wc.RTC_ERR_CODE_WEBSOCKET_CONNECT_ERROR,n=i.code,o="".concat(n||""," websocket connect error"),s=new qc(e,o);MR.getLogger().info(IM,"getConnectionResp, connectId:".concat(t,", connect fail, errMsg=").concat(s)),r(s)}}))})),e).catch((t=>{if(t.getCode()!==Wc.RTC_ERR_CODE_WAIT_RSP_TIMEOUT)throw t;throw MR.getLogger().error(IM,"getConnectionResp, websocket connect timeout after ".concat(e," ms")),this.websocket&&this.websocket.readyState===this.websocket.CONNECTING&&(MR.getLogger().info(IM,"getConnectionResp, websocket connect timeout, close webSocket manual"),this.close()),new qc(Wc.RTC_ERR_CODE_WEBSOCKET_CONNECT_TIMEOUT)})).finally((()=>{this.connectionCallbacks.delete(t)}))}onopen(){MR.getLogger().info(IM,"onopen, wss connection success."),this.connectionCallbacks.has(this.connectionId)&&this.connectionCallbacks.get(this.connectionId)({isSuccess:!0}),this.event_.emit("CMD_CHANNEL_ESTABLISHED")}onmessage(e){e.data?this.event_.emit("CMD_MSG_REVEIVED",e.data):MR.getLogger().error(IM,"onerror, websocket message is null.")}onerror(e){MR.getLogger().error(IM,"onerror, websocket occur error:".concat(JSON.stringify(e))),this.connectionCallbacks.has(this.connectionId)&&this.connectionCallbacks.get(this.connectionId)({isSuccess:!1})}async onclose(e){const t=e.code,r=e.reason;MR.getLogger().warn(IM,"onclose, code:".concat(t,", reason:").concat(r)),this.connectionCallbacks.has(this.connectionId)&&this.connectionCallbacks.get(this.connectionId)({isSuccess:!1,code:t,reason:r}),MR.getLogger().error(IM,"reconnect"),this.event_.emit("CMD_CONNECTION_RECONNECT")}sendMessage(e){if(!this.websocket)return MR.getLogger().error(IM,"send cmd message failed for websocket is null."),!1;try{return this.websocket.send(e),!0}catch(kD){return MR.getLogger().error(IM,"send cmd message failed."),!1}}close(){this.websocket&&(this.websocket.onopen=null,this.websocket.onerror=null,this.websocket.onmessage=null,this.websocket.onclose=null,this.websocket.close(),this.websocket=null,this.connectionCallbacks.clear())}}class RM extends vM{constructor(e,t){super(e,t),this.reconnctInterval=[2,5,10,20],this.reconnctIdx=0}initCmdTranportChannel(){this.transportChannel||(this.transportChannel=new TM),this.transportChannel.on("CMD_MSG_REVEIVED",(e=>{this.receivedCmdRtpPacketDecode(e)})),this.transportChannel.on("CMD_CHANNEL_ESTABLISHED",(()=>{MR.getLogger().info(IM,"cmd websocket connection established."),this.event.emit(hC.CmdChannelEstablished,mC.WEBSOCKET),this.reconnctIdx=0,this.transportChannel.sendMessage(this.genCmdBindRtpPacketMsg())})),this.transportChannel.on("CMD_CONNECTION_RECONNECT",(async()=>{if(this.reconnctIdx===this.reconnctInterval.length)MR.getLogger().info(IM,"cmd websocket connection disconnect."),this.event.emit(hC.CmdChannelDisconnect,mC.WEBSOCKET);else try{this.event.emit(hC.CmdChannelReconnecting);const e=this.reconnctInterval[Math.min(this.reconnctIdx,this.reconnctInterval.length-1)];if(MR.getLogger().error(IM,"cmd websocket reconnect wait for ".concat(e,"s.")),await bR.sleep(1e3*e),!this.transportChannel)return;this.reconnctIdx++,MR.getLogger().error(IM,"cmd websocket reconnect begin."),await this.transportChannel.wsConnect(this.cmdSocketUrl,1,1e4,1e4,500)}catch(kD){MR.getLogger().error(IM,"cmd websocket reconnect failed: ".concat(kD))}}));try{this.transportChannel.wsConnect(this.cmdSocketUrl,1,1e4,1e4,500)}catch(kD){MR.getLogger().error(IM,"cmd websocket connect failed: ".concat(kD))}}extraParamsHandle(e){this.bindCryptoKey=e.wsOptions.bindCryptoKey,this.cmdSocketUrl=e.wsOptions.wsDomain?e.wsOptions.wsUrl.replace(/(ws(s)?:\/\/)[^\/|:]+(.*)/,"$1".concat(e.wsOptions.wsDomain,"$3")):e.wsOptions.wsUrl}reset(){this.roomId=null,this.cmdSendSsrc=0,this.cmdReceiveSsrc=0,this.selfUserUid=0,this.bindCryptoKey=null,this.cmdMsgPacketSeqNum=0,this.reconnctIdx=0,this.transportChannel&&(this.transportChannel.off("CMD_MSG_REVEIVED"),this.transportChannel.off("CMD_CHANNEL_ESTABLISHED"),this.transportChannel.off("CMD_CONNECTION_RECONNECT"),this.transportChannel.close(),this.transportChannel=null)}genCmdBindRtpPacketMsg(){const e=new DataView(new ArrayBuffer(20));e.setUint8(0,this.RTP_HEADER_V_P_X_CC),e.setUint8(1,this.RTP_HEADER_M_PT),e.setUint16(2,this.cmdMsgPacketSeqNum++),e.setUint32(4,Math.floor((new Date).getTime()/1e3)),e.setUint32(8,this.cmdSendSsrc),e.setUint16(12,4096),e.setUint16(14,1),e.setUint8(16,24),e.setUint8(17,1),e.setUint8(18,0),e.setUint8(19,0);const t=yM.numberArrayToArrayBuffer(BI.exports.HmacSHA256(BI.exports.lib.WordArray.create(yM.arrayBufferToNumberArray(e)),this.bindCryptoKey).words);return yM.concatArrayBuffer(e.buffer,t)}}const EM="DataChannelMsgManager";class bM{constructor(e){this.event_=new bk,this.dataChannel=e.createDataChannel("commandMsgDataChannel",{ordered:!0}),this.dataChannel.binaryType="arraybuffer",this.dataChannel.onopen=this.onopen.bind(this),this.dataChannel.onerror=this.onerror.bind(this),this.dataChannel.onmessage=this.onmessage.bind(this),this.dataChannel.onclose=this.onclose.bind(this)}on(e,t){this.event_.on(e,t)}off(e,t){t?this.event_.removeListener(e,t):this.event_.removeAllListeners(e)}sendMessage(e){var t;if(!this.dataChannel||"open"!==this.dataChannel.readyState)return MR.getLogger().error(EM,"send message with dataChannel failed for dataChannel unavaliable: ".concat(null===(t=this.dataChannel)||void 0===t?void 0:t.readyState,".")),!1;try{return this.dataChannel.bufferedAmount>=1024e6&&MR.getLogger().warn(EM,"buffer over high threshold of 1M: ".concat(this.dataChannel.bufferedAmount,", send message may blocked and delay.")),this.dataChannel.send(e),!0}catch(kD){return MR.getLogger().error(EM,"send message with dataChannel occur error: ".concat(kD,".")),!1}}close(){this.dataChannel&&(this.dataChannel.onopen=null,this.dataChannel.onerror=null,this.dataChannel.onmessage=null,this.dataChannel.onclose=null,this.dataChannel.close(),this.dataChannel=null)}onopen(){MR.getLogger().info(EM,"onopen, RTCDataChannel connection status: ".concat(this.dataChannel.readyState)),clearTimeout(this.dataChannelDisConnectTimer),this.event_.emit("CMD_CHANNEL_ESTABLISHED")}onmessage(e){e.data?this.event_.emit("CMD_MSG_REVEIVED",e.data):MR.getLogger().error(EM,"onerror, RTCDataChannel message is null.")}onerror(e){MR.getLogger().error(EM,"onerror, RTCDataChannel occur error: ".concat(e)),this.dataChannelDisConnectTimer||(this.dataChannelDisConnectTimer=setTimeout((()=>{clearTimeout(this.dataChannelDisConnectTimer),this.event_.emit("CMD_CHANNEL_DISCONNECT")}),3e4))}onclose(e){MR.getLogger().info(EM,"onclose, RTCDataChannel closed: ".concat(e)),this.dataChannelDisConnectTimer||(this.dataChannelDisConnectTimer=setTimeout((()=>{clearTimeout(this.dataChannelDisConnectTimer),this.event_.emit("CMD_CHANNEL_DISCONNECT")}),3e4))}}class CM extends vM{initCmdTranportChannel(){this.transportChannel||(this.transportChannel=new bM(this.connection)),this.transportChannel.on("CMD_MSG_REVEIVED",(e=>{super.receivedCmdRtpPacketDecode(e)})),this.transportChannel.on("CMD_CHANNEL_ESTABLISHED",(()=>{MR.getLogger().info(EM,"cmd dataChannel connection established."),this.event.emit(hC.CmdChannelEstablished,mC.DATA_CHANNEL)})),this.transportChannel.on("CMD_CHANNEL_DISCONNECT",(()=>{MR.getLogger().info(EM,"cmd dataChannel connection disconnect."),this.event.emit(hC.CmdChannelDisconnect,mC.DATA_CHANNEL)}))}extraParamsHandle(e){this.connection=e.dataChannelOptions.connection}reset(){this.roomId=null,this.cmdSendSsrc=0,this.cmdReceiveSsrc=0,this.selfUserUid=0,this.cmdMsgPacketSeqNum=0,this.transportChannel&&(this.transportChannel.off("CMD_MSG_REVEIVED"),this.transportChannel.off("CMD_CHANNEL_ESTABLISHED"),this.transportChannel.close(),this.transportChannel=null)}}var AM,wM,kM,OM,PM,MM,DM,NM,UM,xM,LM,BM,VM,YM,jM,FM,HM,KM,zM,WM,GM,qM,JM,XM,QM,$M,ZM,eD,tD,rD,iD,nD,oD,sD,aD,cD,uD,dD;const lD=1e4;var hD;!function(e){e[e.mute=0]="mute",e[e.unmute=1]="unmute",e[e.noChange=2]="noChange"}(hD||(hD={}));const fD={FHD:iC.main,HD:iC.middle1,SD:iC.middle2,LD:iC.slides},pD="Client";let mD=(AM=rO("Client$enableTopThreeAudioMode#boolean#boolean"),wM=eO("".concat(pD,"_switchAudioMode")),kM=rO("Client$getConnectionState#string"),OM=rO("Client$setNetworkBandwidth#void#NetworkBandwidth"),PM=tO("Client$join#Promise<void>#string#JoinConfig"),MM=tO("Client$enableRtcStats#Promise<void>#boolean#number"),DM=tO("Client$leave#Promise<void>"),NM=tO("Client$publish#Promise<void>#Stream#PublishOption"),UM=eO("".concat(pD,"_publishImpl")),xM=tO("Client$unpublish#Promise<void>#Stream"),LM=tO("Client$subscribeAudio#Promise<RemoteStream | void>#string"),BM=tO("Client$unSubscribeAudio#Promise<void>#string"),VM=tO("Client$subscribe#Promise<void>#RemoteStream#SubscribeOption"),YM=tO("Client$batchSubscribe#Promise<void>#SubscribeParam[]"),jM=tO("Client$unsubscribe#Promise<void>#Stream#SubscribeOption"),FM=tO("Client$switchRole#Promise<void>#number#Authorization"),HM=eO("".concat(pD,"_refreshRemoteStreamList")),KM=eO("".concat(pD,"_updateRemoteStream")),zM=eO("".concat(pD,"_removeRemoteStream")),WM=eO("".concat(pD,"_handleWatchMsg")),GM=eO("".concat(pD,"_refreshRoomUserInfos")),qM=rO("Client$setVolume4TopThree#void#number"),JM=rO("Client$muteAudio4TopThree#void#boolean"),XM=tO("Client$setAudioOutput4TopThree#void"),QM=rO("Client$isTopNAudioMuted#boolean"),$M=tO("Client$changeUserName#Promise<boolean>#string"),ZM=tO("Client$startLiveStreaming#Promise<boolean>#string#string[]#PublishConfig#UserConfig[]"),eD=tO("Client$updateLiveStreaming#Promise<void>#string#string[]#PublishConfig#UserConfig[]"),tD=tO("Client$stopLiveStreaming#Promise<void>#string"),rD=rO("Client$setProxyServer#void#string"),iD=rO("Client$setTurnServer#void#TurnServerConfig"),nD=tO("Client$addMultiRoomMediaRelay#Promise<MultiRoomMediaRelayResult[]>#MultiRoomMediaRelayInfo"),oD=tO("Client$stopMultiRoomMediaRelay#Promise<MultiRoomMediaRelayResult[]>#MultiRoomMediaRelayInfo"),sD=rO("Client$addRelayClient#Client#string"),aD=tO("Client$stopRelayClient#Promise<void>#string"),cD=rO("Client$enableCommandMsg#boolean#boolean"),uD=rO("Client$renewSignature#boolean#ctime#signature"),dD=class e extends jO{constructor(e,r){super({logger:!0,stat:!0,emitter:!0,config:e}),t(this,"status",aC.Idle),t(this,"localRejoinFlag",!1),t(this,"resolutionChangeInfo",{mainResolutionChangeTimer:null,auxResolutionChangeTimer:null,preVideoHeight:new Map}),this.clientSymbol=Symbol("".concat(pD,"_").concat(YO.getSequence())),r&&(this.mainRelayRoomSymbol=r),this.locker=new Xk,this.roomId="",this.clientConfig=e,this.userInfo=void 0,this.waitConfigCallbackFunc=void 0,this.topNAudioVolume=100,this.audioPolicy=ak.USER_SUBSCRIBE_AUDIOPOLICY,this.connectState={prevState:"DISCONNECTED",curState:"DISCONNECTED"},this.logger.info(pD,"HRTC VERSION = ".concat(jC,", userAgent = ").concat(navigator.userAgent)),this.top3VolumeUserIds=[],Rk.initDeviceChangedNotify(this.eventEmitter,!1),this.accessManager=new iM(this.logger),this.lastCycleFrameDecodedMap=new Map,this.streamInterruptedUsersMap=new Map,this.streamDetectionCriterion=0,this.audioStreams4TopN=new IP,this.downLinkData=null,this.upLinkData=null,this.preNetQuality=null,this.remoteUserManager=new aM(this),this.stat.setRemoteUserManager(this.remoteUserManager),this.connectionsManager=new WP(this.logger,this.stat,this.eventEmitter),this.streamPublishManager=new RP,this.audioLevelInterval=1e3,this.isLoopRejoining=!1,this.upStreamData=null,this.sdpRepInfo=null,this.startupQoSMap=new Map,this.initReport4WindowEvent(),this.cmdMsgAbility={enable:!1,cmdManager:null,msgFormat:gC.STRING},this.roomStreamStatus={},this.isSignatureExpired=!1,this.pktsLostRate={up:0,down:0}}initReport4WindowEvent(){window.onunload=()=>{var e,t;const r=bR.getCurrentTimestamp();null===(e=this.stat)||void 0===e||e.recordCallbackInfoBeacon("window-onunload",null===(t=this.getInfo())||void 0===t?void 0:t.moduleName,r,r,{event:"window-onunload"},(e=>["object","function"].includes(typeof e)&&e.getStatInfo?JSON.stringify(e.getStatInfo()):JSON.stringify(e||{})))},window.onbeforeunload=()=>{var e,t;const r=bR.getCurrentTimestamp();null===(e=this.stat)||void 0===e||e.recordCallbackInfoBeacon("window-onbeforeunload",null===(t=this.getInfo())||void 0===t?void 0:t.moduleName,r,r,{event:"window-onbeforeunload"},(e=>["object","function"].includes(typeof e)&&e.getStatInfo?JSON.stringify(e.getStatInfo()):JSON.stringify(e||{})))},window.onhashchange=e=>{var t,r;const i=bR.getCurrentTimestamp();null===(t=this.stat)||void 0===t||t.recordCallbackInfoBeacon("window-onhashchange",null===(r=this.getInfo())||void 0===r?void 0:r.moduleName,i,i,{event:"window-onhashchange",newURL:(null==e?void 0:e.newURL)||"",oldURL:(null==e?void 0:e.oldURL)||""},(e=>["object","function"].includes(typeof e)&&e.getStatInfo?JSON.stringify(e.getStatInfo()):JSON.stringify(e||{})))}}getSessionStatus(){return this.status}on(e,t){super.on(e,t,!0)}off(e,t){super.off(e,t,!0)}getSymbol(){return this.identifiedID}getInfo(){var e,t;return{moduleName:"Client",appId:this.clientConfig.appId,roomId:this.roomId,userName:null===(e=this.userInfo)||void 0===e?void 0:e.userName,userId:null===(t=this.userInfo)||void 0===t?void 0:t.userId,domain:this.clientConfig.domain,upStreamData:this.upStreamData,sdpRepInfo:this.sdpRepInfo,countryCode:this.clientConfig.countryCode}}enableTopThreeAudioMode(e){return this.enableTopThreeAudioModeImpl(e)}enableTopThreeAudioModeImpl(e){let t=!1;return e&&this.status===aC.Idle&&(this.audioPolicy=ak.TOPN_AUDIOPOLICY,t=!0),t}async switchAudioMode(e){try{if(e!==ck.TOPN_AUDIOPOLICY&&e!==ck.USER_SUBSCRIBE_AUDIOPOLICY)throw this.logger.error(pD,"audioMode is invalid"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);return e%=2,this.logger.info(pD,"switchAudioMode start, new audioPolicy: ".concat(e,", original audioPolicy: ").concat(this.audioPolicy)),this.status===aC.Joined&&(e===ak.USER_SUBSCRIBE_AUDIOPOLICY&&this.audioPolicy===ak.TOPN_AUDIOPOLICY?(this.audioPolicy=e,await this.switchAudioPolicyTop2User()):e===ak.TOPN_AUDIOPOLICY&&this.audioPolicy===ak.USER_SUBSCRIBE_AUDIOPOLICY&&(this.audioPolicy=e,await this.switchAudioPolicyUser2Top(),this.top3VolumeUserIds&&this.top3VolumeUserIds.length>0&&this.eventEmitter.emit(hC.VolumeIndicator,{userVolumeInfos:this.top3VolumeUserIds}))),this.stat.getMediaStat().setAudioPolicy(this.audioPolicy),this.audioPolicy===ak.USER_SUBSCRIBE_AUDIOPOLICY?ck.USER_SUBSCRIBE_AUDIOPOLICY:ck.TOPN_AUDIOPOLICY}catch(kD){this.logger.error(pD,"switchAudioMode, audioPolicy: ".concat(e,", error: ").concat(kD))}return this.audioPolicy}async switchAudioPolicyTop2User(){await this.signal.changeAudioPolicy(ak.USER_SUBSCRIBE_AUDIOPOLICY),await this.unsubscribeAudio4Top();const e=this.remoteUserManager.getAllUserStreamsByType(this.roomId,null,ok.TRACK_TYPE_VIDEO);for(const t of e){const e=t.mainStream.tracks;for(const t of e)t.isSubscribed&&await this.resubscribeUserAudio()}}async resubscribeUserAudio(){this.logger.info(pD,"resubscribeUserAudio start");const e=this.remoteUserManager.resubscribeMainStreamAudio(this.roomId);await this.updateSubscribe(e),null==e||e.forEach((e=>{var t,r,i,n;(null===(t=e.mainStream)||void 0===t||null===(r=t.tracks4Subscribe)||void 0===r?void 0:r.length)>0&&(null===(i=e.mainStream)||void 0===i||null===(n=i.remoteStream)||void 0===n||n.rePlayAudio())}))}async switchAudioPolicyUser2Top(){await this.unsubscribeAudio4SubscribeUsers(),await this.signal.changeAudioPolicy(ak.TOPN_AUDIOPOLICY),this.remoteUserManager.enableTopThreeAudioMode(this.roomId),await this.connectionsManager.generateAndSetOfferSdpByHandler(sk.STREAM_TYPE_MAIN),await this.connectionsManager.generateAndSetAnswerSdpByHandler(sk.STREAM_TYPE_MAIN,this.addSsrc4Top3.bind(this))}async unsubscribeAudio4SubscribeUsers(){this.logger.info(pD,"unsubscribeAudio4SubscribeUsers start");const e=this.remoteUserManager.unsubscribeAllMainStreamAudio(this.roomId);await this.updateSubscribe(e)}async unsubscribeAudio4Top(){await this.unsubscribeUsersAudio()}async unsubscribeAudio4SubscribeAll(){await this.unsubscribeUsersAudio()}async unsubscribeUsersAudio(){const e=[];for(const t of this.audioStreams4TopN.getAudioStreams()){const r=t.ssrc;this.audioStreams4TopN.close(t.streamId),this.logger.info(pD,"delete audio ssrc:".concat(r)),e.push(r)}e.length>0&&await this.connectionsManager.deleteUser(sk.STREAM_TYPE_MAIN,null,e)}async getLocalAudioStats(){const e=new Map,t=this.streamPublishManager.getPublishedMainAudioTrackInfo();if(!t)return this.logger.error(pD,"local stream has not published yet."),e;if("function"!=typeof t.sender.getStats)return this.logger.error(pD,"audio rtpsender is not support getStat"),e;const r={bytesSent:0,packetsSent:0},i=this.streamPublishManager.getLocalStream(sk.STREAM_TYPE_MAIN),n=this.userInfo.userId||(null==i?void 0:i.getUserId()),o=gk.getLatestStats(this.userInfo.roomId,sk.STREAM_TYPE_MAIN,"".concat(Kb,"_").concat(t.ssrc));return o&&(r.bytesSent=o.bytesSent,r.packetsSent=o.packetsSent,e.set(n,r)),e}async getLocalVideoStats(){const e=new Map,t={mainStream:[],subStream:null};let r=null,i=null;const n=this.streamPublishManager.getMainStreamVideoPublishInfo();if(n){const i=this.streamPublishManager.getLocalStream(sk.STREAM_TYPE_MAIN),o=this.userInfo.userId||(null==i?void 0:i.getUserId());for(const s of n){r={bytesSent:0,packetsSent:0,framesEncoded:0,framesSent:0,frameWidth:0,frameHeight:0};const i=gk.getLatestStats(this.userInfo.roomId,sk.STREAM_TYPE_MAIN,"".concat(zb,"_").concat(s.ssrc));i&&(r.bytesSent=bR.getValue(i.bytesSent,0),r.packetsSent=bR.getValue(i.packetsSent,0),r.framesEncoded=bR.getValue(i.framesEncoded,0),r.framesSent=bR.getValue(i.framesSent,0),r.frameWidth=bR.getValue(i.frameWidth,0),r.frameHeight=bR.getValue(i.frameHeight,0),e.has(o)?e.get(o).mainStream.push(r):(t.mainStream.push(r),e.set(o,t)))}}else this.logger.debug(pD,"have no local mainstream collect stats");const o=this.streamPublishManager.getPublishedAuxVideoTrackInfo();if(o&&"function"==typeof o.sender.getStats){const r=this.streamPublishManager.getLocalStream(sk.STREAM_TYPE_MAIN),n=this.userInfo.userId||(null==r?void 0:r.getUserId());i={bytesSent:0,packetsSent:0,framesEncoded:0,framesSent:0,frameWidth:0,frameHeight:0};const s=gk.getLatestStats(this.userInfo.roomId,sk.STREAM_TYPE_AUX,"".concat(zb,"_").concat(o.ssrc));s&&(i.bytesSent=bR.getValue(s.bytesSent,0),i.packetsSent=bR.getValue(s.packetsSent,0),i.framesEncoded=bR.getValue(s.framesEncoded,0),i.framesSent=bR.getValue(s.framesSent,0),i.frameWidth=bR.getValue(s.frameWidth,0),i.frameHeight=bR.getValue(s.frameHeight,0),e.has(n)?e.get(n).subStream=i:(t.subStream=i,e.set(n,t)))}else this.logger.debug(pD,"have no local substream collect stats");return e}async getRemoteAudioStats(){const e=new Map,t=this.remoteUserManager.getAllUserStreamsByType(this.roomId,sk.STREAM_TYPE_MAIN,ok.TRACK_TYPE_AUDIO),r=this.connectionsManager.getReceivers(sk.STREAM_TYPE_MAIN);if(!r||0===r.length)return this.logger.error(pD,"getRemoteAudioStats, peerConnection is not support getReceivers"),e;for(const i of t){const t=i.userId;if(i.mainStream)for(const r of i.mainStream.tracks){const i={bytesReceived:0,packetsReceived:0,packetsLost:0},n=gk.getLatestStats(this.userInfo.roomId,sk.STREAM_TYPE_MAIN,"".concat(Fb,"_").concat(r.cssrc));t&&n&&(i.bytesReceived=bR.getValue(n.bytesReceived,0),i.packetsReceived=bR.getValue(n.packetsReceived,0),i.packetsLost=bR.getValue(n.packetsLost,0),this.connectionsManager.calcChangedStatistic(n.id,i,["bytesReceived","packetsReceived","packetsLost"]),e.set(t,i))}}return e}async getRemoteVideoStats(){const e=new Map,t=this.remoteUserManager.getAllUserStreamsByType(this.roomId,null,ok.TRACK_TYPE_VIDEO);for(const r of t)r.mainStream&&await this.getRemoteVideoTracksStatistic(r.userId,sk.STREAM_TYPE_MAIN,!1,r.mainStream.tracks,e),r.auxStream&&await this.getRemoteVideoTracksStatistic(r.userId,sk.STREAM_TYPE_AUX,!0,r.auxStream.tracks,e);return e}isSendingStream(){var e,t;const r=(null===(e=this.connectionsManager.getSenders(sk.STREAM_TYPE_MAIN))||void 0===e?void 0:e.length)>0,i=(null===(t=this.connectionsManager.getSenders(sk.STREAM_TYPE_AUX))||void 0===t?void 0:t.length)>0;return r||i}isReceivingStream(){var e,t;const r=(null===(e=this.connectionsManager.getReceivers(sk.STREAM_TYPE_MAIN))||void 0===e?void 0:e.length)>0,i=(null===(t=this.connectionsManager.getReceivers(sk.STREAM_TYPE_AUX))||void 0===t?void 0:t.length)>0;return r||i}async getRemoteVideoTracksStatistic(e,t,r,i,n){if(i&&0!==i.length)for(const o of i){const i=gk.getLatestStats(this.userInfo.roomId,r?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN,"".concat(Hb,"_").concat(o.cssrc));if(!i)continue;const s={streamId:o.trackId,bytesReceived:0,packetsReceived:0,packetsLost:0,framesDecoded:0,frameWidth:0,frameHeight:0,frameRate:0,frameDropped:0};if(s.bytesReceived=bR.getValue(i.bytesReceived,0),s.packetsReceived=bR.getValue(i.packetsReceived,0),s.packetsLost=bR.getValue(i.packetsLost,0),s.framesDecoded=bR.getValue(i.framesDecoded,0),s.frameDropped=bR.getValue(i.framesDropped,0),s.frameRate=bR.getValue(i.framesPerSecond,0),s.frameWidth=i.frameWidth,s.frameHeight=i.frameHeight,this.connectionsManager.calcChangedStatistic(i.id,s,["bytesReceived","packetsReceived","packetsLost","framesDecoded"]),s.frameWidth&&s.frameHeight){const e=i.trackId;if(e){const t=gk.getLatestStats(this.userInfo.roomId,r?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN,e)||{frameWidth:0,frameHeight:0};s.frameWidth=t.frameWidth,s.frameHeight=t.frameHeight}}if(n.has(e))t===sk.STREAM_TYPE_AUX?n.get(e).subStream=s:n.get(e).mainStream.push(s);else{const r={mainStream:[],subStream:null};t===sk.STREAM_TYPE_AUX?r.subStream=s:r.mainStream.push(s),n.set(e,r)}}}async getDownloadStatistic(e){const t=new Map,r=this.remoteUserManager.getAllUserStreamsByType(this.roomId,null,e);for(const s of r)await this.getTrackDownloadStatistic([...s.mainStream.tracks,...s.auxStream.tracks],t);if(0===t.size)return this.downLinkData=null,-1;let i=0,n=0;for(const[s,a]of t)if(this.downLinkData&&this.downLinkData.has(s)){const e=a.packetsReceived-this.downLinkData.get(s).packetsReceived;e>0&&(n+=e,i+=a.packetsLost-this.downLinkData.get(s).packetsLost)}else n+=a.packetsReceived,i+=a.packetsLost;const o=n>0?i/(i+n)*100:-1;return this.downLinkData=t,this.logger.debug(pD,"downLinkData packetsLost:".concat(i,", packetsReceived:").concat(n,",rate:").concat(o)),o}async getTrackDownloadStatistic(e,t){for(const r of e){const e=r.type===ok.TRACK_TYPE_VIDEO?"".concat(Hb):"".concat(Fb),i=gk.getLatestStats(this.userInfo.roomId,r.streamType,"".concat(e,"_").concat(r.cssrc)),n={packetsReceived:0,packetsLost:0};i&&(n.packetsReceived=bR.getValue(i.packetsReceived,0),n.packetsLost=bR.getValue(i.packetsLost,0),this.connectionsManager.calcChangedStatistic(i.id,n),t.set(r.cssrc.toString(),n))}}static getSenderType(e,t){return"audio"===e||t&&t.sender?sk.STREAM_TYPE_MAIN:sk.STREAM_TYPE_AUX}async getUploadStatistic(t){var r,i;const n=this.streamPublishManager.getPublishedMainVideoTrackInfo(),o=this.streamPublishManager.getPublishedMainAudioTrackInfo(),s=this.streamPublishManager.getPublishedAuxVideoTrackInfo();if(!n&&!o&&!s)return-1;const a={packetsLost:0,packetsSent:0,fractionLost:0},c=t===ok.TRACK_TYPE_VIDEO?"".concat(zb):"".concat(Kb),u=t===ok.TRACK_TYPE_VIDEO?(null==n?void 0:n.ssrc)||(null==s?void 0:s.ssrc):null==o?void 0:o.ssrc;if(u){const r=gk.getLatestStats(this.userInfo.roomId,e.getSenderType(t,n),"".concat(c,"_").concat(u));if(r&&(a.packetsSent=bR.getValue(r.packetsSent,0),r.remoteId)){const r=t===ok.TRACK_TYPE_VIDEO?"".concat(Gb):"".concat(Wb),i=gk.getLatestRemoteInboundStats(this.userInfo.roomId,e.getSenderType(t,n),"".concat(r,"_").concat(u));a.packetsLost=bR.getValue(null==i?void 0:i.packetsLost,0),a.fractionLost=bR.getValue(null==i?void 0:i.fractionLost,0)}}let d=0,l=0;this.upLinkData?(l=a.packetsSent-this.upLinkData.packetsSent,d=a.packetsLost-this.upLinkData.packetsLost):(l=a.packetsSent,d=a.packetsLost);const h=(null===(r=this.upLinkData)||void 0===r?void 0:r.deltaPacketsSend)||0,f=(null===(i=this.upLinkData)||void 0===i?void 0:i.deltaPacketsLost)||0;this.upLinkData=a,d<=0?(l=h||this.upLinkData.packetsSent,d=f||this.upLinkData.packetsLost):(this.upLinkData.deltaPacketsSend=l,this.upLinkData.deltaPacketsLost=d);const p=l>0?Math.max(d/l*100,100*(a.fractionLost||0)):-1;return this.logger.debug(pD,"upLinkData packetsLost:".concat(a.packetsLost," ").concat(d," ").concat(100*(a.fractionLost||0),", packetssend:").concat(l,", rate:").concat(p)),p}getConnectionState(){return this.connectState.curState}async getTransportStats(){const e=this.stat.getMediaStat().getTransportMediaStats(),t=this.streamPublishManager.getPublishedMainVideoTrackInfo();if(t){const r=gk.getLatestStats(this.userInfo.roomId,sk.STREAM_TYPE_MAIN,"".concat(Gb,"_").concat(t.ssrc))||{};e.rtt=1e3*(r.roundTripTime||0)}else e.rtt=1e3*this.connectionsManager.getConnectionRTT();return e.upPktsLostRate=this.pktsLostRate.up,e.downPktsLostRate=this.pktsLostRate.down,e}transportStatsRegularReport(){clearTimeout(this.transportStatsTimer),this.transportStatsTimer=setTimeout((()=>{clearTimeout(this.transportStatsTimer),this.calcPktsLostRate().then((async()=>{const e=await this.getTransportStats();if(e.downVideoStreams=await this.getRemoteVideoStats(),this.predownVideoStreams)for(const a of e.downVideoStreams.keys()){var t;for(const t of(null===(r=e.downVideoStreams.get(a))||void 0===r?void 0:r.mainStream)||[]){var r,i;const e=((null===(i=this.predownVideoStreams.get(a))||void 0===i?void 0:i.mainStream)||[]).find((e=>e.streamId===t.streamId));t.bitrate=e?8*Math.max(t.bytesReceived-e.bytesReceived,0):t.bytesReceived,t.frameRate=t.frameRate||(e?Math.max(t.framesDecoded-e.framesDecoded,0):t.framesDecoded)}const o=null===(t=e.downVideoStreams.get(a))||void 0===t?void 0:t.subStream;if(o){var n;const e=null===(n=this.predownVideoStreams.get(a))||void 0===n?void 0:n.subStream;o.bitrate=e?8*Math.max(o.bytesReceived-e.bytesReceived,0):o.bytesReceived,o.frameRate=o.frameRate||(e?Math.max(o.framesDecoded-e.framesDecoded,0):o.framesDecoded)}}else for(const a of e.downVideoStreams.keys()){var o;for(const r of(null===(s=e.downVideoStreams.get(a))||void 0===s?void 0:s.mainStream)||[]){var s;r.bitrate=0}const t=null===(o=e.downVideoStreams.get(a))||void 0===o?void 0:o.subStream;t&&(t.bitrate=0)}this.predownVideoStreams=e.downVideoStreams,this.eventEmitter.emit(hC.TransportStats,e)})).finally(this.transportStatsRegularReport.bind(this,this.predownVideoStreams))}),1e3)}getICETransportStat(e){return this.connectionsManager.getICETransportStat(e)}cleanTransportStats(){this.stat.clearMediaStatBytes()}setNetworkBandwidth(e){if((null==e?void 0:e.maxBandwidth)<cC.MIN_BAND_WIDTH||(null==e?void 0:e.maxBandwidth)>cC.MAX_BAND_WIDTH)throw this.logger.info(pD,"MaxBandWidth Limits [3072Kpbs, 51200Kpbs]"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);this.bandwidthParam={maxBandwidth:1e3*(null==e?void 0:e.maxBandwidth)||cC.DEFAULT_BANDWIDTH_4M}}async join(e,t){return await this.joinImpl(e,t)}async joinImpl(e,t){MR.addPrivacyString(null==t?void 0:t.userId),MR.addPrivacyString(null==t?void 0:t.userName),MR.addPrivacyString(null==t?void 0:t.signature),this.logger.info(pD,"join room roomId:".concat(e," userId:").concat(t.userId," role:").concat(t.role));const r=[];let i="";this.roomId=e;try{var n,o,s,a;if(this.status!==aC.Idle)throw this.logger.error(pD,"room status error!"),this.stat.reportJoinInfo(vC.ROOM_NOT_AVAILABLE,void 0,!1,void 0,"room status error!"),new qc(Wc.RTC_ERR_CODE_STATUS_ERROR);eA.checkJoinParams(e,t),this.mainRelayRoomSymbol&&hM.roleValidCheck4RelayRoom(this,t.role);const c=$O.init(this.identifiedID,e,t);this.userInfo=c;const u=await this.accessManager.getAccessInfo(this.clientConfig.countryCode,r);this.stat.getMediaStat().setAudioPolicy(this.audioPolicy),this.stat.setLocalUserInfo(c),await this.locker.lock("".concat(pD,":joinImpl")),this.newSignal(u),this.signalEvent(),this.status=aC.Joining,i=await this.signal.connect(c,r),this.logger.info(pD,"joinImpl, actualAcsIp:".concat(i)),await this.waitNotifyConfig(r),await this.connectionsManager.initConnectionAndSdp(this.roomId,sk.STREAM_TYPE_MAIN,{onTrackHandler:this.onTrackHandler.bind(this)}),await this.connectionsManager.initConnectionAndSdp(this.roomId,sk.STREAM_TYPE_AUX,{onTrackHandler:this.onTrackHandler.bind(this)});const d=await this.connectionsManager.modifySdpInfo(sk.STREAM_TYPE_MAIN,this.cmdMsgAbility.enable),l=await this.connectionsManager.modifySdpInfo(sk.STREAM_TYPE_AUX),h=await this.signal.join(this.userInfo,d,l,this.audioPolicy,null===(n=this.bandwidthParam)||void 0===n?void 0:n.maxBandwidth,this.connectionsManager.getPortType(),this.cmdMsgAbility.enable,this.sfuConfigs);!this.clientConfig.countryCode&&h.countryCode&&this.accessManager.setOpsUrl(h.countryCode),this.sdpRepInfo=h.sdp,h.userInfos.forEach((e=>{this.stat.getMediaStat().setEncryInfo(e.userId,e.userEid)})),null!=h&&h.userEid&&this.stat.getMediaStat().setEncryInfo(this.userInfo.userId,h.userEid.toString());const f=String(h.roomUid);this.stat.setRoomUid(f);const p=null===(o=h.roomStreamStatus)||void 0===o?void 0:o.audience;let m;m=this.audioPolicy===ak.TOPN_AUDIOPOLICY?async e=>{let{remoteDescription:t,bindCryptoKey:r,wsUrl:i,dataChannelEnable:n}=e;return await this.negTransportChannelHandler(h,r,i,n),p===SC.PAUSE&&this.userInfo.role===GO?{answerSdp:t}:await this.addSsrc4Top3(t)}:async e=>{let{remoteDescription:t,bindCryptoKey:r,wsUrl:i,dataChannelEnable:n}=e;return await this.negTransportChannelHandler(h,r,i,n),{answerSdp:t}};const g=null===(s=h.negSdp.find((e=>e.type===hP.MAIN)))||void 0===s?void 0:s.sdp,_=null===(a=h.negSdp.find((e=>e.type===hP.DESKTOP)))||void 0===a?void 0:a.sdp;this.connectionsManager.setSsrcsMapping(this.sdpRepInfo),await this.connectionsManager.handleAnswerSdpFromServer(sk.STREAM_TYPE_MAIN,g,m),await this.connectionsManager.handleAnswerSdpFromServer(sk.STREAM_TYPE_AUX,_),await this.handleRoomStreamStatus(p),this.upStreamData=h.userInfos.find((e=>{var t;return e.userId===(null===(t=this.userInfo)||void 0===t?void 0:t.userId)})),this.remoteUserManager.initialize(this.userInfo.userId,h.sdp),this.stat.setSFUAddress(this.connectionsManager.getSfuInfoFromSdp(g,_)),this.signal.keepAlive(),this.status=aC.Joined,this.logger.info(pD,"join room success"),this.streamPublishManager.setSdpRepInfo(this.sdpRepInfo),this.statJoinRoomInfo(i,!1,r),this.cleanNetworkStatistic(),this.netQualityRegularReport(),this.cleanTransportStats(),this.transportStatsRegularReport(),this.setAudioLevelStatTimer(),hM.addConnectionCache(this.mainRelayRoomSymbol||this.clientSymbol,this.roomId,this),await this.doRefreshRoomUserInfos(this.userInfo.roomId,h.userInfos,!1),this.locker.unlock("".concat(pD,":joinImpl"))}catch(kD){throw this.locker.unlock("".concat(pD,":joinImpl")),this.logger.error(pD,"join occur errorï¼ ".concat(kD)),this.cleanup(),this.stat.reportJoinInfo(null==kD?void 0:kD.code,i,!1,r,null==kD?void 0:kD.message),await dM.uploadLogFile(this),kD}}reportLogs(){dM.uploadLogFile(this).then((()=>{this.eventEmitter.emit(hC.LogUploaded,{status:200})})).catch((e=>{this.logger.error(pD,"reportLogs occur errorï¼ ".concat(e)),this.eventEmitter.emit(hC.LogUploaded,{status:500})}))}statJoinRoomInfo(e,t,r){this.stat.reportJoinInfo(0,e,t,r,""),this.stat.getMediaStat().setConnectionsManager(this.connectionsManager),gk.addConnection(this.userInfo.roomId,this.connectionsManager),this.stat.getMediaStat().setLocalMainStreamInfo(this.userInfo.userId,this.streamPublishManager.getPublishedMainStreamInfos()),this.stat.getMediaStat().setLocalAuxsStreamInfo(this.userInfo.userId,this.streamPublishManager.getPublishedAuxStreamInfo()),this.stat.startMediaCollector()}async enableRtcStats(e,t){return await this.enableRtcStatsImpl(e,t)}async enableRtcStatsImpl(e,t){if(this.status!==aC.Joined)throw this.logger.error(pD,"cannot enableRtcStats before join room"),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"cannot enableRtcStats before join room");if(!e)return clearTimeout(this.rtcStatsInterval),this.rtcStatsInterval=null,void this.logger.info(pD,"enableRtcStats is disable");if(!Number.isInteger(t)||t<100)throw this.logger.error(pD,"invalid interval"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);if(e&&this.rtcStatsInterval)throw this.logger.error(pD,"enableRtcStats has been invoked, no need do again"),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"enableRtcStats has been invoked, no need do again");return this.rtcStatsCriterion=t,this.doEnableRtcStats()}async doEnableRtcStats(){let e=0;const t=()=>{this.rtcStatsInterval=setTimeout((async()=>{const r=(await this.stat.buildRtcStatsDebugInfo(this.rtcStatsCriterion/1e3)).mediaStatsDebugInfo;this.doTriggerRtcStats(r,e),e++,t()}),0===e?0:this.rtcStatsCriterion)};t()}doTriggerRtcStats(e,t){if(0===t)return;if(!e||0==e.length)return;const r=[];e.forEach((e=>{if(!e.event)return;const t=e.streams||[];switch(e.event){case PC.QoS_UP_STREAM_VIDEO:this.addRtcStatInfos(t,!1,ok.TRACK_TYPE_VIDEO,r);break;case PC.QoS_UP_STREAM_AUDIO:this.addRtcStatInfos(t,!1,ok.TRACK_TYPE_AUDIO,r,iC.main);break;case PC.QoS_AUX_UP_STREAM_VIDEO:this.addRtcStatInfos(t,!1,ok.TRACK_TYPE_VIDEO,r,iC.desktop);break;case PC.QoS_DOWN_STREAM_VIDEO:this.addRtcStatInfos(t,!0,ok.TRACK_TYPE_VIDEO,r);break;case PC.QoS_DOWN_STREAM_AUDIO:this.addRtcStatInfos(t,!0,ok.TRACK_TYPE_AUDIO,r,iC.main);break;case PC.QoS_AUX_DOWN_STREAM_VIDEO:this.addRtcStatInfos(t,!0,ok.TRACK_TYPE_VIDEO,r,iC.desktop);break;default:this.logger.debug(pD,"".concat(e.event," no need stats"))}})),this.connectState.curState===Jb[Xb.CONNECTED]&&r.length>0&&this.eventEmitter.emit(hC.RtcStats,r)}addRtcStatInfos(e,t,r,i,n){let o={};const s=this.userInfo.userName||this.userInfo.userId;for(let _=0;_<e.length;_++){var a,c,u;o.isRemote=t,o.mediaType=r,o.bitrate=(null===(a=e[_])||void 0===a?void 0:a.bit_rate)||0,o.jitter=(null===(c=e[_])||void 0===c?void 0:c.jitter)||0,o.pktLossRate=(null===(u=e[_])||void 0===u?void 0:u.pktLoss)||0;let S=null;var d,l,h,f,p,m,g;if(t)S=this.remoteUserManager.getUserInfoByStreamId(this.roomId,"".concat(null===(d=e[_])||void 0===d?void 0:d.stream_uid)),o.userName=(null===(l=S)||void 0===l||null===(h=l.userInfo)||void 0===h?void 0:h.nickname)||(null===(f=S)||void 0===f||null===(p=f.userInfo)||void 0===p?void 0:p.userId)||"remoteTop3";else o.userName=s,o.rtt=(null===(m=e[_])||void 0===m?void 0:m.rtt)||0;if(n?o.streamType=n:r===ok.TRACK_TYPE_VIDEO&&(o.streamType=t?"main"===S.mainStream.remoteTrackInfos.get(e[_].stream_uid.toString()).content?iC.main:iC.slides:"".concat(e[_].ssrc_uid.split("-")[0])==="".concat(this.sdpRepInfo.video.sendSsrcBegin)?iC.main:iC.slides),r!==ok.TRACK_TYPE_AUDIO)o.frameRate=(null===(g=e[_])||void 0===g?void 0:g.frame_rate)||0;i.push(o),o={}}}async leave(){return await this.leaveImpl()}async leaveImpl(){return new Promise(((e,t)=>{this.logger.info(pD,"leave room"),this.status!==aC.Joined&&this.status!==aC.Rejoining?t(new qc(Wc.RTC_ERR_CODE_STATUS_ERROR)):(this.status=aC.Leaving,this.signal.leave().then((r=>{if(r instanceof qc)return this.stat.reportLeavInfo(yC.LEAVE_ROOM_ERROR),this.stat.getMediaStat().clearEncryUserId(),void t(r);this.doLeaveRoom(),this.stat.reportLeavInfo(yC.LEAVE_ROOM_SUCCESS),this.stat.getMediaStat().clearEncryUserId(),this.stopStreamResolutionDetection(),this.logger.info(pD,"leave success"),e()})))}))}doLeaveRoom(){this.cleanup(),this.cleanTransportStats(),this.stat.leaveRoom(),qw.immediateReportRecords(),this.roomStreamStatus={}}resetConnection(){const e=[],t=this.streamPublishManager.getPublishedMainVideoTrackInfo();t&&e.push(t.sender);const r=this.streamPublishManager.getPublishedMainAudioTrackInfo();r&&e.push(r.sender),this.connectionsManager.destroyPeerConnection(sk.STREAM_TYPE_MAIN,e);const i=this.streamPublishManager.getPublishedAuxVideoTrackInfo();this.connectionsManager.destroyPeerConnection(sk.STREAM_TYPE_AUX,i?[i.sender]:[])}async rejoin(e,t){this.logger.info(pD,"rejoin room roomId:".concat(e," JoinConfig:").concat(JSON.stringify(t)));const r=[];let i="";this.roomId=e;try{var n,o,s,a,c;eA.checkJoinParams(e,t),this.mainRelayRoomSymbol&&hM.roleValidCheck4RelayRoom(this,t.role);const u=$O.init(this.identifiedID,e,t);this.userInfo=u,this.stat.setLocalUserInfo(u),this.resetConnection(),this.streamPublishManager.reset(),clearTimeout(this.netQualityTimer),clearTimeout(this.transportStatsTimer),null===(n=this.signal)||void 0===n||n.reset(),this.status=aC.Joining,i=await this.signal.connect(u,r),this.logger.info(pD,"rejoin, actualAcsIp:".concat(i)),await this.waitNotifyConfig(r),await this.connectionsManager.initConnectionAndSdp(this.roomId,sk.STREAM_TYPE_MAIN,{onTrackHandler:this.onTrackHandler.bind(this)}),await this.connectionsManager.initConnectionAndSdp(this.roomId,sk.STREAM_TYPE_AUX,{onTrackHandler:this.onTrackHandler.bind(this)});const d=await this.connectionsManager.modifySdpInfo(sk.STREAM_TYPE_MAIN,this.cmdMsgAbility.enable),l=await this.connectionsManager.modifySdpInfo(sk.STREAM_TYPE_AUX),h=await this.signal.join(this.userInfo,d,l,this.audioPolicy,null===(o=this.bandwidthParam)||void 0===o?void 0:o.maxBandwidth,this.connectionsManager.getPortType(),this.cmdMsgAbility.enable,this.sfuConfigs);!this.clientConfig.countryCode&&h.countryCode&&this.accessManager.setOpsUrl(h.countryCode),this.sdpRepInfo=h.sdp,h.userInfos.forEach((e=>{this.stat.getMediaStat().setEncryInfo(e.userId,e.userEid)})),null!=h&&h.userEid&&this.stat.getMediaStat().setEncryInfo(this.userInfo.userId,h.userEid.toString());const f=String(h.roomUid);this.stat.setRoomUid(f);const p=null===(s=h.roomStreamStatus)||void 0===s?void 0:s.audience;let m;m=this.audioPolicy===ak.TOPN_AUDIOPOLICY?async e=>{let{remoteDescription:t,bindCryptoKey:r,wsUrl:i,dataChannelEnable:n}=e;return await this.negTransportChannelHandler(h,r,i,n),p===SC.PAUSE&&this.userInfo.role===GO?{answerSdp:t}:await this.addSsrc4Top3(t)}:async e=>{let{remoteDescription:t,bindCryptoKey:r,wsUrl:i,dataChannelEnable:n}=e;return await this.negTransportChannelHandler(h,r,i,n),{answerSdp:t}};const g=null===(a=h.negSdp.find((e=>e.type===hP.MAIN)))||void 0===a?void 0:a.sdp,_=null===(c=h.negSdp.find((e=>e.type===hP.DESKTOP)))||void 0===c?void 0:c.sdp;this.connectionsManager.setSsrcsMapping(this.sdpRepInfo),await this.connectionsManager.handleAnswerSdpFromServer(sk.STREAM_TYPE_MAIN,g,m),await this.connectionsManager.handleAnswerSdpFromServer(sk.STREAM_TYPE_AUX,_),await this.handleRoomStreamStatus(p),this.upStreamData=h.userInfos.find((e=>{var t;return e.userId===(null===(t=this.userInfo)||void 0===t?void 0:t.userId)})),this.remoteUserManager.initialize(this.userInfo.userId,h.sdp),this.stat.setSFUAddress(this.connectionsManager.getSfuInfoFromSdp(g,_)),this.signal.keepAlive(),this.status=aC.Joined,this.localRejoinFlag=!0,this.streamPublishManager.setSdpRepInfo(this.sdpRepInfo),this.statJoinRoomInfo(i,!0,r),this.cleanNetworkStatistic(),this.netQualityRegularReport(),this.cleanTransportStats(),this.transportStatsRegularReport(),this.setAudioLevelStatTimer(),hM.addConnectionCache(this.mainRelayRoomSymbol||this.clientSymbol,this.roomId,this),await this.doRefreshRoomUserInfos(this.userInfo.roomId,h.userInfos,!0),this.logger.info(pD,"rejoin, rejoin room success")}catch(kD){throw this.logger.error(pD,"rejoin room fail, error:".concat(kD)),this.stat.reportJoinInfo(null==kD?void 0:kD.code,i,!0,r,null==kD?void 0:kD.message),await dM.uploadLogFile(this),kD}}async changeStreamMuteStatusNotify(e,t,r,i){const n={"x-nuwa-trace-id":bR.generateRandomId(32,16),"x-nuwa-span-id":bR.generateRandomId(16,16),videoStreams:[]};if(t===ok.TRACK_TYPE_VIDEO){const t={ssrc:0,mute:e};if(r===iC.desktop)t.ssrc=this.sdpRepInfo.desktopVideo.sendSsrcBegin;else if(t.ssrc=this.sdpRepInfo.video.sendSsrcBegin,i){const t={ssrc:this.sdpRepInfo.video.sendSsrcEnd,mute:e};n.videoStreams.push(t)}n.videoStreams.push(t)}else{const t={ssrc:this.sdpRepInfo.audio.sendSsrcBegin,mute:e};n.audioStreams=[t]}await this.signal.changeStreamStatus(n)}async setSendBitrate(e,t,r){if(!e)return void this.logger.info(pD,"sender is null");if("function"!=typeof e.getParameters)return void this.logger.info(pD,"sender not support getParameters");if("function"!=typeof e.setParameters)return void this.logger.info(pD,"sender not support setParameters");const i=e.getParameters();i.encodings.length<=0?this.logger.info(pD,"sender has no track, can not set maxBitRate"):(i.encodings[0].maxBitrate=t,await e.setParameters(i),this.logger.info(pD,"success set ".concat(r," sender maxBitrate: ").concat(t)))}static judgeNetworkQuality(e){return-1===e?dk.NETWORK_QUALITY_UNKNOW:e<1?dk.NETWORK_QUALITY_GREAT:e<3?dk.NETWORK_QUALITY_GOOD:e<6?dk.NETWORK_QUALITY_DEFECTS:e<12?dk.NETWORK_QUALITY_WEAK:e<20?dk.NETWORK_QUALITY_BAD:dk.NETWORK_QUALITY_DISCONNECT}async calcPktsLostRate(){const e=this.connectionsManager.getConnection(sk.STREAM_TYPE_MAIN);if(!e||["disconnected","failed","closed"].includes(e.connectionState))return;let t=await this.getUploadStatistic("video");t<0&&(t=await this.getUploadStatistic("audio")),this.pktsLostRate.up=Math.round(t),t=await this.getDownloadStatistic(ok.TRACK_TYPE_VIDEO),t<0&&(t=await this.getDownloadStatistic(ok.TRACK_TYPE_AUDIO)),this.pktsLostRate.down=Math.round(t)}netQualityRegularReport(){clearTimeout(this.netQualityTimer),this.netQualityTimer=setTimeout((()=>{clearTimeout(this.netQualityTimer);let t={uploadPkgLoss:0,downloadPkgLoss:0};try{const r=this.connectionsManager.getConnection(sk.STREAM_TYPE_MAIN);if(r&&!["disconnected","failed","closed"].includes(r.connectionState)||(t={uploadPkgLoss:dk.NETWORK_QUALITY_DISCONNECT,downloadPkgLoss:dk.NETWORK_QUALITY_DISCONNECT}),t.uploadPkgLoss=e.judgeNetworkQuality(this.pktsLostRate.up),t.downloadPkgLoss=e.judgeNetworkQuality(this.pktsLostRate.down),!this.preNetQuality||this.preNetQuality.uploadPkgLoss!==t.uploadPkgLoss||this.preNetQuality.downloadPkgLoss!==t.downloadPkgLoss){const e={uplinkNetworkQuality:t.uploadPkgLoss,downlinkNetworkQuality:t.downloadPkgLoss};this.logger.info(pD,"emit:".concat(hC.NetworkQuality,", quality:").concat(JSON.stringify(e))),this.eventEmitter.emit(hC.NetworkQuality,e),this.preNetQuality=t}}finally{this.netQualityRegularReport.bind(this)}}),2e3)}validatePublishRequest(e){if(this.status!==aC.Joined)throw this.logger.error(pD,"can not publish stream before join room"),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"can not publish stream before join room");if(this.userInfo.role===GO)throw this.logger.error(pD,"the player role can not publish stream"),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"the player role can not publish stream");if(!e)throw this.logger.error(pD,"stream is null"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);if(e.hasAudioTrack()||e.hasVideoTrack()||this.logger.warn(pD,"stream has no audio and video"),"local"!==e.getType())throw this.logger.error(pD,"stream type: ".concat(e.getType()," cannot publish")),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"stream type: ".concat(e.getType()," cannot publish"))}async publish(e,t){try{return await this.publishImpl(e,t),void(e.isAuxiliary()&&this.stat.reportAuxiliaryStreamShareInfo(IC.ACTION_START,TC.RESULT_SUCCESS))}catch(lw){throw e.isAuxiliary()&&this.stat.reportAuxiliaryStreamShareInfo(IC.ACTION_START,TC.RESULT_ERROR),lw}}async publishImpl(e,t){try{if(!e)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"stream is null");if(await this.publishStream(e,t),!e.isAuxiliary()){if(this.stat.getMediaStat().setLocalMainStreamInfo(this.userInfo.userId,this.streamPublishManager.getPublishedMainStreamInfos())&&(e.hasAudioTrack()&&this.buildSendMediaStreamInfo(Zb.Audio),t&&e.hasVideoTrack())){const e=this.streamPublishManager.getPublishedMainVideoTrackInfos().map((e=>e.ssrc));this.buildSendMediaStreamInfo(Zb.Video,e)}}}catch(kD){throw this.logger.error(pD,"publishImpl fail, errMsg = ".concat(kD)),kD}}async publishStream(e,t){this.logger.info(pD,"publish ".concat(e.isAuxiliary()?"aux":"main"," stream")),this.validatePublishRequest(e);const r=e,i=this.streamPublishManager.generatePubInfoWhenPublish(r,t);await this.sendPublishRequest(i.allTracks2Publish),await this.updateStreamTracks(r,i),this.startStreamResolutionDetection(r),r.addClient(this)}async sendPublishRequest(e){e&&await this.sendPublishReq(e)}startStreamResolutionDetection(e){var t;if(!e||dw.isFirefox())return;const r=e.isAuxiliary();!r&&this.resolutionChangeInfo.mainResolutionChangeTimer&&(clearInterval(this.resolutionChangeInfo.mainResolutionChangeTimer),this.resolutionChangeInfo.mainResolutionChangeTimer),r&&this.resolutionChangeInfo.auxResolutionChangeTimer&&(clearInterval(this.resolutionChangeInfo.auxResolutionChangeTimer),this.resolutionChangeInfo.auxResolutionChangeTimer=null),this.logger.info(pD,"startStreamResolutionDetection isAuxiliary: ".concat(r));const i=r?this.streamPublishManager.getLocalStream(sk.STREAM_TYPE_AUX):null===(t=this.streamPublishManager)||void 0===t?void 0:t.getLocalStream(sk.STREAM_TYPE_MAIN);if(i)try{this.resolutionChangeInfo[r?"auxResolutionChangeTimer":"mainResolutionChangeTimer"]=setInterval((async()=>{const e=this.streamPublishManager.getStreamTrackInfo(i),t={"x-nuwa-trace-id":bR.generateRandomId(32,16),"x-nuwa-span-id":bR.generateRandomId(16,16),videoStreams:[]};for(const n of e){if("audio"===n.type)return;if(!(r?gk.getLatestValue(this.userInfo.roomId,sk.STREAM_TYPE_AUX,"".concat(zb,"_").concat(n.upstream.ssrc),"packetsSent"):gk.getLatestValue(this.userInfo.roomId,sk.STREAM_TYPE_MAIN,"".concat(zb,"_").concat(n.upstream.ssrc),"packetsSent")))continue;const e={resolutionId:n.resolutionId,content:n.upstream.content,streamUid:n.upstream.streamUid,ssrc:n.upstream.ssrc,mute:n.upstream.mute,width:0,height:0};this.resolutionChangeInfo.preVideoHeight.has(e.resolutionId)||this.resolutionChangeInfo.preVideoHeight.set(e.resolutionId,i.getVideoHeight(e.resolutionId));let o=!1;r?(e.height=gk.getLatestValue(this.userInfo.roomId,sk.STREAM_TYPE_AUX,"".concat(zb,"_").concat(e.ssrc),"frameHeight"),e.width=gk.getLatestValue(this.userInfo.roomId,sk.STREAM_TYPE_AUX,"".concat(zb,"_").concat(e.ssrc),"frameWidth")):(e.height=gk.getLatestValue(this.userInfo.roomId,sk.STREAM_TYPE_MAIN,"".concat(zb,"_").concat(e.ssrc),"frameHeight"),e.width=gk.getLatestValue(this.userInfo.roomId,sk.STREAM_TYPE_MAIN,"".concat(zb,"_").concat(e.ssrc),"frameWidth")),o=Math.abs(this.resolutionChangeInfo.preVideoHeight.get(e.resolutionId)-e.height)/this.resolutionChangeInfo.preVideoHeight.get(e.resolutionId)>.1,o&&(t.videoStreams.push(e),this.resolutionChangeInfo.preVideoHeight.set(e.resolutionId,e.height))}t.videoStreams.length>0&&await this.signal.changeStreamStatus(t)}),5e3)}catch(kD){throw this.logger.error(pD,"startStreamResolutionDetection, occur error: ".concat(kD)),kD}}stopStreamResolutionDetection(e){var t;if(!e)return clearInterval(this.resolutionChangeInfo.mainResolutionChangeTimer),this.resolutionChangeInfo.mainResolutionChangeTimer=null,clearInterval(this.resolutionChangeInfo.auxResolutionChangeTimer),this.resolutionChangeInfo.auxResolutionChangeTimer=null,void this.resolutionChangeInfo.preVideoHeight.clear();e.isAuxiliary()?(clearInterval(this.resolutionChangeInfo.auxResolutionChangeTimer),this.resolutionChangeInfo.auxResolutionChangeTimer=null):(clearInterval(this.resolutionChangeInfo.mainResolutionChangeTimer),this.resolutionChangeInfo.mainResolutionChangeTimer=null),null===(t=e.getStreamInfo().videoProfiles)||void 0===t||t.forEach((e=>this.resolutionChangeInfo.preVideoHeight.delete(e.resolutionId)))}async updateStreamTracks(e,t){if(!e)return;const r=e.isAuxiliary();t.tracks2UnPublish&&0!==t.tracks2UnPublish.length||t.tracks2NewPublish&&0!==t.tracks2NewPublish.length?r?await this.updateAuxStreamTrack(e,t):await this.updateMainStreamTrack(e,t):this.logger.info(pD,"update ".concat(r?"aux":"main"," streamTracks, no new publish and unpublish, so no need update sdp"))}async updateMainStreamTrack(e,t){const r=t.tracks2UnPublish.filter((e=>e.type===ok.TRACK_TYPE_VIDEO)),i=this.removeTracksWhenPublish(r),n=t.tracks2UnPublish.filter((e=>e.type===ok.TRACK_TYPE_AUDIO)),o=this.removeTracksWhenPublish(n),s=o.length>0?o[0]:null,a=t.tracks2NewPublish.filter((e=>e.type===ok.TRACK_TYPE_VIDEO)),c=await this.addVideoTracksWhenPublish(e,a),u=t.tracks2NewPublish.filter((e=>e.type===ok.TRACK_TYPE_AUDIO)),d=await this.addAudioTrackWhenPublish(e,u),l=t.tracks2KeepPublish.filter((e=>e.type===ok.TRACK_TYPE_AUDIO)),h=this.getKeepAudioTrackSsrcSender(l),f=t.tracks2KeepPublish.filter((e=>e.type===ok.TRACK_TYPE_VIDEO)),p=this.getKeepVideoTracksSsrcSender(f);await this.generateNewOfferSdp(h,d,p,c,i,s),u.length>0&&await this.sendAudioMedia(e,d),a.length>0&&await this.sendVideoMedia(e,c),null==r||r.forEach((e=>{this.streamPublishManager.unPublishTrackSuccess(sk.STREAM_TYPE_MAIN,ok.TRACK_TYPE_VIDEO,e.upstream.streamUid.toString())})),null==n||n.forEach((e=>{this.streamPublishManager.unPublishTrackSuccess(sk.STREAM_TYPE_MAIN,ok.TRACK_TYPE_AUDIO,e.upstream.streamUid.toString())}))}async updateAuxStreamTrack(e,t){if(t.tracks2NewPublish&&t.tracks2NewPublish.length>0){const r=t.tracks2NewPublish&&t.tracks2NewPublish.filter((e=>e.type===ok.TRACK_TYPE_VIDEO))[0].ssrc,i=await this.connectionsManager.addTrack(sk.STREAM_TYPE_AUX,e.getVideoTrack(),e.getMediaStream());await this.connectionsManager.modifyPublishOfferSdp(sk.STREAM_TYPE_AUX,this.userInfo.userId,[r]),this.logger.info(pD,"aux send bitrate ".concat(e.getScreenSendBitrate())),await this.setSendBitrate(i,e.getScreenSendBitrate(),"auxVideo"),this.streamPublishManager.publishAuxVideoTrackOK(i,r);const n=this.streamPublishManager.getLocalStream(sk.STREAM_TYPE_AUX);n&&(n.off(kb,this.addLocalAuxStreamEndedHandler.bind(this)),n.on(kb,this.addLocalAuxStreamEndedHandler.bind(this))),await e.resumeMixScreenAudio()}else{const r=t.tracks2UnPublish;let i=0;r.forEach((e=>{i=e.ssrc,this.connectionsManager.removeTrack(sk.STREAM_TYPE_AUX,e.sender)})),await this.connectionsManager.modifyPublishOfferSdp(sk.STREAM_TYPE_AUX,this.userInfo.userId,[],0,[i]),await e.stopMixScreenAudio()}}async sendAudioMedia(e,t){if(t)try{await this.setSendBitrate(t.sender,e.getAudioSendBitrate(),"audio"),this.streamPublishManager.publishMainAudioTrackOK(t.sender,t.ssrc),this.logger.info(pD,"sendAudioMedia, send audio media successfully")}catch(kD){throw this.logger.error(pD,"sendAudioMedia, occur error: ".concat(kD)),kD}}async sendVideoMedia(e,t){if(0!==t.length)try{const r=[];t.forEach((t=>{r.push(this.setSendBitrate(t.sender,e.getVideoMaxSendBitrate(t.resolutionId),"mainVideo"))})),await Promise.all(r).then((()=>{t.forEach((e=>{this.streamPublishManager.publishMainVideoTrackOK(e.sender,e.ssrc,e.streamId)}))})),this.logger.info(pD,"sendVideoMedia, send video media successfully")}catch(kD){throw this.logger.error(pD,"sendVideoMedia, occur error: ".concat(kD)),kD}}async generateNewOfferSdp(e,t,r,i,n,o){try{const s=[];r.forEach((e=>s.push(e.ssrc))),i.forEach((e=>s.push(e.ssrc)));const a=t?t.ssrc:e?e.ssrc:null,c=[];n.forEach((e=>c.push(e.ssrc)));const u=o?o.ssrc:null,d=await this.connectionsManager.modifyPublishOfferSdp(sk.STREAM_TYPE_MAIN,this.userInfo.userId,s,a,c,u);return this.logger.info(pD,"generateNewOfferSdp successfully"),d}catch(kD){throw this.logger.error(pD,"generateNewOfferSdp, occur error: ".concat(kD)),kD}}async sendPublishReq(e){try{const t=[];e.forEach((e=>{t.push(e.upstream),this.logger.info(pD,"prepare to send publish req, streamId:".concat(e.upstream.streamUid))})),await this.signal.publish(t),this.logger.info(pD,"sendPublishReq successfully")}catch(kD){throw this.logger.error(pD,"sendPublishReq, occur error: ".concat(kD)),kD}}async addVideoTracksWhenPublish(e,t){if(0===t.length)return[];try{const r=[];for(const i of t){const t=e.getVideoTrack(i.resolutionId),n=i.ssrc,o=await this.connectionsManager.addTrack(sk.STREAM_TYPE_MAIN,t,e.getMediaStream());r.push({ssrc:n,sender:o,streamId:i.upstream.streamUid.toString(),resolutionId:i.resolutionId}),this.logger.info(pD,"addVideoTracksWhenPublish, add video track of resolutionId:".concat(i.resolutionId,",")+"physical track id:".concat(t.id,", streamId: ").concat(i.upstream.streamUid," with ssrc: ").concat(n," to connection successfully"))}return r}catch(kD){throw this.logger.error(pD,"addVideoTracksWhenPublish, occur error: ".concat(kD)),kD}}async addAudioTrackWhenPublish(e,t){if(0===t.length)return null;try{const r=e.getPublishAudioTrack(),i=t[0].ssrc,n={ssrc:i,sender:await this.connectionsManager.addTrack(sk.STREAM_TYPE_MAIN,r,e.getMediaStream()),streamId:t[0].upstream.streamUid.toString(),resolutionId:null};return this.logger.info(pD,"addAudioTrackWhenPublish, add audio track for streamId: ".concat(t[0].upstream.streamUid,",")+"physical track id:".concat(null==r?void 0:r.id," to connection successfully")),n}catch(kD){throw this.logger.error(pD,"addAudioTrackWhenPublish, occur error: ".concat(kD)),kD}}removeTracksWhenPublish(e){if(0===e.length)return[];try{const t=[];return e.forEach((e=>{this.connectionsManager.removeTrack(sk.STREAM_TYPE_MAIN,e.sender),t.push({ssrc:e.ssrc,sender:e.sender,streamId:e.upstream.streamUid.toString(),resolutionId:e.resolutionId}),this.logger.info(pD,"removeTracksWhenPublish, remove ".concat(e.type," track for streamId: ").concat(e.upstream.streamUid," to connection successfully"))})),t}catch(kD){throw this.logger.error(pD,"removeTracksWhenPublish, occur error: ".concat(kD)),kD}}getKeepAudioTrackSsrcSender(e){const t=[];return e.forEach((e=>{t.push({ssrc:e.ssrc,sender:e.sender,streamId:e.upstream.streamUid.toString(),resolutionId:e.resolutionId})})),t.length>0?t[0]:null}getKeepVideoTracksSsrcSender(e){const t=[];return e.forEach((e=>{t.push({ssrc:e.ssrc,sender:e.sender,streamId:e.upstream.streamUid.toString(),resolutionId:e.resolutionId})})),t}buildSendMediaStreamInfo(e,t){switch(e){case Zb.Aux:{const e=this.streamPublishManager.generateAuxOptTag();e&&this.stat.reportStartSendMediaStream(EC.AUX,e);break}case Zb.Video:{const e=this.streamPublishManager.generateMainVideoOptTags();e&&e.length>0&&e.forEach((e=>{t.find((t=>-1!=e.indexOf("".concat(t))))&&this.stat.reportStartSendMediaStream(EC.VIDEO,e)}));break}case Zb.Audio:{const e=this.streamPublishManager.generateMainAudioOptTag();e&&this.stat.reportStartSendMediaStream(EC.AUDIO,e);break}}}async unpublish(e){try{return await this.unpublishImpl(e),e.isAuxiliary()&&this.stat.reportAuxiliaryStreamShareInfo(IC.ACTION_STOP,TC.RESULT_SUCCESS),void this.stopStreamResolutionDetection(e)}catch(lw){throw e.isAuxiliary()&&this.stat.reportAuxiliaryStreamShareInfo(IC.ACTION_STOP,TC.RESULT_ERROR),lw}}async unpublishImpl(e){if(this.userInfo.role===GO)throw this.logger.error(pD,"the player role can not unpublish stream"),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"the player role can not unpublish stream");if(!e)throw this.logger.error(pD,"stream is null"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);if("local"!==e.getType())throw this.logger.error(pD,"stream type: ".concat(e.getType()," cannot unpublish")),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"stream type: ".concat(e.getType()," cannot unpublish"));try{await this.locker.lock("".concat(pD,":unpublishImpl")),await this.unPublishStream(e)}finally{this.locker.unlock("".concat(pD,":unpublishImpl"))}}async unPublishStream(e){const t=e.isAuxiliary(),r=t?"aux":"main";try{this.logger.info(pD,"unpublish ".concat(r," stream:").concat(e.getId()));const i=e,n=this.streamPublishManager.generatePubInfoWhenUnPublish(i);await this.sendPublishRequest(n.allTracks2Publish),await this.startStreamResolutionDetection(i),await this.updateStreamTracks(i,n),i.removeClient(this),t?this.streamPublishManager.unPublishAuxStreamOK():this.streamPublishManager.unPublishMainStreamOK(),this.logger.info(pD,"unpublish ".concat(r,"stream success: ").concat(e.getId()))}catch(kD){throw this.logger.error(pD,"unpublish ".concat(r," stream, ").concat(e.getId()," occur error: ").concat(kD)),kD}}async rejoinPublishStreams(e){let t=[];for(const r of e){this.logger.info(pD,"rejoin publish ".concat(r.isAuxiliary()?"aux":"main"," stream"));const e=r;e.removeClient(this),this.validatePublishRequest(r);const i=this.streamPublishManager.generatePubInfoWhenPublish(e);await this.updateStreamTracks(e,i),e.addClient(this),t=[...t,...i.allTracks2Publish]}t=[...new Set(t)],await this.sendPublishRequest(t);for(const r of e){const e=r;await this.startStreamResolutionDetection(e)}}addLocalAuxStreamEndedHandler(e){this.streamPublishManager.isAuxVideoTrackValid(e)&&this.unpublish(this.streamPublishManager.getLocalStream(sk.STREAM_TYPE_AUX))}async subscribeAudio(e){return await this.subscribeAudioImpl(e)}async subscribeAudioImpl(e){if(!e)throw this.logger.error(pD,"subscribeAudioImpl, userId is null"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"userId is null");const t=new zO({type:"main",log:this.logger,userId:e,client:this,roomId:this.roomId});this.logger.info(pD,"subscribeAudioImpl begin, userId:".concat(e)),await this.subscribeImpl(t,{audio:!0,video:!1});const r=this.remoteUserManager.getUserInfoById(e,this.roomId);if(r){let e=!1;for(const t of null===(i=r.mainStream.remoteTrackInfos)||void 0===i?void 0:i.values()){var i;if(t.type===ok.TRACK_TYPE_AUDIO&&t.isSubscribed){e=!0;break}}if(e)return r.mainStream.remoteStream}}async unSubscribeAudio(e){return await this.unSubscribeAudioImpl(e)}async unSubscribeAudioImpl(e){if(!e)throw this.logger.error(pD,"unSubscribeAudioImpl, userId is null"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"userId is null");const t=new zO({type:"main",log:this.logger,userId:e,client:this,roomId:this.roomId});this.logger.info(pD,"unSubscribeAudioImpl begin, userId:".concat(e)),await this.unsubscribeImpl(t,{audio:!0,video:!1})}startupQoSReportPlay(e,t){const r=this.startupQoSMap.get(e);if(r){const e={timestamp:r.start,traceId:r.traceId,spanId:"0.1.1",originIntfName:r.interfaceName,interfaceName:"play",source:"",target:"",resultCode:"",successFlag:"T",duration:t-r.start,async:"N",extendInfo:JSON.stringify({id:r.id,streamIds:r.streamIds})};this.stat.setFirstFrameInfo(e),r.start=t,r.interfaceName="play"}}startupQoSReportCanPlay(e){const t=bR.getCurrentTimestamp(),r=(null==e?void 0:e.id)&&this.startupQoSMap.get(null==e?void 0:e.id);if(r){const e={timestamp:r.start,traceId:r.traceId,spanId:"0.1.1.1",originIntfName:r.interfaceName,interfaceName:"canplay",source:"",target:"",resultCode:"",successFlag:"T",duration:t-r.start,async:"N",extendInfo:JSON.stringify({id:r.id,streamIds:r.streamIds})};this.stat.setFirstFrameInfo(e)}}async subscribe(e,t){return await this.subscribeImpl(e,t)}async subscribeImpl(e,t){if(this.roomStreamStatus.audience===SC.PAUSE&&this.userInfo.role===GO)throw this.logger.error(pD,"subscribeImpl, room stream status is pause"),new qc(Wc.RTC_ERR_CODE_ROOM_STREAM_STATUS_PAUSED,"room stream status is ".concat(this.roomStreamStatus.audience));const r=bR.getCurrentTimestamp(),i={traceId:bR.generateRandomId(32,16),spanId:"0",originIntfName:"",interfaceName:"subscribe",id:e.getUniqueId(),start:r};if(!e)throw this.logger.error(pD,"subscribeImpl, stream is null"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"stream is null");if(t||(t={video:!0,audio:!0}),t.audio||t.video){if(t.video&&![dC.ON,dC.OFF,null,void 0].includes(t.autoAdjustResolution))throw this.logger.error(pD,"the autoAdjustResolution value must be 1 or 2 or empty."),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);await this.doSubscribe(e,t,i)}}async doSubscribe(e,t,r){if(this.connectState.curState!==Jb[Xb.CONNECTED])throw this.logger.error(pD,"cannot do subscribe when network disconnected"),new qc(Wc.RTC_ERR_CODE_WEBSOCKET_NOT_CONNECTED);const i=e.getUserId(),n=e.isAuxiliary()?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN;this.logger.info(pD,"start subscribe, ".concat(i,", ").concat(n,", option: ").concat(JSON.stringify(t))),this.audioPolicy!==ak.USER_SUBSCRIBE_AUDIOPOLICY&&t.audio&&this.logger.info(pD,"doSubscribe, ".concat(this.audioPolicy," is not common audio mode, but audio option is true, reserve it"));try{await this.locker.lock("".concat(pD,":doSubscribe"));const e=this.remoteUserManager.subscribeStream(i,this.roomId,n,t,this.audioPolicy,!1,r);return await this.updateSubscribe(e,r)}catch(kD){throw this.logger.error(pD,"subscribe release lock, subscribe userId ".concat(e.getUserId()," occur error ").concat(kD)),kD}finally{this.locker.unlock("".concat(pD,":doSubscribe"))}}async batchSubscribe(e){return await this.doBatchSubscribe(e)}checkSubscribeParams(e){e.forEach((e=>{if(![dC.OFF,dC.ON,null,void 0].includes(e.autoAdjustResolution))throw this.logger.error(pD,"the autoAdjustResolution value must be 1 or 2"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);if(!["FHD","HD","SD","LD",null,void 0].includes(e.minResolution))throw this.logger.error(pD,"the minResolution value must be 'FHD','HD','SD','LD'"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER)}))}async doBatchSubscribe(e){this.logger.info(pD,"doBatchSubscribe, subscribeInfos:  ".concat(JSON.stringify(e)));try{this.checkSubscribeParams(e);const t=e.map((e=>({userId:e.userId,resolutionIds:e.resolutionIds,autoAdjustResolution:e.autoAdjustResolution,minResolution:e.minResolution})));await this.locker.lock("".concat(pD,":doBatchSubscribe"));const r=this.remoteUserManager.batchSubscribeMainStream(this.roomId,t);await this.updateSubscribe(r)}catch(kD){throw this.logger.error(pD,"batchSubscribe failed, ".concat(kD)),kD}finally{this.locker.unlock("".concat(pD,":doBatchSubscribe"))}}async batchDeleteUnusedSsrcInSdp(e,t,r){(t&&0!==t.length||r&&0!==r.length)&&(this.logger.info(pD,"batchDeleteUnusedSsrcInSdp, streamType: ".concat(e,", videoSsrc2Del: ").concat(t,", audioSsrc2Del:").concat(r)),await this.connectionsManager.deleteUser(e,t,r))}async enableStreamStateDetection(e,t){if(this.status!==aC.Joined)throw this.logger.error(pD,"cannot enable stream detection before join room"),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"cannot enable stream detection before join room");if(!e)return clearTimeout(this.streamInterruptedDetectInterval),this.streamInterruptedDetectInterval=null,this.lastCycleFrameDecodedMap.clear(),void this.streamInterruptedUsersMap.clear();if(!Number.isInteger(t)||t<1||t>60)throw this.logger.error(pD,"invalid interval for enable stream detection"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);if(e&&this.streamInterruptedDetectInterval)throw this.logger.error(pD,"cannot double enable stream detection"),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"cannot double enable stream detection");if(this.streamDetectionCriterion=t,this.lastCycleFrameDecodedMap&&0===this.lastCycleFrameDecodedMap.size){this.remoteUserManager.getAllUserStreamsByType(this.roomId,null,null).forEach((e=>{const t=e.userId;e.mainStream&&this.lastCycleFrameDecodedMap.set(t+",0",{userId:t,decodedFrame:0}),e.auxStream&&this.lastCycleFrameDecodedMap.set(t+",1",{userId:t,decodedFrame:0})}))}await this.startStreamDetection()}async startStreamDetection(){if(!this.streamInterruptedDetectInterval){const e=1e3,t=()=>{this.streamInterruptedDetectInterval=setTimeout((async()=>{const r=await this.stat.collectReceiverDecodedFrameMap(),i=[],n=[],o=Math.round(1e3*this.streamDetectionCriterion/e);this.streamInterruptedUsersMap.forEach(((e,t)=>{r.has(t)||this.streamInterruptedUsersMap.delete(t)})),r.forEach(((e,t)=>{const r=this.lastCycleFrameDecodedMap&&this.lastCycleFrameDecodedMap.get(t);if(r&&r.decodedFrame===e.decodedFrame){const e=this.streamInterruptedUsersMap.get(t);e?this.streamInterruptedUsersMap.set(t,e+1):this.streamInterruptedUsersMap.set(t,1)}if(r&&r.decodedFrame!==e.decodedFrame){if(this.streamInterruptedUsersMap.get(t)>=o){const r=t.split(",");r[0]!==oC&&n.push({userId:r[0],isScreen:e.isAux})}this.streamInterruptedUsersMap.delete(t)}})),this.lastCycleFrameDecodedMap=r,this.streamInterruptedUsersMap&&this.streamInterruptedUsersMap.forEach(((e,t)=>{if(e===o){const e=t.split(",");e[0]!==oC&&(i.push({userId:e[0],isScreen:"1"===e[1]}),this.logger.info(pD,"stream interrupted, userId: ".concat(e[0],", isAux: ").concat(e[1])))}})),i.length>0&&this.connectState.curState===Jb[Xb.CONNECTED]&&(this.logger.info(pD,"find stream interrupted users, ".concat(JSON.stringify(i))),this.eventEmitter.emit(hC.StreamInterrupted,i)),n.length>0&&this.connectState.curState===Jb[Xb.CONNECTED]&&(this.logger.info(pD,"find stream recovered users, ".concat(JSON.stringify(n))),this.eventEmitter.emit(hC.StreamRecovered,n)),t()}),e)};t()}}async unsubscribe(e,t){return await this.unsubscribeImpl(e,t)}async unsubscribeImpl(e,t){if(this.logger.info(pD,"start unsubscribe"),this.roomStreamStatus.audience===SC.PAUSE&&this.userInfo.role===GO)throw this.logger.error(pD,"unsubscribeImpl, room stream status is pause"),new qc(Wc.RTC_ERR_CODE_ROOM_STREAM_STATUS_PAUSED,"room stream status is ".concat(this.roomStreamStatus.audience));if(this.connectState.curState!==Jb[Xb.CONNECTED])throw this.logger.error(pD,"cannot do subscribe when network disconnected"),new qc(Wc.RTC_ERR_CODE_WEBSOCKET_NOT_CONNECTED);if(!e)throw this.logger.error(pD,"stream is null"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"stream is null");const r=e.getUserId(),i=e.isAuxiliary()?sk.STREAM_TYPE_AUX:sk.STREAM_TYPE_MAIN;this.logger.info(pD,"start doUnsubscribe, ".concat(r,", ").concat(i,", option: ").concat(JSON.stringify(t)));try{const e=t||{video:!0,audio:!0};await this.locker.lock("".concat(pD,":doUnsubscribe"));const n=this.remoteUserManager.unsubscribeStream(r,this.roomId,i,e);await this.updateSubscribe(n)}catch(kD){throw this.logger.error(pD,"subscribe userId ".concat(e.getUserId()," occur error ").concat(kD)),kD}finally{this.locker.unlock("".concat(pD,":doUnsubscribe"))}}async switchRole(e,t){return await this.switchRoleImpl(e,t)}async switchRoleImpl(e,t){if(this.logger.info(pD,"switchRole from ".concat(this.userInfo.role," to ").concat(e)),this.status!==aC.Joined&&this.status!==aC.Rejoining)throw new qc(Wc.RTC_ERR_CODE_STATUS_ERROR);if(this.userInfo.role===e)throw this.logger.error(pD,"new role same with old role, no need switch."),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"new role same with old role, no need switch.");hM.switchRoleParamsCheck(this,e,t);try{this.userInfo.role===WO&&e===GO&&(this.streamPublishManager.isMainStreamPublished()&&await this.unpublish(this.streamPublishManager.getLocalStream(sk.STREAM_TYPE_MAIN)),this.streamPublishManager.isAuxVideoTrackPublished()&&await this.unpublish(this.streamPublishManager.getLocalStream(sk.STREAM_TYPE_AUX))),await this.locker.lock("".concat(pD,":_switchRoleImpl"));const r=await this.signal.switchRole(e,t);this.logger.debug(pD,"swithRole resp: ".concat(JSON.stringify(r))),this.userInfo.role===GO&&e===WO&&(this.stat.getMediaStat().setLocalMainStreamInfo(this.userInfo.userId,this.streamPublishManager.getPublishedMainStreamInfos()),this.stat.getMediaStat().setLocalAuxsStreamInfo(this.userInfo.userId,this.streamPublishManager.getPublishedAuxStreamInfo())),this.userInfo.role=e,e===WO&&this.roomStreamStatus.audience===SC.PAUSE&&await this.handleRoomStreamStatus(SC.NORMAL,ak.TOPN_AUDIOPOLICY===this.audioPolicy,!0),this.stat.reportSwitchRoleInfo(e,CC),this.locker.unlock("".concat(pD,":_switchRoleImpl")),this.logger.info(pD,"switchRole success")}catch(kD){throw this.locker.unlock("".concat(pD,":_switchRoleImpl")),this.logger.error(pD,"switchRole  switchRole failed, errMsg = ".concat(kD)),this.stat.reportSwitchRoleInfo(e,AC),kD}}getPublishAudioSender(){var e;return null===(e=this.streamPublishManager.getPublishedMainAudioTrackInfo())||void 0===e?void 0:e.sender}getPublishedMainAudioTrackInfo(){return this.streamPublishManager.getPublishedMainAudioTrackInfo()}getPublishedMainVideoTrackInfos(){return this.streamPublishManager.getPublishedMainVideoTrackInfos()}getPublishVideoSender(e){if(e===sk.STREAM_TYPE_AUX){const e=this.streamPublishManager.getPublishedAuxVideoTrackInfo();if(e)return[e.sender]}const t=[];return this.streamPublishManager.getPublishedMainVideoTrackInfos().forEach((e=>{t.push(e.sender)})),t}getMainStreamSenderByTrack(e){if(!e)return null;const t=this.streamPublishManager.getPublishedMainVideoTrackInfos().find((t=>t.upstream.streamUid.toString()===e));return null==t?void 0:t.sender}async waitForTrackBatch(e){const t=e.map((e=>{var t,r;return(null===(t=e.mainStream)||void 0===t||null===(r=t.tracks)||void 0===r?void 0:r.length)>0?1:0})).reduce(((e,t)=>e+t),0),r=e.map((e=>{var t,r;return(null===(t=e.auxStream)||void 0===t||null===(r=t.tracks)||void 0===r?void 0:r.length)>0?1:0})).reduce(((e,t)=>e+t),0);this.logger.debug(pD,"wait for track batch begin, mainStreamCount:".concat(t,", auxStreamCount:").concat(r,"  "));for(let i=0;i<100;i++){if(this.computeSucceedStreamCount(sk.STREAM_TYPE_MAIN,t,e)+this.computeSucceedStreamCount(sk.STREAM_TYPE_AUX,r,e)===t+r)break;if(99===i)return void this.logger.error(pD,"waitForTrackBatch subscribe on track timeout");await bR.sleep(50)}}computeSucceedStreamCount(e,t,r){let i=0;return t&&(i=r.map((t=>this.isStreamTrackReady(e,t)?1:0)).reduce(((e,t)=>e+t),0)),i}newSignal(e){this.signal||(this.signal=new yP(this.clientConfig.appId,e,this))}async negTransportChannelHandler(e,t,r,i){if(this.cmdMsgAbility.enable)if(e.sdp.cmd){var n;if(i)return super.off(hC.CmdChannelDisconnect),MR.getLogger().debug(pD,"negTransportChannelHandler init command channel of datachannel."),this.cmdMsgAbility.cmdManager=new CM(this.eventEmitter,this.remoteUserManager),null===(n=this.cmdMsgAbility.cmdManager)||void 0===n||n.setCommandChannelParams(this.roomId,{tranportOptions:{userUid:e.userUid,sendSsrc:e.sdp.cmd.sendSsrc,receiveSsrc:e.sdp.cmd.receiveSsrc,payload:e.sdp.cmd.pt},dataChannelOptions:{connection:this.connectionsManager.getConnection(sk.STREAM_TYPE_MAIN)},msgFormat:this.cmdMsgAbility.msgFormat}),await this.connectionsManager.refreshOffer(sk.STREAM_TYPE_MAIN),void(t&&r&&super.on(hC.CmdChannelDisconnect,(i=>{i===mC.DATA_CHANNEL&&(MR.getLogger().debug(pD,"negTransportChannelHandler downgrade to webocket command channel."),this.websocketChannelInit(e,t,r))}),!1));t&&r&&(MR.getLogger().debug(pD,"negTransportChannelHandler init webocket command channel."),this.websocketChannelInit(e,t,r))}else MR.getLogger().error(pD,"negTransportChannelHandler error, cmd signal info missing.")}websocketChannelInit(e,t,r){var i;null===(i=this.cmdMsgAbility.cmdManager)||void 0===i||i.reset(),this.cmdMsgAbility.cmdManager=new RM(this.eventEmitter,this.remoteUserManager),this.cmdMsgAbility.cmdManager.setCommandChannelParams(this.roomId,{tranportOptions:{userUid:e.userUid,sendSsrc:e.sdp.cmd.sendSsrc,receiveSsrc:e.sdp.cmd.receiveSsrc,payload:e.sdp.cmd.pt},wsOptions:{bindCryptoKey:t,wsUrl:r,wsDomain:e.sdp.domain},msgFormat:this.cmdMsgAbility.msgFormat})}onTrackHandler(e,t){if(this.logger.info(pD,"peerconnection ontrack event: ".concat(e.track.kind)),e.track.kind===ok.TRACK_TYPE_VIDEO||this.audioPolicy===ak.USER_SUBSCRIBE_AUDIOPOLICY&&e.track.kind===ok.TRACK_TYPE_AUDIO){var r,i;const n=e.streams[0].id,o=this.remoteUserManager.getUserInfoByStreamId(this.roomId,n),s=t?null==o||null===(r=o.auxStream)||void 0===r?void 0:r.remoteStream:null==o||null===(i=o.mainStream)||void 0===i?void 0:i.remoteStream;s?(this.logger.info(pD,"connection.ontrack streamId=".concat(n,", hasAudio:").concat(s.hasAudioTrack()," hasVideo:").concat(s.hasVideoTrack())),s.addRemoteTrack(e.track,n)):this.logger.info(pD,"ontrack stream: ".concat(n,"  is not existed"))}this.logger.info("onConnection","audio policy:".concat(this.audioPolicy,",track kind:").concat(e.track.kind)),this.audioPolicy===ak.TOPN_AUDIOPOLICY&&e.track.kind===ok.TRACK_TYPE_AUDIO&&this.saveAudioStream4TopN(e)}static isStreamAdd(e,t){if(!t)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);const r=e===sk.STREAM_TYPE_MAIN?t.mainStream:t.auxStream;return 0===r.preTracks.length&&r.curTracks.length>0}static isStreamRemove(e,t){if(!t)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);const r=e===sk.STREAM_TYPE_MAIN?t.mainStream:t.auxStream;return r.preTracks.length>0&&0===r.curTracks.length}static isStreamUpdate(e,t){if(!t)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);const r=e===sk.STREAM_TYPE_MAIN?t.mainStream:t.auxStream;return r.addedTracks.length>0||r.updatedTracks.length>0||r.removedTracks.length>0}static getMuteChangeStatus(t,r,i){if(!i)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);const n=t===sk.STREAM_TYPE_MAIN?i.mainStream:i.auxStream;return e.getMediaMuteChangeFlag(n,r)}static getMediaMuteChangeFlag(t,r){const i="noTrack",n=t.preTracks.find((e=>e.type===r)),o=t.curTracks.find((e=>e.type===r)),s=n?n.mute:i,a=o?o.mute:i;return e.getMuteChangeFlag(s,a)}static getMuteChangeFlag(e,t){return e!==t?t?hD.mute:hD.unmute:hD.noChange}async updateSubscribe(t,r,i){if(this.connectState.curState!==Jb[Xb.CONNECTED])throw this.logger.error(pD,"cannot do subscribe or unSubscribe when network disconnected"),new qc(Wc.RTC_ERR_CODE_WEBSOCKET_NOT_CONNECTED);if(!t||0===t.length)return null;if(!e.isSubscriptionChange(t))return this.logger.info(pD,"no need update subscription"),null;try{const e={successSubscribeInfos:[],failSubscribeInfos:[],successUnsubscribeInfos:[],failUnsubscribeInfos:[]};await this.modifyBrowerSdp(t,e);const n={successSubscribeInfos:[],failSubscribeInfos:[],successUnsubscribeInfos:[],failUnsubscribeInfos:[]};!i&&await this.subscribeSignal(t,n,r),this.clearResource(t);const o=await this.handleRemoteStreamsState(n.successSubscribeInfos),s={successSubscribeInfos:[],failSubscribeInfos:[],successUnsubscribeInfos:[],failUnsubscribeInfos:[]};return(null==o?void 0:o.successSubscribeInfos)&&s.successSubscribeInfos.push(...o.successSubscribeInfos),(null==o?void 0:o.failSubscribeInfos)&&s.failSubscribeInfos.push(...o.failSubscribeInfos),(null==n?void 0:n.failSubscribeInfos)&&s.failSubscribeInfos.push(...n.failSubscribeInfos),(null==n?void 0:n.successUnsubscribeInfos)&&s.successUnsubscribeInfos.push(...n.successUnsubscribeInfos),(null==n?void 0:n.failUnsubscribeInfos)&&s.failUnsubscribeInfos.push(...n.failUnsubscribeInfos),await this.rollbackResource(s.failSubscribeInfos),this.remoteUserManager.subscribeResultCallback(s,!1),this.logger.info(pD,"updateSubscribe end. ".concat(this.getSubscribeResultString(s))),s}catch(kD){this.logger.error(pD,"updateSubscribe fail. errMsg:".concat(kD));const r=this.getSubscribeExceptionResult(t);throw this.remoteUserManager.subscribeResultCallback(r,!0),this.logger.info(pD,"updateSubscribe fail end. ".concat(this.getSubscribeResultString(r))),kD}}modifyBrowerSdp(t,r){const i=this.buildSubsReq(t,r),n=e.getUserUpdateInfos(i.joinUserUpdateInfos),o=this.buildDefaultSubsRep(i);this.getSubscribeResult(n,o.videoUpstreams,o.audioUpstreams,r,!1);const s=[],a=[],c=[],u=[];r.successUnsubscribeInfos.forEach((e=>{var t,r,i,n;null===(t=e.mainStream)||void 0===t||null===(r=t.tracks)||void 0===r||r.forEach((e=>{e.type===ok.TRACK_TYPE_VIDEO?s.push(e.cssrc):c.push(e.cssrc)})),null===(i=e.auxStream)||void 0===i||null===(n=i.tracks)||void 0===n||n.forEach((e=>{e.type===ok.TRACK_TYPE_VIDEO?a.push(e.cssrc):u.push(e.cssrc)}))}));const d=[];return d.push(this.generateReceiveSdp(sk.STREAM_TYPE_MAIN,r.successSubscribeInfos,s,c)),d.push(this.generateReceiveSdp(sk.STREAM_TYPE_AUX,r.successSubscribeInfos,a,u)),Promise.all(d)}getSubscribeExceptionResult(e){const t={successSubscribeInfos:[],failSubscribeInfos:[],successUnsubscribeInfos:[],failUnsubscribeInfos:[]};return e.forEach((e=>{var r,i,n,o,s,a,c,u;const d={userId:e.userInfo.userId,roomId:this.roomId,mainStream:{remoteStream:null===(r=e.mainStream)||void 0===r?void 0:r.remoteStream,tracks:null===(i=e.mainStream)||void 0===i?void 0:i.tracks4Subscribe},auxStream:{remoteStream:null===(n=e.auxStream)||void 0===n?void 0:n.remoteStream,tracks:null===(o=e.auxStream)||void 0===o?void 0:o.tracks4Subscribe}},l={userId:e.userInfo.userId,roomId:this.roomId,mainStream:{remoteStream:null===(s=e.mainStream)||void 0===s?void 0:s.remoteStream,tracks:null===(a=e.mainStream)||void 0===a?void 0:a.tracks4Unsubscribe},auxStream:{remoteStream:null===(c=e.auxStream)||void 0===c?void 0:c.remoteStream,tracks:null===(u=e.auxStream)||void 0===u?void 0:u.tracks4Unsubscribe}};this.appendSubscribeResult(t.failSubscribeInfos,d),this.appendSubscribeResult(t.failUnsubscribeInfos,l)})),this.logger.info(pD,"getSubscribeExceptionResult. ".concat(this.getSubscribeResultString(t))),t}getSubscribeResultString(e){var t,r,i,n;let o;return null==e||null===(t=e.successSubscribeInfos)||void 0===t||t.forEach((e=>{o="".concat(o||""," subscribe success list: ").concat(this.getRemoteUserSubscribeInfoString(e),", ")})),null==e||null===(r=e.failSubscribeInfos)||void 0===r||r.forEach((e=>{o="".concat(o||""," subscribe failed list: ").concat(this.getRemoteUserSubscribeInfoString(e),",")})),null==e||null===(i=e.successUnsubscribeInfos)||void 0===i||i.forEach((e=>{o="".concat(o||""," unsubscribe success list: ").concat(this.getRemoteUserSubscribeInfoString(e),",")})),null==e||null===(n=e.failUnsubscribeInfos)||void 0===n||n.forEach((e=>{o="".concat(o||""," unsubscribe failed list: ").concat(this.getRemoteUserSubscribeInfoString(e))})),o}async rollbackResource(e){if(e&&0!==e.length)try{const t=[],r=[],i=[],n=[];e.forEach((e=>{var o,s,a,c;null===(o=e.mainStream)||void 0===o||null===(s=o.tracks)||void 0===s||s.forEach((e=>{e.type===ok.TRACK_TYPE_VIDEO?t.push(e.cssrc):r.push(e.cssrc)})),null===(a=e.auxStream)||void 0===a||null===(c=a.tracks)||void 0===c||c.forEach((e=>{e.type===ok.TRACK_TYPE_VIDEO?i.push(e.cssrc):n.push(e.cssrc)}))})),await this.batchDeleteUnusedSsrcInSdp(sk.STREAM_TYPE_MAIN,t,r),await this.batchDeleteUnusedSsrcInSdp(sk.STREAM_TYPE_AUX,i,n)}catch(kD){this.logger.error(pD,"rollbackResource fail, errMsg:".concat(kD))}}isNormalStateStream(e){const t=e.tracks.filter((e=>e.isTrackReady)),r=e.tracks.filter((e=>e.isTrackReady&&e.state===hk.normal));return t.length&&t.length===r.length}async handleReadyStream(e,t){var r,i,n,o;e===sk.STREAM_TYPE_MAIN&&(null===(r=t.mainStream)||void 0===r||null===(i=r.tracks)||void 0===i?void 0:i.length)>0?await this.handleReadyStreamByType(t.userId,e,t.mainStream):e===sk.STREAM_TYPE_AUX&&(null===(n=t.auxStream)||void 0===n||null===(o=n.tracks)||void 0===o?void 0:o.length)>0&&await this.handleReadyStreamByType(t.userId,e,t.auxStream)}async handleReadyStreamByType(e,t,r){this.logger.debug(pD,"handleReadyStreamByType, ".concat(t,", ").concat(JSON.stringify(r.tracks)));try{if(this.isNormalStateStream(r)&&(this.logger.info(pD,"emit ".concat(hC.StreamSubscribed,", userId: ").concat(e,", ").concat(t)),this.eventEmitter.emit(hC.StreamSubscribed,{stream:r.remoteStream}),t===sk.STREAM_TYPE_MAIN)){const t=setTimeout((async()=>{clearTimeout(t),this.reportMediaStatus(e,this.roomId)}),0)}const i=r.tracks.some((e=>e.type===ok.TRACK_TYPE_VIDEO&&e.isTrackReady));for(const e of r.tracks)e.isTrackReady&&await this.handleReadyTrack(e,r.remoteStream,i)}catch(kD){this.logger.error(pD,"handleReadyStreamByType fail, errMsg:".concat(kD))}}getMediaNotifyInfo(e,t){const r=[],i=this.remoteUserManager.getAllUserStreamsByType(t,null,null);return null==i||i.forEach((i=>{if(i.userId!==e)return;const n=i.mainStream,o=null==n?void 0:n.tracks.find((e=>e.type===ok.TRACK_TYPE_AUDIO&&e.isTrackReady));if(o){const i={mediaType:ok.TRACK_TYPE_AUDIO,roomId:t,userId:e,status:o.mute?Qb.MediaStatusUnavailable:Qb.MediaStatusAvailable,reason:o.mute?eC.MediaUnmuted:eC.MediaMuted};r.push(i)}const s=null==n?void 0:n.tracks.find((e=>e.type===ok.TRACK_TYPE_VIDEO&&e.isTrackReady));if(s){const t={mediaType:ok.TRACK_TYPE_VIDEO,roomId:this.roomId,userId:e,status:s.mute?Qb.MediaStatusUnavailable:Qb.MediaStatusAvailable,reason:s.mute?eC.MediaUnmuted:eC.MediaMuted};r.push(t)}})),r}reportMediaStatus(e,t){this.getMediaNotifyInfo(e,t).forEach((t=>{const r=t.mediaType===ok.TRACK_TYPE_AUDIO?t.status===Qb.MediaStatusAvailable?"UnmuteAudio":"MuteAudio":t.status===Qb.MediaStatusAvailable?"UnmuteVideo":"MuteVideo";this.logger.info(pD,"emit ".concat(hC[r],", userId: ").concat(e,", type: ").concat(t.mediaType,", status: ").concat(t.status)),this.eventEmitter.emit(hC[r],t)}))}async handleReadyTrack(e,t,r){const i=e.type===ok.TRACK_TYPE_VIDEO||e.type===ok.TRACK_TYPE_AUDIO&&!r,n=[hk.remoteRejoinCache,hk.localRejoin,hk.resolutionChange].includes(e.state);i&&e.playElement&&n&&(this.logger.info(pD,"handleReadyTrack, auto play"),this.logger.info(pD,"video track.muted[".concat(e.muted,"]")),await t.play(e.playElement,{objectFit:e.objectFit,muted:e.muted,resolutionId:e.type===ok.TRACK_TYPE_VIDEO?e.trackId:null}));const o=e.type===ok.TRACK_TYPE_AUDIO,s=[hk.remoteRejoinCache,hk.localRejoin,hk.resolutionChange].includes(e.state);if(o&&e.playElement&&s){this.logger.info(pD,"audio track.muted[".concat(e.muted,"]"));const r=t.getAudioHRTCTrack();e.muted?r.muteTrack():r.unmuteTrack()}}async handleRemoteStreamsState(t){if(!t||0===t.length)return null;await this.waitForTrackBatch(t),this.logger.info(pD,"handleRemoteTracksState, waitForTrackBatch return");const r=[],i=[];for(const c of t){var n,o,s,a;const t=e.newRemoteUserSubscribeInfo(c.userId,this.roomId,null===(n=c.mainStream)||void 0===n?void 0:n.remoteStream,null===(o=c.auxStream)||void 0===o?void 0:o.remoteStream),u=e.newRemoteUserSubscribeInfo(c.userId,this.roomId,null===(s=c.mainStream)||void 0===s?void 0:s.remoteStream,null===(a=c.auxStream)||void 0===a?void 0:a.remoteStream);await this.handleRemoteStreamsStateByType(c,sk.STREAM_TYPE_MAIN,t,u),await this.handleRemoteStreamsStateByType(c,sk.STREAM_TYPE_AUX,t,u),(t.mainStream.tracks.length||t.auxStream.tracks.length)&&r.push(t),(u.mainStream.tracks.length||u.auxStream.tracks.length)&&i.push(u),this.stat.getMediaStat().setSubscribeInfo(c)}return{successSubscribeInfos:r,failSubscribeInfos:i,successUnsubscribeInfos:null,failUnsubscribeInfos:null}}isStreamTrackReady(e,t){const r=e===sk.STREAM_TYPE_MAIN?t.mainStream:t.auxStream,i=null==r?void 0:r.remoteStream,n=null!=r&&r.tracks?Array.from(r.tracks.values()):null,o=null==n?void 0:n.filter((e=>e.type===ok.TRACK_TYPE_VIDEO)).map((e=>e.trackId)),s=null==n?void 0:n.some((e=>e.type===ok.TRACK_TYPE_AUDIO));return null==i?void 0:i.isTracksReady(o,s)}async handleRemoteStreamsStateByType(e,t,r,i){var n;const o=this.isStreamTrackReady(t,e);let s=e.mainStream,a=null===(n=e.mainStream)||void 0===n?void 0:n.tracks,c=r.mainStream,u=i.mainStream;var d;t===sk.STREAM_TYPE_AUX&&(s=e.auxStream,a=null===(d=e.auxStream)||void 0===d?void 0:d.tracks,c=r.auxStream,u=i.auxStream);let l=!1;var h,f;o?(null===(h=a)||void 0===h||h.forEach((e=>{e.isTrackReady=!0,l=!0})),a&&c.tracks.push(...a)):null===(f=a)||void 0===f||f.forEach((e=>{var t;null!==(t=s)&&void 0!==t&&t.remoteStream.isTrackReady(e.type,e.trackId)?(e.isTrackReady=!0,l=!0,c.tracks.push(e)):u.tracks.push(e)}));l&&await this.handleReadyStream(t,e)}getRemoteUserSubscribeInfoString(e){var t,r,i,n;if(!e)return"";let o,s;return null===(t=e.mainStream)||void 0===t||null===(r=t.tracks)||void 0===r||r.forEach((e=>{o="".concat(o||""," ").concat(JSON.stringify(e))})),null===(i=e.auxStream)||void 0===i||null===(n=i.tracks)||void 0===n||n.forEach((e=>{s="".concat(s||""," ").concat(JSON.stringify(e))})),"  userId:".concat(e.userId,", mainTracks:").concat(o,", auxTracks:").concat(s,"  ")}releaseTrack(e,t){t.type===ok.TRACK_TYPE_VIDEO?(e.stop({audio:!1,video:!0,resolutionIds:[t.trackId]}),e.removeRemoteVideoTrack(t.trackId),this.logger.info(pD,"releaseTrack ".concat(t.type))):(e.stop({audio:!0}),e.removeRemoteAudioTrack(),this.logger.info(pD,"releaseTrack ".concat(t.type)))}clearResource(e){try{null==e||e.forEach((e=>{var t,r,i,n;null===(t=e.mainStream)||void 0===t||null===(r=t.tracks4Unsubscribe)||void 0===r||r.forEach((t=>{this.stat.getMediaStat().deleteSubscribeInfo(e.userInfo.userId,sk.STREAM_TYPE_MAIN,t.trackId),this.releaseTrack(e.mainStream.remoteStream,t)})),null===(i=e.auxStream)||void 0===i||null===(n=i.tracks4Unsubscribe)||void 0===n||n.forEach((t=>{this.stat.getMediaStat().deleteSubscribeInfo(e.userInfo.userId,sk.STREAM_TYPE_AUX,t.trackId),this.releaseTrack(e.auxStream.remoteStream,t)}))}))}catch(kD){this.logger.error(pD,"clearResource error: ".concat(kD))}}async generateReceiveSdp(e,t,r,i){this.logger.info(pD,"generateReceiveSdp, stream type: ".concat(e,", removeVideoSsrcs: ").concat(r,", removeAudioSsrcs: ").concat(i));const n=t.some((t=>{var r;const i=e===sk.STREAM_TYPE_MAIN?t.mainStream:t.auxStream;return(null==i||null===(r=i.tracks)||void 0===r?void 0:r.length)>0})),o=!!r.length||!!i.length;if(!n&&!o)return null;o&&await this.connectionsManager.deleteUser(e,r,i);const s=new Map;for(const u of t){var a,c;const t=e===sk.STREAM_TYPE_MAIN?null===(a=u.mainStream)||void 0===a?void 0:a.tracks:null===(c=u.auxStream)||void 0===c?void 0:c.tracks;if(t&&!(t.length<1))for(const r of t){this.logger.info(pD,"generateReceiveSdp, userId : ".concat(u.userId,", stream type: ").concat(e,", track type: ").concat(r.type,", ssrc: ").concat(r.cssrc));const t={streamId:r.trackId};r.type===ok.TRACK_TYPE_VIDEO?t.videoSsrc=r.cssrc:t.audioSsrc=r.cssrc,s.has(u.userId)?s.get(u.userId).push(t):s.set(u.userId,[t])}}await this.connectionsManager.addUserBatch(e,s)}static getWatchType4Ops(e){return 0===e?"cancel_watch":1===e?"watch":"batch_watch"}static isSubscriptionChange(e){return e.some((e=>{var t,r,i,n,o,s,a,c;return(null===(t=e.mainStream)||void 0===t||null===(r=t.tracks4Subscribe)||void 0===r?void 0:r.length)>0||(null===(i=e.mainStream)||void 0===i||null===(n=i.tracks4Unsubscribe)||void 0===n?void 0:n.length)>0||(null===(o=e.auxStream)||void 0===o||null===(s=o.tracks4Subscribe)||void 0===s?void 0:s.length)>0||(null===(a=e.auxStream)||void 0===a||null===(c=a.tracks4Unsubscribe)||void 0===c?void 0:c.length)>0}))}appendSubscribeResult(e,t){var r,i,n,o;if(t&&(null!==(r=t.mainStream)&&void 0!==r&&null!==(i=r.tracks)&&void 0!==i&&i.length||null!==(n=t.auxStream)&&void 0!==n&&null!==(o=n.tracks)&&void 0!==o&&o.length)){const r=e.find((e=>e.userId===t.userId&&e.roomId===t.roomId));var s,a;if(r)null!==(s=r.mainStream)&&void 0!==s&&s.tracks?r.mainStream.tracks.push(...t.mainStream.tracks):r.mainStream=t.mainStream,null!==(a=r.auxStream)&&void 0!==a&&a.tracks?r.auxStream.tracks.push(...t.auxStream.tracks):r.auxStream=t.auxStream;else e.push(t)}}buildSubsReq(t,r){const i=[],n=[],o=[];return t.forEach((t=>{if(t.curUserState===lk.NotJoin){var s,a,c,u,d,l;const i=e.newRemoteUserSubscribeInfo(t.userInfo.userId,this.roomId,null===(s=t.mainStream)||void 0===s?void 0:s.remoteStream,null===(a=t.auxStream)||void 0===a?void 0:a.remoteStream);null===(c=t.mainStream)||void 0===c||null===(u=c.tracks4Unsubscribe)||void 0===u||u.forEach((e=>{i.mainStream.tracks.push(e)})),null===(d=t.auxStream)||void 0===d||null===(l=d.tracks4Unsubscribe)||void 0===l||l.forEach((e=>{i.auxStream.tracks.push(e)})),this.appendSubscribeResult(r.successUnsubscribeInfos,i)}else{var h,f,p,m;o.push(t),null===(h=t.mainStream)||void 0===h||null===(f=h.allSubscribeTracks)||void 0===f||f.forEach((r=>{e.getUserTrackSubscribeInfo(t.userInfo,i,n,r)})),null===(p=t.auxStream)||void 0===p||null===(m=p.allSubscribeTracks)||void 0===m||m.forEach((r=>{e.getUserTrackSubscribeInfo(t.userInfo,i,n,r)}))}})),{videoSubscribeInfos:i,audioSubscribeInfos:n,joinUserUpdateInfos:o}}async subscribeSignal(t,r,i){const n=this.buildSubsReq(t,r);if(!e.isSubscriptionChange(n.joinUserUpdateInfos))return;const o=e.getWatchType4Ops(n.videoSubscribeInfos.length);let s;this.logger.info(pD,"subscribeSignal, fullVideoSubscribeInfos: ".concat(JSON.stringify(n.videoSubscribeInfos)," ,")+"fullAudioSubscribeInfos: ".concat(JSON.stringify(n.audioSubscribeInfos)));let a=null;const c=bR.getCurrentTimestamp();if(i){const e={timestamp:i.start,traceId:i.traceId,spanId:"0",originIntfName:"",interfaceName:"subscribe",source:"",target:"",resultCode:"",successFlag:"T",duration:c-i.start,async:"N",extendInfo:JSON.stringify({id:i.id})};this.stat.setFirstFrameInfo(e)}try{a=this.status!==aC.Leaving?await this.signal.subscribe(n.videoSubscribeInfos,n.audioSubscribeInfos,o):this.buildDefaultSubsRep(n)}catch(lw){throw s=lw,lw}finally{if(i){const e=bR.getCurrentTimestamp(),t={timestamp:c,traceId:i.traceId,spanId:"0.1",originIntfName:i.interfaceName,interfaceName:"subscribeSignal",source:"",target:"",resultCode:"",successFlag:s?"F":"T",duration:e-c,async:"N",extendInfo:JSON.stringify({id:i.id,streamIds:i.streamIds})};this.stat.setFirstFrameInfo(t),i.interfaceName="subscribeSignal",i.start=e,this.startupQoSMap.set(i.id,i)}}a.audioUpstreams||a.videoUpstreams||this.logger.error(pD,"subscribeSignal, subscribe stream subscribed no result record, subsResult:".concat(JSON.stringify(a)));const u=e.getUserUpdateInfos(n.joinUserUpdateInfos);this.getSubscribeResult(u,a.videoUpstreams,a.audioUpstreams,r)}buildDefaultSubsRep(e){const t=[];e.videoSubscribeInfos.forEach((e=>{t.push({cSsrcId:e.cSsrcId,code:0,pSsrcId:e.pSsrcId,pStreamUid:e.pStreamUid,pUserId:e.pUserId,pUserUid:e.pUserUid})}));const r=[];return e.audioSubscribeInfos.forEach((e=>{r.push({cSsrcId:e.cSsrcId,code:0,pSsrcId:e.pSsrcId,pStreamUid:e.pStreamUid,pUserId:e.pUserId,pUserUid:e.pUserUid})})),{audioUpstreams:r,videoUpstreams:t}}static getUserTrackSubscribeInfo(e,t,r,i){const n={pSsrcId:i.pssrc,cSsrcId:i.cssrc,pStreamUid:parseInt(i.trackId),pUserId:e.userId,pUserUid:e.userUid};i.type===ok.TRACK_TYPE_AUDIO?r.push(n):(n.mediaData={width:i.width,height:i.height,maxFps:60},i.autoAdjustResolution===dC.ON&&(n.minReceiveContent=fD[i.minResolution]),t.push(n))}static getUserUpdateInfos(e){return e.filter((e=>{var t,r,i,n,o,s,a,c;return(null===(t=e.mainStream)||void 0===t||null===(r=t.allSubscribeTracks)||void 0===r?void 0:r.length)>0||(null===(i=e.mainStream)||void 0===i||null===(n=i.tracks4Unsubscribe)||void 0===n?void 0:n.length)>0||(null===(o=e.auxStream)||void 0===o||null===(s=o.allSubscribeTracks)||void 0===s?void 0:s.length)>0||(null===(a=e.auxStream)||void 0===a||null===(c=a.tracks4Unsubscribe)||void 0===c?void 0:c.length)>0}))}getSubscribeResult(e,t,r,i,n){const o=new Map;null==t||t.forEach((e=>{const t=e.pUserId+"#"+this.roomId,r=o.get(t);if(r)r.tracks.push(e);else{const r={userId:e.pUserId,userUid:e.pStreamUid,tracks:[e]};o.set(t,r)}})),null==r||r.forEach((e=>{const t=e.pUserId+"#"+this.roomId,r=o.get(t);if(r)r.tracks.push(e);else{const r={userId:e.pUserId,userUid:e.pStreamUid,tracks:[e]};o.set(t,r)}})),e.forEach((e=>{this.getStreamSubscribeResult(e,!0,o,i)})),e.forEach((e=>{this.getStreamSubscribeResult(e,!1,o,i)})),this.logger.info(pD,"isRealSubsAction: ".concat(n,", getSubscribeResult success, ").concat(this.getSubscribeResultString(i)))}getStreamSubscribeResult(t,r,i,n){var o,s,a,c;if(!r)return this.handleUnsubscribeReq(sk.STREAM_TYPE_MAIN,t,n),void this.handleUnsubscribeReq(sk.STREAM_TYPE_AUX,t,n);const u=n.successSubscribeInfos,d=n.failSubscribeInfos,l=e.newRemoteUserSubscribeInfo(t.userInfo.userId,this.roomId,null===(o=t.mainStream)||void 0===o?void 0:o.remoteStream,null===(s=t.auxStream)||void 0===s?void 0:s.remoteStream),h=e.newRemoteUserSubscribeInfo(t.userInfo.userId,this.roomId,null===(a=t.mainStream)||void 0===a?void 0:a.remoteStream,null===(c=t.auxStream)||void 0===c?void 0:c.remoteStream),f=t.userInfo.userId+"#"+this.roomId,p=i.get(f);var m,g,_,S;if(!p&&this.hasTrackSignalReq(t))return d.push({userId:t.userInfo.userId,roomId:this.roomId,mainStream:{remoteStream:null===(m=t.mainStream)||void 0===m?void 0:m.remoteStream,tracks:null===(g=t.mainStream)||void 0===g?void 0:g.tracks4Subscribe},auxStream:{remoteStream:null===(_=t.auxStream)||void 0===_?void 0:_.remoteStream,tracks:null===(S=t.auxStream)||void 0===S?void 0:S.tracks4Subscribe}}),void this.logger.error(pD,"subscribe user ".concat(t.userInfo.userId,", isSubscribe: ").concat(r," subscribed failed,mcs not response"));this.getTracksSubscribeResults(r,t,p,l,h),this.appendToSubscribeResult(l,u,h,d)}appendToSubscribeResult(e,t,r,i){var n,o,s,a,c,u,d,l;((null===(n=e.mainStream)||void 0===n||null===(o=n.tracks)||void 0===o?void 0:o.length)>0||(null===(s=e.auxStream)||void 0===s||null===(a=s.tracks)||void 0===a?void 0:a.length)>0)&&this.appendSubscribeResult(t,e),((null===(c=r.mainStream)||void 0===c||null===(u=c.tracks)||void 0===u?void 0:u.length)>0||(null===(d=r.auxStream)||void 0===d||null===(l=d.tracks)||void 0===l?void 0:l.length)>0)&&this.appendSubscribeResult(i,r)}static newRemoteUserSubscribeInfo(e,t,r,i){return{userId:e,roomId:t,mainStream:{remoteStream:r,tracks:[]},auxStream:{remoteStream:i,tracks:[]}}}handleUnsubscribeReq(e,t,r){const i=e===sk.STREAM_TYPE_MAIN?t.mainStream:t.auxStream,n=null==i?void 0:i.tracks4Unsubscribe;if(null!=n&&n.length){var o,s,a,c,u;const d=null===(o=i.tracks4Subscribe)||void 0===o?void 0:o.some((e=>e.state===hk.remoteRejoinCache)),l=r.successSubscribeInfos.find((e=>e.userId===t.userInfo.userId&&e.roomId===t.userInfo.roomId)),h=e===sk.STREAM_TYPE_MAIN?null==l||null===(s=l.mainStream)||void 0===s?void 0:s.tracks:null==l||null===(a=l.auxStream)||void 0===a?void 0:a.tracks,f=!h||0===(null==h?void 0:h.filter((e=>e.state===hk.remoteRejoinCache)).length),p={userId:t.userInfo.userId,roomId:this.roomId,mainStream:{remoteStream:null===(c=t.mainStream)||void 0===c?void 0:c.remoteStream,tracks:e===sk.STREAM_TYPE_MAIN?n:[]},auxStream:{remoteStream:null===(u=t.auxStream)||void 0===u?void 0:u.remoteStream,tracks:e===sk.STREAM_TYPE_AUX?n:[]}};this.logger.info(pD,"handleUnsubscribeReq, hasSubscribeReq:".concat(d,", allSubscribeReqFailed:").concat(f)),d&&f?this.appendSubscribeResult(r.failUnsubscribeInfos,p):this.appendSubscribeResult(r.successUnsubscribeInfos,p)}}hasTrackSignalReq(e){var t,r,i,n;return(null===(t=e.mainStream)||void 0===t||null===(r=t.allSubscribeTracks)||void 0===r?void 0:r.filter((e=>e.type===ok.TRACK_TYPE_VIDEO)).length)>0||(null===(i=e.auxStream)||void 0===i||null===(n=i.allSubscribeTracks)||void 0===n?void 0:n.filter((e=>e.type===ok.TRACK_TYPE_VIDEO)).length)>0}getTracksSubscribeResults(e,t,r,i,n){var o,s,a,c;const u=e?null===(o=t.mainStream)||void 0===o?void 0:o.tracks4Subscribe:null===(s=t.mainStream)||void 0===s?void 0:s.tracks4Unsubscribe;null==u||u.forEach((o=>{this.getTrackSubscribeResult(e,t.userInfo.userId,o,sk.STREAM_TYPE_MAIN,r,i,n)}));const d=e?null===(a=t.auxStream)||void 0===a?void 0:a.tracks4Subscribe:null===(c=t.auxStream)||void 0===c?void 0:c.tracks4Unsubscribe;null==d||d.forEach((o=>{this.getTrackSubscribeResult(e,t.userInfo.userId,o,sk.STREAM_TYPE_AUX,r,i,n)}))}getTrackSubscribeResult(e,t,r,i,n,o,s){var a;const c=i===sk.STREAM_TYPE_MAIN?s.mainStream:s.auxStream,u=i===sk.STREAM_TYPE_MAIN?o.mainStream:o.auxStream,d=null==n||null===(a=n.tracks)||void 0===a?void 0:a.find((e=>e.cSsrcId===r.cssrc));d?0!==d.code?(c.tracks.push(r),this.logger.error(pD,"isSubscribe:".concat(e,", subscribe user ").concat(t," ").concat(i," streamUid:").concat(d.pStreamUid," subscribed failed,code:").concat(d.code))):u.tracks.push(r):this.logger.error(pD,"isSubscribe:".concat(e,", subscribe user ").concat(t,", ").concat(i,"\n      track req id: ").concat(r.trackId,", ssrc ").concat(r.cssrc," subscribed failed,mcs not response"))}async updateUserList(e){this.logger.info(pD,"updateUserList start");try{e.infos.forEach((e=>{this.stat.getMediaStat().setEncryInfo(String(e.userId),String(e.userEid))})),await this.locker.lock("".concat(pD,":updateUserList"));const t=this.remoteUserManager.updateUserListInfo(this.roomId,e.infos);if(this.logger.info(pD,"updateUserList , begin"),!t||0===t.length)return void this.logger.error(pD,"updateUserList , userUpdateInfos is null");t.forEach((e=>{if(e.isUserNameChanged&&(this.logger.info(pD,"emit ".concat(hC.UserNameChanged,", ").concat(e.userInfo.userId,"}")),this.eventEmitter.emit(hC.UserNameChanged,{roomId:this.roomId,userId:e.userInfo.userId,userName:e.userInfo.nickname})),e.preUserState===lk.NotJoin&&e.curUserState===lk.Joined)this.logger.info(pD,"emit ".concat(hC.PeerJoin,", ").concat(e.userInfo.userId,":").concat(e.userInfo.nickname)),this.eventEmitter.emit(hC.PeerJoin,{userId:e.userInfo.userId,userName:e.userInfo.nickname,roomId:e.userInfo.roomId,relayRoomId:e.userInfo.relaySrcRoomId});else if(e.preUserState===lk.Joined&&e.curUserState===lk.NotJoin){var t,r,i,n;(null===(t=e.mainStream)||void 0===t||null===(r=t.removedTracks)||void 0===r?void 0:r.length)>0&&(this.logger.info(pD,"emit ".concat(hC.StreamRemoved,", ").concat(e.userInfo.userId,", ").concat(sk.STREAM_TYPE_MAIN)),this.eventEmitter.emit(hC.StreamRemoved,{stream:e.mainStream.remoteStream})),(null===(i=e.auxStream)||void 0===i||null===(n=i.removedTracks)||void 0===n?void 0:n.length)>0&&(this.logger.info(pD,"emit ".concat(hC.StreamRemoved,", ").concat(e.userInfo.userId,", ").concat(sk.STREAM_TYPE_AUX)),this.eventEmitter.emit(hC.StreamRemoved,{stream:e.auxStream.remoteStream})),this.logger.info(pD,"emit ".concat(hC.PeerLeave,", ").concat(e.userInfo.userId)),this.eventEmitter.emit(hC.PeerLeave,{userId:e.userInfo.userId,userName:e.userInfo.nickname,roomId:e.userInfo.roomId,relayRoomId:e.userInfo.relaySrcRoomId,reason:uC.HRTC_LEAVE_REASON_USER_LEAVE_ROOM}),this.stat.getMediaStat().updateAudioStreamInfos(e.userInfo.userId,"removed")}})),await this.updateSubscribe(t)}catch(kD){this.logger.error(pD,"updateUserList occur exception ".concat(kD))}finally{this.locker.unlock("".concat(pD,":updateUserList"))}}async refreshRemoteStreamList(e){this.logger.info(pD,"refreshRemoteStreamList start");try{const t={userId:e.userId,userUid:e.userUid,roomId:this.roomId,nickname:null};e.allAudioStreams=e.allAudioStreams.filter((e=>"cmd"!==e.content));const r=this.remoteUserManager.refreshRemoteStreamList(t,e.allVideoStreams,e.allAudioStreams);if(this.logger.info(pD,"refreshRemoteStreamList begin"),!r||0===r.length)return void this.logger.error(pD,"refreshRemoteStreamList , userUpdateInfos is null");const i=r.find((t=>t.userInfo.userId===e.userId));this.updateSingleUser(i),await this.updateSubscribe(r)}catch(kD){this.logger.error(pD,"refreshRemoteStreamList occur exception ".concat(kD))}}updateSingleUser(t){var r,i;t.isUserNameChanged&&(this.logger.info(pD,"emit ".concat(hC.UserNameChanged,", ").concat(t.userInfo.userId,"}")),this.eventEmitter.emit(hC.UserNameChanged,{roomId:this.roomId,userId:t.userInfo.userId,userName:t.userInfo.nickname})),t.preUserState===lk.NotJoin&&t.curUserState===lk.Joined&&(this.logger.info(pD,"emit ".concat(hC.PeerJoin,", ").concat(t.userInfo.userId,":").concat(t.userInfo.nickname)),this.eventEmitter.emit(hC.PeerJoin,{userId:t.userInfo.userId,userName:t.userInfo.nickname,roomId:t.userInfo.roomId,relayRoomId:t.userInfo.relaySrcRoomId}));const n=null===(r=t.mainStream)||void 0===r?void 0:r.remoteStream;n&&(e.isStreamAdd(sk.STREAM_TYPE_MAIN,t)?(this.logger.info(pD,"emit ".concat(hC.StreamAdded,", ").concat(t.userInfo.userId,", ").concat(n.getType(),"}")),this.eventEmitter.emit(hC.StreamAdded,{stream:n}),this.updateAudioStreamInfo(t.userInfo.userId,"add",n)):e.isStreamRemove(sk.STREAM_TYPE_MAIN,t)?(this.logger.info(pD,"emit ".concat(hC.StreamRemoved,", ").concat(t.userInfo.userId,", ").concat(n.getType(),"}")),this.eventEmitter.emit(hC.StreamRemoved,{stream:n}),this.updateAudioStreamInfo(t.userInfo.userId,"removed",n)):e.isStreamUpdate(sk.STREAM_TYPE_MAIN,t)&&(this.logger.info(pD,"emit ".concat(hC.StreamUpdated,", ").concat(t.userInfo.userId,", ").concat(n.getType(),"}")),this.eventEmitter.emit(hC.StreamUpdated,{stream:n}),this.updateAudioStreamInfo(t.userInfo.userId,"update",n)));const o=null===(i=t.auxStream)||void 0===i?void 0:i.remoteStream;o&&(e.isStreamAdd(sk.STREAM_TYPE_AUX,t)?(this.logger.info(pD,"emit ".concat(hC.StreamAdded,", ").concat(t.userInfo.userId,", ").concat(o.getType(),"}")),this.eventEmitter.emit(hC.StreamAdded,{stream:o})):e.isStreamRemove(sk.STREAM_TYPE_AUX,t)&&(this.logger.info(pD,"emit ".concat(hC.StreamRemoved,", ").concat(t.userInfo.userId,", ").concat(o.getType(),"}")),this.eventEmitter.emit(hC.StreamRemoved,{stream:o}))),t.preUserState===lk.Joined&&t.curUserState===lk.NotJoin&&(this.logger.info(pD,"emit ".concat(hC.PeerLeave,", ").concat(t.userInfo.userId)),this.eventEmitter.emit(hC.PeerLeave,{userId:t.userInfo.userId,userName:t.userInfo.nickname,roomId:t.userInfo.roomId,relayRoomId:t.userInfo.relaySrcRoomId,reason:uC.HRTC_LEAVE_REASON_USER_LEAVE_ROOM}),this.stat.getMediaStat().updateAudioStreamInfos(t.userInfo.userId,"removed")),this.handleMuteStatus(t)}updateAudioStreamInfo(e,t,r){var i;if("add"===t)null!==(i=r.getStreamInfo())&&void 0!==i&&i.audioProfile&&this.stat.getMediaStat().updateAudioStreamInfos(e,"add");else if("removed"===t)this.stat.getMediaStat().updateAudioStreamInfos(e,"removed");else{var n;null!==(n=r.getStreamInfo())&&void 0!==n&&n.audioProfile?this.stat.getMediaStat().updateAudioStreamInfos(e,"add"):this.stat.getMediaStat().updateAudioStreamInfos(e,"removed")}}remoteUserDisconnectNotify(e){e&&this.logger.info(pD,"remoteDisconnectNotify, userId:".concat(e.userId))}remoteUserReconnectNotify(e){if(!e)return;this.logger.info(pD,"remoteReconnectNotify, userId:".concat(e.userId));const t={userId:e.userId,userUid:e.userUid,roomId:this.roomId,nickname:null};this.remoteUserManager.remoteUserReconnect(t,e.videoStreams,e.audioStreams)}updateAppData(e){const t=e.userId,r=e.appData.nickname;t&&e.userId!==this.userInfo.userId&&(this.remoteUserManager.updateUserName(t,this.roomId,r),this.eventEmitter.emit(hC.UserNameChanged,{roomId:this.roomId,userId:t,userName:r}))}async updateRemoteStream(e){this.logger.info(pD,"updateRemoteStream start");try{const t={userId:e.userId,userUid:e.userUid,roomId:this.roomId,nickname:null},r=this.remoteUserManager.updateRemoteStream(t,e.videoStreams,e.audioStreams);if(this.logger.info(pD,"updateRemoteStream , begin"),!r)return void this.logger.error(pD,"updateRemoteStream , userUpdateInfos is null");this.handleMuteStatus(r)}catch(kD){this.logger.error(pD,"updateRemoteStream occur exception ".concat(kD))}}handleMuteStatus(t){this.logger.info(pD,"handleMuteStatus begin");const r=e.getMuteChangeStatus(sk.STREAM_TYPE_MAIN,ok.TRACK_TYPE_AUDIO,t);r!==hD.noChange&&(this.emitMediaStatusChange(t.userInfo.userId,t.userInfo.roomId,ok.TRACK_TYPE_AUDIO,r),r===hD.unmute?this.stat.getMediaStat().updateAudioStreamInfos(this.userInfo.userId,"add"):this.stat.getMediaStat().updateAudioStreamInfos(this.userInfo.userId,"removed"));const i=e.getMuteChangeStatus(sk.STREAM_TYPE_MAIN,ok.TRACK_TYPE_VIDEO,t);i!==hD.noChange&&this.emitMediaStatusChange(t.userInfo.userId,t.userInfo.roomId,ok.TRACK_TYPE_VIDEO,i)}async removeRemoteStream(e){this.logger.info(pD,"removeRemoteStream start");try{const t={userId:e.userId,userUid:e.userUid,roomId:this.roomId,nickname:null};e.allAudioStreams=e.allAudioStreams.filter((e=>"cmd"!==e.content));const r=this.remoteUserManager.refreshRemoteStreamList(t,e.allVideoStreams,e.allAudioStreams);if(this.logger.info(pD,"removeRemoteStream begin"),!r||0===r.length)return void this.logger.error(pD,"removeRemoteStream , userUpdateInfos is null");const i=r.find((t=>t.userInfo.userId===e.userId));this.updateSingleUser(i),await this.updateSubscribe(r)}catch(kD){this.logger.error(pD,"removeRemoteStream occur exception ".concat(kD))}}emitMediaStatusChange(e,t,r,i){const n={roomId:t,userId:e,status:i===hD.unmute?Qb.MediaStatusAvailable:Qb.MediaStatusUnavailable,reason:i===hD.unmute?eC.MediaUnmuted:eC.MediaMuted},o=r===ok.TRACK_TYPE_AUDIO?i===hD.unmute?"UnmuteAudio":"MuteAudio":i===hD.unmute?"UnmuteVideo":"MuteVideo";this.logger.info(pD,"emit ".concat(hC[o],", userId: ").concat(e,", type: ").concat(r,", status: ").concat(n.status)),this.eventEmitter.emit(hC[o],n)}waitNotifyConfig(e){return new Promise(((t,r)=>{const i={id:e.length+1,domain:"",start_ms:bR.getCurrentTimestamp(),delay_ms:0,stepName:"configNotify",rspCode:"",errMsg:""};let n=null;this.waitConfigCallbackFunc=()=>{clearTimeout(n),t(),i.delay_ms=bR.getCurrentTimestamp()-i.start_ms,i.rspCode="OK",e.push(i)},this.validSignatureFunc=e=>{clearTimeout(n),r(new qc(e.code,e.message))},n=setTimeout((()=>{this.logger.error(pD,"wait config timeout"),i.rspCode="".concat(Wc.RTC_ERR_CODE_WAIT_CONFIG_FAIL),i.errMsg=Gc[Wc.RTC_ERR_CODE_WAIT_CONFIG_FAIL],i.delay_ms=bR.getCurrentTimestamp()-i.start_ms,e.push(i),t()}),zC)}))}handleConfigNotifyBody(e){const{controlDisconnectTimeout:t="30",controlHoldTimeout:r="120",controlPingPeriod:i="5"}=e.appConfigs||{};this.sfuConfigs={};for(const o of ZC)Object.prototype.hasOwnProperty.call(o,e.appConfigs)&&(this.sfuConfigs[o]=e.appConfigs[o]);const n={heartBeatRetryTimes:parseInt(t)/parseInt(i)||GC,connectionTimeout:parseInt(r)||qC,heartBeatPeriod:parseInt(i)||WC};this.waitConfigCallbackFunc&&this.waitConfigCallbackFunc(),this.stat.setTraceInfo(e.traceId),dM.setLogServerConfigs(e.logServerConfigs),this.signal.setConfigParams(n)}async uploadLog(e){await dM.uploadLogFile(this,e)}async handleWatchMsg(e){if(null!=e)try{const t=e,r=t.videoSsrcIds,i=t.audioSsrcIds;if(this.sdpRepInfo.cmd&&0===(i||[]).filter((e=>this.sdpRepInfo.cmd.sendSsrc!==e)).length)return;const n=r.filter((e=>this.sdpRepInfo.video.sendSsrcRange.find((t=>e===t)))),o=r.filter((e=>this.sdpRepInfo.desktopVideo.sendSsrcRange.find((t=>e===t)))),s=[],a=[],c={mainStreamVideoTracks2Update:{},mainStreamAudioTracks2Update:{},auxStreamTracks2Update:{}};if(n&&n.length>0){const e=this.streamPublishManager.generatePubInfoWhenWatch(sk.STREAM_TYPE_MAIN,n,[]);await this.publishWhenWatch(sk.STREAM_TYPE_MAIN,e),e.tracks2NewPublish.forEach((e=>{r.find((t=>t===e.ssrc))&&s.push({ssrcId:e.ssrc,status:0})})),e.tracks2KeepPublish.forEach((e=>{s.push({ssrcId:e.ssrc,status:0})})),c.mainStreamVideoTracks2Update=e}if(i&&i.length>0){const e=this.streamPublishManager.generatePubInfoWhenWatch(sk.STREAM_TYPE_MAIN,[],i);await this.publishWhenWatch(sk.STREAM_TYPE_MAIN,e),e.tracks2NewPublish.forEach((e=>{i.find((t=>t===e.ssrc))&&a.push({ssrcId:e.ssrc,status:0})})),e.tracks2KeepPublish.forEach((e=>{a.push({ssrcId:e.ssrc,status:0})})),c.mainStreamAudioTracks2Update=e}if(o&&o.length>0){const e=this.streamPublishManager.generatePubInfoWhenWatch(sk.STREAM_TYPE_AUX,o,[]);await this.publishWhenWatch(sk.STREAM_TYPE_AUX,e),e.tracks2NewPublish.forEach((e=>{r.find((t=>t===e.ssrc))&&s.push({ssrcId:e.ssrc,status:0})})),e.tracks2KeepPublish.forEach((e=>{s.push({ssrcId:e.ssrc,status:0})})),c.auxStreamTracks2Update=e}this.logger.info(pD,"handle watch success, videoSsrcs: ".concat(JSON.stringify(r),", audioSsrcs: ").concat(JSON.stringify(i)));const u=this.stat.getSpanId(t["x-nuwa-span-id"]),d=bR.generateRandomId(16,16);this.stat.setParentSpanId(d,u);const l={type:"WATCH_STREAM_NOTIFY",requestId:t.requestId,traceId:t.traceId,version:t.version,videoSsrcIds:s,audioSsrcIds:a,"x-nuwa-trace-id":t["x-nuwa-trace-id"],"x-nuwa-span-id":d};await this.signal.pushStreamResponse(l),this.reportMediaStreamInfo(c,s),this.logger.info(pD,"handleWatchMsg success")}catch(kD){this.logger.error(pD,"handleWatchMsg occur error ".concat(kD))}else this.logger.error(pD,"message is null")}reportMediaStreamInfo(e,t){var r,i;if(null!==(r=e.mainStreamVideoTracks2Update.tracks2NewPublish)&&void 0!==r&&r.find((e=>e.type===ok.TRACK_TYPE_VIDEO))){this.stat.getMediaStat().setLocalMainStreamInfo(this.userInfo.userId,this.streamPublishManager.getPublishedMainStreamInfos())&&this.buildSendMediaStreamInfo(Zb.Video,t)}if(null!==(i=e.auxStreamTracks2Update.tracks2NewPublish)&&void 0!==i&&i.filter((e=>e.type===ok.TRACK_TYPE_VIDEO))){this.stat.getMediaStat().setLocalAuxsStreamInfo(this.userInfo.userId,this.streamPublishManager.getPublishedAuxStreamInfo())&&this.buildSendMediaStreamInfo(Zb.Aux)}}async publishWhenWatch(e,t){if(!t||0===t.tracks2NewPublish.length&&0===t.tracks2KeepPublish.length)return void this.logger.info(pD,"handleWatchMsg, not published stream");const r=this.streamPublishManager.getLocalStream(e);await this.sendPublishRequest(t.allTracks2Publish),await this.startStreamResolutionDetection(r),await this.updateStreamTracks(r,t),this.logger.info(pD,"handleWatchMsg, published stream")}setCameraCaptureReport(e,t){this.stat.setCameraInfo(e,t)}signalEvent(){this.signal.on(rC.watchStreamNotify,(e=>{this.handleWatchMsg(e)})),this.signal.on(rC.pushStreamNotify,(e=>{this.refreshRemoteStreamList(e)})),this.signal.on(rC.stopPushStreamNotify,(e=>{this.removeRemoteStream(e)})),this.signal.on(rC.changeStreamStatusNotify,(e=>{this.updateRemoteStream(e)})),this.signal.on(rC.appDataChangeNotify,(e=>{this.updateAppData(e)})),this.signal.on(rC.disconnectNotify,(e=>{this.remoteUserDisconnectNotify(e)})),this.signal.on(rC.reconnectNotify,(e=>{this.remoteUserReconnectNotify(e)})),this.signal.on(rC.configNotify,(e=>{this.handleConfigNotifyBody(e)})),this.signal.on(rC.top3AudioVolumeNotify,(e=>{this.handleMaxVolumeNotify(e)})),this.signal.on(rC.statusChangeNotify,(async e=>{await this.updateUserList(e)})),this.signal.on(rC.uploadLogNotify,(async e=>{await this.uploadLog(e)})),this.signal.on(rC.publishStatusNotify,(e=>{this.handlePublishStatusNotify(e)})),this.signal.on(ZO.Reconnected,(async()=>{await this.refreshRoomUserInfos()})),this.signal.on(ZO.SessionUnavailable,(async()=>{this.logger.info(pD,"".concat(ZO.SessionUnavailable));await this.rejoinLoop(120)})),this.signal.on(ZO.ConnectionUnavailable,(async()=>{this.logger.info(pD,"".concat(ZO.ConnectionUnavailable));await this.rejoinLoop(120)})),this.signal.on(ZO.AuthenticateFail,(async()=>{this.logger.info(pD,"".concat(ZO.AuthenticateFail)),this.doLeaveRoom()})),this.signal.on(ZO.SignatureExpired,(e=>{this.handleNotifySignatureExpired(e)})),this.signal.on(hC.ConnectionStateChanged,(e=>{this.handleNotifyConnectStateChange(e)})),this.signal.on(hC.NetworkQuality,(e=>{this.eventEmitter.emit(hC.NetworkQuality,e)})),this.signal.on(ZO.ClientBanned,(()=>{this.kickRoom()})),this.signal.on(rC.roomStreamStatusNotify,(e=>{this.handleNotifyRoomStreamStatus(e)}))}kickRoom(){this.eventEmitter.emit(hC.ClientBanned,{userId:this.userInfo.userId}),this.cleanup(),this.cleanTransportStats(),this.stat.leaveRoom(),qw.immediateReportRecords(),this.logger.info(pD,"kick leave success")}async refreshRoomUserInfos(){const e=await this.signal.queryRoomUsers(null);await this.doRefreshRoomUserInfos(this.roomId,e.userInfos,!1)}async doRefreshRoomUserInfos(e,t,r){try{this.logger.debug(pD,"doRefreshRoomUserInfos, begin");const i=this.remoteUserManager.refreshRemoteUserList(e,t,r);if(!i)return null;i.forEach((e=>{this.updateSingleUser(e)})),await this.updateSubscribe(i)}catch(kD){this.logger.error(pD,"doRefreshRoomUserInfos, error:".concat(kD))}}async rejoinLoop(e){if(this.isLoopRejoining)this.logger.info(pD,"rejoinLoop, isLoopRejoining so return");else try{this.isLoopRejoining=!0;const t=async e=>await this.handleRejoin(e),r=e=>"function"==typeof(null==e?void 0:e.getCode)&&e.getCode()===Wc.RTC_ERR_CODE_STATUS_ERROR;return await nO.callWithRetryTimes(t,!1,e,lD,r)}catch(kD){this.logger.error(pD,"rejoinLoop, rejoin room failed, leave room, error:".concat(kD)),this.localRejoinFlag||(this.connectState={prevState:Jb[Xb.RECONNECTING],curState:Jb[Xb.DISCONNECTED]},this.eventEmitter.emit(hC.ConnectionStateChanged,this.connectState));try{await this.leaveImpl()}catch(kD){this.logger.error(pD,"rejoinLoop, leave failed, error:".concat(kD))}}finally{this.isLoopRejoining=!1}}async handleRejoin(e){if(this.logger.info(pD,"handleRejoin, client status: ".concat(this.status,", tryNumber:").concat(e)),this.status===aC.Idle)throw this.logger.error(pD,"handleRejoin, status:".concat(aC.Idle)),new qc(Wc.RTC_ERR_CODE_STATUS_ERROR,"handleRejoin but status is Idle");if(this.isSignatureExpired){if(this.signatureExpiredRejoinTimeout)return void this.logger.info(pD,"signature expired, try rejoin, timer already exists");this.signatureExpiredRejoinTimeout=setTimeout((()=>{throw this.logger.error(pD,"handleRejoin, signature expired and retry limit, exit"),this.cleanup(),new qc(Wc.RTC_ERR_CODE_STATUS_ERROR,"handleRejoin but signature expired")}),2e4)}try{await this.locker.lock("".concat(pD,":handleRejoin")),this.status=aC.Rejoining,await this.rejoin(this.roomId,$O.transLocalUserToJoinConfig(this.userInfo)),this.getSessionStatus()===aC.Joined&&(this.logger.info(pD,"handleRejoin, rejoin room success"),this.isSignatureExpired=!1,clearTimeout(this.signatureExpiredRejoinTimeout),this.signatureExpiredRejoinTimeout=void 0,this.connectState={prevState:Jb[Xb.RECONNECTING],curState:Jb[Xb.CONNECTED]},this.eventEmitter.emit(hC.ConnectionStateChanged,this.connectState),await this.rejoinPublish(),this.localRejoinFlag=!1)}finally{this.locker.unlock("".concat(pD,":handleRejoin"))}}async rejoinPublish(){this.logger.info(pD,"rejoin publish stream"),this.connectState.prevState=Jb[Xb.DISCONNECTED];const e=[],t=this.streamPublishManager.getLocalStream(sk.STREAM_TYPE_MAIN),r=this.streamPublishManager.getLocalStream(sk.STREAM_TYPE_AUX);t&&e.push(t),r&&e.push(r),e.length>0&&await this.rejoinPublishStreams(e)}handleNotifySignatureExpired(e){this.logger.warn(pD,"handleNotifySignatureExpired");const t={code:0,reason:""};"reconnect"===e.type?(this.logger.warn(pD,"reconnect but signature expired"),t.code=Wc.RTC_ERR_CODE_SIGNATURE_EXPIRED,t.reason=Gc[Wc.RTC_ERR_CODE_SIGNATURE_EXPIRED]):this.isLoopRejoining?(this.logger.warn(pD,"rejoin but signature expired"),this.isSignatureExpired=!0,t.code=Wc.RTC_ERR_CODE_SIGNATURE_EXPIRED,t.reason=Gc[Wc.RTC_ERR_CODE_SIGNATURE_EXPIRED]):(t.code=Wc.RTC_ERR_CODE_SIGNATURE_INVALID,t.reason=Gc[Wc.RTC_ERR_CODE_SIGNATURE_INVALID]),this.validSignatureFunc&&this.validSignatureFunc(t),this.validSignatureFunc=void 0;const r={errorCode:"".concat(t.code),errorMsg:t.reason};this.eventEmitter.emit(hC.SignatureExpired,r)}handleNotifyConnectStateChange(e){this.logger.info(pD,"ConnectStateChange"),this.eventEmitter.emit(hC.ConnectionStateChanged,e),this.connectState.curState=e.curState}cleanNetworkStatistic(){this.preNetQuality=null,this.downLinkData=null,this.upLinkData=null}cleanup(){var e,t,r;null===(e=this.signal)||void 0===e||e.disconnect(),this.signal=void 0,this.resetConnection(),null===(t=this.remoteUserManager)||void 0===t||t.clear(this.roomId);const i=this.streamPublishManager.getLocalStream(sk.STREAM_TYPE_MAIN);if(i){i.removeClient(this)}this.streamPublishManager.reset(),clearTimeout(this.streamInterruptedDetectInterval),clearTimeout(this.rtcStatsInterval),clearTimeout(this.netQualityTimer),clearTimeout(this.transportStatsTimer),gk.reset(),this.cleanNetworkStatistic(),this.streamInterruptedDetectInterval=null,this.rtcStatsInterval=null,this.lastCycleFrameDecodedMap.clear(),this.streamInterruptedUsersMap.clear(),this.startupQoSMap.clear(),this.status=aC.Idle,this.locker.clear(),clearInterval(this.audioLevelTimer),hM.stopRelayConnection(this,this.roomId),null===(r=this.cmdMsgAbility.cmdManager)||void 0===r||r.reset(),this.isSignatureExpired=!1,clearTimeout(this.signatureExpiredRejoinTimeout),this.signatureExpiredRejoinTimeout=void 0}async addSsrc4Top3(e){var t;return this.audioStreams4TopN.close(),await this.addSsrc2SdpBatch(e,null===(t=this.sdpRepInfo.audio)||void 0===t?void 0:t.topNSsrcBegin)}setAudioLevelStatTimer(){this.audioLevelTimer&&clearInterval(this.audioLevelTimer),this.logger.info(pD,"setAudioLevelStatTimer"),this.audioLevelTimer=setInterval((()=>{try{this.audioStreams4TopN.getAudioLevel().forEach((e=>{const t=Math.round(100*e.level);this.stat.getMediaStat().updateAudioLevel({type:"remotetop3",level:t,ssrc:e.ssrc})}));const e=this.remoteUserManager.getAllUserStreamsByType(this.roomId,sk.STREAM_TYPE_MAIN,ok.TRACK_TYPE_AUDIO),t=[];e.forEach((e=>{const r=e.mainStream.tracks.find((e=>e.isTrackReady&&e.type===ok.TRACK_TYPE_AUDIO&&e.isSubscribed));r&&t.push({userId:e.userId,ssrc:r.cssrc})}));for(const n of t){const e=this.remoteUserManager.getUserInfoById(n.userId,this.roomId),t=Math.round(100*e.mainStream.remoteStream.getAudioLevel());this.stat.getMediaStat().updateAudioLevel({type:"remote",level:t,ssrc:n.ssrc,userId:n.userId})}const r=this.streamPublishManager.getLocalStream(sk.STREAM_TYPE_MAIN),i=Math.round(100*(r?r.getAudioLevel():0));this.stat.getMediaStat().updateAudioLevel({type:"local",level:i})}catch(kD){this.logger.error(pD,"setAudioLevelStatTimer, occur error: ".concat(kD))}}),this.audioLevelInterval)}async addSsrc2SdpBatch(e,t){if(!t)return null;const r={answerSdp:e},i=await this.connectionsManager.addTopAudioUserBatch(r.answerSdp,t,3,((e,t)=>{this.audioStreams4TopN.addAudioStream(e,t)}));return this.stat.getMediaStat().setStartSsrc(t),i}async saveAudioStream4TopN(e){this.logger.info(pD,"AudioPolicyï¼TOPN_AUDIOPOLICY, save audio stream, streamId: ".concat(e.streams[0].id));if(null!=this.audioStreams4TopN.getAudioStream(e.streams[0].id)){this.audioStreams4TopN.updateAudioStream(e.streams[0].id,e.track),this.logger.info(pD,"AudioPolicyï¼TOPN_AUDIOPOLICY, save audio stream ok, streamId: ".concat(e.streams[0].id));try{await this.audioStreams4TopN.play(e.streams[0].id),this.audioStreams4TopN.setAudioVolume4Id(e.streams[0].id,this.topNAudioVolume),this.logger.info(pD,"AudioPolicyï¼TOPN_AUDIOPOLICY, auto play audio success, streamId: ".concat(e.streams[0].id))}catch(e){this.logger.error(pD,"AudioPolicyï¼TOPN_AUDIOPOLICY, auto play audio fail, ".concat(null==e?void 0:e.message,", streamId: ").concat(e.streams[0].id))}}else this.logger.error(pD,"AudioPolicyï¼TOPN_AUDIOPOLICY, audio stream of streamId: ".concat(e.streams[0].id," not exist"))}handleMaxVolumeNotify(e){try{e.topUserAudios&&e.topUserAudios.length>0?(this.top3VolumeUserIds.length=0,e.topUserAudios.forEach((e=>{e.volume=100*(60-(e.volume>60?60:e.volume))/60,this.top3VolumeUserIds.push({user_id:e.userId,volume:e.volume})})),this.audioPolicy===ak.TOPN_AUDIOPOLICY&&this.eventEmitter.emit(hC.VolumeIndicator,{userVolumeInfos:this.top3VolumeUserIds})):this.logger.error(pD,"handleMaxVolumeNotify error,topUserAudios is null")}catch(lw){this.logger.error(pD,"handleMaxVolumeNotify error ".concat(null==lw?void 0:lw.message))}}handlePublishStatusNotify(e){try{e.urlStatus&&(this.logger.info(pD,"emit ".concat(hC.LiveStreamingUpdated)),this.eventEmitter.emit(hC.LiveStreamingUpdated,e.urlStatus))}catch(lw){this.logger.error(pD,"handlePublishStatusNotify error ".concat(lw))}}setVolume4TopThree(e){this.setVolume4TopThreeImpl(e)}setVolume4TopThreeImpl(e){this.logger.debug(pD,"setVolume4TopThreeImpl volume: "+e),e>100||e<0||this.audioPolicy===ak.TOPN_AUDIOPOLICY&&(this.topNAudioVolume=e,this.audioStreams4TopN.setAudioVolume(e))}muteAudio4TopThree(e){this.muteAudio4TopThreeImpl(e)}muteAudio4TopThreeImpl(e){this.logger.debug(pD,"muteAudio4TopThree enable: "+e),this.audioPolicy===ak.TOPN_AUDIOPOLICY&&this.audioStreams4TopN.muteAudio(e)}async setAudioOutput4TopThree(e){this.audioPolicy===ak.TOPN_AUDIOPOLICY&&await this.audioStreams4TopN.setAudioOutput(e)}isTopNAudioMuted(){return this.isTopNAudioMutedImpl()}isTopNAudioMutedImpl(){let e=!1;return this.audioPolicy===ak.TOPN_AUDIOPOLICY&&(e=this.audioStreams4TopN.isAudioMuted(),this.logger.debug(pD,"isTopNAudioMutedImpl : "+e)),e}async changeUserName(e){return await this.changeUserNameImpl(e)}async changeUserNameImpl(e){try{if(eA.checkUserName(e),this.userInfo.role===GO)throw new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"player can not change user name");return await this.signal.appData(this.userInfo.appData,"nickname",e),this.userInfo.appData.nickname=e,!0}catch(kD){return this.logger.error(pD,"changeUserNameImpl, error:".concat(kD)),!1}}reportAudioMuteInfo(e,t){this.stat.reportAudioMuteInfo(e,t)}reportVideoMuteInfo(e,t){this.stat.reportVideoMuteInfo(e,t)}async startLiveStreaming(e,t,r,i){return await this.startLiveStreamingImpl(e,t,r,i)}async startLiveStreamingImpl(e,t,r,i){if(this.logger.info(pD,"startLiveStreaming:  publishConfig: ".concat(JSON.stringify(r),", userConfig: ").concat(JSON.stringify(i))),!(t&&e&&r&&i))throw this.logger.error(pD,"startLiveStreaming failed for parameter error: empty parameter"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);if(this.status!==aC.Joined||this.userInfo.role!==WO)throw this.logger.error(pD,"startLiveStreaming failed for permission not allowed"),new qc(Wc.RTC_ERR_CODE_ROLE_NO_PERMISSION);const n=this.getLiveStreamingUserInfos(i,99===r.template);if(0===n.length)throw this.logger.error(pD,"startLiveStreaming failed for parameter error:".concat(JSON.stringify(i))),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);try{await this.signal.startLiveStreaming(e,t,r,n),this.logger.info(pD,"startLiveStreaming success, taskId: ".concat(e,", url: ").concat(t))}catch(kD){throw this.logger.error(pD,"startLiveStreaming failed: ".concat(kD)),kD}}getLiveStreamingUserInfos(e,t){if(!e||0===e.length)return null;const r=[],i=this.userInfo.userId;return e.forEach((e=>{const n={userId:e.userId,audioStreams:[],videoStreams:[],layouts:[]};if(t&&!e.layouts)throw this.logger.error(pD,"getLiveStreamingUserInfos, layouts is null when template=99"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);e.userId===i?this.getLocalLiveStreamingUserInfos(e,n,t):this.getRemoteLiveStreamingUserInfos(e,n,t),(n.audioStreams.length||n.videoStreams.length)&&r.push(n)})),this.logger.info(pD,"getLiveStreamingUserInfos, publishInfos : ".concat(JSON.stringify(r))),r}getLocalLiveStreamingUserInfos(t,r,i){const n=this.streamPublishManager.getPublishedMainStreamInfos();if(t.audio){var o;const e=null==n||null===(o=n.find((e=>e.type===ok.TRACK_TYPE_AUDIO)))||void 0===o?void 0:o.ssrc;e&&r.audioStreams.push(e)}if(!t.resolutionIds||0===t.resolutionIds.length)return;const s=this.streamPublishManager.getPublishedAuxVideoTrackInfo();t.resolutionIds.forEach((o=>{var a;const c=null==n||null===(a=n.find((e=>e.resolutionId===o)))||void 0===a?void 0:a.ssrc;c?e.updateSlidePublishInfo(t,r,c,o,i):(null==s?void 0:s.resolutionId)===o&&e.updateSlidePublishInfo(t,r,s.ssrc,o,i)}))}static getSsrcLayout(e,t){return{alpha:t.alpha,localX:t.localX,localY:t.localY,renderMode:t.renderMode,ssrc:e,subBackGroundColor:t.subBackGroundColor,subHeight:t.subHeight,subWidth:t.subWidth,zorder:t.zorder}}getRemoteLiveStreamingUserInfos(t,r,i){const n=this.remoteUserManager.getAllUserStreamsByType(this.roomId,null,null),o=null==n?void 0:n.find((e=>e.userId===t.userId));if(o){if(t.audio){var s,a,c;const e=null===(s=o.mainStream)||void 0===s||null===(a=s.tracks)||void 0===a||null===(c=a.find((e=>e.type===ok.TRACK_TYPE_AUDIO)))||void 0===c?void 0:c.pssrc;e&&r.audioStreams.push(e)}if(!t.resolutionIds||0===t.resolutionIds.length)return;for(const n of t.resolutionIds){var u,d,l;const s=null===(u=o.mainStream)||void 0===u||null===(d=u.tracks)||void 0===d||null===(l=d.find((e=>e.trackId===n)))||void 0===l?void 0:l.pssrc;if(s)e.updateSlidePublishInfo(t,r,s,n,i);else{var h,f,p;const s=null===(h=o.auxStream)||void 0===h||null===(f=h.tracks)||void 0===f||null===(p=f.find((e=>e.trackId===n)))||void 0===p?void 0:p.pssrc;s&&e.updateSlidePublishInfo(t,r,s,n,i)}}}}static updateSlidePublishInfo(t,r,i,n,o){if(r.videoStreams.push(i),o&&t.layouts){const o=t.layouts.find((e=>e.resolutionId===n));if(o){const t=e.getSsrcLayout(i,o);r.layouts.push(t)}}}async updateLiveStreaming(e,t,r,i){return await this.updateLiveStreamingImpl(e,t,r,i)}async updateLiveStreamingImpl(e,t,r,i){if(this.logger.info(pD,"updateLiveStreaming: publishConfig: ".concat(JSON.stringify(r),", userConfig: ").concat(JSON.stringify(i))),!(t&&e&&r&&i))throw this.logger.error(pD,"updateLiveStreaming failed for parameter error: empty param"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);if(this.status!==aC.Joined||this.userInfo.role!==WO)throw this.logger.error(pD,"updateLiveStreaming failed for permission not allowed"),new qc(Wc.RTC_ERR_CODE_ROLE_NO_PERMISSION);const n=this.getLiveStreamingUserInfos(i,99===r.template);try{await this.signal.updateLiveStreaming(e,r,n),this.logger.info(pD,"updateLiveStreaming success, taskId: ".concat(e,", url: ").concat(t))}catch(kD){throw this.logger.error(pD,"updateLiveStreaming failed: ".concat(kD)),kD}}async stopLiveStreaming(e){return await this.stopLiveStreamingImpl(e)}async stopLiveStreamingImpl(e){if(this.logger.info(pD,"stopLiveStreaming:  taskId: ".concat(e)),!e)throw this.logger.error(pD,"stopLiveStreaming failed for parameter error: taskId is empty"),new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER);try{await this.signal.stopLiveStreaming(e),this.logger.info(pD,"stopLiveStreaming success, taskId: ".concat(e))}catch(kD){throw this.logger.error(pD,"stopLiveStreaming failed: ".concat(kD)),kD}}setProxyServer(e){tA.setPorxyServer(e)}setTurnServer(e){var t;null===(t=this.connectionsManager)||void 0===t||t.setTurnServer(e)}async addMultiRoomMediaRelay(e){if(this.status!==aC.Joined)throw this.logger.error(pD,"addMultiRoomMediaRelay failed for not joined room."),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION);eA.checkSrcMultiRoomInfo(e.srcRoomRelayInfo);for(const n of e.dstRoomRelayInfo)eA.checkDstMultiRoomInfo(n,this.userInfo.role);const t=new Map;e.dstRoomRelayInfo.forEach((e=>{t.set(e.roomId,e.role)}));const r=await this.signal.mediaRelay(e,!0,this.userInfo),i=[];return r.addResult.forEach((async e=>{i.push({roomId:e.roomId,result:e.resultCode,msg:e.resultMessage}),0===e.resultCode?this.userInfo.addRelayInfo(e.roomId,t.get(e.roomId)):this.logger.error(pD,"addMultiRoomMediaRelay failed, roomId: ".concat(e.roomId,", resultCode: ").concat(e.resultCode,", errMsg: ").concat(e.resultMessage)),this.stat.reportRelayJoinInfo({code:e.resultCode,acsAddr:"",requestId:r.requestId,traceId:r.traceId,roomId:e.roomId,role:t.get(e.roomId),roomUid:e.roomUid,failMessage:e.resultMessage})})),i}async stopMultiRoomMediaRelay(e){if(this.status!==aC.Joined)throw this.logger.error(pD,"stopMultiRoomMediaRelay failed for not joined room."),new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION);let t;if(e&&e.dstRoomRelayInfo&&0!==e.dstRoomRelayInfo.length){eA.checkSrcMultiRoomInfo(e.srcRoomRelayInfo);for(const t of e.dstRoomRelayInfo)eA.checkDstMultiRoomInfo(t,this.userInfo.role);t=e}else t={dstRoomRelayInfo:this.userInfo.getRelayInfos()};const r=await this.signal.mediaRelay(t,!1,this.userInfo),i=[];return r.addResult.forEach((async e=>{i.push({roomId:e.roomId,result:e.resultCode,msg:e.resultMessage}),0===e.resultCode?this.userInfo.removeRelayInfo(e.roomId):this.logger.error(pD,"stopMultiRoomMediaRelay failed, roomId: ".concat(e.roomId,", resultCode: ").concat(e.resultCode,", errMsg: ").concat(e.resultMessage)),this.stat.reportRelayLeavInfo({code:e.resultCode,requestId:r.requestId,traceId:r.traceId,roomId:e.roomId,roomUid:e.roomUid})})),i}addRelayClient(e){return hM.addRelayConnection(this,e)}async stopRelayClient(e){const t=hM.getRelayConnection(this,e);t&&await t.leave()}enableCommandMsg(e,t){if(this.status!==aC.Idle&&e)throw new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"pls call enableCommandMsg interface before join room first.");var r;e?this.cmdMsgAbility.msgFormat=(null==t?void 0:t.msgFormat)||gC.STRING:(null===(r=this.cmdMsgAbility.cmdManager)||void 0===r||r.reset(),this.cmdMsgAbility.cmdManager=null);return this.cmdMsgAbility.enable=e,!0}sendCommandMsg(e,t){var r;if(!this.cmdMsgAbility.enable)throw new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"pls call enableCommandMsg interface before join room first.");if(this.status!==aC.Joined)throw new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"pls call this interface after joined room.");if((null===(r=this.userInfo)||void 0===r?void 0:r.roleSignalType)!==qO.JOINER)throw new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"only joiner can send comand message.");return eA.checkCmdMsgValid(e),this.cmdMsgAbility.cmdManager.sendCommandMsg(e,t,this.roomId)}async handleNotifyRoomStreamStatus(e){const{audienceState:t}=e;this.logger.info(pD,"handleNotifyRoomStreamStatus handle room stream status : "+t+" role:"+this.userInfo.role),await this.handleRoomStreamStatus(t,ak.TOPN_AUDIOPOLICY===this.audioPolicy&&this.userInfo.role===GO&&SC.NORMAL===t)}async handleRoomStreamStatus(e,t,r){this.logger.info(pD,"handle room stream status : "+e),this.roomStreamStatus={audience:e};try{if(this.userInfo.role===GO&&e===SC.PAUSE){this.logger.info(pD,"player handle room stream status : "+e);const t=this.remoteUserManager.getAllSubscribedUpdateInfos4Unsubscribe(this.roomId);await this.updateSubscribe(t,null,!0),ak.TOPN_AUDIOPOLICY===this.audioPolicy&&(this.logger.info(pD,"player handle room stream status : "+e+" and topN unsubscribeUsersAudio"),await this.unsubscribeUsersAudio()),this.logger.info(pD,"player handle room stream status : "+e+" and clear intervals"),this.cleanNetworkStatistic(),this.netQualityRegularReport(),this.cleanTransportStats(),this.setAudioLevelStatTimer()}t&&(this.logger.info(pD,"".concat(this.userInfo.role," handle room stream status : ")+e+" and topN addSsrc4Top3"),this.remoteUserManager.enableTopThreeAudioMode(this.roomId),await this.connectionsManager.generateAndSetOfferSdpByHandler(sk.STREAM_TYPE_MAIN),await this.connectionsManager.generateAndSetAnswerSdpByHandler(sk.STREAM_TYPE_MAIN,this.addSsrc4Top3.bind(this))),(r||this.userInfo.role===GO&&[SC.PAUSE,SC.NORMAL].includes(e))&&(this.logger.info(pD,"eventEmitter RoomStreamStatus : "+e),this.eventEmitter.emit(hC.RoomStreamStatus,e))}catch(lw){this.logger.error(pD,"RoomStreamStatus : "+e+" error:"+lw)}}renewSignature(e,t){if("string"!=typeof e||"string"!=typeof t)throw new qc(Wc.RTC_ERR_CODE_INVALID_PARAMETER,"ctime or signature must be string");const r=$O.renewSignature(this.identifiedID,e,t);var i;return r?(this.userInfo=r,null===(i=this.signal)||void 0===i||i.refreshUserInfo(r),this.logger.info(pD,"renewSignature success"),!0):(this.logger.info(pD,"renewSignature fail"),!1)}},r(dD.prototype,"enableTopThreeAudioMode",[AM],Object.getOwnPropertyDescriptor(dD.prototype,"enableTopThreeAudioMode"),dD.prototype),r(dD.prototype,"switchAudioMode",[wM],Object.getOwnPropertyDescriptor(dD.prototype,"switchAudioMode"),dD.prototype),r(dD.prototype,"getConnectionState",[kM],Object.getOwnPropertyDescriptor(dD.prototype,"getConnectionState"),dD.prototype),r(dD.prototype,"setNetworkBandwidth",[OM],Object.getOwnPropertyDescriptor(dD.prototype,"setNetworkBandwidth"),dD.prototype),r(dD.prototype,"join",[PM],Object.getOwnPropertyDescriptor(dD.prototype,"join"),dD.prototype),r(dD.prototype,"enableRtcStats",[MM],Object.getOwnPropertyDescriptor(dD.prototype,"enableRtcStats"),dD.prototype),r(dD.prototype,"leave",[DM],Object.getOwnPropertyDescriptor(dD.prototype,"leave"),dD.prototype),r(dD.prototype,"publish",[NM],Object.getOwnPropertyDescriptor(dD.prototype,"publish"),dD.prototype),r(dD.prototype,"publishImpl",[UM],Object.getOwnPropertyDescriptor(dD.prototype,"publishImpl"),dD.prototype),r(dD.prototype,"unpublish",[xM],Object.getOwnPropertyDescriptor(dD.prototype,"unpublish"),dD.prototype),r(dD.prototype,"subscribeAudio",[LM],Object.getOwnPropertyDescriptor(dD.prototype,"subscribeAudio"),dD.prototype),r(dD.prototype,"unSubscribeAudio",[BM],Object.getOwnPropertyDescriptor(dD.prototype,"unSubscribeAudio"),dD.prototype),r(dD.prototype,"subscribe",[VM],Object.getOwnPropertyDescriptor(dD.prototype,"subscribe"),dD.prototype),r(dD.prototype,"batchSubscribe",[YM],Object.getOwnPropertyDescriptor(dD.prototype,"batchSubscribe"),dD.prototype),r(dD.prototype,"unsubscribe",[jM],Object.getOwnPropertyDescriptor(dD.prototype,"unsubscribe"),dD.prototype),r(dD.prototype,"switchRole",[FM],Object.getOwnPropertyDescriptor(dD.prototype,"switchRole"),dD.prototype),r(dD.prototype,"refreshRemoteStreamList",[HM],Object.getOwnPropertyDescriptor(dD.prototype,"refreshRemoteStreamList"),dD.prototype),r(dD.prototype,"updateRemoteStream",[KM],Object.getOwnPropertyDescriptor(dD.prototype,"updateRemoteStream"),dD.prototype),r(dD.prototype,"removeRemoteStream",[zM],Object.getOwnPropertyDescriptor(dD.prototype,"removeRemoteStream"),dD.prototype),r(dD.prototype,"handleWatchMsg",[WM],Object.getOwnPropertyDescriptor(dD.prototype,"handleWatchMsg"),dD.prototype),r(dD.prototype,"refreshRoomUserInfos",[GM],Object.getOwnPropertyDescriptor(dD.prototype,"refreshRoomUserInfos"),dD.prototype),r(dD.prototype,"setVolume4TopThree",[qM],Object.getOwnPropertyDescriptor(dD.prototype,"setVolume4TopThree"),dD.prototype),r(dD.prototype,"muteAudio4TopThree",[JM],Object.getOwnPropertyDescriptor(dD.prototype,"muteAudio4TopThree"),dD.prototype),r(dD.prototype,"setAudioOutput4TopThree",[XM],Object.getOwnPropertyDescriptor(dD.prototype,"setAudioOutput4TopThree"),dD.prototype),r(dD.prototype,"isTopNAudioMuted",[QM],Object.getOwnPropertyDescriptor(dD.prototype,"isTopNAudioMuted"),dD.prototype),r(dD.prototype,"changeUserName",[$M],Object.getOwnPropertyDescriptor(dD.prototype,"changeUserName"),dD.prototype),r(dD.prototype,"startLiveStreaming",[ZM],Object.getOwnPropertyDescriptor(dD.prototype,"startLiveStreaming"),dD.prototype),r(dD.prototype,"updateLiveStreaming",[eD],Object.getOwnPropertyDescriptor(dD.prototype,"updateLiveStreaming"),dD.prototype),r(dD.prototype,"stopLiveStreaming",[tD],Object.getOwnPropertyDescriptor(dD.prototype,"stopLiveStreaming"),dD.prototype),r(dD.prototype,"setProxyServer",[rD],Object.getOwnPropertyDescriptor(dD.prototype,"setProxyServer"),dD.prototype),r(dD.prototype,"setTurnServer",[iD],Object.getOwnPropertyDescriptor(dD.prototype,"setTurnServer"),dD.prototype),r(dD.prototype,"addMultiRoomMediaRelay",[nD],Object.getOwnPropertyDescriptor(dD.prototype,"addMultiRoomMediaRelay"),dD.prototype),r(dD.prototype,"stopMultiRoomMediaRelay",[oD],Object.getOwnPropertyDescriptor(dD.prototype,"stopMultiRoomMediaRelay"),dD.prototype),r(dD.prototype,"addRelayClient",[sD],Object.getOwnPropertyDescriptor(dD.prototype,"addRelayClient"),dD.prototype),r(dD.prototype,"stopRelayClient",[aD],Object.getOwnPropertyDescriptor(dD.prototype,"stopRelayClient"),dD.prototype),r(dD.prototype,"enableCommandMsg",[cD],Object.getOwnPropertyDescriptor(dD.prototype,"enableCommandMsg"),dD.prototype),r(dD.prototype,"renewSignature",[uD],Object.getOwnPropertyDescriptor(dD.prototype,"renewSignature"),dD.prototype),dD);var gD,_D,SD,vD,yD,ID,TD,RD,ED,bD,CD;const AD=new(gD=rO("default$setLogLevel#void#LogLevel"),_D=tO("default$checkSystemRequirements#Promise<boolean>#boolean"),SD=rO("default$isScreenShareSupported#boolean"),vD=tO("default$getDevices#Promise<MediaDeviceInfo[]>"),yD=tO("default$getCameras#Promise<MediaDeviceInfo[]>"),ID=tO("default$getMicrophones#Promise<MediaDeviceInfo[]>"),TD=tO("default$getSpeakers#Promise<MediaDeviceInfo[]>"),RD=rO("default$setParameter#boolean#string#string"),ED=rO("default$createClient#Client#ClientConfig"),bD=rO("default$createStream#LocalStream#StreamConfig"),r((CD=class extends jO{constructor(){super({logger:!0,stat:!0}),t(this,"VERSION",jC),this.stat.setDeviceStatusInfo(),this.stat.setDeviceUserAgent()}setLogLevel(e){MR.setAllLogLevel(e)}async checkSystemRequirements(e){return await dw.checkSystemRequirements(e)}isScreenShareSupported(){return dw.isRTCScreenShareSupported()}async getDevices(){return await nC()}async getCameras(){return await async function(){return new Promise(((e,t)=>{nC().then((r=>{const i=r.filter((e=>"videoinput"===e.kind));i&&0!==i.length?e(i):t(new qc(Wc.RTC_ERR_CODE_NO_AVAILABLE_VIDEO_INPUT_DEVICES))})).catch((e=>{t(e)}))}))}()}async getMicrophones(){return await async function(){return new Promise(((e,t)=>{nC().then((r=>{const i=r.filter((e=>"audioinput"===e.kind&&"communications"!==e.deviceId&&"default"!==e.deviceId));i&&0!==i.length?e(i):t(new qc(Wc.RTC_ERR_CODE_NO_AVAILABLE_AUDIO_INPUT_DEVICES))})).catch((e=>{t(e)}))}))}()}async getSpeakers(){return await async function(){return new Promise(((e,t)=>{nC().then((r=>{const i=r.filter((e=>"audiooutput"===e.kind));i&&0!==i.length?e(i):t(new qc(Wc.RTC_ERR_CODE_NO_AVAILABLE_AUDIO_OUTPUT_DEVICES))})).catch((e=>{t(e)}))}))}()}setParameter(e,t){return nk.setParameter(e,t)}createClient(e){return eA.checkAppid(e.appId),eA.checkCountryCode(e.countryCode),e.domain&&eA.checkDomain(e.domain),new mD(e)}createStream(e){if(e.screen){if(e.videoSource||e.audioSource){if(!0===e.video||!0===e.audio)throw new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION)}else if(!this.isScreenShareSupported())throw new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION,"screen share is not supported")}else{if(!0!==e.video&&!0!==e.audio&&!e.videoSource&&!e.audioSource)throw new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION);if((!0===e.video||!0===e.audio)&&(e.videoSource||e.audioSource))throw new qc(Wc.RTC_ERR_CODE_INVALID_OPERATION)}return new KO(e)}getInfo(){return{moduleName:"default"}}}).prototype,"setLogLevel",[gD],Object.getOwnPropertyDescriptor(CD.prototype,"setLogLevel"),CD.prototype),r(CD.prototype,"checkSystemRequirements",[_D],Object.getOwnPropertyDescriptor(CD.prototype,"checkSystemRequirements"),CD.prototype),r(CD.prototype,"isScreenShareSupported",[SD],Object.getOwnPropertyDescriptor(CD.prototype,"isScreenShareSupported"),CD.prototype),r(CD.prototype,"getDevices",[vD],Object.getOwnPropertyDescriptor(CD.prototype,"getDevices"),CD.prototype),r(CD.prototype,"getCameras",[yD],Object.getOwnPropertyDescriptor(CD.prototype,"getCameras"),CD.prototype),r(CD.prototype,"getMicrophones",[ID],Object.getOwnPropertyDescriptor(CD.prototype,"getMicrophones"),CD.prototype),r(CD.prototype,"getSpeakers",[TD],Object.getOwnPropertyDescriptor(CD.prototype,"getSpeakers"),CD.prototype),r(CD.prototype,"setParameter",[RD],Object.getOwnPropertyDescriptor(CD.prototype,"setParameter"),CD.prototype),r(CD.prototype,"createClient",[ED],Object.getOwnPropertyDescriptor(CD.prototype,"createClient"),CD.prototype),r(CD.prototype,"createStream",[bD],Object.getOwnPropertyDescriptor(CD.prototype,"createStream"),CD.prototype),CD),wD={};return wD.VERSION=AD.VERSION,wD.setLogLevel=AD.setLogLevel,wD.checkSystemRequirements=AD.checkSystemRequirements,wD.isScreenShareSupported=AD.isScreenShareSupported,wD.getDevices=AD.getDevices,wD.getCameras=AD.getCameras,wD.getMicrophones=AD.getMicrophones,wD.getSpeakers=AD.getSpeakers,wD.setParameter=AD.setParameter,wD.createClient=AD.createClient,wD.createStream=AD.createStream,wD}));
